[{"content":"å†™åœ¨å‰é¢ äº‘åŸç”Ÿå£°é‡æœ€å¤§çš„ä¸€æ®µæ—¶é—´é‡Œ Java æ—¶å¸¸è¢«äººè¯Ÿç—…åº”ç”¨å¯åŠ¨é€Ÿåº¦å¤ªæ…¢äº†ï¼Œè€Œä¸”å ç”¨å†…å­˜ä¹Ÿå¾ˆå¤§ï¼Œç”±äºäº‘åŸç”Ÿåº”ç”¨ç›®æ ‡åŒ…æ‹¬å¿«é€Ÿå¯åŠ¨ã€å¿«é€Ÿå“åº”ã€å¿«é€Ÿæ‰©å®¹ã€å¿«é€Ÿæ”¶ç¼©ï¼Œå› æ­¤ Java ä¸€ç›´è¢«è®¤ä¸ºä¸é€‚åˆäº‘åŸç”Ÿåº”ç”¨ã€‚ä½†æ˜¯ï¼Œéšç€ GraalVM çš„æ›å…‰ï¼Œè¿™ä¸ªé—®é¢˜å¾—åˆ°äº†éƒ¨åˆ†è§£å†³ï¼ŒGraalVM å¯ä»¥å°† Java åº”ç”¨ç¼–è¯‘æˆæœ¬åœ°å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ƒè¢«ç§°ä¸º Native Imageï¼Œè¿™æ ·å°±ä¸éœ€è¦å®‰è£… Java è¿è¡Œæ—¶ï¼ˆJREï¼‰äº†ï¼Œç›´æ¥è¿è¡Œå³å¯ã€‚\næœ€æ—©ä½“éªŒåˆ° Native Image æ˜¯é€šè¿‡ Quarkus ä¸ Picocli å¼€å‘ä¸€äº›å‘½ä»¤è¡Œåº”ç”¨ï¼ˆCLI Appï¼‰ï¼Œä¸ªäººæ„Ÿè§‰é’ˆå¯¹ä¸åŒçš„å¹³å°æ‰“åŒ…å‡ºä¸åŒçš„äºŒè¿›åˆ¶æ–‡ä»¶çš„ç¼–è¯‘å’Œéƒ¨ç½²æˆæœ¬æ¯” Go/Rust/Node.js è¯­è¨€éƒ½é«˜ï¼ŒNative Image çš„é™åˆ¶ä¹Ÿæ¯”è¾ƒå¤šï¼Œæ¯”å¦‚åå°„ã€åŠ¨æ€ä»£ç†ã€åŠ¨æ€ç±»åŠ è½½ç­‰ï¼Œä¸å¾—ä¸ä»¥å£°æ˜å¼å‘Šè¯‰ GraalVM å“ªäº›ç±»æœ‰å“ªäº›åŠ¨æ€è¡Œä¸ºã€‚åæ¥ Spring Boot ä¹Ÿæ”¯æŒäº† Native Imageï¼Œé‚£äº›è€æ¯›ç—…å¥åœ¨ï¼Œåªä¸è¿‡ç”Ÿæ€è§„æ¨¡æ›´å¤§ç½¢äº†ã€‚\nGraalVM èƒ½æ˜¾è‘—æå‡ Java åº”ç”¨ç¨‹åºçš„æ€§èƒ½è¿˜æ˜¯æŒºå¯ä¿¡çš„ï¼Œæ¯”å¦‚ GraalVM for JDK 21 is here! å’Œ Migrating 10MinuteMail from Java to GraalVM Nativeï¼Œå°¤å…¶ç›¸è¾ƒäºä¼ ç»Ÿ JVM åº”ç”¨çš„è¿™ä¸¤ä¸ªæŒ‡æ ‡ï¼š\nå¯åŠ¨æ—¶é—´ startup time\nå•ä½æ—¶é—´ä¸å†…å­˜çš„ååé‡ requests/GB-s\nå…ˆå†³æ¡ä»¶ å®‰è£… Java 21 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œç°åœ¨æŒºæµè¡Œä½¿ç”¨ SDKMAN! å®‰è£…å’Œç®¡ç†å¤šç‰ˆæœ¬ JDKï¼Œæˆ‘ä¹ æƒ¯åœ¨ Download Azul JDKs ä¸‹è½½ OpenJDKã€‚\nåœ¨ Windows å¹³å°ï¼Œåœ¨ WSL ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥åªé€šè¿‡ç±»ä¼¼äº alias çš„åˆ«ååŠ¨æ€åˆ‡æ¢ JDK ç‰ˆæœ¬ï¼Œæ¯”å¦‚ç¼–è¾‘ PowerShell çš„ $profile æŒ‡å‘çš„æ–‡ä»¶ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # reload env path Function Refresh { $env:Path = [System.Environment]::GetEnvironmentVariable(\u0026#34;Path\u0026#34;, \u0026#34;Machine\u0026#34;) + \u0026#34;;\u0026#34; + [System.Environment]::GetEnvironmentVariable(\u0026#34;Path\u0026#34;, \u0026#34;User\u0026#34;) } Function SetJdk($version) { $env:JAVA_HOME = \u0026#34;C:\\Program Files\\Zulu\\zulu-$version\u0026#34; Refresh } Function Jdk8 { SetJdk 8 } Function Jdk21 { $env:GRAALVM_HOME = \u0026#34;C:\\Program Files\\Java\\graalvm-community-openjdk-21.0.1+12.1\u0026#34; SetJdk 21 } Set-Alias -Name j8 -Value Jdk8 Set-Alias -Name j21 -Value Jdk21 å®‰è£… GraalVM for JDK 21 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œä¸ªäººé€šå¸¸åœ¨ GraalVM Community Edition ä¸‹è½½é€‚ç”¨äºå„ Java ç‰ˆæœ¬çš„ç¤¾åŒºç‰ˆã€‚\nè‹¥åœ¨ Windows å¹³å°ï¼Œè¿˜éœ€è¦ä¸‹è½½ Visual Studioï¼Œå¹¶åœ¨å®‰è£…æ—¶å‹¾é€‰ Desktop development with C++ ç­‰ç»„ä»¶ï¼Œè¯¦æƒ…å‚è€ƒ Installation on Windows Platformsã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨é»˜è®¤çš„å®‰è£…è·¯å¾„åœ¨ç¼–è¯‘æ—¶å¯ä»¥ç»•è¿‡ä¸å°‘å‘ï¼ˆError: Failed to find xxx in a Visual Studio installationï¼‰ï¼Œä¸å¾—ä¸è¿ç§» Visual Studio åˆ°å…¶å®ƒç›˜æ—¶ï¼Œå»ºè®®åœ¨å‘½ä»¤æç¤ºç¬¦ä½¿ç”¨ mklink åˆ›å»ºç¬¦å·é“¾æ¥ï¼Œæ¯”å¦‚ï¼š 1 mklink /d \u0026#34;C:\\Program Files\\Microsoft Visual Studio\u0026#34; \u0026#34;D:\\Program Files\\Microsoft Visual Studio\u0026#34; å®‰è£… Maven æˆ– Gradleã€‚\nQuarkus + Picocli ä¸ Spring Boot çš„ Spring Initializr ç±»ä¼¼ï¼ŒQuarkus ä¹Ÿæä¾›äº†ç”Ÿæˆå¿«é€Ÿå¼€å§‹é¡¹ç›®çš„åœ¨çº¿å·¥å…· code.quarkus.ioï¼Œå¯ä»¥æœç´¢é€‰æ‹©ä¾èµ–ç”Ÿæˆä½ çš„åˆå§‹ä»£ç ã€‚ä¸ºä»€ä¹ˆé¦–é€‰ picocli ä¸ quarkus çš„æ•´åˆåŒ… quarkus-picocliï¼Ÿè€Œä¸æ˜¯å•ç‹¬æ·»åŠ å®ƒï¼Ÿå› ä¸ºå®ƒä»¬çš„æ•´åˆåŒ…å·²ç»å¸®ä½ è§£å†³äº†æ„å»º Native Image æ—¶çš„ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ java.lang.NoClassDefFoundError: \u0026hellip;ï¼Œè¯¦æƒ…å‚è€ƒ quarkus-picocli # Native Imageã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @Command( name = \u0026#34;\u0026lt;your_command_name\u0026gt;\u0026#34;, description = \u0026#34;\u0026lt;your_command_descripiton\u0026gt;\u0026#34;, mixinStandardHelpOptions = true, version = \u0026#34;\u0026lt;your_command_version\u0026gt;\u0026#34; ) public class App implements Runnable { // your command options and parameters public static void main(String[] args) { var app = new App(); var cli = new CommandLine(app); int code = cli.execute(args); System.exit(code); } @Override public void run() { // your command logic } } è¿™æ˜¯æˆ‘æœ€å¸¸ç”¨çš„å‘½ä»¤è¡Œåº”ç”¨çš„æ¨¡æ¿ä¹‹ä¸€ï¼Œå®ƒåªéœ€è¦ä¸€ä¸ªæºæ–‡ä»¶ App.javaï¼Œå…¶ä¸­çš„æ–¹æ³• main æ—¢æ˜¯ Quarkus åº”ç”¨ç¨‹åºä¹Ÿæ˜¯ Picocli å‘½ä»¤è¡Œåº”ç”¨çš„å…¥å£ï¼Œå®ƒçš„å‚æ•° args ä¼šè¢«ä¼ é€’ç»™ Picocli çš„ CommandLine å¯¹è±¡ï¼Œè€Œ CommandLine å¯¹è±¡ä¼šè§£æ args å¹¶è°ƒç”¨ App å¯¹è±¡çš„ run æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ run æ–¹æ³•ä¸­ç¼–å†™å‘½ä»¤è¡Œåº”ç”¨çš„é€»è¾‘äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 . â”œâ”€â”€ mvnw â”œâ”€â”€ mvnw.cmd â”œâ”€â”€ pom.xml â”œâ”€â”€ README.md â””â”€â”€ src â”œâ”€â”€ main â”‚Â â”œâ”€â”€ docker â”‚Â â”‚Â â”œâ”€â”€ Dockerfile.jvm â”‚Â â”‚Â â”œâ”€â”€ Dockerfile.legacy-jar â”‚Â â”‚Â â”œâ”€â”€ Dockerfile.native â”‚Â â”‚Â â””â”€â”€ Dockerfile.native-micro â”‚Â â”œâ”€â”€ java â”‚Â â”‚Â â””â”€â”€ dev â”‚Â â”‚Â â””â”€â”€ example â”‚Â â”‚Â â””â”€â”€ App.java â”‚Â â””â”€â”€ resources â”‚Â â””â”€â”€ application.properties â””â”€â”€ test â””â”€â”€ java â””â”€â”€ dev â””â”€â”€ example ä¸ºäº†ä½¿ç¨‹åºå¯åŠ¨æ—¶çœ‹èµ·æ¥æ›´åƒ CLI Appï¼Œå¯ä»¥åœ¨ application.properties æ·»åŠ ï¼š\n1 2 3 quarkus.banner.enabled=false quarkus.package.output-name=your- quarkus.package.runner-suffix=cli ä»ç”Ÿæˆçš„é¡¹ç›®ä»£ç ä¸éš¾å‘ç° README.md å·²ç»æç¤ºäº†å¦‚ä½•æ„å»º Native Imageï¼Œæ­¤å¤„ä¸ä½¿ç”¨ Maven Wrapperï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨è‡ªå®šä¹‰å®‰è£…å¹¶é…ç½®å¥½ç¯å¢ƒå˜é‡çš„ Maven å·¥å…·ï¼š\n1 mvn package -Dnative ä»¥ Windows ä¸ºä¾‹ï¼Œæ„å»ºæˆåŠŸï¼ˆBUILD SUCCESSï¼‰åï¼Œå¯ä»¥åœ¨ target ç›®å½•ä¸‹çœ‹åˆ°ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ your-cli.exeï¼Œåœ¨ä¸åŒå‘½ä»¤è¡Œ Shell ä¸Šå‰ç¼€æœ‰æ‰€ä¸åŒï¼š\nè‹¥åœ¨ PowerShell åˆ™è¾“å…¥ .\\your-cli.exe ... è¿è¡Œ\nè‹¥åœ¨å‘½ä»¤æç¤ºç¬¦ï¼ˆcmd.exeï¼‰åˆ™è¾“å…¥ cmd /k your-cli.exe ... è¿è¡Œ\né‡åˆ°æœ€å¤šçš„æ˜¯åå°„é—®é¢˜ï¼Œä»¥ä¸‹æ˜¯å®˜æ–¹ç»™å‡ºçš„ç†ç”±ï¼š\nåœ¨æ„å»ºæœ¬åœ°å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼ŒGraalVM åŸºäºå°é—­ä¸–ç•Œçš„å‡è®¾è¿›è¡Œæ“ä½œã€‚å®ƒåˆ†æè°ƒç”¨æ ‘å¹¶åˆ é™¤æ‰€æœ‰æœªç›´æ¥ä½¿ç”¨çš„ç±»/æ–¹æ³•/å­—æ®µã€‚é€šè¿‡åå°„ä½¿ç”¨çš„å…ƒç´ ä¸æ˜¯è°ƒç”¨æ ‘çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å®ƒä»¬ä¼šè¢«æ­»ä»£ç æ¶ˆé™¤ï¼ˆåœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œå¦‚æœæœªç›´æ¥è°ƒç”¨ï¼‰ã€‚è¦åœ¨æœ¬åœ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­åŒ…å«è¿™äº›å…ƒç´ ï¼Œæ‚¨éœ€è¦æ˜¾å¼åœ°ä¸ºåå°„æ³¨å†Œå®ƒä»¬ã€‚\nå¯¹äºä¾èµ–åå°„æ¥åºåˆ—åŒ–/ååºåˆ—åŒ–çš„ç±»ï¼Œå¯ä½¿ç”¨ @RegisterForReflection æ³¨è§£æ¥æ³¨å†Œåå°„ç±»ï¼š\n1 2 @RegisterForReflection record MyRecord(String id, String name) {} è¯¦æƒ…å‚è€ƒ Registering for reflectionã€‚\nSpring Boot + Picocli ä» Spring Initializr ç”ŸæˆåŒ…å«ä¾èµ– picocli-spring-boot-starter çš„é¡¹ç›®ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæºæ–‡ä»¶ App.java å’Œ Cmd.javaï¼ŒSpring Boot çš„å‘½ä»¤è¡Œåº”ç”¨çš„å…¥å£ç±»éœ€è¦å®ç°æ¥å£ CommandLineRunner å’Œ ExitCodeGeneratorï¼Œå…¶ä¸­ CommandLineRunner çš„ run æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œè€Œ ExitCodeGenerator çš„ getExitCode æ–¹æ³•ä¼šè¿”å›é€€å‡ºç ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ main æ–¹æ³•ä¸­è°ƒç”¨ SpringApplication.exit æ–¹æ³•æ¥é€€å‡ºç¨‹åºäº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 @Component @SpringBootApplication public class App implements CommandLineRunner, ExitCodeGenerator { private final Cmd cmd; private final IFactory factory; private int exitCode; public App(Cmd cmd, IFactory factory) { this.cmd = cmd; this.factory = factory; } @Override public void run(String... args) throws Exception { exitCode = new CommandLine(cmd, factory).execute(args); } @Override public int getExitCode() { return exitCode; } public static void main(String[] args) { System.exit(SpringApplication.exit(SpringApplication.run(App.class, args))); } } å…·ä½“ä¸šåŠ¡é€»è¾‘åœ¨ Cmd.java ä¸­å®ç°ï¼Œå®ƒéœ€è¦å®ç°æ¥å£ Callable\u0026lt;Integer\u0026gt;ï¼Œå…¶ä¸­ call æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œè¿”å›å€¼ä¸ºé€€å‡ºç ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Component @Command( name = \u0026#34;\u0026lt;your_command_name\u0026gt;\u0026#34;, description = \u0026#34;\u0026lt;your_command_descripiton\u0026gt;\u0026#34;, mixinStandardHelpOptions = true, version = \u0026#34;\u0026lt;your_command_version\u0026gt;\u0026#34; ) public class Cmd implements Callable\u0026lt;Integer\u0026gt; { // your command options and parameters @Override public Integer call() throws Exception { // your command logic return 0; } } ç±»ä¼¼åœ°ï¼Œåœ¨ application.properties è®¾ç½® spring.main.banner-mode=offï¼Œç„¶ååœ¨ HELP.md å¯ä»¥å‘ç°å¦‚ä½•æ„å»º Native Imageï¼š\n1 mvn native:compile -Pnative çœ‹èµ·æ¥ç¼–è¯‘æ—¶å¥½å¥½çš„ï¼Œè¿è¡Œæ—¶å´æŠ¥é”™ï¼š\njava.lang.IllegalStateException: Failed to execute CommandLineRunner è§£å†³æ–¹æ¡ˆæ˜¯æ–°å¢ä¾èµ– Picocli Code Generationï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯ç”¨äºç”Ÿæˆæ„å»º GraalVM Native Image çš„ Picocli å‘½ä»¤æ‰€éœ€å…ƒæ•°æ®çš„æ³¨è§£å¤„ç†å™¨ï¼Œä»¥ Maven ä¸ºä¾‹ï¼š\n1 2 3 4 5 6 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;info.picocli\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;picocli-codegen\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.7.5\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;provided\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; ç”±äºä½¿ç”¨äº† HTTPSï¼Œä¸æ–™é­é‡äº†å¼‚å¸¸ï¼š\njava.net.MalformedURLException: Accessing an URL protocol that was not enabled. The URL protocol HTTPS is supported but not enabled by default. It must be enabled by adding the \u0026ndash;enable-url-protocols=https option to the native-image command. äºæ˜¯åœ¨ native-maven-plugin æ·»åŠ æ„å»ºå‚æ•°ï¼š\n1 2 3 4 5 6 7 8 9 \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.graalvm.buildtools\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;native-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;buildArgs\u0026gt; \u0026lt;arg\u0026gt;--enable-url-protocols=https\u0026lt;/arg\u0026gt; \u0026lt;/buildArgs\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; è¿˜ä»¥ä¸‡äº‹å¤§å‰äº†ï¼Œæ²¡æƒ³åˆ°æœ‰äº›ç”¨ä¾‹åœ¨è¿è¡Œ jar æ—¶æ²¡é—®é¢˜ï¼Œè€Œåœ¨è¿è¡Œ native image æ—¶å´å¼‚å¸¸ï¼Œé€šè¿‡å¼‚å¸¸å †æ ˆè¿½è¸ªæºç ä»ç„¶ä¸å¥½ç¡®å®šç¼ºäº†å“ªäº›é…ç½®é¡¹æˆ–å…ƒæ•°æ®ï¼Œæœ€ç»ˆä» How to register method for runtime reflection with GraalVM? å¾—åˆ°å¯å‘ï¼Œé€šè¿‡ native-image-agent æ¥ä¿®å¤ï¼Œå®ƒæ˜¯ä¸€ä¸ª Java Agentï¼Œå¯ä»¥åœ¨è¿è¡Œ jar æ—¶ç”Ÿæˆå…ƒæ•°æ®ï¼Œç„¶ååœ¨æ„å»º native æ—¶ä½¿ç”¨å®ƒä»¬ï¼š\n1 2 3 4 5 6 7 8 src/main/resources/META-INF/native-image/ â”œâ”€â”€ agent-extracted-predefined-classes â”œâ”€â”€ jni-config.json â”œâ”€â”€ predefined-classes-config.json â”œâ”€â”€ proxy-config.json â”œâ”€â”€ reflect-config.json â”œâ”€â”€ resource-config.json â””â”€â”€ serialization-config.json æ“ä½œæ­¥éª¤å¦‚ä¸‹æ‰€ç¤ºï¼š\nè¿è¡Œ mvn -Pnative native:compile ï¼ˆç¼–è¯‘é€šè¿‡åï¼Œå‡è®¾åœ¨ç›®å½• target ä¸‹å¯æ‰§è¡Œæ–‡ä»¶å’Œ jar åˆ†åˆ«ä¸º your-app å’Œ your-app.jarï¼‰\næ–°å»ºç›®å½• src/main/resources/META-INF/native-image åè¿è¡Œ java -Dspring.aot.enabled=true -agentlib:native-image-agent=config-output-dir=./src/main/resources/META-INF/native-image -jar target/your-app.jar ï¼ˆè‹¥åœ¨ Windows åˆ™æ³¨æ„è·¯å¾„å†™æ³•ï¼Œä»¥åŠä½¿ç”¨ -D\u0026quot;xxx\u0026quot; ä»£æ›¿ -Dxxxï¼‰\nå°è¯•é€šè¿‡æµ‹è¯•è¦†ç›–æ‰€æœ‰å¯èƒ½çš„æ§åˆ¶æµï¼Œä»¥ä¾¿åœ¨è¿è¡Œæ—¶æ–‡ä»¶ reflection-config.json ä¸­åŒ…å«å…³äºåå°„è°ƒç”¨çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå®Œæˆåä½¿ç”¨ Ctrl + C åœæ­¢åº”ç”¨ç¨‹åº\nå†æ¬¡è¿è¡Œ mvn -Pnative native:compile\næœ€ç»ˆè¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ target/your-app\nå‚è€ƒèµ„æ–™ Quarkus # Native Reference Guide\nSpring # GraalVM Native Image Support\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\n","date":"2023-11-18T23:39:26+08:00","permalink":"https://h2cone.github.io/2023/11/18/your-own-graalvm-native-image-cli-app/","title":"é€ ä½ è‡ªå·±çš„ GraalVM Native Image å‘½ä»¤è¡Œåº”ç”¨"},{"content":"ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ å›´ç»• I/O ä¸ºæ ¸å¿ƒçš„å•æœºä»»åŠ¡ï¼Œéš¾ç‚¹ä¹‹ä¸€æ˜¯æƒè¡¡åº”å¯¹è´Ÿè½½å¢åŠ çš„èƒ½åŠ›å’Œå¼€å‘çš„éš¾æ˜“ç¨‹åº¦ï¼Œä» ç½‘ç»œÂ·NIO ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒBlocking I/O ä¼˜ç‚¹æ˜¯æ¦‚å¿µç®€å•ï¼Œç¼ºç‚¹æ˜¯åœ¨ I/O æ“ä½œå®Œæˆä¹‹å‰ï¼Œçº¿ç¨‹å°†æ— æ³•æ‰§è¡Œä»»ä½•å…¶ä»–æ“ä½œï¼Œå¦å¤–ä¸€ç‚¹å®¹æ˜“å¿½è§†çš„æ˜¯å®ƒç»è¿‡ Java å †å¤åˆ¶æ•°æ®ï¼›Java NIO åŠ£åŠ¿æ˜¯æ¦‚å¿µè¾ƒå¤æ‚ï¼ˆè€ƒè™‘å¼‚æ­¥å®¹æ˜“å‡ºé”™ï¼‰ï¼Œä¼˜åŠ¿æ˜¯æ”¯æŒéé˜»å¡ I/O å’Œåˆ†é…ç›´æ¥å†…å­˜ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒåŸºäº NIO çš„æœåŠ¡æ¯”åŸºäº BIO çš„æœåŠ¡æ€§èƒ½è¡¨ç°æ›´å¥½ï¼Œä½†é˜»å¡å¼ I/O å¯¹å¹¿å¤§å¼€å‘è€…çš„å¿ƒæ™ºè´Ÿæ‹…æ›´ä½ã€‚\nä½¿ç”¨éé˜»å¡ I/O æ¨¡å‹éš¾ä»¥é¿å…å¼•å…¥å¼‚æ­¥ç¼–ç¨‹æˆ–å“åº”å¼ç¼–ç¨‹ï¼Œè€Œè¿™äº›èŒƒå¼å¯¹äºå¼€å‘è€…æ¥è¯´æ˜¯ä¸€ç§æŒ‘æˆ˜ï¼Œå› æ­¤è®¸å¤šä¸»æµè¯­è¨€éƒ½æä¾›äº†å°†å•çº¿ç¨‹é˜»å¡å¼ä»£ç è½¬åŒ–ä¸ºå¼‚æ­¥ã€éé˜»å¡å¼ä»£ç çš„è¯­æ³•ç³–ï¼Œæ¯”å¦‚ C#/JavaScript çš„ async/awaitï¼š\nè®©å‡ºï¼ˆyieldï¼‰æ§åˆ¶æƒç»™è°ƒç”¨è€…çº¿ç¨‹ã€‚ å°è¯•éšè—å¼‚æ­¥è°ƒç”¨ä¸åŒæ­¥è°ƒç”¨çš„å·®å¼‚ï¼Œä½¿å…¶çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç é‚£æ ·ç®€å•ã€‚ æ˜¯é€šè¿‡ç¼–è¯‘å™¨è‡ªåŠ¨å°† async æ–¹æ³•è½¬æ¢ä¸ºçŠ¶æ€æœºæ¥å®ç°çš„ã€‚ è¯¦æƒ…å‚è€ƒ Task asynchronous programming modelï¼Œéšç€è¶Šæ¥è¶Šå¤šçš„å¼‚æ­¥â€œä¼ æŸ“â€ç¨‹åºä»£ç ï¼Œæ€§èƒ½æé«˜ä»£ä»·å¯èƒ½æ˜¯è¶Šæ¥è¶Šéš¾ä»¥æ¨ç†ä»£ç ã€‚ç”±äºå„ç§å„æ ·çš„åŸå› ï¼ŒJava å®˜æ–¹æ²¡èµ° async/await çš„é“è·¯ï¼Œè€Œæ˜¯é€‰æ‹©äº†ç±»ä¼¼äº Go/Kotlin åç¨‹ çš„â€œç»¿è‰²çº¿ç¨‹â€ã€‚æ‰€è°“â€œç»¿è‰²â€æ˜¯ç›¸å¯¹äº OS çº¿ç¨‹è€Œè¨€ï¼Œå…¶ä¸­ Java çš„çº¿ç¨‹ç“¶é¢ˆå°¤ä¸ºä¸¥é‡ï¼Œå·²çŸ¥ 1 çº¿ç¨‹éœ€è¦å¤§å° 1MB çš„æ ˆï¼Œé‚£ä¹ˆ 10000 çº¿ç¨‹å¤§çº¦æ¶ˆè´¹ 10 GB å†…å­˜ï¼Œè¿™ç±»æ¥è‡ª OS çš„ç“¶é¢ˆä¿ƒä½¿å¼€å‘äººå‘˜è€ƒè™‘çº¿ç¨‹æ± æŠ€æœ¯ã€‚éšç€è´Ÿè½½çš„å¢åŠ ï¼ŒJava çº¿ç¨‹æ± çš„æ‰©å±•åˆæ˜¯ä¸€å¤§æŒ‘æˆ˜ï¼Œå®˜æ–¹æ­£å¼æ¨å‡ºçš„æŒ‘æˆ˜è€…æ˜¯è™šæ‹Ÿçº¿ç¨‹ã€‚\nâ€œæ¯çº¿ç¨‹ä¸€è¯·æ±‚â€çš„å´›èµ·ï¼Ÿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ExecutorService executor = Executors.newThreadPerTaskExecutor(Thread.ofVirtual().name(\u0026#34;my-thread\u0026#34;, 0).factory()); @Override public void run() { try (ServerSocket serverSocket = new ServerSocket(port)) { while (!Thread.interrupted()) { Socket socket = serverSocket.accept(); executor.submit(() -\u0026gt; handleRequest(socket)); } } catch (IOException e) { // ... } finally { executor.close(); } } åœ¨å¼€å§‹ä¹‹å‰éœ€è¦å…ˆæ¾„æ¸…è‹¥å¹²æ¦‚å¿µï¼š\næ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼ˆOS threadï¼‰ã€‚ç”±æ“ä½œç³»ç»Ÿç®¡ç†çš„æ•°æ®ç»“æ„ã€‚\nå¹³å°çº¿ç¨‹ï¼ˆPlatform threadï¼‰ã€‚åœ¨ Java 19 ä¹‹å‰ï¼ŒThread ç±»çš„æ¯ä¸ªå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªå¹³å°çº¿ç¨‹ï¼Œæ˜¯æ“ä½œç³»ç»Ÿçº¿ç¨‹çš„åŒ…è£…å™¨ã€‚åˆ›å»ºä¸€ä¸ªå¹³å°çº¿ç¨‹å°±ä¼šåˆ›å»ºä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œé˜»å¡ä¸€ä¸ªå¹³å°çº¿ç¨‹å°±ä¼šé˜»å¡ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚\nè™šæ‹Ÿçº¿ç¨‹ï¼ˆVirtual threadï¼‰ã€‚ç”± JVM ç®¡ç†çš„è½»é‡çº§çº¿ç¨‹ã€‚å®ƒä»¬æ‰©å±•äº†çº¿ç¨‹ç±»ï¼Œä½†ä¸ä¸ç‰¹å®šçš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ç»‘å®šã€‚å› æ­¤ï¼Œè™šæ‹Ÿçº¿ç¨‹çš„è°ƒåº¦ç”± JVM è´Ÿè´£ã€‚\nè½½ä½“çº¿ç¨‹ï¼ˆCarrier threadï¼‰ã€‚ç”¨äºè¿è¡Œè™šæ‹Ÿçº¿ç¨‹çš„å¹³å°çº¿ç¨‹ç§°ä¸ºè½½ä½“çº¿ç¨‹ã€‚å®ƒä¸æ˜¯ä¸€ä¸ªæœ‰åˆ«äº Thread æˆ– VirtualThread çš„ç±»ï¼Œè€Œæ˜¯ä¸€ä¸ªåŠŸèƒ½åç§°ã€‚\nJVM çº§åˆ«çš„è™šæ‹Ÿçº¿ç¨‹è°ƒåº¦å™¨å¯¹äºè™šæ‹Ÿçº¿ç¨‹åº”ç”¨ M : N è°ƒåº¦ï¼ˆM:N schedulingï¼‰ï¼ŒM è¡¨ç¤ºè¾ƒå¤šè™šæ‹Ÿçº¿ç¨‹æ•°ï¼ŒN è¡¨ç¤ºè¾ƒå°‘å¹³å°çº¿ç¨‹æ•°ï¼Œå¹¶ä¸” JVM åœ¨å¯åƒåœ¾å›æ”¶çš„å †ä¸­ä½¿ç”¨ Java å¯¹è±¡æ¥è¡¨ç¤ºè™šæ‹Ÿçº¿ç¨‹çš„æ ˆå¸§ã€‚\nè°ƒåº¦å™¨è°ƒåº¦è™šæ‹Ÿçº¿ç¨‹æ—¶ç»™è™šæ‹Ÿçº¿ç¨‹æŒ‚è½½ï¼ˆmountï¼‰ å¹³å°çº¿ç¨‹ï¼Œæ‰§è¡ŒæŸäº›ä»£ç æ—¶å¸è½½ï¼ˆunmountï¼‰å¹³å°çº¿ç¨‹ï¼ˆé€šå¸¸å‘ç”Ÿåœ¨æ‰§è¡Œé˜»å¡å¼ I/O æ“ä½œï¼‰ï¼Œå°†å®ƒé‡Šæ”¾åˆ° ForkJoinPool ç»´æŠ¤çš„çº¿ç¨‹æ± ï¼Œè™šæ‹Ÿçº¿ç¨‹ä¼šè¢«é˜»å¡åœ¨ I/O æ“ä½œç›´åˆ°å®Œæˆæ—¶æ‰è¢«è°ƒåº¦å™¨é‡æ–°è°ƒåº¦ã€‚\né˜»å¡æˆ–å¢åŠ å¹³å°çº¿ç¨‹ âŒ æŸäº›æ–¹æ³•ï¼ˆä¾‹å¦‚ Object.wait()ï¼‰ä¼šè§¦å‘æ•è·è½½ä½“çº¿ç¨‹ï¼ˆcaptureÂ the carrier threadï¼‰ï¼Œå¼•èµ·è½½ä½“çº¿ç¨‹ â¬†ï¸ é˜»å¡æˆ–å¢åŠ è™šæ‹Ÿçº¿ç¨‹ âœ… å›ºå®šè™šæ‹Ÿçº¿ç¨‹ï¼ˆpinned theadï¼‰ï¼šä¸å¸è½½ç›´åˆ°åœ¨ native method æˆ– synchronized code è¿”å›ï¼ŒæœŸé—´è½½ä½“çº¿ç¨‹â¬‡ï¸ è™šæ‹Ÿçº¿ç¨‹ API è®¾è®¡å€¾å‘äºå‡è½»å¼€å‘äººå‘˜å¿ƒæ™ºè´Ÿæ‹…ï¼Œå°†è™šæ‹Ÿçº¿ç¨‹å¤æ‚åº¦è½¬ç§»åˆ°å¹³å°å’Œåº“ï¼Œä½†ä½¿ç”¨æ—¶ä»ç„¶æœ‰ä¸å°‘æ³¨æ„äº‹é¡¹ï¼š\nä»¥â€œæ¯çº¿ç¨‹ä¸€è¯·æ±‚â€æ–¹å¼ç¼–å†™ç®€å•çš„åŒæ­¥ä»£ç ï¼Œé‡‡ç”¨é˜»å¡å¼ I/O APIã€‚\nå°†æ¯ä¸ªå¹¶å‘ä»»åŠ¡è¡¨ç¤ºä¸ºä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œåˆ‡å‹¿æ± åŒ–è™šæ‹Ÿçº¿ç¨‹ã€‚\nä½¿ç”¨ Semaphore é™åˆ¶å¹¶å‘æ•°ã€‚\nä¸è¦åœ¨ ThreadLocal ä¸­ç¼“å­˜æ˜‚è´µçš„å¯é‡ç”¨å¯¹è±¡ã€‚\né¿å…é•¿æ—¶é—´æˆ–é¢‘ç¹å›ºå®šè™šæ‹Ÿçº¿ç¨‹ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ Exploring the design of Javaâ€™s new virtual threads\nJEP 444: Virtual Threads\nOracle # Virtual Threads\nWhen Quarkus meets Virtual Threads\nQuarkus # VIRTUAL THREAD SUPPORT REFERENCE\nSpring # Embracing Virtual Threads\nHello, Java 21\nComparing Java Virtual Threads with Spring Reactive Webflux\n","date":"2023-09-26T22:32:39+08:00","permalink":"https://h2cone.github.io/2023/09/26/a-quick-look-at-virtual-threads/","title":"è™šæ‹Ÿçº¿ç¨‹é€Ÿè§ˆ"},{"content":"å†™åœ¨å‰é¢ ä¸Šä¸ªæœˆå‚ä¸å…¬å¸å°† LLM åº”ç”¨åˆ°åŸºäº Spring Boot çš„ä¸šåŠ¡ç³»ç»Ÿå·®äº‹ï¼šæ¥å…¥ ChatGPTã€‚\nAzure OpenAI Service Azure OpenAI æœåŠ¡å…è®¸é€šè¿‡ REST API è®¿é—® OpenAI çš„å¼ºå¤§è¯­è¨€æ¨¡å‹ï¼ŒåŒ…æ‹¬ GPT-3ã€Codex å’Œ Embeddings æ¨¡å‹ç³»åˆ—ã€‚ è¿™äº›æ¨¡å‹å¯ä»¥è½»æ¾é€‚åº”ç‰¹å®šçš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå†…å®¹ç”Ÿæˆã€æ±‡æ€»ã€è¯­ä¹‰æœç´¢å’Œè‡ªç„¶è¯­è¨€åˆ°ä»£ç çš„è½¬æ¢ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ REST APIã€Python SDK æˆ– Azure OpenAI Studio ä¸­åŸºäº Web çš„ç•Œé¢è®¿é—®è¯¥æœåŠ¡ã€‚\nä½¿ç”¨ Azure OpenAI æœåŠ¡åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸éœ€è¦ä»£ç†ï¼Œæ— ä¸¥æ ¼ç½‘ç»œå°é”ã€‚\nä¾èµ–åº“ åç«¯ TheoKanning/openai-javaã€‚Java ä¸­çš„ OpenAI GPT-3 API å®¢æˆ·ç«¯ã€‚\nknuddelsgmbh/jtokkitã€‚JTokkit æ˜¯ä¸€ä¸ª Java åˆ†è¯å™¨åº“ï¼Œè®¾è®¡ç”¨äº OpenAI æ¨¡å‹ã€‚\nå‰ç«¯ mpetazzoni/sse.jsã€‚ä¸€ä¸ªçµæ´»çš„ JavaScript SSE åº“ã€‚ è®¤è¯ ä¸ OpenAI API çš„ header è¦æ±‚åŒ…å« Authorization: Bearer $OPENAI_API_KEY ä¸åŒçš„æ˜¯ï¼ŒAzure OpenAI API çš„ header è¦æ±‚åŒ…å« api-key: $OPENAI_API_KEYï¼Œè¯¦æƒ…å‚è€ƒ Azure OpenAI Service REST API referenceã€‚\næç¤ºä¸è¡¥å…¨ åœ¨ä¸ LLM å¯¹è¯çš„è¿‡ç¨‹ä¸­ï¼Œæµå¼å“åº”ä½“éªŒæ¯”é˜»å¡å¼å“åº”å¥½å¾ˆå¤šã€‚\n1 2 3 4 5 6 7 8 9 10 public interface ChatApi extends OpenAiApi { @Streaming @POST(\u0026#34;{deployment}/chat/completions\u0026#34;) Call\u0026lt;ResponseBody\u0026gt; createChatCompletionStream( @Body ChatCompletionRequest request, @Path(\u0026#34;deployment\u0026#34;) String deployment, @Query(\u0026#34;api-version\u0026#34;) String version ); } è‡ªå®šä¹‰ API å®¢æˆ·ç«¯ä¸è¦†å†™æ¥å£å¯ä»¥ä½¿ç”¨ OpenAI API é£æ ¼çš„ Java åº“è°ƒç”¨ Azure OpenAI APIã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 @Getter private ChatApi chatApi; private ChatApi chatApi() { OkHttpClient httpClient = new OkHttpClient.Builder().addInterceptor(chain -\u0026gt; { Request rawRequest = chain.request(); Request request = rawRequest.newBuilder() .header(headerName, StrUtil.isBlank(headerPrefix) ? key : headerPrefix + key) .header(Header.CONTENT_TYPE.getValue(), ContentType.JSON.getValue()) .method(rawRequest.method(), rawRequest.body()) .build(); return chain.proceed(request); }).addInterceptor(chain -\u0026gt; { Request request = chain.request(); Response response = chain.proceed(request); Assert.notNull(response); if (!response.isSuccessful()) { ResponseBody body = response.body(); String bodyStr = Objects.nonNull(body) ? body.string() : null; log.warn(\u0026#34;{} {} -\u0026gt; {} {} {}\u0026#34;, request.method(), request.url(), response.code(), response.message(), bodyStr); BaseResponse\u0026lt;?\u0026gt; baseResponse = JSONUtil.toBean(bodyStr, BaseResponse.class, true); if (Objects.nonNull(baseResponse.getError())) { String message = baseResponse.getError().getMessage(); log.error(\u0026#34;!chatApi|{}\u0026#34;, message); } ErrorCode.OPENAI_API_NOT_AVAILABLE.throwOut(); } return response; }) .connectTimeout(timeout, TimeUnit.SECONDS) .writeTimeout(timeout, TimeUnit.SECONDS) .readTimeout(timeout, TimeUnit.SECONDS) .build(); return new Retrofit.Builder() .baseUrl(baseUrl) .client(httpClient) .addCallAdapterFactory(RxJava2CallAdapterFactory.create()) .addConverterFactory(JacksonConverterFactory.create(OBJECT_MAPPER)) .build() .create(ChatApi.class); } Chat API å®¢æˆ·ç«¯ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 @Override public Flowable\u0026lt;ChatCompletionsChunk\u0026gt; chatCompletionStream(ChatCompletionsRequest request) { request.setStream(true); String deployment = conf.modelDeployment.get(request.getModel()); return OpenAiService.stream(chatApi.createChatCompletionStream(request, deployment, conf.version), ChatCompletionsChunk.class); } SSE æ¥å£ åœ¨ Spring Boot ç¨‹åºå¼€å‘ SSE æ¥å£å‚è€ƒäº† Server-Sent Events in Springã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 @ApiOperation(\u0026#34;å‘é€æ¶ˆæ¯\u0026#34;) @PostMapping(\u0026#34;/conversation\u0026#34;) public SseEmitter conversation(@RequestBody ConversationParam param) throws InterruptedException { String username = JwtUtils.currentUser(); Assert.notBlank(username, ErrorCode.ACCOUNT_NOT_EXISTS); param.setUid(username); final SseEmitter emitter = new SseEmitter(); final SecurityManager securityManager = SecurityUtils.getSecurityManager(); param.setStream(true).setEmitter(emitter).setSecurityManager(securityManager); chatService.sendMessageAsync(param); return emitter; } é™¤äº† SSEï¼Œä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨ WebSocket å‘é€æ¶ˆæ¯ï¼ŒChatGPT å’Œ New Bing æ˜¯ä¸¤æ´¾çš„ä»£è¡¨ã€‚\nä¸Šä¸‹æ–‡æ·˜æ±° ç”±äº gpt-3.5-turbo çš„ Tokens é™åˆ¶ä¸º 4096ï¼Œä¸€ç§ç²—æš´çš„ç­–ç•¥æ˜¯å½“é¢„è®¡çš„å¯¹è¯ä¸Šä¸‹æ–‡è¶…è¿‡ä¸Šé™æ—¶ä¸¢å¼ƒè¾ƒæ—©çš„æ¶ˆæ¯ã€‚\n1 2 3 while (conv_history_tokens + max_response_tokens \u0026gt;= token_limit): del conversation[1] conv_history_tokens = num_tokens_from_messages(conversation) ç®€è¨€ä¹‹ï¼Œè¯·æ±‚ Tokens + æœ€å¤§å“åº” Tokens \u0026lt; æ¨¡å‹ Tokens é™åˆ¶ï¼Œå…¶ä¸­ Tokens è®¡ç®—å‚è€ƒï¼š\n1 2 3 4 5 6 7 8 9 10 11 def num_tokens_from_messages(messages, model=\u0026#34;gpt-3.5-turbo-0301\u0026#34;): encoding = tiktoken.encoding_for_model(model) num_tokens = 0 for message in messages: num_tokens += 4 # every message follows \u0026lt;im_start\u0026gt;{role/name}\\n{content}\u0026lt;im_end\u0026gt;\\n for key, value in message.items(): num_tokens += len(encoding.encode(value)) if key == \u0026#34;name\u0026#34;: # if there\u0026#39;s a name, the role is omitted num_tokens += -1 # role is always required and always 1 token num_tokens += 2 # every reply is primed with \u0026lt;im_start\u0026gt;assistant return num_tokens æŒ‰å‡åºä¸¢å¼ƒæ¶ˆæ¯å¯èƒ½ä¼šå‡ºç°ä¸¢å¤±ä¸ç”¨æˆ·æç¤ºæœ‰å…³çš„æ¶ˆæ¯æˆ–æºå¸¦ä¸ç”¨æˆ·æç¤ºä¸ç›¸å…³çš„å†…å®¹å‘é€åˆ° LLMï¼Œç»“æœæ˜¯å›å¤æ•ˆæœä¸å¥½ï¼Œè°ƒç”¨æˆæœ¬è¾ƒé«˜ã€‚è§‚å¯Ÿåˆ°å¸‚é¢ä¸Šä¸€äº›å¤„ç†é•¿æ–‡æœ¬çš„ LLM åº”ç”¨ä½¿ç”¨ LlamaIndex (GPT Index) â€œç»•è¿‡â€ Tokens é™åˆ¶ï¼Œå®ƒé€šè¿‡ Embeddings æ¨¡å‹ä¸æœ¬åœ°æ•°æ®åº“æŸ¥æ‰¾ä¸ç”¨æˆ·æç¤ºç›¸å…³çš„æ®µè½ï¼Œç„¶åä»è¿™äº›æ®µè½ä¸­ç”Ÿæˆ Prompt å–‚ç»™ LLMã€‚\næ¯” GPT Index å°è£…ç¨‹åº¦è¿˜é«˜çš„å¦ä¸€ä¸ª Python åº“ langchain çš„ç©æ³•æ˜¯çœŸçš„å¤š\u0026hellip;\u0026hellip;\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ Azure OpenAI Service Documentation\nWelcome to OpenAI\nHow to summarize a long text using GPT-3\nllama-index(gpt-index)ï¼šåchatgptæ—¶ä»£çš„å¯¹è¯å¼æ–‡æ¡£é—®ç­”è§£å†³æ–¹æ¡ˆ\n","date":"2023-04-26T13:54:13+08:00","permalink":"https://h2cone.github.io/2023/04/26/azure_openai_api_0/","title":"é€šè¿‡ Azure OpenAI API æ¥å…¥ ChatGPT"},{"content":"ğŸ§± æœ‰ä¸€é˜µå­è®¿é—® OpenAIï¼ˆç°åœ¨æ›´åƒ CloseAIï¼‰ çš„ä¸€äº›åŸŸåç»å¸¸é‡åˆ° Cloudflare çš„ Access Deniedï¼Œä¸€å¼€å§‹å°è¯•æ›´æ¢æœºæˆ¿ IP æ¥ä»£ç†ï¼Œå¯å‡ ä¹æ²¡æœ‰ä¸€ä¸ªä¸åœ¨é»‘åå•ã€‚ä¾¥å¹¸é€šè¿‡å…ˆèµ°ä»£ç†ï¼Œåœ¨ç™»å½•æœ€åä¸€æ­¥åˆ‡æ¢ä¸ºç›´è¿ç»•è¿‡äº†æ•°æ¬¡ï¼Œç›´åˆ°å›½å†…ç»ˆäºå½»åº•è¢«å¢™äº†ã€‚\nâ“ æ‰“ä¸è¿‡å°±åŠ å…¥å®ƒï¼šæµé‡å‡ºç«™è½¬å‘ Cloudflare ç½‘ç»œã€‚\nåœ¨ VPS ä¸Šå®‰è£… WARPï¼Œä»¥ Debian/Ubuntu ä¸ºä¾‹ï¼š 1 sudo apt install cloudflare-warp ä»¥æœ¬åœ°ä»£ç†æ¨¡å¼è¿è¡Œ WARP 1 2 3 4 warp-cli register warp-cli set-mode proxy warp-cli connect warp-cli enable-always-on æµ‹è¯•ä»£ç†æ¨¡å¼ 1 curl ifconfig.me ç•™æ„å‰åæ ‡å‡†è¾“å‡ºçš„åŒºåˆ«ã€‚\n1 2 export ALL_PROXY=socks5://127.0.0.1:40000 curl ifconfig.me é…ç½® V2Ray è®¾ç½®è·¯ç”±è§„åˆ™ï¼Œéå›½å†…åŸŸåèµ° WARP ä»£ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 { \u0026#34;routing\u0026#34;: { \u0026#34;domainStrategy\u0026#34;: \u0026#34;IPIfNonMatch\u0026#34;, \u0026#34;rules\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;field\u0026#34;, \u0026#34;outboundTag\u0026#34;: \u0026#34;reject\u0026#34;, \u0026#34;ip\u0026#34;: [ \u0026#34;geoip:private\u0026#34; ] }, { \u0026#34;type\u0026#34;: \u0026#34;field\u0026#34;, \u0026#34;outboundTag\u0026#34;: \u0026#34;proxy\u0026#34;, \u0026#34;domain\u0026#34;: [ \u0026#34;geosite:geolocation-!cn\u0026#34; ] }, { \u0026#34;type\u0026#34;: \u0026#34;field\u0026#34;, \u0026#34;outboundTag\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;network\u0026#34;: \u0026#34;udp,tcp\u0026#34; } ] } } å…¶ä¸­ WARP ä»£ç†çš„å‡ºç«™æ ‡ç­¾æ˜¯ proxyï¼Œä½¿ç”¨ WARP æœ¬åœ°ä»£ç†æ¨¡å¼åœ°å€å’Œç«¯å£ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 { \u0026#34;outbounds\u0026#34;: [ { \u0026#34;tag\u0026#34;: \u0026#34;reject\u0026#34;, \u0026#34;protocol\u0026#34;: \u0026#34;blackhole\u0026#34; }, { \u0026#34;tag\u0026#34;: \u0026#34;proxy\u0026#34;, \u0026#34;protocol\u0026#34;: \u0026#34;socks\u0026#34;, \u0026#34;settings\u0026#34;: { \u0026#34;servers\u0026#34;: [ { \u0026#34;address\u0026#34;: \u0026#34;127.0.0.1\u0026#34;, \u0026#34;port\u0026#34;: 40000 } ] } }, { \u0026#34;tag\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;protocol\u0026#34;: \u0026#34;freedom\u0026#34; } ] } ç”±äºåœ¨ V2Ray Server ä¸ç›®æ ‡ï¼ˆä¾‹å¦‚ chat.openai.comï¼‰ä¹‹é—´æ’å…¥ä¸€å±‚ Cloudflare WARPï¼Œå› æ­¤å‘ç›®æ ‡éšè—äº† V2Ray Server çš„çœŸå®åœ°å€ã€‚\nğŸ˜… è¿è¡Œä¸€æ®µæ—¶é—´å VPS ç»å¸¸ç½¢å·¥ï¼Œè¿ SSH éƒ½è¿ä¸é€šï¼Œç™»å½• Web æ§åˆ¶å°æ‰çŸ¥é“æ˜¯ Memory å’Œ Swap è´Ÿè½½è¿‡é«˜ï¼Œå¥½ä¸å®¹æ˜“è¿ä¸Šåç¡®å®šäº†å‡¶æ‰‹å°±æ˜¯ Cloudflare WARP å®¢æˆ·ç«¯ä¸€ä¸ªè¿›ç¨‹ warp-svcï¼Œä¸å°‘ç½‘å‹è¯´å®ƒå®¹æ˜“å†…å­˜æ³„æ¼ï¼Œä¹Ÿæ²¡æ‰¾åˆ°æºä»£ç ï¼ŒæŠŠæˆ‘ç»™æ°”å¾—ç›´æ¥ä½¿ç”¨ crontab æ¯åˆ†é’Ÿæ£€æŸ¥å®ƒæ¶ˆè€—å†…å­˜ç™¾åˆ†æ¯”æ˜¯å¦è¶…è¿‡æŒ‡å®šé˜ˆå€¼ï¼Œè‹¥æ˜¯åˆ™æ€æ­»å®ƒï¼ˆåæ­£ä¼šè‡ªåŠ¨é‡å¯ï¼‰ã€‚\n1 */1 * * * * kill -9 $(ps -C warp-svc --no-headers -o \u0026#34;pid,\\%mem\u0026#34; | awk \u0026#39;{ if ($2 \u0026gt; 40) print $1 }\u0026#39;) æ³¨æ„å‘½ä»¤ä¸­çš„ç™¾åˆ†æ¯”ç¬¦å· % é™¤éç”¨åæ–œæ  \\ è½¬ä¹‰ï¼Œå¦åˆ™å°†è¢« crontab æ”¹å˜ä¸ºæ¢è¡Œç¬¦ã€‚\nğŸ¤–ï¸ â€œæ€»çš„æ¥è¯´ï¼ŒCloudflare WARP çš„æœ¬è´¨æ˜¯ä¸€ä¸ªåŸºäº WireGuard åè®®çš„ VPN æœåŠ¡ï¼Œå®ƒé€šè¿‡åŠ å¯†å’Œéš§é“æŠ€æœ¯æ¥ä¿æŠ¤ç”¨æˆ·çš„éšç§å’Œå®‰å…¨ï¼ŒåŒæ—¶é€šè¿‡ä¼˜åŒ–è·¯ç”±ã€ç¼“å­˜åŠ é€Ÿç­‰æŠ€æœ¯æ¥æé«˜ç”¨æˆ·çš„ç½‘ç»œæ€§èƒ½å’Œä½“éªŒã€‚â€\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nğŸ” Announcing WARP for Linux and Proxy Mode\nUserspace WireGuardÂ® Implementation in Rust\nA platform for building proxies to bypass network restrictions.\n","date":"2023-04-05T16:22:44+08:00","permalink":"https://h2cone.github.io/2023/04/05/proxy_with_warp/","title":"V2Ray + Cloudflare WARP"},{"content":"è®¾é—® å…ˆæœ‰ Rust è¿˜æ˜¯å…ˆæœ‰ Rust ç¼–è¯‘å™¨ï¼Ÿ ç¬¬ä¸€ä¸ª Rust ç¼–è¯‘å™¨ä¸€å®šæ˜¯ç”¨é Rust å®ç°çš„ï¼Œå‡è®¾å®ƒå«å¼•å¯¼ç¼–è¯‘å™¨ï¼Œå·¨ä½¬ç”¨å¼•å¯¼ç¼–è¯‘å™¨æ¥ç¼–è¯‘ç”¨ Rust ç¼–å†™çš„ Rust ç¼–è¯‘å™¨æºä»£ç å¾—åˆ° Rust å®ç°çš„ Rust ç¼–è¯‘å™¨ï¼Œä»æ­¤ä»¥åçš„è¿­ä»£å¼€å‘æ— éœ€å¼•å¯¼ç¼–è¯‘å™¨ï¼Œè€Œæ˜¯åŸºäº Rust å®ç°çš„ Rust ç¼–è¯‘å™¨ã€‚\nç¬¬ä¸€æ¬¡çœ‹åˆ° rust-lang/rust å°±æœ‰è¿™æ ·çš„ç–‘é—®ï¼Œåæ¥æ‰æƒ³èµ·æ¥è¿™ç§è§£å†³æ–¹æ¡ˆè¢«ç§°ä¸ºè‡ªä¸¾ã€‚\nè¯­å¥ä¸è¡¨è¾¾å¼çš„åŒºåˆ«ï¼Ÿ è¯­å¥ï¼ˆstatementï¼‰æ˜¯æ‰§è¡ŒæŸäº›åŠ¨ä½œçš„æŒ‡ä»¤ï¼Œæ— è¿”å›å€¼ï¼›è¡¨è¾¾å¼ï¼ˆexpressionï¼‰è¢«ä¼°ç®—ï¼ˆevaluateï¼‰è¾“å‡ºè¿”å›å€¼ã€‚\nå½“åœ¨è¯­å¥è¡Œå°¾å¤„é‡åˆ° ; æ—¶ï¼Œå…¶å·¦é‚»çš„ç‰‡æ®µå°†è¢«ä¼°ç®—å‡ºè¿”å›å€¼ï¼Œè¯¥è¿”å›å€¼åˆè¢« = èµ‹äºˆæŸä¸ªå˜é‡ï¼Œå®ƒä»¬é€šå¸¸æˆå¯¹å‡ºç°ï¼Œè‹¥è¯¥ç‰‡æ®µä¸å«åˆ†å·ï¼Œåˆ™å®ƒè¢«çœ‹ä½œæ˜¯è¡¨è¾¾å¼ã€‚\nå†…å­˜åˆ†é…åœ¨å“ªé‡Œï¼Ÿ åŸºäºå †çš„å†…å­˜åˆ†é…ï¼ˆheap-based memory allocationï¼‰æˆ–åŸºäºæ ˆçš„å†…å­˜åˆ†é…ï¼ˆstack-based memory allocationï¼‰ã€‚èµ‹å€¼è¯­å¥ã€å‡½æ•°è°ƒç”¨ç­‰åœºæ™¯ç¦»ä¸å¼€ç»™å˜é‡ï¼ˆçš„å€¼ï¼‰åˆ†é…å†…å­˜ï¼Œå¾ˆå–œæ¬¢ä¹¦ä¸­çš„é¤å…éšå–»ï¼Œåœ¨æ ˆä¸Šåˆ†é…å†…å­˜å°±åƒå ç¢Ÿå­ï¼Œè€Œå †ä¸Šåˆ†é…å†…å­˜å°±åƒè¿›å…¥é¤å…æ‰¾ç©ºä½ã€‚\næ ‡é‡ç±»å‹ï¼ˆscalar typeï¼‰æ•°å€¼ä»…åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œæ¯”å¦‚æ•´æ•°ã€æµ®ç‚¹æ•°ã€å¸ƒå°”ã€å­—ç¬¦ï¼Œå®ƒä»¬çš„é•¿åº¦å›ºå®šçš„å«ä¹‰æ˜¯åœ¨è¿è¡Œæ—¶æ¯”ç‰¹åºåˆ—é•¿åº¦ä¸å¯å˜ï¼Œæ¢è¨€ä¹‹ï¼Œåœ¨ç¼–è¯‘æ—¶å°±å·²ç»çŸ¥é“å®ƒä»¬çš„å¤§å°ã€‚å¤åˆç±»å‹ï¼ˆCompound Typesï¼‰ä¸­çš„å…ƒç»„å’Œæ•°ç»„çš„é•¿åº¦å›ºå®šï¼Œå› æ­¤åœ¨æ ˆä¸Šåˆ†é…å†…å­˜ï¼›ç›¸åï¼Œåœ¨ç¼–è¯‘æ—¶æœªçŸ¥å¤§å°çš„æ•°æ®æˆ–å¯èƒ½æ”¹å˜å¤§å°çš„æ•°æ®å¿…é¡»è¢«å­˜å‚¨åœ¨å †ä¸Šï¼Œè€Œæ‰¾åˆ°å †ä¸Šæ•°æ®çš„æ–¹æ³•æ˜¯é€šè¿‡æ ˆä¸Šçš„æŒ‡é’ˆçš„å€¼â€”â€”è™šæ‹Ÿåœ°å€ï¼Œåœ°å€ä¸ºæ ‡é‡ã€‚æ€»è€Œè¨€ä¹‹ï¼Œè¦ä¹ˆä»…åœ¨æ ˆä¸Šåˆ†é…å†…å­˜ï¼Œè¦ä¹ˆæ—¢åœ¨æ ˆä¸Šï¼Œåˆåœ¨å †ä¸Šåˆ†é…å†…å­˜ã€‚\næ¯ä¸ªå°çŸ©å½¢å†…ï¼šæ ˆåœ¨å·¦ï¼Œå †åœ¨å³ã€‚ scalar æ ‡é‡ã€‚ ptr æŒ‡é’ˆã€‚ ç®­å¤´ï¼šåœ°å€æŒ‡å‘çš„ä½ç½®ã€‚ len é•¿åº¦ã€‚ cap å®¹é‡ã€‚ è“è‰²ï¼šlenã€‚ ç»¿è‰²ï¼šcap - lenã€‚ èµ‹å€¼è¯­å¥æˆ–å‡½æ•°è°ƒç”¨ä¼ å‚æœ¬è´¨ä¸Šæ˜¯çº¯æ ˆçš„æ•°æ®æ‹·è´? å¦‚æœåœ¨å †ä¸Šçš„æ•°æ®å¾ˆå¤§ï¼Œé‚£ä¹ˆå †çš„æ•°æ®æ‹·è´åœ¨è¿è¡Œæ—¶å¼€é”€éå¸¸æ˜‚è´µï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯éšå¼ Copyï¼Œé™¤éæ˜¾å¼ Cloneã€‚\nä»€ä¹ˆæ˜¯æ‰€æœ‰æƒï¼Ÿ æ‰€æœ‰æƒï¼ˆownershipï¼‰ä½¿ Rust èƒ½å¤Ÿæ— éœ€åƒåœ¾æ”¶é›†å™¨çš„æƒ…å†µä¸‹ä¿è¯å†…å­˜å®‰å…¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿åæ‰€æœ‰æƒè§„åˆ™ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ï¼Œæ‰€æœ‰æƒè§„åˆ™å¦‚ä¸‹æ‰€è¿°ï¼š\næ¯ä¸ªå€¼ï¼ˆvalueï¼‰éƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…ï¼ˆownerï¼‰ã€‚\nä¸€ä¸ªæ‰€æœ‰è€…æ˜¯ä¸€ä¸ªå˜é‡ã€‚\néšå¼åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…ï¼Œæ˜¾å¼æ”¯æŒå¤šä¸ªæ‰€æœ‰è€…ã€‚\nå½“æ‰€æœ‰è€…è¶…å‡ºä½œç”¨åŸŸï¼ˆvariable scopeï¼‰æ—¶ï¼Œè¯¥å€¼å°†è¢«é”€æ¯ï¼ˆdropï¼‰ã€‚\nèŒƒå›´å¼€å§‹äºå·¦å¤§æ‹¬å· {, ç»“æŸäºå³å¤§æ‹¬å· }ã€‚\né€šè¿‡å®ç° Drop æ¥é”€æ¯å€¼ã€‚\nåœ¨è§„åˆ™ä¹‹ä¸Šï¼Œæ‰€æœ‰æƒå¯ä»¥åœ¨å˜é‡ä¹‹é—´è½¬ç§»ï¼ˆmoveï¼‰ï¼Œç”¨å®˜æ–¹çš„ä¾‹å­æ¥è¯´ï¼Œè¢«å…¶å®ƒå˜é‡å¤ºèµ°æ‰€æœ‰æƒçš„å˜é‡å·²æ— æ•ˆã€‚\n1 2 3 4 let s1 = String::from(\u0026#34;hello\u0026#34;); let s2 = s1; // This code does not compile! println!(\u0026#34;{}, world!\u0026#34;, s1); ä¼ é€’å‡½æ•°å‚æ•°æˆ–æ¥æ”¶è¿”å›å€¼æ—¶è½¬ç§»æ‰€æœ‰æƒå¾ˆç¹çï¼Œä¸è¦ææ…Œï¼ŒRust æœ‰ä½¿ç”¨ä¸€ä¸ªå€¼è€Œä¸å¤ºå–æ‰€æœ‰æƒçš„ç‰¹æ€§ï¼šå¼•ç”¨ï¼ˆreferenceï¼‰ï¼Œæ¯”å¦‚ä¸Šæ–‡ 1.4 æ’å›¾ç¬¬ 3 åˆ—ç¬¬ 2 è¡Œã€‚\nå¼•ç”¨ä¸æŒ‡é’ˆçš„åŒºåˆ«ï¼Ÿ æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå†…å­˜åœ°å€ï¼Œå¯ä»¥ç”¨æ¥è®¿é—®å­˜å‚¨åœ¨è¯¥å†…å­˜åœ°å€ä¸Šçš„å€¼ï¼Œå¼•ç”¨ä¹Ÿç±»ä¼¼ï¼Œä¸æŒ‡é’ˆä¸åŒçš„æ˜¯ï¼Œå¼•ç”¨ä¿è¯åœ¨å¼•ç”¨çš„æœ‰æ•ˆæœŸå†…æŒ‡å‘ä¸€ä¸ªç‰¹å®šç±»å‹çš„æœ‰æ•ˆå€¼ï¼ˆç¼–è¯‘æ—¶æ£€æŸ¥ï¼‰ï¼Œå¼•ç”¨çš„è§„åˆ™å¦‚ä¸‹æ‰€è¿°ï¼š\nä¸€ä¸ªå˜é‡åªèƒ½æœ‰ä¸€ä¸ªå¯å˜ï¼ˆmutableï¼‰å¼•ç”¨ï¼Œæˆ–å¤šä¸ªä¸å¯å˜ï¼ˆimmutableï¼‰å¼•ç”¨ã€‚\nä¸€ä¸ªå¼•ç”¨æ˜¯ä¸€ä¸ªå˜é‡ã€‚\nå£°æ˜å˜é‡æ—¶ï¼Œå®ƒçš„å€¼é»˜è®¤æ˜¯ä¸å¯å˜çš„ï¼Œå³åªè¯»ï¼Œé™¤éä½¿ç”¨ mut ä¿®é¥°æ‰å¯å†™ã€‚\nå¼•ç”¨å¿…é¡»å§‹ç»ˆæœ‰æ•ˆï¼ˆvalidï¼‰ï¼Œå‚è€ƒç”Ÿå‘½å‘¨æœŸã€‚\nä»€ä¹ˆæ˜¯å€Ÿç”¨ï¼Ÿ å€Ÿç”¨ï¼ˆborrowï¼‰æ˜¯æŒ‡åœ¨ä¸æ‹¥æœ‰æ‰€æœ‰æƒçš„æƒ…å†µä¸‹ï¼Œä»ä¸€ä¸ªå˜é‡ä¸­å€Ÿç”¨å®ƒçš„å€¼ã€‚è¿™æ„å‘³ç€ï¼Œåœ¨æŸä¸ªæ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªå˜é‡å¯¹å®ƒè¿›è¡Œå€Ÿç”¨ã€‚è¿™æ ·åšå¯ä»¥é¿å…æ•°æ®ç«äº‰ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†çµæ´»æ€§ï¼Œå› ä¸ºå¤šä¸ªå˜é‡å¯ä»¥å¯¹åŒä¸€ä¸ªå€¼è¿›è¡Œå€Ÿç”¨ã€‚\nç”»å›¾å¤ªéº»çƒ¦äº†ï¼Œç›´æ¥å€Ÿç”¨ Graphical depiction of ownership and borrowing in Rustã€‚\nä»€ä¹ˆæ˜¯æ•°æ®ç«äº‰ï¼Ÿ æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰æ˜¯æŒ‡åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œç”±äºçº¿ç¨‹ä¹‹é—´çš„æ‰§è¡Œé¡ºåºæ— æ³•é¢„çŸ¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç»“æœä¸å¯é¢„æµ‹æˆ–é”™è¯¯çš„æƒ…å†µï¼Œå‘ç”Ÿæ•°æ®ç«äº‰æœ‰ä¸‰ä¸ªæ¡ä»¶ï¼š\nä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹/çº¿ç¨‹/åç¨‹å¹¶å‘è®¿é—®ç›¸åŒçš„å˜é‡ã€‚\nè‡³å°‘æœ‰ä¸€ä¸ªè®¿é—®æ˜¯å†™å…¥ã€‚\næ²¡æœ‰åŒæ­¥è®¿é—®æœºåˆ¶ã€‚\nä»€ä¹ˆæ˜¯ç”Ÿå‘½å‘¨æœŸï¼Ÿ å˜é‡åœ¨ä½œç”¨åŸŸä¸­ä»åˆå§‹åŒ–åˆ°é”€æ¯çš„æ•´ä¸ªè¿‡ç¨‹ç§°ä¹‹ä¸ºç”Ÿå‘½å‘¨æœŸï¼ˆlifetimeï¼‰ã€‚ç”Ÿå‘½å‘¨æœŸä¸»è¦ç›®çš„æ˜¯é˜²æ­¢â€œæ‚¬æŒ‚å¼•ç”¨â€å’Œâ€œæ‚¬ç©ºæŒ‡é’ˆâ€é”™è¯¯ï¼Œæ¯”å¦‚å½“å¤šä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªåœ°å€æ—¶ï¼Œé€šè¿‡ä¸€ä¸ªæŒ‡é’ˆé”€æ¯äº†è¯¥åœ°å€çš„æ•°æ®ï¼Œå¦ä¸€ä¸ªæŒ‡é’ˆå°±äº§ç”Ÿäº†æ‚¬æŒ‚å¼•ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸæ³¨è§£æ¥ç¡®ä¿å¼•ç”¨åœ¨æˆ‘ä»¬éœ€è¦æ—¶æœ‰æ•ˆã€‚\nString ä¸ \u0026amp;str çš„åŒºåˆ«ï¼Ÿ String å’Œ \u0026amp;str æ˜¯ Rust ä¸­çš„ä¸¤ç§ä¸åŒçš„å­—ç¬¦ä¸²ç±»å‹ï¼š\nString ç±»å‹è¡¨ç¤ºä¸€ä¸ªå¯å˜çš„ã€UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ã€‚å®ƒæ˜¯ä¸€ä¸ªç±»å‹å®‰å…¨çš„ã€åŠ¨æ€åˆ†é…å†…å­˜çš„å­—ç¬¦ä¸²ç±»å‹ï¼Œå¯ä»¥éšæ—¶æ‰©å±•æˆ–æ”¶ç¼©å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚String ç±»å‹å¯ä»¥éšæ—¶è¢«ä¿®æ”¹ï¼Œå¹¶ä¸”å®ƒçš„æ‰€æœ‰æƒåœ¨æ•´ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸå†…éƒ½è¢«ä¿æŒã€‚\n\u0026amp;str ç±»å‹è¡¨ç¤ºä¸€ä¸ªä¸å¯å˜çš„ã€UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å­—ç¬¦ä¸²æ•°æ®çš„æŒ‡é’ˆã€‚ç”±äº \u0026amp;str ç±»å‹æ˜¯ä¸å¯å˜çš„ï¼Œå› æ­¤å®ƒä¸èƒ½è¢«ä¿®æ”¹ï¼Œä¹Ÿä¸èƒ½æ‰©å±•æˆ–æ”¶ç¼©å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚\u0026amp;str ç±»å‹å¯ä»¥è¢«å½“ä½œä¸€ä¸ªåªè¯»çš„å­—ç¬¦ä¸²å€¼æ¥ä½¿ç”¨ï¼Œä½†æ˜¯å®ƒä¸èƒ½è¢«ä¿®æ”¹ã€‚\nä»€ä¹ˆæ˜¯ Monomorphizationï¼Ÿ Monomorphization æ˜¯ä¸€ç§ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ï¼Œå®ƒçš„ç›®çš„æ˜¯å°†å¤šæ€ä»£ç ï¼ˆå³å…·æœ‰å¤šç§å¯èƒ½ç±»å‹çš„ä»£ç ï¼‰è½¬æ¢ä¸ºå•æ€ä»£ç ï¼ˆå³åªæœ‰ä¸€ç§å¯èƒ½ç±»å‹çš„ä»£ç ï¼‰ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥æé«˜ä»£ç çš„æ‰§è¡Œæ•ˆç‡ï¼Œå› ä¸ºå•æ€ä»£ç å¯ä»¥è¢«ç¼–è¯‘å™¨æ›´å¥½åœ°ä¼˜åŒ–ã€‚\nä»€ä¹ˆæ˜¯ Blanket implementationsï¼Ÿ Blanket implementations æ˜¯æŒ‡åœ¨ Rust ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œä¸ºä¸€ç±»ç±»å‹å®ç°ä¸€ä¸ª traitï¼ˆå³æ¥å£ï¼‰çš„æ–¹æ³•ï¼Œä½¿å¾—è¿™ä¸€ç±»ç±»å‹éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ª trait çš„æ–¹æ³•ã€‚è¿™ç§æ–¹æ³•å¯ä»¥è®©å¼€å‘è€…æ›´æ–¹ä¾¿åœ°å®šä¹‰ä¸€ç»„ç±»å‹æ‰€å…±æœ‰çš„è¡Œä¸ºï¼Œå¹¶ä¸”å¯ä»¥è®©è¿™äº›ç±»å‹åœ¨è¿è¡Œæ—¶å…·æœ‰æ›´é«˜çš„æ€§èƒ½ã€‚\nè¿­ä»£å™¨æ¯”å¾ªç¯å¿«ï¼Ÿ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨è¿­ä»£å™¨ï¼ˆiteratorï¼‰å¯èƒ½æ¯”ä½¿ç”¨å¾ªç¯ï¼ˆloopï¼‰æ‰§è¡Œå¾—æ›´å¿«ã€‚è¿™æ˜¯å› ä¸ºè¿­ä»£å™¨å¯ä»¥è®©ç¼–è¯‘å™¨è¿›è¡Œæ›´å¤šçš„ä¼˜åŒ–ï¼Œä¾‹å¦‚é¢„å…ˆè®¡ç®—è¿­ä»£æ¬¡æ•°å¹¶å¯¹å¾ªç¯è¿›è¡Œå±•å¼€ï¼ˆunrollingï¼‰ï¼Œä»è€Œå‡å°‘äº†è¿è¡Œæ—¶çš„å¼€é”€ã€‚æ­¤å¤–ï¼Œè¿­ä»£å™¨è¿˜å¯ä»¥æ›´é«˜æ•ˆåœ°å¤„ç†å¤§å‹æ•°æ®é›†ï¼Œå› ä¸ºå®ƒåªä¼šåœ¨éœ€è¦æ—¶æ‰åŠ è½½å’Œå¤„ç†æ•°æ®ã€‚\næœ‰å“ªäº›é›¶æˆæœ¬æŠ½è±¡ï¼Ÿ é›¶æˆæœ¬æŠ½è±¡æ˜¯æŒ‡åœ¨ç¼–è¯‘æ—¶æ‰§è¡Œçš„æŠ½è±¡æ“ä½œï¼Œä¸ä¼šå¸¦æ¥é¢å¤–çš„è¿è¡Œæ—¶å¼€é”€ã€‚Rust ä¸­æœ‰å¤šç§é›¶æˆæœ¬æŠ½è±¡çš„å®ç°æ–¹å¼ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š\nTraitsï¼štraits æ˜¯ Rust ä¸­çš„æ¥å£ç±»å‹ï¼Œå¯ä»¥ç”¨æ¥å®šä¹‰ä¸€ç»„ç±»å‹æ‰€å…±æœ‰çš„è¡Œä¸ºã€‚ä½¿ç”¨ traits å¯ä»¥åœ¨ç¼–è¯‘æ—¶å°†å¤šæ€ä»£ç è½¬æ¢ä¸ºå•æ€ä»£ç ï¼Œä»è€Œæé«˜ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€‚ Genericsï¼šgenerics æ˜¯ Rust ä¸­çš„æ³›å‹ç±»å‹ï¼Œå¯ä»¥ç”¨æ¥å®šä¹‰æ”¯æŒå¤šç§ç±»å‹çš„ä»£ç ã€‚ä½¿ç”¨ generics å¯ä»¥åœ¨ç¼–è¯‘æ—¶ä¸ºæ¯ç§ç±»å‹ç”Ÿæˆä¸åŒçš„ä»£ç ç‰ˆæœ¬ï¼Œä»è€Œé¿å…åœ¨è¿è¡Œæ—¶è¿›è¡Œç±»å‹æ£€æŸ¥ã€‚ Closuresï¼šclosures æ˜¯ Rust ä¸­çš„åŒ¿åå‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥å®šä¹‰ç®€å•çš„å‡½æ•°é€»è¾‘ã€‚ä½¿ç”¨ closures å¯ä»¥åœ¨ç¼–è¯‘æ—¶è¿›è¡Œç±»å‹æ¨æ–­å’Œä»£ç ä¼˜åŒ–ï¼Œä»è€Œé¿å…åœ¨è¿è¡Œæ—¶è¿›è¡Œç±»å‹æ£€æŸ¥å’Œå†…å­˜åˆ†é…ã€‚ å¼•ç”¨ä¸æ™ºèƒ½æŒ‡é’ˆçš„åŒºåˆ«? å¼•ç”¨ï¼ˆ\u0026amp;Tï¼‰å’Œæ™ºèƒ½æŒ‡é’ˆï¼ˆå¦‚ Box\u0026lt;T\u0026gt; å’Œ Rc\u0026lt;T\u0026gt;ï¼‰éƒ½æ˜¯ç”¨æ¥å¤„ç†å†…å­˜ç®¡ç†çš„ç±»å‹ã€‚å®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œå¼•ç”¨æ˜¯ä¸€ä¸ªä¸å¯å˜çš„æŒ‡å‘æŸä¸ªå€¼çš„æŒ‡é’ˆï¼Œè€Œæ™ºèƒ½æŒ‡é’ˆæ˜¯ä¸€ç§å¸¦æœ‰é¢å¤–ç‰¹æ€§çš„æŒ‡é’ˆï¼Œå®ƒä¸ä»…èƒ½ä¿è¯æ•°æ®çš„å®‰å…¨ï¼Œè¿˜èƒ½è‡ªåŠ¨ç®¡ç†å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ã€‚æ¯”å¦‚ï¼ŒBox\u0026lt;T\u0026gt; ç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆç”¨äºåœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œå¹¶è‡ªåŠ¨åœ¨æŒ‡é’ˆç¦»å¼€ä½œç”¨åŸŸæ—¶é‡Šæ”¾å†…å­˜ï¼›Rc\u0026lt;T\u0026gt; ç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆåˆ™ç”¨äºç»´æŠ¤å¼•ç”¨è®¡æ•°ï¼Œå¹¶åœ¨å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶é‡Šæ”¾å†…å­˜ã€‚\nDeref æ˜¯ä»€ä¹ˆï¼Ÿ Deref coercionÂ converts a reference to a type that implements theÂ Deref trait into a reference to another type. For example, deref coercion can convertÂ \u0026amp;String toÂ \u0026amp;str becauseÂ String implements theÂ Deref trait such that it returnsÂ \u0026amp;str .\nRust callsÂ deref to turn theÂ \u0026amp;String intoÂ \u0026amp;str \u0026amp;str æ¥è‡ªå¯¹ String åˆ‡ç‰‡ï¼ˆç”¨ \u0026amp; ä¸Â [..]ï¼‰ \u0026amp;String æ˜¯ç±»å‹ä¸º String çš„æ•°æ®çš„å¼•ç”¨ ä¸å­˜åœ¨ç±»å‹ï¼šstr å¦‚ä½•é€‰æ‹©æ™ºèƒ½æŒ‡é’ˆï¼Ÿ TheÂ Box\u0026lt;T\u0026gt; type has a known size and points to data allocated on the heap. TheÂ Rc\u0026lt;T\u0026gt; type keeps track of the number of references to data on the heap so that data can have multiple owners. TheÂ RefCell\u0026lt;T\u0026gt; type with its interior mutability gives us a type that we can use when we need an immutable type but need to change an inner value of that type; it also enforces the borrowing rules at runtime instead of at compile time. å¼•ç”¨å¾ªç¯ä¼šæ³„æ¼å†…å­˜ï¼Ÿ Reference variable å¯ä»¥ drop ä¸” reference count å¯ä»¥é€’å‡ï¼Œä½†å®ƒæŒ‡å‘çš„å®ä¾‹æˆ–å€¼åœ¨å †ä¸Šå´ä¸èƒ½è¢« dropï¼Œç”±äºå¼•ç”¨å¾ªç¯ï¼Œå®ä¾‹çš„ reference count ä¸ä¸ºé›¶\u0026hellip;\u0026hellip;\nå¼ºå¼•ç”¨ä¸å¼±å¼•ç”¨çš„åŒºåˆ«ï¼Ÿ åœ¨æˆ‘çœ‹æ¥ strong reference ä¸ weak referenceï¼š\ndrop æˆ–è€… clean up æ—¶å¼±å¼•ç”¨å¿½ç•¥ä¸è®¡ Weak å¼•ç”¨çš„å€¼å¯èƒ½å·²è¢«åˆ é™¤ cloneã€downgradeã€upgrade Rc æ˜¯å¼ºï¼ˆè¢«ï¼‰å¼•ç”¨ç±»å‹ï¼ŒWeak æ˜¯å¼±ï¼ˆè¢«ï¼‰å¼•ç”¨ç±»å‹ å¦‚ä½•æ„é€ æ ‘ï¼Ÿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 use std::cell::RefCell; use std::rc::{Rc, Weak}; #[derive(Debug)] struct Node { value: i32, // ä»ç»“ç‚¹åˆ°çˆ¶ç»“ç‚¹æ˜¯å¼±å¼•ç”¨ï¼ˆé˜²æ­¢å› å¼•ç”¨å¾ªç¯è€Œæ³„æ¼å†…å­˜ // æ›´æ”¹å…¶çˆ¶èŠ‚ç‚¹ parent: RefCell\u0026lt;Weak\u0026lt;Node\u0026gt;\u0026gt;, // ä»ç»“ç‚¹åˆ°å­ç»“ç‚¹æ˜¯å¼ºå¼•ç”¨ï¼ˆ å½“ç»“ç‚¹è¢« drop æ—¶ï¼Œå®ƒçš„å­ç»“ç‚¹ä¹Ÿåº”è¯¥è¢« drop // ç»“ç‚¹èƒ½å¤Ÿè¢«å…¶å®ƒå˜é‡å¼•ç”¨ï¼ˆå…è®¸å¤šä¸ª onwers // æ›´æ”¹å“ªäº›ç»“ç‚¹æ˜¯å¦ä¸€ä¸ªç»“ç‚¹çš„å­—ç»“ç‚¹ children: RefCell\u0026lt;Vec\u0026lt;Rc\u0026lt;Node\u0026gt;\u0026gt;\u0026gt;, } å¦‚ä½•æ„é€ çº¿ç¨‹æ± ï¼Ÿ æœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå…¶å®ƒ The Rust Programming Language\nString vs \u0026amp;str in Rust\nArrays, vectors and slices in Rust\nOpen API # ChatGPT\n","date":"2022-12-04T21:17:41+08:00","permalink":"https://h2cone.github.io/2022/12/04/rust_rookie_qa/","title":"Rust å…«è‚¡"},{"content":"å‰è¨€ æ­£åˆ™è¡¨è¾¾å¼æ˜¯æŒ‡å®šæ–‡æœ¬ä¸­æœç´¢æ¨¡å¼çš„å­—ç¬¦åºåˆ—ï¼Œè¿™ç§æ¨¡å¼è¢«å­—ç¬¦ä¸²æœç´¢ç®—æ³•ç”¨äºå¯¹å­—ç¬¦ä¸²è¿›è¡ŒæŸ¥æ‰¾ã€æ›¿æ¢ã€æ ¡éªŒç­‰ã€‚\næ‹†åˆ† åœ¨æ—¥å¿—è§£æé¢†åŸŸï¼Œæ—¶å¸¸é‡åˆ°æ»¡è¶³ç‰¹å®šæ¨¡å¼çš„æ—¥å¿—æ¡ç›®ï¼Œæ¯”å¦‚â€œå¤´éƒ¨â€æ˜¯æ—¶é—´ä¿¡æ¯ï¼Œâ€œèº«ä½“â€æ˜¯è¯¦ç»†ä¿¡æ¯çš„æ—¥å¿—æ¡ç›®ï¼š\n1 2 % cat a0.log \u0026lt;30\u0026gt;May 21 21:33:47 localhost alert: {category=æ¼æ´æ‰«æäº‹ä»¶} {type=WebShell} {priority=æç¤º} {typeCN=Webåé—¨} {level=6} {id=974609} {time=2018-05-21 21:33:04} {sip=101.206.169.180} {sport=49187} {dip=10.1.186.7} {dport=9084} {host=m.****.com.cn:9084} {code=200} {sysurl=/sys/web_session.php?level=6\u0026amp;sid=974609} {attach=/sys/web_session.php?act=download\u0026amp;level=6\u0026amp;sid=974609} {intent=ä¸Šä¼ å¯æ‰§è¡Œè„šæœ¬æˆ–WebShellæ–‡ä»¶} {detail=åœ¨Postæ•°æ®åŒ…ä¸­å‘ç°å«æœ‰JSP/ASP/ASP.NETä»£ç ç‰¹å¾çš„å­—ç¬¦ï¼š\u0026lt;%request/QueryString/Form/[\u0026#39;...\u0026#39;]%\u0026gt;} {dev=zonghang01} {url=http://m.****.com.cn:9084/pmobile/MCPerEAccountSignTrs.do} äººè„‘èƒ½å¤Ÿä»å°‘é‡æ—¥å¿—æ¡ç›®å½’çº³å‡ºæ—¥å¿—çš„æ ¼å¼ï¼Œä¹Ÿèƒ½ä»ç¨‹åºå¼€å‘è€…çš„è§’åº¦çœ‹è§æ—¥å¿—çš„ç»“æ„ï¼Œä½†æ˜¯è®¡ç®—æœºåªæœ‰åœ¨äººç±»çš„æŒ‡å¯¼ï¼ˆå£°æ˜å­—ç¬¦ä¸²æ»¡è¶³çš„æ¨¡å¼ï¼‰ä¸‹æ‰èƒ½åŒºåˆ†æ—¥å¿—æ¡ç›®çš„å„ä¸ªç»„æˆéƒ¨åˆ†ã€‚\n1 2 3 % cat a0.log | sd \u0026#39;(\u0026lt;\\d+\u0026gt;\\w+\\s+\\d{1,2}\\s+\\d{2}:\\d{2}:\\d{2}\\s+\\w+\\s+\\w+:\\s+)(.+)\u0026#39; \u0026#39;$1\\n$2\u0026#39; \u0026lt;30\u0026gt;May 21 21:33:47 localhost alert: {category=æ¼æ´æ‰«æäº‹ä»¶} {type=WebShell} {priority=æç¤º} {typeCN=Webåé—¨} {level=6} {id=974609} {time=2018-05-21 21:33:04} {sip=101.206.169.180} {sport=49187} {dip=10.1.186.7} {dport=9084} {host=m.****.com.cn:9084} {code=200} {sysurl=/sys/web_session.php?level=6\u0026amp;sid=974609} {attach=/sys/web_session.php?act=download\u0026amp;level=6\u0026amp;sid=974609} {intent=ä¸Šä¼ å¯æ‰§è¡Œè„šæœ¬æˆ–WebShellæ–‡ä»¶} {detail=åœ¨Postæ•°æ®åŒ…ä¸­å‘ç°å«æœ‰JSP/ASP/ASP.NETä»£ç ç‰¹å¾çš„å­—ç¬¦ï¼š\u0026lt;%request/QueryString/Form/[\u0026#39;...\u0026#39;]%\u0026gt;} {dev=zonghang01} {url=http://m.****.com.cn:9084/pmobile/MCPerEAccountSignTrs.do} å‘½ä»¤è¡Œå·¥å…· sd ç”¨äºåœ¨æ–‡æœ¬ä¸­æŸ¥æ‰¾ä¸æ›¿æ¢ï¼Œå®ƒæ—¢æ”¯æŒåŸºäºå­—é¢é‡çš„æŸ¥æ‰¾ï¼Œä¹Ÿæ”¯æŒåŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„æŸ¥æ‰¾ã€‚ä¸Šæ–‡æ•´æ¡å‘½ä»¤è¡¨ç¤ºå°†æ–‡ä»¶ a1.log è¾“å…¥åˆ° sdï¼Œå®ƒç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ›¿æ¢å‰å­—ç¬¦ä¸²æ»¡è¶³çš„æ¨¡å¼ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ›¿æ¢åçš„å­—ç¬¦ä¸²æ ¼å¼ï¼Œä»è¾“å‡ºç»“æœå¯ä»¥çœ‹åˆ°æ—¥å¿—æ¡ç›®çš„â€œå¤´éƒ¨â€å’Œâ€œèº«ä½“â€ä¹‹é—´å·²é€šè¿‡è¡Œåˆ†éš”ç¬¦ \\n åˆ†éš”ï¼Œç›¸å½“äºæ‹†åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ã€‚\næ­£åˆ™è¡¨è¾¾å¼é€šå¸¸åŒ…å«å…ƒå­—ç¬¦ï¼Œå…¶ä¸­ (X) è¡¨ç¤ºä¸€ä¸ªç»„ï¼ˆGroupï¼‰çš„ä¸€åæˆå‘˜ Xï¼Œä¸€ä¸ªç»„æ˜¯æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åˆ°çš„ä¸€ä¸ªå­å­—ç¬¦ä¸²ï¼Œé€šè¿‡ä» 0 å¼€å§‹ä¸”æ­¥é•¿ä¸º 1 çš„å•è°ƒé€’å¢çš„ç´¢å¼•ï¼ˆindexï¼‰å®šä½å„åæˆå‘˜ï¼ˆå­å­å­—ç¬¦ä¸²ï¼‰ã€‚\n1 2 % echo \u0026#39;lizzy 2 2002\u0026#39; | sd \u0026#39;(\\w+)\\s+(\\d+)\\s+(\\d+)\u0026#39; \u0026#39;name: $1, gender: $2, birth: $3, raw: \u0026#34;$0\u0026#34;\u0026#39; name: lizzy, gender: 2, birth: 2002, raw: \u0026#34;lizzy 2 2002\u0026#34; ç´¢å¼•ä¸º 0 çš„æˆå‘˜å§‹ç»ˆä»£è¡¨æ•´ä¸ªç»„ã€‚\næå–é”®å€¼å¯¹ ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä½œç”¨äºæ–‡æœ¬å¯èƒ½åŒ¹é…åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªç»„ï¼Œæ¯ä¸ªç»„åˆèƒ½æŒ‰ç…§ç´¢å¼•æ‹†åˆ†ã€‚\n1 2 % cat a1.log \u0026lt;30\u0026gt;May 21 22:01:16 localhost alert: {category=æ¼æ´æ‰«æäº‹ä»¶} {type=WebShell} {priority=æç¤º} {typeCN=Webåé—¨} {level=6} {id=974612} {time=2018-05-21 22:01:12} {sip=125.45.235.110} {sport=42425} {dip=10.1.186.5} {dport=9223} {host=ebank.****.com.cn:9223} {code=200} {sysurl=/sys/web_session.php?level=6\u0026amp;sid=974612} {attach=/sys/web_session.php?act=download\u0026amp;level=6\u0026amp;sid=974612} {intent=ä¸Šä¼ å¯æ‰§è¡Œè„šæœ¬æˆ–WebShellæ–‡ä»¶} {detail=åœ¨Postæ•°æ®åŒ…ä¸­å‘ç°å«æœ‰JSP/ASP/ASP.NETä»£ç ç‰¹å¾çš„å­—ç¬¦ï¼š\u0026lt;%request/QueryString/Form/[\u0026#39;...\u0026#39;]%\u0026gt;} {dev=zonghang01} {url=http://ebank.****.com.cn:9223/pWeb/FP410803.do?Wdserialno=CIP06A029396} ä½¿ç”¨ Java APIs ä» a1.log æå–ç”¨æˆ·æ„Ÿå…´è¶£çš„ä¿¡æ¯ï¼Œä¾‹å¦‚é”®å€¼å¯¹ã€‚\n1 2 3 4 5 6 7 8 9 10 String text = Files.readString(Paths.get(\u0026#34;/path/to/a1.log\u0026#34;)); // ç§»é™¤è½¬ä¹‰åçš„è¡¨è¾¾å¼ä¸º \\{(\\w+?)=(.+?)} Pattern pattern = Pattern.compile(\u0026#34;\\\\{(\\\\w+?)=(.+?)}\u0026#34;); Matcher matcher = pattern.matcher(text); while (matcher.find()) { String kv = matcher.group(0); String k = matcher.group(1); String v = matcher.group(2); System.out.printf(\u0026#34;%s \u0026lt;=\u0026gt; %s -\u0026gt; %s\u0026#34; + System.lineSeparator(), kv, k, v); } æ ‡å‡†è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 {category=æ¼æ´æ‰«æäº‹ä»¶} \u0026lt;=\u0026gt; category -\u0026gt; æ¼æ´æ‰«æäº‹ä»¶ {type=WebShell} \u0026lt;=\u0026gt; type -\u0026gt; WebShell {priority=æç¤º} \u0026lt;=\u0026gt; priority -\u0026gt; æç¤º {typeCN=Webåé—¨} \u0026lt;=\u0026gt; typeCN -\u0026gt; Webåé—¨ {level=6} \u0026lt;=\u0026gt; level -\u0026gt; 6 {id=974612} \u0026lt;=\u0026gt; id -\u0026gt; 974612 {time=2018-05-21 22:01:12} \u0026lt;=\u0026gt; time -\u0026gt; 2018-05-21 22:01:12 {sip=125.45.235.110} \u0026lt;=\u0026gt; sip -\u0026gt; 125.45.235.110 {sport=42425} \u0026lt;=\u0026gt; sport -\u0026gt; 42425 {dip=10.1.186.5} \u0026lt;=\u0026gt; dip -\u0026gt; 10.1.186.5 {dport=9223} \u0026lt;=\u0026gt; dport -\u0026gt; 9223 {host=ebank.****.com.cn:9223} \u0026lt;=\u0026gt; host -\u0026gt; ebank.****.com.cn:9223 {code=200} \u0026lt;=\u0026gt; code -\u0026gt; 200 {sysurl=/sys/web_session.php?level=6\u0026amp;sid=974612} \u0026lt;=\u0026gt; sysurl -\u0026gt; /sys/web_session.php?level=6\u0026amp;sid=974612 {attach=/sys/web_session.php?act=download\u0026amp;level=6\u0026amp;sid=974612} \u0026lt;=\u0026gt; attach -\u0026gt; /sys/web_session.php?act=download\u0026amp;level=6\u0026amp;sid=974612 {intent=ä¸Šä¼ å¯æ‰§è¡Œè„šæœ¬æˆ–WebShellæ–‡ä»¶} \u0026lt;=\u0026gt; intent -\u0026gt; ä¸Šä¼ å¯æ‰§è¡Œè„šæœ¬æˆ–WebShellæ–‡ä»¶ {detail=åœ¨Postæ•°æ®åŒ…ä¸­å‘ç°å«æœ‰JSP/ASP/ASP.NETä»£ç ç‰¹å¾çš„å­—ç¬¦ï¼š\u0026lt;%request/QueryString/Form/[\u0026#39;...\u0026#39;]%\u0026gt;} \u0026lt;=\u0026gt; detail -\u0026gt; åœ¨Postæ•°æ®åŒ…ä¸­å‘ç°å«æœ‰JSP/ASP/ASP.NETä»£ç ç‰¹å¾çš„å­—ç¬¦ï¼š\u0026lt;%request/QueryString/Form/[\u0026#39;...\u0026#39;]%\u0026gt; {dev=zonghang01} \u0026lt;=\u0026gt; dev -\u0026gt; zonghang01 {url=http://ebank.****.com.cn:9223/pWeb/FP410803.do?Wdserialno=CIP06A029396} \u0026lt;=\u0026gt; url -\u0026gt; http://ebank.****.com.cn:9223/pWeb/FP410803.do?Wdserialno=CIP06A029396 å³ä½¿â€œå¤´éƒ¨â€æœ‰å¹²æ‰°é¡¹çš„æ—¥å¿—æ¡ç›®ï¼Œä¹Ÿä¸èƒ½æ’é™¤æ‰¾ä¸åˆ°ç²¾å‡†çš„æ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…é”®å€¼å¯¹ã€‚\n1 2 % cat b0.log \u0026lt;134\u0026gt;Mar 17 14:16:11 CMFEACLOG01 BA[5100]:[log_type:flux][record_time:2022-03-17 14:12.24] [user:liujt2] [group:/****/23åŸºé‡‘æ ¸ç®—éƒ¨/][host_ip:192.168.79.78][dst_ip:::][serv:è®¿é—®ç½‘ç«™][app:æ¬¾ä»¶ä¸‹è£][site:æœªå®šä¹‰ä½ç½®] [tm_type:/PC/MAC PC][up_flux:120][down_flux:120] æ¢…å¼€äºŒåº¦ï¼š\n1 2 3 4 5 6 7 8 9 10 String text = Files.readString(Paths.get(\u0026#34;/path/to/b0.log\u0026#34;)); // ç§»é™¤è½¬ä¹‰åçš„è¡¨è¾¾å¼ä¸º \\[(\\w+?):(.+?)] Pattern pattern = Pattern.compile(\u0026#34;\\\\[(\\\\w+?):(.+?)]\u0026#34;); Matcher matcher = pattern.matcher(text); while (matcher.find()) { String kv = matcher.group(0); String k = matcher.group(1); String v = matcher.group(2); System.out.printf(\u0026#34;%s \u0026lt;=\u0026gt; %s -\u0026gt; %s\u0026#34; + System.lineSeparator(), kv, k, v); } ç¬¦åˆé¢„æœŸï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 [log_type:flux] \u0026lt;=\u0026gt; log_type -\u0026gt; flux [record_time:2022-03-17 14:12.24] \u0026lt;=\u0026gt; record_time -\u0026gt; 2022-03-17 14:12.24 [user:liujt2] \u0026lt;=\u0026gt; user -\u0026gt; liujt2 [group:/****/23åŸºé‡‘æ ¸ç®—éƒ¨/] \u0026lt;=\u0026gt; group -\u0026gt; /****/23åŸºé‡‘æ ¸ç®—éƒ¨/ [host_ip:192.168.79.78] \u0026lt;=\u0026gt; host_ip -\u0026gt; 192.168.79.78 [dst_ip:::] \u0026lt;=\u0026gt; dst_ip -\u0026gt; :: [serv:è®¿é—®ç½‘ç«™] \u0026lt;=\u0026gt; serv -\u0026gt; è®¿é—®ç½‘ç«™ [app:æ¬¾ä»¶ä¸‹è£] \u0026lt;=\u0026gt; app -\u0026gt; æ¬¾ä»¶ä¸‹è£ [site:æœªå®šä¹‰ä½ç½®] \u0026lt;=\u0026gt; site -\u0026gt; æœªå®šä¹‰ä½ç½® [tm_type:/PC/MAC PC] \u0026lt;=\u0026gt; tm_type -\u0026gt; /PC/MAC PC [up_flux:120] \u0026lt;=\u0026gt; up_flux -\u0026gt; 120 [down_flux:120] \u0026lt;=\u0026gt; down_flux -\u0026gt; 120 éä¸“ä¸šäººå£«ä¹Ÿè®¸ä¸æ‡‚æ­£åˆ™è¡¨è¾¾å¼ï¼Œå€’æœ‰ä¸€ç§æ›´ç›´è§‚çš„é”®å€¼å¯¹æå–æ–¹æ¡ˆï¼Œç”¨æˆ·è‡³å°‘å¡«å†™ 2 ä¸ªåˆ†éš”ç¬¦ï¼š\nè¦æ±‚åˆ‡é™¤çš„å‰ç¼€ï¼Œé»˜è®¤ä¸º nullã€‚ è¦æ±‚åˆ‡é™¤çš„åç¼€ï¼Œé»˜è®¤ä¸º nullã€‚ é”®å€¼å¯¹ä¹‹é—´çš„åˆ†éš”ç¬¦ï¼Œä¸èƒ½ä¸º nullã€‚ é”®ä¸å€¼ä¹‹é—´çš„åˆ†éš”ç¬¦ï¼Œä¸èƒ½ä¸º nullã€‚ æ˜¯å¦åˆ é™¤å€¼å¤´å°¾å¼•å·ï¼Œé»˜è®¤ä¸º falseã€‚ å‡è®¾é”®å€¼å¯¹ä¹‹é—´çš„åˆ†éš”ç¬¦æ˜¯ pairSeparatorï¼Œè€Œé”®ä¸å€¼ä¹‹é—´çš„åˆ†éš”ç¬¦æ˜¯ kvSeparatorï¼Œä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 String[] pairs = text.split(Pattern.quote(pairSeparator)); if (ArrayUtils.isEmpty(pairs)) { return; } Map\u0026lt;String, Object\u0026gt; kv = new HashMap\u0026lt;\u0026gt;(keys.size()); String lastKey = null; for (String pair : pairs) { int first = pair.indexOf(kvSeparator); if (first \u0026gt; 0) { String key = pair.substring(0, first); if (StringUtils.isNotBlank(key)) { String value = pair.substring(key.length() + kvSeparator.length()); kv.put(key, value); lastKey = key; } } else { // å°†å­¤ç‹¬çš„å€¼è¿½åŠ åˆ°ä¸Šä¸€å¯¹é”®å€¼ if (StringUtils.isNotBlank(lastKey)) { Object lastValue = kv.get(lastKey); if (Objects.nonNull(lastValue)) { kv.put(lastKey, lastValue + pairSeparator + pair); } } } } æ–¹æ³• split çš„å‘ è¯´èµ·å­—ç¬¦ä¸²åˆ†éš”ï¼Œæ–¹æ³• split çš„å‚æ•°å¯æ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼\n1 2 3 4 5 String str = \u0026#34;a=1} {b=2} {c=3\u0026#34;; String separator = \u0026#34;} {\u0026#34;; // java.util.regex.PatternSyntaxException: Illegal repetition near index 3 // } { String[] pairs = str.split(separator); è¾“å…¥çš„åˆ†éš”ç¬¦åŒ…å«å…ƒå­—ç¬¦ä¼šè¢«å½“ä½œæ­£åˆ™è¡¨è¾¾å¼æ¥æ ¡éªŒå’Œè§£æï¼Œé™¤äº†è½¬ä¹‰ï¼Œå¦ä¸€ç§åŸºäºå­—é¢é‡çš„åˆ†éš”æŠ€å·§ï¼š\n1 String[] pairs = str.split(Pattern.quote(separator)); æŸ¥æ‰¾ä¸æ›¿æ¢ æœ€è¿‘åœ¨æ£é¼“ä¸€ç³»åˆ—å¤§æ•°æ®é›†ï¼Œé‡åˆ°äº†ç±»ä¼¼äº JSON lines çš„æ–‡ä»¶ï¼Œç†æƒ³æƒ…å†µä¸‹å®ƒä»¬æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ JSON å€¼ï¼Œé—æ†¾çš„æ˜¯å®ƒä»¬æ˜¯äºŒæ‰‹èµ„æ–™ï¼š\n1 2 3 4 5 6 7 8 % cat ****_sample_750k/person_info.json | jq type \u0026#34;object\u0026#34; \u0026#34;object\u0026#34; parse error: Invalid numeric literal at line 3, column 289 % cat ****_sample_750k/address_merge_with_mobile_data.json | jq type parse error: Invalid numeric literal at line 1, column 95 % cat ****_sample_750k/case_data_index.json | jq type parse error: Invalid numeric literal at line 1, column 118 é€šè¿‡ jq å¯ä»¥å¿«é€Ÿå®šä½å“ªäº›è¡Œä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œè§†å¯Ÿåä½¿ç”¨ sd ç­‰å·¥å…·å°†å…¶å°±åœ°ï¼ˆin-placeï¼‰æ›¿æ¢æˆåˆè§„çš„ JSONã€‚\n1 2 3 4 5 6 7 8 #!/bin/bash file=****_sample_750k/person_info.json sd -s \u0026#39;\u0026#34;{\u0026#39; \u0026#39;{\u0026#39; $file sd -s \u0026#39;}\u0026#34;\u0026#39; \u0026#39;}\u0026#39; $file sd -s \u0026#39;ç®€ç§°\u0026#34;ä¸­ä¸“\u0026#34;\u0026#39; \u0026#39;ç®€ç§°ä¸­ä¸“\u0026#39; $file sd -s \u0026#39;ç®€ç§°\u0026#34;å¤§å­¦\u0026#34;\u0026#39; \u0026#39;ç®€ç§°å¤§å­¦\u0026#39; $file echo \u0026#39;\u0026#34;]}}}\u0026#39; \u0026gt;\u0026gt; $file cat $file | jq type é€‰é¡¹ -s å°±æ˜¯ sd çš„å­—ç¬¦ä¸²å­—é¢é‡æ¨¡å¼ï¼ˆå°†è¡¨è¾¾å¼è§†ä¸ºéæ­£åˆ™å­—ç¬¦ä¸²ï¼‰ï¼Œä½†æ˜¯å¯èƒ½å‘ç”Ÿâ€œè¯¯ä¼¤â€æˆ–â€œè¶Šç•Œâ€ï¼Œå› ä¸ºå‰©ä½™ä¸¤ä¸ªç±» JSON lines æ–‡ä»¶çš„æŸäº›å­—ç¬¦ä¸²ç±»å‹çš„å­—æ®µçš„å€¼åŒ…å«ä¸€äº› JSON å…ƒå­—ç¬¦ï¼š\n1 \u0026#34;field\u0026#34;:\u0026#34;å†…å®¹{å†…å®¹}å†…å®¹\u0026#34; ï¼ˆå†…å®¹å¯èƒ½ä¸ºç©ºç™½ï¼‰\n1 \u0026#34;field\u0026#34;:\u0026#34;å†…å®¹\u0026#34;å†…å®¹\u0026#34;å†…å®¹\u0026#34; æ··åˆä½¿ç”¨æ­£åˆ™æ¨¡å¼ä¸éæ­£åˆ™æ¨¡å¼æ¥ä¿®å¤ï¼š\n1 2 3 4 5 6 #!/bin/bash file=****_sample_750k/address_merge_with_mobile_data.json sd \u0026#39;\u0026#34;\\{(.+?)}\u0026#34;\u0026#39; \u0026#39;{$1}\u0026#39; $file export JAVA_HOME=/Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home \u0026amp;\u0026amp; java StrFieldReplace.java $file echo \u0026#39;\u0026#34;}}\u0026#39; \u0026gt;\u0026gt; $file cat $file | jq type å…¶ä¸­è„šæœ¬ StrFieldReplace.java çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 public class StrFieldReplace { static final Pattern[] PATTERNS = new Pattern[]{ // \u0026#34;SRC_ADDRESS\u0026#34;:\u0026#34;(.+?)\u0026#34;,\u0026#34;SRC_ID\u0026#34; Pattern.compile(\u0026#34;\\\u0026#34;SRC_ADDRESS\\\u0026#34;:\\\u0026#34;(.+?)\\\u0026#34;,\\\u0026#34;SRC_ID\\\u0026#34;\u0026#34;), // \u0026#34;BRIEF_CASE\u0026#34;:\u0026#34;(.+?)\u0026#34;,\u0026#34;CASE_TYPE\u0026#34; Pattern.compile(\u0026#34;\\\u0026#34;BRIEF_CASE\\\u0026#34;:\\\u0026#34;(.+?)\\\u0026#34;,\\\u0026#34;CASE_TYPE\\\u0026#34;\u0026#34;), // \u0026#34;CASE_ADDRESS\u0026#34;:\u0026#34;(.+?)\u0026#34;} Pattern.compile(\u0026#34;\\\u0026#34;CASE_ADDRESS\\\u0026#34;:\\\u0026#34;(.+?)\\\u0026#34;}\u0026#34;), // \u0026#34;case_address\u0026#34;:\u0026#34;(.+?)\u0026#34;,\u0026#34;\\w+?\u0026#34; Pattern.compile(\u0026#34;\\\u0026#34;case_address\\\u0026#34;:\\\u0026#34;(.+?)\\\u0026#34;,\\\u0026#34;\\\\w+?\\\u0026#34;\u0026#34;), // \u0026#34;caseAddress\u0026#34;:\u0026#34;(.+?)\u0026#34;,\u0026#34;\\w+?\u0026#34; Pattern.compile(\u0026#34;\\\u0026#34;caseAddress\\\u0026#34;:\\\u0026#34;(.+?)\\\u0026#34;,\\\u0026#34;\\\\w+?\\\u0026#34;\u0026#34;), // \u0026#34;CASE_NAME\u0026#34;:\u0026#34;(.+?)\u0026#34;,\u0026#34;CASE_NUMBER\u0026#34; Pattern.compile(\u0026#34;\\\u0026#34;CASE_NAME\\\u0026#34;:\\\u0026#34;(.+?)\\\u0026#34;,\\\u0026#34;CASE_NUMBER\\\u0026#34;\u0026#34;), }; static final Map\u0026lt;String, String\u0026gt; REGEX_REPL = Map.of( // \u0026#34; -\u0026gt; \u0026#39; \u0026#34;\\\u0026#34;\u0026#34;, \u0026#34;\u0026#39;\u0026#34; ); public static void main(String[] args) throws IOException { if (args.length \u0026lt; 1) { System.err.println(\u0026#34;Usage: java StrFieldReplace.java \u0026lt;pathToFile\u0026gt;\u0026#34;); System.exit(1); } String pathToFile = args[0]; Path filepath = Paths.get(pathToFile); List\u0026lt;String\u0026gt; lines = Files.readAllLines(filepath); if (lines.isEmpty()) { System.err.println(filepath + \u0026#34; is empty\u0026#34;); return; } for (int i = 0; i \u0026lt; lines.size(); i++) { String line = lines.get(i); for (Pattern pattern : PATTERNS) { Matcher matcher = pattern.matcher(line); while (matcher.find()) { String value = matcher.group(1); for (Map.Entry\u0026lt;String, String\u0026gt; entry : REGEX_REPL.entrySet()) { String regex = entry.getKey(); String repl = entry.getValue(); String newValue = value.replaceAll(regex, repl); line = line.replace(value, newValue); lines.set(i, line); value = newValue; } } } } Files.writeString(filepath, String.join(System.lineSeparator(), lines)); } } æ­¤å¤„ï¼ŒåŸºäºå­—é¢é‡æ›¿æ¢æ¯”åŸºäºæ­£åˆ™æ›¿æ¢æ›´å¿«ï¼Œåœ¨è¡Œæ›¿æ¢æ¯”åœ¨å…¨æ–‡æ›¿æ¢æ›´å¿«ã€‚\n1 2 3 4 5 6 #!/bin/bash file=****_sample_750k/case_data_index.json sd \u0026#39;\u0026#34;ADDR_DETL\u0026#34;:\u0026#34;\\{(.+?)}\u0026#34;,\u0026#34;ADDR_TYPE\u0026#34;\u0026#39; \u0026#39;\u0026#34;ADDR_DETL\u0026#34;:{$1},\u0026#34;ADDR_TYPE\u0026#34;\u0026#39; $file export JAVA_HOME=/Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home \u0026amp;\u0026amp; java StrFieldReplace.java $file sd -s \u0026#39;\u0026#34;{\u0026#39; \u0026#39;{\u0026#39; $file \u0026amp;\u0026amp; echo \u0026#39;\u0026#34;:null}}}}\u0026#39; \u0026gt;\u0026gt; $file cat $file | jq type æœ¬æ–‡é¦–å‘äº https://h2cone.github.io\næ–‡æœ¬æ ¡éªŒ é€šå¸¸å§‹äºä¸€è¡Œçš„å¼€å¤´ ^ï¼Œç»ˆäºä¸€è¡Œçš„ç»“å°¾ $ã€‚\nå‚è€ƒ Wiki # Regular expression\nOracle # Class Pattern\nregex101: build, test, and debug regex\n","date":"2022-07-15T10:31:49+08:00","permalink":"https://h2cone.github.io/2022/07/15/regex_use_cases/","title":"æ­£åˆ™è¡¨è¾¾å¼ç”¨ä¾‹"},{"content":"å†™åœ¨å‰é¢çš„è¯ å›¢é˜Ÿå›´ç»•ç€ Kafka ä¸€ç³»åˆ—æœåŠ¡çš„å‹åŠ›æµ‹è¯•çš„æ ¸å¿ƒæŒ‡æ ‡ä¹‹ä¸€æ˜¯ Eevents per secondï¼Œæ’é™¤å…¶å®ƒå› ç´ ï¼Œå®ƒä¸ååé‡æ­£ç›¸å…³ã€‚\nä»€ä¹ˆæ˜¯ååé‡ ååé‡æ˜¯æŒ‡é€šè¿‡é€šä¿¡é€šé“æˆåŠŸä¼ é€’æ¶ˆæ¯çš„é€Ÿç‡ã€‚ä» Kafka ç”Ÿäº§è€…ï¼ˆProducerï¼‰çš„è§’åº¦æ¥çœ‹ï¼Œå¯ä»¥ç”¨å•ä½æ—¶é—´å†…äº¤ä»˜æˆåŠŸçš„è®°å½•æ¡æ•°æˆ–å¤§å°æ¥æè¿°ååé‡ï¼›ä» Kafka æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰çš„è§’åº¦æ¥çœ‹ï¼Œå¯ä»¥ç”¨å•ä½æ—¶é—´å†…è¯»å–çš„è®°å½•æ¡æ•°æˆ–å¤§å°æ¥æè¿°ã€‚\nç”Ÿäº§è€…å‡†å¤‡è®°å½•åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œæ­¤å¤„åªå…³æ³¨å•ä½æ—¶é—´å†…æ¥æ”¶åˆ°å›æ‰§ï¼ˆackï¼‰çš„è®°å½•æ¡æ•°æˆ–å¤§å°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç”Ÿäº§è€…ä½¿ç”¨å¼‚æ­¥å‘é€ï¼Œä¸”å®ƒå°†å°è¯•åœ¨å†…å­˜ä¸­ç´¯ç§¯è®°å½•å¹¶åœ¨å•ä¸ªè¯·æ±‚ä¸­å‘é€æ‰¹é‡è®°å½•ã€‚\n1 2 3 for (long i = 0; i \u0026lt; numRecords; i++) { producer.send(record, callback); } è°ƒç”¨æ–¹æ³• KafkaProducer.send(ProducerRecord, Callback) ä¸é˜»å¡åœ¨è¯¥æ–¹æ³•ï¼Œæ—¢ä¼ é€’è®°å½•ï¼ˆrecordï¼‰çš„å¼•ç”¨ï¼Œä¹Ÿä¼ é€’å›è°ƒï¼ˆcallbackï¼‰çš„å¼•ç”¨ã€‚\n1 2 3 4 5 6 class MyCallback implements Callback { @Override public void onCompletion(RecordMetadata metadata, Exception e) { // handling } } ç”Ÿäº§è€…æ¥å—åˆ°å‘é€è®°å½•çš„å›æ‰§æ—¶ï¼Œå°†æœ‰çº¿ç¨‹æ‰§è¡Œæ–¹æ³• onCompletion çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å›è°ƒæ–¹æ³•ä½“å†…å®ç°è®°å½•æ¡æ•°æˆ–å¤§å°çš„ç´¯è®¡ã€‚\næ³¨æ„ï¼šâ€œæäº¤åç§»é‡â€ä¸ä¸€å®šå‘ç”Ÿåœ¨â€œå¤„ç†è®°å½•â€ä¹‹åã€‚\n1 2 3 4 while (conditions) { ConsumerRecords records = consumer.poll(timeout); processRetrievedRecords(records); } æ¶ˆè´¹è€…å¤„ç†è®°å½•åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œæ­¤å¤„åªå…³æ³¨å•ä½æ—¶é—´å†…æ¥å—åˆ°çš„è®°å½•æ¡æ•°æˆ–å¤§å°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹è€…é€šè¿‡è½®è¯¢æ‹‰å–ï¼ˆpollï¼‰æ‰¹é‡çš„è®°å½•ï¼Œæ¯æ¬¡è°ƒç”¨æ–¹æ³• KafkaConsumer.poll(Duration) é˜»å¡åœ¨è¯¥æ–¹æ³•ï¼Œç›´åˆ°è¶…æ—¶ï¼ˆtimeoutï¼‰è¿”å›ï¼Œä¸”ä¼šæœ‰çº¿ç¨‹å®šæœŸé€æ˜åœ°æäº¤å‰ä¸€æ‰¹çš„æœ€åä¸€æ¡è®°å½•çš„åç§»é‡ï¼ˆauto commitï¼‰ã€‚\næµ‹è¯•ååé‡ ç”Ÿäº§è€…å·¥å…· åœ¨ Kafka å®‰è£…ç›®å½•ï¼Œæœ‰åŠ©äºæµ‹è¯•ç”Ÿäº§è€…æ€§èƒ½çš„å‘½ä»¤è¡Œå·¥å…·æ˜¯ kafka-producer-perf-test.shã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 % ./bin/kafka-producer-perf-test.sh --help usage: producer-performance [-h] --topic TOPIC --num-records NUM-RECORDS [--payload-delimiter PAYLOAD-DELIMITER] --throughput THROUGHPUT [--producer-props PROP-NAME=PROP-VALUE [PROP-NAME=PROP-VALUE ...]] [--producer.config CONFIG-FILE] [--print-metrics] [--transactional-id TRANSACTIONAL-ID] [--transaction-duration-ms TRANSACTION-DURATION] (--record-size RECORD-SIZE | --payload-file PAYLOAD-FILE) This tool is used to verify the producer performance. optional arguments: -h, --help show this help message and exit --topic TOPIC produce messages to this topic --num-records NUM-RECORDS number of messages to produce --payload-delimiter PAYLOAD-DELIMITER provides delimiter to be used when --payload-file is provided. Defaults to new line. Note that this parameter will be ignored if --payload-file is not provided. (default: \\n) --throughput THROUGHPUT throttle maximum message throughput to *approximately* THROUGHPUT messages/sec. Set this to -1 to disable throttling. --producer-props PROP-NAME=PROP-VALUE [PROP-NAME=PROP-VALUE ...] kafka producer related configuration properties like bootstrap.servers,client.id etc. These configs take precedence over those passed via --producer.config. --producer.config CONFIG-FILE producer config properties file. --print-metrics print out metrics at the end of the test. (default: false) --transactional-id TRANSACTIONAL-ID The transactionalId to use if transaction-duration-ms is \u0026gt; 0. Useful when testing the performance of concurrent transactions. (default: performance-producer-default-transactional-id) --transaction-duration-ms TRANSACTION-DURATION The max age of each transaction. The commitTransaction will be called after this time has elapsed. Transactions are only enabled if this value is positive. (default: 0) either --record-size or --payload-file must be specified but not both. --record-size RECORD-SIZE message size in bytes. Note that you must provide exactly one of --record-size or --payload-file. --payload-file PAYLOAD-FILE file to read the message payloads from. This works only for UTF-8 encoded text files. Payloads will be read from this file and a payload will be randomly selected when sending messages. Note that you must provide exactly one of --record-size or --payload-file. æŸ¥çœ‹ kafka-producer-perf-test.sh ä¸éš¾å‘ç°å®é™…æ‰§è¡Œ ProducerPerformance çš„æ–¹æ³• mainã€‚\n1 2 3 4 5 6 7 % ./bin/kafka-producer-perf-test.sh \\ --topic perf_test \\ --num-records 1000000 \\ --record-size 1024 \\ --throughput -1 \\ --producer-props \\ bootstrap.servers=localhost:9092 å‘é€ 1000000 æ¡å¤§å°ä¸º 1024 å­—èŠ‚çš„è®°å½•åˆ°åœ°å€ä¸º localhost:9092 çš„ Kafka Broker çš„ä¸»é¢˜ perf_testï¼Œè¾“å‡ºåŒ…å« records/sec æˆ– MB/sec æ˜¯æˆ‘ä»¬å…³æ³¨çš„ååé‡ã€‚\n1 2 498505 records sent, 99701.0 records/sec (97.36 MB/sec), 1.4 ms avg latency, 176.0 ms max latency. 1000000 records sent, 102722.136620 records/sec (100.31 MB/sec), 0.92 ms avg latency, 176.00 ms max latency, 0 ms 50th, 1 ms 95th, 23 ms 99th, 56 ms 99.9th. æ¶ˆè´¹è€…å·¥å…· å¦ä¸€æ–¹é¢ï¼Œå‘½ä»¤è¡Œå·¥å…· kafka-consumer-perf-test.sh æœ‰åŠ©äºå¯¹æ¶ˆè´¹è€…è¿›è¡Œæ€§èƒ½æµ‹è¯•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 % ./bin/kafka-consumer-perf-test.sh --help This tool helps in performance test for the full zookeeper consumer Option Description ------ ----------- --bootstrap-server \u0026lt;String: server to REQUIRED unless --broker-list connect to\u0026gt; (deprecated) is specified. The server (s) to connect to. --broker-list \u0026lt;String: broker-list\u0026gt; DEPRECATED, use --bootstrap-server instead; ignored if --bootstrap- server is specified. The broker list string in the form HOST1:PORT1, HOST2:PORT2. --consumer.config \u0026lt;String: config file\u0026gt; Consumer config properties file. --date-format \u0026lt;String: date format\u0026gt; The date format to use for formatting the time field. See java.text. SimpleDateFormat for options. (default: yyyy-MM-dd HH:mm:ss:SSS) --fetch-size \u0026lt;Integer: size\u0026gt; The amount of data to fetch in a single request. (default: 1048576) --from-latest If the consumer does not already have an established offset to consume from, start with the latest message present in the log rather than the earliest message. --group \u0026lt;String: gid\u0026gt; The group id to consume on. (default: perf-consumer-20714) --help Print usage information. --hide-header If set, skips printing the header for the stats --messages \u0026lt;Long: count\u0026gt; REQUIRED: The number of messages to send or consume --num-fetch-threads \u0026lt;Integer: count\u0026gt; DEPRECATED AND IGNORED: Number of fetcher threads. (default: 1) --print-metrics Print out the metrics. --reporting-interval \u0026lt;Integer: Interval in milliseconds at which to interval_ms\u0026gt; print progress info. (default: 5000) --show-detailed-stats If set, stats are reported for each reporting interval as configured by reporting-interval --socket-buffer-size \u0026lt;Integer: size\u0026gt; The size of the tcp RECV size. (default: 2097152) --threads \u0026lt;Integer: count\u0026gt; DEPRECATED AND IGNORED: Number of processing threads. (default: 10) --timeout [Long: milliseconds] The maximum allowed time in milliseconds between returned records. (default: 10000) --topic \u0026lt;String: topic\u0026gt; REQUIRED: The topic to consume from. --version Display Kafka version. æŸ¥çœ‹ kafka-consumer-perf-test.sh ä¸éš¾å‘ç°å®é™…æ‰§è¡Œ ConsumerPerformance çš„æ–¹æ³• mainã€‚\n1 2 3 4 ./bin/kafka-consumer-perf-test.sh \\ --broker-list localhost:9092 \\ --topic perf_test \\ --messages 1000000 ä»åœ°å€æ˜¯ localhost:9092 çš„ Kafka Broker çš„ä¸»é¢˜ perf_test ç´¢å– 1000000 æ¡è®°å½•ï¼Œè¾“å‡ºç»“æœåŒ…å«åˆ—å nMsg.sec æ˜¯æˆ‘ä»¬å…³æ³¨çš„ååé‡ã€‚\n1 2 start.time, end.time, data.consumed.in.MB, MB.sec, data.consumed.in.nMsg, nMsg.sec, rebalance.time.ms, fetch.time.ms, fetch.MB.sec, fetch.nMsg.sec 2022-07-02 11:39:47:948, 2022-07-02 11:39:49:374, 976.9287, 685.0832, 1000375, 701525.2454, 187, 1239, 788.4816, 807405.1655 ç†è®ºé…ç½® å®Œå…¨å—åˆ° Summary of Configurations for Optimizing Throughput çš„å¯å‘ã€‚\nç”Ÿäº§è€…é…ç½® batch.sizeã€‚æ‰¹æ¬¡å¤§å°ã€‚æ‰¹å¤„ç†æ—¶ï¼ˆå½“å¤šä¸ªè®°å½•è¢«å‘é€åˆ°åŒä¸€ä¸ªåˆ†åŒºæ—¶ï¼‰ç´¯ç§¯è®°å½•ä¸è¶…è¿‡æŒ‡å®šå­—èŠ‚æ•°ï¼Œè¶…è¿‡æ—¶ç«‹å³å‘é€æ‰¹é‡è®°å½•ã€‚å»ºè®®å¢åŠ åˆ° 100000 ~ 200000ã€‚é»˜è®¤ä¸º 16384ã€‚\nlinger.msã€‚é€—ç•™æ—¶é•¿ã€‚æ‰¹å¤„ç†æ—¶ï¼ˆå½“å¤šä¸ªè®°å½•è¢«å‘é€åˆ°åŒä¸€ä¸ªåˆ†åŒºæ—¶ï¼‰ç´¯ç§¯è®°å½•ä¸è¶…è¿‡æŒ‡å®šæ¯«ç§’æ•°ï¼Œè¶…è¿‡æ—¶ç«‹å³å‘é€æ‰¹é‡è®°å½•ã€‚å±æ€§ linger.ms ä¼˜å…ˆäºå±æ€§ batch.sizeã€‚é»˜è®¤ä¸º 0ã€‚\ncompression.type=lz4ã€‚å‹ç¼©ç±»å‹ã€‚é»˜è®¤å€¼æ˜¯ noneï¼Œè¡¨ç¤ºä¸å‹ç¼©ã€‚\nacks=1ã€‚ç”Ÿäº§è€…è¦æ±‚åœ¨ Leader è€ƒè™‘è¯·æ±‚å®Œæˆä¹‹å‰æ”¶åˆ°çš„ ack æ•°é‡ã€‚é»˜è®¤å€¼æ˜¯ allï¼ŒKafka 3.0 ä¹‹å‰çš„é»˜è®¤å€¼æ˜¯ 1ã€‚\nbuffer.memoryã€‚ç¼“å†²è®°å½•çš„å†…å­˜æ€»å­—èŠ‚æ•°ã€‚å¦‚æœæœ‰å¾ˆå¤šåˆ†åŒºå°±å¢åŠ å®ƒï¼Œé»˜è®¤ä¸º 33554432ã€‚\næ¶ˆè´¹è€…é…ç½® fetch.min.bytesã€‚ä¸€ä¸ªç´¢å–è¯·æ±‚ï¼ˆfetch requestï¼‰è¦æ±‚æœåŠ¡ç«¯è¿”å›çš„æœ€å°å­—èŠ‚æ•°ã€‚å¢åŠ åˆ° 100000ï¼Œé»˜è®¤ä¸º 1ã€‚\nfetch.max.wait.ms=500ã€‚ä¸€ä¸ªç´¢å–è¯·æ±‚ï¼ˆfetch requestï¼‰è¦æ±‚æœåŠ¡ç«¯æœªç´¯ç§¯åˆ° fetch.min.bytes çš„æœ€å¤§é˜»å¡æ¯«ç§’æ•°ã€‚\néªŒè¯é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 % ./bin/kafka-producer-perf-test.sh \\ --topic perf_test \\ --num-records 1000000 \\ --record-size 1024 \\ --throughput -1 \\ --producer-props \\ bootstrap.servers=localhost:9092 \\ batch.size=100000 \\ linger.ms=10 \\ compression.type=lz4 \\ acks=1 \\ buffer.memory=33554432 489179 records sent, 97835.8 records/sec (95.54 MB/sec), 3.0 ms avg latency, 421.0 ms max latency. 1000000 records sent, 102637.791235 records/sec (100.23 MB/sec), 2.22 ms avg latency, 421.00 ms max latency, 1 ms 50th, 5 ms 95th, 39 ms 99th, 90 ms 99.9th. ä¸Šé¢çš„é…ç½®ä½¿ç”¨ lz4 å‹ç¼©ç®—æ³•ï¼Œè€Œä¸‹é¢çš„é…ç½®ä¸ä½¿ç”¨å‹ç¼©åœ¨æŸäº›æŒ‡æ ‡è¡¨ç°å¾—æ›´å¥½ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 % ./bin/kafka-producer-perf-test.sh \\ --topic perf_test \\ --num-records 1000000 \\ --record-size 1024 \\ --throughput -1 \\ --producer-props \\ bootstrap.servers=localhost:9092 \\ batch.size=100000 \\ linger.ms=10 \\ acks=1 \\ buffer.memory=33554432 558625 records sent, 111680.3 records/sec (109.06 MB/sec), 1.8 ms avg latency, 197.0 ms max latency. 1000000 records sent, 114207.400640 records/sec (111.53 MB/sec), 1.87 ms avg latency, 197.00 ms max latency, 1 ms 50th, 5 ms 95th, 20 ms 99th, 48 ms 99.9th. äº²è‡ªèµ°â€œè°ƒå‚-æµ‹è¯•â€å¾ªç¯ï¼Œæ–¹å¯è¿­ä»£åˆ°æ›´é€‚åˆè‡ªå·±çš„æœ€ä½³å®è·µã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒ Kafka Design | Confluent Documentation\nKafka - When to commit?\nOptimizing for Throughput | Confluent Documentation\n","date":"2022-06-20T10:16:16+08:00","permalink":"https://h2cone.github.io/2022/06/20/high_throughput_kafka_client_config/","title":"é«˜åå Kafka å®¢æˆ·ç«¯é…ç½®"},{"content":"ä¸ªäººé€‰æ‹© å…¬å¸ä¸­çš„é—ç•™é¡¹ç›®åŸºäº Java 8ï¼Œä¹Ÿæœ‰éƒ¨ç½²ä½¿ç”¨ Java 11 çš„å¼€æºè½¯ä»¶ï¼›å¯¹äº Side Projectï¼Œç”šè‡³æ˜¯æ–°é¡¹ç›®ï¼Œå¯ä»¥æ¯«ä¸çŠ¹è±«ä½¿ç”¨ Java 11/17ã€‚ä¸ªäººå«Œåœ¨ Oracle å®˜æ–¹ä¸‹è½½ JDK è¿‡äºéº»çƒ¦ï¼Œä¹Ÿé 100% å¼€æºï¼ŒåŠ ä¸Šæœ¬åœ°æ“ä½œç³»ç»ŸæŒ‡ä»¤é›†æ¶æ„ä» x86 è½¬åˆ°äº† ARMï¼Œå› æ­¤å†³å®šä¸‹è½½ Azul Zulu Builds of OpenJDKã€‚\nå¸‚é¢ä¸Šå„å®¶å‚å•†æ„å»ºçš„ JDK ä¸å¯èƒ½æ¯«æ— å·®å¼‚ï¼Œæ¯”å¦‚ OpenJDK ä¸ Oracle JDK â€“ æ¯”è¾ƒè¡¨ã€‚\nå‘åå…¼å®¹ Java 8 æœ‰æ—¶è¢«ç§°ä¸º Java 1.8ï¼Œåœ¨è¿™ä¹‹åçš„ç‰ˆæœ¬å·ä¸å†ä»¥ 1. å¼€å¤´ï¼Œéšç€å‘å¸ƒæ—¶é—´çš„å¢åŠ è€Œå¢åŠ ï¼Œä¸Šå›¾ä¸­åªæœ‰ 8ã€11ã€17 æ˜¯ LTS ç‰ˆæœ¬ã€‚\n1 2 3 4 % java -version openjdk version \u0026#34;17.0.3\u0026#34; 2022-04-19 LTS OpenJDK Runtime Environment Zulu17.34+19-CA (build 17.0.3+7-LTS) OpenJDK 64-Bit Server VM Zulu17.34+19-CA (build 17.0.3+7-LTS, mixed mode, sharing) Java ç‰ˆæœ¬ä¹‹é—´ç ´åæ€§å˜æ›´è¾ƒå°ï¼ŒJVM é«˜åº¦å‘åå…¼å®¹ï¼Œæ–°ç‰ˆé€šå¸¸å…¼å®¹æ—§ç‰ˆï¼Œä¾‹å¦‚åŸºäº Java 5 æˆ– Java 8 çš„ç¨‹åºï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸æ›´æ”¹ä»£ç ä¹Ÿå¯ä»¥åœ¨ Java 8 åˆ° Java 17 çš„ JVM ä¸Šè¿è¡Œæ­£å¸¸ï¼›åè¿‡æ¥è¯´ï¼Œä¸èƒ½å‘å‰å…¼å®¹ï¼Œä¾‹å¦‚ä½¿ç”¨ Java 17 ç¼–è¯‘è¾“å‡ºçš„ Class æˆ– Jar æ–‡ä»¶æ— æ³•åœ¨ 17 ä¹‹å‰çš„ JVM ä¸ŠåŠ è½½é€šè¿‡ï¼šUnsupportedClassVersionErrorã€‚\nç‰¹æ€§æ¦‚è§ˆ ä¸‹æ–‡åªåˆ—å‡ºæ„Ÿå…´è¶£çš„ç‰¹æ€§ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåä¸€ç‰ˆå¹¶ä¸ä¼šç§»é™¤ä¸Šä¸€ç‰ˆçš„ç‰¹æ€§ã€‚\nJava 8 è¦ä¹ˆå¯¹æ•°æ®è¿›è¡ŒæŠ½è±¡ï¼Œè¦ä¹ˆå¯¹è¡Œä¸ºè¿›è¡ŒæŠ½è±¡ã€‚\nLambda expressions å°½ç®¡ Java ä¸æ˜¯å‡½æ•°å¼è¯­è¨€ï¼Œä½†æ˜¯ Lambda è¡¨è¾¾å¼å…è®¸æˆ‘ä»¬å°†åŠŸèƒ½è§†ä¸ºæ–¹æ³•å‚æ•°ï¼Œæˆ–å°†ä»£ç è§†ä¸ºæ•°æ®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // before java 8 Runnable r1 = new Runnable() { @Override public void run() { System.out.println(\u0026#34;hello world\u0026#34;); // --snip-- } }; // after java 8 Runnable r2 = () -\u0026gt; { System.out.println(\u0026#34;hello world\u0026#34;); // --snip-- }; File dir = new File(\u0026#34;/path/to/dir\u0026#34;); // anonymous class File[] files1 = dir.listFiles(new FileFilter() { @Override public boolean accept(File pathname) { return pathname.getName().endsWith(\u0026#34;.java\u0026#34;); } }); // lambda File[] files2 = dir.listFiles(pathname -\u0026gt; pathname.getName().endsWith(\u0026#34;.java\u0026#34;)); å¦‚æœåŒ¿åç±»æ˜¯â€œæ—§é…’â€ï¼Œé‚£ä¹ˆ Lambda è¡¨è¾¾å¼æ˜¯â€œæ–°ç“¶â€ï¼Œå®ƒæ›´ç´§å‡‘åœ°è¡¨è¾¾äº†â€œå•ä¸€æŠ½è±¡æ–¹æ³•æ¥å£â€ï¼ˆè¢«ç§°ä¸º Functional Interfaceï¼‰çš„å®ä¾‹ï¼ŒFunctional Interface çš„æŠ½è±¡æ–¹æ³•ç­¾åå†³å®šäº†å‡½æ•°çš„å‚æ•°ç±»å‹åˆ—è¡¨å’Œè¿”å›å€¼ç±»å‹ã€‚\n1 2 3 4 5 @FunctionalInterface public interface Function\u0026lt;T, R\u0026gt; { R apply(T t); // --snip-- } Java æä¾›äº†è®¸å¤š Functional Interface å……å½“ lambda è¡¨è¾¾å¼çš„æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚ï¼šConsumerã€Predicateã€Supplierã€‚\nfinal or effectively final Lambda è¡¨è¾¾å¼æˆ–åŒ¿åç±»åœ¨å°é—­èŒƒå›´è®¿é—®çš„å¤–å›´æœ¬åœ°å˜é‡å¿…é¡»æ˜¯ final æˆ– effectively final å˜é‡ã€‚\n1 2 3 4 5 6 7 int n = 0; Arrays.asList(0, 1, 2, 3, 4, 5, 6, 7, 8, 9).forEach(item -\u0026gt; { if (item % 2 == 0) { // This code does not compile! n++; } }); æ³¨æ„ï¼Œä¸Šé¢å’Œä¸‹é¢çš„ä»£ç ç¼–è¯‘éƒ½ä¸ä¼šé€šè¿‡ï¼šVariable used in lambda expression should be final or effectively final.\n1 2 3 4 Supplier\u0026lt;Integer\u0026gt; incrementer(int start) { // This code does not compile! return () -\u0026gt; start++; } åœ¨åŒ¿åç±»æ–¹æ³•ä½“å†…è®¿é—®å¤–å›´æœ¬åœ°å˜é‡æ—¶ï¼ŒåŒæ ·è¦æ±‚æˆ‘ä»¬å°†å®ƒä»¬å£°æ˜ä¸º final æˆ–è€…ä¸æ›´æ”¹å®ƒä»¬çš„å€¼ï¼Œåè€…å¯¹äºç¼–è¯‘å™¨æ¥è¯´æœ€ç»ˆè¿˜æ˜¯ finalã€‚\nAn anonymous class cannot access local variables in its enclosing scope that are not declared as final or effectively final.\nJLS å½“ä¸­çš„ Â§15.27.2 æåˆ°äº†åŸå› ï¼š\nThe restriction to effectively final variables prohibits access to dynamically-changing local variables, whose capture would likely introduce concurrency problems.\nç®€è€Œè¨€ä¹‹ï¼Œè¯¥é™åˆ¶å¯ä»¥è§„é¿ä¸€äº›å¹¶å‘é£é™©ï¼Œä¸è¿‡è®¿é—®æ”¾ç½®åœ¨ Java å †çš„å®ä¾‹å­—æ®µã€é™æ€å­—æ®µå¹¶ä¸å—æ­¤é™åˆ¶ã€‚\nMethod references æ–¹æ³•å¼•ç”¨ä¸ºå·²æœ‰åç§°çš„æ–¹æ³•æä¾›æ˜“äºé˜…è¯»çš„ Lambda è¡¨è¾¾å¼ã€‚\n1 2 3 Stream.of(\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;).map(item -\u0026gt; item.toUpperCase()).forEach(item -\u0026gt; System.out.println(item)); // can be replaced with a method reference Stream.of(\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;c\u0026#34;).map(String::toUpperCase).forEach(System.out::println); æ ¹æ®ã€ŠEffective Javaã€‹ä¸­çš„è¯´æ³•ï¼Œæœ‰ 5 ç§ç±»å‹çš„ç”¨ä¾‹å¯ä¾›å‚è€ƒã€‚\nStreams æ–°çš„ java.util.stream åŒ…æä¾›äº† Stream API æ¥æ”¯æŒå¯¹å…ƒç´ æµï¼ˆstreams of elementsï¼‰çš„å‡½æ•°å¼æ“ä½œã€é“¾å¼æ“ä½œã€èšåˆæ“ä½œã€‚ä¸€ä¸ª Stream æ˜¯ä¸€ä¸ªå…ƒç´ åºåˆ—ï¼Œä¸åŒäº Collectionï¼Œå®ƒä¸æ˜¯å­˜å‚¨å…ƒç´ çš„æ•°æ®ç»“æ„ï¼Œç›¸åï¼ŒStream é€šè¿‡ç®¡é“æºå¸¦æ¥è‡ª Source çš„å€¼ã€‚ä¸€ä¸ª Source å¯ä»¥æ˜¯ä¸€ä¸ª Collectionã€ä¸€ä¸ªæ•°ç»„ã€ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°ã€ä¸€ä¸ª I/O Channel ç­‰ç­‰ã€‚\nOracle çš„ Java æŒ‡å—æŠŠ Streams å®‰æ’åˆ° Collections ä¹‹ä¸‹ï¼Œé€šå¸¸å°†ä¸¤è€…çš„ API ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œå‡è®¾æœ‰ä¸€ä¸ªåä¸º roster ä¸”ç±»å‹æ˜¯ Collection çš„å˜é‡ï¼Œè¦æ±‚æ‰“å°ç”·æ€§å§“åï¼š\n1 2 3 4 5 6 7 8 9 10 11 // before java 8 for (Person p : roster) { if (p.getGender() == Person.Sex.MALE) { System.out.println(p.getName()); } } // after java 8 roster .stream() .filter(e -\u0026gt; e.getGender() == Person.Sex.MALE) .forEach(e -\u0026gt; System.out.println(e.getName())); ä¸€ç³»åˆ—èšåˆæ“ä½œå¦‚åŒ Unix çš„ç®¡é“éšè—äº†å†…éƒ¨ç»“æ„ï¼Œä½¿è¿‡ç¨‹æ›´æ¸…æ™°å’Œç®€å•ã€‚\n1 2 3 4 5 6 List\u0026lt;Integer\u0026gt; transactionsIds = transactions.stream() .filter(t -\u0026gt; t.getType() == Transaction.GROCERY) .sorted(comparing(Transaction::getValue).reversed()) .map(Transaction::getId) .collect(toList()); è¿™ä¹ˆå¥½çš„ä¾‹å­æ¥è‡ª Processing Data with Java SE 8 Streams, Part 1 å’Œ Part 2: Processing Data with Java SE 8 Streamsã€‚\nDefault method å‘æŸä¸€æ¥å£æ–°å¢æ–¹æ³•ï¼Œè¯¥æ¥å£çš„æ‰€æœ‰å®ç°ç±»å‡è¦æ›´æ”¹ï¼Œé»˜è®¤æ–¹æ³•å…è®¸æ¥å£æä¾›é»˜è®¤å…·ä½“å®ç°å’Œå…¼å®¹æ—§ç‰ˆæœ¬å®ç°ç±»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 interface One { default void method() { System.out.println(\u0026#34;One\u0026#34;); } } interface Two { default void method () { System.out.println(\u0026#34;One\u0026#34;); } } class Three implements One, Two { public void method() { One.super.method(); } } å®ç°ç±»éå¿…é¡»é‡å†™ï¼ˆoverrideï¼‰é»˜è®¤æ–¹æ³•ï¼Œå‡å¦‚éœ€è¦åœ¨é‡å†™çš„æ–¹æ³•å†…å¼•ç”¨é»˜è®¤æ–¹æ³•ï¼Œåº”è¯¥ä½¿ç”¨ interface åç§°ä¸å…³é”®è¯ superã€‚\nJava 9 Collections çš„ä¾¿åˆ©å·¥å‚æ–¹æ³• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 { // before java 9 // mutable List\u0026lt;String\u0026gt; list1 = Arrays.asList(\u0026#34;one\u0026#34;, \u0026#34;two\u0026#34;, \u0026#34;three\u0026#34;); // since java 9 // immutable List\u0026lt;String\u0026gt; list2 = List.of(\u0026#34;one\u0026#34;, \u0026#34;two\u0026#34;, \u0026#34;three\u0026#34;); // before java 9 // mutable Set\u0026lt;String\u0026gt; set1 = new HashSet\u0026lt;\u0026gt;(); set1.add(\u0026#34;one\u0026#34;); set1.add(\u0026#34;two\u0026#34;); set1.add(\u0026#34;three\u0026#34;); Set\u0026lt;String\u0026gt; set2 = new HashSet\u0026lt;String\u0026gt;() { { add(\u0026#34;one\u0026#34;); add(\u0026#34;two\u0026#34;); add(\u0026#34;three\u0026#34;); } }; // since java 9 // immutable Set\u0026lt;String\u0026gt; set3 = Set.of(\u0026#34;one\u0026#34;, \u0026#34;two\u0026#34;, \u0026#34;three\u0026#34;); // before java 9 // mutable Map\u0026lt;String, Integer\u0026gt; map1 = new HashMap\u0026lt;\u0026gt;(); map1.put(\u0026#34;foo\u0026#34;, 1); map1.put(\u0026#34;bar\u0026#34;, 2); Map\u0026lt;String, Integer\u0026gt; map2 = new HashMap\u0026lt;String, Integer\u0026gt;() { { put(\u0026#34;foo\u0026#34;, 1); put(\u0026#34;bar\u0026#34;, 2); } }; // since java 9 // immutable Map\u0026lt;String, Integer\u0026gt; map3 = Map.of(\u0026#34;foo\u0026#34;, 1, \u0026#34;bar\u0026#34;, 2); } Stream ç”Ÿæˆå™¨ 1 2 3 4 5 6 for (int i = 0; i \u0026lt; 10; ++i) { System.out.println(i); } // since java 9 Stream.iterate(0, i -\u0026gt; i \u0026lt; 10, i -\u0026gt; i + 1) .forEach(System.out::println); Stream takeWhile/dropWhile 1 2 3 4 5 6 7 8 9 10 11 12 // print: 0123443210 Stream.of(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0) .filter(i -\u0026gt; i \u0026lt; 5) .forEach(System.out::print); // print: 01234 Stream.of(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0) .takeWhile(i -\u0026gt; i \u0026lt; 5) .forEach(System.out::print); // print: 56789876543210 Stream.of(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0) .dropWhile(i -\u0026gt; i \u0026lt; 5) .forEach(System.out::print); é‡åˆ°ç¬¬ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶çš„å…ƒç´ æ—¶ï¼Œæ–¹æ³• filter å°†ç»§ç»­ï¼Œè€Œæ–¹æ³• takeWhile/dropWhile å°†é€€å‡ºã€‚\nJShell JShell æ˜¯ä¸€ç§ REPLï¼Œå³â€œè¯»-æ±‚å€¼-æ‰“å°â€å¾ªç¯ï¼Œå®ƒè¯»å–æ¥è‡ªç”¨æˆ·è¾“å…¥åˆ°ç»ˆç«¯çš„è¯­å¥æˆ–è¡¨è¾¾å¼ï¼Œè¿›è¡Œæ±‚å€¼ï¼Œå°†ç»“æœè¾“å‡ºåˆ°ç»ˆç«¯ã€‚\nJava 10 æœ¬åœ°å˜é‡ç±»å‹æ¨æ–­ 1 2 3 4 5 6 { // Pre-Java 10 Person person = new Person(); // With Java 10 var person = new Person(); } å…³é”®è¯ var æ˜¯ variable çš„ç®€å†™ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶èƒ½å¤Ÿä»åˆå§‹åŒ–å™¨ï¼ˆinitializerï¼‰æ¨æ–­å‡ºå£°æ˜ä¸º var çš„æœ¬åœ°å˜é‡ï¼ˆlocal variableï¼‰çš„ç±»å‹ï¼Œå°½ç®¡å¦‚æ­¤ï¼ŒJava ä»ç„¶æ˜¯é™æ€ç±»å‹è¯­è¨€ã€‚\næ˜¾å¼å£°æ˜ç±»å‹çš„æœ¬åœ°å˜é‡æœªåˆå§‹åŒ–ä¸å¯ä½¿ç”¨ï¼Œä½¿ç”¨ var ä¿®é¥°çš„æœ¬åœ°å˜é‡åŒç†ï¼Œå‰è€…å…è®¸è¿Ÿä¸€ç‚¹åˆå§‹åŒ–æˆ–è€…å¹²è„†ä¸åˆå§‹åŒ–ä¹Ÿä¸ä½¿ç”¨å´èƒ½é€šè¿‡ç¼–è¯‘ï¼Œåè€…è¦æ±‚å£°æ˜åç«‹å³æä¾›å¯æ¨æ–­çš„åˆå§‹åŒ–å™¨ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ç¼–è¯‘ä¸é€šè¿‡ï¼š\n1 2 3 4 5 6 7 { // Cannot infer type: \u0026#39;var\u0026#39; on variable without initializer var title; title = \u0026#34;barista\u0026#34;; // Cannot infer type: variable initializer is \u0026#39;null\u0026#39; var city = null; } Java 11 Strings ä¸ Files çš„æ–°æ–¹æ³• Strings æ–¹æ³• isBlank()ã€‚æ²¡å¿…è¦åªä¸ºäº† StringUtils.isBlank(java.lang.String) å¼•å…¥ Apache Commons Lang3ã€‚\næ–¹æ³• lines()ã€‚è¿”å›ä»å­—ç¬¦ä¸²æå–çš„ç”±è¡Œç»„æˆçš„æµï¼Œè¡Œä¹‹é—´é€šè¿‡è¡Œç»ˆæ­¢ç¬¦åˆ†éš”ã€‚\næ–¹æ³• trim()ã€‚æ–¹æ³• trim() ä»…åˆ é™¤å­—ç¬¦ \u0026lt;= U+0020ï¼ˆç©ºæ ¼ï¼‰ï¼›æ–¹æ³• strip() åˆ é™¤æ‰€æœ‰ Unicode ç©ºç™½å­—ç¬¦ï¼ˆä½†ä¸æ˜¯æ‰€æœ‰æ§åˆ¶å­—ç¬¦ï¼Œä¾‹å¦‚ \\0ï¼‰ã€‚\nFiles æ›´å®¹æ˜“åœ°ä»æ–‡ä»¶è¯»å–å­—ç¬¦ä¸²å’Œå†™å…¥å­—ç¬¦ä¸²ã€‚\n1 2 3 Path path = Files.writeString(Files.createTempFile(tempDir, \u0026#34;demo\u0026#34;, \u0026#34;.txt\u0026#34;), \u0026#34;Sample text\u0026#34;); String content = Files.readString(path); assertThat(content).isEqualTo(\u0026#34;Sample text\u0026#34;); è¿è¡Œæºæ–‡ä»¶ å¯ä»¥ç›´æ¥è¿è¡Œæºæ–‡ä»¶ï¼Œè€Œæ— éœ€ç»è¿‡æ‰‹åŠ¨ç¼–è¯‘ï¼\n1 2 3 4 5 6 public class MyScript { public static void main(String[] args) { System.out.println(\u0026#34;Hello, \u0026#34; + args[0] + \u0026#34;!\u0026#34;); } } å‘½ä»¤è¡Œå·¥å…· java å¸®ä½ å…ˆç¼–è¯‘åå¯åŠ¨ JVMã€‚\n1 2 % java MyScript.java world Hello, world! Lambda å‚æ•°çš„ç±»å‹æ¨æ–­ 1 (var firstName, var lastName) -\u0026gt; firstName + lastName Java 12 ğŸ¥µ æ”¯æŒ Unicode 11 å’Œ Switch è¡¨è¾¾å¼çš„é¢„è§ˆã€‚\nJava 13 Switch Expression (Preview) Switch è¡¨è¾¾å¼æ¯” Switch è¯­å¥æ›´ç´§å‡‘ã€ç®€æ´ã€æ˜“äºé˜…è¯»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 switch (day) { case MONDAY: case FRIDAY: case SUNDAY: System.out.println(6); break; case TUESDAY: System.out.println(7); break; case THURSDAY: case SATURDAY: System.out.println(8); break; case WEDNESDAY: System.out.println(9); break; } // since java 12/13 switch (day) { case MONDAY, FRIDAY, SUNDAY -\u0026gt; System.out.println(6); case TUESDAY -\u0026gt; System.out.println(7); case THURSDAY, SATURDAY -\u0026gt; System.out.println(8); case WEDNESDAY -\u0026gt; System.out.println(9); } Switch è¡¨è¾¾å¼ä¸ Switch è¯­å¥ä¸€ä¸ªé‡è¦åŒºåˆ«åœ¨äºå‰è€…æœ‰è¿”å›å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 int numLetters; switch (day) { case MONDAY: case FRIDAY: case SUNDAY: numLetters = 6; break; case TUESDAY: numLetters = 7; break; case THURSDAY: case SATURDAY: numLetters = 8; break; case WEDNESDAY: numLetters = 9; break; default: throw new IllegalStateException(\u0026#34;Wat: \u0026#34; + day); } // since java 12/13 int numLetters = switch (day) { case MONDAY, FRIDAY, SUNDAY -\u0026gt; 6; case TUESDAY -\u0026gt; 7; case THURSDAY, SATURDAY -\u0026gt; 8; case WEDNESDAY -\u0026gt; 9; }; Text Blocks (Preview) åœ¨ Java æºæ–‡ä»¶é‡Œå†™å¤šè¡Œçš„ SQL ä»¤äººæ²®ä¸§ï¼Œæ˜¾å¼çš„æ¢è¡Œå’Œæ˜¾å¼çš„åŠ å·æ˜¯é˜…è¯»ä»£ç çš„éšœç¢ï¼Œä¸ç»å¤„ç†å¤åˆ¶åˆ°å…¶å®ƒåœ°æ–¹ä¹Ÿéš¾ä»¥è°ƒè¯•ï¼š\n1 2 3 String query = \u0026#34;SELECT `EMP_ID`, `LAST_NAME` FROM `EMPLOYEE_TB`\\n\u0026#34; + \u0026#34;WHERE `CITY` = \u0026#39;INDIANAPOLIS\u0026#39;\\n\u0026#34; + \u0026#34;ORDER BY `EMP_ID`, `LAST_NAME`;\\n\u0026#34;; ç›´åˆ°ç»ˆäºå¯ä»¥ä½¿ç”¨â€œäºŒç»´â€çš„æ–‡æœ¬å—ï¼š\n1 2 3 4 5 String query = \u0026#34;\u0026#34;\u0026#34; SELECT `EMP_ID`, `LAST_NAME` FROM `EMPLOYEE_TB` WHERE `CITY` = \u0026#39;INDIANAPOLIS\u0026#39; ORDER BY `EMP_ID`, `LAST_NAME`; \u0026#34;\u0026#34;\u0026#34;; Java 14 Switch Expression Switch è¡¨è¾¾å¼æ­£å¼åŠ å…¥ Javaã€‚\n1 2 3 4 5 6 7 8 9 int j = switch (day) { case MONDAY -\u0026gt; 0; case TUESDAY -\u0026gt; 1; default -\u0026gt; { int k = day.toString().length(); int result = f(k); yield result; } }; åœ¨ Switch è¡¨è¾¾å¼ä½“å†…æ˜¾å¼æˆ–éšå¼ä½¿ç”¨å…³é”®è¯ yield äº§ç”Ÿè¿”å›å€¼ã€‚\nRecords (Preview) ç¼–å†™æ™®é€šçš„ç±»æ—¶å¸¸ä¼´éšç€ç¼–å†™å¤§é‡çš„æ ·æ¿ä»£ç ï¼šæ„é€ å™¨ã€è®¿é—®å™¨ï¼ˆæ¯”å¦‚ Getters/Settersï¼‰ã€equals()ã€toString() ç­‰ç­‰ï¼Œé€šå¸¸æœ‰ä¸¤ç§æ–¹æ¡ˆå¯ä»¥ç¼“è§£ç¼–å†™æ ·æ¿ä»£ç çš„æ²®ä¸§ï¼š\nç”Ÿæˆæºä»£ç ã€‚ä¾‹å¦‚ä½¿ç”¨ IDE ç”Ÿæˆæ ·æ¿ä»£ç ã€‚ ç¼–è¯‘æ—¶ç”Ÿæˆä»£ç ã€‚ä¾‹å¦‚ä½¿ç”¨ Project Lombokã€‚ Records æ˜¯ä¸€ç§ç±»å‹å£°æ˜ï¼Œå®ƒæ˜¯ class çš„ä¸€ç§å—é™å½¢å¼ï¼Œä¸€æ¡ record å…·æœ‰åç§°å’ŒçŠ¶æ€æè¿°ï¼ˆstate descriptionï¼‰ï¼Œä¸¾ä¾‹æ¥è¯´ï¼š\n1 2 record Point(int x, int y) { } ä¸€æ¡ record è‡ªåŠ¨è·å¾—äº†è®¸å¤šæ ‡å‡†æˆå‘˜ï¼špublic final çš„å®ä¾‹å­—æ®µã€æœ‰å‚æ„é€ å™¨ã€æ ‡å‡†çš„ equalsã€hashCodeã€toString æ–¹æ³•ï¼Œä¸Šæ–‡çš„ record Point è¿‘ä¹ç­‰ä»·äºï¼š\n1 2 3 4 5 6 7 8 9 10 11 final class Point { public final int x; public final int y; public Point(int x, int y) { this.x = x; this.y = y; } // Implementation of equals, hashCode, toString } Pattern Matching for instanceof (Preview) ä½¿ç”¨ instanceof åˆ¤æ–­å˜é‡ä¹‹åä½¿ç”¨è¯¥å˜é‡éœ€å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼š\n1 2 3 4 if (obj instanceof String) { String s = (String) obj; // use s } ç°åœ¨æœ‰äº†æ›´ç®€æ´çš„å†™æ³•ï¼š\n1 2 3 if (obj instanceof String s) { // can use s here } Packaging Tool (Incubator) å‘½ä»¤è¡Œå·¥å…· jpackage å°† Java åº”ç”¨ç¨‹åºå’Œ Java è¿è¡Œæ—¶é•œåƒä½œä¸ºè¾“å…¥ï¼Œå¹¶äº§å‡ºåŒ…å«æ‰€æœ‰å¿…è¦ä¾èµ–çš„ Java åº”ç”¨ç¨‹åºé•œåƒã€‚å®ƒèƒ½å¤Ÿäº§ç”Ÿç‰¹å®šå¹³å°çš„åŸç”ŸåŒ…ï¼Œä¾‹å¦‚ Windows ä¸Šçš„ exe å’Œ msiã€MacOS ä¸Šçš„ dmg å’Œ pkgã€Linux ä¸Šçš„ deb å’Œ rpmï¼Œç„¶è€Œæ¯ç§æ ¼å¼å¿…é¡»åœ¨å…¶è¿è¡Œçš„å¹³å°ä¸Šæ„å»ºã€‚\nRemove CMS ç§»é™¤å¹¶å‘æ ‡è®°æ¸…é™¤ (CMS) åƒåœ¾æ”¶é›†å™¨ã€‚\nJava 15 ZGC å¯æ‰©å±•çš„ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ ZGCï¼Œç”Ÿäº§å°±ç»ªã€‚\nText Blocks Text Blocks ç”Ÿäº§å°±ç»ªã€‚\nSealed Classes (Preview) ä¸€ä¸ª sealed class æˆ–è€… sealed interface è¦æ±‚æŒ‡å®šå…è®¸å“ªäº›ç±»ç»§æ‰¿æˆ–è€…å®ç°ã€‚\n1 2 3 4 package com.example.geometry; public abstract sealed class Shape permits Circle, Rectangle, Square { } å¦‚ä¸Šæ‰€ç¤ºï¼Œç±» Shape åªèƒ½è¢« Circleã€Rectangleã€Square ç»§æ‰¿ï¼Œä¸”æ‰€æœ‰ sealed class çš„å­ç±»å¿…é¡»æ˜¯ finalã€sealed æˆ–é sealed çš„ã€‚\nJava 16 Pattern Matching for instanceof Pattern Matching for instanceof æ­£å¼åŠ å…¥ Javaã€‚\nUnix-Domain Socket Channels Unix-domain sockets ç”¨äºåŒä¸€ä¸»æœºä¸Šçš„è¿›ç¨‹é—´çš„é€šä¿¡ï¼Œå®ƒä»¬å¤§å¤šæ•°æ–¹é¢ç±»ä¼¼äº TCP/IP Socketsï¼Œé™¤äº†é€šè¿‡æ“ä½œç³»ç»Ÿæ–‡ä»¶è·¯å¾„åè€Œä¸æ˜¯é€šè¿‡ IP åœ°å€å’Œç«¯å£æ¥å¯»å€ã€‚\nJava 17 Pattern Matching for switch (Preview) è™½ç„¶ instanceof å·²ç»æœ‰æ›´ç®€æ´çš„æ¨¡å¼åŒ¹é…ï¼Œä½†æ˜¯ç»“åˆè¿‡å¤šçš„ if\u0026hellip;else if\u0026hellip;else ä¸æ¯” switch è¡¨è¾¾å¼æ›´ç›´è§‚ã€‚\n1 2 3 4 5 6 7 8 9 static String formatterPatternSwitch(Object o) { return switch (o) { case Integer i -\u0026gt; String.format(\u0026#34;int %d\u0026#34;, i); case Long l -\u0026gt; String.format(\u0026#34;long %d\u0026#34;, l); case Double d -\u0026gt; String.format(\u0026#34;double %f\u0026#34;, d); case String s -\u0026gt; String.format(\u0026#34;String %s\u0026#34;, s); default -\u0026gt; o.toString(); }; } ç°åœ¨æˆ‘ä»¬å¯ä»¥æŠŠ Object ç±»å‹çš„å˜é‡ä¼ é€’ç»™ switchï¼Œä¸”å·²åŒ¹é… case çš„æ¨¡å¼è¢«è‡ªåŠ¨èµ‹å€¼ã€‚\nSealed Classes Sealed Classes æ­£å¼åŠ å…¥ Javaã€‚\nForeign Function \u0026amp; Memory API (Incubator) Foreign Function \u0026amp; Memory API æ˜¯ JNI çš„æ›¿ä»£å“ï¼ŒJava ç¨‹åºå¯ä»¥é€šè¿‡è¯¥ API ä¸ Java è¿è¡Œæ—¶ä¹‹å¤–çš„ä»£ç å’Œæ•°æ®è¿›è¡Œäº¤äº’ã€‚é€šè¿‡æœ‰æ•ˆè°ƒç”¨ Foreign Functionï¼ˆå³ JVM ä¹‹å¤–çš„ä»£ç ï¼‰å’Œå®‰å…¨åœ°è®¿é—®å¤–éƒ¨å†…å­˜ï¼ˆå³ä¸å— JVM ç®¡ç†çš„å†…å­˜ï¼‰ä½¿ Java ç¨‹åºèƒ½å¤Ÿè°ƒç”¨åŸç”Ÿåº“ï¼ˆnative librariesï¼‰å¹¶å¤„ç†åŸç”Ÿæ•°æ®ï¼ˆprocess native dataï¼‰ï¼Œä¸”æ²¡æœ‰ JNI çš„è„†å¼±æ€§å’Œå±é™©æ€§ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\né‡åˆ°çš„å‘ CGLIB æœªæ”¯æŒ Java 17ã€‚\nè‡³å°‘æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š\nä½¿ç”¨ Byte Buddy ä»£æ›¿ cglibï¼Œä½† API å¤§ç›¸å¾„åº­ã€‚\nä½¿ç”¨ org.springframework.cglib ä»£æ›¿ net.sf.cglibï¼Œä½†ä¾èµ– org.springframework:spring-core:5.3.xã€‚\n\u0026hellip;\u0026hellip;\nå‚è€ƒèµ„æ–™ On Java\nJava Versions and Features\nWhy Do Local Variables Used in Lambdas Have to Be Final or Effectively Final?\nJEP 0: JEP Index\nWhatâ€™s New Between Java 11 and Java 17?\nJava version history\n","date":"2022-05-30T10:37:32+08:00","permalink":"https://h2cone.github.io/2022/05/30/java8-java17/","title":"Java 8 åˆ° Java 17 çš„ç‰¹æ€§"},{"content":"æ¦‚è¿° MySQL æ— ç–‘æ˜¯â€œå…«è‚¡æ–‡â€çš„é‡ç¾åŒºä¹‹ä¸€ï¼Œé»˜è®¤å­˜å‚¨å¼•æ“æ˜¯ InnoDB çš„ MySQL å®é™…ä¸Šæ˜¯ä»€ä¹ˆæ ·å­ï¼Ÿ\nMySQL æ¶æ„ è¿™æ˜¯ MySQL æ¶æ„å›¾ï¼Œç»“åˆåº”ç”¨ç¨‹åºå¼€å‘ç»éªŒï¼Œä¸éš¾çœ‹å‡ºï¼š\nå®¢æˆ·ç«¯/æœåŠ¡ç«¯æ¨¡å‹ã€‚\nMySQL çš„å®ˆæŠ¤è¿›ç¨‹æ˜¯ mysqldã€‚\nMySQL æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯æä¾›äº† SQL æ¥å£ï¼ˆåŒ…æ‹¬ DDLã€DMLã€DQLã€DCLï¼‰ã€‚\nMySQL å¯æ’æ‹”å­˜å‚¨å¼•æ“ï¼ŒMySQL 8.0 é»˜è®¤å­˜å‚¨å¼•æ“æ˜¯ InnoDBï¼ˆé™¤éåˆ›å»ºè¡¨æ—¶æŒ‡å®šå…¶å®ƒå¼•æ“ï¼‰ã€‚\nMySQL æœåŠ¡ç«¯ä»ä¸Šåˆ°ä¸‹å¯åˆ†ä¸ºä¸‰å±‚æ¬¡ï¼šæœåŠ¡å±‚ï¼ˆSQLã€è§£æã€ä¼˜åŒ–ã€ç¼“å­˜ï¼‰ã€å­˜å‚¨å¼•æ“ã€æ–‡ä»¶ã€‚\nå­˜å‚¨å¼•æ“éšè—äº†æ•°æ®åº“æ–‡ä»¶ä¸å†…å­˜ç¼“å†²æ± çš„å¤æ‚æ€§ï¼Œå‘æœåŠ¡å±‚æä¾›äº†ç»Ÿä¸€çš„æ–‡ä»¶è¯»å†™æ¥å£ï¼Ÿ\nInnoDB æ¶æ„ InnoDB è‡³å°‘æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š\néµå¾ª ACID æ¨¡å‹ï¼Œäº‹åŠ¡å…·æœ‰æäº¤ã€å›æ»šã€å´©æºƒæ¢å¤çš„åŠŸèƒ½ä»¥ä¿æŠ¤ç”¨æˆ·æ•°æ®ã€‚\nè¡Œçº§é”ä¸ä¸€è‡´æ€§è¯»æé«˜äº†å¤šç”¨æˆ·å¹¶å‘è®¿é—®çš„æ€§èƒ½ã€‚\næ¯å¼  InnoDB è¡¨éƒ½æœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•ï¼Œèƒ½å¤Ÿæœ€å°åŒ–ä¸»é”®æŸ¥è¯¢çš„ I/O æ¬¡æ•°ã€‚\næ”¯æŒå¤–é”®çº¦æŸæ¥ä¿æŒæ•°æ®å®Œæ•´æ€§ã€‚\nè¿™æ˜¯ InnoDB æ¶æ„å›¾ï¼ŒäºŒåˆ†ä¸ºåœ¨å†…å­˜ä¸­çš„ç»“æ„ä¸åœ¨ç£ç›˜ä¸Šçš„ç»“æ„ï¼Œ\nSQL æ‰§è¡Œè·¯å¾„ ä¸€æ¡æ™®é€šçš„ SELECT è¯­å¥çš„æ—…ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š\nå®¢æˆ·ç«¯è¾“å…¥è¯­å¥ã€‚\næ¶ˆæ¯é€šè¿‡ TCP/IP çº¿è·¯ã€‚\næœåŠ¡ç«¯åˆ¤å®šæ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼Œæœªå‘½ä¸­åˆ™è§£æè¯­å¥ä¸ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ã€‚\næœåŠ¡ç«¯è°ƒç”¨ä¸‹å±‚å‡½æ•°ã€‚\nå­˜å‚¨å¼•æ“è¯»å†™æ–‡ä»¶ã€‚\nç´¢å¼•ç¯‡ æ•°æ®ç»“æ„ ç´¢å¼•æ˜¯ä»¥é¢å¤–çš„å†™å…¥ä¸ç©ºé—´ä¸ºä»£ä»·æ¥åŠ é€Ÿæ•°æ®æŸ¥æ‰¾çš„ä¸€ç±»æ•°æ®ç»“æ„çš„ç»Ÿç§°ã€‚ç´¢å¼•å°±åƒå›¾ä¹¦å¼€å¤´åä¸ºâ€œç›®å½•â€çš„ä¹¦é¡µæˆ–ç»“å°¾åä¸ºâ€œç´¢å¼•â€çš„ä¹¦é¡µï¼Œè¯»è€…æƒ³è¦æŸ¥çœ‹æŸä¸€å†…å®¹ï¼Œä¸å…¶ä»ç¬¬ä¸€é¡µå¼€å§‹ç¿»é˜…ç›´åˆ°é‡è§ç›®æ ‡ä¹¦é¡µä¸ºæ­¢ï¼Œä¸å¦‚å…ˆåœ¨â€œç´¢å¼•â€æˆ–â€œç›®å½•â€æŸ¥æ‰¾å…³é”®è¯å¾—åˆ°é¡µç ï¼Œæœ‰äº†é¡µç å°±èƒ½å¿«é€Ÿå®šä½å…³é”®è¯æ‰€åœ¨çš„ä¹¦é¡µã€‚è™½ç„¶éšå–»ä¾¿äºç†è§£ç´¢å¼•çš„åŠ é€Ÿä½œç”¨ï¼Œä½†è¯´æœåŠ›æœ‰é™ï¼Œè‡³å°‘å®šæ€§æè¿°è§£å†³æŸ¥æ‰¾é—®é¢˜çš„æ•°æ®ç»“æ„ä¸ç®—æ³•æ€§èƒ½ï¼š\nä¸Šå›¾æ˜¯è‘—åçš„çº¢çš®ä¹¦å¯¹æ‰€è®²è¿°çš„æ•°æ®ç»“æ„ä¸ç®—æ³•æ—¶é—´å¤æ‚åº¦çš„æ€»ç»“ï¼Œé¡ºåºæŸ¥æ‰¾æœ€æ…¢ï¼ŒäºŒå‰æ ‘æŸ¥æ‰¾æœ€åçš„æƒ…å†µä¸‹é€€åŒ–æˆé¡ºåºæŸ¥è¯¢ï¼Œè€Œæœ‰åºæ•°ç»„çš„æ’å…¥æ“ä½œå¾ˆæ…¢ï¼Œå¯¹äºæŸ¥æ‰¾ä¸æ’å…¥è¾ƒå¥½çš„æƒè¡¡æ˜¯ 2-3 æ ‘æŸ¥æ‰¾ï¼ˆçº¢é»‘æ ‘ï¼‰ã€‚æ•£åˆ—è¡¨æˆ–å“ˆå¸Œè¡¨è¡¨ç°å¦‚ä½•ï¼Ÿå–å†³äºå“ˆå¸Œå‡½æ•°çš„å®ç°ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒHash Table æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ï¼Œå‡ ä¹ä¸ N æ— å…³ã€‚\næ•°æ®åº“ç³»ç»Ÿï¼ˆDBMSï¼‰ä¸ä»…ç®¡ç†å†…å­˜ç¼“å†²æ± ï¼ˆBuffer Poolï¼‰ï¼Œè€Œä¸”ç®¡ç†æ•°æ®åº“æ–‡ä»¶ï¼ˆDatabase Fileï¼‰ã€‚ç”±äºè®¡ç®—æœºç³»ç»Ÿä¸»å­˜ï¼ˆMemoryï¼‰ä¸ç£ç›˜ï¼ˆDiskï¼‰çš„é€Ÿåº¦é«˜åº¦ä¸å¯¹ç­‰ï¼Œå¼€å‘è€…é€‰æ‹©æ•°æ®ç»“æ„ä¸ä»…è€ƒè™‘å‘ç”Ÿåœ¨å†…å­˜çš„æŸ¥æ‰¾ä¸æ’å…¥ï¼Œè€Œä¸”é«˜åº¦æ³¨æ„ç£ç›˜ I/O æ¬¡æ•°æˆ–é¡µï¼ˆPageï¼‰è®¿é—®æ¬¡æ•°ã€‚\né¡µæ˜¯ä¸€å—è¿ç»­ã€å›ºå®šå¤§å°çš„æ•°æ®ã€‚ä»å…³ç³»æ•°æ®åº“ç³»ç»Ÿçš„è§’åº¦æ¥çœ‹ï¼ŒæŸä¸€å¼ è¡¨çš„æŸä¸€è¡Œæ•°æ®å­˜åœ¨äºæŸä¸€é¡µæˆ–æŸä¸€äº›é¡µä¸­ã€‚å…³ç³»æ•°æ®åº“æ—¢ç„¶å£°ç§°æ”¯æŒ SQLï¼Œé‚£ä¹ˆè‡³å°‘æ»¡è¶³ä»¥ä¸‹æŸ¥è¯¢éœ€æ±‚ï¼š\nFROM \u0026amp; JOIN -\u0026gt; WHERE -\u0026gt; GROUP BY -\u0026gt; HAVING -\u0026gt; SELECT -\u0026gt; ORDER BY -\u0026gt; LIMIT\nåœ¨ WHERE æˆ– HAVING å¤„ï¼Œå¯ä»¥æ˜¯ç­‰å€¼æ¡ä»¶ï¼Œå¦‚ =ï¼Œä¹Ÿå¯ä»¥èŒƒå›´æ¡ä»¶ï¼Œå¦‚ \u0026lt;ã€\u0026gt;ã€BETWEEN \u0026hellip; AND \u0026hellip;ï¼›GROUP BY éšå«äº†æ˜¯å¦ç›¸ç­‰çš„æ¯”è¾ƒï¼›ORDER BY è¦æ±‚æœ‰åºæˆ–æ’åºï¼›SELECT åˆ—è¡¨å¯ä»¥åŒ…å«èšåˆå‡½æ•°ï¼Œå¦‚ COUNTã€SUMã€MINã€AVGã€MAX ç­‰ã€‚\nä¸æ­¢äºæ”¯æŒç­‰å€¼æŸ¥è¯¢ã€èŒƒå›´æŸ¥è¯¢ã€æœ‰åºæ“ä½œçš„é«˜æ€§èƒ½çš„ç£ç›˜å‹å¥½å‹æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼ŸMySQL InnoDB å¼€å‘è€…é€‰æ‹© B+ treeã€‚\nB+ tree ä» B-tree æ¼”åŒ–è€Œæ¥ï¼Œä¸¤è€…éƒ½å±äºå¹³è¡¡æŸ¥æ‰¾æ ‘ï¼Œä¸ä¼šå‡ºç°è¿‡é•¿çš„æï¼Œç»“ç‚¹æ›´èƒ–ä¸”æ ‘æ›´çŸ®æœ‰åŠ©äºç¼©çŸ­æœç´¢è·¯å¾„æˆ–å‡å°‘æœç´¢èŒƒå›´ã€‚B+ tree å¶å­ç»“ç‚¹å†—ä½™å­˜å‚¨é”®ï¼Œå¶å­ç»“ç‚¹åŒ…å«çš„é”®çš„èŒƒå›´å¦‚ä¸‹æ‰€ç¤ºï¼š\n[æœ€å°é”®æˆ–çˆ¶æ¯çš„è¾ƒå°é”®, æœ€å¤§é”®æˆ–çˆ¶æ¯çš„è¾ƒå¤§é”®)\nç”±äº B+ tree å¶å­ç»“ç‚¹æ›´èƒ–ä¸”å¶å­ç»“ç‚¹ä¹‹é—´ç›¸äº’é“¾æ¥ç»„æˆæœ‰åºé“¾è¡¨ï¼ŒèŒƒå›´æŸ¥è¯¢æ—¶å®šä½åˆ°ä¸€ä¸ªå¶å­ç»“ç‚¹åæ— éœ€è¿”å›åˆ°çˆ¶æ¯ç»“ç‚¹ï¼Œè€Œæ˜¯éå†æœ‰åºé“¾è¡¨ï¼Œå› æ­¤èŒƒå›´æŸ¥æ‰¾æ€§èƒ½é«˜äº B-treeã€‚\nå—åˆ° B+Tree index structures in InnoDB çš„å¯å‘ï¼Œç¡®ä¿¡ InnoDB åŸºäº B+ tree å®ç°ç´¢å¼•ï¼Œå…¶ç»“ç‚¹è¢«ç§°ä¹‹ä¸ºé¡µï¼ˆPageï¼‰ï¼Œé¡µåŒ…å«å¤šæ¡è®°å½•ï¼ˆRecordï¼‰ï¼Œè®°å½•ç”±é”®ï¼ˆKeyï¼‰ä¸å€¼ï¼ˆValueï¼‰ç»„æˆï¼Œå€¼çš„ç±»å‹æ˜¯å…ƒç»„ï¼ˆtupleï¼‰æˆ–æŒ‡é’ˆï¼ˆpointerï¼‰ã€‚é™¤äº†ç”¨æˆ·æ’å…¥çš„è®°å½•ï¼ŒInfimun å’Œ Supremun éƒ½å±äºç³»ç»Ÿè®°å½•ï¼ˆsystem recordï¼‰ï¼Œå‰è€…åŒ…å«æœ€å¤§ä¸‹ç•Œï¼Œåè€…åŒ…å«æœ€å°ä¸Šç•Œã€‚å¶å­é¡µçš„è®°å½•åŒ…å«è¡Œæ•°æ®ï¼Œéå¶å­é¡µçš„è®°å½•åŒ…å«æŒ‡å‘å…¶å®ƒé¡µçš„æŒ‡é’ˆï¼Œå¶å­é¡µä¹‹é—´å’Œéå¶å­é¡µä¹‹é—´éƒ½å­˜åœ¨é“¾æ¥ï¼Œéå¶å­é¡µä¸ºå¿«é€Ÿå®šä½å¶å­é¡µæä¾›äº†å¯¼èˆªã€‚\nå¶å­é¡µé€»è¾‘ç»“æ„ï¼š\néå¶å­é¡µé€»è¾‘ç»“æ„ï¼š\nå‡è®¾åˆ›å»ºä¸€å¼ è¡¨å¹¶æ’å…¥ä¸€äº›è®°å½•ï¼š\n1 2 3 4 5 6 7 CREATE TABLE t_btree ( i INT NOT NULL, s CHAR(10) NOT NULL, PRIMARY KEY(i) ) ENGINE=InnoDB; INSERT INTO t_btree (i, s) VALUES (0, \u0026#34;A\u0026#34;), (1, \u0026#34;B\u0026#34;), (2, \u0026#34;C\u0026#34;); è¿™å¼ è¡¨çš„ç´¢å¼•å¦‚ä¸‹æ‰€ç¤ºï¼ˆé€»è¾‘ç»“æ„ï¼‰ï¼š\nä¸å±€é™äºäºŒç»´è¡¨æ ¼ï¼Œè½¬ç§»åˆ°ç´¢å¼•çš„æ•°æ®ç»“æ„æ˜¯è§£å†³é—®é¢˜çš„å…¨æ–°è§†è§’ã€‚\nç´¢å¼•åˆ†ç±» æŒ‰æ•°æ®ç»“æ„ï¼š\nå¤§å¤šæ•° MySQL ç´¢å¼•ï¼ˆPRIMARY KEYã€UNIQUEã€KEY/INDEXï¼‰éƒ½å­˜å‚¨åœ¨ B-Trees ä¸­ã€‚ä¾‹å¤–ï¼šç©ºé—´æ•°æ®ç±»å‹çš„ç´¢å¼•ä½¿ç”¨ R-treesï¼›MEMORY è¡¨ä¹Ÿæ”¯æŒ Hash ç´¢å¼•ï¼›InnoDB å¯¹ FULLTEXT ç´¢å¼•ä½¿ç”¨å€’æ’åˆ—è¡¨ã€‚\næŒ‰å­˜å‚¨å™¨ï¼š\nAdaptive Hash Index åœ¨å†…å­˜ä¸­ï¼ŒClustered and Secondary Indexes å’Œ InnoDB Full-Text Indexes åœ¨ç£ç›˜ä¸Šã€‚\næŒ‰ç´¢å¼•ç±»ï¼ˆIndex Classï¼‰ï¼š\næŒ‰åˆ—çš„ä¸ªæ•°ï¼š\nåˆ†æˆå•åˆ—ç´¢å¼•ï¼ˆcolumn indexï¼‰å’Œå¤åˆç´¢å¼•ï¼ˆcomposite indexï¼‰ï¼Œå¤åˆç´¢å¼•å³å¤šåˆ—ç´¢å¼•ã€‚\nå¦‚ä½•ä½¿ç”¨ åˆ›å»º ç”¨æˆ·è¦ä¹ˆåœ¨åˆ›å»ºè¡¨æ—¶åˆ›å»ºç´¢å¼•ï¼Œè¦ä¹ˆåœ¨åˆ›å»ºè¡¨ååˆ›å»ºç´¢å¼•ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒMySQL ä¼˜åŒ–å™¨è¶³ä»¥é€šè¿‡ç»Ÿè®¡ä¿¡æ¯ä»ç”¨æˆ·åˆ›å»ºçš„ç´¢å¼•å½“ä¸­é€‰æ‹©æœ€ä¼˜çš„ç´¢å¼•ã€‚\nä¼˜åŒ– æ¯å¼  InnoDB è¡¨éƒ½æœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•ï¼ˆclustered indexï¼‰ï¼Œå´ä¸ä¸€å®šæœ‰äºŒçº§ç´¢å¼•ï¼ˆsecondary Indexï¼‰ï¼Œå‰è€…æœ‰æ—¶è¢«ç§°ä¸ºä¸»é”®ç´¢å¼•ï¼Œåè€…æœ‰æ—¶è¢«ç§°ä¸ºè¾…åŠ©ç´¢å¼•ã€‚èšç°‡ç´¢å¼•å¶å­é¡µçš„è®°å½•åŒ…å«æ•´è¡Œæ•°æ®ï¼ŒäºŒçº§ç´¢å¼•å¶å­é¡µçš„è®°å½•åŒ…å«ä¸»é”®å€¼ã€‚\nå‡è®¾æœ‰ä¸€å¼ åä¸º tab çš„è¡¨ï¼Œä¸»é”®ï¼ˆPRIMARY KEYï¼‰æ˜¯ pkï¼Œå”¯ä¸€é”®ï¼ˆUNIQUEï¼‰æ˜¯ ukï¼Œæ™®é€šç´¢å¼•ï¼ˆKEY/INDEXï¼‰çš„åˆ—æ˜¯ kï¼Œæ— ç´¢å¼•çš„åˆ—æ˜¯ colï¼š\npk uk k col 1 uk1 k1 col1 2 uk2 k2 col2 3 uk3 k3 col3 è¡¨ tab çš„èšç°‡ç´¢å¼•å¶å­é¡µä»¬è¡¨ç¤ºä¸º:\n(1, uk1, k1, col1) â‡† (2, uk2, k2, col2) â‡† (3, uk3, k3, col13)\nè¡¨ tab çš„ä¸€ä¸ªäºŒçº§ç´¢å¼•å¶å­é¡µä»¬è¡¨ç¤ºä¸ºï¼š\n(uk1, 1) â‡† (uk2, 2) â‡† (uk3, 3)\nè¡¨ tab çš„å¦ä¸€ä¸ªäºŒçº§ç´¢å¼•å¶å­é¡µä»¬è¡¨ç¤ºä¸ºï¼š\n(k1, 1) â‡† (k2, 2) â‡† (k3, 3)\nä¸‹é¢çš„è¯­å¥æ‰§è¡Œåªåœ¨ä¸€ä¸ªèšç°‡ç´¢å¼•ä¸Šæœç´¢ï¼š\n1 SELECT * FROM tab WHERE pk = 3; ä¸‹é¢çš„è¯­å¥æ‰§è¡Œä¾æ¬¡åœ¨ä¸€ä¸ªäºŒçº§ç´¢å¼•å’Œä¸€ä¸ªèšç°‡ç´¢å¼•ä¸Šæœç´¢ï¼š\n1 SELECT * FROM tab WHERE uk = \u0026#34;uk3\u0026#34;; å…ˆåœ¨ uk çš„ç´¢å¼•æ‰¾åˆ° (uk3, 3) ï¼Œå¾—åˆ°ä¸»é”®å€¼ä¸º 3ï¼Œå†é€šè¿‡è¯¥ä¸»é”®å€¼åœ¨ pk çš„ç´¢å¼•æ‰¾åˆ° (3, uk3, col13)ã€‚ç”±æ­¤çœ‹æ¥ï¼Œç´¢å¼•è®¿é—®æ¬¡æ•°çš„å·®å¼‚å†³å®šäº†é€šè¿‡ä¸»é”®æŸ¥è¯¢å¯ä»¥æ¯”é€šè¿‡å”¯ä¸€é”®æŸ¥è¯¢æˆ–æ™®é€šç´¢å¼•åˆ—æŸ¥è¯¢æ›´å¿«ã€‚åº”ç”¨ç¨‹åºä¸æ€»æ˜¯åªé€šè¿‡ä¸»é”®æŸ¥è¯¢æ•°æ®ï¼Œå‡è®¾æœ‰ä¸€å¼ å­¦å‘˜è¡¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 CREATE TABLE `student` ( `id` bigint unsigned NOT NULL AUTO_INCREMENT, `first_name` varchar(50) COLLATE utf8mb4_bin NOT NULL, `last_name` varchar(50) COLLATE utf8mb4_bin NOT NULL, `email` varchar(50) COLLATE utf8mb4_bin NOT NULL, `gender` tinyint unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39;, `ip_address` varchar(20) COLLATE utf8mb4_bin NOT NULL, `level` int NOT NULL DEFAULT \u0026#39;0\u0026#39;, `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP, `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`id`) ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin; é¢„æœŸæ•°æ®é‡è¶³å¤Ÿå¤§çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•åˆ›å»ºç´¢å¼•ä»¥æé«˜ç§ä¸€äº›æ¡ä»¶æŸ¥è¯¢çš„æ•ˆç‡ï¼šemailã€levelã€email and levelã€level and emailï¼Ÿå‡è®¾ id çš„ç´¢å¼•åä¸º pkï¼Œè‹¥åªåˆ›å»ºæ™®é€šç´¢å¼•ï¼šemail_kï¼Œåˆ™ä¸‹é¢çš„è¯­å¥åœ¨ email_k æœç´¢å‘½ä¸­åï¼Œä»ç„¶ä¼šåœ¨ pk æœç´¢ï¼š\n1 select email, `level` from student where email = \u0026#39;sharryms@edublogs.org\u0026#39;; è‹¥åªåˆ›å»ºæ™®é€šç´¢å¼• level_kï¼Œåˆ™ä¸‹é¢çš„è¯­å¥åœ¨ level_k æœç´¢å‘½ä¸­åï¼Œä»ç„¶ä¼šåœ¨ pk æœç´¢ï¼š\n1 select email, `level` from student where `level` = 59; é™¤äº†èšç°‡ç´¢å¼•ï¼Œæ˜¯å¦å­˜åœ¨åŒ…å« SQL æ£€ç´¢åˆ°çš„æ‰€æœ‰åˆ—çš„ç´¢å¼•ï¼ŸMySQL æ”¯æŒå¤åˆå¤šä¸ªæ™®é€šç´¢å¼•ï¼Œå¯ä»¥åˆ›å»ºå¤šåˆ—ç´¢å¼•ã€‚å¦‚æœè¡¨æ‹¥æœ‰ä¸€ä¸ªå¤šåˆ—ç´¢å¼•ï¼Œä¼˜åŒ–å™¨å¯ä»¥ä½¿ç”¨ç´¢å¼•çš„ä»»ä½•æœ€å·¦å‰ç¼€æ¥æŸ¥æ‰¾è¡Œã€‚ä¾‹å¦‚ï¼Œå¦‚æœåœ¨ (col1, col2, col3) ä¸Šæœ‰ä¸€ä¸ªä¸‰åˆ—ç´¢å¼•ï¼Œåˆ™åœ¨ (col1)ã€(col1, col2) å’Œ (col1, col2, col3) ä¸Šæœ‰å‡æœ‰ç´¢å¼•ã€‚\nä½¿ç”¨ç´¢å¼• (col1, col2, col3) çš„è¯­å¥ä»¬ï¼š\n1 2 SELECT * FROM tbl WHERE col1 = val1; SELECT * FROM tbl WHERE col1 = val1 AND col2 = val2; æ— å¯ç”¨ç´¢å¼•çš„è¯­å¥ä»¬ï¼š\n1 2 SELECT * FROM tbl WHERE col2 = val2; SELECT * FROM tbl WHERE col2 = val2 AND col3 = val3; MySQL å®˜æ–¹è¿˜æœ‰ä¸€ä¸ªéå¸¸ç»å…¸çš„ä¾‹å­ï¼Œåˆ›å»ºä¸€ä¸ªç´¢å¼•ï¼šINDEX name (last_name, first_name)ã€‚\nä½¿ç”¨ç´¢å¼• name çš„è¯­å¥ä»¬ï¼š\n1 2 3 4 SELECT * FROM student WHERE last_name = \u0026#39;Jones\u0026#39;; SELECT * FROM student WHERE last_name = \u0026#39;Jones\u0026#39; AND first_name = \u0026#39;John\u0026#39;; SELECT * FROM student WHERE last_name=\u0026#39;Jones\u0026#39; AND (first_name = \u0026#39;John\u0026#39; OR first_name = \u0026#39;Jon\u0026#39;); SELECT * FROM student WHERE last_name = \u0026#39;Jones\u0026#39; AND first_name \u0026gt;=\u0026#39;M\u0026#39; AND first_name \u0026lt; \u0026#39;N\u0026#39;; æ— æ³•ä½¿ç”¨ç´¢å¼• name çš„è¯­å¥ä»¬ï¼š\n1 2 SELECT * FROM student WHERE first_name = \u0026#39;John\u0026#39;; SELECT * FROM student WHERE last_name = \u0026#39;Jones\u0026#39; OR first_name = \u0026#39;John\u0026#39;; è¦†ç›–äº†æŸ¥è¯¢è¯­å¥ä¸­æ‰€æœ‰åˆ—çš„ç´¢å¼•è¢«ç§°ä¸ºè¦†ç›–ç´¢å¼•ï¼ˆcovering indexï¼‰ï¼Œåœ¨ä¸­æ–‡è¯­å¢ƒï¼Œè¦†ç›–ç´¢å¼•å¯ä»¥é¿å…å›è¡¨ï¼Œå›è¡¨æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªç´¢å¼•ä¸Šæœç´¢å®Œæˆåè¿”å›åˆ°å¦ä¸€ä¸ªç´¢å¼•ä¸Šæœç´¢ã€‚å¦‚æœåœ¨ç´¢å¼• (col1, col2, col3) å‘½ä¸­äº† col1ï¼Œé‚£ä¹ˆå¯ç›´æ¥è·å– col1ã€col2ã€col3 è€Œæ— éœ€ç»§ç»­åœ¨å…¶å®ƒç´¢å¼•ä¸Šæœç´¢ col2 æˆ– col3ã€‚\nå¦‚æœç”¨ (email)ã€(level) ä¾æ¬¡è¡¨ç¤º email_kã€level_kï¼Œé‚£ä¹ˆ (email, level) è¡¨ç¤ºå¤šä¸ªç´¢å¼•ï¼š(email)ã€(email, level)ï¼Œåè¿‡æ¥è¯´ï¼Œ(level, email) è¡¨ç¤ºå¤šä¸ªç´¢å¼•ï¼š(level)ã€(level, email)ã€‚å¯¹äºä¼˜åŒ–å™¨æ¥è¯´ï¼Œlevel and email å’Œ email and level ç­‰ä»·ï¼Œå‰©ä¸‹ level å’Œ email éœ€è¦è¦†ç›–ã€‚\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé¡µåŒ…å«çš„è®°å½•è¶ŠçŸ­æˆ–è€…åˆ—é•¿åº¦ä¹‹å’Œè¶ŠçŸ­ï¼Œåˆæˆ–è€…ç´¢å¼•å ç”¨ç©ºé—´è¶Šå°ï¼Œä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¹Ÿå°±è¶Šå¿«ã€‚æ•°æ®ç±»å‹ VARCHAR(M) å…¶ä¸­çš„ M è¡¨ç¤ºä»¥å­—ç¬¦ä¸ºå•ä½å£°æ˜çš„éäºŒè¿›åˆ¶å­—ç¬¦ä¸²ç±»å‹çš„åˆ—é•¿åº¦ï¼Œä¾‹å¦‚ï¼Œä¸Šæ–‡åˆ— email çš„æ•°æ®ç±»å‹æ˜¯ varchar(50)ï¼Œå®ƒè¡¨ç¤ºå¯å­˜å‚¨çš„æœ€å¤§å­—ç¬¦æ•°ä¸º 50ï¼Œç„¶è€Œï¼Œä¸€ä¸ªå­—ç¬¦ç­‰äºå¤šå°‘å­—èŠ‚åˆ™å–å†³äºå­—ç¬¦é›†ã€‚åˆ—é•¿åº¦å•ä½æ˜¯å­—èŠ‚æ•°ï¼Œå¦‚ä½•è®¡ç®—å¯ä»¥å‚è€ƒæ•°æ®ç±»å‹å­˜å‚¨è¦æ±‚ã€‚\næ—¢ç„¶è¿‡é•¿å­—ç¬¦ä¸²æœ‰å¯èƒ½é™ä½æŸ¥è¯¢æ€§èƒ½ï¼Œé‚£æœ‰å“ªäº›ä¼˜åŒ–æ–¹æ¡ˆï¼ŸMySQL æ”¯æŒç´¢å¼•å­—ç¬¦ä¸²å‰ç¼€ï¼Œä½†æ˜¯ï¼Œå‰ç¼€çš„åŒºåˆ†åº¦è¿‡ä½çš„è¯ï¼Œå¾ˆæœ‰å¯èƒ½å¢åŠ æ‰«æè¡Œæ•°ï¼ˆrows examinedï¼‰ï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹ï¼ˆæœ€åä¸€ä¸ªé”®çš„å€¼æ‰å…¨ç­‰ï¼‰ï¼Œä¸ä»…åœ¨äºŒçº§ç´¢å¼•ä¸Šéå†è®¸å¤šå€¼çš„å‰ç¼€ç›¸ç­‰çš„é”®ï¼Œè€Œä¸”æ¯æ¬¡éƒ½è¦è¿”å›åˆ°èšç°‡ç´¢å¼•ä¸Šè¿›ä¸€æ­¥æŸ¥æ‰¾å’Œå¯¹æ¯”æ‰èƒ½ç¡®è®¤æ˜¯å¦å…¨ç­‰ï¼›ç”±äºå›è¡¨ï¼Œå­—ç¬¦ä¸²å‰ç¼€ç´¢å¼•å¾ˆå°‘æˆä¸ºè¦†ç›–ç´¢å¼•ã€‚å¦‚æœåç¼€æ¯”å‰ç¼€åŒºåˆ†åº¦æ›´é«˜ï¼Œå¯ä»¥è€ƒè™‘å€’åºæ’åˆ—å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚å…ˆå€’æ’å­˜å‚¨èº«ä»½è¯å·ï¼Œå°†æ¥æŸ¥è¯¢éœ€è¦åè½¬è¾“å…¥å­—ç¬¦ä¸²ï¼š\n1 select column_list from t where id_card = REVERSE(\u0026#39;input_id_card\u0026#39;); å¦‚æœç”¨ count(distinct col) è¡¨ç¤º col çš„åŸºæ•°ï¼Œé‚£ä¹ˆ col çš„åŒºåˆ†åº¦è®¡ç®—ç±»ä¼¼äºï¼š\n1 select count(distinct col) / count(*) from t; å¦ä¸€ç§æ–¹æ¡ˆæ˜¯æ–°å¢ç›¸åº”çš„å“ˆå¸Œåˆ—ï¼Œä¾‹å¦‚å¢åŠ æ•´æ•°ç±»å‹çš„åˆ—ï¼šèº«ä»½è¯å·çš„ CRC32ï¼ŒæŸ¥è¯¢éœ€è¦è°ƒç”¨å“ˆå¸Œå‡½æ•°ï¼Œä¸”éœ€è¦ç»„åˆåŸåˆ—å¤„ç†å¯èƒ½å‘ç”Ÿç¢°æ’çš„åœºæ™¯ï¼š\n1 select column_list from t where id_card_crc = CRC32(\u0026#39;input_id_card\u0026#39;) and id_card = \u0026#39;input_id_card\u0026#39;; ç®€å•æ€»ç»“ä¸€ä¸‹å››ç§ç´¢å¼•å­—ç¬¦ä¸²æ–¹å¼çš„ä¼˜ç¼ºç‚¹ï¼š\nç´¢å¼•å­—ç¬¦ä¸² ä¼˜ç‚¹ ç¼ºç‚¹ æ•´ä¸² æ‰«æè¡Œæ•°æˆ–å›è¡¨æ¬¡æ•°è¾ƒå°‘ã€‚ ç©ºé—´å ç”¨è¾ƒå¤§ã€‚ å‰ç¼€ ç©ºé—´å ç”¨è¾ƒå°ã€‚ å¯èƒ½å¢åŠ æ‰«æè¡Œæ•°æˆ–å›è¡¨æ¬¡æ•°ã€‚ å€’åº æ— éœ€æ–°å¢åˆ—ã€‚ ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼›ç©ºé—´å ç”¨è¾ƒå¤§ã€‚ å“ˆå¸Œ æ‰«æè¡Œæ•°æˆ–å›è¡¨æ¬¡æ•°è¾ƒå°‘ã€‚ ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼›éœ€è¦æ–°å¢åˆ—ã€‚ æœ‰æ—¶ï¼Œä¸šåŠ¡ç³»ç»Ÿè¦æ±‚æ•°æ®ä¸é‡å¤ï¼Œå”¯ä¸€ç´¢å¼•å®ç°äº†æ•°æ®åº“å±‚çš„å”¯ä¸€æ€§çº¦æŸã€‚ä¸æ™®é€šç´¢å¼•ç›¸æ¯”ï¼ŒChange Buffer æ— æ³•ç¼“å†²å¯¹å”¯ä¸€ç´¢å¼•çš„æ’å…¥ï¼Œé™¤éè®¾ç½® unique_checks = 0ï¼Œå› ä¸ºå”¯ä¸€æ€§æ£€æŸ¥è¦æ±‚å¿…é¡»å°†é¡µä»ç£ç›˜è¯»å…¥å†…å­˜æ‰èƒ½åˆ¤æ–­æŸå€¼æ˜¯å¦å·²å­˜åœ¨ã€‚\nINSERTã€UPDATE å’Œ DELETE éƒ½éœ€è¦æ›´æ”¹æ‰€æœ‰ç´¢å¼•ï¼Œå‡ºäºè¿™ä¸ªåŸå› ï¼Œè¿™äº›å˜æ›´é€šå¸¸ä¼šè¢«ç¼“å†²ã€‚é¡µåœ¨ç¼“å†²æ± ä¸­è¢«æ›´æ”¹ï¼Œè€Œä¸ç«‹å³åˆ·å…¥ç£ç›˜ã€‚åˆ é™¤è®°å½•æ—¶ï¼Œä¼šè®¾ç½®ä¸€ä¸ªæ ‡å¿—ï¼Œå› æ­¤ä¸ä¼šç«‹å³åœ¨ç£ç›˜ä¸Šåˆ é™¤è®°å½•ã€‚ç¨åï¼Œå˜æ›´å°†ç”± InnoDB åå°çº¿ç¨‹åˆ·å…¥ç£ç›˜ã€‚å·²åœ¨å†…å­˜ä¸­æ›´æ”¹ä½†å°šæœªåˆ·å…¥ç£ç›˜çš„é¡µè¢«ç§°ä¸ºè„é¡µï¼Œæ•°æ®å˜æ›´ç¼“å†²åŒºè¢«ç§°ä¸º Change Bufferã€‚\næ™®é€šç´¢å¼•ç»„åˆ Change Buffer æ˜¯ä¸€ç§ä¸é”™çš„ä¼˜åŒ–ï¼š\nä¸€å¼ é¡µå¯ä»¥åœ¨å†…å­˜ä¸­å¤šæ¬¡æ›´æ”¹ï¼Œå¹¶ä¸”åªèƒ½åˆ·å…¥ç£ç›˜ä¸€æ¬¡ã€‚\nå› ä¸ºè„é¡µä»¬ä¸€èµ·åˆ·å…¥ç£ç›˜ï¼Œæ‰€ä»¥ I/O æ¬¡æ•°æ¯”è¾ƒå°‘ã€‚\nåšæ­£ç¡®çš„äº‹æƒ… ä¼˜åŒ–å…·ä½“æŸ¥è¯¢è¯­å¥çš„ç¬¬ä¸€æ­¥ä¸åº”ç›´æ¥å¥—ç”¨ä¸Šæ–‡æ‰€è¯´çš„æ–¹å¼ï¼Œè€Œåº”è¯¥å…ˆä½¿ç”¨ EXPLAINï¼Œç‰¹åˆ«æ˜¯ç†è§£ EXPLAIN è¾“å‡ºä¿¡æ¯ï¼Œæ¯”å¦‚æ˜¯å¦ä½¿ç”¨ç´¢å¼•ã€ä½¿ç”¨å“ªäº›ç´¢å¼•ã€è®¿é—®ç±»å‹ã€é¢„è®¡æ‰«æè¡Œæ•°ç­‰ã€‚\nå½“è¡¨ student åªæœ‰èšç°‡ç´¢å¼•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 mysql\u0026gt; show index from student; +---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+ | Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression | +---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+ | student | 0 | PRIMARY | 1 | id | A | 204700 | NULL | NULL | | BTREE | | | YES | NULL | +---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+ 1 row in set (0.01 sec) mysql\u0026gt; explain select * from student where id = 169951; +----+-------------+---------+------------+-------+---------------+---------+---------+-------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+---------------+---------+---------+-------+------+----------+-------+ | 1 | SIMPLE | student | NULL | const | PRIMARY | PRIMARY | 8 | const | 1 | 100.00 | NULL | +----+-------------+---------+------------+-------+---------------+---------+---------+-------+------+----------+-------+ 1 row in set, 1 warning (0.00 sec) mysql\u0026gt; explain select email, `level` from student where email = \u0026#39;sharryms@edublogs.org\u0026#39;; +----+-------------+---------+------------+------+---------------+------+---------+------+--------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+---------------+------+---------+------+--------+----------+-------------+ | 1 | SIMPLE | student | NULL | ALL | NULL | NULL | NULL | NULL | 298708 | 10.00 | Using where | +----+-------------+---------+------------+------+---------------+------+---------+------+--------+----------+-------------+ 1 row in set, 1 warning (0.00 sec) mysql\u0026gt; explain select email, `level` from student where `level` = 59; +----+-------------+---------+------------+------+---------------+------+---------+------+--------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+---------------+------+---------+------+--------+----------+-------------+ | 1 | SIMPLE | student | NULL | ALL | NULL | NULL | NULL | NULL | 298708 | 10.00 | Using where | +----+-------------+---------+------------+------+---------------+------+---------+------+--------+----------+-------------+ 1 row in set, 1 warning (0.00 sec) mysql\u0026gt; explain select * from student where email = \u0026#39;sharryms@edublogs.org\u0026#39; and `level` = 59; +----+-------------+---------+------------+------+---------------+------+---------+------+--------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+---------------+------+---------+------+--------+----------+-------------+ | 1 | SIMPLE | student | NULL | ALL | NULL | NULL | NULL | NULL | 298708 | 1.00 | Using where | +----+-------------+---------+------------+------+---------------+------+---------+------+--------+----------+-------------+ 1 row in set, 1 warning (0.01 sec) mysql\u0026gt; explain select * from student where `level` = 59 and email = \u0026#39;sharryms@edublogs.org\u0026#39;; +----+-------------+---------+------------+------+---------------+------+---------+------+--------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+---------------+------+---------+------+--------+----------+-------------+ | 1 | SIMPLE | student | NULL | ALL | NULL | NULL | NULL | NULL | 298708 | 1.00 | Using where | +----+-------------+---------+------------+------+---------------+------+---------+------+--------+----------+-------------+ 1 row in set, 1 warning (0.00 sec) å½“è¡¨ student çš„äºŒçº§ç´¢å¼•åªæœ‰ (email) å’Œ (level)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 mysql\u0026gt; show index from student; +---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+ | Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression | +---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+ | student | 0 | PRIMARY | 1 | id | A | 204700 | NULL | NULL | | BTREE | | | YES | NULL | | student | 1 | email_k | 1 | email | A | 204700 | NULL | NULL | | BTREE | | | YES | NULL | | student | 1 | level_k | 1 | level | A | 101 | NULL | NULL | | BTREE | | | YES | NULL | +---------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+ 3 rows in set (0.00 sec) mysql\u0026gt; explain select email, `level` from student where email = \u0026#39;sharryms@edublogs.org\u0026#39;; +----+-------------+---------+------------+------+---------------+---------+---------+-------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+---------------+---------+---------+-------+------+----------+-------+ | 1 | SIMPLE | student | NULL | ref | email_k | email_k | 202 | const | 1 | 100.00 | NULL | +----+-------------+---------+------------+------+---------------+---------+---------+-------+------+----------+-------+ 1 row in set, 1 warning (0.00 sec) mysql\u0026gt; explain select email, `level` from student where `level` = 59; +----+-------------+---------+------------+------+---------------+---------+---------+-------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+---------------+---------+---------+-------+------+----------+-------+ | 1 | SIMPLE | student | NULL | ref | level_k | level_k | 4 | const | 2936 | 100.00 | NULL | +----+-------------+---------+------------+------+---------------+---------+---------+-------+------+----------+-------+ 1 row in set, 1 warning (0.00 sec) mysql\u0026gt; explain select * from student where email = \u0026#39;sharryms@edublogs.org\u0026#39; and `level` = 59; +----+-------------+---------+------------+------+-----------------+---------+---------+-------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+-----------------+---------+---------+-------+------+----------+-------------+ | 1 | SIMPLE | student | NULL | ref | email_k,level_k | email_k | 202 | const | 1 | 5.00 | Using where | +----+-------------+---------+------------+------+-----------------+---------+---------+-------+------+----------+-------------+ 1 row in set, 1 warning (0.00 sec) mysql\u0026gt; explain select * from student where `level` = 59 and email = \u0026#39;sharryms@edublogs.org\u0026#39;; +----+-------------+---------+------------+------+-----------------+---------+---------+-------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+-----------------+---------+---------+-------+------+----------+-------------+ | 1 | SIMPLE | student | NULL | ref | email_k,level_k | email_k | 202 | const | 1 | 5.00 | Using where | +----+-------------+---------+------------+------+-----------------+---------+---------+-------+------+----------+-------------+ 1 row in set, 1 warning (0.00 sec) å½“è¡¨ student çš„äºŒçº§ç´¢å¼•åªæœ‰ (email, level)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 mysql\u0026gt; show index from student; +---------+------------+---------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+ | Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression | +---------+------------+---------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+ | student | 0 | PRIMARY | 1 | id | A | 204700 | NULL | NULL | | BTREE | | | YES | NULL | | student | 1 | email_level_k | 1 | email | A | 298708 | NULL | NULL | | BTREE | | | YES | NULL | | student | 1 | email_level_k | 2 | level | A | 298708 | NULL | NULL | | BTREE | | | YES | NULL | +---------+------------+---------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+ 3 rows in set (0.00 sec) mysql\u0026gt; explain select email, `level` from student where email = \u0026#39;sharryms@edublogs.org\u0026#39;; +----+-------------+---------+------------+------+---------------+---------------+---------+-------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+---------------+---------------+---------+-------+------+----------+-------------+ | 1 | SIMPLE | student | NULL | ref | email_level_k | email_level_k | 202 | const | 1 | 100.00 | Using index | +----+-------------+---------+------------+------+---------------+---------------+---------+-------+------+----------+-------------+ 1 row in set, 1 warning (0.01 sec) mysql\u0026gt; explain select email, `level` from student where `level` = 59; +----+-------------+---------+------------+-------+---------------+---------------+---------+------+--------+----------+--------------------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+-------+---------------+---------------+---------+------+--------+----------+--------------------------+ | 1 | SIMPLE | student | NULL | index | email_level_k | email_level_k | 206 | NULL | 298708 | 10.00 | Using where; Using index | +----+-------------+---------+------------+-------+---------------+---------------+---------+------+--------+----------+--------------------------+ 1 row in set, 1 warning (0.00 sec) mysql\u0026gt; explain select * from student where email = \u0026#39;sharryms@edublogs.org\u0026#39; and `level` = 59; +----+-------------+---------+------------+------+---------------+---------------+---------+-------------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+---------------+---------------+---------+-------------+------+----------+-------+ | 1 | SIMPLE | student | NULL | ref | email_level_k | email_level_k | 206 | const,const | 1 | 100.00 | NULL | +----+-------------+---------+------------+------+---------------+---------------+---------+-------------+------+----------+-------+ 1 row in set, 1 warning (0.00 sec) mysql\u0026gt; explain select * from student where `level` = 59 and email = \u0026#39;sharryms@edublogs.org\u0026#39;; +----+-------------+---------+------------+------+---------------+---------------+---------+-------------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+---------------+---------------+---------+-------------+------+----------+-------+ | 1 | SIMPLE | student | NULL | ref | email_level_k | email_level_k | 206 | const,const | 1 | 100.00 | NULL | +----+-------------+---------+------------+------+---------------+---------------+---------+-------------+------+----------+-------+ 1 row in set, 1 warning (0.00 sec) å½“è¡¨ student çš„äºŒçº§ç´¢å¼•åªæœ‰ (email, level) å’Œ (level)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 mysql\u0026gt; show index from student; +---------+------------+---------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+ | Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression | +---------+------------+---------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+ | student | 0 | PRIMARY | 1 | id | A | 204700 | NULL | NULL | | BTREE | | | YES | NULL | | student | 1 | email_level_k | 1 | email | A | 298708 | NULL | NULL | | BTREE | | | YES | NULL | | student | 1 | email_level_k | 2 | level | A | 298708 | NULL | NULL | | BTREE | | | YES | NULL | | student | 1 | level_k | 1 | level | A | 101 | NULL | NULL | | BTREE | | | YES | NULL | +---------+------------+---------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+ 4 rows in set (0.00 sec) mysql\u0026gt; explain select email, `level` from student where email = \u0026#39;sharryms@edublogs.org\u0026#39;; +----+-------------+---------+------------+------+---------------+---------------+---------+-------+------+----------+-------------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+---------------+---------------+---------+-------+------+----------+-------------+ | 1 | SIMPLE | student | NULL | ref | email_level_k | email_level_k | 202 | const | 1 | 100.00 | Using index | +----+-------------+---------+------------+------+---------------+---------------+---------+-------+------+----------+-------------+ 1 row in set, 1 warning (0.02 sec) mysql\u0026gt; explain select email, `level` from student where `level` = 59; +----+-------------+---------+------------+------+-----------------------+---------+---------+-------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+-----------------------+---------+---------+-------+------+----------+-------+ | 1 | SIMPLE | student | NULL | ref | email_level_k,level_k | level_k | 4 | const | 2936 | 100.00 | NULL | +----+-------------+---------+------------+------+-----------------------+---------+---------+-------+------+----------+-------+ 1 row in set, 1 warning (0.01 sec) mysql\u0026gt; explain select * from student where email = \u0026#39;sharryms@edublogs.org\u0026#39; and `level` = 59; +----+-------------+---------+------------+------+-----------------------+---------------+---------+-------------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+-----------------------+---------------+---------+-------------+------+----------+-------+ | 1 | SIMPLE | student | NULL | ref | email_level_k,level_k | email_level_k | 206 | const,const | 1 | 100.00 | NULL | +----+-------------+---------+------------+------+-----------------------+---------------+---------+-------------+------+----------+-------+ 1 row in set, 1 warning (0.00 sec) mysql\u0026gt; explain select * from student where `level` = 59 and email = \u0026#39;sharryms@edublogs.org\u0026#39;; +----+-------------+---------+------------+------+-----------------------+---------------+---------+-------------+------+----------+-------+ | id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra | +----+-------------+---------+------------+------+-----------------------+---------------+---------+-------------+------+----------+-------+ | 1 | SIMPLE | student | NULL | ref | email_level_k,level_k | email_level_k | 206 | const,const | 1 | 100.00 | NULL | +----+-------------+---------+------------+------+-----------------------+---------------+---------+-------------+------+----------+-------+ 1 row in set, 1 warning (0.00 sec) æœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒ How MySQL Uses Indexes\nDiagrams for InnoDB data structures and behaviors\n","date":"2022-03-15T15:48:42+08:00","permalink":"https://h2cone.github.io/2022/03/15/mysql-index/","title":"é‡æ–°è®¤è¯† MySQLï¼ˆä¸€ï¼‰"},{"content":"å‰è¨€ ä¸ä¹…å‰å‚ä¸äº†åŸºäºç¼–æ’å¼•æ“çš„åº”ç”¨ç¨‹åºå¼€å‘ï¼Œåœ¨å¹¶å‘æ‰§è¡Œå¤§é‡çš„çŸ­æ—¶ä»»åŠ¡æ—¶å‘ç°å·¥ä½œæµå½“ä¸­ä»»åŠ¡ä¹‹é—´çš„å»¶è¿Ÿå¯èƒ½è¿œå¤§äºä»»åŠ¡æ‰§è¡Œè€—æ—¶ã€‚ç¿»é˜…å®˜æ–¹æ–‡æ¡£æ—¶å‘ç°æ­¤ç¼–æ’å¼•æ“ä»¥â€œæ•°æ®åº“è¿æ¥é¥¥æ¸´â€è‘—ç§°ï¼Œè­¦å‘Šé“ï¼šå¯¹äº MySQL æ¥è¯´é€šå¸¸ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºå®ƒå¤„ç†è¿æ¥çš„æ¨¡å‹æ˜¯åŸºäºçº¿ç¨‹çš„ï¼Œä½†è¿™å¯¹äº PostgreSQL å¯èƒ½æ˜¯ä¸ªé—®é¢˜ï¼Œå› ä¸ºå®ƒçš„è¿æ¥å¤„ç†æ˜¯åŸºäºè¿›ç¨‹çš„ã€‚\næ›¾ç»è¯¯ä»¥ä¸ºç¼–æ’å¼•æ“æˆ–æ•°æ®åº“æŒæœ‰è¿æ¥æ± ï¼Œä¸€æ–¹é¢ç”±äºå¯¹è¿æ¥æ± çš„åˆå°è±¡æ¥è‡ªäºå®¢æˆ·ç«¯ JDBC è¿æ¥æ± ï¼Œå¦ä¸€æ–¹é¢æ˜¯ç”±äºå¯¹äº MySQL è¿æ¥å™¨çš„è¯¯è§£ã€‚\nå°†è¿æ¥æ± åŠ å…¥åˆ°ç³»ç»Ÿï¼Œéšåæµ‹è¯•å‘ç°å¹¶å‘æ‰§è¡Œä»»åŠ¡çš„æ€§èƒ½æ˜¾è‘—æé«˜ï¼Œå¾ˆéš¾ä¸å¯¹è¿æ¥æ± åˆ®ç›®ç›¸çœ‹ã€‚\nè¿›ç¨‹ï¼Œè¿˜æ˜¯çº¿ç¨‹ The Internals of PostgreSQL å±•ç¤ºäº† PostgreSQL/Postgres å¤šè¿›ç¨‹æ¶æ„ï¼š\nä¸€ä¸ªå®¢æˆ·ç«¯ï¼ˆclientï¼‰çš„è¿æ¥è¯·æ±‚ç”±æœåŠ¡è¿›ç¨‹ï¼ˆserver processï¼‰åˆ†æ´¾ç»™ä¸€ä¸ªåå°è¿›ç¨‹ï¼ˆbackend processï¼‰å¤„ç†ï¼Œåå°è¿›ç¨‹ä»æœåŠ¡è¿›ç¨‹è¡ç”Ÿï¼ˆforkï¼‰è€Œæ¥ã€‚\nç³»ç»Ÿè°ƒç”¨ fork ç”¨äºåˆ›å»ºè¿›ç¨‹ï¼Œæ­¤å¤„å¼•ç”¨ The fork() System Call çš„å›¾æ¥ç®€å•è®¤è¯†ä¸€ä¸‹ï¼š\nä¼—æ‰€å‘¨çŸ¥ï¼Œåˆ›å»ºè¿›ç¨‹çš„å¼€é”€é€šå¸¸å¤§äºåˆ›å»ºçº¿ç¨‹ã€‚Postgres ä¸ºä»€ä¹ˆä½¿ç”¨å¤šè¿›ç¨‹æ¶æ„ï¼Ÿåœ¨é¥è¿œçš„è¿‡å»ï¼Œçº¿ç¨‹æ¨¡å‹åœ¨ Unix ä¸Šå¹¶ä¸æˆç†Ÿï¼Œç¬¬ä¸€ä¸ª Postgres å¼€å‘è€…å¯èƒ½è®¤ä¸ºè¿›ç¨‹æ˜¯æ¯”çº¿ç¨‹æ›´å®‰å…¨ã€å¥å£®ã€ç¨³å®šçš„é€‰æ‹©ã€‚\nè¿›ç¨‹ä¹‹é—´çš„éš”ç¦»æ€§å¼ºäºçº¿ç¨‹ä¹‹é—´çš„éš”ç¦»æ€§ï¼Œä¸€ä¸ªè¿›ç¨‹çš„å´©æºƒé€šå¸¸ä¸ä¼šå½±å“å…¶å®ƒè¿›ç¨‹ã€‚\nåœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸Šï¼Œåˆ›å»ºè¿›ç¨‹ä¸åˆ›å»ºçº¿ç¨‹ä¹‹é—´çš„å¼€é”€å·®å¼‚æ¯”ä»¥å‰å°å¾—å¤šã€‚\nå½“äº‹åŠ¡éå¸¸çŸ­çš„æ—¶å€™ï¼Œåˆ›å»ºè¿›ç¨‹çš„æˆæœ¬æ˜¯å¦çœŸçš„å¯ä»¥å¿½ç•¥ä¸è®¡ï¼ŸWhat is the point of bouncing çš„ä½œè€…æµ‹é‡äº†å»ºç«‹è¿æ¥çš„è€—æ—¶ï¼š\nè¿™æ„å‘³ç€ç”¨â€œä¿¡ä»»â€è¿æ¥åˆ° localhost å¹³å‡éœ€è¦ 0.045msï¼Œç”¨ MD5 è®¤è¯åˆ™éœ€è¦ 0.063msã€‚åœ¨ç½‘ç»œä¸Šï¼Œå®ƒéœ€è¦ 0.532msï¼ˆä¿¡ä»»ï¼‰å’Œ 0.745msï¼ˆmd5ï¼‰ã€‚è¿™å¬èµ·æ¥å¯èƒ½ä¸å¤šï¼Œä½†è€ƒè™‘åˆ°ä»ç›¸å¯¹è¾ƒå®½çš„è¡¨ä¸­è·å–å•è¡Œï¼ˆå®½åº¦ï¼Œå¦‚è§£é‡Šæ‰€ç¤ºï¼š750 å­—èŠ‚ï¼‰ï¼Œä½¿ç”¨ä¸»é”®éœ€è¦ 0.03msï¼Œæˆ‘ä»¬çªç„¶å¯ä»¥çœ‹åˆ°è¿æ¥çš„å¼€é”€æ¯”ä»ç£ç›˜è·å–æ•°æ®è¦å¤š 20 å€ã€‚\nè¿æ¥æ± æ˜¯å¦å¯ä»¥å‡å°‘é¢‘ç¹åˆ›å»ºè¿›ç¨‹çš„æˆæœ¬ï¼ŸScaling PostgreSQL with PgBouncer: You May Need a Connection Pooler çš„æµ‹è¯•ç»“æœä¸€ç›®äº†ç„¶ï¼š\nä¸Šå›¾æ˜¯ç›´è¿ Postgres ä¸ä½¿ç”¨ PgBouncer ä½œä¸ºè¿æ¥æ± ä¹‹é—´çš„ TPS å¯¹æ¯”ï¼Œå¹¶å‘æ•°è¶…è¿‡æŸä¸€é˜ˆå€¼ä¹‹åï¼Œç›´è¿ Postgres çš„æ€§èƒ½å¤§å¹…ä¸‹é™ï¼Œè€Œä½¿ç”¨ PgBouncer ä½œä¸ºè¿æ¥æ± éå¸¸ç¨³å®šã€‚\né›†ä¸­ï¼Œè¿˜æ˜¯åˆ†æ•£ è¿æ¥æ± æ˜¯ç»´æŠ¤æ•°æ®åº“è¿æ¥çš„ç¼“å­˜ï¼Œä»¥ä¾¿å°†æ¥çš„æ–°è¯·æ±‚å¯ä»¥é‡ç”¨è¿æ¥ã€‚å¤šè·¯å¤ç”¨æ˜¯çº¿ç¨‹æ± çš„æ ¸å¿ƒæ–¹æ³•ä¹‹ä¸€ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿè¿æ¥ï¼ˆvirtual connectionï¼‰æ•°ä¸ç‰©ç†è¿æ¥ï¼ˆphysical connectionï¼‰æ•°ä¹‹æ¯”å¤§äº 1ã€‚\nPgBouncer å¹¶éæ˜¯å®¢æˆ·ç«¯è¿æ¥æ± ï¼Œè€Œæ˜¯æ˜¯é›†ä¸­å¼çš„è¿æ¥æ± ï¼Œå¤„äºå®¢æˆ·ç«¯ä¸æ•°æ®åº“çš„ä¸­é—´å±‚ï¼Œå®é™…ä¸Š PgBouncer æ˜¯å•çº¿ç¨‹è¿›ç¨‹ã€‚æŠŠå®¢æˆ·ç«¯ä¸ PgBouncer çš„è¿æ¥ç§°ä¸ºå®¢æˆ·ç«¯è¿æ¥ï¼ˆclient connectionï¼‰ï¼Œå†æŠŠ PgBouncer ä¸ Postgres çš„è¿æ¥ç§°ä¸ºæœåŠ¡ç«¯è¿æ¥ï¼ˆserver connectionï¼‰ï¼Œä»æ‰“å¼€è¿æ¥åˆ°å…³é—­è¿æ¥çš„è¿‡ç¨‹çœ‹èµ·æ¥åƒè¿™æ ·å­ï¼š\nå®¢æˆ·ç«¯è¿æ¥ PgBouncerï¼Œå»ºç«‹å®¢æˆ·ç«¯è¿æ¥ï¼ˆè®¤è¯ä¸æˆæƒï¼‰ã€‚\nPgBouncer é€šè¿‡ç”¨æˆ·åä¸æ•°æ®åº“åä»æ± è·å–ç©ºé—²çš„æœåŠ¡ç«¯è¿æ¥ï¼ˆè‹¥æ²¡æœ‰åˆ™åˆ›å»ºï¼‰ï¼Œéšåå°†æœåŠ¡ç«¯è¿æ¥åˆ†é…ç»™å®¢æˆ·ç«¯è¿æ¥ã€‚\nå®¢æˆ·ç«¯è¿æ¥ä¸æœåŠ¡ç«¯è¿æ¥é…å¯¹å®Œæˆä¹‹åï¼Œå®¢æˆ·ç«¯é—´æ¥è¿æ¥äº† Postgresï¼ˆä¸­é—´ä»¶ä»£ç†ï¼‰ã€‚\nå®¢æˆ·ç«¯è¿æ¥æ–­å¼€æ—¶ï¼ŒPgBouncer ä¸ä¼šå…³é—­æœåŠ¡ç«¯è¿æ¥ï¼Œè€Œæ˜¯å°†æœåŠ¡ç«¯è¿æ¥é‡Šæ”¾åˆ°æ± ã€‚\nåœ¨ä½¿ç”¨ PgBouncer ä¹‹å‰ï¼Œæˆ‘é‡åˆ°çš„åœºæ™¯ä¹‹ä¸€æ˜¯æ¯ä¸ªå®¢æˆ·ç«¯å±äºè¿›ç¨‹ï¼Œå‡ ä¹åŒæ—¶è¯·æ±‚ Postgresï¼ŒPostgres åˆ›å»ºå¤§é‡åå°è¿›ç¨‹ï¼Œå³ä½¿è¿™äº›å®¢æˆ·ç«¯è¿è¡Œæ—¶ç»´æŠ¤ç€å„è‡ªçš„å†…åµŒè¿æ¥æ± ï¼Œåœ¨è¿‡å¤šå®¢æˆ·ç«¯æƒ…å†µä¸‹ï¼Œåˆ†æ•£å¼æ¯”é›†ä¸­å¼æ± æ˜‚è´µã€‚åˆ†æ•£å¼é¢å‘çš„æ˜¯çº¿ç¨‹ï¼Œè€Œé›†ä¸­å¼é¢å‘çš„æ˜¯è¿›ç¨‹ï¼Œå‰è€…ç”±äºä¾èµ–åº“æˆ–æ¡†æ¶ï¼Œæœ‰ä¸€å®šçš„ä¾µå…¥æ€§ä¸”æ— é›†ä¸­æ§åˆ¶ï¼Œåè€…å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œæ–°å¢äº†ä¸€æ®µå»¶è¿Ÿï¼ˆç»è¿‡ä¸­é—´å±‚ï¼‰ã€å•ç‚¹å¤±æ•ˆã€å¯æ‰©å±•æ€§ç­‰é—®é¢˜ã€‚\nPgBouncer é…ç½® PgBouncer æœ‰ä¸‰ç§æ¨¡å¼ï¼ˆpool_modeï¼‰æŒ‡å®šæœåŠ¡ç«¯è¿æ¥ä½•æ—¶å¯ä»¥è¢«å…¶å®ƒå®¢æˆ·ç«¯é‡ç”¨ã€‚\nsessionã€‚å®¢æˆ·ç«¯æ–­å¼€è¿æ¥åï¼ˆå…³é—­ä¼šè¯åï¼‰ï¼ŒæœåŠ¡ç«¯è¿æ¥è¢«é‡Šæ”¾å›æ± ã€‚\ntransactionã€‚äº‹åŠ¡å®Œæˆä¹‹åï¼ˆå›æ»šæˆ–è€…æäº¤æ‰§è¡Œåï¼‰ï¼ŒæœåŠ¡ç«¯è¿æ¥è¢«é‡Šæ”¾å›æ± ã€‚ä¸èƒ½ä¿è¯åœ¨åŒä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ä¸Šè¿è¡Œçš„ä¸¤ä¸ªäº‹åŠ¡å°†åœ¨åŒä¸€ä¸ªæœåŠ¡ç«¯è¿æ¥ä¸Šè¿è¡Œã€‚\nstatementã€‚è¯­å¥æ‰§è¡Œå®Œæˆåï¼ŒæœåŠ¡ç«¯è¿æ¥è¢«é‡Šæ”¾å›æ± ã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ä¸å…è®¸å¤šè¯­å¥äº‹åŠ¡ã€‚\nç”±äºé‚£ä¸ªç¼–æ’å¼•æ“çš„æ‰€æœ‰å·¥ä½œè¿›ç¨‹ä¾èµ– SQLAlchemy ä¸ Postgres é€šä¿¡ï¼Œå®¢æˆ·ç«¯è¿æ¥æœ‰ä¸å®¹å¿½è§†çš„ç”Ÿå‘½å‘¨æœŸï¼ˆpool_recycleï¼‰ï¼Œä¸æ­¢æ‰§è¡Œæµç¨‹ç»“ç‚¹ä»»åŠ¡çš„å­è¿›ç¨‹ï¼Œå…¶å®ƒå­è¿›ç¨‹ä¹Ÿéœ€è¦æŒç»­ä¿æŒè¿æ¥ä»è€Œåšå…¶å®ƒäº‹æƒ…ï¼Œæ‰€ä»¥æœ€ä½³é€‰æ‹©æ˜¯ transactionã€‚\né™¤äº† pool_mode ä»¥å¤–ï¼Œåœ¨æ€§èƒ½è°ƒä¼˜æ—¶å€¼å¾—æ³¨æ„çš„é…ç½®é¡¹ï¼š\ndefault_pool_sizeã€‚æ¯å¯¹ï¼ˆç”¨æˆ·åï¼Œæ•°æ®åº“ï¼‰å…è®¸å¤šå°‘ä¸ªæœåŠ¡ç«¯è¿æ¥ã€‚ max_client_connã€‚å…è®¸çš„æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°ã€‚ è¯¦æƒ…è¯·å‚è€ƒ PgBouncer Configã€‚\nè¿æ¥æ± ä¸çº¿ç¨‹æ±  è¿æ¥æ± ä¸æ˜¯ã€ä¸å±äºçº¿ç¨‹æ± ï¼Œä¸¤è€…èŒè´£åˆ†ç¦»ã€‚ä»¥ MySQL ä¸ºä¾‹ï¼ŒMySQL å®¢æˆ·ç«¯è¿æ¥æ± è™½ç„¶å¯ä»¥å‡å°‘é¢‘ç¹å»ºç«‹æˆ–æ‹†æ¯è¿æ¥çš„å¼€é”€ï¼Œä½†æ˜¯å´å¯¹ MySQL æœåŠ¡ç«¯çš„æŸ¥è¯¢å¤„ç†èƒ½åŠ›æˆ–è´Ÿè½½ä¸€æ— æ‰€çŸ¥ï¼›ç›¸æ¯”ä¹‹ä¸‹ï¼ŒMySQL æœåŠ¡ç«¯çº¿ç¨‹æ± ç®¡ç†ç€æ¥å—å…¥ç«™å¹¶å‘è¿æ¥å’Œäº‹åŠ¡æ‰§è¡Œçš„ä¸€ç³»åˆ—çº¿ç¨‹ã€‚\næ—§æ–‡å·²ä»‹ç» Java çº¿ç¨‹æ± ï¼Œéƒ¨åˆ†å¯ç±»æ¯”ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒ Wiki # database connection\nPostgreSQL Connection Pooling: Part 1 â€“ Pros \u0026amp; Cons\nä¸ºä»€ä¹ˆ MySQL ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œè€Œ Oracle å’Œ PostgreSQL ä½¿ç”¨å¤šè¿›ç¨‹ï¼Ÿ\nçº¿ç¨‹å´©æºƒæ˜¯å¦ä¼šé€ æˆè¿›ç¨‹å´©æºƒï¼Ÿ\nPostgreSQL Connection Pooling: Part 2 â€“ PgBouncer\nWhat is the purpose of session pool_mode in pgbouncer?\nManaging High Availability in PostgreSQL â€“ Part III: Patroni\nPgbounceræœ€ä½³å®è·µ ä¹‹ æ€§èƒ½æå‡ç¯‡\nA.15 MySQL 8.0 FAQ: MySQL Enterprise Thread Pool\nScaling the GitLab database\n","date":"2022-01-16T23:30:47+08:00","permalink":"https://h2cone.github.io/2022/01/16/connection-pool-0/","title":"è¿æ¥æ± çš„æ„ä¹‰"},{"content":"é‡è¦çš„äº‹æƒ… ä¸æ˜¯å¯¹è®ºæ–‡çš„é˜…è¯»ç†è§£ï¼Œè€Œæ˜¯å—åˆ°äº†åŠ¨ç”»çš„å¯å‘ã€‚\nå¯å‘å¼é—®é¢˜ å…±è¯†æ˜¯ä»€ä¹ˆï¼Ÿå…±è¯†ç®—æ³•çš„åº”ç”¨åœºæ™¯ï¼Ÿ\nå…±è¯†æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿæœ€é‡è¦çš„æŠ½è±¡ä¹‹ä¸€ï¼Œè‘—åçš„ã€ŠDesigning Data-Intensive Applicationsã€‹å±•ç¤ºäº†å…¨æ™¯å¼çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå…¶ä¸­æœ‰ä¸€å¤§ç« æ¢è®¨ä¸€è‡´æ€§ä¸å…±è¯†çš„å†…å®¹ã€‚\nå…±è¯†é—®é¢˜é€šå¸¸å½¢å¼åŒ–æè¿°å¦‚ä¸‹ï¼šä¸€ä¸ªæˆ–å¤šä¸ªç»“ç‚¹å¯ä»¥æè®®æŸäº›å€¼ï¼Œç”±å…±è¯†ç®—æ³•æ¥å†³å®šæœ€ç»ˆå€¼ã€‚\nâ€œé€šä¿—ç†è§£ï¼Œå…±è¯†æ˜¯è®©å‡ ä¸ªç»“ç‚¹å°±æŸé¡¹æè®®è¾¾æˆä¸€è‡´ã€‚ä¾‹å¦‚ï¼Œå¤šä¸ªäººåŒæ—¶å°è¯•é¢„è®¢é£æœºçš„æœ€åä¸€ä¸ªåº§ä½æˆ–å‰§é™¢ä¸­çš„åŒä¸€åº§ä½ï¼Œæˆ–è€…å°è¯•ä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·åæ³¨å†Œè´¦æˆ·ï¼Œæ­¤æ—¶å¯ä»¥ç”¨å…±è¯†ç®—æ³•æ¥å†³å®šè¿™äº›ä¸ç›¸å®¹çš„æ“ä½œä¹‹ä¸­è°æ˜¯è·èƒœè€…ã€‚â€\nå¯¹äºæœ¬åœ°æˆ–å…±äº«å†…å­˜çš„å”¯ä¸€æ€§é—®é¢˜ï¼Œç›´æˆªäº†å½“çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨é”ï¼Œä½†åˆ°äº†åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¤æ‚åº¦éª¤ç„¶ä¸Šå‡ï¼Œå…±è¯†å¯èƒ½æ˜¯å”¯ä¸€å¯é çš„æ–¹æ³•ã€‚ä¸æ­¢äºæ­¤ï¼Œå…±è¯†ç®—æ³•å¯ä»¥åº”ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€ç³»åˆ—é—®é¢˜ï¼š\nå¯çº¿æ€§åŒ–çš„æ¯”è¾ƒï¼è®¾ç½®å¯„å­˜å™¨ã€‚å¯„å­˜å™¨éœ€è¦æ ¹æ®å½“å‰å€¼æ˜¯å¦ç­‰äºè¾“å…¥çš„å‚æ•°ï¼Œæ¥è‡ªåŠ¨å†³å®šæ¥ä¸‹æ¥æ˜¯å¦åº”è¯¥è®¾ç½®æ–°å€¼ã€‚\nåŸå­äº‹åŠ¡æäº¤ã€‚æ•°æ®åº“éœ€è¦å†³å®šæ˜¯å¦æäº¤æˆ–ä¸­æ­¢åˆ†å¸ƒå¼äº‹åŠ¡ã€‚\nå…¨åºå¹¿æ’­ã€‚æ¶ˆæ¯ç³»ç»Ÿè¦å†³å®šä»¥ä½•ç§é¡ºåºå‘é€æ¶ˆæ¯ã€‚\né”ä¸ç§Ÿçº¦ã€‚å½“å¤šä¸ªå®¢æˆ·ç«¯äº‰æŠ¢é”æˆ–ç§Ÿçº¦æ—¶ï¼Œè¦å†³å®šå…¶ä¸­å“ªä¸€ä¸ªæˆåŠŸã€‚\næˆå‘˜/åè°ƒæœåŠ¡ã€‚å¯¹äºå¤±è´¥æ£€æµ‹å™¨ï¼ˆä¾‹å¦‚è¶…æ—¶æœºåˆ¶ï¼‰ï¼Œç³»ç»Ÿè¦å†³å®šç»“ç‚¹çš„å­˜æ´»çŠ¶æ€ï¼ˆä¾‹å¦‚åŸºäºä¼šè¯è¶…æ—¶ï¼‰ã€‚\nå”¯ä¸€æ€§çº¦æŸã€‚å½“å¤šä¸ªäº‹åŠ¡åœ¨ç›¸åŒçš„ä¸»é”®ä¸Šè¯•å›¾äº•å‘åˆ›å»ºå†²çªèµ„æºæ—¶ï¼Œçº¦æŸæ¡ä»¶è¦å†³å®šå“ªä¸€ä¸ªè¢«å…è®¸ï¼Œå“ªäº›è¿åçº¦æŸå› è€Œå¿…é¡»å¤±è´¥ã€‚\nRaft å¯èƒ½æ˜¯æœ€æ˜“äºç†è§£çš„å…±è¯†ç®—æ³•ï¼Œæ ‡æ†å¼çš„å®ç°æ˜¯ etcd/raftï¼Œå…¶å®ƒçš„å®ç°å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚\nä¸ºä»€ä¹ˆéœ€è¦ Leader æˆ– Primary æˆ– Master è¿™ç±»è§’è‰²çš„é€‰ä¸¾ï¼Ÿ\nå‘å®¢æˆ·ç«¯åˆ¶é€ äº†å•ä¸€æœåŠ¡ç«¯ç‚¹çš„å‡è±¡ï¼Œå®¢æˆ·ç«¯ä¸ç³»ç»Ÿçš„é€šä¿¡ç®€åŒ–ä¸ºä¸å•ä¸€æœåŠ¡ç«¯çš„é€šä¿¡ã€‚\næœ‰ä¸€ç§æ— ä¸»ç»“ç‚¹æ•°æ®å¤åˆ¶ï¼ˆleaderless replicationï¼‰å£°ç§°ï¼Œå¦‚æœ w + r \u0026gt; nï¼Œåˆ™è¯»å†™çš„ç»“ç‚¹ä¸­ä¸€å®šåŒ…å«æœ€æ–°å€¼ï¼ˆn æ˜¯å‰¯æœ¬æ•°ï¼Œå†™å…¥éœ€è¦ w ä¸ªç»“ç‚¹ç¡®è®¤ï¼Œè¯»å–å¿…é¡»è‡³å°‘æŸ¥è¯¢ r ä¸ªç»“ç‚¹ï¼‰ã€‚å¦‚æœå†™å…¥äº† w ä¸ªç»“ç‚¹ï¼Œåˆ™éœ€è¦è¯»å–å¤šäº n - w ä¸ªç»“ç‚¹ä¿è¯åŒ…å«æœ€æ–°å€¼ï¼ˆæƒ³è±¡ä¸€ä¸‹ w ä¸ªç»“ç‚¹ä¸ r ä¸ªç»“ç‚¹æœ‰é‡å ï¼‰ï¼Œå› æ­¤ r \u0026gt; n - w -\u0026gt; r + w \u0026gt; nï¼Œè¿™è¢«ç§°ä¸º Quorumï¼Œä½†ç°å®æƒ…å†µå¾€å¾€æ›´åŠ å¤æ‚ï¼Œä¸ä¿è¯ä¸€å®šèƒ½è¯»å–åˆ°æœ€æ–°å€¼ã€‚\nä¸ºå•ä¸€ Leader ç¼–å†™ç¨‹åºå¯èƒ½æ¯”é‡‡ç”¨ Quorum ç­‰å…¶å®ƒæ–¹æ³•æ›´å®¹æ˜“ï¼Œä½†æ˜¯åŠ£åŠ¿ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œä¾‹å¦‚å•ç‚¹å¤±æ•ˆå‘ç”Ÿåœ¨å”¯ä¸€çš„ Leader èº«ä¸Šï¼Œé‚£æ¢å¤æœŸé—´æœåŠ¡ä¸å¯ç”¨ï¼Ÿå®¢æˆ·ç«¯å¯ä»¥é‡è¯•ï¼Œç›´åˆ°ä¸€åæ–°çš„ Leader è¢«é€‰ä¸¾å‡ºæ¥ï¼›æ›´ä¸¥é‡çš„ç¼ºé™·æ˜¯å”¯ä¸€çš„ Leader è´Ÿè½½è¿‡é«˜æ—¶ï¼Œä¼šæˆä¸ºäº†ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚æ—©æœ‰è€³é—» TiKV æ˜¯åŸºäº Raft çš„åˆ†å¸ƒå¼é”®å€¼å¯¹æ•°æ®åº“ï¼Œå…¶æ‰©å±•æ–¹å¼æ˜¯é€šè¿‡æ•°æ®åˆ†åŒºä¸ Raft ç»„ï¼ˆraft groupï¼‰ã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ•°æ®åˆ†å¸ƒåˆ° 3 ä¸ªåˆ†åŒºï¼ˆRegionï¼‰ï¼Œæ¯ä¸ªåˆ†åŒºé€šè¿‡ Raft çš„æ•°æ®å¤åˆ¶æ–¹æ³•å¾—åˆ° 3 ä¸ªæ•°æ®å‰¯æœ¬ï¼ˆ1 Leader + 2 followerï¼‰ï¼Œè™½ç„¶ Raft ç»„ä¹‹é—´å¹¶æ— ä¸€è‡´æ€§çš„è¦æ±‚ï¼Œä½†æ˜¯ä¼˜åŠ¿å·²ç»éå¸¸æ˜æ˜¾çš„äº†ã€‚\nFollower ä½•æ—¶è½¬ä¸º Candidateï¼ŸCandidate ä½•æ—¶è½¬ä¸º Leaderï¼ŸLeader ä½•æ—¶è½¬ä¸º Followerï¼Ÿ\nRaft é›†ç¾¤ä¸­çš„ Server å¯ä»¥æ˜¯ Leaderï¼Œä¹Ÿå¯ä»¥æ˜¯ Followerï¼Œè¿˜å¯ä»¥æ˜¯é€‰ä¸¾ä¸­ï¼ˆLeader ä¸å¯ç”¨æ—¶ï¼‰çš„ Candidateã€‚Leader è´Ÿè´£å°†æ—¥å¿—å¤åˆ¶åˆ° Followersï¼ˆä¸€ç§æ•°æ®å¤åˆ¶æ–¹æ³•ï¼Œåä¸ºçŠ¶æ€æœºå¤åˆ¶ï¼‰ã€‚Leader é€šè¿‡å‘é€â€œå¿ƒè·³â€å®šæœŸé€šçŸ¥ Follower ä»¬å®ƒçš„å­˜åœ¨ã€‚æ¯ä¸ª Follower éƒ½æœ‰ä¸€ä¸ªå€’è®¡æ—¶ï¼ˆelection timeoutï¼‰ï¼Œæ¥æ”¶åˆ°â€œå¿ƒè·³â€æ—¶ï¼Œå°†é‡ç½®è¯¥å€’è®¡æ—¶ï¼Œè‹¥æ²¡æ¥æ”¶åˆ°ï¼Œåˆ™è½¬ä¸º Candidateï¼Œå¼€å§‹ Leader é€‰ä¸¾ã€‚\næ¯ä¸ª Server çš„ Election timeout ä¸åº”æ˜¯ç›¸ç­‰æˆ–è€…è¿‡äºç›¸è¿‘ï¼Œå¦åˆ™å®¹æ˜“å‡ºç°å¤šä¸ª Candidate åŒæ—¶è¯·æ±‚æŠ•ç¥¨çš„å±€é¢ï¼Œå¾ˆå¯èƒ½å‘ç”Ÿ Split voteã€‚\nä¸€æ—¦è·å¾—äº†å¤šæ•°ç¥¨ï¼ŒCandidate å°±èƒ½æå‡ä¸º Leaderï¼Œæ‰€è°“å¤šæ•°ï¼ˆmajorityï¼‰ç­‰äºç»“ç‚¹æ•°é‡é™¤ä»¥ 2 çš„ç»“æœå‘ä¸‹å–æ•´ï¼Œæ¯”å¦‚ 3 / 2 == 1ã€4 / 2 == 2ã€5 / 2 == 2ã€‚\nç»“ç‚¹ä¹‹é—´å¦‚ä½•é€šä¿¡ï¼Ÿå…è®¸ Candidates å¹¶å‘è¯·æ±‚æŠ•ç¥¨ï¼ˆrequest votesï¼‰ï¼Ÿç»“ç‚¹å¦‚ä½•å“åº”ï¼Ÿ\né€šå¸¸æ˜¯ RPCï¼ŒServer å¯å‘é€ä¸¤ç±»æ¶ˆæ¯ï¼Œä¸€æ˜¯ RequestVotesï¼ŒäºŒæ˜¯ AppendEntriesï¼Œåˆ†åˆ«ç”¨äº Leader é€‰ä¸¾ã€å¿ƒè·³ä¸æ—¥å¿—å¤åˆ¶ã€‚å½“ç„¶ï¼Œä½†æ˜¯æ¯ä¸ª Server åœ¨ä¸€ä¸ªæœŸæ•°ï¼ˆtermï¼‰æœ€å¤šåªèƒ½æŠ•ä¸€ç¥¨ï¼ŒCandidate ä¸€å®šä¼šæŠ•ç»™è‡ªå·±ä¸€ç¥¨ï¼Œæ¥æ”¶åˆ°æŠ•ç¥¨è¯·æ±‚çš„ Follower æœ€å¤šå›åº”ä¸€ç¥¨ã€‚Term æ˜¯å•è°ƒé€’å¢çš„æ•´æ•°å˜é‡ï¼Œåœ¨å¼€å§‹ Leader é€‰ä¸¾æ—¶é€’å¢ï¼Œæ¯ä¸ª Server éƒ½ç»´æŠ¤ç€å„è‡ªçš„ Termã€‚\nä¸€æ—¦å‘ç”Ÿäº† Split voteï¼Œç”±äºå¤šä¸ª Candidate éƒ½ä¸èƒ½è·å¾—å¤šæ•°ç¥¨ï¼ˆå‚è€ƒä¸Šå›¾ 4 ç»“ç‚¹çš„æƒ…æ™¯ï¼‰ï¼Œåªèƒ½é€’å¢ Termï¼Œå¼€å§‹æ–°çš„é€‰ä¸¾ã€‚ä¸ºäº†å¿«é€Ÿçš„é€‰å‡º Leader ä»¥æä¾›æœåŠ¡ï¼ŒElection timeout é€šå¸¸åœ¨ 150 åˆ° 300 æ¯«ç§’ä¹‹é—´ï¼Œæœ€å¥½è¿å¤§äºå¹¿æ’­æ—¶é—´ï¼ˆå‘ä¸€ç»„ç»“ç‚¹å‘é€è¯·æ±‚åˆ°æ¥æ”¶å“åº”çš„å¹³å‡æ—¶é—´ï¼‰ä¸”è¿œå°äº MTBFã€‚\nå¦‚ä½•è§£å†³è„‘è£‚ï¼Ÿ\nè™½ç„¶æŸä¸€ä»»æœŸæœ€å¤šåªæœ‰ä¸€ä½ Leaderï¼Œä½†æ˜¯ Raft é›†ç¾¤å¯èƒ½å› ä¸ºç½‘ç»œåˆ†åŒºï¼Œåˆ†è£‚æˆè‹¥å¹²å­é›†ç¾¤ã€‚\nä¸Šæ–‡åˆ†æå¯ä»¥çŸ¥é“ï¼Œå°‘æ•°æ´¾æ— æ³•é€‰ä¸¾å‡ºæ–° Leaderï¼Œåªæœ‰å¤šæ•°æ´¾åšå¾—åˆ°ã€‚ç½‘ç»œåˆ†åŒºä¿®å¤åï¼ŒTerm è¾ƒå¤§çš„ Leader ä¼šæŠŠ Term è¾ƒä½ çš„ Leader èµ¶ä¸‹å°ï¼ˆdiscovers server with higher termï¼‰ã€‚\nä¸ºä»€ä¹ˆéœ€è¦å¤åˆ¶æ—¥å¿—ï¼ˆreplicated logï¼‰ï¼Ÿ\næ—¥å¿—æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿæœ€é‡è¦çš„æŠ½è±¡ä¹‹ä¸€ã€‚å†™æ—¥å¿—ä¼˜å…ˆäºæ‰§è¡Œæ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤ï¼Œæ—¥å¿—å…ˆè¡ŒæŠ€æœ¯æœ‰ä¸å°‘ä¼˜åŠ¿ï¼Œä¸€æ˜¯è¿½åŠ å¼æ›´æ–°è¾ƒå¿«ï¼ŒäºŒæ˜¯é€‚åˆå¢é‡åŒæ­¥æ•°æ®ï¼Œä¸‰æ˜¯æ»¡è¶³æ•°æ®æ¢å¤ä¸å¼ºä¸€è‡´æ€§è¦æ±‚ã€‚\nä¸ºä»€ä¹ˆ Leader æ‰§è¡Œæ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤å‰å…ˆå†™æ—¥å¿—ï¼ŸLeader/Follower ä½•æ—¶æäº¤æ—¥å¿—æ¡ç›®ï¼Ÿåˆä½•æ—¶åº”ç”¨æ•°æ®å˜æ›´ï¼ˆæ‰§è¡Œå‘½ä»¤ï¼‰ï¼Ÿ\nå‡è®¾ä¸å†™æ—¥å¿—æˆ–è€…å…ˆæ‰§è¡Œä¸€ç³»åˆ—å‘½ä»¤ï¼Œå½“æŸäº›å‘½ä»¤æ‰§è¡Œå¤±è´¥äº†ï¼ˆæ²¡æœ‰çœŸæ­£æŒä¹…åŒ–è¿™ä»¶äº‹å®¢æˆ·ç«¯ä¸ä¸€å®šçŸ¥é“ï¼‰ï¼Œé‚£ç›¸å½“äºè¿™äº›å‘½ä»¤å½»åº•ä¸¢å¤±äº†ï¼›ç›¸åï¼Œå…ˆå†™æ—¥å¿—åæ‰§è¡Œå‘½ä»¤ï¼Œè‡³å°‘å¯èƒ½å‘ç”Ÿä¸€ä»¶å‘½ä»¤å·²å¤‡ä»½ï¼ˆæ—¥å¿—æ¡ç›®åŒ…å«å‘½ä»¤ï¼‰çš„äº‹ä»¶ï¼Œä¹Ÿå°±æ‹¥æœ‰äº†æ›´å¼ºçš„å®¹é”™æ€§ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå†™æ—¥å¿—å½“ç„¶ä¹Ÿå¯èƒ½å¤±è´¥ï¼Œé€€åŒ–æˆä¸æ‰§è¡Œæ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤ä¸€æ ·ï¼Œæç¤ºå®¢æˆ·ç«¯å¤±è´¥æˆ–é‡è¯•ã€‚\nå¦‚ä½•ä¿è¯ç»“ç‚¹ä¹‹é—´å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ï¼Ÿç»“ç‚¹æ•…éšœã€ç½‘ç»œåˆ†åŒºã€ä¸ä¸€è‡´æ—¶å¦‚ä½•æ¢å¤ï¼Ÿ\næœ‰äº›æ—¥å¿—æ¯”å¦ä¸€äº›æ—¥å¿—æ›´æ–°ï¼ˆmore up-to-dateï¼‰ã€‚Raft é€šè¿‡æ¯”è¾ƒæœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®æ¥å†³å®šå“ªä¸ª Server çš„æ—¥å¿—è¾ƒæ–°ã€‚\næœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ term ä¸ç­‰æ—¶ï¼Œterm è¶Šå¤§åˆ™è¶Šæ–°ã€‚\næœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ term ç›¸ç­‰æ—¶ï¼Œæ—¥å¿—è¶Šé•¿åˆ™è¶Šæ–°ã€‚\nå¯¹äº Server ä¹‹é—´çš„æ—¥å¿—å†²çªï¼ŒRaft å€¾å‘äºä¿®å¤è¾ƒæ—§çš„æ—¥å¿—ï¼Œä½¿å…¶ä¸è¾ƒæ–°çš„æ—¥å¿—ä¿æŒä¸€è‡´ã€‚\nåŸºäº Raft çš„ç³»ç»Ÿå¦‚ä½•ä¿è¯å¯é æ€§ï¼Ÿæ¢è¨€ä¹‹ï¼Œå¦‚ä½•å®¹é”™ï¼ˆå¯ç”¨æ€§ä¸ä¸€è‡´æ€§ï¼‰ï¼Ÿä¾‹å¦‚ç»“ç‚¹æ•…éšœã€ç½‘ç»œåˆ†åŒºç­‰ã€‚\né™¤äº†æ—¥å¿—ä¸€è‡´æ€§ã€Raft ç»„ã€æœ€ä½³çš„ Election timeoutï¼Œå¦‚æœ Follower å´©æºƒäº†ï¼Œè™½ç„¶å…¶å®ƒ Server å‘é€æ¶ˆæ¯ç»™ Follower å¤±è´¥äº†ï¼Œä½†æ˜¯ Server ä¼šé‡è¯•ï¼Œç›´åˆ° Follower ä¸Šçº¿åå›åº”ç¡®è®¤æ¶ˆæ¯ï¼›å¦‚æœè¯·æ±‚åœ¨å¤±è´¥ä¹‹å‰å·²ç»è¢«è€ƒè™‘ï¼Œé‡å¯çš„ Follower å°†å¿½ç•¥å®ƒã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒçš„é“¾æ¥ Raft Web Site\nTiKV # Multi-raft\n","date":"2021-10-17T19:00:17+08:00","permalink":"https://h2cone.github.io/2021/10/17/raft-0/","title":"æµ…è°ˆ Raft"},{"content":"åŸºäºå¤šæ€ å‡è®¾æœ‰ä¸€æ®µâ€œåˆ†æ”¯ä»£ç â€ï¼ˆç‰‡æ®µ 1ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 // å¯èƒ½çš„ Case CaseEnum caseEnum = getRandomCase(); if (CaseEnum.AA.equals(caseEnum)) { // ... } else if (CaseEnum.BB.equals(caseEnum)) { // ... } else if (CaseEnum.CC.equals(caseEnum)) { // ... } å…¶ç­‰æ•ˆä»£ç ç±»ä¼¼äºï¼ˆç‰‡æ®µ 2ï¼‰ï¼š\n1 2 3 4 5 6 7 8 // å¯èƒ½çš„ Case CaseEnum caseEnum = getRandomCase(); for (CaseHandler handler : caseHandlerFactory.getHandlers()) { if (handler.match(caseEnum)) { handler.handle(); break; } } å½“å¢åŠ åˆ†æ”¯çš„æ—¶å€™ï¼Œç‰‡æ®µ 1 éœ€è¦åœ¨å°¾éƒ¨è¿½åŠ ä»£ç ï¼Œè€Œç‰‡æ®µ 2 æ— éœ€å˜æ›´ï¼Œå‰ææ˜¯ç‰‡æ®µ 2 ä¾èµ–æ›´å¤šçš„ç±»ã€‚\næ³¨æ„ï¼šç‰‡æ®µ 2 åœ¨æœ€åæƒ…å†µä¸‹çš„è¿è¡Œæ—¶é—´çš„å¢é•¿æ•°é‡çº§æ˜¯ Nã€‚\nå¦‚ä½•å®ç°ï¼Ÿ\nï¼ˆä¸€ï¼‰CaseHandlerã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public interface CaseHandler { /** * åŒ¹é… Caseã€‚ * * @param caseEnum Case æšä¸¾ * @return æ˜¯å¦ */ boolean match(CaseEnum caseEnum); /** * ä¸šåŠ¡å¤„ç†ã€‚ */ void handle(); } ï¼ˆäºŒï¼‰CaseHandler å®ç°ä¹‹ä¸€ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 public class AaHandler implements CaseHandler { @Override public boolean match(CaseEnum caseEnum) { return CaseEnum.AA.equals(caseEnum); } @Override public void handle() { // ... } } ï¼ˆä¸‰ï¼‰CaseHandler å·¥å‚ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public class CaseHandlerFactory { /** * handler name to handler */ private final Map\u0026lt;String, CaseHandler\u0026gt; name2Handler; public CaseHandlerFactory() { this.name2Handler = new LinkedHashMap\u0026lt;\u0026gt;(); } public CaseHandlerFactory addHandler(CaseHandler handler) { if (Objects.isNull(handler)) { return this; } name2Handler.put(handler.getClass().getSimpleName(), handler); return this; } public Collection\u0026lt;CaseHandler\u0026gt; getHandlers() { return name2Handler.values(); } } ï¼ˆå››ï¼‰åˆå§‹åŒ– CaseHandler å·¥å‚ã€‚\n1 2 3 4 5 final CaseHandlerFactory caseHandlerFactory = new CaseHandlerFactory() .addHandler(new AaHandler()) .addHandler(new BbHandler()) .addHandler(new CcHandler()) ; ä¾èµ–æ³¨å…¥ åŸºäº Spring IoCï¼Œè‡ªåŠ¨å®ä¾‹åŒ– CaseHandler å·¥å‚ã€‚\nï¼ˆä¸€ï¼‰å°† CaseHandler çš„æ‰€æœ‰å®ç°å£°æ˜ä¸º Spring Beanã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 @Component public class AaHandler implements CaseHandler { @Override public boolean match(CaseEnum caseEnum) { return CaseEnum.AA.equals(caseEnum); } @Override public void handle() { // ... } } ï¼ˆäºŒï¼‰CaseHandlerFactory æ„é€ å™¨çš„ä¾èµ–æ³¨å…¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 @Component public class CaseHandlerFactory { /** * handler name to handler */ private final Map\u0026lt;String, CaseHandler\u0026gt; name2Handler; @Autowired public CaseHandlerFactory(Collection\u0026lt;CaseHandler\u0026gt; handlers) { Assert.notNull(handlers, \u0026#34;handlers must not be null\u0026#34;); this.name2Handler = new LinkedHashMap\u0026lt;\u0026gt;(handlers.size()); handlers.forEach(this::addHandler); } public void addHandler(CaseHandler handler) { if (Objects.isNull(handler)) { return; } name2Handler.put(handler.getClass().getSimpleName(), handler); } public Collection\u0026lt;CaseHandler\u0026gt; getHandlers() { return name2Handler.values(); } } ï¼ˆä¸‰ï¼‰å¼•ç”¨ CaseHandlerFactoryã€‚\n1 2 @Resource private CaseHandlerFactory caseHandlerFactory; ç­–ç•¥æ¨¡å¼ åŸºäº Spring Boot å¼€å‘ Web ç¨‹åºæ—¶ï¼Œæœ‰æ—¶ä¼šé‡åˆ°éœ€è¦æ ¹æ®ä¸åŒçš„ç±»å‹æˆ–ç­–ç•¥ï¼ˆstrategyï¼‰åšä¸åŒçš„äº‹æƒ…ï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 @RestController @RequestMapping(\u0026#34;/some\u0026#34;) public class SomeController { @Resource private SomeService someService; @PostMapping(\u0026#34;/doSomething\u0026#34;) public ResponseEntity\u0026lt;?\u0026gt; doSomething(@RequestBody Some some) { someService.doSomething(some); return ResponseEntity.ok().build(); } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @Service public class SomeService { public void doSomething(Some some) { StrategyEnum strategyEnum = some.getStrategyEnum(); Assert.notNull(strategyEnum, \u0026#34;strategyEnum must not be null\u0026#34;); switch (strategyEnum) { case Strategy1: // ... break; case Strategy2: // ... break; case Strategy3: // ... break; default: // ... } } } ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¯ä»¥ä¼˜åŒ–è¿‡é•¿çš„â€œåˆ†æ”¯ä»£ç â€ã€‚\nDefine a family of algorithms, encapsulate each one, and make them interchangeable. Strategy lets the algorithm vary independently from clients that use it.\nå¤§åŒå°å¼‚ï¼Œç¼–å†™ç­–ç•¥ç±»å’Œç­–ç•¥å·¥å‚ç±»ã€‚\nï¼ˆä¸€ï¼‰æ‰€æœ‰å¯èƒ½çš„ Strategyã€‚\n1 2 3 4 5 6 7 8 9 public enum StrategyEnum { Strategy1, Strategy2, Strategy3 // ... } ï¼ˆäºŒï¼‰Strategy æ¥å£ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 public interface Strategy { /** * è·å– Strategy æšä¸¾ * * @return Strategy æšä¸¾ */ StrategyEnum getStrategyEnum(); /** * ä¸šåŠ¡å¤„ç† */ void doSomething(); } ï¼ˆä¸‰ï¼‰Strategy çš„å…¶ä¸­ä¸€ä¸ªå®ç°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 @Component public class Strategy1 implements Strategy { @Override public StrategyEnum getStrategyEnum() { return StrategyEnum.Strategy1; } @Override public void doSomething() { // ... } } ï¼ˆå››ï¼‰Strategy å·¥å‚ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @Component public class StrategyFactory { private final Map\u0026lt;StrategyEnum, Strategy\u0026gt; strategyMap; @Autowired public StrategyFactory(Collection\u0026lt;Strategy\u0026gt; strategies) { Assert.notNull(strategies, \u0026#34;strategies must not be null\u0026#34;); this.strategyMap = new LinkedHashMap\u0026lt;\u0026gt;(strategies.size()); strategies.forEach((strategy) -\u0026gt; strategyMap.put(strategy.getStrategyEnum(), strategy)); } public Strategy getStrategy(StrategyEnum strategyEnum) { return strategyMap.get(strategyEnum); } } ï¼ˆäº”ï¼‰é‡å†™ SomeServiceã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 @Service public class SomeService { @Resource private StrategyFactory strategyFactory; public void doSomething(Some some) { Strategy strategy = strategyFactory.getStrategy(some.getStrategyEnum()); if (Objects.nonNull(strategy)) { strategy.doSomething(); } } } æ³¨æ„ï¼šè·å–ç­–ç•¥çš„æ–¹æ³•ï¼ˆgetStrategyï¼‰åœ¨æœ€åæƒ…å†µä¸‹çš„è¿è¡Œæ—¶é—´çš„å¢é•¿æ•°é‡çº§æ˜¯ 1ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ Spring Beans and Dependency Injection\nStrategy Design Pattern with in Spring Boot application.\n","date":"2021-08-05T14:37:16+08:00","permalink":"https://h2cone.github.io/2021/08/05/loop_or_strategy/","title":"ä¼˜åŒ–è¿‡é•¿çš„â€œåˆ†æ”¯ä»£ç â€"},{"content":"åŸºäºæ—¥æœŸçš„ç´¢å¼• é¢„æœŸå•ä¸€ç´¢å¼•å¢é•¿é€Ÿç‡è¾ƒå¿«ï¼Œæœ€ç»ˆå†³å®šåˆ›å»ºåŸºäºæ—¥æœŸçš„ç´¢å¼•ï¼ˆtime-based indicesï¼‰ï¼Œä¾‹å¦‚æŒ‰æœˆä»½åˆ†ç´¢å¼•ï¼š\n1 2 3 4 @Document(indexName = \u0026#34;my_index-#{@timeBasedIndexNameProvider.toMonth()}\u0026#34;, shards = 3) public class Entity { // ... } å…¶ä¸­ indexName çš„å€¼å¯åŒ…å« SpELï¼Œå¼•ç”¨äº† TimeBasedIndexNameProvider çš„ toMonthã€‚\n1 2 3 4 5 6 7 @Component(\u0026#34;timeBasedIndexNameProvider\u0026#34;) public class TimeBasedIndexNameProvider { public String toMonth() { return LocalDateTime.now().format(DateTimeFormatter.ofPattern(\u0026#34;yyyy-MM\u0026#34;)); } } ç”Ÿæˆçš„ä¸€ç³»åˆ—ç´¢å¼•åå½¢å¼å¦‚ä¸‹ï¼š\nmy_index-2021-07\nmy_index-2021-08\n\u0026hellip;\u0026hellip;\nä¿å­˜å®ä½“æ—¶ï¼Œå½“å‰æœˆä»½çš„ç´¢å¼•å¯èƒ½è¿˜æœªåˆ›å»ºï¼Œå¦‚æœç›´æ¥ä½¿ç”¨ ElasticsearchRestTemplate çš„ save æ–¹æ³•ï¼Œå½“å‰ç‰ˆæœ¬å¹¶ä¸ä¼šè§£æå®ä½“ç±»çš„å®ä¾‹å­—æ®µä¸Šæ ‡æ³¨çš„ Elasticsearch ç›¸å…³æ³¨è§£ï¼Œä¾‹å¦‚æœ‰ä¸€ä¸ªå­—æ®µï¼ˆbatchIdï¼‰ï¼š\n1 2 @Field(type = FieldType.Keyword) private String batchId; è¿™ç§æƒ…å†µä¸‹ï¼Œè‡ªåŠ¨åˆ›å»ºçš„ my_index-* çš„ Mapping æ‰€åŒ…å«çš„ batchId ç±»å‹æ˜¯ Textï¼Œè€Œä¸æ˜¯é¢„æœŸçš„ Keywordã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨ä¿å­˜å®ä½“ä¹‹å‰ï¼Œå…ˆæ£€æµ‹å½“å‰æœˆä»½çš„ç´¢å¼•æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºç´¢å¼•ï¼ˆåŒ…æ‹¬ Mappingï¼‰ï¼Œå¦åˆ™ç›´æ¥ä¿å­˜å®ä½“ã€‚\n1 2 3 4 5 6 7 8 9 void createIndexAndPutMapping(Class\u0026lt;T\u0026gt; entityClass) { IndexOperations ops = elasticsearchRestTemplate.indexOps(entityClass); if (ops.exists()) { return; } ops.create(); Document mapping = ops.createMapping(entityClass); ops.putMapping(mapping); } ä¸Šé¢çš„ createIndexAndPutMapping çº¿ç¨‹ä¸å®‰å…¨ï¼Œå¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œè¯¥æ–¹æ³•æ—¶ï¼Œä¸ä»…å¯èƒ½ä¼šçœ‹åˆ°ä¸‹é¢çš„é”™è¯¯ä¿¡æ¯ï¼Œè€Œä¸” my_index-* çš„ Mapping ä¹Ÿå¯èƒ½ä¸ç¬¦åˆé¢„æœŸã€‚\n1 mapper [batchId] of different type, current_type [text], merged_type [keyword] æ—¢å¸Œæœ›å„ä¸ªçº¿ç¨‹ä¿å­˜å®ä½“äº’ä¸å¹²æ‰°ï¼Œåˆä¸å¸Œæœ›åŒæ­¥æœºåˆ¶æ‰€å¼•èµ·çš„å»¶è¿Ÿï¼Œé‚£ä¹ˆæœ€å¥½çš„æ–¹æ¡ˆæ˜¯ä½¿ç”¨ç´¢å¼•æ¨¡æ¿ã€‚\n1 2 3 4 5 6 7 8 boolean putTemplate(Class\u0026lt;T\u0026gt; entityClass, String templateName, String... indexPatterns) { IndexOperations ops = elasticsearchRestTemplate.indexOps(entityClass); PutTemplateRequest request = PutTemplateRequest.builder(templateName, indexPatterns) .withSettings(Document.from(ops.createSettings())) .withMappings(Document.from(ops.createMapping())) .build(); return ops.putTemplate(request); } æ„å»ºæ¨¡æ¿æ—¶ï¼ŒæŒ‡å®šç´¢å¼•çš„æ¨¡å¼ï¼ˆindexPatternsï¼‰ï¼Œè¿™é‡Œå°±æ˜¯ my_index-*ï¼Œä¹‹åæ‰€æœ‰åç§°æ»¡è¶³è¯¥æ¨¡å¼çš„ç´¢å¼•åˆ›å»ºæ—¶ï¼Œå®ƒä»¬çš„ Mapping å®Œå…¨ä¸€è‡´ã€‚æ³¨æ„ï¼Œä»¥ä¸Šæ–¹æ³•æ— éœ€åŒæ­¥æœºåˆ¶ï¼Œä½†æ˜¯è¦æ±‚å•çº¿ç¨‹æ‰§è¡Œï¼Œä¾‹å¦‚åœ¨ç¨‹åºå¯åŠ¨æ—¶ç”±å•çº¿ç¨‹æ‰§è¡Œ createIndexAndMapping æ–¹æ³•ï¼Œå†ç”±å¤šçº¿ç¨‹æ‰§è¡Œ ElasticsearchRestTemplate çš„ save æ–¹æ³•ã€‚\nå®ä½“å†…å®¹å¤ªé•¿ åœ¨æ—¥å¿—ä¸­çœ‹åˆ°äº†è¿™æ ·çš„é”™è¯¯ä¿¡æ¯ï¼š\n1 entity content is too long [499093206] for the configured buffer limit [104857600] ä» HttpAsyncResponseConsumerFactory å¯ä»¥çŸ¥é“ Elasticsearch å®¢æˆ·ç«¯æ¥æ”¶å“åº”çš„ç¼“å†²åŒºå¤§å°æ˜¯ 100 MBï¼ˆ104857600 bytesï¼‰ï¼Œè™½ç„¶æ˜¯ç¡¬ç¼–ç ï¼Œä½†æ˜¯å·²ç»è¶³å¤Ÿå¤§åˆ°è¦†ç›–ç»å¤§å¤šæ•°åœºæ™¯ï¼Œä¸å¦‚è°ƒæŸ¥ä¸€ä¸‹æ˜¯å¦æ˜¯ä¸šåŠ¡é€»è¾‘ä»£ç çš„ç¼ºé™·ã€‚\næœ‰å¯èƒ½æ˜¯å› ä¸ºå…ˆè¿‡æ»¤åèšåˆçš„æŸ¥è¯¢æ²¡æœ‰é™åˆ¶è®°å½•æ¡æ•°ï¼Œå¯ä»¥è€ƒè™‘è®¾ç½® withPageableã€‚\n1 2 3 4 5 6 NativeSearchQuery query = new NativeSearchQueryBuilder() .withQuery(queryBuilder) .withPageable(PageRequest.of(0, 1)) .addAggregation(aggregationBuilder) .withIndicesOptions(IndicesOptions.lenientExpandOpen()) .build(); åˆ†ç»„å’Œæ’åºä»¥åŠ Top-N ä¾‹å¦‚ï¼Œä¸€ä¸ªå…ˆè¿‡æ»¤åèšåˆçš„æŸ¥è¯¢ï¼š\næŒ‰æŸä¸€å­—æ®µè¿‡æ»¤ã€‚ æŒ‰æŸä¸€å­—æ®µåˆ†ç»„ã€‚ ç»„å†…æŒ‰æŸä¸€å­—æ®µæ’åºã€‚ æ¯ç»„åªå–å‰å‡ ä¸ªã€‚ å„ç»„æŒ‰æŸä¸€å­—æ®µæ’åºã€‚ Query DSL å¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 { \u0026#34;query\u0026#34;: { \u0026#34;bool\u0026#34;: { \u0026#34;must\u0026#34;: [ { \u0026#34;term\u0026#34;: { \u0026#34;eventId\u0026#34;: { \u0026#34;value\u0026#34;: \u0026#34;AXso-TZMPxhCtoMLAWoN\u0026#34;, \u0026#34;boost\u0026#34;: 1.0 } } } ], \u0026#34;adjust_pure_negative\u0026#34;: true, \u0026#34;boost\u0026#34;: 1.0 } }, \u0026#34;aggs\u0026#34;: { \u0026#34;group-by-batchId\u0026#34;: { \u0026#34;terms\u0026#34;: { \u0026#34;field\u0026#34;: \u0026#34;batchId\u0026#34;, \u0026#34;size\u0026#34;: 10, \u0026#34;min_doc_count\u0026#34;: 1, \u0026#34;shard_min_doc_count\u0026#34;: 0, \u0026#34;show_term_doc_count_error\u0026#34;: false, \u0026#34;order\u0026#34;: [ { \u0026#34;min-createTime\u0026#34;: \u0026#34;asc\u0026#34; }, { \u0026#34;_key\u0026#34;: \u0026#34;asc\u0026#34; } ] }, \u0026#34;aggregations\u0026#34;: { \u0026#34;min-createTime\u0026#34;: { \u0026#34;min\u0026#34;: { \u0026#34;field\u0026#34;: \u0026#34;createTime\u0026#34; } }, \u0026#34;topN\u0026#34;: { \u0026#34;top_hits\u0026#34;: { \u0026#34;from\u0026#34;: 0, \u0026#34;size\u0026#34;: 1, \u0026#34;version\u0026#34;: false, \u0026#34;seq_no_primary_term\u0026#34;: false, \u0026#34;explain\u0026#34;: false, \u0026#34;sort\u0026#34;: [ { \u0026#34;actionStartTime\u0026#34;: { \u0026#34;order\u0026#34;: \u0026#34;asc\u0026#34; } } ] } } } } } } è¿™é‡Œå…³é”®åœ¨äºåˆ†ç»„ä¹‹åï¼Œåœ¨æ¯ä¸€ç»„æ±‚ç”¨äºå„ç»„æ’åºçš„å­—æ®µçš„æœ€å°å€¼æˆ–æœ€å¤§å€¼ã€‚\n1 2 3 4 5 MinAggregationBuilder minAggBuilder = AggregationBuilders .min(minAggName) .field(orderByField); termsAggBuilder.order(BucketOrder.aggregation(minAggName, orderByFieldAsc)); termsAggBuilder.subAggregation(minAggBuilder); å­—æ®µè†¨èƒ€ Elasticsearch é™åˆ¶å®¢æˆ·ç«¯å°†è¿‡å¤šé”®å€¼å¯¹æ’å…¥ç´¢å¼•ã€‚\n1 2 3 4 /** * nodeId to taskId */ private Map\u0026lt;String, String\u0026gt; nodeId2TaskId; ä¸Šé¢æ˜¯ Object æˆ–è€… Nested çš„å­—æ®µï¼Œéšç€æ’å…¥æ¬¡æ•°å¢å¤šï¼Œå¯èƒ½é‡åˆ°å¼‚å¸¸ï¼š\n1 Limit of total fields [1000] in index has been exceeded å¦‚æœä¸éœ€è¦æ£€ç´¢ï¼Œé‚£ä¹ˆä¼˜å…ˆè€ƒè™‘å°†å­—æ®µç±»å‹è®¾ç½®ä¸º Flattenedã€‚\n1 2 @Field(type = FieldType.Flattened) private Map\u0026lt;String, String\u0026gt; nodeId2TaskId; æœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ Spring Data Elasticsearch # High Level REST Client\nSpring Data Elasticsearch - Reference Documentation\nAnd the big one said \u0026ldquo;Rollover\u0026rdquo;â€‰â€”â€‰Managing Elasticsearch time-based indices efficiently\nElasticsearch Guide # Aggregations\n","date":"2021-07-26T11:05:02+08:00","permalink":"https://h2cone.github.io/2021/07/26/elasticsearch_rest_template_pitfall/","title":"ElasticsearchRestTemplate çš„ä¸€äº›å‘"},{"content":"èƒŒæ™¯ è¿‘æœŸï¼Œä»é›¶å¼€å§‹æ­å»º SOAR å¹³å°ï¼Œå…¶ä¸­å·¥ä½œæµå¼•æ“æˆ–ä»»åŠ¡ç¼–æ’ç»„ä»¶æ˜¯æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ã€‚\nAirflow Airflow æ˜¯ç”¨äºæè¿°ã€æ‰§è¡Œã€ç›‘æ§å·¥ä½œæµçš„å¹³å°ã€‚ç›®å‰ä¸ºæ­¢ï¼Œå¯åŠ¨ Airflow æœ€å¿«çš„æ–¹å¼æ˜¯â€”â€”åœ¨ Docker ä¸­è¿è¡Œ Airflowï¼Œè¿™ç§å®‰è£…æ–¹å¼ä¹Ÿæœ‰åˆ©äºå¯æ‰©å±•æ€§ã€‚\næœ‰ä¸€äº›ç»„ä»¶éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼ˆæ­¤å¤„çœç•¥ Flowerï¼‰ï¼š\nWebserverï¼šæä¾›è®¿é—® DAGã€ä»»åŠ¡ã€å˜é‡ã€è¿æ¥ç­‰ç­‰çš„çŠ¶æ€ä¿¡æ¯çš„ Airflow REST APIã€‚ Schedulerï¼šè´Ÿè´£ DAG è§£æä¸ä»»åŠ¡è°ƒåº¦ã€‚ Workerï¼šæ‰§è¡Œç”± Scheduler åˆ†é…çš„ä»»åŠ¡ã€‚ Redisï¼šScheduler ä¸ Worker ä¹‹é—´çš„æ¶ˆæ¯ä»£ç†ã€‚ Postgresï¼šå­˜å‚¨æœ‰å…³ DAGã€ä»»åŠ¡ã€å˜é‡ã€è¿æ¥ç­‰ç­‰çš„çŠ¶æ€ä¿¡æ¯ã€‚ ä¸Šè¿°ç»„ä»¶æ˜¯è¿›ç¨‹çº§ç»„ä»¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ DAGs å¹¶ä¸æ˜¯è¿›ç¨‹ï¼Œè€Œæ˜¯æŒ‡å¤šä¸ª Python æºæ–‡ä»¶ã€‚DAG æ˜¯æœ‰å‘æ— ç¯å›¾ï¼ˆDirected Acyclic Graphï¼‰çš„ç¼©å†™ï¼Œä» Airflow çš„è§’åº¦æ¥çœ‹ï¼ŒDAG ç”¨äºæè¿°å·¥ä½œæµï¼Œæœ‰å‘æ— ç¯å›¾ä¸­çš„ç»“ç‚¹è¢«ç§°ä¸ºä»»åŠ¡ï¼ˆTaskï¼‰ï¼Œè€Œ Task æ˜¯é€šè¿‡ Operator æ¥å®ç°ã€‚DAGs çš„ä½ç½®åœ¨ Airflow é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šï¼Œé‡è¦çš„äº‹æƒ…æ˜¯ Webserver å’Œ Scheduler ä»¥åŠ Worker éƒ½éœ€è¦è¯»å– DAGsã€‚\nç”Ÿæˆ DAG ç¼–å†™ DAG éœ€è¦ä¸€å®šçš„ Python çŸ¥è¯†ï¼Œç”šè‡³ Airflow å¹¶ä¸æä¾›åˆ›å»º DAG çš„ UI æˆ– REST APIã€‚æƒ…ç†ä¹‹ä¸­ï¼ŒAirflow åˆ›å»ºå·¥ä½œæµå¹¶ä¸åŒ…å«â€œæ— ä»£ç â€æˆ–â€œä½ä»£ç â€ç‰¹æ€§ï¼Œä»å®˜æ–¹é¦–é¡µå¯ä»¥çœ‹åˆ°å…¶å®šä½ï¼š\nAirflow is a platform created by the community to programmatically author, schedule and monitor workflows.\nåç«¯æ»¡è¶³å¯è§†åŒ–ä»»åŠ¡ç¼–æ’éœ€æ±‚è§£å†³æ–¹æ¡ˆä¹‹ä¸€æ˜¯é€šè¿‡ç”¨æˆ·è¾“å…¥ç”Ÿæˆ DAG æºæ–‡ä»¶ï¼Œå³ç”Ÿæˆç‰¹å®šçš„ Python æºæ–‡ä»¶ã€‚\næ¨¡æ¿æ–¹æ³• ä½“éªŒè¿‡ç¼–å†™ DAG æˆ–æµè§ˆè¿‡ DAG ç¤ºä¾‹ä¹‹åå¯ä»¥å½’çº³å‡º DAG çš„ä¸€èˆ¬ç»“æ„ï¼š\nImport Statementsï¼ˆå¯¼å…¥è¯­å¥ï¼‰\nDefault Argumentsï¼ˆé»˜è®¤å‚æ•°ï¼‰\nDAG Constructorï¼ˆDAG æ„é€ å™¨ï¼‰\nOperatorsï¼ˆOperator æ„é€ å™¨ï¼‰\nDependenciesï¼ˆOperator ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼‰\nå¦‚æœéœ€è¦ä¸€äº›å¤æ‚å‡½æ•°æ‰èƒ½æ»¡è¶³éœ€æ±‚ï¼Œå®Œå…¨å¯ä»¥å°†å¤æ‚åº¦è½¬ç§»åˆ° Airflow ä¹‹å¤–çš„æœåŠ¡æä¾›è€…ï¼ˆservice providerï¼‰ï¼Œä¾‹å¦‚åœ¨ DAG ä¸­ä½¿ç”¨ HTTP Operators å‘æœåŠ¡æä¾›è€…å‘é€è¯·æ±‚ï¼Œç”±æœåŠ¡æä¾›è€…å¤„ç†è¯·æ±‚ï¼ˆå…·ä½“ä¸šåŠ¡é€»è¾‘åœ¨æœåŠ¡æä¾›è€…å®ç°ï¼‰ã€‚\nç¨‹åºå¯ä»¥æ ¹æ® DAG çš„ä¸€èˆ¬ç»“æ„ï¼Œä¾æ¬¡è¿½åŠ ä»£ç ç‰‡æ®µã€‚æ ¹æ®å…³æ³¨ç‚¹åˆ†ç¦»åŸåˆ™ï¼Œç±»ä¼¼äºæ¨¡å‹ï¼ˆModelï¼‰ä¸è§†å›¾ï¼ˆViewï¼‰çš„åˆ†ç¦»é™ä½äº†å¤æ‚åº¦ï¼Œä»£ç ç‰‡æ®µå¯åˆ†ä¸ºé™æ€å†…å®¹å’ŒåŠ¨æ€å†…å®¹ï¼Œå‰è€…é€šå¸¸æ˜¯æ˜¯æ ·æ¿ä»£ç ï¼Œåè€…é€šå¸¸æ˜¯å‚æ•°å€¼ï¼›å°†é™æ€å†…å®¹ä¸åŠ¨æ€å†…å®¹åˆæˆæºä»£ç æœ€ä¾¿åˆ©çš„å·¥å…·æ˜¯æ¨¡æ¿å¼•æ“ï¼Œè€Œä¸æ˜¯é‡æ–°å‘æ˜è½®å­ã€‚\nå„ç§ç¼–ç¨‹è¯­è¨€æ—©å·²æœ‰é¢å‘ Web é¢†åŸŸçš„æ¨¡æ¿å¼•æ“ï¼Œä½†æ­¤å¤„å¹¶ä¸éœ€è¦åŸºäºæ–‡æ¡£æ ‘ï¼ˆDOMï¼‰ç”Ÿæˆï¼Œå› ä¸ºæœŸæœ›è¾“å‡ºä¸æ˜¯ HTML ä¹‹ç±»çš„æ–‡ä»¶ï¼Œè€Œæ˜¯ Python æºæ–‡ä»¶ï¼Œå³çº¯æ–‡æœ¬ï¼Œå› è€Œè€ƒè™‘åŸºäºå­—ç¬¦ä¸²çš„æ¨¡æ¿å¼•æ“ï¼Œä¾‹å¦‚ Antlr Project ä¸‹çš„ StringTemplate 4ï¼Œæ­¤ä»‹ç»éå¸¸æœ‰åŠ©äºç†è§£ StringTemplate 4ã€‚\n1 2 3 4 5 6 7 8 9 public class User { public int id; // template can directly access via u.id private String name; // template can\u0026#39;t access this public User(int id, String name) { this.id = id; this.name = name; } public boolean isManager() { return true; } // u.manager public boolean hasParkingSpot() { return true; } // u.parkingSpot public String getName() { return name; } // u.name public String toString() { return id+\u0026#34;:\u0026#34;+name; } // u } 1 2 3 ST st = new ST(\u0026#34;\u0026lt;b\u0026gt;$u.id$\u0026lt;/b\u0026gt;: $u.name$\u0026#34;, \u0026#39;$\u0026#39;, \u0026#39;$\u0026#39;); st.add(\u0026#34;u\u0026#34;, new User(999, \u0026#34;parrt\u0026#34;)); String result = st.render(); // \u0026#34;\u0026lt;b\u0026gt;999\u0026lt;/b\u0026gt;: parrt\u0026#34; å¦‚ä½•ä½¿ç”¨ StringTemplate 4 çš„æ¨¡æ¿è¡¨è¾¾å¼ç¼–å†™ DAG æ¨¡æ¿ï¼Ÿä¸å¦¨å‚è€ƒ airflow-up/templatesã€‚æ­¤å¤„åˆ—ä¸¾ä¸€ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;t.taskId\u0026gt; = SimpleHttpOperator( task_id=\u0026#39;\u0026lt;t.taskId\u0026gt;\u0026#39;, http_conn_id=\u0026#39;\u0026lt;t.httpConnId\u0026gt;\u0026#39;, endpoint=\u0026#39;\u0026lt;t.endpoint\u0026gt;\u0026#39;, method=\u0026#39;\u0026lt;t.method\u0026gt;\u0026#39;, \u0026lt;if(t.data)\u0026gt;data=\u0026#34;{{ dag_run.conf[\u0026#39;\u0026lt;t.taskId\u0026gt;\u0026#39;][\u0026#39;data\u0026#39;] \u0026lt;if(t.dataFilter)\u0026gt;\u0026lt;t.dataFilter\u0026gt;\u0026lt;endif\u0026gt; }}\u0026#34;,\u0026lt;endif\u0026gt; \u0026lt;if(t.headers)\u0026gt;headers=\u0026lt;t.headers\u0026gt;,\u0026lt;endif\u0026gt; \u0026lt;if(t.responseCheck)\u0026gt;response_check=\u0026lt;t.responseCheck\u0026gt;,\u0026lt;endif\u0026gt; \u0026lt;if(t.responseFilter)\u0026gt;response_filter=\u0026lt;t.responseFilter\u0026gt;,\u0026lt;endif\u0026gt; \u0026lt;if(t.extraOptions)\u0026gt;extra_options=\u0026lt;t.extraOptions\u0026gt;,\u0026lt;endif\u0026gt; \u0026lt;if(logResponse)\u0026gt;log_response=\u0026lt;logResponse\u0026gt;,\u0026lt;endif\u0026gt; dag=dag, ) DAG æºæ–‡ä»¶ç”šè‡³å¯ä»¥åŒ…å« Jinja è¡¨è¾¾å¼ï¼ˆdataFilter çš„å€¼é€‰è‡ª Jinja2 å†…ç½®è¿‡æ»¤å™¨ï¼Œåœ¨è§¦å‘ DAG è¿è¡Œæ—¶ï¼ŒAirflow æ¸²æŸ“ DAG æºæ–‡ä»¶ï¼Œå¹¶ä¸”ä¼ é€’é¢å¤–é…ç½®å‚æ•°ï¼ˆdag_run.confï¼‰çš„å€¼ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨ Jinja2ï¼Œé™¤äº† Airflow å¤©ç„¶æ”¯æŒä»¥å¤–ï¼ŒåŸå› ä¹‹ä¸€æ˜¯ä¸šåŠ¡ç³»ç»Ÿå°†äº‹ä»¶ä½œä¸ºè¯·æ±‚å‚æ•°çš„ä¸€éƒ¨åˆ†ï¼ˆé¢å¤–é…ç½®å‚æ•°ï¼‰ä¼ é€’ç»™ Webserver ç”¨äºè§¦å‘ä¸€ä¸ªæ–°çš„ DAG è¿è¡Œçš„æ¥å£ï¼ˆPOST /dags/{dag_id}/dagRunsï¼‰ï¼Œå› æ­¤æœ‰äº›å‚æ•°æ²¡æ³•åœ¨ç”Ÿæˆ DAG æºæ–‡ä»¶æ—¶ç¡®å®šï¼Œè€Œåªèƒ½åœ¨è¿è¡Œæ—¶ç¡®å®šã€‚\nNote: The parameters from dag_run.conf can only be used in a template field of an operator.\nåŸå› ä¹‹äºŒæ˜¯ SimpleHttpOperator æˆ– HttpSensor çš„æ„é€ å™¨å¯¹äºä¸åŒçš„è¯·æ±‚æ–¹æ³•ï¼ˆmethodï¼‰è¦æ±‚ä¸åŒç»“æ„çš„è¯·æ±‚å‚æ•°ï¼ˆdataï¼‰ï¼Œä¾‹å¦‚ POST è¯·æ±‚å‚æ•°è¦æ±‚ JSONï¼Œè€Œ GET è¯·æ±‚å‚æ•°è¦æ±‚ Query Stringã€‚\nAirflow å®˜æ–¹æ¨èä½¿ç”¨ç§»ä½è¿ç®—ç¬¦å®šä¹‰ Operator ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ç”¨æˆ·æäº¤åˆ°åç«¯çš„æµç¨‹å›¾ï¼ˆé€šå¸¸æ˜¯æ ‘æˆ–æœ‰å‘æ— ç¯å›¾ï¼‰å®šä¹‰äº†ç»“ç‚¹ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç”Ÿæˆ Operator ä¹‹é—´çš„ä¾èµ–å…³ç³»æœ€ç›´æˆªäº†å½“çš„æ–¹å¼æ˜¯ä½¿ç”¨æ·±åº¦æœç´¢åˆ—å‡ºæ‰€æœ‰è·¯å¾„ã€‚\næ¯ä¸ªæ ˆå¸§éƒ½ç»´æŠ¤ä¸€ä¸ªæœ‰åºåˆ—è¡¨ï¼ˆå­è·¯å¾„ï¼‰ï¼Œæ–¹æ³•æ‰§è¡Œè¿‡ç¨‹å°†ç»“ç‚¹æˆ– Operator æ·»åŠ åˆ°å­è·¯å¾„ï¼Œé€’å½’è°ƒç”¨æ—¶å°†å­è·¯å¾„å…ƒç´ å­˜å…¥æ–°å­è·¯å¾„ï¼Œå¾ªç¯ç»“æŸåå°†å­è·¯å¾„æ·»åŠ åˆ°ä¸»è·¯å¾„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 void addPathToPaths(List\u0026lt;Node\u0026gt; nodes, List\u0026lt;Node\u0026gt; path) { if (CollectionUtils.isEmpty(nodes)) { return; } for (Node node : nodes) { if (Objects.isNull(node)) { continue; } addNodeToPath(node); List\u0026lt;Node\u0026gt; children = node.getChildren(); if (CollectionUtils.isNotEmpty(children)) { addPathToPaths(children, new ArrayList\u0026lt;\u0026gt;(path)); } } if (CollectionUtils.isNotEmpty(path)) { paths.add(path); } } DAG ä»£ç† Airflow çš„ Scheduler å®šæœŸæ‰«æ DAG ç›®å½•ï¼Œå‘ç°æ–° DAG æ–‡ä»¶ï¼ŒåŒæ—¶å®šæœŸè§£æè¯¥ç›®å½•ä¸‹çš„æ¯ä¸€ä¸ª DAG æ–‡ä»¶ï¼Œä¸¤è€…çš„é¢‘ç‡å¯é€šè¿‡ min_file_process_interval å’Œ dag_dir_list_interval è®¾ç½®ã€‚åº”ç”¨ç¨‹åºæ˜¯å¦ä¹Ÿå¿…é¡»çŸ¥é“è¯¥ç›®å½•çš„ç»å¯¹è·¯å¾„ï¼Ÿåº”ç”¨ç¨‹åºå¿…é¡»ä¸ Airflow è¿è¡Œåœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šï¼Ÿæ˜¾ç„¶ä¸æ˜¯ï¼Œåªéœ€è¦åœ¨åº”ç”¨ç¨‹åºä¸ DAGs ä¹‹é—´æ’å…¥ä¸€ä¸ªä¸­é—´å±‚ã€‚\nå…±äº«å· å‡å¦‚åœ¨ Docker ä¸­è¿è¡Œ Airflowï¼Œæ–¹ä¾¿å¼€å‘è¿ç»´èµ·è§ï¼ŒDagAgent ç†åº”åœ¨ Docker ä¸­è¿è¡Œï¼Œä½†æ˜¯ DagAgent æ¥æ”¶åˆ° DAG æ–‡ä»¶ååº”è¯¥å†™åˆ°å“ªé‡Œå»ï¼Ÿä»¥ airflow/docker-compose.yaml ä¸ºä¾‹ï¼Œåˆ›å»ºäº†ä¸‰ä¸ªå·ï¼ˆVolumeï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 version: \u0026#39;3\u0026#39; x-airflow-common: ... volumes: - ./dags:/opt/airflow/dags - ./logs:/opt/airflow/logs - ./plugins:/opt/airflow/plugins ... ... å…¶ä¸­ DAG ç›®å½•çš„æºåœ°å€æ˜¯ ./dagsï¼ˆå®¿ä¸»æœºè§†è§’ï¼‰ï¼Œè€Œç›®çš„åœ°æ˜¯ /opt/airflow/dagsï¼ˆDocker å®¹å™¨è§†è§’ï¼‰ï¼›å¯å–œå¯è´ºçš„æ˜¯ Docker CLI å·²ç»æ”¯æŒ Compose å‘½ä»¤ï¼Œæ£é¼“ Docker ç‰ˆ Airflow ä¹Ÿå°±ä¸éœ€è¦ docker-compose ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 % docker compose up -d [+] Running 8/8 â ¿ Network \u0026#34;airflow_default\u0026#34; Created 0.6s â ¿ Container airflow_redis_1 Started 1.6s â ¿ Container airflow_postgres_1 Started 1.4s â ¿ Container airflow_airflow-scheduler_1 Started 10.0s â ¿ Container airflow_airflow-init_1 Started 10.3s â ¿ Container airflow_airflow-worker_1 Started 10.5s â ¿ Container airflow_airflow-webserver_1 Started 7.8s â ¿ Container airflow_dagagent_1 Started 10.6s % docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 122a8455e781 dagagent:latest \u0026#34;./dagagent\u0026#34; 16 minutes ago Up 16 minutes (healthy) 0.0.0.0:1323-\u0026gt;1323/tcp airflow_dagagent_1 8ab76a88a05a apache/airflow:2.0.2 \u0026#34;/usr/bin/dumb-init â€¦\u0026#34; 16 minutes ago Up 16 minutes (healthy) 0.0.0.0:8889-\u0026gt;8080/tcp airflow_airflow-webserver_1 1d0e1b191ea0 apache/airflow:2.0.2 \u0026#34;/usr/bin/dumb-init â€¦\u0026#34; 16 minutes ago Up 16 minutes 8080/tcp airflow_airflow-scheduler_1 a389b993a2c3 apache/airflow:2.0.2 \u0026#34;/usr/bin/dumb-init â€¦\u0026#34; 16 minutes ago Up 16 minutes 8080/tcp airflow_airflow-worker_1 12015f9bc778 postgres:13 \u0026#34;docker-entrypoint.sâ€¦\u0026#34; 16 minutes ago Up 16 minutes (healthy) 5432/tcp airflow_postgres_1 e32501a14963 redis:latest \u0026#34;docker-entrypoint.sâ€¦\u0026#34; 16 minutes ago Up 16 minutes (healthy) 0.0.0.0:6379-\u0026gt;6379/tcp airflow_redis_1 å½“å‰ä¸»ç›®å½•å¦‚ä¸‹ï¼š\n1 2 3 4 5 . â”œâ”€â”€ dags â”œâ”€â”€ logs â”œâ”€â”€ plugins â””â”€â”€ docker-compose.yaml åœ¨å®¿ä¸»æœºä¸Šå°† DAG æ–‡ä»¶è¾“å…¥åˆ° dagsï¼Œè¿è¡Œåœ¨ Docker ä¸­çš„ Airflow å¯æ„ŸçŸ¥ï¼›Airflow çš„ Docker å®¹å™¨è¾“å‡ºçš„æ–‡ä»¶åœ¨å®¿ä¸»æœºå¯è§‚æµ‹ã€‚ç”±äº DagAgent å®¹å™¨åŒ–ï¼Œå®ƒçš„æ–‡ä»¶ I/O è‡ªç„¶ä½œç”¨äºå®¹å™¨æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤ä» DagAgent çš„è§’åº¦æ¥çœ‹ï¼ŒDAG ç›®å½•ä¹Ÿæ˜¯ /opt/airflow/dagsï¼›æ—¢ç„¶ Webserverã€Schedulerã€Worker éƒ½å¼•ç”¨äº† airflow-commonï¼ŒDagAgent æœåŠ¡é…ç½®ä¸­å¯ä»¥ä½¿ç”¨ volumes_from å…±äº« DAG ç›®å½•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 ... dagagent: image: dagagent:latest ports: - 1323:1323 environment: AIRFLOW__CORE__DAGS_FOLDER: /opt/airflow/dags ... volumes_from: - airflow-webserver:rw ... ... æœ€å°åŒ–é•œåƒ DagAgent ä»…ä»…æ˜¯ä¸€ä¸ªå¾®å°çš„æœåŠ¡ï¼Œå®¹å™¨åŒ– Java ç¨‹åºçš„è¯é€šå¸¸è¿‡äºé‡é‡çº§ï¼Œä¸å¦¨ä½¿ç”¨ Go ç¼–å†™ï¼Œè¯¦æƒ…å¯å‚è€ƒ dagagentã€‚\nåŸºäº Go å®˜æ–¹é•œåƒæ„å»ºåº”ç”¨ç¨‹åºé•œåƒï¼Œç›´æ¥äº†å½“çš„ Dockerfile æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 FROM golang:1.16 WORKDIR /go/src/github.com/h2cone/dagagent COPY . . RUN go get -d -v ./... RUN go install -v ./... CMD [\u0026#34;dagagent\u0026#34;] æ„å»ºåä¸º dagagent:straightforward çš„é•œåƒï¼š\n1 % docker build -t dagagent:straightforward -f docker/Dockerfile-straightforward . ä½†æ˜¯ dagagent:straightforward å®åœ¨æ˜¯å¤ªå¤§äº†ï¼\n1 2 3 4 5 6 % docker image list REPOSITORY TAG IMAGE ID CREATED SIZE dagagent straightforward 149604a01e75 6 seconds ago 1.05GB redis latest 739b59b96069 2 weeks ago 105MB apache/airflow 2.0.2 d7a0ff8c98a9 2 weeks ago 871MB postgres 13 26c8bcd8b719 3 weeks ago 314MB åŸºç¡€é•œåƒæ˜¯ç½ªé­ç¥¸é¦–ï¼Ÿä½¿ç”¨ golang:1.16-alpine ä»£æ›¿ golang:1.16ï¼š\n1 2 3 4 5 6 7 8 9 FROM golang:1.16-alpine WORKDIR /go/src/github.com/h2cone/dagagent COPY . . RUN go get -d -v RUN go install -v CMD [\u0026#34;dagagent\u0026#34;] æ„å»ºåä¸º dagagent:small çš„é•œåƒï¼š\n1 % docker build -t dagagent:small -f docker/Dockerfile-small . è¯¥é•œåƒå¤§å°å·²ç»å°äº 1Gï¼Œæ˜¯å¦è¿˜èƒ½å†ç²¾ç®€ï¼Ÿ\n1 2 3 4 5 6 7 % docker image list REPOSITORY TAG IMAGE ID CREATED SIZE dagagent small 145b612b635e 5 seconds ago 485MB dagagent straightforward 149604a01e75 About a minute ago 1.05GB redis latest 739b59b96069 2 weeks ago 105MB apache/airflow 2.0.2 d7a0ff8c98a9 2 weeks ago 871MB postgres 13 26c8bcd8b719 3 weeks ago 314MB åˆ†æä¸€ä¸‹ä»¥ä¸Šä¸¤ä¸ªé•œåƒçš„ç»„æˆï¼Œè‡³å°‘åŒ…å«ä¸‹è½½çš„ä¾èµ–æ–‡ä»¶ã€åº”ç”¨ç¨‹åºçš„æºæ–‡ä»¶ã€é™æ€ç¼–è¯‘è¾“å‡ºçš„å¯æ‰§è¡Œæ–‡ä»¶ç­‰ã€‚DagAgent è¿è¡Œæ—¶åªéœ€è¦å¯æ‰§è¡Œæ–‡ä»¶ä¸æ“ä½œç³»ç»Ÿï¼Œæ•…ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼ˆmulti-stage buildsï¼‰ï¼Œå°†ç¼–è¯‘æ—¶ä¸è¿è¡Œæ—¶åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œè¿è¡Œæ—¶æ‰€éœ€çš„å¯æ‰§è¡Œæ–‡ä»¶æ‹·è´è‡ªç¼–è¯‘æ—¶ï¼Œæœ€ç»ˆåªäº§å‡ºåŒ…å«å¯æ‰§è¡Œæ–‡ä»¶ä¸æ“ä½œç³»ç»Ÿçš„é•œåƒï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 FROM golang:1.16-alpine3.12 AS builder WORKDIR /go/src/github.com/h2cone/dagagent COPY . . RUN go build -v FROM alpine:3.12 WORKDIR /root COPY --from=builder /go/src/github.com/h2cone/dagagent/dagagent . CMD [\u0026#34;./dagagent\u0026#34;] æ„å»ºåä¸º dagagent:min çš„é•œåƒï¼š\n1 % docker build -t dagagent:min -f docker/Dockerfile-min . è¯¥é•œåƒå¤§å°å·²é™ä½ 94%ï¼š\n1 2 3 4 5 6 7 8 % docker image list REPOSITORY TAG IMAGE ID CREATED SIZE dagagent min 75dbfbb53d78 10 seconds ago 27.3MB dagagent small 145b612b635e 4 minutes ago 485MB dagagent straightforward 149604a01e75 5 minutes ago 1.05GB redis latest 739b59b96069 2 weeks ago 105MB apache/airflow 2.0.2 d7a0ff8c98a9 2 weeks ago 871MB postgres 13 26c8bcd8b719 3 weeks ago 314MB åŠ é€Ÿæ„å»º å›å¤´çœ‹ dagagent:straightforwardï¼Œé™¤äº†é•œåƒè¿‡å¤§ï¼Œè¿˜æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå³ä¸‹è½½ä¾èµ–æ—¶ï¼ˆé€šå¸¸æœ€è€—æ—¶ï¼‰æ— æ³•å‘½ä¸­ç¼“å­˜ã€‚åªæ›´æ–°äº† DagAgent çš„æºä»£ç ä½†ä¸æ›´æ–°ä¾èµ–ï¼Œæ„å»ºé•œåƒæ—¶å´éœ€é‡æ–°ä¸‹è½½ä¾èµ–ã€‚\nåŠ é€Ÿé•œåƒæ„å»ºé¦–è¦æ–¹å¼æ˜¯å……åˆ†åˆ©ç”¨æ„å»ºç¼“å­˜ï¼ˆLeverage build cacheï¼‰ã€‚Docker é•œåƒå»ºç«‹åœ¨ä¸€ç³»åˆ—å±‚ä¹‹ä¸Šï¼Œæ¯ä¸€å±‚è¡¨ç¤º Dockerfile ä¸­çš„ä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œç»“æœã€‚å‡å¦‚ä¸ç¦ç”¨ç¼“å­˜ï¼ŒDocker æ‰§è¡Œæ¯ä¸€æ¡ Dockerfile æŒ‡ä»¤æ—¶å…ˆæŸ¥æ‰¾ä¹‹å‰å±‚çš„ç¼“å­˜ï¼Œè‹¥å‘½ä¸­ï¼ˆä¾‹å¦‚æ ¡éªŒå’Œç›¸ç­‰ï¼‰ï¼Œåˆ™ä¸é‡æ–°æ‰§è¡Œå½“å‰æŒ‡ä»¤è€Œæ˜¯å¼•ç”¨å·²å­˜åœ¨çš„å±‚ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç»“æœä¸æ˜“å˜çš„æŒ‡ä»¤å†™åœ¨ç»“æœæ˜“å˜çš„æŒ‡ä»¤ä¹‹å‰çš„ Dockerfile ç¼“å­˜åˆ©ç”¨ç‡æ›´é«˜ã€‚\nDagAgent æºä»£ç æ¯”ä¾èµ–æ›´æ˜“å˜ï¼Œæ ¹æ®ä¸Šæ–‡ï¼Œå…ˆä¸‹è½½ä¾èµ–åæ‹·è´æºä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 FROM golang:1.16 WORKDIR /go/src/github.com/h2cone/dagagent COPY go.mod . COPY go.sum . RUN go mod download -x COPY . . RUN go install -v CMD [\u0026#34;dagagent\u0026#34;] ç»“åˆä¸Šä¸€èŠ‚çš„â€œæœ€å°åŒ–é•œåƒâ€ï¼Œæœ€ç»ˆç‰ˆæœ¬çš„ Dockerfile å¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # syntax=docker/dockerfile:1 FROM golang:1.16-alpine3.12 AS builder ENV GOPROXY=\u0026#34;https://goproxy.io,direct\u0026#34; WORKDIR /go/src/github.com/h2cone/dagagent COPY go.mod . COPY go.sum . RUN go mod download -x COPY . . RUN go build -v FROM alpine:3.12 RUN apk add curl WORKDIR /root COPY --from=builder /go/src/github.com/h2cone/dagagent/dagagent . CMD [\u0026#34;./dagagent\u0026#34;] æ„å»ºåä¸º dagagent:latest çš„é•œåƒ:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 % docker build -t dagagent -f docker/Dockerfile . [+] Building 36.5s (19/19) FINISHED =\u0026gt; [internal] load build definition from Dockerfile 0.0s =\u0026gt; =\u0026gt; transferring dockerfile: 37B 0.0s =\u0026gt; [internal] load .dockerignore 0.0s =\u0026gt; =\u0026gt; transferring context: 2B 0.0s =\u0026gt; resolve image config for docker.io/docker/dockerfile:1 19.2s =\u0026gt; CACHED docker-image://docker.io/docker/dockerfile:1@sha256:e2a8561e419ab1ba6b2fe6cbdf49fd92b95912df1cf7d313c3e2230a333fdbcc 0.0s =\u0026gt; [internal] load metadata for docker.io/library/alpine:3.12 7.6s =\u0026gt; [internal] load metadata for docker.io/library/golang:1.16-alpine3.12 17.1s =\u0026gt; [builder 1/7] FROM docker.io/library/golang:1.16-alpine3.12@sha256:1636899c10870ab66c48d960a9df620f4f9e86a0c72fbacf36032d27404e7e6c 0.0s =\u0026gt; =\u0026gt; resolve docker.io/library/golang:1.16-alpine3.12@sha256:1636899c10870ab66c48d960a9df620f4f9e86a0c72fbacf36032d27404e7e6c 0.0s =\u0026gt; [stage-1 1/4] FROM docker.io/library/alpine:3.12@sha256:36553b10a4947067b9fbb7d532951066293a68eae893beba1d9235f7d11a20ad 0.0s =\u0026gt; [internal] load build context 0.0s =\u0026gt; =\u0026gt; transferring context: 6.42kB 0.0s =\u0026gt; CACHED [stage-1 2/4] RUN apk add curl 0.0s =\u0026gt; CACHED [stage-1 3/4] WORKDIR /root 0.0s =\u0026gt; CACHED [builder 2/7] WORKDIR /go/src/github.com/h2cone/dagagent 0.0s =\u0026gt; CACHED [builder 3/7] COPY go.mod . 0.0s =\u0026gt; CACHED [builder 4/7] COPY go.sum . 0.0s =\u0026gt; CACHED [builder 5/7] RUN go mod download -x 0.0s =\u0026gt; CACHED [builder 6/7] COPY . . 0.0s =\u0026gt; CACHED [builder 7/7] RUN go build -v 0.0s =\u0026gt; CACHED [stage-1 4/4] COPY --from=builder /go/src/github.com/h2cone/dagagent/dagagent . 0.0s =\u0026gt; exporting to image 0.0s =\u0026gt; =\u0026gt; exporting layers 0.0s =\u0026gt; =\u0026gt; writing image sha256:ad807e3e1bda89824e55db14088156f9d4e8dabce6d4e79af117eb533371e4dc 0.0s =\u0026gt; =\u0026gt; naming to docker.io/library/dagagent 0.0s åˆ¤æ–­æŒ‡ä»¤æ˜¯å¦å‘½ä¸­ç¼“å­˜å¯é€šè¿‡ä¸€ä¸ªå…³é”®è¯â€”â€”CACHEDæ¥åˆ¤æ–­ã€‚\næ’ä»¶å‘ç° å½“ Airflow ç”Ÿæ€çš„ç°æœ‰çš„ Operators ä¸æ»¡è¶³éœ€æ±‚æ—¶ï¼Œå¯ä»¥è€ƒè™‘è‡ªå®šä¹‰ Operatorï¼Œä¾‹å¦‚è¦å®ç°ä¸€ä¸ªå“¨å…µè¯­å¥å¼çš„ HTTP Operatorï¼Œåˆå¦‚è¦å®ç°ä¸€ä¸ªå¯ä»¥å°†é¢å¤–é…ç½®å‚æ•°æˆ–ä¸Šæ¸¸ Tasks çš„è¿”å›å€¼ï¼ˆä¼ é€’æœºåˆ¶æ˜¯ XComsï¼‰ç»„è£…æˆå¤æ‚è¯·æ±‚å‚æ•°çš„æ‹“å±• HTTP Operatorã€‚\n1 2 3 4 5 6 7 8 9 10 . â”œâ”€â”€ dags â”œâ”€â”€ logs â”œâ”€â”€ plugins â”‚ â””â”€â”€ operators â”‚ â”œâ”€â”€ __init__.py â”‚ â”œâ”€â”€ extended_http_operator.py â”‚ â”œâ”€â”€ extended_http_sentinel.py â”‚ â””â”€â”€ simple_http_sentinel.py â”œâ”€â”€ docker-compose.yaml å®ç°äº†æ–°çš„ Operator ä¹‹åï¼Œå½“å‰ç‰ˆæœ¬çš„ Airflow èƒ½å¤Ÿå‘ç°ç±»ä¼¼ä¸Šé¢ plugins/operators ç›®å½•ä¸‹çš„è‡ªå®šä¹‰ Operatorï¼ŒæŠ€å·§åœ¨äºå†…å®¹ç©ºç™½çš„ __init__.pyï¼Œè‡ªå®šä¹‰ Operator çš„å¯¼å…¥è¯­å¥å¦‚ä¸‹ï¼š\n1 2 3 from operators.simple_http_sentinel import SimpleHttpSentinel from operators.extended_http_sentinel import ExtendedHttpSentinel from operators.extended_http_operator import ExtendedHttpOperator çŠ¶æ€åŒæ­¥ ä¸šåŠ¡ç³»ç»Ÿå¾ˆå¯èƒ½éœ€è¦çŸ¥é“ä¸€ä¸ª DAG è¿è¡Œåçš„çŠ¶æ€ï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰ï¼ŒDAG æ„é€ å™¨æœ‰æˆåŠŸ/å¤±è´¥çš„å›è°ƒå‡½æ•°ç±»å‹çš„å‚æ•°ï¼ˆon_success_callback/on_failure_callbackï¼‰ï¼Œç¾ä¸­ä¸è¶³çš„æ˜¯æ²¡æœ‰è¡¨ç¤ºå¤±è´¥é‡è¯•æ¬¡æ•°çš„å‚æ•°ï¼Œç„¶è€Œå—åˆ° Python Requests çš„é«˜çº§ä½¿ç”¨ - è¶…æ—¶ï¼Œé‡è¯•ï¼Œé’©å­çš„å¯å‘ï¼Œäºæ˜¯ç¼–å†™äº† dag_callback æ¥æé«˜å›è°ƒæ›´æ–°çŠ¶æ€çš„æˆåŠŸç‡ã€‚\næ•°æ®åº“ä»£ç† æŒ‰ç…§ Fine-tuning your Scheduler performance è°ƒä¼˜ Airflow Scheduler æ—¶ï¼Œæ³¨æ„åˆ°ä¸‹é¢è¿™æ®µè¯ï¼š\nDatabase connections and Database usage might become a problem as you want to increase performance and process more things in parallel. Airflow is known from being â€œdatabase-connection hungryâ€ - the more DAGs you have and the more you want to process in parallel, the more database connections will be opened. This is generally not a problem for MySQL as its model of handling connections is thread-based, but this might be a problem for Postgres, where connection handling is process-based. It is a general consensus that if you have even medium size Postgres-based Airflow installation, the best solution is to use PGBouncer as a proxy to your database. The Helm Chart for Apache Airflow supports PGBouncer out-of-the-box. For MsSQL we have not yet worked out the best practices as support for MsSQL is still experimental.\nåœ¨æˆ‘çš„æµ‹è¯•ä¸­ï¼Œéƒ¨ç½²äº†edoburu/docker-pgbouncer åï¼ŒAirflow ä»»åŠ¡å®ä¾‹ä¹‹é—´çš„å»¶è¿Ÿä¸‹é™äº† 20% ~ 30%ã€‚\nDeferrable Operators å¦‚æœé•¿æ—¶é—´è¿è¡Œçš„ Sensors èµ„æºå¼€é”€ä¸å®¹å°è§‘ï¼ˆåŸºäºå¤šè¿›ç¨‹æ¨¡å‹ï¼‰ï¼Œç–‘ä¼¼æ‹–æ…¢å…¶å®ƒ Operatorï¼Œé‚£ä¹ˆä¸å¦¨è€ƒè™‘ Smart Sensors æˆ–è€… Deferrable Operatorsï¼Œåè€…æä¾›äº†ä¸€ç§æ›´çµæ´»çš„æ–¹å¼æ¥å®ç°é«˜æ•ˆçš„é•¿æ—¶é—´è¿è¡Œçš„ Sensorã€‚\nå°¾å£° æ›´å¤šç¼–æ’å¼•æ“ï¼ˆorchestration engineï¼‰ï¼š\nCadence\nTemporal\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ Airflow # Concepts\nAirflow # Celery Executor\nAirflow # Configuration Reference\nAirflow # Ecosystem\nCurated list of resources about Apache Airflow\nDevelop with Docker\n","date":"2021-05-01T18:12:03+08:00","permalink":"https://h2cone.github.io/2021/05/01/airflow_trick/","title":"Airflow æ‚æŠ€"},{"content":"åé¢ ä¸Šè¯¾æœŸé—´çœ‹åˆ°ä¸€æ®µæ¨¡æ‹ŸæŠ•ç¥¨çš„ç¨‹åºï¼Œå…¶ä¸­ä¸»åç¨‹ï¼ˆmain goroutineï¼‰äº§ç”Ÿçš„è‹¥å¹²å­åç¨‹å¹¶å‘è¯·æ±‚ç¥¨ä¸è®¡ç¥¨ï¼Œä¸»åç¨‹é‡å¤æ£€æŸ¥ç¥¨æ•°æ˜¯å¦å·²è¾¾åˆ°é¢„æœŸã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;math/rand\u0026#34; \u0026#34;os\u0026#34; \u0026#34;strconv\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) func main() { rand.Seed(time.Now().UnixNano()) total, err := strconv.Atoi(os.Args[1]) if err != nil { panic(err) } overHalf := total/2 + 1 count := 0 finished := 0 var mu sync.Mutex for i := 0; i \u0026lt; total; i++ { go func() { vote := requestVote() mu.Lock() defer mu.Unlock() if vote { count++ } finished++ }() } for count \u0026lt; overHalf \u0026amp;\u0026amp; finished \u0026lt; total { // ... } fmt.Printf(\u0026#34;count: %d\\n\u0026#34;, count) fmt.Printf(\u0026#34;finished: %d\\n\u0026#34;, finished) fmt.Printf(\u0026#34;count \u0026gt;= overHalf: %t\\n\u0026#34;, count \u0026gt;= overHalf) } func requestVote() bool { time.Sleep(time.Duration(rand.Intn(100)) * time.Millisecond) return rand.Int()%2 == 0 } ç”±äºè‹¥å¹²å­åç¨‹å¹¶å‘è®¿é—®ä¸€äº›å…±äº«å˜é‡ï¼ˆcount å’Œ finishedï¼‰ï¼Œä½¿ç”¨äº’æ–¥é”ï¼ˆMutexï¼‰å¯ç›´æˆªäº†å½“é˜²æ­¢å†…å­˜ä¸€è‡´æ€§é”™è¯¯ã€‚å¦ä¸€æ–¹é¢ï¼Œä¸»åç¨‹åå¤æ£€æŸ¥ç¥¨æ•°æ—¶å¯¹äº count å’Œ finished åªè¯»ï¼Œå› æ­¤å¹¶ä¸éœ€è¦é”å®šä¸è§£é”ï¼Ÿ\n1 2 3 for count \u0026lt; overHalf \u0026amp;\u0026amp; finished \u0026lt; total { // ... } Visual Studio Code æ¨èçš„ Go ä»£ç é™æ€åˆ†æå™¨â€”â€” go-staticcheck å¯¹ä»¥ä¸Šå¾ªç¯è¯­å¥ç»™å‡ºäº†ä»¥ä¸‹æç¤ºï¼š\nloop condition never changes or has a race condition (SA5002) go-staticcheck\nç«æ€æ¡ä»¶ï¼ˆrace conditionï¼‰æ˜¯æŒ‡äº‹ä»¶çš„æ—¶åºæˆ–æ¬¡åºçš„ä¸ç¡®å®šæ€§å½±å“åˆ°ç¨‹åºçš„æ­£ç¡®æ€§æ—¶äº§ç”Ÿçš„ç¼ºé™·ã€‚æ­¤å¤„ä¸ç¡®å®šæ€§çš„å…¸å‹äº‹ä¾‹æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢ã€æ“ä½œç³»ç»Ÿä¿¡å·ã€å¤šå¤„ç†å™¨ä¸Šçš„å†…å­˜æ“ä½œã€ç¡¬ä»¶ä¸­æ–­ç­‰ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œäº§ç”Ÿç«æ€æ¡ä»¶çš„åœºæ™¯æ˜¯å¹¶å‘ã€‚åœ¨æ¨¡æ‹ŸæŠ•ç¥¨ç¨‹åºï¼Œä¸»åç¨‹è¯»å…±äº«å˜é‡ä¸è‹¥å¹²å­åç¨‹å†™å…±äº«å˜é‡è¿™ä¸¤ä»¶äº‹çš„æ¬¡åºå…·æœ‰ä¸ç¡®å®šæ€§ï¼ˆå‚è§å¤šçº¿ç¨‹Â·å¹¶å‘ç¼–ç¨‹ï¼‰ï¼Œä½†æ˜¯è¯¥ç¨‹åºç»“æœä»ç„¶ç¬¦åˆé¢„æœŸï¼Œå› ä¸ºè¿™äº›å…±äº«å˜é‡ä»ä¸»åç¨‹çš„è§’åº¦æ¥çœ‹åªæ˜¯åªè¯»çš„å˜é‡ï¼ˆä»…åˆ¤æ–­æ¡ä»¶ä¸ºçœŸåä¸åšä»»ä½•äº‹æƒ…è€Œæ˜¯ç»§ç»­åˆ¤æ–­æ¡ä»¶ï¼‰ï¼›å°½ç®¡ä¸»åç¨‹æŸæ—¶åˆ»å¯èƒ½è¯»åˆ°è„æ•°æ®ï¼ˆè„è¯»ï¼‰ï¼Œä½†æ˜¯åœ¨è¿™ä¹‹åæ€»èƒ½è¯»åˆ°æœ€ç»ˆå€¼ï¼Œå› ä¸º count/finished çš„å€¼åªé€’å¢ï¼Œè€Œä¸” overHalf/total çš„å€¼ä¸å˜ã€‚å¦‚æœä¸»åç¨‹å¯¹å…±äº«å˜é‡ä¸ä»…è¯»å–è€Œä¸”å†™å…¥ï¼Œå‡ºäºå®‰å…¨è€ƒè™‘åº”å½“ä½¿ç”¨åŒæ­¥ï¼ˆSynchronizationï¼‰ï¼Œä¾‹å¦‚ä¹Ÿä½¿ç”¨äº’æ–¥é”ï¼š\n1 2 3 4 5 6 7 8 9 10 11 for { mu.Lock() if count \u0026gt;= overHalf || finished \u0026gt;= total { break } mu.Unlock() } fmt.Printf(\u0026#34;count: %d\\n\u0026#34;, count) fmt.Printf(\u0026#34;finished: %d\\n\u0026#34;, finished) fmt.Printf(\u0026#34;count \u0026gt;= overHalf: %t\\n\u0026#34;, count \u0026gt;= overHalf) mu.Unlock() ä¸ä»…æ¶ˆç­äº†æ½œåœ¨çš„ç«æ€æ¡ä»¶ï¼Œè€Œä¸”æ¶ˆç­äº†æ½œåœ¨çš„æ•°æ®ç«äº‰ï¼ˆdata raceï¼‰ã€‚æ•°æ®ç«äº‰å‘ç”Ÿåœ¨ä¸¤ä¸ªçº¿ç¨‹/åç¨‹å¹¶å‘è®¿é—®ç›¸åŒå˜é‡å¹¶ä¸”è‡³å°‘ä¸€ä¸ªè®¿é—®æ˜¯å†™å…¥æ—¶ã€‚å‘ç”Ÿæ•°æ®ç«äº‰çš„ä¸‰ä¸ªæ¡ä»¶ï¼š\nä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹/åç¨‹å¹¶å‘è®¿é—®ç›¸åŒçš„å˜é‡ã€‚\nè‡³å°‘æœ‰ä¸€ä¸ªè®¿é—®æ˜¯å†™å…¥ã€‚\næ²¡æœ‰åŒæ­¥è®¿é—®æœºåˆ¶ã€‚\nä¸‹é¢è€å¥—çš„ç¨‹åºï¼ˆä¸»åç¨‹å°†ç­‰å¾…æ‰€æœ‰å­åç¨‹å®Œæˆè®¡æ•°ä»»åŠ¡åæ‰æ±‡æŠ¥ï¼‰æ¯”è¾ƒå®¹æ˜“æ•è·åç¨‹ä¹‹é—´çš„æ•°æ®ç«äº‰äº§ç”Ÿçš„ BUGã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; \u0026#34;strconv\u0026#34; \u0026#34;sync\u0026#34; ) func main() { total, err := strconv.Atoi(os.Args[1]) if err != nil { panic(err) } count := 0 var wg sync.WaitGroup for i := 0; i \u0026lt; total; i++ { wg.Add(1) go func() { defer wg.Done() count++ }() } wg.Wait() fmt.Printf(\u0026#34;count: %d\\n\u0026#34;, count) fmt.Printf(\u0026#34;count == total: %t\\n\u0026#34;, count == total) } Go å®˜æ–¹æä¾›äº† Data Race Detector ç”¨äºæ¢æµ‹åç¨‹ä¹‹é—´çš„æ•°æ®ç«äº‰ï¼Œæœ‰åˆ©äºäººä»¬æ’é™¤å¹¶å‘å¼•èµ·çš„æ•…éšœã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 % go run -race count.go 1000000 ================== WARNING: DATA RACE Read at 0x00c0001ba008 by goroutine 8: main.main.func1() /Users/cosimo/vscws/go-examples/condvar/count.go:22 +0x6c Previous write at 0x00c0001ba008 by goroutine 7: main.main.func1() /Users/cosimo/vscws/go-examples/condvar/count.go:22 +0x84 Goroutine 8 (running) created at: main.main() /Users/cosimo/vscws/go-examples/condvar/count.go:20 +0x184 Goroutine 7 (finished) created at: main.main() /Users/cosimo/vscws/go-examples/condvar/count.go:20 +0x184 ================== count: 999990 count == total: false Found 1 data race(s) exit status 66 ä»¥ä¸Šåªæ˜¯å€Ÿé¢˜å‘æŒ¥ï¼Œä¸å¿™ç­‰ï¼ˆbusy waitingï¼‰å¹¶æ— å…³ç³»ï¼Œå¿™ç­‰æœ‰æ—¶è¢«ç§°ä¸ºè‡ªæ—‹ï¼ˆspinningï¼‰ã€‚æ¨¡æ‹ŸæŠ•ç¥¨ç¨‹åºä¸­çš„ä¸»åç¨‹åå¤åˆ¤æ–­æ¡ä»¶æ˜¯åœ¨æµªè´¹ CPU æ—¶é—´ï¼Œé™æ€åˆ†æå™¨å¾—å‡ºäº†ç±»ä¼¼çš„è­¦å‘Šï¼š\nthis loop will spin, using 100%% CPU (SA5002) go-staticcheck\nåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¿™ç­‰è¢«è®¤ä¸ºæ˜¯åæ¨¡å¼è€Œåº”è¯¥é¿å…ï¼Œä¸å…¶å°† CPU æ—¶é—´æµªè´¹åœ¨æ— ç”¨çš„æ´»åŠ¨ä¸Šï¼Œä¸å¦‚ç”¨äºæ‰§è¡Œå…¶å®ƒä»»åŠ¡ã€‚\n1 2 3 while (\u0026lt;condition\u0026gt;) { Thread.sleep(millis); } å³ä½¿æ˜¯åœ¨å¾ªç¯ä½“å†…ç¡çœ ï¼ŒIntelliJ IDEA ä¹Ÿå¯èƒ½æé†’é“ï¼š\nCall to \u0026lsquo;Thread.sleep()\u0026rsquo; in a loop, probably busy-waiting\nä¸è¿‡æ˜¯äº”åæ­¥ç¬‘ç™¾æ­¥ç½¢äº†ã€‚è™½ç„¶è°ƒæ•´ç¡çœ æ—¶é•¿èƒ½å‡å°‘æ¡ä»¶åˆ¤æ–­æ¬¡æ•°ï¼Œä½†æ˜¯åå¤å”¤é†’çš„æˆæœ¬ä¸å®¹å¿½è§†ï¼Œæ— æ³•æ’é™¤æµªè´¹ CPU æ—¶é—´çš„å«Œç–‘ã€‚\næ¡ä»¶å˜é‡ æœ€å°‘åŒ–çº¿ç¨‹/åç¨‹çš„ CPU æ—¶é—´æˆæœ¬ï¼Œå¹²å—ä¸ç”¨äº‹ä»¶é©±åŠ¨èŒƒå¼æŒ‡å¯¼ç¼–ç¨‹å‘¢ï¼Ÿå…·ä½“æ¥è¯´ï¼Œæ¨¡æ‹ŸæŠ•ç¥¨ç¨‹åºä¸­çš„ä¸»åç¨‹åªåœ¨ç¥¨æ•°å¯èƒ½å·²åˆ°é¢„æœŸçš„æƒ…å†µä¸‹åˆ¤æ–­æ¡ä»¶ï¼ˆè‹¥å¹²å­åç¨‹å¯¹å…±äº«å˜é‡çš„å†™å…¥å®Œæˆåé€šçŸ¥ä¸»åç¨‹ï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;math/rand\u0026#34; \u0026#34;os\u0026#34; \u0026#34;strconv\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) func main() { rand.Seed(time.Now().UnixNano()) total, err := strconv.Atoi(os.Args[1]) if err != nil { panic(err) } overHalf := total/2 + 1 count := 0 finished := 0 var mu sync.Mutex cond := sync.NewCond(\u0026amp;mu) for i := 0; i \u0026lt; total; i++ { go func() { vote := requestVote() mu.Lock() defer mu.Unlock() if vote { count++ } finished++ cond.Signal() }() } mu.Lock() for count \u0026lt; overHalf \u0026amp;\u0026amp; finished \u0026lt; total { cond.Wait() } fmt.Printf(\u0026#34;count: %d\\n\u0026#34;, count) fmt.Printf(\u0026#34;finished: %d\\n\u0026#34;, finished) fmt.Printf(\u0026#34;count \u0026gt;= overHalf: %t\\n\u0026#34;, count \u0026gt;= overHalf) mu.Unlock() } func requestVote() bool { time.Sleep(time.Duration(rand.Intn(100)) * time.Millisecond) return rand.Int()%2 == 0 } æ¡ä»¶å˜é‡ï¼ˆcondition variableï¼‰æ˜¯ä¸€ç§ä½¿çº¿ç¨‹/åç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹/åç¨‹æ‰§è¡Œç‰¹å®šæ“ä½œçš„æœºåˆ¶ï¼Œä¸äº’æ–¥é”åŒå±äºåŒæ­¥åŸè¯­ï¼ˆsynchronization primitivesï¼‰ã€‚\nä¸éš¾å‘ç°æ¡ä»¶å˜é‡æ˜¯é€šè¿‡äº’æ–¥é”æ¥åˆ›å»ºï¼Œè€Œä¸”åœ¨ç­‰å¾…ï¼ˆWait()ï¼‰ä¹‹å‰éœ€è¦å…ˆé”å®šï¼ˆLock()ï¼‰ï¼ˆJava çš„ wait/notify å’Œ Condition ä¹Ÿæœ‰ç±»ä¼¼è¦æ±‚ï¼‰ï¼Œä¸ºä»€ä¹ˆæ¡ä»¶å˜é‡éœ€è¦æˆ–è€…ä¾èµ–äº’æ–¥é”ï¼Ÿ\næ¡ä»¶å˜é‡å¯èƒ½è¢«å¹¶å‘è®¿é—®ï¼Œè€ƒè™‘å°†è®¿é—®æ¡ä»¶å˜é‡çš„ä»£ç ç§»åŠ¨åˆ°ä¸´ç•ŒåŒºï¼ˆé”å®šçš„ä»£ç å—ï¼‰ã€‚\nåç¨‹åœ¨ä¸´ç•ŒåŒºè°ƒç”¨ cond.Wait() æ—¶é‡Šæ”¾äº’æ–¥é”ï¼ˆå¦åˆ™å‡†å¤‡å‘é€é€šçŸ¥çš„åç¨‹ä¸€ç›´é”å®šå¤±è´¥ï¼‰ï¼Œå³â€œæš‚åœâ€ã€‚\nåç¨‹åœ¨ä¸´ç•ŒåŒºè°ƒç”¨ cond.Signal() æˆ– cond.Broadcast() é€šçŸ¥â€œæš‚åœâ€çš„åç¨‹å‡†å¤‡é”å®šï¼›åç¨‹é‡Šæ”¾äº’æ–¥é”åçš„æŸæ—¶åˆ»ï¼Œè¢«é€šçŸ¥çš„åç¨‹é‡è·äº’æ–¥é”æˆåŠŸåä» cond.Wait() è¿”å›ï¼Œå³â€œæ¢å¤â€ï¼ˆç»§ç»­æ‰§è¡Œå…¶ä½™ä»£ç ï¼‰ã€‚\nçƒ‚å°¾ ä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ\nä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ\nä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ\n\u0026hellip;\u0026hellip;\nåˆ«å†é—®äº†ï¼Œå‡†å¤‡å¥½äº†å°±é€šçŸ¥ä½ ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ Are â€œdata racesâ€ and â€œrace conditionâ€ actually the same thing in context of concurrent programming\nRace Condition vs. Data Race\nWhy do pthreadsâ€™ condition variable functions require a mutex?\nHow To Avoid Busy Waiting\n","date":"2021-03-08T23:05:33+08:00","permalink":"https://h2cone.github.io/2021/03/08/busy_waiting/","title":"å¿™ç­‰"},{"content":"ä¸€æ¬¡äº¤å‰ç¼–è¯‘ä½“éªŒ æœ‰ä¸€ä¸ªé¡¹ç›®ä½¿ç”¨é«˜çº§ç¼–ç¨‹è¯­è¨€åˆ›å»ºåŸç”Ÿè¿›ç¨‹ï¼ˆnative processï¼‰æ¥æ‰§è¡Œ Shell è„šæœ¬ï¼Œå…¶ä¸­æœ‰ä¸€æ®µç”¨äºç¼–è¾‘ç‰¹å®šé…ç½®æ–‡ä»¶çš„ä»£ç ç‰‡æ®µã€‚\n1 2 3 4 for name in $names; do eval expr=\u0026#39;$\u0026#39;\u0026#34;$name\u0026#34; sed -i -e \u0026#34;s/\u0026lt;@${name}@\u0026gt;/${expr}/g\u0026#34; ${file%.*}.${component_instance} done sedï¼ˆstream editorï¼‰æ˜¯ä¸€ä¸ªç”¨äºè¿‡æ»¤å’Œè½¬æ¢æ–‡æœ¬çš„ Unix ç¨‹åºã€‚\n1 2 # å°† file.txt ä¸­çš„ before å°±åœ°æ›¿æ¢ä¸º after sed -i -e \u0026#39;s/before/after/g\u0026#39; file.txt ç”¨æ³•è¿˜ç®—ç®€å•ï¼Œä½†æ˜¯ï¼Œå¦‚æœ after åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œæ¯”å¦‚ä¼ é€’åŒ…å«æ­£åˆ™è¡¨è¾¾å¼çš„å¤šè¡Œä»£ç ï¼ˆæƒ³è±¡ä¸€ä¸‹ Logstash é…ç½®ï¼‰ï¼Œè¿è¡Œæ—¶å°†ææœ‰å¯èƒ½å‘ç”Ÿç±»ä¼¼é”™è¯¯ï¼šunknown option to s'ã€‚å¦‚æœè¦å¯¹ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰ï¼Œè¿™ç§æ–¹æ¡ˆä¸ä»…å¤æ‚è¿˜æ˜“é”™ï¼Œç”šè‡³å¯èƒ½ä¼šæ›´æ”¹â€œé—´æ¥è°ƒç”¨â€ Shell è„šæœ¬çš„åº”ç”¨ç¨‹åºä»£ç ã€‚æ¢ä¸ªè§’åº¦ï¼Œsed æ˜¯å¦æœ‰æ›´å¥½çš„æ›¿ä»£å“ï¼Ÿ\næ„Ÿè°¢ä½¿ç”¨ Rust é‡å†™ä¸€åˆ‡çš„å¼€æºè½¯ä»¶ä½œè€…ä»¬ï¼Œsd å®Œå…¨å¯ä»¥ä»£æ›¿ sedï¼Œè€Œä¸”èƒ½è¯†åˆ«ç‰¹æ®Šå­—ç¬¦ã€‚\n1 sd -s before after file.txt å…´è‡´å‹ƒå‹ƒä» releases ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå´é‡åˆ°å› ä¸ºå¼€å‘/æµ‹è¯•ç¯å¢ƒçš„ glibc ç‰ˆæœ¬ä¸ç¬¦åˆ sd çš„è¦æ±‚ä»è€Œå¯¼è‡´æ— æ³•æ­£å¸¸æ‰§è¡Œã€‚\n1 2 $ ./sd-v0.7.6-x86_64-unknown-linux-musl --help ./sd-v0.7.6-x86_64-unknown-linux-musl: /lib64/libc.so.6: version `GLIBC_2.18\u0026#39; not found (required by ./sd-v0.7.6-x86_64-unknown-linux-musl) å‡çº§ glibc æœ‰ä¸€å®šé£é™©ï¼Œç®¡ç†å‘˜ä¸ä¸€å®šå…è®¸å‡çº§ï¼Œè€Œä¸”å®¢æˆ·/ç”¨æˆ·ä¹Ÿä¸ä¸€å®šå…è®¸åœ¨çº¿å®‰è£… sdã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåªéœ€è¦æå‰åœ¨æœ¬åœ°å°† sd æºä»£ç ç¼–è¯‘æˆç›®æ ‡æœåŠ¡å™¨çš„å¯æ‰§è¡Œä»£ç ï¼Œé‚£ä¹ˆç›®æ ‡æœåŠ¡å™¨å°±æ— éœ€å®‰è£… Rust æˆ–å…¶å®ƒä¸œè¥¿äº†ã€‚å¾—ç›Šäº Cross-compile and link a static binary on macOS for Linux with cargo and rustï¼ŒæˆåŠŸåœ¨ macOS Big Sur ä¸Šå°† sd æºä»£ç ç¼–è¯‘æˆå¼€å‘/æµ‹è¯•ç¯å¢ƒçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚\n1 2 $ file sd sd: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, not stripped æ‰€è°“äº¤å‰ç¼–è¯‘ï¼Œå³å°†æºæ–‡ä»¶ä»è¿è¡Œç¼–è¯‘å™¨çš„å¹³å°ç”Ÿæˆå¯åœ¨å…¶å®ƒå¹³å°æ‰§è¡Œçš„æ–‡ä»¶ã€‚é™¤äº† Rust å¤©ç„¶æ”¯æŒäº¤å‰ç¼–è¯‘ ï¼Œå…¶å®ƒä¸»æµè¯­è¨€åšå¾—åˆ°å—ï¼ŸGo å¼€ç®±å³æ”¯æŒäº¤å‰ç¼–è¯‘ã€‚\nAOT å’Œ JIT Java å°±éº»çƒ¦å¾—å¤šäº†ã€‚Oracle Java ç¼–è¯‘å™¨ï¼ˆjavacï¼‰å¹¶ä¸èƒ½å°† Java æºä»£ç ï¼ˆSource Codeï¼‰ç¼–è¯‘æˆåŸç”Ÿå¯æ‰§è¡Œä»£ç ï¼Œè€Œåªèƒ½ç¼–è¯‘æˆ Java å­—èŠ‚ç ï¼ˆBytecodeï¼‰ã€‚\nJava å­—èŠ‚ç é€šå¸¸ä¸å¹³å°æ— å…³ï¼ˆplatform-independentï¼‰ï¼Œç”± Java è™šæ‹Ÿæœºçš„è§£é‡Šå™¨ï¼ˆBytecode Interpreterï¼‰æ‰§è¡Œï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼ŒSun ç”¨â€œç¼–å†™ä¸€æ¬¡ï¼Œåˆ°å¤„è¿è¡Œâ€çš„å£å·æ¥è¯´æ˜ Java çš„è·¨å¹³å°ä¼˜åŠ¿ï¼ŒJava è·¨å¹³å°æ˜¯å› ä¸º Java è™šæ‹Ÿæœºä¸è·¨å¹³å°ï¼Œä¸åŒçš„å¹³å°å®‰è£…ä¸åŒçš„ Java è™šæ‹Ÿæœºæ‰å¯èƒ½è¿è¡Œç›¸åŒçš„ Java ç¨‹åºï¼ˆä¸åŒå¹³å°çš„ Java å­—èŠ‚ç è§£é‡Šå™¨å¯ä»¥æ‰§è¡Œç›¸åŒçš„å­—èŠ‚ç ï¼‰ã€‚\nå½“ Java å­—èŠ‚ç ç”±è§£é‡Šå™¨æ‰§è¡Œæ—¶ï¼Œæ€»æ˜¯æ¯”ç¼–è¯‘ä¸ºåŸç”Ÿæœºå™¨ç çš„åŒä¸€ç¨‹åºæ‰§è¡Œæ…¢ã€‚JIT ç¼–è¯‘å™¨ï¼ˆJIT Compilerï¼‰ä¸“é—¨ç¼“è§£æ­¤é—®é¢˜ï¼ŒJIT ç¼–è¯‘å™¨é€šå¸¸åœ¨è¿è¡Œæ—¶å°† Java å­—èŠ‚ç ç¼–è¯‘æˆåŸç”Ÿæœºå™¨ç ï¼ˆNative/Machine Codeï¼‰ï¼Œåˆç§°åŠ¨æ€ç¼–è¯‘ã€‚ç›¸å¯¹åœ°è¯´ï¼Œé™æ€ç¼–è¯‘åˆå AOT ç¼–è¯‘ï¼ˆAhead-of-time compilationï¼‰ï¼ŒAOT ç¼–è¯‘å™¨çš„ç¼–è¯‘è¿‡ç¨‹ï¼ˆä»æºä»£ç åˆ°åŸç”Ÿæœºå™¨ç ï¼‰å‘ç”Ÿåœ¨ç¨‹åºè¿è¡Œä¹‹å‰ã€‚\n1 2 3 4 5 6 #include \u0026lt;stdio.h\u0026gt; int main() { printf(\u0026#34;hello, world\\n\u0026#34;); } ä¸€ä¸ªè¡¨é¢ä¸Šéå¸¸ç®€å•çš„ C è¯­è¨€ç¨‹åºï¼ˆhello.cï¼‰ï¼Œä½¿ç”¨ GCC ç¼–è¯‘åè¾“å‡ºå¯æ‰§è¡Œçš„ç›®æ ‡ç¨‹åºï¼ˆhelloï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬äº† AOT ç¼–è¯‘ã€‚\n1 % gcc -o hello hello.c å¯æ‰§è¡Œè‡³å°‘æ„å‘³ç€å¯é€šè¿‡ ./ æ‰§è¡Œã€‚\n1 2 % ./hello hello, world å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿäº†è§£ç¼–è¯‘ç³»ç»Ÿå¦‚ä½•å·¥ä½œï¼Œå¯¹å°†æ¥ä¼˜åŒ–ç¨‹åºæ€§èƒ½æœ‰ç›Šå¤„ã€‚\nï¼ˆæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆåŸä¹¦ç¬¬3ç‰ˆï¼‰1.2 ç¨‹åºè¢«å…¶ä»–ç¨‹åºç¿»è¯‘æˆä¸åŒçš„æ ¼å¼ï¼‰\n1 2 % file hello hello: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=dd72445243a497f2f62a1e5d19185ca41181e4b5, not stripped JIT ç¼–è¯‘å™¨é€šå¸¸åœ¨é¢„çƒ­ï¼ˆwarmupï¼‰æœŸå·¥ä½œï¼Œè™½ç„¶ Java ç¨‹åºå¯åŠ¨é€Ÿåº¦ä¼šå—åˆ°å½±å“ï¼Œä½†æ˜¯æ–¹æ³•è°ƒç”¨ï¼ˆMethod Invocationï¼‰å‘ç”Ÿæ—¶ï¼ŒJava è™šæ‹Ÿæœºå°†é€šè¿‡åˆ†ææ•°æ®ï¼ˆProfilingï¼‰ç§¯æåº”ç”¨ä¼˜åŒ–ã€‚ä¾‹å¦‚ï¼Œå°†è°ƒç”¨æ¬¡æ•°å·²è¾¾é˜ˆå€¼çš„æ–¹æ³•ï¼ˆçƒ­ç‚¹ä»£ç ï¼‰ç¼–è¯‘æˆåŸç”Ÿæœºå™¨ç å¹¶å†™å…¥ä»£ç ç¼“å­˜ï¼ˆCode Cacheï¼‰ï¼Œä»£ç ç¼“å­˜çš„å®¹é‡å¯ä»¥é€šè¿‡é€‰é¡¹ -XX:ReservedCodeCacheSize è®¾ç½®ï¼›å°†æ¥è°ƒç”¨åŒä¸€æ–¹æ³•æ—¶ï¼Œä¸æ˜¯è§£é‡Šæ‰§è¡Œï¼ˆåŸºäº Stack Machineï¼‰ï¼Œè€Œæ˜¯ä»ç¼“å­˜è¯»å–åŸç”Ÿæœºå™¨ç ç›´æ¥æ‰§è¡Œï¼ˆåŸºäº Register Machineï¼‰ã€‚\nåœ¨ç”ŸæˆåŸç”Ÿæœºå™¨ç ä¹‹å‰ï¼ŒJIT ç¼–è¯‘å™¨ä¼šå…ˆç§¯æä¼˜åŒ–å­—èŠ‚ç ã€‚ä¾‹å¦‚ï¼Œæ–¹æ³•å†…è”ï¼ˆMethod Inliningï¼‰ã€é€ƒé€¸åˆ†æï¼ˆEscape Analysisï¼‰ã€å¾ªç¯å±•å¼€ï¼ˆLoop unrollingï¼‰ã€é”ç²—åŒ–ï¼ˆLock Coarseningï¼‰ã€é”æ¸…é™¤ï¼ˆLock Elisionï¼‰ ç­‰ç­‰ã€‚\nç”±äº Java è™šæ‹Ÿæœºéšè—äº†æ“ä½œç³»ç»Ÿå…·ä½“å®ç°çš„å¤æ‚æ€§ï¼Œå¹¶ç»™åº”ç”¨ç¨‹åºæä¾›äº†ç®€å•æˆ–ç»Ÿä¸€çš„æ¥å£ï¼Œéšç€ Java è™šæ‹Ÿæœºçš„è¿­ä»£å‡çº§ï¼Œå³ä½¿è¿è¡ŒåŒä¸€ç¨‹åºï¼Œä¹Ÿèƒ½å®ç°æ›´é«˜çš„æ€§èƒ½ã€‚Oracle çš„ Java é»˜è®¤è™šæ‹Ÿæœºæ˜¯ HotSpot JVMï¼ŒHotSpot JVM ç”¨ C++ ç¼–å†™è€Œæˆï¼Œå®ƒæœ‰ä¸¤ä¸ª JIT ç¼–è¯‘å™¨ï¼ŒC1 å’Œ C2ã€‚\nC1 é€‚ç”¨äº Clientï¼ˆjava â€“clientï¼‰ï¼Œå¯åŠ¨å¿«ï¼Œä½†å³°å€¼æ€§èƒ½å—æŸï¼›C2 é€‚ç”¨äº Serverï¼ˆjava â€“serverï¼‰ï¼Œéå¸¸é€‚åˆç¼–è¯‘çƒ­ç‚¹æ–¹æ³•ï¼Œä½†å¯åŠ¨æ…¢ï¼ˆçƒ­èº«ï¼‰ã€‚æƒè¡¡åˆ©å¼Šçš„ç»“æœå¯èƒ½æ˜¯ç»„åˆä½¿ç”¨ C1 å’Œ C2ï¼ŒJava 8 åé»˜è®¤å¼€å¯å¤šå±‚ç¼–è¯‘ï¼ˆ-XX:+TieredCompilationï¼‰ï¼Œå…ˆä»¥ C1 ç¼–è¯‘ï¼Œé‡‡æ ·è¶³å¤Ÿåä»¥ C2 ç¼–è¯‘ã€‚\næ‰€è°“çš„ JVM æ€§èƒ½è°ƒä¼˜ï¼Œé€šå¸¸èšç„¦åœ¨å†…å­˜ä¸ GCï¼Œè‹¥ä¸è€ƒè™‘åº”ç”¨ç¨‹åºå¯èƒ½åŒ…å«ä½æ•ˆçš„éƒ¨åˆ†ï¼Œé‚£ä¸å¦¨è°ƒå‚ï¼ˆé€‰é¡¹æˆ–æ ‡è®°ï¼‰ ä¹‹åæµ‹è¯•æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚çœŸé‡åˆ°äº†éœ€è¦ç›‘è§† JIT çš„åœºæ™¯ï¼Œæ¢è¨€ä¹‹æ˜¯ä¸ºäº†æ€§èƒ½ä¼˜åŒ–æˆ–æ•…éšœæ’æŸ¥çš„ç›®çš„åˆ†æ JIT æ—¥å¿—ï¼Œå‘è§‰æ—¥å¿—éš¾è¯»ï¼Œä½†å¥½åœ¨å‘ç°ä¸€æ¬¾ JIT æ—¥å¿—åˆ†æä¸å¯è§†åŒ–å·¥å…·â€”â€”jitwatchã€‚\nGraalVM å’Œ LLVM é€€ä¸€æ­¥æ¥è¯´ï¼Œå€ŸåŠ©è™šæ‹Ÿæœºå¯ä»¥åœ¨ç¼–è¯‘æ—¶å°† Java ç¨‹åºç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚Oracle çš„ GraalVM çš„é™„åŠ ç»„ä»¶åŒ…æ‹¬äº†ä¸€ç§å°† Java åº”ç”¨ç¨‹åº AOT ç¼–è¯‘ä¸ºåŸç”Ÿå¯æ‰§è¡Œæ–‡ä»¶çš„æŠ€æœ¯ï¼Œåä¸º Native Imageã€‚\nGraalVM æ˜¯ç”¨äºè¿è¡Œä»¥ JavaScriptã€Pythonã€Rubyã€Rã€åŸºäº JVM çš„è¯­è¨€ï¼ˆä¾‹å¦‚ Javaã€Scalaï¼ŒClojureï¼ŒKotlinï¼‰ã€åŸºäº LLVM çš„è¯­è¨€ï¼ˆä¾‹å¦‚ C å’Œ C ++ï¼‰ç¼–å†™çš„åº”ç”¨ç¨‹åºçš„é€šç”¨è™šæ‹Ÿæœºã€‚\nGraalVM Native Image æŠ€æœ¯å­˜åœ¨ä¸å®¹å¿½è§†çš„é™åˆ¶ï¼ŒåŸå› ä¹‹ä¸€æ˜¯ AOT ç¼–è¯‘å‚è€ƒçš„é™æ€ä¿¡æ¯æœ‰æ—¶æ˜¯ä¸å¤Ÿçš„ï¼Œå¹¶ä¸”å¾ˆéš¾çŒœæµ‹åº”ç”¨ç¨‹åºçš„å®é™…è¡Œä¸ºã€‚ä¸ºäº†èƒ½å¤Ÿæ„å»ºé«˜åº¦ä¼˜åŒ–çš„åŸç”Ÿå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒGraalVM ä¼šè¿è¡Œç§¯æçš„é™æ€åˆ†æï¼Œåœ¨ç¼–è¯‘æ—¶å¿…é¡»çŸ¥é“æ‰€æœ‰å¯è®¿é—®çš„ç±»å’Œå­—èŠ‚ç ï¼Œå¦åˆ™ Java çš„åŠ¨æ€ç‰¹æ€§ï¼ˆä¾‹å¦‚åŠ¨æ€ç±»åŠ è½½ã€åå°„ã€åŠ¨æ€ä»£ç†ç­‰ç­‰ï¼‰ä¸¥é‡å—é™ï¼Œç”šè‡³ä¸å¯ç”¨ã€‚å› æ­¤ï¼ŒGraalVM Native Image å…¼å®¹å’Œä¼˜åŒ–æŒ‡å—å»ºè®®ç”¨æˆ·ç¼–å†™é…ç½®æ–‡ä»¶â€œæç¤ºâ€ GraalVM åšæ­£ç¡®çš„äº‹æƒ…ã€‚\nGraalVM Native Image æš‚ä¸æ”¯æŒäº¤å‰ç¼–è¯‘ï¼Œä½†ä¸æ„å‘³ä¸èƒ½åœ¨ä¸€ä¸ªå¹³å°æ„å»ºå‡ºå…¶å®ƒå¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿ç”¨ æ“ä½œç³»ç»Ÿçº§åˆ«çš„è™šæ‹ŸåŒ–å³å¯ï¼Œä¾‹å¦‚åœ¨æœ¬åœ°ä¸‹è½½å„ä¸ªå¹³å°çš„ GraalVM Docker é•œåƒï¼Œä»¥æ­¤ä¸ºåŸºç¡€æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶çš„é•œåƒã€‚\nGraalVM ä¹‹æ‰€ä»¥èƒ½è¿è¡Œä¸åŒç§ç±»çš„è¯­è¨€ç¼–å†™è€Œæˆçš„åº”ç”¨ç¨‹åºçš„åŸå› ä¹‹ä¸€æ˜¯ GraalVM çš„æ ¸å¿ƒç»„ä»¶ä¸é™„åŠ ç»„ä»¶åŒ…å«äº†å¤šç§è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰ã€‚æ¯”å¦‚è¿è¡Œ Javaã€JavaScript/Node.jsã€C/C++ ç¨‹åºæ‰€éœ€çš„ç¯å¢ƒï¼š\nJava HotSpot VM Node.js JavaScript runtime LLVM runtime LLVM æ˜¯æ¨¡å—åŒ–å’Œå¯é‡ç”¨çš„ç¼–è¯‘å™¨ä¸å·¥å…·é“¾æŠ€æœ¯çš„é›†åˆã€‚\nLLVM ä¸æ˜¯é€šç”¨è™šæ‹Ÿæœºï¼ˆVMï¼‰ï¼Œä½†ä½¿ç”¨ LLVM çš„ç¼–ç¨‹è¯­è¨€éå¸¸ä¹‹å¤šï¼ˆä»LLVM çš„ç»´åŸºç™¾ç§‘è¯æ¡ç¬¬äºŒæ®µå¯ä»¥ä½“ä¼šåˆ°ï¼‰ã€‚\nLLVM ç¼–è¯‘å™¨é€šå¸¸åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šå‰ç«¯ï¼ˆfrond-endï¼‰ã€ä¸­ç«¯ï¼ˆmiddle-endï¼‰ã€åç«¯ï¼ˆback-endï¼‰ã€‚\nå‰ç«¯ï¼šå°†æºç ç¼–è¯‘ä¸º IRã€‚ ä¸­ç«¯ï¼šä¼˜åŒ– IRã€‚ åç«¯ï¼šå°† IR ç¼–è¯‘ä¸ºæœºå™¨ç ã€‚ IR æ˜¯ä¸­é—´è¡¨ç¤ºï¼ˆIntermediate representationï¼‰çš„ç®€ç§°ï¼Œå®ƒæ˜¯ä¸€ç§ä¸å¹³å°æ— å…³ï¼ˆplatform-independentï¼‰çš„ä»£ç /æŒ‡ä»¤ã€‚\n1 % clang-11 hello.c -o hello ä¾‹å¦‚ï¼Œä½¿ç”¨ Clang ç¼–è¯‘ç®€å•çš„ C è¯­è¨€ç¨‹åºï¼ˆhello.cï¼‰ï¼Œæœ€ç»ˆå¾—åˆ°å…¶å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆhelloï¼Œå¦‚æœæƒ³è§‚çœ‹ LLVM IR çš„æ¨¡æ ·ï¼Œä¸å¦¨è¯•è¯•åœ¨æµè§ˆå™¨ç¼–è¯‘ C è¯­è¨€ç¨‹åºï¼‰ã€‚\n1 2 % file hello hello: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=bf54bb50604533e477e6e42d576c573f88f2a986, not stripped å½“æˆ‘ä»¬æƒ³åˆ›å»ºæ–°çš„ç¼–ç¨‹è¯­è¨€æ—¶ï¼Œå¯ä»¥ä¸å¿…èŠ±è´¹æ—¶é—´å’Œç²¾åŠ›å»é‡æ–°å‘æ˜é‚£äº›ç‰¹å®šçš„è½®å­ï¼ˆä¾‹å¦‚ç”¨äºç¼–è¯‘ä¸ä¼˜åŒ–çš„å·¥å…·ï¼‰ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ LLVM å®ç°è¯­è¨€ã€‚\nä»ç¼–è¯‘æ—¶å¼€å§‹é‡ç”¨ ç¨‹åºå‘˜ä»¬æ—¥å¸¸ä½¿ç”¨çš„å„ç§åº“ï¼ˆLibraryï¼‰æˆ–æ¡†æ¶ï¼ˆFrameworkï¼‰æ€»æ˜¯ä»ç¼–è¯‘æ—¶å¼€å§‹é‡ç”¨ï¼ˆReuseï¼‰ï¼Œé‚£æ—¶ï¼Œå½·ä½›ç«™åœ¨äº†å·¨äººçš„è‚©è†€ä¸Šã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ Wiki # Ahead-of-time compilation\nWiki # Just-in-time compilation\nJVM JIT-compiler overview\nåŸºæœ¬åŠŸ | Javaå³æ—¶ç¼–è¯‘å™¨åŸç†è§£æåŠå®è·µ\nThe Java HotSpot VM Under the Hood\nThe Java programming language Compiler Group\nWiki # Java performance\nWhat is LLVM? The power behind Swift, Rust, Clang, and more\nLLVM IR and Go\n","date":"2021-01-22T10:20:35+08:00","permalink":"https://h2cone.github.io/2021/01/22/some_things_about_compilation/","title":"ç¼–è¯‘çš„ä¸€äº›äº‹"},{"content":"å‰é¢çš„è¯ æœ‰ä¸€ä¸ªé¡¹ç›®ä½¿ç”¨äº† Vert.x 3ï¼Œæ²¡æƒ³åˆ° v4.0.0 å·²ç»å‘å¸ƒã€‚\nä»€ä¹ˆæ˜¯ Vert.x Vert.x æ˜¯ç”¨äºåœ¨ JVM ä¸Šæ„å»º Reactive åº”ç”¨ç¨‹åºçš„å·¥å…·åŒ…ã€‚\næ—©åœ¨ 2014 å¹´ååº”å¼å®£è¨€å°±æå‡ºååº”å¼ï¼ˆReactiveï¼‰åº”ç”¨ç¨‹åº/è½¯ä»¶ç³»ç»Ÿåº”å…·æœ‰ååº”çµæ•ï¼ˆResponsiveï¼‰ã€å›å¼¹æ€§ï¼ˆResilientï¼‰ã€å¼¹æ€§ï¼ˆElasticï¼‰ã€æ¶ˆæ¯é©±åŠ¨ï¼ˆMessage Drivenï¼‰ç­‰ç‰¹å¾ï¼Œè¿™äº›è«åå…¶å¦™çš„è¦æ±‚å¯ä»¥å½’å±äºå‰æ–‡å¸¸å¸¸æåˆ°çš„è½¯ä»¶ç³»ç»Ÿä¸‰å¤§ç›®æ ‡ã€‚\nVert.x å—åˆ°äº† Node.js å¯å‘ï¼Œæ¨èçš„ç¼–ç¨‹èŒƒå¼æ˜¯äº‹ä»¶é©±åŠ¨ï¼Œäº‹ä»¶å¯ä»¥ç”±è½¯ä»¶ã€ç”¨æˆ·ã€ç³»ç»Ÿäº§ç”Ÿæˆ–è§¦å‘ï¼Œå¤„ç†äº‹ä»¶çš„å‡½æ•°é€šå¸¸è¢«ç§°ä¸º Event Handlerã€‚\n1 2 3 4 5 6 7 8 9 10 11 import io.vertx.core.AbstractVerticle; public class Server extends AbstractVerticle { public void start() { vertx.createHttpServer().requestHandler(req -\u0026gt; { req.response() .putHeader(\u0026#34;content-type\u0026#34;, \u0026#34;text/plain\u0026#34;) .end(\u0026#34;Hello from Vert.x!\u0026#34;); }).listen(8080); } } å¦‚ä¸Šæ‰€ç¤ºï¼Œä½¿ç”¨ Vert.x ç¼–å†™ä¸€ä¸ªç®€å•çš„ HTTP Serverï¼Œå…¶ä¸­ requestHandler æ–¹æ³•ä¼ å…¥äº†ç”¨äºå¤„ç†è¯·æ±‚äº‹ä»¶çš„ Handlerï¼ŒHandler è¡¨ç°ä¸ºå›è°ƒå‡½æ•°ï¼Œå³ CallÂ­backï¼›å…¶ä¸­ listen æ–¹æ³•æ˜¯éé˜»å¡æ–¹æ³•ï¼Œçº¿ç¨‹è°ƒç”¨éé˜»å¡æ–¹æ³•ä¸ä¼šè¢«é˜»å¡åœ¨è¯¥æ–¹æ³•ï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œå…¶å®ƒä»£ç ï¼›éé˜»å¡å‡½æ•°æœ‰æ—¶è¢«ç§°ä¸ºå¼‚æ­¥å‡½æ•°ï¼Œè¿”å›å€¼å¯ä»¥è¢«ç§°ä¸ºå¼‚æ­¥ç»“æœï¼Œä»…ä½¿ç”¨ Callback å¤„ç†å¼‚æ­¥ç»“æœå¯èƒ½å¯¼è‡´åµŒå¥—å’Œå‡Œä¹±çš„ä»£ç ï¼Œè¢«ç§°ä¸ºå›è°ƒåœ°ç‹±ã€‚Vert.x æ”¯æŒ FuÂ­tures/Promises å’Œ RxJavaï¼Œå‰è€…ç”¨äºä¼˜é›…åœ°é“¾å¼å¼‚æ­¥æ“ä½œï¼Œåè€…ç”¨äºé«˜çº§ååº”å¼ç¼–ç¨‹ã€‚\nVert.x çš„éé˜»å¡ I/O åŸºäº Nettyï¼Œåœ¨æ­¤ä¹‹ä¸Šæ„å»º Vert.x Core å’Œ Web åç«¯æŠ€æœ¯æ ˆï¼šååº”å¼æ•°æ®åº“é©±åŠ¨ã€æ¶ˆæ¯ä¼ é€’ã€äº‹ä»¶æµã€é›†ç¾¤ã€æŒ‡æ ‡åº¦é‡ã€åˆ†å¸ƒå¼è¿½è¸ªç­‰ï¼Œè¯¦æƒ…è¯·è§ Vert.x Documentationã€‚\nVert.x çš„äº‹ä»¶æ¨¡å‹å»¶ç”¨ Netty çš„ Event Loopï¼Œæ¬²äº†è§£æ¥é¾™å»è„‰å¯ä» ç½‘ç»œÂ·NIO å¼€å§‹ã€‚\nVerticle æ˜¯ Vert.x ä¸­çš„åŸºæœ¬å¤„ç†å•å…ƒï¼ŒVerticle å®ä¾‹ä¹‹é—´é€šè¿‡ Event Bus é€šä¿¡ã€‚Java ä¼ ç»Ÿçš„å¹¶å‘æ¨¡å‹æ˜¯å…±äº«å†…å­˜å¤šçº¿ç¨‹ï¼ˆshared memory multithreadingï¼‰ï¼Œå¦‚åŒå‰æ–‡ å¤šçº¿ç¨‹Â·å¹¶å‘ç¼–ç¨‹ æ‰€è¯´ï¼Œä½†æ˜¯è®¡ç®—æœºä¸–ç•Œè¿˜å­˜åœ¨ç€å…¶å®ƒå¹¶å‘æ¨¡å‹ï¼Œä¾‹å¦‚ CSP å’Œ Actor modelï¼ŒVerticles å°±æ˜¯å®½æ¾çš„ Actorsã€‚\næ„å»ºååº”å¼åº”ç”¨ç¨‹åº/è½¯ä»¶ç³»ç»Ÿå¹¶é Vert.x ä¸å¯ï¼Œåªä¸è¿‡ Netty çš„ APIs æ›´åº•å±‚ï¼›äº‘åŸç”Ÿï¼ˆcloud nativeï¼‰æ—¶ä»£çš„ Quarkus æŠ€æœ¯æ ˆæ”¯æŒååº”å¼ï¼ŒJava ç”¨æˆ·ä½¿ç”¨æœ€å¤šçš„ Spring æŠ€æœ¯æ ˆä¹Ÿæ”¯æŒååº”å¼ï¼Œéä¸€èˆ¬åœºæ™¯å¯ä»¥è€ƒè™‘ Akkaã€‚\nä»€ä¹ˆæ˜¯ Hazelcast IMDG Hazelcast æœ‰ä¸€ä¸ªå¼€æºåˆ†å¸ƒå¼å†…å­˜å¯¹è±¡å­˜å‚¨ï¼ˆin-memory object storeï¼‰ï¼Œåä¸º Hazelcast IMDGï¼ŒIMDG æ˜¯ In-Memory Data Grid çš„ç¼©å†™ï¼ŒIMDG ä¸å†…å­˜æ•°æ®åº“æœ‰æ‰€ä¸åŒï¼Œåè€…é€šå¸¸éœ€è¦ç”¨æˆ·å¤„ç†å¯¹è±¡åˆ°å…³ç³»çš„æ˜ å°„ï¼ˆORMï¼‰ï¼Œå‰è€…æ”¯æŒå„ç§å„æ ·çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ Mapã€Setã€Listã€MultiMapã€RingBufferã€HyperLogLog ç­‰ã€‚\nHazelcast IMDG çš„æ¶æ„ä¸åˆ†å¸ƒå¼åè°ƒæœåŠ¡â€”â€”Zookeeperã€åˆ†å¸ƒå¼ Key-Value å­˜å‚¨â€”â€”etcdã€ç«¯åˆ°ç«¯æœåŠ¡å‘ç°è§£å†³æ–¹æ¡ˆâ€”â€”Consul æˆªç„¶ä¸åŒï¼Œå®ƒçš„å®šä½æ›´æ¥è¿‘åˆ†å¸ƒå¼ç¼“å­˜ï¼Œå¹¶ä¸”æ— éœ€ Server ç«¯ï¼Œåªéœ€ Client ç«¯çš„ç‚¹åˆ°ç‚¹é€šä¿¡ï¼ˆP2Pï¼‰ã€‚\nHazelcast é›†ç¾¤ï¼ˆHazelcast Clusterï¼‰æˆå‘˜ï¼ˆHazelcast Memberï¼‰ä¹‹é—´ä¸ºä»€ä¹ˆéœ€è¦é€šä¿¡ï¼Ÿ\nHazelcast æˆå‘˜ä¹‹é—´å…±äº«æ•°æ®çš„æœºåˆ¶æ˜¯æ•°æ®åˆ†åŒºä¸æ•°æ®å¤åˆ¶ï¼Œä¸¤è€…ç»“åˆåœ¨ä¸€èµ·çš„å›¾åƒå¯ä»¥å…ˆå‚è€ƒä¸ºä»€ä¹ˆåˆ†åŒºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒHazelcast æä¾› 271 ä¸ªåˆ†åŒºï¼Œä¸ºæ¯ä¸ªåˆ†åŒºåˆ›å»ºå•ä¸€æ‹·è´/å‰¯æœ¬ï¼Œå¯é…ç½®ä¸ºå¤šå‰¯æœ¬ã€‚\nä¸Šå›¾æ˜¯ 4 æˆå‘˜/ç»“ç‚¹çš„ Hazelcast é›†ç¾¤çš„ç¤ºæ„å›¾ï¼Œå‡è®¾åˆ†åŒºç¼–å·ä» P_1 åˆ° P_136ï¼Œé»‘è‰²ç¼–å·åˆ†åŒºä»£è¡¨ä¸»å‰¯æœ¬ï¼ˆprimary replicasï¼‰ï¼Œè“è‰²ç¼–å·åˆ†åŒºä»£è¡¨å¤‡å‰¯æœ¬ï¼ˆbackup replicasï¼‰ï¼Œæ•°æ®å¤åˆ¶æ–¹å‘ä¸ºä¸»åˆ°å¤‡ã€‚\næ•°æ®åˆ†åŒºä¸æ•°æ®å¤åˆ¶å¯¹ç”¨æˆ·é€æ˜æ˜¯ç°ä»£åˆ†å¸ƒå¼å­˜å‚¨çš„åŸºæœ¬ç‰¹æ€§ã€‚æ·»åŠ æˆå‘˜åˆ° Hazelcast é›†ç¾¤æ—¶ä¸ Redis ä¸åŒï¼ŒHazelcast ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œä»…ç§»åŠ¨æœ€å°æ•°é‡çš„åˆ†åŒºå³å¯æ¨ªå‘æ‰©å±•ã€‚\nHazelcast å¦‚ä½•ä¿è¯ä¸€è‡´æ€§ä¸å¯ç”¨æ€§ï¼Ÿ\nHazelcast æä¾›äº†å…·æœ‰ä¸åŒæ•°æ®ç»“æ„å®ç°çš„ AP å’Œ CP åŠŸèƒ½ã€‚æ ¹æ® CAP (Consistency, Availability and Partition Tolerance) ç»éªŒæ³•åˆ™ï¼ŒHazelcast çš„ AP æ•°æ®ç»“æ„ä¾§é‡å¯ç”¨æ€§ï¼Œè€Œ Hazelcast çš„ CP å­ç³»ç»Ÿåˆ™ä¾§é‡ä¸€è‡´æ€§ã€‚\nä½¿ç”¨ Hazelcast å®ç° Vert.x é›†ç¾¤ Vert.x é›†ç¾¤æ— éœ€æ³¨å†Œä¸­å¿ƒï¼ˆService Registryï¼‰å³å¯å»ºç«‹ï¼Œå› ä¸º Vert.x å®ä¾‹ä¹‹é—´å¯ä»¥é€šè¿‡ Hazelcast Client Library ç›¸äº’å‘ç°ï¼ˆDiscoveryï¼‰ã€‚\nä½¿ç”¨ Hazelcast Cluster Manager å¯ä»¥é™ä½ Vert.x é›†æˆ/æ•´åˆ Hazelcast çš„æˆæœ¬ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸æŒ‡å®šå¤–éƒ¨é…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆé›†ç¾¤ç®¡ç†å™¨ç”±æ‰“åŒ…åœ¨ vertx-hazelcast-4.0.0.jar å†…çš„ default-cluster.xml é…ç½®ï¼Œå…¶ä¸­é»˜è®¤çš„å‘ç°æœºåˆ¶æ˜¯ Multicastã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œçº¢è‰²æˆå‘˜å‘é€ç‰¹å®šæŠ¥æ–‡åˆ°ç›‘å¬ç‰¹å®šç«¯å£çš„ä¸€ç»„ç»¿è‰²æˆå‘˜ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå‘ç°å½¼æ­¤ã€‚\n1 2 3 4 5 6 7 8 9 10 11 hazelcast: network: join: multicast: enabled: true multicast-group: 224.2.2.3 multicast-port: 54327 # UDP port multicast-time-to-live: 32 multicast-timeout-seconds: 2 trusted-interfaces: - 192.168.1.102 ä½¿ç”¨ Multicast æœ€å¸¸è§çš„ä¼ è¾“å±‚åè®®æ˜¯ UDPï¼›ç„¶è€Œï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Multicast å‘ç°ï¼Œå› ä¸º UDP åœ¨ç”Ÿäº§ç¯å¢ƒå¯èƒ½è¢«é˜»æ­¢ï¼ˆå‡ºäºå®‰å…¨è€ƒè™‘ï¼‰å¹¶ä¸”å…¶å®ƒå‘ç°æœºåˆ¶æ›´åŠ ç²¾ç¡®ï¼Œä¾‹å¦‚ TCP/IP å‘ç°ï¼Œå…¶å®ƒå¯å‚è€ƒ Discovery Mechanismsã€‚\n1 2 3 4 5 6 7 8 9 10 11 hazelcast: network: join: tcp-ip: enabled: true member-list: - machine1 - machine2 - machine3:5799 - 192.168.1.0-7 - 192.168.1.21 å½¢æˆäº†é›†ç¾¤ä¹‹åï¼Œé›†ç¾¤æˆå‘˜ä¹‹é—´çš„é€šä¿¡å§‹ç»ˆé€šè¿‡ TCP/IP è¿›è¡Œï¼›æ–¹ä¾¿å±•ç¤ºèµ·è§ï¼Œä¸‹æ–‡çš„ç¨‹åºé‡‡ç”¨ç®€åŒ–çš„æœåŠ¡ç”Ÿäº§è€…ï¼ˆProviderï¼‰ä¸æœåŠ¡æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰æ¨¡å¼ï¼š\né¦–å…ˆæ˜¯æœåŠ¡ç”Ÿäº§è€…ï¼Œè¯¥ Verticle çš„å¯åŠ¨æ–¹æ³•ï¼ˆstartï¼‰å†…ä»…ä»…æ˜¯è®¢é˜…/æ¶ˆè´¹ï¼ˆconsumerï¼‰EventBus ä¸­çš„ç‰¹å®šäº‹ä»¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public class DefaultProvider extends AbstractVerticle { private static final Logger log = LoggerFactory.getLogger(DefaultProvider.class); @Override public void start(Promise\u0026lt;Void\u0026gt; startPromise) throws Exception { vertx.eventBus().\u0026lt;JsonObject\u0026gt;consumer(BusAddress.TEST_REQUEST, msg -\u0026gt; { JsonObject body = msg.body(); log.debug(\u0026#34;consume from {}, message body: {}\u0026#34;, BusAddress.TEST_REQUEST, body); if (Objects.nonNull(body)) { body.put(\u0026#34;consumed\u0026#34;, true); } msg.reply(body); }); vertx.eventBus().\u0026lt;JsonObject\u0026gt;consumer(BusAddress.TEST_SEND, msg -\u0026gt; { JsonObject body = msg.body(); log.debug(\u0026#34;consume from {}, message body: {}\u0026#34;, BusAddress.TEST_SEND, body); }); vertx.eventBus().\u0026lt;JsonObject\u0026gt;consumer(BusAddress.TEST_PUBLISH, msg -\u0026gt; { JsonObject body = msg.body(); log.debug(\u0026#34;consume from {}, message body: {}\u0026#34;, BusAddress.TEST_PUBLISH, body); }); } } ä¹‹æ‰€ä»¥è¯´ç‰¹å®šäº‹ä»¶æ˜¯ç”±äºæœåŠ¡æ¶ˆè´¹è€…å°†äº‹ä»¶å‘é€åˆ° EventBus ä¸­çš„ç‰¹å®šåœ°å€ã€‚\n1 2 3 4 5 6 7 public interface BusAddress { String TEST_REQUEST = \u0026#34;test.request\u0026#34;; String TEST_SEND = \u0026#34;test.send\u0026#34;; String TEST_PUBLISH = \u0026#34;test.publish\u0026#34;; } ç„¶åæ˜¯æœåŠ¡æ¶ˆè´¹è€…ï¼Œè¯¥ Verticle ä½œä¸º HTTP Serverï¼ŒåŒæ—¶æ¼”ç¤ºäº† requestã€sendã€publish ä¸‰ç§å‘é€äº‹ä»¶åˆ° EventBus æ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 public class HttpServer extends AbstractVerticle { private static final Logger log = LoggerFactory.getLogger(HttpServer.class); @Override public void start(Promise\u0026lt;Void\u0026gt; startPromise) throws Exception { ConfigRetriever retriever = ConfigRetriever.create(vertx); retriever.getConfig(json -\u0026gt; { JsonObject config = json.result(); Integer port = config.getInteger(\u0026#34;http.port\u0026#34;, 8080); Router router = Router.router(vertx); router.get(\u0026#34;/hello\u0026#34;).handler(this::hello); router.post().handler(BodyHandler.create()); router.post(\u0026#34;/test/request\u0026#34;).handler(this::testRequest); router.post(\u0026#34;/test/send\u0026#34;).handler(this::testSend); router.post(\u0026#34;/test/publish\u0026#34;).handler(this::testPublish); vertx.createHttpServer() .requestHandler(router) .listen(port) .onSuccess(server -\u0026gt; { log.info(\u0026#34;HTTP server started on port \u0026#34; + server.actualPort()); startPromise.complete(); } ).onFailure(startPromise::fail); }); } private void testPublish(RoutingContext context) { JsonObject reqBody = context.getBodyAsJson(); log.debug(\u0026#34;request body: {}\u0026#34;, reqBody); vertx.eventBus().publish(BusAddress.TEST_PUBLISH, reqBody); context.json(reqBody); } private void testSend(RoutingContext context) { JsonObject reqBody = context.getBodyAsJson(); log.debug(\u0026#34;request body: {}\u0026#34;, reqBody); vertx.eventBus().send(BusAddress.TEST_SEND, reqBody); context.json(reqBody); } private void testRequest(RoutingContext context) { JsonObject reqBody = context.getBodyAsJson(); log.debug(\u0026#34;request body: {}\u0026#34;, reqBody); vertx.eventBus().\u0026lt;JsonObject\u0026gt;request(BusAddress.TEST_REQUEST, reqBody, response -\u0026gt; { if (response.succeeded()) { Message\u0026lt;JsonObject\u0026gt; msg = response.result(); JsonObject msgBody = msg.body(); log.debug(\u0026#34;reply from {}, message body: {}\u0026#34;, BusAddress.TEST_REQUEST, msgBody); context.json(msgBody); } else { log.error(\u0026#34;failed to test request\u0026#34;, response.cause()); } }); } private void hello(RoutingContext context) { String address = context.request().connection().remoteAddress().toString(); MultiMap queryParams = context.queryParams(); String name = queryParams.contains(\u0026#34;name\u0026#34;) ? queryParams.get(\u0026#34;name\u0026#34;) : \u0026#34;unknown\u0026#34;; context.json( new JsonObject() .put(\u0026#34;name\u0026#34;, name) .put(\u0026#34;address\u0026#34;, address) .put(\u0026#34;message\u0026#34;, \u0026#34;Hello \u0026#34; + name + \u0026#34; connected from \u0026#34; + address) ); } } æœ€åï¼Œä»ç„¶æ˜¯ä¸ºäº†æ–¹ä¾¿å±•ç¤ºèµ·è§ï¼Œæä¾›ä¸€ä¸ªç®€åŒ–çš„ç¨‹åºå¯åŠ¨è„šæœ¬ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 #!/bin/bash bin_dir=$(dirname \u0026#34;$0\u0026#34;) start() { case $1 in consumer) java -jar \u0026#34;$bin_dir\u0026#34;/../consumer/target/consumer-1.0.0-SNAPSHOT-fat.jar -cluster ;; provider) java -jar \u0026#34;$bin_dir\u0026#34;/../provider/target/provider-1.0.0-SNAPSHOT-fat.jar -cluster ;; *) echo \u0026#34;Unknown module: $1\u0026#34; exit 1 ;; esac } stop() { jcmd | grep \u0026#34;$1-1.0.0-SNAPSHOT-fat.jar\u0026#34; | awk \u0026#39;{print $1}\u0026#39; | xargs -I {} kill -9 {} } stopAll() { stop consumer stop provider } case $1 in start) start \u0026#34;$2\u0026#34; ;; stop) stop \u0026#34;$2\u0026#34; ;; restart) stop \u0026#34;$2\u0026#34; start \u0026#34;$2\u0026#34; ;; down) stopAll ;; *) echo \u0026#34;Usage: $0 {start \u0026lt;module\u0026gt;|stop \u0026lt;module\u0026gt;|restart \u0026lt;module\u0026gt;|down}\u0026#34; ;; esac å‡å¦‚å…ˆå¯åŠ¨å…¶ä¸­ä¸€ä¸ªæ¨¡å—ï¼Œæ¯”å¦‚å¯åŠ¨æœåŠ¡ç”Ÿäº§è€…ã€‚\n1 % ./dev.sh start provider ä»å®ƒçš„æ—¥å¿—ä¼šå‘ç°å®ƒå·²ç»æˆä¸º Hazelcast é›†ç¾¤çš„å”¯ä¸€æˆå‘˜ï¼š\n1 2 3 Members {size:1, ver:1} [ Member [192.168.0.100]:5701 - 0d97d436-ab4f-432b-abb6-10975e224044 this ] ç´§æ¥ç€å¯åŠ¨æœåŠ¡æ¶ˆè´¹è€…ã€‚\n1 % ./dev.sh start consumer æœåŠ¡æ¶ˆè´¹è€…çš„è§†è§’ï¼š\n1 2 3 4 Members {size:2, ver:2} [ Member [192.168.0.100]:5701 - 0d97d436-ab4f-432b-abb6-10975e224044 this Member [192.168.0.100]:5702 - 12740655-5ee8-4228-a723-112c2992b290 ] æœåŠ¡ç”Ÿäº§è€…çš„è§†è§’ï¼š\n1 2 3 4 Members {size:2, ver:2} [ Member [192.168.0.100]:5701 - 0d97d436-ab4f-432b-abb6-10975e224044 Member [192.168.0.100]:5702 - 12740655-5ee8-4228-a723-112c2992b290 this ] ä¸¤è€…ç›¸äº’å‘ç°äº†å¯¹æ–¹ï¼Œä½†æ˜¯ï¼Œå®ƒä»¬æ˜¯å¦èƒ½æ­£å¸¸é€šä¿¡ï¼Ÿ\n1 2 % curl \u0026#34;localhost:8888/hello?name=huangh\u0026#34; {\u0026#34;name\u0026#34;:\u0026#34;huangh\u0026#34;,\u0026#34;address\u0026#34;:\u0026#34;0:0:0:0:0:0:0:1:51328\u0026#34;,\u0026#34;message\u0026#34;:\u0026#34;Hello huangh connected from 0:0:0:0:0:0:0:1:51328\u0026#34;} 1 2 % curl localhost:8888/test/request -d \u0026#34;{\\\u0026#34;name\\\u0026#34;:\\\u0026#34;huangh\\\u0026#34;}\u0026#34; {\u0026#34;name\u0026#34;:\u0026#34;huangh\u0026#34;,\u0026#34;consumed\u0026#34;:true} å®Œæ•´ä»£ç å·²å‘å¸ƒï¼Œè¯·å‚è€ƒ vertx-hazelcast-expã€‚\nå†™åœ¨æœ€å Hazelcast Management Center å¯ç”¨äºå¯è§†åŒ–ç›‘æ§å’Œç®¡ç† Vert.x é›†ç¾¤ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ Eclipse Vert.x and reactive in just a few words\nVert.x in Action: Asynchronous and Reactive Java\nUnderstanding Vert.x Architecture - Part I: Inside Vert.x. Comparison with Node.js\nUnderstanding Vert.x Architecture - Part II\nUnderstanding Vert.x: Event Loop\nUnderstanding Vert.x: Event Bus\nhazelcast/hazelcast\nhazelcast/hazelcast-code-samples\nhazelcast/hazelcast-go-client\nHazelcast IMDG Reference Manual # Overview\nHazelcast IMDG Reference Manual # Appendix F: Frequently Asked Questions\nHazelcast # Vert.x Cluster\netcd versus other key-value stores\nReactiverse\nVert.x AweÂ­some\neclipse-vertx/vert.x\nAdvanced Vert.x Guide\nVert.x Examples\nBuilding a Vert.x Native Image\n","date":"2020-12-14T14:50:54+08:00","permalink":"https://h2cone.github.io/2020/12/14/vertx-hazelcast-exp/","title":"Vert.x ä¸ Hazelcast"},{"content":"èƒŒæ™¯ åˆšå…¥è¡Œé‚£ä¼šï¼Œå…¬å¸äº§å“ç ”å‘éƒ¨æ­£å¦‚ç«å¦‚è¼å»ºè®¾å¾®æœåŠ¡åŸºç¡€è®¾æ–½ï¼Œå…¶ä¸­å°±åŒ…æ‹¬æ—¥å¿—ä¸­å¿ƒã€‚è¯•æƒ³ä¸€ä¸‹ï¼ŒåŒ…å«ä¼—å¤šå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç³»ç»Ÿï¼Œä¸€ä¸ªæœåŠ¡å¯èƒ½ä¼šæœ‰å¤šä¸ªå®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹è¾“å‡ºå„è‡ªçš„æ—¥å¿—è®°å½•ï¼›å‡å¦‚åœ¨å®¢æˆ·ç«¯æ”¶åˆ°äº†æ¥è‡ªæœåŠ¡å™¨ç«¯çš„å¼‚å¸¸å“åº”ï¼Œä¾‹å¦‚ 500 Internal Server Errorï¼Œç›¸åº”çš„è´Ÿè´£äººä¸å¯é¿å…åœ°ä¼šé‡åˆ°éœ€è¦é€šè¿‡æŸ¥çœ‹å®¹å™¨æ—¥å¿—æ¥æŸ¥æ˜å“ªé‡Œå‘ç”Ÿæ•…éšœæˆ–åˆ™ä»€ä¹ˆåŸå› å¯¼è‡´æ€§èƒ½ä¸‹é™çš„æƒ…æ™¯ã€‚\nè´Ÿè´£äººä¹Ÿè®¸èµ°äº†å¼¯è·¯ã€‚ç™»å½•å“ªäº›æœåŠ¡å™¨æˆ–è·³æ¿æœºï¼Ÿæœ‰æ²¡æœ‰è®¿é—®æƒï¼Ÿéœ€ä¸éœ€è¦é€šè¿‡â€œä¸­ä»‹â€æ‰èƒ½è·å¾—è®¸å¯æˆ–ç›¸å…³æ—¥å¿—æ–‡ä»¶ï¼ŸæŸ¥çœ‹å“ªäº›ç»“ç‚¹ä¸Šçš„å“ªäº›æœåŠ¡çš„æ—¥å¿—ï¼Ÿ\nè´Ÿè´£äººä¹Ÿä»¥å¯ä»¥èµ°å·²ç»é“ºå¥½çš„è·¯ã€‚ç›´æ¥åœ¨æ—¥å¿—ä¸­å¿ƒ Web ç‰ˆæœç´¢æ‰€éœ€çš„ä¸€åˆ‡æ—¥å¿—è®°å½•ï¼›ç³»ç»Ÿä¸­æ‰€æœ‰æœåŠ¡çš„æ—¥å¿—è®°å½•éƒ½å¯ä»¥è¢«ç´¢å¼•ä¸æ£€ç´¢ï¼Œä¸ä»…ä»…å¯ä»¥ç”¨äºæ•…éšœæ’é™¤ï¼Œè¿˜å¯ä»¥ç”¨äºç›‘æ§ã€å‘Šè­¦ã€æ•°æ®åˆ†æç­‰ç­‰ã€‚\né›†ä¸­å¼æ—¥å¿—ç®¡ç† ä¸Šå›¾æ¥è‡ªè¿ç»´å’–å•¡å§ï¼Œè¿™æ˜¯ä¸€ç±»å…¸å‹çš„æ—¥å¿—å¤„ç†æ¶æ„ã€‚\nFilebeatï¼Œè½»é‡çº§æ—¥å¿—é‡‡é›†å™¨ã€‚\nè€ƒè™‘åˆ°åŸºäº Docker å¼€å‘æœåŠ¡ï¼Œåº”ç”¨ç¨‹åºçš„çˆ¶é•œåƒåº”åŒ…å« Filebeatï¼Œä¾‹å¦‚ FROM çˆ¶é•œåƒ ä¹‹åæ‰§è¡Œä¸€ç³»åˆ—ä¸‹è½½ã€å®‰è£…ã€è®¾ç½® Filebeat çš„æŒ‡ä»¤ã€‚\nFilebeat ä½œä¸ºåº”ç”¨ç¨‹åºçš„ agent å¯ä»¥å°†æ—¥å¿—ä½œä¸ºè¾“å…¥æºï¼ˆä»æ—¥å¿—æ–‡ä»¶è¯»å–è¡Œï¼‰ï¼Œå†å°† kafka ä½œä¸ºè¾“å‡ºç›®çš„åœ°ï¼ˆå‘é€æ—¥å¿—è®°å½•æˆ–äº‹ä»¶åˆ° Kafkaï¼‰ã€‚\nLogstashï¼Œä¼ è¾“å’Œå¤„ç†æ—¥å¿—ã€äº‹ä»¶ç­‰æ•°æ®ã€‚\nå› ä¸º Logstash æœ‰è®¸å¤šè¾“å…¥æ’ä»¶ï¼ŒåŒ…æ‹¬è¯»å–æ¥è‡ª Kafka Topic çš„äº‹ä»¶ï¼Œå¯ä»¥ä½œä¸º Kafka çš„æ¶ˆè´¹è€…ã€‚\nELK ä¸­çš„ Logstash å½“ç„¶æ”¯æŒå°† Elasticsearch ä½œä¸ºè¾“å‡ºç›®çš„åœ°ã€‚\nElasticsearchï¼Œåˆ†å¸ƒå¼ RESTful æœç´¢å¼•æ“ã€‚\nKibanaï¼Œå¯è§†åŒ– Elasticsearch æ•°æ®çš„ç”¨æˆ·ç•Œé¢ã€‚\næœ‰è¶£çš„æ˜¯ï¼ŒElastic Stack å¹¶ä¸åŒ…å« Kafkaï¼Œä½†ä¸¤è€…åœ¨æ—¥å¿—/äº‹ä»¶å¤„ç†é¢†åŸŸå´æ˜¯ç»å…¸ç»„åˆã€‚\nä½•æ—¶ç»„åˆä½¿ç”¨ Kafka ä¸ Elastic Stack åº”å¯¹çªå‘æµé‡ åœ¨å¤§æ•°æ®é¢†åŸŸï¼ŒKafka ä»¥å•ä½æ—¶é—´å†…ååé‡æé«˜è‘—ç§°ï¼Œæ‰€è°“ååé‡æ˜¯æŒ‡ä»£å¯å¤„ç†çš„è®°å½•æ¡æ•°ï¼ŒKafka éå¸¸é€‚ç”¨äºæµé‡å‰Šå³°ã€‚æ—©åœ¨ 2014 å¹´ï¼ŒKafka å·²ç»èƒ½è¾¾åˆ°æ¯ç§’ 200 ä¸‡æ¬¡å†™å…¥ï¼ˆåœ¨ä¸‰å°å»‰ä»·çš„æœºå™¨ä¸Šï¼‰ã€‚ä¸ºä»€ä¹ˆ Kafka å¦‚æ­¤ä¹‹å¿«ï¼Ÿè‡³å°‘æœ‰å¦‚ä¸‹åŸå› ï¼š\nåŸºäºè¿½åŠ å¼æäº¤æ—¥å¿—ï¼Œé¡ºåº I/O é£å¿«ã€‚\né‡åº¦ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ã€‚\nå¤æ‚æ€§ä»ç”Ÿäº§è€…è½¬ç§»åˆ°äº†æ¶ˆè´¹è€…ã€‚\né«˜åº¦å¯æ°´å¹³/æ¨ªå‘æ‰©å±•ã€‚\nKafka åº”å¯¹å³°å€¼æˆ–çªå‘æ•°æ®çš„èƒ½åŠ›è¿œå¼ºäº Logstashï¼Œå¯é˜²æ­¢å•ä½æ—¶é—´è¾“å…¥è¿‡å¤šæ—¥å¿—æ•°æ®å¯¼è‡´ Logstash æˆä¸ºç³»ç»Ÿçš„ç“¶é¢ˆï¼›å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå®Œæˆæœ¬ç¯‡ä¹‹æ—¶ï¼Œå®˜æ–¹çš„ Logstash æ‰©å±•å»ºè®®ä¹Ÿä»…æœ‰ä¸€å°æ®µã€‚\nå½“ ES ä¸å¯è®¿é—® å½“ Elasticsearch é›†ç¾¤ä¸å¯è®¿é—®æ—¶ï¼ˆä¾‹å¦‚å‡çº§ç‰ˆæœ¬æˆ–è€…å…¶ä»–ç†ç”±éœ€è¦æš‚æ—¶ä¸‹çº¿ï¼‰ï¼ŒKafka èƒ½å¤Ÿæš‚æ—¶ä¿å­˜ Filebeat é‡‡é›†çš„æ—¥å¿—æ•°æ®ï¼Œç›´åˆ° Elasticsearch å’Œ Logstash å†æ¬¡ä¸Šçº¿ã€‚\næ‰©å±•å’Œå®¹é”™ å¼•ç”¨ä¸€å¼ æ¥è‡ª Kafka: The Definitive Guide çš„æ’å›¾ï¼š\næ¶ˆè´¹è€…ç¾¤ç»„ï¼ˆConsumer Groupï¼‰ä¿è¯åŒä¸€ä¸ªä¸»é¢˜ï¼ˆTopicï¼‰çš„ä»»æ„åˆ†åŒºï¼ˆPartitionï¼‰æœ€å¤šåªèƒ½è¢«ç»„å†…çš„ä¸€ä¸ªæ¶ˆè´¹è€…ä½¿ç”¨ã€‚å¢åŠ  Logstash å®ä¾‹æ¥ç»„æˆä¸€ä¸ªæ¶ˆè´¹è€…ç¾¤ç»„ï¼Œå®ƒä»¬å°†å¹¶å‘è¯»å– Kafka Topic ä¸­çš„æ—¥å¿—æ¶ˆæ¯ï¼Œè€Œä¸ä¼šäº¤å ï¼Œå› æ­¤èƒ½å¤Ÿæå‡å•ä½æ—¶é—´å†…ä» Kafka åˆ° Logstash å†åˆ° Elasticsearch çš„ååé‡ï¼›ä½¿ç”¨å¤šä¸ª Logstash å®ä¾‹çš„å¦å¤–ä¸€ä¸ªå¥½å¤„æ˜¯æ˜¯å¢å¼ºç³»ç»Ÿçš„å®¹é”™èƒ½åŠ›ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼Œå½“æ¶ˆè´¹è€…åŠ å…¥æˆ–ç¦»å¼€æ¶ˆè´¹è€…ç¾¤ç»„å°†è§¦å‘å†å¹³è¡¡ï¼ˆrebalancingï¼‰ï¼ŒLogstash æ¶ˆè´¹è€…çš„ Kafka Client åº“å°†å‚ä¸é‡æ–°åˆ†é…åˆ†åŒºç»™æ¶ˆè´¹è€…çš„è¿‡ç¨‹ã€‚å½“ç¾¤ç»„ä¸­æœ‰è‹¥å¹² Logstash å®ä¾‹å¤±æ•ˆæ—¶ï¼Œæ ¹æ®å†å¹³è¡¡åè®®ï¼Œå¤±å»æ¶ˆè´¹è€…çš„åˆ†åŒºå°†è¢«åˆ†é…ç»™ç°æœ‰çš„æ¶ˆè´¹è€…ã€‚\nä¸€ç‚¹å»ºè®® å‡è®¾ Logstash å®ä¾‹ç»„æˆçš„æ¶ˆè´¹è€…ç¾¤ç»„ ID ä¸º logstashï¼Œå­˜å‚¨åº”ç”¨ç¨‹åºæ—¥å¿—è®°å½•çš„è¯é¢˜ ID ä¸º app_logsï¼Œä¸‹é¢æ˜¯ logstash-*.conf çš„è¾“å…¥æºé…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 input { kafka { bootstrap_servers =\u0026gt; \u0026#34;kafka_host_1:9092,kafka_host_2:9092\u0026#34; group_id =\u0026gt; \u0026#34;logstash\u0026#34; topics =\u0026gt; [\u0026#34;app_logs\u0026#34;] consumer_threads =\u0026gt; 8 ... } } å…¶ä¸­ consumer_threads æ˜¯æ¶ˆè´¹è€…çº¿ç¨‹æ•°ï¼ˆé»˜è®¤å€¼æ˜¯ 1ï¼‰ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹æ•°ä¹‹å’Œåº”ä¸åˆ†åŒºæ•°ç›¸ç­‰ï¼Œä»¥å®ç°å®Œç¾å¹³è¡¡ã€‚å¦‚æœæ¶ˆè´¹è€…çº¿ç¨‹æ•°ä¹‹å’Œå¤šäºåˆ†åŒºæ•°ï¼Œé‚£ä¹ˆæŸäº›çº¿ç¨‹å°†å¤„äºç©ºé—²çŠ¶æ€ï¼›å¦‚æœæ¶ˆè´¹è€…çº¿ç¨‹æ•°ä¹‹å’Œå°‘äºåˆ†åŒºæ•°ï¼Œé‚£ä¹ˆæŸäº›çº¿ç¨‹å°†æ¶ˆè´¹å¤šä¸ªåˆ†åŒºã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œapp_logs è¯é¢˜çš„åˆ†åŒºæ•°ä¸º 16ï¼Œæœ€ä½³çš„éƒ¨ç½²æ–¹å¼å¾ˆå¯èƒ½æ˜¯å°†æ¶ˆè´¹è€…çº¿ç¨‹æ•°ä¸º 8 çš„ 2 ä¸ª Logstash å®ä¾‹éƒ¨ç½²åˆ° 2 å° CPU æ ¸æ•°ä¸º 8 çš„æœºå™¨ä¸Šã€‚\nè™½è¯´ Kafka åº”å¯¹çªå‘æ•°æ®æˆ–æµé‡é«˜å³°çš„èƒ½åŠ›å¾ˆå¼ºï¼Œä½†æ˜¯åœ¨æ— æ³•ä¼°ç®—æ—¥å¿—è®°å½•/äº‹ä»¶çš„é‡çº§ä¸æµé€Ÿä¹‹å‰åº”å¤‡ä¸æ—¶ä¹‹éœ€ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ä¸€äº›â€œçªå‘â€ä¸»é¢˜ï¼Œå½“å•ä½æ—¶é—´å†…åº”ç”¨ç¨‹åºäº§ç”Ÿè¿‡å¤šæ—¥å¿—æ•°æ®æ—¶ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶å°†å…¶ç§»åŠ¨åˆ°â€œçªå‘â€ä¸»é¢˜ï¼Œä½¿å…¶å®ƒä¸»é¢˜é¿å…ä¸å¿…è¦çš„æµé‡ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ Just Enough Kafka for the Elastic Stack, Part 1\nELKæ—¥å¿—ç³»ç»Ÿä¹‹é€šç”¨åº”ç”¨ç¨‹åºæ—¥å¿—æ¥å…¥æ–¹æ¡ˆ\nWhy Kafka Is so Fast\nELKæ¶æ„ä¸‹åˆ©ç”¨Kafka Groupå®ç°Logstashçš„é«˜å¯ç”¨\nApache Kafka Rebalance Protocol, or the magic behind your streams applications\n","date":"2020-11-22T11:32:08+08:00","permalink":"https://h2cone.github.io/2020/11/22/kafka_in_the_elk/","title":"Kafka ä¹‹äº Elastic Stack"},{"content":"ä»€ä¹ˆæ˜¯æ—¥å¿— æ—¥å¿—æ˜¯è¿½åŠ å¼çš„ï¼ŒæŒ‰æ—¶é—´æ’åºçš„è®°å½•ï¼ˆæ¡ç›®ï¼‰åºåˆ—ã€‚\næ— å…³è®°å½•çš„æ ¼å¼ï¼Œæ—¥å¿—æ–‡ä»¶è®°å½•æ“ä½œç³»ç»Ÿæˆ–å…¶å®ƒè½¯ä»¶è¿è¡Œæ—¶å‘ç”Ÿçš„äº‹ä»¶åŠå…¶æ—¶é—´ã€‚\n1 \u0026lt;34\u0026gt;1 2003-10-11T22:14:15.003Z mymachine.example.com su - ID47 - BOM\u0026#39;su root\u0026#39; failed for lonvick on /dev/pts/8 â€œåº”ç”¨ç¨‹åºæ—¥å¿—â€æ˜¯äººç±»å¯è¯»çš„æ–‡æœ¬ï¼Œæ¯”å¦‚ Syslog å’Œ SLF4J ç­‰ï¼›å¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™æ˜¯ä¸€ä¸ªæ¥è‡ª RFC5424 çš„ syslog æ—¥å¿—æ¶ˆæ¯ä¾‹å­ï¼Œä»ä¸­ä¸éš¾çœ‹å‡ºä¸»æœºï¼ˆmymachine.example.comï¼‰ä¸Šçš„ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ˆsuï¼‰åœ¨ 2003-10-11T22:14:15.003Z å‘ç”Ÿäº† â€œ\u0026lsquo;su root\u0026rsquo; failed for lonvick\u0026hellip;â€ã€‚\nç°ä»£æœ€æµè¡Œçš„åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­çš„æ—¥å¿—è®°å½•ç€æ‰€æœ‰è´¡çŒ®è€…çš„æäº¤å†å²ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 % git log ... commit 130560a769fe6da64c87f695e4665225de1faec3 Author: Daniel Smith \u0026lt;dbsmith@google.com\u0026gt; Date: Fri Jun 6 17:31:45 2014 -0700 Proofread guestbook.md commit 2c4b3a562ce34cddc3f8218a2c4d11c7310e6d56 Author: Joe Beda \u0026lt;joe.github@bedafamily.com\u0026gt; Date: Fri Jun 6 16:40:48 2014 -0700 First commit ç„¶è€Œï¼Œæ—¥å¿—å¹¶éå…¨éƒ½æ˜¯äººç±»å¯è¯»çš„ï¼Œå®ƒå¯èƒ½æ˜¯äºŒè¿›åˆ¶æ ¼å¼è€Œåªèƒ½è¢«ç¨‹åºè¯»å–ï¼Œä½œä¸ºå…³é”®æŠ½è±¡æ™®éå­˜åœ¨äºæ•°æ®åº“ç³»ç»Ÿå’Œåˆ†å¸ƒå¼ç³»ç»Ÿä¹‹ä¸­ã€‚\næ•°æ®åº“æ—¥å¿— å…³ç³»æ•°æ®åº“ç³»ç»Ÿä¸­çš„æ—¥å¿—é€šå¸¸ç”¨äºå´©æºƒæ¢å¤ã€æä¾›ä¸€å®šç¨‹åº¦çš„åŸå­æ€§ä¸æŒä¹…æ€§ã€æ•°æ®å¤åˆ¶ã€‚\né¢„å†™æ—¥å¿— æ ¹æ®ç»éªŒï¼Œæˆ‘ä»¬ç¡®ä¿¡å…¥åº“æ•°æ®ç»ˆå°†ä¼šè¢«å†™å…¥ç£ç›˜ã€‚ç£ç›˜æ˜¯ä¸€ç§ I/O è®¾å¤‡ï¼ˆå‚è€ƒç½‘ç»œÂ·NIO # I/Oï¼‰ï¼Œä»ä¸»å­˜å¤åˆ¶æ•°æ®åˆ° I/O è®¾å¤‡å¹¶ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå¦‚æœå®¢æˆ·ç«¯å‘é€è¯·æ±‚åï¼Œæ•°æ®åº“æœåŠ¡ç«¯å¤„ç†è¯·æ±‚ä¸­ï¼Œç³»ç»Ÿå´©æºƒæˆ–å®•æœºæŠ‘æˆ–é‡å¯ï¼ŒæœåŠ¡ç«¯Â·å¦‚ä½•ä¿è¯ä¸ä¸¢å¤±å˜æ›´æˆ–è€…æ¢å¤åˆ°æ­£ç¡®çš„æ•°æ®ï¼Ÿ\nå¾ˆä¹…ä»¥å‰ï¼Œå­˜åœ¨ç€æ— åŸå­æ€§çš„éåˆ†å¸ƒå¼æ•°æ®åº“äº‹åŠ¡ã€‚å¼ ä¸‰è´¦æˆ·æœ‰ 1000 å…ƒï¼Œæå››è´¦æˆ·æœ‰ 2000 å…ƒï¼Œå¼ ä¸‰å‘æå››è½¬è´¦ 200 å…ƒï¼Œæ•°æ®åº“ç³»ç»Ÿå…ˆå°†å¼ ä¸‰è´¦æˆ·å‡å°‘ 200 å…ƒï¼Œç„¶åå°† 800 å…ƒå†™å›å¼ ä¸‰è´¦æˆ·ï¼Œæ¥ç€å°†æå››è´¦æˆ·å¢åŠ  200 å…ƒå¹¶ä¸”å°† 2200 å…ƒå†™å›æå››è´¦æˆ·æ—¶ï¼ŒæœåŠ¡å™¨çªç„¶å‘ç”Ÿæ•…éšœï¼›ç³»ç»Ÿé‡å¯åï¼Œåªæœ‰ä¸€ä¸ªè´¦æˆ·æ˜¯å¯¹çš„ï¼Œå¼ ä¸‰è´¦æˆ·æ˜¯ 800 å…ƒï¼Œä½†æ˜¯æå››è´¦æˆ·è¿˜æ˜¯ 2000 å…ƒï¼Œ200 å…ƒä¸ç¿¼è€Œé£ã€‚\nè®¡ç®—æœºç•Œæ˜æ˜¾çš„å‘æ—©å·²è¢«å‰äººå¡«æ»¡ã€‚Write-ahead logging æ˜¯æ•°æ®åº“ç³»ç»Ÿä¸­æä¾›åŸå­æ€§ä¸æŒä¹…æ€§çš„æŠ€æœ¯ï¼ˆæ—¥å¿—å…ˆè¡ŒæŠ€æœ¯ï¼‰ï¼Œç®€ç§° WALï¼Œä¸€è¨€è”½ä¹‹ï¼Œæ•°æ®åº“ç³»ç»Ÿé¦–å…ˆå°†æ•°æ®å˜æ›´è®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œç„¶åå°†æ—¥å¿—å†™å…¥ç¨³å®šå­˜å‚¨ï¼ˆå¦‚ç£ç›˜ï¼‰ï¼Œä¹‹åæ‰å°†å˜æ›´å†™å…¥æ•°æ®åº“ã€‚\nRedo log å’Œ Undo log æ˜¯è¿ç”¨äº† WAL çš„ç£ç›˜æ•°æ®ç»“æ„ï¼š\n- Undo log åœ¨å´©æºƒæ¢å¤æœŸé—´ç”¨äºæ’¤æ¶ˆæˆ–å›æ»šæœªæäº¤çš„äº‹åŠ¡ã€‚\n- Redo log åœ¨å´©æºƒæ¢å¤æœŸé—´ç”¨äºé‡åšå·²æäº¤ä½†æœªå°†æ•°æ®åº“å¯¹è±¡ä»ç¼“å†²åŒºåˆ·å…¥ç£ç›˜çš„äº‹åŠ¡ã€‚\næ’¤æ¶ˆå’Œé‡åšçš„å‰ææ˜¯è®°å½•äº†æ•°æ®åº“å¯¹è±¡å˜æ›´å‰çš„å€¼å’Œå˜æ›´åçš„å€¼ã€‚\nå‡è®¾äº‹åŠ¡ T[i] æ‰€æ“ä½œçš„æ•°æ®åº“å¯¹è±¡æ˜¯ Xï¼ŒX çš„å€¼ä» V[old] æ›´æ”¹ä¸º V[new]ï¼Œå°†æ•°æ®ä»ç¼“å†²åŒºåˆ·å…¥ç£ç›˜çš„æ“ä½œè¢«ç§°ä¸º flushï¼Œé‚£ä¹ˆ undo/redo log æ—¥å¿—è®°å½•å½¢å¼å¦‚ä¸‹ï¼š\n1 2 3 begin T[i] //ï¼ˆ1ï¼‰ (T[i], X, V) //ï¼ˆ2ï¼‰ commit T[i] //ï¼ˆ3ï¼‰ ï¼ˆ1ï¼‰è®°å½•äº‹åŠ¡å¼€å§‹ã€‚\nï¼ˆ2ï¼‰è®°å½•æ•°æ®åº“å¯¹è±¡çš„å€¼ã€‚Undo log è®°å½• (T[i], X, V[old]) ï¼Œè€Œ Redo log è®°å½• (T[i], X, V[new])ï¼Œä¸¤è€…éƒ½è¦æ±‚ flush X ä¹‹å‰ flush (T[i], X, V)ã€‚\nï¼ˆ3ï¼‰è®°å½•äº‹åŠ¡æäº¤ã€‚Undo log è¦æ±‚ flush X ä¹‹å flush (commit T[i])ï¼Œè€Œ Redo log è¦æ±‚ flush X ä¹‹å‰ flush (commit T[i])ã€‚\nåœ¨å´©æºƒæ¢å¤æœŸé—´ï¼Œä»æ•°æ®åº“ç³»ç»Ÿè§’åº¦æ¥çœ‹ï¼š\nè‹¥å‘ç° undo log ç¼ºå°‘ï¼ˆ3ï¼‰ï¼Œåˆ™æ— æ³•ç¡®å®š flush X æ˜¯å¦å®Œæˆã€‚å†³å®šå°† X çš„å€¼è®¾ä¸º V[old] å flush Xï¼Œå› ä¸º X å˜æ›´å‰çš„å€¼æ˜¯ V[old]ï¼Œå³ä½¿æ¢å¤è¿‡ç¨‹ä¸­åˆå‘ç”Ÿå´©æºƒï¼Œé‡å¤å°† X çš„å€¼è®¾ä¸º V[old] ä»ç„¶å¹‚ç­‰ï¼Œç›´åˆ°æ¢å¤å®Œæˆåï¼Œå¯ä»¥åœ¨ï¼ˆ3ï¼‰ä½ç½®å†™ä¸€æ¡è®°å½•ï¼šrollback T[i]ï¼Œä¸‹æ¬¡æ¢å¤æœŸé—´å¿½ç•¥ã€‚\nè‹¥å‘ç° redo log ç¼ºå°‘ï¼ˆ3ï¼‰ï¼Œåˆ™ç¡®å®š flush X æœªæ‰§è¡Œã€‚å†³å®šå°† X çš„å€¼è®¾ä¸º V[new]ï¼Œé‡è¯• flush Xã€‚\nè‹¥å‘ç°ç¼ºå°‘ï¼ˆ2ï¼‰ï¼Œåˆ™å¿½ç•¥æ­¤äº‹åŠ¡ï¼ˆæ— è®¡å¯æ–½ï¼‰ã€‚\nè‹¥æ²¡æœ‰ï¼ˆ1ï¼‰ï¼Œåˆ™æ— æ­¤äº‹åŠ¡ã€‚\né€»è¾‘æ—¥å¿— å‰æ–‡MySQL çª˜å¢ƒ # ä¸»ä»å¤åˆ¶ä¸­æåˆ°å…¶æ•°æ®å¤åˆ¶éœ€è¦æ•°æ®å˜æ›´æ—¥å¿—ï¼Œæˆ–åˆ™æ•°æ®å˜æ›´æ—¥å¿—è®°å½•ï¼ˆäº‹ä»¶ï¼‰ã€‚MySQL Server æœ‰è‹¥å¹²ç§æ—¥å¿—ï¼Œå…¶ä¸­äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBinary logï¼Œç®€ç§° binlogï¼‰åŒ…å«æè¿°æ•°æ®å˜æ›´çš„â€œäº‹ä»¶â€ï¼Œä¾‹å¦‚åˆ›å»ºè¡¨æˆ–å¯¹è¡¨æ•°æ®çš„æ›´æ”¹ï¼ŒMySQL binlog ä¸å­˜å‚¨å¼•æ“è§£è€¦ã€‚\nåœ¨æœåŠ¡åŒ–æ¶æ„ä¸­ï¼Œç»„åˆä½¿ç”¨ MySQL å’Œ Elasticsearch æ—¶å¸¸å¸¸è¦æ±‚å°† MySQL æ•°æ®åŒæ­¥åˆ° Elasticsearchï¼›Elastic Stack çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ Logstash çš„æ’ä»¶ï¼šJdbc input pluginã€‚\nLogstash çš„ Jdbc input plugin ä¼šæ ¹æ®é…ç½®æ–‡ä»¶å®šæ—¶/å®šæœŸå¯¹ MySQL è¿›è¡Œè½®è¯¢ï¼Œå¯è·å–ä¸Šä¸€æ¬¡è¯¢é—®ä¹‹åæ’å…¥æˆ–æ›´æ”¹çš„è®°å½•ã€‚æœ‰äººè¯¯ä»¥ä¸º Jdbc input plugin æœ€å¿«åªèƒ½æ¯åˆ†é’ŸæŸ¥è¯¢ä¸€æ¬¡ï¼Œå®é™…ä¸Šä¹Ÿèƒ½è®¾ç½®ç§’çº§ã€‚\nç›‘å¬ binlog äº‹ä»¶å¯ä»¥å®ç°å°† MySQL æ•°æ®åŒæ­¥åˆ°å„ç§æ•°æ®æºï¼Œè¿™ç§æ–¹æ¡ˆéå¸¸é€‚åˆå„ç§æ¶ˆæ¯ä¼ é€’ã€æ•°æ®æµã€å®æ—¶æ•°æ®å¤„ç†ã€‚å‡è®¾æœ‰ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæ ¹æ® MySQL åè®®ï¼Œå®ƒåªè¦å‘ MySQL master æ³¨å†Œä¸º MySQL slaveï¼ŒæŒç»­æ¥æ”¶å¹¶è§£æ binlog äº‹ä»¶ï¼Œç»è¿‡å¤„ç†ååˆèƒ½ä½œä¸ºæ¶ˆæ¯ä¼ é€’ç»™å„ç§æœåŠ¡æˆ–ç»„ä»¶ä»¥æ»¡è¶³æ•°æ®åŒæ­¥éœ€æ±‚ï¼›æ¯”å¦‚ alibaba/canalï¼Œå®ƒæ˜¯ä¸€ä¸ªå…³äº MySQL binlog å¢é‡è®¢é˜…\u0026amp;æ¶ˆè´¹çš„ç»„ä»¶ã€‚\nè¯¸å¦‚æ­¤ç±»çš„è®¾è®¡æ¨¡å¼è¢«ç§°ä¸º CDCï¼ˆchange data captureï¼‰ã€‚\nåˆ†å¸ƒå¼ç³»ç»Ÿæ—¥å¿— è¿™è¦ä»çŠ¶æ€æœºå¤åˆ¶è¯´èµ·ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¯ä¸ª Server å­˜å‚¨äº†ä¸€ä¸ªå®ƒçš„çŠ¶æ€æœºï¼ˆState Machineï¼‰æŒ‰é¡ºåºæ‰§è¡Œçš„ä¸€ç³»åˆ—å‘½ä»¤çš„æ—¥å¿—ï¼ˆLogï¼‰ï¼›æ¯ä¸ªæ—¥å¿—åŒ…å«ç›¸åŒé¡ºåºçš„å‘½ä»¤é›†ï¼Œå› æ­¤æ¯ä¸ªçŠ¶æ€æœºå°†æ‰§è¡Œç›¸åŒçš„å‘½ä»¤åºåˆ—ï¼›å› ä¸ºè®¨è®ºçš„çŠ¶æ€æœºå…·æœ‰ç¡®å®šæ€§ï¼Œæ‰€ä»¥å®ƒä»¬å°†äº§ç”Ÿç›¸åŒçš„è¾“å‡ºå¹¶ä»¥ç›¸åŒçš„çŠ¶æ€ç»“æŸã€‚\nä»€ä¹ˆæ˜¯ç¡®å®šæ€§ï¼Ÿç»™å®šç‰¹å®šçš„è¾“å…¥ï¼Œå°†å§‹ç»ˆäº§ç”Ÿç›¸åŒçš„è¾“å‡ºã€‚ä½œä¸ºåé¢ï¼Œæ‰§è¡Œç±»ä¼¼ä»¥ä¸‹å‘½ä»¤çš„è‹¥å¹²çŠ¶æ€æœºï¼ˆè¿›ç¨‹ï¼‰å°†äº§ç”Ÿä¸åŒçš„è¾“å‡ºå¹¶ä»¥ä¸åŒçš„çŠ¶æ€ï¼ˆç£ç›˜å’Œä¸»å­˜ä¸­çš„æ•°æ®ï¼‰ç»“æŸã€‚\n1 INSERT INTO t VALUES (NOW()); çŠ¶æ€æœºå¤åˆ¶é€šå¸¸ä½¿ç”¨ replicated log å®ç°ï¼Œä¿æŒ replicated log çš„ä¸€è‡´æ€§æ˜¯å…±è¯†ç®—æ³•çš„å·¥ä½œã€‚\næäº¤æ—¥å¿— Apache Kafka åˆ†åŒºï¼ˆpartitionï¼‰çš„æœ¬è´¨æ˜¯æäº¤æ—¥å¿—ï¼ˆcommit logï¼‰ã€‚\nå¦‚æœæŠŠ Kafka ä¸å…³ç³»å‹æ•°æ®åº“ä½œç±»æ¯”ï¼Œé‚£ä¹ˆæ¶ˆæ¯ï¼ˆmessageï¼‰ç±»æ¯”è¡Œï¼ˆrowï¼‰ï¼Œä¸»é¢˜ï¼ˆtopicï¼‰ç±»æ¯”è¡¨ï¼ˆtableï¼‰ï¼›ä¸€ä¸ªä¸»é¢˜åˆ†æˆå¤šä¸ªåˆ†åŒºï¼Œåˆ†åŒºæ˜¯è¿½åŠ å¼çš„æ¶ˆæ¯åºåˆ—ï¼ŒåŒä¸€ä¸ªä¸»é¢˜çš„å¤šä¸ªåˆ†åŒºå¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒæœºå™¨ä¸Šã€‚\nä» Kafka çš„è§’åº¦æ¥çœ‹ï¼Œå°†æ¶ˆæ¯å†™å…¥åˆ†åŒºå°±åƒå°†æ—¥å¿—è®°å½•å†™å…¥æäº¤æ—¥å¿—ï¼ˆè¿½åŠ å¼æ›´æ–°æ—¥å¿—æ–‡ä»¶ï¼‰ã€‚\nåœ¨ Kafka çš„ server.properties ä¸­ï¼Œæœ‰ä¸€ä¸ª log.dirs ç”¨äºæŒ‡å®šæ—¥å¿—æ–‡ä»¶ç›®å½•åˆ—è¡¨ã€‚\n1 2 # A comma separated list of directories under which to store log files log.dirs=/usr/local/var/lib/kafka-logs åœ¨ç£ç›˜ä¸Šï¼Œä¸€ä¸ªåˆ†åŒºæ˜¯ä¸€ä¸ªç›®å½•ï¼Œä¾‹å¦‚ä¸»é¢˜åä¸º quickstart-events çš„ä¸€ä¸ªåˆ†åŒºï¼š\n1 2 3 4 5 6 % tree /usr/local/var/lib/kafka-logs/quickstart-events-0/ /usr/local/var/lib/kafka-logs/quickstart-events-0/ â”œâ”€â”€ 00000000000000000000.index â”œâ”€â”€ 00000000000000000000.log â”œâ”€â”€ 00000000000000000000.timeindex â””â”€â”€ leader-epoch-checkpoint å…¶ä¸­ index æ–‡ä»¶ä¸ log æ–‡ä»¶åˆç§°ä¸ºä¸€ä¸ª segmentï¼Œä»¥äººç±»å¯è¯»çš„æ–¹å¼æŸ¥çœ‹ log æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 % kafka-run-class kafka.tools.DumpLogSegments --deep-iteration --print-data-log --files /usr/local/var/lib/kafka-logs/quickstart-events-0/00000000000000000000.log Dumping /usr/local/var/lib/kafka-logs/quickstart-events-0/00000000000000000000.log Starting offset: 0 baseOffset: 0 lastOffset: 0 count: 1 baseSequence: -1 lastSequence: -1 producerId: -1 producerEpoch: -1 partitionLeaderEpoch: 0 isTransactional: false isControl: false position: 0 CreateTime: 1604900950169 size: 90 magic: 2 compresscodec: NONE crc: 3202290031 isvalid: true | offset: 0 CreateTime: 1604900950169 keysize: -1 valuesize: 22 sequence: -1 headerKeys: [] payload: This is my first event baseOffset: 1 lastOffset: 1 count: 1 baseSequence: -1 lastSequence: -1 producerId: -1 producerEpoch: -1 partitionLeaderEpoch: 0 isTransactional: false isControl: false position: 90 CreateTime: 1604900955215 size: 91 magic: 2 compresscodec: NONE crc: 3852839661 isvalid: true | offset: 1 CreateTime: 1604900955215 keysize: -1 valuesize: 23 sequence: -1 headerKeys: [] payload: This is my second event ä»ä¸­å¯ä»¥å‘ç°ï¼Œæ¶ˆæ¯ç¼–ç åœ¨ log æ–‡ä»¶ä¸­ï¼›index æ–‡ä»¶åˆ™åŒ…å«äº†åç§»é‡ï¼ˆoffsetï¼‰ä¸æ¶ˆæ¯åœ¨ log æ–‡ä»¶ä¸­çš„ä½ç½®ï¼ˆpositionï¼‰çš„æ˜ å°„ï¼Œç”¨äºæŸ¥æ‰¾æ¶ˆæ¯ã€‚\nå¯¹äºæ¶ˆæ¯æ¶ˆè´¹è€…ç»„ï¼ˆconsumer groupï¼‰æ¥è¯´ï¼Œä»åˆ†åŒºè¯»å–æ¶ˆæ¯å°±åƒä»æäº¤æ—¥å¿—è¯»å–è®°å½•ï¼›æ¶ˆè´¹è€…ç»„é€šè¿‡åˆ†åŒºçš„åç§»é‡åŒºåˆ†å·²è¯»æ¶ˆæ¯å’Œæœªè¯»æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ç»„å¯¹ä¸»é¢˜ï¼ˆTopicï¼‰çš„åˆ†åŒºçš„åç§»é‡å­˜å‚¨åœ¨ Zookeeper æ ‘æˆ– Kafka å†…ç½®ä¸»é¢˜ä¸­ã€‚\næ¯«ä¸å¤¸å¼ åœ°è¯´ï¼ŒKafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æäº¤æ—¥å¿—ç³»ç»Ÿï¼Œåªä¸è¿‡å®˜æ–¹æ›´æ„¿æ„ç§°ä¹‹ä¸ºåˆ†å¸ƒå¼äº‹ä»¶æµå¹³å°ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ The Log: What every software engineer should know about real-time data\u0026rsquo;s unifying abstraction\nWikipedia # Log file\nWikipedia # Write-ahead logging\nML Wiki # Undo/Redo Logging\nIntro to undo/redo logging\nRecovering from a system crash using undo/redo-log\nundo log ä¸ redo log åŸç†åˆ†æ\nMySQL 5.7 Reference Manual # The Binary Log\nMySQL 5.7 Reference Manual # mysqlbinlog â€” Utility for Processing Binary Log Files\nMySQL 5.7 Reference Manual # Replication Formats\nHow to keep Elasticsearch synchronized with a relational database using Logstash and JDBC\nHow to sync your MySQL data to Elasticsearch\nThe Raft Consensus Algorithm\nHow Kafkaâ€™s Storage Internals Work\nDistributed Commit Logs with Apache Kafka\n","date":"2020-08-30T15:21:41+08:00","permalink":"https://h2cone.github.io/2020/08/30/log-notes/","title":"æ—¥å¿—æ¸¸è®°"},{"content":"MySQL çª˜å¢ƒ æ‰©å±• æ•°æ®ä»¥å‰æ‰€æœªæœ‰çš„é€Ÿåº¦å¢é•¿ï¼Œä¾‹å¦‚ä» GB åˆ° TBï¼Œç”šè‡³åˆ° PBï¼›è´Ÿè½½å¢åŠ ï¼Œä¾‹å¦‚å•ä½æ—¶é—´è¯·æ±‚æ•°ã€I/O æ¬¡æ•°ã€æ´»è·ƒç”¨æˆ·æ•°æ¿€å¢ï¼›è¿™å¯èƒ½å¼•èµ·å•æœº MySQL server æ€§èƒ½ä¸‹é™ï¼Œç”šè‡³ä¸å¯ç”¨ã€‚æˆ‘ä»¬æƒ³å°½åŠæ³•æ‰©å±• MySQLï¼Œé€šå¸¸ï¼Œè¦ä¹ˆé‡‡è´­æ›´å¼ºå¤§çš„æœºå™¨ä½œä¸ºæ•°æ®åº“æœåŠ¡å™¨ï¼Œè¿™æ˜¯ä¸€ç§çºµå‘æ‰©å±•ï¼ˆscale upï¼‰ï¼›è¦ä¹ˆå¯¹ MySQL çš„åº“æˆ–è¡¨è¿›è¡Œåˆ†ç‰‡ï¼ˆMySQL Shardingï¼‰ï¼Œå³å°†æ•°æ®é›†åˆ†ç¦»å¾—åˆ°å¤šä¸ªå­æ•°æ®é›†ï¼Œä»»æ„ä¸¤ä¸ªå­æ•°æ®é›†å¯èƒ½å­˜å‚¨åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œä¹Ÿå¯èƒ½å­˜å‚¨åœ¨ä¸åŒæœºå™¨ä¸Šï¼Œè¿™æ˜¯ä¸€ç§æ¨ªå‘æ‰©å±•ï¼ˆscale outï¼‰ã€‚\nçºµå‘æ‰©å±•éœ€è¦åº”å¯¹ä¸€äº›é—®é¢˜ï¼š\næˆæœ¬å¢é•¿è¿‡å¿«ã€‚å¦‚æœæŠŠä¸€å°æœºå™¨çš„ CPU æ ¸æ•°å¢åŠ ä¸€å€ï¼Œä¸»å­˜å’Œç£ç›˜å„æ‰©å®¹ä¸€å€ï¼Œåˆ™æœ€ç»ˆæ€»æˆæœ¬å¢åŠ ä¸æ­¢ä¸€å€ã€‚\né¢„è§æ€§èƒ½ç“¶é¢ˆã€‚ä¸€å°æœºå™¨å°½ç®¡æ‹¥æœ‰ä¸¤å€çš„ç¡¬ä»¶æŒ‡æ ‡ä½†å´ä¸ä¸€å®šèƒ½å¤„ç†ä¸¤å€çš„è´Ÿè½½ã€‚\næœ‰é™å®¹é”™èƒ½åŠ›ã€‚æ˜¾ç„¶æ— æ³•æä¾›å¼‚åœ°å®¹é”™èƒ½åŠ›ã€‚\næ¨ªå‘æ‰©å±•ä¸€èˆ¬ä¸éœ€è¦é«˜ç«¯çš„ç¡¬ä»¶æˆ–æœºå™¨ï¼Œä½†éœ€è¦å¤šå°ä¸€èˆ¬çš„æœºå™¨å’Œåº”å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿçš„è®¸å¤šæŒ‘æˆ˜ï¼š\næ•…éšœä¸éƒ¨åˆ†å¤±æ•ˆã€‚\nä¸å¯é çš„ç½‘ç»œã€‚\nä¸å¯é çš„æ—¶é’Ÿã€‚\nå› ä¸ºå…³å¿ƒç³»ç»Ÿåº”å¯¹è´Ÿè½½å¢åŠ çš„èƒ½åŠ›ï¼ˆå¯æ‰©å±•æ€§ï¼‰ï¼Œæ‰€ä»¥å…³å¿ƒç³»ç»Ÿå®¹é”™èƒ½åŠ›ï¼ˆå¯ç”¨æ€§ä¸ä¸€è‡´æ€§ï¼‰ã€‚\nè¾¾æˆä»¥ä¸Šç›®æ ‡è‡³å°‘éœ€è¦åˆ†åŒºï¼Œå¯¹äº Elasticsearch å’Œ SolrCloud ä»¥åŠ MongoDB æ¥è¯´æ˜¯ shardï¼›å¯¹äº Cassandra å’Œ HBase åˆ†åˆ«æ˜¯ vnode å’Œ regionã€‚\nä¸ºä»€ä¹ˆåˆ†åŒº å¢å¼ºå¯æ‰©å±•æ€§ã€‚æµ·é‡æ•°æ®åˆ†å¸ƒåœ¨æ›´å¤šç£ç›˜ä¸Šï¼ŒæŸ¥è¯¢è´Ÿè½½åˆ†å¸ƒåˆ°æ›´å¤šå¤„ç†å™¨ä¸Šã€‚\nåˆ†åŒºå®¹é”™ã€‚æ•°æ®åˆ†åŒºä¸æ•°æ®å¤åˆ¶é€šå¸¸ç»“åˆä½¿ç”¨ï¼Œå³æ¯ä¸ªåˆ†åŒºåœ¨å¤šä¸ªç»“ç‚¹ä¸Šå­˜æœ‰å‰¯æœ¬ï¼ˆreplicaï¼‰ã€‚\nå‰¯æœ¬çš„ä¼˜åŠ¿ï¼š\nå®¹é”™ã€‚å®¹å¿ç»“ç‚¹å¤±æ•ˆï¼Œæ”¯æŒæ•…éšœè½¬ç§»ã€‚\næ¨ªå‘æ‰©å±•ã€‚é‡‡ç”¨å¤šç»“ç‚¹æ¥å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚\nå°±è¿‘è®¿é—®ã€‚å°†å‰¯æœ¬éƒ¨ç½²åˆ°è·ç¦»ç”¨æˆ·æ›´è¿‘çš„åœ°æ–¹ã€‚\nPartitioning é¡¹ç›®å¼€å§‹åˆæœŸï¼Œä»€ä¹ˆæƒ…å†µä¸‹é€‚åˆå¯¹ MySQL åˆ†åº“åˆ†è¡¨ï¼Ÿé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œåœ¨â€œMySQL æ•°æ®åº“â€œç« èŠ‚ä¸­æœ‰ä¸€åˆ™æ¨èï¼Œä»…ä¾›å‚è€ƒï¼š\nã€æ¨èã€‘å•è¡¨è¡Œæ•°è¶…è¿‡ 500 ä¸‡è¡Œæˆ–è€…å•è¡¨å®¹é‡è¶…è¿‡ 2 GBï¼Œæ‰æ¨èè¿›è¡Œåˆ†åº“åˆ†è¡¨ã€‚ è¯´æ˜ï¼šå¦‚æœé¢„è®¡ä¸‰å¹´åçš„æ•°æ®é‡æ ¹æœ¬è¾¾ä¸åˆ°è¿™ä¸ªçº§åˆ«ï¼Œè¯·ä¸è¦åœ¨åˆ›å»ºè¡¨æ—¶å°±åˆ†åº“åˆ†è¡¨ã€‚\næˆ‘ä»¬é€šå¸¸ä½¿ç”¨å‚ç›´åˆ†åŒºï¼ˆvertical partitioningï¼‰å’Œæ°´å¹³åˆ†åŒºï¼ˆhorizontal partitioningï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nVP1 å’Œ VP2 è¡¨ç°å¾—åƒä¸¤å¼ å¯é€šè¿‡ ID å…³è”èµ·æ¥çš„è¡¨ï¼ŒHP1 å’Œ HP2 çš„ scheme å’Œåˆ—ï¼ˆcolumnsï¼‰ç›¸åŒï¼Œä½†è¡Œï¼ˆrowsï¼‰ä¸åŒã€‚è¡Œçš„å¢é•¿é€Ÿåº¦é€šå¸¸å¿«äºåˆ—çš„å¢é•¿é€Ÿåº¦ï¼Œæˆ‘ä»¬æ›´å…³æ³¨æ°´å¹³åˆ†åŒºï¼Œæ•°æ®åº“åˆ†ç‰‡æ˜¯æ•°æ®åº“æˆ–æœç´¢å¼•æ“çš„æ°´å¹³åˆ†åŒºï¼›ä½†æ–°é—®é¢˜éšä¹‹è€Œæ¥ï¼šå‡è®¾ HP1ã€HP2ã€HP3ã€HP4\u0026hellip;\u0026hellip; åŒ…å«äº†å¤šå¼ è¡¨çš„æ•°æ®ï¼Œä¸”ç”±å¤šä¸ª MySQL server ç»´æŠ¤ï¼Œå¦‚æœå®¢æˆ·ç«¯è¦æŸ¥æ‰¾æ»¡è¶³ç»™å®šæ¡ä»¶çš„ä¸€è¡Œæˆ–å¤šè¡Œè®°å½•ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥å‘å“ªä¸ªæˆ–å“ªäº› MySQL server å‘èµ·è¯·æ±‚ï¼Ÿå¦‚ä½•åˆå¹¶å¤šä¸ªç»“ç‚¹è¿”å›çš„ç»“æœé›†ï¼Ÿå¦‚ä½•æ‰§è¡Œè·¨åˆ†åŒº JOINã€æ’åºã€åˆ†é¡µã€åˆ†ç»„ç­‰æ“ä½œï¼Ÿå¦‚ä½•ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ\nåœ¨ä»¥å‰ï¼Œä¸Šé¢é—®é¢˜çš„è§£å†³æ–¹æ¡ˆå¸¸å¸¸æ˜¯æ•°æ®åº“ä¸­é—´ä»¶ï¼Œæ•°æ®åº“ä¸­é—´ä»¶çš„è®¾è®¡æ¨¡å¼è‡³å°‘æœ‰ä¸¤ç§ï¼ŒProxy å’Œ Smart Clientã€‚Proxy æ˜¯åº”ç”¨ç¨‹åºä¸æ•°æ®åº“é›†ç¾¤çš„ä¸­é—´å±‚ï¼Œå®ƒå¯¹å®¢æˆ·ç«¯åˆ¶é€ äº†å•ä¸€æ•°æ®åº“å®ä¾‹çš„å‡è±¡ï¼Œå®¢æˆ·ç«¯å‘é€åˆ° Proxy çš„è¯·æ±‚å°†ç”± Proxy åˆ†å‘ç»™ä¸‹å±‚çš„æ•°æ®åº“æœåŠ¡å™¨ï¼›Smart Client æ˜¯ä¸åº”ç”¨ç¨‹åºé›†æˆçš„åº“æˆ–æ¡†æ¶ï¼Œå®¢æˆ·ç«¯å‘æ•°æ®åº“é›†ç¾¤å‘èµ·çš„è¯·æ±‚å°†ç”±å®¢æˆ·ç«¯è·¯ç”±ã€‚ä¸¤è€…çš„å›¾åƒå¯å‚è€ƒä»£ç†åˆ†å‘å’Œå®¢æˆ·ç«¯è·¯ç”±ã€‚\nç›®å‰ï¼Œå¼€æºä¸”è¾ƒæ´»è·ƒçš„æ•°æ®åº“ä¸­é—´ä»¶æœ‰ ShardingSphereã€MyCATã€vitess ç­‰ç­‰ï¼Œä¸€ç›´ä»¥æ¥å‹‰å¼ºå¯ç”¨ï¼Œä½†æ˜¯å‰ä¸¤è€…çš„ç¼ºç‚¹ä¹Ÿä¸å®¹å¿½è§†ï¼š\nä¾µå…¥æ€§ã€‚è¦æ±‚ç”¨æˆ·æŒ‡å®š shard key å’Œå…¶å®ƒåˆ†ç‰‡é…ç½®ï¼›å¦‚æœåŸä¸šåŠ¡é€»è¾‘åŒ…å« JOINã€subquery ç­‰å¤æ‚ SQLï¼Œæ”¹åŠ¨å·¥ä½œé‡å¯èƒ½éš¾ä»¥ä¼°è®¡ã€‚\nä¸æ”¯æŒé€æ˜åˆ†ç‰‡ã€‚ç»´æŠ¤åˆ†ç‰‡æˆ–é›†ç¾¤çš„ä»£ä»·éšç€ç»“ç‚¹çš„å¢å¤šè€Œéçº¿æ€§å¢é•¿ã€‚\næš‚ä¸æ”¯æŒå¼¹æ€§ä¼¸ç¼©ã€‚æ®è¯´éƒ½è¿˜åœ¨å¼€å‘ä¸­ã€‚\nå¤æ‚æŸ¥è¯¢ä¼˜åŒ–èƒ½åŠ›è¾ƒå¼±ã€‚ä¸èƒ½ç”Ÿæˆæœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ï¼ˆplanï¼‰ï¼Œè®¸å¤šä¼˜åŒ–å·¥ä½œæ¨å¸ç»™åº”ç”¨ç¨‹åºã€‚\nå¦‚ä½•å°†åŸå§‹è¡¨ï¼ˆorginal tableï¼‰çš„è®°å½•åˆ†é…ç»™å¤šä¸ª MySQL serverï¼ˆå®ä¾‹ã€è¿›ç¨‹ï¼‰ï¼Ÿæ•°æ®åº“ä¸­é—´ä»¶æ˜¯åº”ç”¨ç¨‹åºçº§åˆ«çš„å®ç°ï¼ŒMySQL Cluster åˆ™æ˜¯æ•°æ®åº“çº§åˆ«çš„å®ç°ï¼Œå®ƒå£°ç§°æ”¯æŒè·¨ç»“ç‚¹è‡ªåŠ¨åˆ†ç‰‡ï¼ˆåˆ†åŒºï¼‰ï¼Œå¯æ˜¯å®ƒæ˜¯é€šè¿‡ NDB å­˜å‚¨å¼•æ“å®ç°çš„ï¼Œä¸æ¸©ä¸ç«ã€‚\nä¸»ä»å¤åˆ¶ MySQL çš„æ•°æ®å¤åˆ¶æ¨¡å‹æ˜¯ä¸»ä»å¤åˆ¶ã€‚ä¼ ç»Ÿä¸»ä»å¤åˆ¶å›¾åƒï¼šä¸»ç»“ç‚¹ï¼ˆä¸»å‰¯æœ¬ã€ä¸»åº“ï¼‰å¤„ç†è¯»/å†™è¯·æ±‚ï¼Œè‹¥æ˜¯å†™è¯·æ±‚åˆ™é€šè¿‡åŒæ­¥å¤åˆ¶æˆ–å¼‚æ­¥å¤åˆ¶å°†æ•°æ®å˜æ›´æ—¥å¿—ï¼ˆäº‹ä»¶æˆ–æ—¥å¿—è®°å½•ï¼‰å‘é€åˆ°æ‰€æœ‰ä»ç»“ç‚¹ï¼ˆä»å‰¯æœ¬ã€ä»åº“ï¼‰ï¼Œä»ç»“ç‚¹æŒ‰ç…§æ—¥å¿—ï¼ˆæ—¥å¿—è®°å½•æˆ–äº‹ä»¶ï¼‰å†™å‰¯æœ¬ï¼›ä¸€èˆ¬æƒ…å†µï¼Œä»ç»“ç‚¹åªè¯»ï¼Œæ•…éšœè½¬ç§»æ—¶ä»ç»“ç‚¹å¯æå‡ä¸ºä¸»ç»“ç‚¹ã€‚ä¼ ç»Ÿçš„åŒæ­¥å¤åˆ¶ä¾§é‡ä¸€è‡´æ€§ï¼Œè¦æ±‚â€çŸ­æš‚â€œçš„ä¸å¯ç”¨ï¼Œä¸»ç»“ç‚¹éœ€è¦ç­‰å¾…ä»ç»“ç‚¹çš„ç¡®è®¤ï¼›ä¼ ç»Ÿçš„å¼‚æ­¥å¤åˆ¶ä¾§é‡å¯ç”¨æ€§ï¼Œè¦æ±‚â€œçŸ­æš‚â€çš„ä¸ä¸€è‡´ï¼Œä»ç»“ç‚¹æ»åäºä¸»ç»“ç‚¹ã€‚\nå¦‚æœæŠŠæ‰€æœ‰ä»ç»“ç‚¹é…ç½®ä¸ºåŒæ­¥å¤åˆ¶æ¨¡å¼ï¼Œé‚£ä¹ˆä»»ä½•å¤±æ•ˆæˆ–æ€§èƒ½ä¸‹é™çš„ä»ç»“ç‚¹ä¼šå¯¼è‡´ç³»ç»Ÿé˜»å¡ã€‚MySQL æ”¯æŒè®¾ç½®åŠåŒæ­¥æ¨¡å¼ï¼ŒæŸä¸€ä¸ªä»ç»“ç‚¹é…ç½®ä¸ºåŒæ­¥æ¨¡å¼ï¼Œå…¶å®ƒä»ç»“ç‚¹é…ç½®ä¸ºå¼‚æ­¥æ¨¡å¼ï¼›å½“åŒæ­¥æ¨¡å¼çš„ä»ç»“ç‚¹å¤±æ•ˆæ—¶ï¼Œå¦ä¸€ä¸ªä»ç»“ç‚¹ä»å¼‚æ­¥æ¨¡å¼æå‡ä¸ºåŒæ­¥æ¨¡å¼ï¼Œè¿™ä¹ˆåšçš„å¥½å¤„ä¹‹ä¸€æ˜¯ä¿è¯è‡³å°‘æœ‰ä¸¤ä¸ªç»“ç‚¹ï¼ˆä¸»ç»“ç‚¹å’ŒåŒæ­¥æ¨¡å¼çš„ä»ç»“ç‚¹ï¼‰æ‹¥æœ‰æœ€æ–°çš„æ•°æ®å‰¯æœ¬ã€‚åŠåŒæ­¥å¹¶éé«˜æ•æ— å¿§ï¼Œå¾®ä¿¡åå°å›¢é˜Ÿåœ¨ MySQL åŠåŒæ­¥å¤åˆ¶çš„æ•°æ®ä¸€è‡´æ€§æ¢è®¨ä¸­æ€»ç»“äº† MySQL çš„åŠåŒæ­¥å¤åˆ¶å’Œ Master åˆ‡æ¢éƒ½å­˜åœ¨ä¸€äº›ä¸è¶³ï¼Œæ•°æ®å¤åˆ¶å­˜åœ¨å›æ»šéš¾é¢˜ï¼ŒMaster åˆ‡æ¢å­˜åœ¨å¤š Master éš¾é¢˜ã€‚\nä¸»ä»å¤åˆ¶æ¨¡å‹ä¸èƒ½ä¿è¯åŒæ—¶æ»¡è¶³å¼ºä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§ã€‚å¦‚æœå‡ºç°ç»“ç‚¹å¤±æ•ˆã€ç½‘ç»œä¸­æ–­ã€å»¶è¿ŸæŠ–åŠ¨ç­‰æƒ…å†µï¼Œå¤šä¸»ç»“ç‚¹å¤åˆ¶æ–¹æ¡ˆä¼šæ›´åŠ å¯é ï¼Œä½†æ˜¯ä»£ä»·åˆ™æ˜¯ç³»ç»Ÿçš„é«˜å¤æ‚åº¦å’Œå¼±ä¸€è‡´æ€§ä¿è¯ã€‚å¤šä¸»ç»“ç‚¹å¤åˆ¶é€‚ç”¨äºå¤šæ•°æ®ä¸­å¿ƒï¼Œæ¯ä¸ªæ•°æ®ä¸­å¿ƒé‡‡ç”¨å¸¸è§„çš„ä¸»ä»å¤åˆ¶æ–¹æ¡ˆï¼Œå„ä¸ªæ•°æ®ä¸­å¿ƒçš„ä¸»ç»“ç‚¹è´Ÿè´£ä¸å…¶å®ƒæ•°æ®ä¸­å¿ƒçš„ä¸»ç»“ç‚¹äº¤æ¢ replicated logã€‚\nå°ç»“ é¢å¯¹é€æ˜åˆ†ç‰‡ï¼ˆtransparent shardingï¼‰ã€å¼¹æ€§ä¼¸ç¼©ï¼ˆauto-scalingï¼‰ã€è‡ªåŠ¨æ¢å¤ï¼ˆauto-failoverï¼‰ã€å¼‚åœ°å¤šæ´»ï¼ˆmulti-data centerï¼‰ï½ç­‰éœ€æ±‚ï¼Œä¼ ç»Ÿçš„è§£å†³æ–¹æ¡ˆä½¿æˆ‘ä»¬é™·å…¥çª˜å¢ƒã€‚\nSQL å’Œ NoSQL ACID å’Œ BASE ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ NoSQL æ•°æ®åº“ä»£æ›¿ MySQL æ•°æ®åº“å‘¢ï¼Ÿå‡è®¾æˆ‘ä»¬æœ‰äº†å¤§åˆ€é˜”æ–§è¿ç§»æ•°æ®å’Œé‡å†™åº”ç”¨ç¨‹åºçš„å†³å¿ƒï¼ˆåŸºæœ¬ä¸å¯èƒ½ï¼‰ï¼Œä½†æ˜¯è®¸å¤š NoSQL æ•°æ®åº“éƒ½ç‰ºç‰²äº†ä¸€è‡´æ€§ï¼Œè€Œå€¾å‘äºå¯ç”¨æ€§ï¼Œè¿™ç§ä¸€è‡´æ€§æ¨¡å‹å¾€å¾€è¢«ç§°ä¸º BASEï¼š\nåŸºæœ¬å¯ç”¨æ€§ï¼ˆBasically Availableï¼‰ã€‚\nè½¯çŠ¶æ€ï¼ˆSoft stateï¼‰ã€‚ç±»ä¼¼ä¸­é—´çŠ¶æ€ã€‚\næœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual consistencyï¼‰ã€‚\nBASE æ¨¡å‡Œä¸¤å¯ï¼Œå¤ªé•¿æˆ–æ°¸è¿œä¸ä¸€è‡´çš„ç³»ç»ŸåŸºæœ¬ä¸å¯ç”¨ã€‚è®¸å¤šå¤„ç†é‡è¦æ•°æ®çš„ç³»ç»Ÿï¼ˆä¾‹å¦‚ï¼Œè´¢åŠ¡ã€è®¢å•ã€äº’è”ç½‘é‡‘èç³»ç»Ÿç­‰ï¼‰éšç€å¿«é€Ÿå¢é•¿çš„æ•°æ®å’Œè´Ÿè½½ï¼Œå¸¸è§„çš„å…³ç³»æ•°æ®åº“æ‰©å±•å›°éš¾ï¼Œè€Œå¯¹äº ACID ï¼Œç‰¹åˆ«æ˜¯ä¸€è‡´æ€§çš„è¦æ±‚ï¼ŒNoSQL æ•°æ®åº“éš¾ä»¥æ»¡è¶³ã€‚ç›¸è¾ƒäº BASE çš„æ‰¿è¯ºï¼Œå…³ç³»æ•°æ®åº“çš„ ACID çš„æ‰¿è¯ºæ˜¯äº”åæ­¥ç¬‘ç™¾æ­¥ï¼ˆä¸€è‡´æ€§å¾€å¾€æ¨å¸ç»™åº”ç”¨ç¨‹åºï¼‰ï¼š\nåŸå­æ€§ï¼ˆAtomicityï¼‰ã€‚äº‹åŠ¡ä¸­çš„æ“ä½œåºåˆ—ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼ˆæäº¤ï¼‰ï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œï¼ˆå›æ»šï¼‰ã€‚\nä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€‚ä¸è•´å«çŸ›ç›¾ï¼Œé€»è¾‘è‡ªæ´½\u0026hellip;\u0026hellip;\néš”ç¦»æ€§ï¼ˆIsolationï¼‰ã€‚åŒæ—¶è¿è¡Œçš„äº‹åŠ¡ä¸åº”ç›¸äº’å¹²æ‰°ï¼Œäº‹åŠ¡æäº¤æ—¶ï¼Œå…¶ç»“æœä¸ä¸²è¡Œæ‰§è¡Œå®Œå…¨ç›¸åŒã€‚\næŒä¹…æ€§ï¼ˆDurabilityï¼‰ã€‚æ— å®Œç¾æˆ–ç»å¯¹çš„ä¿è¯ã€‚\næ•°æ®æ¨¡å‹ä¸æŸ¥è¯¢è¯­è¨€ NoSQL æ•°æ®åº“ç¼ºä¹ JOIN çš„èƒ½åŠ›ï¼Œè¿™æ˜¯å…¶æ–‡æ¡£æ¨¡å‹çš„é™åˆ¶ã€‚å…³ç³»æ•°æ®åº“å¸‚åœºå æœ‰ç‡ä¸€ç›´å±…é«˜ä¸ä¸‹ï¼Œå‚è€ƒ DB-Engines Rankingï¼ŒåŸå› ä¹‹ä¸€æ˜¯ SQLï¼ˆDDLã€DMLã€DQLã€DCLï¼‰ æ˜¯å£°æ˜å¼è¯­è¨€çš„ä»£è¡¨ï¼Œå®ƒçš„ç®€å•ä¸ç»Ÿä¸€åœ¨äºæŒ‡å®šç»“æœæ‰€æ»¡è¶³çš„æ¨¡å¼ï¼Œåœ¨ä¸æ”¹å˜è¯­å¥çš„å‰æä¸‹ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨æˆ–åº•å±‚å¼•æ“çš„è¿­ä»£æ›´æ–°å°±æœ‰å¯èƒ½æ˜¾è‘—æé«˜æ€§èƒ½ã€‚\nSQL çš„å…³ç³»æ¨¡å‹ç†è®ºè¶³å¤Ÿä¼˜é›…ï¼š\nå…³ç³»æ˜¯ç¬›å¡å°”ç§¯çš„ä¸€ä¸ªå­é›†ã€‚\nå…³ç³»ï¼ˆè¡¨ï¼‰æ˜¯å…ƒç»„ï¼ˆè¡Œï¼‰çš„é›†åˆã€‚\nå…³ç³»ï¼ˆè¡¨ï¼‰ç»è¿‡è¿ç®—ä»¥åï¼Œå¦‚ SELECTã€JOINã€WHEREã€äº¤ã€å¹¶ã€å·®ï¼ˆå…³ç³»ä»£æ•°ï¼‰ï¼Œç»“æœè¿˜æ˜¯ä¸€ä¸ªå…³ç³»ï¼ˆè¡¨ï¼‰ã€‚\nè¿‘å¹´æ¥ï¼Œæµè¡Œå¼€æºç»„ä»¶æä¾›ç±» SQL çš„è¶‹åŠ¿è¶Šæ¥è¶Šæ˜æ˜¾ï¼Œä¾‹å¦‚ Spark SQLã€KSQLã€Flink SQLã€ClickHouse SQL\u0026hellip;\nNewSQL æ–°åœ¨å“ª NewSQL æ˜¯ä¸€ç±»å…³ç³»æ•°æ®åº“ç³»ç»Ÿï¼Œæ—¨åœ¨ä¸º OLTP æä¾› NoSQL æ•°æ®åº“ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ï¼ŒåŒæ—¶æä¾›ä¼ ç»Ÿå…³ç³»æ•°æ®åº“ç³»ç»Ÿçš„ ACID ä¿è¯ã€‚OLTP ä¸ OLAP æœ‰æ—¶åŒºåˆ†å¹¶ä¸æ˜¯é‚£ä¹ˆæ˜æ˜¾ï¼Œå‰è€…ä¾§é‡ Tï¼ˆäº‹åŠ¡ï¼‰ï¼Œåè€…ä¾§é‡ Aï¼ˆåˆ†æï¼‰ï¼š\nNewSQL æ•°æ®åº“ç³»ç»Ÿæ–°åœ¨æ¶æ„ã€å­˜å‚¨å¼•æ“ã€å…±è¯†ç®—æ³•ã€‚\nä½ å¥½ TiDB TiDB é¡¹ç›®å—åˆ°äº† Spanner/F1 ä¸ Raft çš„å¯å‘ï¼ŒTiKV å¯¹åº”çš„æ˜¯ Spannerï¼ŒTiDB å¯¹åº”çš„æ˜¯ F1ï¼Œè¯¦æƒ…è¯·çœ‹ TiDB æ•´ä½“æ¶æ„ã€TiDB æ•°æ®åº“çš„å­˜å‚¨ã€TiDB æ•°æ®åº“çš„è®¡ç®—ã€è°ƒåº¦æ¦‚è¿°\u0026hellip;\u0026hellip;\nSQL Layer æ— çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡è´Ÿè½½å‡è¡¡ç»„ä»¶ï¼ˆå¦‚ LVSã€HAProxyã€F5ï¼‰å¯¹å¤–æä¾›ç»Ÿä¸€çš„æ¥å…¥åœ°å€ã€‚\n1 tiup playground v4.0.0 --db 3 --kv 4 --pd 3 --monitor å¦‚ä¸Šæ‰€ç¤ºï¼Œä½¿ç”¨ tiup å¯åŠ¨äº† 3 ä¸ª TiDB å®ä¾‹å’Œ 4 ä¸ª TiKV å®ä¾‹ä»¥åŠ 3 ä¸ª PD å®ä¾‹ã€‚\n1 2 3 4 5 6 7 8 9 10 Waiting for tikv 127.0.0.1:20160 ready Waiting for tikv 127.0.0.1:20161 ready Waiting for tikv 127.0.0.1:20162 ready Waiting for tikv 127.0.0.1:20163 ready CLUSTER START SUCCESSFULLY, Enjoy it ^-^ To connect TiDB: mysql --host 127.0.0.1 --port 4000 -u root To connect TiDB: mysql --host 127.0.0.1 --port 4001 -u root To connect TiDB: mysql --host 127.0.0.1 --port 4002 -u root To view the dashboard: http://127.0.0.1:2379/dashboard To view the monitor: http://127.0.0.1:9090 TiDB éå¸¸å‹å¥½åœ°å…¼å®¹äº† MySQL 5.7 åè®®ï¼Œä» MySQL è¿ç§»åˆ° TiDB å¯¹åº”ç”¨ç¨‹åºæ— é™æ¥è¿‘é›¶ä¾µå…¥ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ MySQL å‘½ä»¤è¡Œå·¥å…·è¿æ¥æŸä¸€ä¸ª TiDB å®ä¾‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 % mysql --host 127.0.0.1 --port 4000 -u root Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 5 Server version: 5.7.25-TiDB-v4.0.0 TiDB Server (Apache License 2.0) Community Edition, MySQL 5.7 compatible Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. mysql\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | INFORMATION_SCHEMA | | METRICS_SCHEMA | | PERFORMANCE_SCHEMA | | mysql | | test | +--------------------+ 5 rows in set (0.00 sec) å¯¼å…¥æ ·æœ¬æ•°æ®é›†åˆ°æŸä¸€ä¸ª TiDB å®ä¾‹ï¼Œæ ·æœ¬æ•°æ®é›†çš„ database åç§°ä¸º employeesã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 % mysql --host 127.0.0.1 --port 4001 -u root \u0026lt; employees.sql INFO CREATING DATABASE STRUCTURE INFO storage engine: InnoDB INFO LOADING departments INFO LOADING employees INFO LOADING dept_emp INFO LOADING dept_manager INFO LOADING titles INFO LOADING salaries data_load_time_diff NULL æˆ‘ä»¬ä¼šå‘ç°ï¼Œè¿æ¥ä»»æ„ä¸€ä¸ª TiDB å®ä¾‹éƒ½èƒ½è§‚å¯Ÿåˆ° employees åº“ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 mysql\u0026gt; show tables from employees; +----------------------+ | Tables_in_employees | +----------------------+ | current_dept_emp | | departments | | dept_emp | | dept_emp_latest_date | | dept_manager | | employees | | salaries | | titles | +----------------------+ 8 rows in set (0.00 sec) TiKV æ•°æ®åˆ†åŒºçš„æœ¯è¯­æ˜¯ Regionï¼Œä½¿ç”¨ Raft å¯¹å†™å…¥æ•°æ®åœ¨å¤šä¸ª TiKV ç»“ç‚¹ï¼ˆå®ä¾‹ï¼‰ä¹‹é—´è‡ªåŠ¨åˆ†ç‰‡å’Œå¤åˆ¶æ—¥å¿—ï¼Œæ¯ä¸ª Region çš„æ‰€æœ‰å‰¯æœ¬ï¼ˆé»˜è®¤ä¸ºä¸‰å‰¯æœ¬ï¼‰ç»„æˆä¸€ä¸ª Raft Groupï¼Œæ¯ä¸ª TiKV å®ä¾‹ï¼ˆç»“ç‚¹ï¼‰è´Ÿè´£å¤šä¸ª Regionã€‚\nåŒåŸå¤šæ•°æ®ä¸­å¿ƒéƒ¨ç½²å’Œä¸¤åœ°ä¸‰ä¸­å¿ƒéƒ¨ç½²åˆ™æä¾›äº†æ›´å¼ºå¤§çš„å®¹é”™ï¼ˆå®¹ç¾ï¼‰èƒ½åŠ›ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ Designing Data-Intensive Applications\nUnderstanding Database Sharding\nâ€œåˆ†åº“åˆ†è¡¨\u0026quot; ï¼Ÿé€‰å‹å’Œæµç¨‹è¦æ…é‡ï¼Œå¦åˆ™ä¼šå¤±æ§\nMySQL 5.7 Reference Manual # Replication Implementation\nSQL vs NoSQL: What\u0026rsquo;s the difference?\nWiki # NewSQL\nShared-nothing architecture\næ¼”è®²å®å½•|é»„ä¸œæ—­ï¼šåˆ†å¸ƒå¼æ•°æ®åº“æ¨¡å¼ä¸åæ¨¡å¼\nHow do we build TiDB\nPingCAP blog\nTiDB æ•°æ®åº“å¿«é€Ÿä¸Šæ‰‹æŒ‡å—\nPingCAP docs\n","date":"2020-07-11T11:21:03+08:00","permalink":"https://h2cone.github.io/2020/07/11/from-mysql-to-tidb/","title":"ä» MySQL åˆ° TiDB"},{"content":"å…³é”® å˜é‡æ˜¯åŒ…å«å€¼çš„å­˜å‚¨ã€‚ æŒ‡é’ˆçš„å€¼æ˜¯å˜é‡çš„åœ°å€ã€‚ Go è¯­è¨€çš„å˜é‡éƒ½æ‹¥æœ‰åœ°å€ï¼Œè€ŒæŒ‡é’ˆæ˜¯ä¸€ä¸ªå˜é‡ï¼Œå®ƒçš„å€¼æ˜¯å¦å¤–ä¸€ä¸ªå˜é‡çš„åœ°å€ã€‚å½“æˆ‘ä»¬è¯´æ•´å‹æŒ‡é’ˆæ—¶ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯ä¸€ç±»å‹çš„æŒ‡é’ˆã€‚è€ƒè™‘ä¸‹é¢çš„ä»£ç ç‰‡æ®µï¼š\n1 2 3 4 5 x := 1 p := \u0026amp;x // p, ç±»å‹ *int, æŒ‡å‘ x fmt.Println(*p) // \u0026#34;1\u0026#34; *p = 2 // ç›¸å½“äº x = 2 fmt.Println(x) // \u0026#34;2\u0026#34; æ“ä½œç¬¦ \u0026amp; ä½œç”¨äºå˜é‡ xï¼Œäº§ç”Ÿäº†æŒ‡é’ˆ pï¼Œp çš„ç±»å‹æ˜¯ *intï¼Œå¯ä»¥å‘ç°å…¶ä¸­ int å°±æ˜¯ x çš„ç±»å‹ï¼›æ“ä½œç¬¦ * ä½œç”¨äº pï¼Œæ£€ç´¢äº† p æŒ‡å‘çš„å˜é‡ xï¼Œèƒ½å¤Ÿè¯»å†™ x çš„å€¼ï¼Œä½†æ˜¯è¿™åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿä¸‹å›¾æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç±»æ¯”ï¼š\nå·¦è¾¹ä¸ºå˜é‡ï¼Œä¸­é—´ä¸ºåœ°å€ ï¼ˆè¯•ç€æ‰“å°ä¸€ä¸‹ pï¼‰ï¼Œå³è¾¹ä¸ºå€¼ã€‚å½“æ‰§è¡Œäº† p := \u0026amp;x åï¼Œ*p æ˜¯ x çš„åˆ«åï¼Œæ•…èµ‹æ–°å€¼ç»™ *p ä¹Ÿå°±æ›´æ”¹äº† x çš„å€¼ã€‚ä¸ºä»€ä¹ˆæŒ‡é’ˆè¿˜éœ€è¦ç»‘å®šç±»å‹ï¼Ÿå‡ºäºç±»å‹å®‰å…¨è€ƒè™‘ï¼Œå¦‚æœæŠŠä¸Šé¢ä»£ç çš„ *p = 2 æ›¿æ¢æˆ *p = \u0026quot;two\u0026quot;ï¼Œé‚£ä¹ˆç¼–è¯‘ä¸é€šè¿‡ã€‚\nç•…æƒ³ Go å‡½æ•°è°ƒç”¨çš„å‚æ•°ä¼ é€’æ˜¯å€¼ä¼ é€’ï¼Œå€¼å¯èƒ½æ˜¯åœ°å€ï¼Œæ‹·è´åœ°å€å¾€å¾€æ›´é«˜æ•ˆï¼Œä¸”èƒ½æ“çºµæŒ‡å‘çš„å˜é‡çš„å€¼æˆ–å¼•ç”¨çš„æ•°æ®ç»“æ„ã€‚ Java æŠŠæŒ‡é’ˆ ï¼ˆPointerï¼‰ä¼ªè£…æˆå¼•ç”¨ï¼ˆReferenceï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™äº§ç”Ÿäº†è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ã€‚ Java æ–¹æ³•è°ƒç”¨çš„å‚æ•°ä¼ é€’ä¼°è®¡æ˜¯å€¼ä¼ é€’ï¼Œåªä¸è¿‡åŸå§‹ç±»å‹ ï¼ˆprimitive typeï¼‰èµ‹äºˆçš„æ˜¯åŸå€¼è€Œå¼•ç”¨ç±»å‹ ï¼ˆreference typeï¼‰èµ‹äºˆçš„æ˜¯åœ°å€ã€‚ æœ¬æ–‡é¦–å‘äº https://h2cone.github.io\n","date":"2020-06-21T11:11:59+08:00","permalink":"https://h2cone.github.io/2020/06/21/go-pointer/","title":"Go æŒ‡é’ˆè¦ç‚¹"},{"content":"å›¾ç‰‡æ¥è‡ªç½‘ç»œ æœ¬æ–‡é¦–å‘äº https://h2cone.github.io\n","date":"2020-06-04T00:00:24+08:00","permalink":"https://h2cone.github.io/2020/06/04/goodbye-spring/","title":"Goodbye Spring"},{"content":"é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®® ä¼—æ‰€å‘¨çŸ¥ï¼ŒRabbitMQ å®ç°äº† AMQPï¼ˆAdvanced Message Queuing Protocolï¼‰ï¼Œå‡†ç¡®æ¥è¯´æ˜¯ AMQP 0-9-1ï¼›AMQP æ˜¯ä¸€ç§ä½¿ç¬¦åˆè¦æ±‚çš„å®¢æˆ·ç«¯å¯ä»¥ä¸ç¬¦åˆè¦æ±‚çš„æ¶ˆæ¯ä»£ç†ï¼ˆmessage brokerï¼‰è¿›è¡Œé€šä¿¡çš„ä¸€ç§æ¶ˆæ¯ä¼ é€’åè®®ï¼Œå®ƒçš„æ¦‚å¿µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nç”Ÿäº§è€…ï¼ˆproducerï¼‰å‘å¸ƒæ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ï¼ˆconsumerï¼‰æ¶ˆè€—æ¶ˆæ¯ã€‚ç”Ÿäº§è€…æˆ–å‘å¸ƒè€…ï¼ˆpublisherï¼‰é€šå¸¸æ— éœ€å…³å¿ƒä»¥ä¸‹å‡ ç‚¹ï¼š\næ¶ˆæ¯å°†å‘é€åˆ°å“ªäº›é˜Ÿåˆ—ï¼ˆqueueï¼‰ã€‚\næ¶ˆæ¯ï¼ˆmessageï¼‰è¢«å“ªäº›æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚\nExchange æ¥æ”¶ç”Ÿäº§è€…å‘å¸ƒçš„æ¶ˆæ¯å¹¶è·¯ç”±åˆ°é˜Ÿåˆ—ï¼Œexchange æ ¹æ®ä»€ä¹ˆè½¬å‘æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Ÿäººç±»å¯ä»¥ä½¿ç”¨ç»‘å®šï¼ˆbindingï¼‰æ¥å®šä¹‰ queue å’Œ exchange çš„å…³ç³»ä»¥åŠæä¾›æ¶ˆæ¯è·¯ç”±è§„åˆ™ã€‚ç”Ÿäº§è€…åªé¢å‘ exchange å‘å¸ƒæ¶ˆæ¯ï¼Œè€Œæ¶ˆè´¹è€…åªé¢å‘ queue æ¶ˆè€—æ¶ˆæ¯ï¼Œå› æ­¤å¸¸è¯´ RabbitMQ è§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚\nå€¼å¾—ä¸€æçš„æ˜¯ï¼Œå•ç‹¬çš„ MySQL server å¯ä»¥åˆ›å»ºå¤šä¸ªæ•°æ®åº“ï¼›ä¸æ­¤ç±»ä¼¼ï¼Œå•ç‹¬çš„ RabbitMQ server å¯ä»¥åˆ›å»ºå¤šä¸ªè™šæ‹Ÿä¸»æœºï¼ˆvirtual hostï¼‰ã€‚è™šæ‹Ÿä¸»æœºåŒ…å« queues å’Œ exchanges ä»¥åŠ bindingsï¼Œè™šæ‹Ÿä¸»æœºä¹‹é—´å¯ç›¸äº’éš”ç¦»ã€‚\nExchange å½“æˆåŠŸå®‰è£…äº† RabbitMQ å¹¶æ­£å¸¸å¯åŠ¨åï¼Œå¯ä»¥é€šè¿‡åå°ç®¡ç†ç•Œé¢å»ç›´è§‚è®¤è¯†è¿™ç§æ¶ˆæ¯ä»£ç†ï¼Œä¸éš¾å‘ç° RabbitMQ æä¾›äº† 4 ç§ exchange ç±»å‹ï¼š\nExchange ä½¿ç”¨çš„è·¯ç”±ç®—æ³•å–å†³äº exchange ç±»å‹å’Œ binding è§„åˆ™ã€‚\nDirect exchange å¦‚æœä¸€ä¸ª exchange çš„ç±»å‹æ˜¯ directï¼Œå°†ä¸€ä¸ª queue ç»‘å®šåˆ°è¯¥ exchange æ—¶ï¼Œè¦æ±‚é™„åŠ ä¸€ä¸ªåä¸º routing key çš„å‚æ•°ï¼›å½“ä¸€ä¸ªæºå¸¦ routing key çš„æ¶ˆæ¯åˆ°è¾¾è¯¥ exchange æ—¶ï¼Œè¯¥ exchange å°†è½¬å‘æ¶ˆæ¯åˆ°ç›¸åº”çš„ queueï¼ˆç²¾ç¡®åŒ¹é… routing keyï¼‰ã€‚\nFonout exchange ç±»å‹ä¸º fonout çš„ä¸€ä¸ª exchange å¿½ç•¥ routing keyï¼Œå°†æ¶ˆæ¯å¹¿æ’­åˆ°æ‰€æœ‰ä¸è¯¥ exhange ç»‘å®šçš„ queueã€‚\nTopic exchange å®ƒä¸ direct exchange ç±»ä¼¼ï¼Œç»‘å®šæ—¶è¦æ±‚è®¾ç½® routing keyï¼Œä¸åŒåœ¨äºè·¯ç”±æ—¶ topic exchange æ”¯æŒæ¨¡ç³ŠåŒ¹é…æˆ–æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… routing keyã€‚\nHeaders exchange å®ƒå¿½ç•¥ routing keyï¼Œè·¯ç”±æ˜¯æ ¹æ®æ¶ˆæ¯ä¸­çš„ header å’Œç»‘å®šæ—¶è®¾ç½®çš„ argumentã€‚\nå¯é çš„æ¶ˆæ¯ä¼ é€’ å³ä½¿ TCP ç¡®è®¤ä¸€ä¸ªæ•°æ®åŒ…å·²ç»å‘é€åˆ°ç›®æ ‡ç»“ç‚¹ï¼Œä½†åº”ç”¨ç¨‹åºä¹Ÿå¯èƒ½åœ¨å¤„ç†å®Œæˆä¹‹å‰å‘ç”Ÿå´©æ„¤ã€‚å¦‚æœä½ æƒ³çŸ¥é“ä¸€ä¸ªè¯·æ±‚æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œå°±éœ€è¦åº”ç”¨çº§åˆ«çš„å›å¤ã€‚\næ‰€è°“å¯é çš„æ¶ˆæ¯ä¼ é€’ï¼Œå‚è€ƒåº•å±‚ TCP å¯é ä¼ è¾“çš„åŸºæœ¬æ€æƒ³ï¼Œåº”ç”¨å±‚çš„ RabbitMQ æ˜¯å¦ä¹Ÿæœ‰ç¡®è®¤ã€è¶…æ—¶ã€é‡ä¼ ç­‰æ¦‚å¿µï¼Ÿ\nç¡®è®¤ä¸å›æ‰§ Publisher confirms å…è®¸æ¶ˆæ¯ä»£ç†å‘å‘å¸ƒè€…è¡¨æ˜æ¶ˆæ¯å·²æ”¶åˆ°æˆ–å·²å¤„ç†ï¼ŒConsumer acknowledgements å…è®¸æ¶ˆè´¹è€…å‘æ¶ˆæ¯ä»£ç†è¡¨æ˜æ¶ˆæ¯å·²æ”¶åˆ°æˆ–å·²å¤„ç†ã€‚Acknowledgement å³æ˜¯å›æ‰§ï¼Œç®€ç§° ackï¼Œæ¶ˆæ¯ä»£ç†çš„ ack å°±æ˜¯ publisher confirmsï¼Œæ¶ˆè´¹è€…çš„ ack å°±æ˜¯ consumer acknowledgementsã€‚ä½¿ç”¨å‘å¸ƒè€…ç¡®è®¤æˆ–æ¶ˆè´¹è€…å›æ‰§è‡³å°‘å¯ä»¥ä¿è¯ä¸€æ¬¡æ¶ˆæ¯ä¼ é€’ä¸ä¸¢å¤±æ¶ˆæ¯ï¼Œå»ºè®®å…³é—­è‡ªåŠ¨ ack æˆ–å¼€å¯æ‰‹åŠ¨æ¨¡å¼ã€‚\nPublisher confirms 1 2 3 4 5 6 7 8 Channel channel = connection.createChannel(); channel.confirmSelect(); channel.addConfirmListener((deliveryTag, multiple) -\u0026gt; { // code when message is confirmed }, (deliveryTag, multiple) -\u0026gt; { // code when message is nack-ed }); å¯¹äº Java å®¢æˆ·ç«¯è€Œè¨€ï¼Œå¯ä»¥å¼‚æ­¥å¤„ç† publisher confirmsï¼Œä¸€æ˜¯æ¶ˆæ¯ä»£ç†å·²æ”¶åˆ°æ¶ˆæ¯æˆ–å·²å¤„ç†æ¶ˆæ¯çš„å®¢æˆ·ç«¯å›è°ƒæ–¹æ³•ï¼›äºŒæ˜¯æ¶ˆæ¯ä»£ç†æœªæ”¶åˆ°æ¶ˆæ¯æˆ–å·²ä¸¢å¤±æ¶ˆæ¯çš„å®¢æˆ·ç«¯å›è°ƒæ–¹æ³•ï¼Œä¸¢å¤±çš„æ¶ˆæ¯ä»å¯èƒ½ä¼ é€’åˆ°æ¶ˆè´¹è€…ï¼Œä½†æ˜¯æ¶ˆæ¯ä»£ç†æ²¡æ³•ä¿è¯è¿™ä¸€ç‚¹ã€‚long deliveryTag æ˜¯åœ¨ä¸€ä¸ª Channel ä¸­ä¸€æ¬¡æ¶ˆæ¯ä¼ é€’çš„æ ‡ç¤ºç¬¦ï¼Œå®ƒæ˜¯å•è°ƒé€’å¢çš„æ­£æ•´æ•°ï¼›boolean multiple ä¸º true åˆ™è¡¨ç¤ºå½“å‰å’Œ deliveryTag ä¹‹å‰çš„æ¶ˆæ¯å·²æ”¶åˆ°æˆ–å·²å¤„ç†ã€‚å¯¹äºæ— æ³•è·¯ç”±çš„æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä»£ç†è™½ç„¶ä¹Ÿä¼šå›å¤ï¼ˆè¿”å›ç©ºé˜Ÿåˆ—åˆ—è¡¨ï¼‰ï¼Œä½†æ˜¯é»˜è®¤æƒ…å†µä¸‹æ— æ³•è·¯ç”±çš„æ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒï¼Œé™¤éå‘å¸ƒæ¶ˆæ¯æ—¶å°† boolean mandatory è®¾ä¸º true æˆ–ä½¿ç”¨ alternate exchange æ¥å¤‡ä»½ã€‚\n1 2 3 4 channel.addReturnListener(returnMessage -\u0026gt; { // to be notified of failed deliveries // when basicPublish is called with \u0026#34;mandatory\u0026#34; or \u0026#34;immediate\u0026#34; flags set }); Consumer acknowledgements 1 2 3 4 5 6 7 8 // this example assumes an existing channel instance // ç¡®è®¤ï¼Œack \u0026gt; 0 channel.basicAck(deliveryTag, multiple); // å¦è®¤ï¼Œack \u0026lt; 0 channel.basicNack(deliveryTag, multiple, requeue); // æ‹’ç»ï¼Œack \u0026lt; 0 channel.basicReject(deliveryTag, requeue) æ¶ˆè´¹è€…çš„å›æ‰§å¯ä»¥æ˜¯ç¡®è®¤ã€å¦è®¤ã€æ‹’ç»ã€‚ä¸ç®¡æ˜¯å¦è®¤è¿˜æ˜¯æ‹’ç»ï¼Œå¦‚æœ boolean requeue ä¸º false åˆ™ç›¸åº”çš„æ¶ˆæ¯å°†è¢«æ¶ˆæ¯ä»£ç†ä¸¢å¼ƒï¼Œè®¾ä¸º true åˆ™ç›¸åº”çš„æ¶ˆæ¯å°†é‡æ–°åŠ å…¥æ¶ˆæ¯ä»£ç†çš„é˜Ÿåˆ—ï¼Œä»è€Œå…è®¸å…¶å®ƒæ¶ˆè´¹è€…æ¶ˆè´¹ï¼›boolean multiple ä¸º true è¡¨ç¤ºå¦è®¤æˆ–æ‹’ç»å½“å‰å’Œ deliveryTag ä¹‹å‰çš„æ¶ˆæ¯ã€‚ç¡®è®¤åˆ™è¡¨ç¤ºç›¸åº”çš„æ¶ˆæ¯å·²æ”¶åˆ°æˆ–å·²å¤„ç†ï¼Œæ¶ˆæ¯ä»£ç†å°†è®°å½•å·²æ¨é€çš„æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥å°†å…¶ä¸¢å¼ƒã€‚å¦‚æœæ¶ˆè´¹è€…æŠ•é€’ç»™æ¶ˆæ¯ä»£ç†çš„ ack ä¸¢å¤±äº†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæ¶ˆæ¯ä»£ç†å°†é‡å‘ã€‚\nAMQP äº‹åŠ¡ RabbitMQ äº‹åŠ¡å°†å¯èƒ½å¤§å¹…é™ä½ååé‡ï¼Œæ•…ä¸€èˆ¬ä¸æ¨èä½¿ç”¨ã€‚\nUsing standard AMQP 0-9-1, the only way to guarantee that a message isn\u0026rsquo;t lost is by using transactions \u0026ndash; make the channel transactional then for each message or set of messages publish, commit. In this case, transactions are unnecessarily heavyweight and decrease throughput by a factor of 250. To remedy this, a confirmation mechanism was introduced. It mimics the consumer acknowledgements mechanism already present in the protocol.\né›†ç¾¤ æ—§æ–‡æåˆ°è¿‡è½¯ä»¶ç³»ç»Ÿä¸‰å¤§ç›®æ ‡ï¼Œé¦–å…ˆï¼ŒRabbitMQ é›†ç¾¤å¦‚ä½•ä¿è¯å¯é æ€§ï¼ŸRabbitMQ é›†ç¾¤æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªç»“ç‚¹çš„é€»è¾‘åˆ†ç»„ï¼Œæ¯ä¸ªç»“ç‚¹å…±äº« exchangesã€bindingsã€queuesã€virtual hostsã€usersï¼ˆRabbitMQ æœ‰ RBAC ç‰¹æ€§ï¼‰ã€runtime parameters ç­‰è¿è¡Œæ—¶çŠ¶æ€ï¼Œä¸”ç»“ç‚¹å¯¹ç­‰ï¼ˆP2Pï¼‰ã€‚å¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªç»“ç‚¹éƒ½å¯ä»¥ç»‘å®šã€å‘å¸ƒã€åˆ é™¤è¿æ¥åˆ°é¦–ä¸ªç»“ç‚¹æ—¶åˆ›å»ºçš„ exchangeã€‚\nRabbitMQ é›†ç¾¤æä¾›äº†åˆ›å»ºé«˜å¯ç”¨é˜Ÿåˆ—ï¼ˆHA queuesï¼‰çš„æ–¹æ³•æ¥æ”¯æŒå®¹é”™ï¼ˆfault toleranceï¼‰ã€‚é«˜å¯ç”¨é˜Ÿåˆ—æ¨ªè·¨å¤šä¸ªé›†ç¾¤ç»“ç‚¹å¹¶å…±äº«åŒæ­¥çš„é˜Ÿåˆ—çŠ¶æ€ï¼ŒåŒ…æ‹¬æ¶ˆæ¯æ•°æ®ã€‚ä»»ä½•å…·æœ‰é«˜å¯ç”¨é˜Ÿåˆ—çš„ç»“ç‚¹å‘ç”Ÿæ•…éšœï¼Œç¾¤é›†ä¸­çš„å…¶å®ƒç»“ç‚¹ä»å°†åŒ…å«æ¶ˆæ¯å’Œé˜Ÿåˆ—çŠ¶æ€ï¼›å½“æ•…éšœç»“ç‚¹æ¢å¤å¹¶é‡æ–°åŠ å…¥é›†ç¾¤æ—¶ï¼Œå®ƒå°†åŒæ­¥å®ƒä¸‹çº¿æ—¶é”™è¿‡çš„æ¶ˆæ¯ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ AMQP 0-9-1 Model Explained\nMessageing using AMQP\nRabbitMQ # Consumer Acknowledgements and Publisher Confirms\nRabbitMQ # Tutorials # Publisher Confirms\nrabbitmq é‡å¤ç¡®è®¤å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±\nRabbitMQ # Reliability Guide\nRabbitMQ # Clustering Guide\nRabbitMQ # Cluster Formation and Peer Discovery\nharbur/docker-rabbitmq-cluster\nRabbitMQ in Depth # Chapter 7. Scaling RabbitMQ with clusters\n","date":"2020-05-04T11:54:46+08:00","permalink":"https://h2cone.github.io/2020/05/04/rabbitmq-reliability/","title":"RabbitMQ çš„å¯é æ€§"},{"content":"çº¸ä¸Šè°ˆå…µ æœ‰ä¸¤ä¸ª 1GB çš„æ–‡æœ¬æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯æ— åºæ•°ç»„ï¼ˆä¸€è¡Œä¸€ä¸ªæ•´æ•°ï¼Œä¸€ä¸ªæ–‡ä»¶ä¸­å¤§æ¦‚æœ‰ä¸€äº¿ä¸ªéè´Ÿæ•´æ•°ï¼ŒåŒä¸€ä¸ªæ–‡ä»¶ä¸­ä¸é‡å¤ï¼‰ï¼Œè¯·åœ¨å†…å­˜ä½¿ç”¨å°½å¯èƒ½å°‘çš„æƒ…å†µä¸‹å°†åªåœ¨å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶å‡ºç°è¿‡çš„æ•°å­—æ‰¾å‡ºæ¥ã€‚\nåº”ç”¨ BitArrayã€‚é€è¡Œè¯»å– 2 ä¸ªæ–‡ä»¶çš„æ•´æ•°å¹¶åˆ†åˆ«æ˜ å°„åˆ° 2 ä¸ª BitArrayï¼Œå…¶ä¸­æ¯ä¸ª BitArray çš„é•¿åº¦ä¸º 1 äº¿ï¼Œå³ 100000000 bit = 11.92093 MBï¼Œæ±‚è¿™ä¸¤ä¸ª BitArray çš„å¯¹ç§°å·®ã€‚\næ˜ å°„ã€‚å°†æ–‡ä»¶ä¸­çš„éè´Ÿæ•´æ•°æ˜ å°„ä¸ºä¸‹æ ‡ï¼ˆç´¢å¼•ï¼‰ï¼Œæ¯”å¦‚ç»™å®š {1, 5} å’Œ {1, 2} è¿™ä¸¤ä¸ªæ•´æ•°é›†ï¼Œåˆ™ç›¸åº”çš„ BitArray åˆ†åˆ«å½¢å¦‚ï¼š\n00\u0026hellip;100010\n00\u0026hellip;000110\nBit array æ¯ä½åˆå§‹å€¼ä½ 0ï¼Œè®¾ç½®ä¸º 1 åˆ™è¡¨ç¤ºè¯¥ä½çš„ä¸‹æ ‡ï¼ˆindexï¼‰ä¸ºç›¸åº”çš„æ•´æ•°ï¼Œå³è¾¹ç¬¬ä¸€ä½ä¸‹æ ‡ä¸º 0ï¼Œä»å³åˆ°å·¦å•è°ƒé€’å¢ï¼Œå¢é‡ä¸º 1ã€‚\nå¯¹ç§°å·®ã€‚ä¸¤ä¸ªé›†åˆçš„å¯¹ç§°å·®æ˜¯å±äºä¸€ä¸ªé›†åˆè€Œä¸å±äºå¦ä¸€ä¸ªé›†åˆçš„å…ƒç´ ç»„æˆçš„é›†åˆã€‚æ¯”å¦‚ {1, 5} ä¸ {1, 2} çš„å¯¹ç§°å·®ä¸º {2, 5}ï¼Œç›¸åº”çš„ BitArray è¿ç®—å½¢å¦‚ï¼š\n00\u0026hellip;100010 ^ 00\u0026hellip;000110 -\u0026gt; 00\u0026hellip;100100\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\n","date":"2020-04-23T17:40:57+08:00","permalink":"https://h2cone.github.io/2020/04/23/bit-array-0/","title":"åˆè¯† BitArray"},{"content":"Nginx Nginx æ˜¯é«˜æ€§èƒ½çš„è´Ÿè½½å‡è¡¡å™¨ã€Web æœåŠ¡å™¨ã€åå‘ä»£ç†æœåŠ¡å™¨ã€‚å®ƒæ˜¯æˆ‘ä»¬æ—¢ç†Ÿæ‚‰åˆé™Œç”Ÿçš„è€æœ‹å‹ï¼Œç»å¸¸ä¾é å®ƒæ°´å¹³æ‰©å±•åº”ç”¨ç¨‹åºã€éƒ¨ç½²å‰ç«¯åº”ç”¨ç¨‹åºã€ä»£ç†åº”ç”¨ç¨‹åºã€æ„å»º API ç½‘å…³ç­‰ï¼ŒNginx ç”±çº¯ C è¯­è¨€å®ç°ï¼Œä½†å´éå¸¸æ˜“äºä½¿ç”¨ã€‚\næ—©åœ¨ 2005 å¹´ï¼Œå®˜æ–¹åšå®¢ç”¨ä¸€ç¯‡æ ‡é¢˜ä¸º Inside NGINX: How We Designed for Performance \u0026amp; Scale çš„æ–‡ç« æè¿°äº† Nginx çš„æ¶æ„ï¼š\nNginx å¦‚ä½•åˆ›å»ºè¿›ç¨‹ä»¥æœ‰æ•ˆåˆ©ç”¨èµ„æºã€‚\nä½¿ç”¨çŠ¶æ€æœºæ¥ç®¡ç†æµé‡ï¼ˆtrafficï¼‰ã€‚\néé˜»å¡å’Œäº‹ä»¶é©±åŠ¨çš„æ¶æ„ä½¿ Nginx å¯ä»¥åŒæ—¶è°ƒåº¦å¤šä¸ªçŠ¶æ€æœºã€‚\nè¿›ç¨‹æ¶æ„å¦‚ä½•æ”¯æŒä¸é—´æ–­çš„ä¼˜é›…æ›´æ–°å’ŒäºŒè¿›åˆ¶å‡çº§ã€‚\nOpenResty ä¸å¦¨å…ˆçœ‹çœ‹ OpenResty å®˜æ–¹çš„å®£ä¼ è¯­ã€‚\nOpenRestyÂ® æ˜¯ä¸€ä¸ªåŸºäº Nginx ä¸ Lua çš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œå…¶å†…éƒ¨é›†æˆäº†å¤§é‡ç²¾è‰¯çš„ Lua åº“ã€ç¬¬ä¸‰æ–¹æ¨¡å—ä»¥åŠå¤§å¤šæ•°çš„ä¾èµ–é¡¹ã€‚ç”¨äºæ–¹ä¾¿åœ°æ­å»ºèƒ½å¤Ÿå¤„ç†è¶…é«˜å¹¶å‘ã€æ‰©å±•æ€§æé«˜çš„åŠ¨æ€ Web åº”ç”¨ã€Web æœåŠ¡å’ŒåŠ¨æ€ç½‘å…³ã€‚\næ¯”èµ·ä½¿ç”¨ C è¯­è¨€ï¼Œä½¿ç”¨ Lua é—¨æ§›è¦ç¨ä½ä¸€äº›ï¼Œè€Œä¸”æœ‰ LuaJIT çš„æ€§èƒ½ä¼˜åŒ–ã€‚\nOpenRestyÂ® é€šè¿‡æ±‡èšå„ç§è®¾è®¡ç²¾è‰¯çš„ Nginx æ¨¡å—ï¼ˆä¸»è¦ç”± OpenResty å›¢é˜Ÿè‡ªä¸»å¼€å‘ï¼‰ï¼Œä»è€Œå°† Nginx æœ‰æ•ˆåœ°å˜æˆä¸€ä¸ªå¼ºå¤§çš„é€šç”¨ Web åº”ç”¨å¹³å°ã€‚è¿™æ ·ï¼ŒWeb å¼€å‘äººå‘˜å’Œç³»ç»Ÿå·¥ç¨‹å¸ˆå¯ä»¥ä½¿ç”¨ Lua è„šæœ¬è¯­è¨€è°ƒåŠ¨ Nginx æ”¯æŒçš„å„ç§ C ä»¥åŠ Lua æ¨¡å—ï¼Œå¿«é€Ÿæ„é€ å‡ºè¶³ä»¥èƒœä»» 10K ä¹ƒè‡³ 1000K ä»¥ä¸Šå•æœºå¹¶å‘è¿æ¥çš„é«˜æ€§èƒ½ Web åº”ç”¨ç³»ç»Ÿã€‚\nå¯¹äºåŸºäº I/O å¤šè·¯å¤ç”¨ï¼ˆè¯·è§ç½‘ç»œÂ·NIO # I/O æ¨¡å‹ï¼‰çš„ Nginx æ¥è¯´ï¼Œå•æœº C1000K ä¸åœ¨è¯ä¸‹ï¼Œåè€Œæ˜¯å—é™äºæ“ä½œç³»ç»Ÿæˆ–é…ç½®ã€‚\nOpenRestyÂ® çš„ç›®æ ‡æ˜¯è®©ä½ çš„ Web æœåŠ¡ç›´æ¥è·‘åœ¨ Nginx æœåŠ¡å†…éƒ¨ï¼Œå……åˆ†åˆ©ç”¨ Nginx çš„éé˜»å¡ I/O æ¨¡å‹ï¼Œä¸ä»…ä»…å¯¹ HTTP å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç”šè‡³äºå¯¹è¿œç¨‹åç«¯è¯¸å¦‚ MySQLã€PostgreSQLã€Memcached ä»¥åŠ Redis ç­‰éƒ½è¿›è¡Œä¸€è‡´çš„é«˜æ€§èƒ½å“åº”ã€‚\næ—¢ç„¶æ”¯æŒè®¿é—®å¤šç§æ•°æ®åº“ï¼Œåˆ™è¶³çŸ£å¤„ç†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚\næ¥ä¸‹æ¥ï¼Œä»¥ä¸€ä¸ªåä¸º openresty-exp/redis-example çš„ä¾‹å­æ¥åˆæ­¥ä½“éªŒ OpenRestyã€‚\n1 2 3 4 5 6 . â”œâ”€â”€ RedisExample.lua â”œâ”€â”€ conf â”‚ â””â”€â”€ nginx.conf â”œâ”€â”€ logs â”‚ â””â”€â”€ error.log é¦–å…ˆæ–°å»ºé…ç½®æ–‡ä»¶ç›®å½•ï¼ˆconfï¼‰å’Œæ—¥å¿—æ–‡ä»¶ç›®å½•ï¼ˆlogsï¼‰ï¼Œç„¶åç¼–å†™ Nginx é…ç½®æ–‡ä»¶ï¼ˆnginx.confï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 worker_processes 1; error_log logs/error.log; events { worker_connections 1024; } http { server { listen 80; location ~ /redis/(.+)/(.+) { charset utf-8; lua_code_cache on; content_by_lua_file RedisExample.lua; } } } Nginx http server ç›‘å¬ 80 ç«¯å£ï¼Œä¸ºäº†æ–¹ä¾¿å±•ç¤ºï¼ŒåŒ¹é…çš„è¯·æ±‚ URL åŒ…å«ä¸¤ä¸ªè·¯å¾„å‚æ•°ã€‚Nginx å¤„ç† HTTP è¯·æ±‚åˆ†æˆäº†è‹¥å¹²é˜¶æ®µï¼Œè¯¦æƒ…è¯·è§ Nginx # http phasesï¼Œæˆ–åˆ™ç›´æ¥å‚è€ƒ OpenResty # æ‰§è¡Œé˜¶æ®µæ¦‚å¿µï¼Œè¿™é‡Œåªå…³å¿ƒæ­£å¸¸ç”Ÿæˆå“åº”çš„é˜¶æ®µï¼ˆcontentï¼‰å¹¶ä½¿ç”¨ Lua è„šæœ¬å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚\nå‡è®¾ HTTP å®¢æˆ·ç«¯å‘é€åŒ…å«é”®å€¼å¯¹çš„è¯·æ±‚åˆ° Nginx serverï¼ŒNginx server å…ˆå°†é”®å€¼å¯¹æ’å…¥ Redis å®ä¾‹ï¼Œç„¶åå†ä» Redis å®ä¾‹æŸ¥è¯¢ç›¸åº”çš„é”®æ‰€å¯¹åº”çš„å€¼ï¼Œæœ€åå‘é€åŒ…å«é”®å€¼å¯¹çš„å“åº”åˆ° HTTP å®¢æˆ·ç«¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 local json = require \u0026#34;cjson\u0026#34; local redis = require \u0026#34;resty.redis\u0026#34; local red = redis.new() red:set_timeouts(1000, 1000, 1000) local ok, err = red:connect(\u0026#34;127.0.0.1\u0026#34;, 6379) if not ok then ngx.say(\u0026#34;failed to connect: \u0026#34;, err) return end local key = ngx.var[1] local val = ngx.var[2] local ok, err = red:set(key, val) if not ok then ngx.say(\u0026#34;failed to set: \u0026#34;, err) return end local val, err = red:get(key) if not val then ngx.say(\u0026#34;failed to get: \u0026#34;, err) return end if val == ngx.null then ngx.say(\u0026#34;key no found\u0026#34;) return end local ok, err = red:close() if not ok then ngx.say(\u0026#34;failed to close: \u0026#34;, err) return end ngx.say(json.encode({[key]=val})) å¯åŠ¨ Nginx å¹¶æŒ‡å®šé…ç½®æ–‡ä»¶ã€‚\n1 openresty -p `pwd`/ -c conf/nginx.conf ä½¿ç”¨ HTTP å®¢æˆ·å‘é€è¯·æ±‚ã€‚\n1 2 % curl 127.0.0.1/redis/hello/world {\u0026#34;hello\u0026#34;:\u0026#34;world\u0026#34;} Nginx server å“åº”æ­£å¸¸ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nMemo Inside NGINX\nThe Architecture of Open Source Applications (Volume 2): nginx\nNginx # development guide\nHTTP request processing phases in Nginx\nNginx # modules # lua\nOpenResty # Components\nlua-nginx-module\nlua-resty-redis\nOpenResty æœ€ä½³å®è·µ\nOpenResty ä¸å®Œå…¨æŒ‡å—\nLua Style Guide\n","date":"2020-03-31T14:44:18+08:00","permalink":"https://h2cone.github.io/2020/03/31/openresty-exp/","title":"ä½¿ç”¨ Lua æ‹“å±• Nginx"},{"content":"é“ºå« å­˜å‚¨å±‚æ¬¡ç»“æ„ è‡ªä¸‹è€Œä¸Šï¼Œæ›´å°æ›´å¿«ã€‚\nè‡ªé¡¶å‘ä¸‹ï¼Œæ›´å¤§æ›´æ…¢ã€‚\nä¸Šå±‚æ˜¯ä¸‹å±‚çš„ï¼ˆé«˜é€Ÿï¼‰ç¼“å­˜ã€‚\nè½¯ä»¶ç³»ç»Ÿä¸‰å¤§ç›®æ ‡ ç›®æ ‡ è§£é‡Š æœŸæœ› æˆ˜æœ¯ å¯é æ€§ å®¹é”™èƒ½åŠ› ç¡¬ä»¶æ•…éšœã€è½¯ä»¶é”™è¯¯ã€äººä¸ºå¤±è¯¯å‘ç”Ÿæ—¶ç»§ç»­æ­£å¸¸è¿ä½œ ç†”æ–­ã€é™çº§ã€è‡ªåŠ¨æ¢å¤ã€å®¹ç¾ã€é«˜å¯ç”¨ã€å¼ºä¸€è‡´æ€§\u0026hellip;\u0026hellip; å¯æ‰©å±•æ€§ åº”å¯¹è´Ÿè½½å¢åŠ çš„èƒ½åŠ› è´Ÿè½½å¢åŠ æ—¶ä¿æŒè‰¯å¥½æ€§èƒ½æˆ–é«˜æ€§èƒ½ ä½å»¶è¿Ÿã€é«˜ååã€å¼¹æ€§ä¼¸ç¼©\u0026hellip;\u0026hellip; å¯ç»´æŠ¤æ€§ è¿ç»´å’Œå¼€å‘çš„éš¾æ˜“ç¨‹åº¦ æ—¢ç®€å•åˆå¥½æ‹“å±• DRYã€SoCã€DevOps\u0026hellip;\u0026hellip; Redis cluster å•ä¸€ç‹¬ç«‹çš„ Redis ç»“ç‚¹ï¼Œè™½ç„¶å®ƒçœŸçš„å¾ˆå¿«ï¼ˆæœªæ¥å°†å¼€æ–°ç¯‡ç« è§£é‡Šï¼‰ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸Šé™ï¼Œæ€§èƒ½æå‡æ€»å°†é‡åˆ°å¤©èŠ±æ¿ï¼Œè€Œä¸”å•ç‚¹æ•…éšœå°†å¯¼è‡´ä¸€æ®µæ—¶é—´æœåŠ¡ä¸å¯ç”¨ã€‚\nRedis é›†ç¾¤å¦‚ä½•è§£å†³å¯é æ€§é—®é¢˜å’Œæ‰©å±•æ€§é—®é¢˜ï¼Ÿ\næ•°æ®åœ¨å¤šä¸ª Redis ç»“ç‚¹ä¹‹é—´è‡ªåŠ¨åˆ†ç‰‡ï¼ˆshardï¼‰ã€‚\nRedis é›†ç¾¤å¯ä»¥åœ¨åˆ†åŒºæœŸé—´æä¾›ä¸€å®šç¨‹åº¦çš„å¯ç”¨æ€§ï¼ˆavailabilityï¼‰ã€‚\næ°´å¹³æ‰©å±• Redisï¼ˆscalabilityï¼‰ã€‚\næ•°æ®åˆ†ç‰‡ Redis é›†ç¾¤ä¸ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œï¼Œè€Œæ˜¯ä½¿ç”¨å“ˆå¸Œæ§½ï¼ˆhash slotï¼‰ã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒRedis é›†ç¾¤ä¸­çš„ç»“ç‚¹ï¼ˆnodeï¼‰è´Ÿè´£å„è‡ªçš„å“ˆå¸Œæ§½ã€‚å‘é›†ç¾¤æ’å…¥ä¸€ä¸ªé”®ï¼ˆkeyï¼‰æ—¶ï¼Œåªæ˜¯è®¡ç®—ç»™å®šé”®çš„ CRC16 å¹¶å– 16384 çš„æ¨¡æ¥å°†ç»™å®šé”®æ˜ å°„åˆ°å“ˆå¸Œæ§½ã€‚\nä½¿ç”¨å“ˆå¸Œæ§½å¯ä»¥â€œè½»æ¾â€åœ¨é›†ç¾¤ä¸­æ·»åŠ ç»“ç‚¹åˆ°åˆ é™¤ç»“ç‚¹ã€‚è‹¥å¢åŠ ä¸€ä¸ªç»“ç‚¹ Dï¼Œåˆ™ä» Aã€Bã€C ç§»åŠ¨ä¸€äº›å“ˆå¸Œæ§½åˆ° Dï¼ŒåŒç†ï¼Œè‹¥åˆ é™¤ä¸€ä¸ªç»“ç‚¹ Aï¼Œåˆ™ä» A ç§»åŠ¨å“ˆå¸Œæ§½åˆ°ç»“ç‚¹ Bã€Cã€Dï¼Œå½“ A ä¸ºç©ºå¯è¢«å®Œå…¨ä»é›†ç¾¤ç§»é™¤ï¼›è€Œä¸”ï¼Œæ·»åŠ ç»“ç‚¹ã€åˆ é™¤ç»“ç‚¹ã€æ›´æ”¹ç»“ç‚¹çš„å“ˆå¸Œæ§½çš„ç™¾åˆ†æ¯”éƒ½ä¸è¦æ±‚é›†ç¾¤æš‚åœè¿ä½œï¼Œä¸éœ€è¦ä»»ä½•åœæœºæ—¶é—´ã€‚\nå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒRedis é›†ç¾¤æ”¯æŒå¤šä¸ªé”®çš„æ“ä½œï¼Œå‰ææ˜¯å•ä¸ªå‘½ä»¤æ‰§è¡Œæˆ–æ•´ä¸ªäº‹åŠ¡æˆ– Lua è„šæœ¬æ‰§è¡Œä¸­æ¶‰åŠçš„æ‰€æœ‰é”®å±äºåŒä¸€ä¸ªå“ˆå¸Œæ§½ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç§°ä¸º hash tags çš„æ¦‚å¿µæ¥å¼ºåˆ¶å¤šä¸ª key æ˜ å°„åˆ°åŒä¸€ä¸ªå“ˆå¸Œæ§½ã€‚\nå¯ç”¨æ€§ä¸ä¸€è‡´æ€§ Redis é›†ç¾¤ä½¿ç”¨ä¸»ä»æ¨¡å‹ï¼ˆmaster-slave modelï¼‰ å®ç°æ•…éšœè½¬ç§»ã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨é›†ç¾¤åˆ›å»ºæ—¶æˆ–ç¨åï¼Œæˆ‘ä»¬ç»™æ¯ä¸ªä¸»ç»“ç‚¹æ·»åŠ ä»ç»“ç‚¹ï¼Œä¾‹å¦‚ B æ˜¯ä¸»ç»“ç‚¹ï¼ŒB1 æ˜¯å®ƒçš„ä»ç»“ç‚¹ï¼ŒB1 çš„å“ˆå¸Œæ§½æ˜¯ B çš„å“ˆå¸Œæ§½çš„å‰¯æœ¬ã€‚å½“ B å‘ç”Ÿæ•…éšœï¼Œé›†ç¾¤å°†æå‡ B1 ä¸ºæ–°ä¸»ç»“ç‚¹ï¼Œç»§ç»­æä¾›æœåŠ¡ï¼›ä»¥æ­¤ç±»æ¨ï¼Œå½“æœ‰è‹¥å¹²ä¸»ç»“ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œå®ƒä»¬çš„ä»ç»“ç‚¹å°†æ›¿ä»£å®ƒä»¬æˆä¸ºæ–°ä¸»ç»“ç‚¹ï¼Œä»¥æ­¤æä¾›ä¸€å®šç¨‹åº¦çš„å¯ç”¨æ€§ã€‚\nä¸ºä»€è¯´æ˜¯ä¸€å®šç¨‹åº¦çš„å¯ç”¨æ€§ï¼Œè€ƒè™‘ä»¥ä¸‹çš„åœºæ™¯ï¼Œé›†ç¾¤æå¯èƒ½ä¸èƒ½æ­£å¸¸è¿ä½œã€‚\nä¸€å¯¹ä¸»ä»ç»“ç‚¹åŒæ—¶æ•…éšœã€‚\nè¶…è¿‡åŠæ•°çš„ç»“ç‚¹å‘ç”Ÿäº†æ•…éšœã€‚\nRedis é›†ç¾¤æ— æ³•ä¿è¯å¼ºä¸€è‡´æ€§ï¼ˆstrong consistencyï¼‰ã€‚Kafka çš„ä½œè€… Jay Kreps æ›¾ç»è¯´è¿‡ï¼š\nIs it better to be alive and wrong or right and dead?\nåœ¨å¯ç”¨æ€§ä¸ä¸€è‡´æ€§å¤©å¹³ä¹‹é—´ï¼ŒRedis é›†ç¾¤ä¾§é‡äºå¯ç”¨æ€§ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥é›†ç¾¤å¹¶å†™å…¥é”®ï¼Œä¸¢å¤±å†™ï¼ˆlose writesï¼‰å¯èƒ½å‘ç”Ÿï¼Œå› ä¸º Redis ä½¿ç”¨å¼‚æ­¥å¤åˆ¶ï¼ˆasynchronous replicationï¼‰ã€‚\nå®¢æˆ·ç«¯å°†ç»™å®šé”®å†™å…¥ä¸»ç»“ç‚¹ B\nä¸»ç»“ç‚¹ B å‘é€ OK ç»™å®¢æˆ·ç«¯\nä» B å¤åˆ¶æ•°æ®åˆ°ä»ç»“ç‚¹ B1ã€B2ã€B3\u0026hellip;\u0026hellip;\næ³¨æ„ï¼Œä¸Šé¢æ“ä½œ 2 å’Œæ“ä½œ 3 éé˜»å¡ï¼Œå³å®¢æˆ·ç«¯å†™çš„åŒæ—¶ï¼Œä¸»ç»“ç‚¹ B æ‰§è¡Œæ•°æ®å¤åˆ¶ä»»åŠ¡ï¼ˆé€šå¸¸åªéœ€å¤åˆ¶å‘½ä»¤ï¼‰ï¼Œè€Œä¸æ˜¯é˜»å¡ç›´åˆ°æ‰€æœ‰æ•°æ®å¤åˆ¶å®Œæˆå†å›å¤å®¢æˆ·ç«¯ï¼Œæ•°æ®å¤åˆ¶å¿…å®šå­˜åœ¨æ»åï¼›å½“ B å‘ç”Ÿæ•…éšœåœæ­¢å¤åˆ¶ä¸” B çš„ä»ç»“ç‚¹æå‡ä¸ºæ–°ä¸»ç»“ç‚¹ï¼Œæ–°ä¸»ç»“ç‚¹å°†å¯èƒ½ä¸å­˜åœ¨å®¢æˆ·ç«¯å·²å†™å…¥çš„é”®ã€‚\nè¿™ä¹Ÿæ˜¯ä¸€ç§åœ¨æ€§èƒ½ä¸ä¸€è‡´æ€§ä¹‹é—´çš„æƒè¡¡ï¼ˆtrade-offï¼‰ã€‚\nå³ä½¿ Redis æ”¯æŒåŒæ­¥å¤åˆ¶ï¼Œä¹Ÿæœ‰å…¶å®ƒæ›´å¤æ‚çš„æƒ…æ™¯å¯¼è‡´ä¸»ç»“ç‚¹ä¸ä»ç»“ç‚¹æ•°æ®ä¸ä¸€è‡´ã€‚ä¸€ç§æƒ…æ™¯æ˜¯ä»ç»“ç‚¹æå‡ä¸ºä¸»ç»“ç‚¹æ—¶ï¼Œå®¢æˆ·ç«¯å°†å¯èƒ½æ‰¾ä¸åˆ°ç›®æ ‡é”®æˆ–è¯»å–äº†è„æ•°æ®ï¼›å½“å®¢æˆ·ç«¯å‘é€ä¸€æ¬¡è¶³å¤Ÿå¤§çš„é”®æˆ–è¶³å¤Ÿå¤šçš„é”®åˆ°ä¸€ä¸ªä¸»ç»“ç‚¹ï¼Œä»¥è‡³äºè¯¥ä¸»ç»“ç‚¹çš„ä»ç»“ç‚¹æœ‰å……åˆ†æ—¶é—´æå‡ä¸ºæ–°ä¸»ç»“ç‚¹ï¼Œæ—§ä¸»ç»“ç‚¹å°†æ‹’ç»æ¥å—é”®ï¼Œä¸”æ–°ä¸»ç»“ç‚¹ä¸å­˜åœ¨å®¢æˆ·ç«¯å†™å…¥çš„é”®ã€‚\næœªæ¥å°†å¼€æ–°ç¯‡ç« è°ˆè°ˆåˆ†å¸ƒç³»ç»Ÿçš„ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ã€‚\næœ€å°çš„é›†ç¾¤ ä» antirez/redis å…‹éš†ã€‚\n1 git clone -v https://github.com/antirez/redis.git ç¼–è¯‘ä¸€ä¸‹ã€‚\n1 2 cd redis make ç¼–è¯‘æˆåŠŸåï¼Œå¯ä»¥ä½¿ç”¨åä¸º redis-server çš„å¯æ‰§è¡Œæ–‡ä»¶å¯åŠ¨å• Redis å®ä¾‹ã€‚\n1 2 cd src ./redis-server æ£€æŸ¥ utils/create-cluster ç›®å½•ï¼Œå¯ä»¥å‘ç°ä¸€ä¸ªåä¸º create-cluster çš„ Shell è„šæœ¬ï¼Œè¯¥è„šæœ¬åŸºäº Redis é›†ç¾¤åˆ›å»ºå’Œç®¡ç†å‘½ä»¤è¡Œå·¥å…·ï¼š\n1 redis-cli --cluster åˆ›å»º Redis é›†ç¾¤éœ€è¦å…ˆå¯åŠ¨è‹¥å¹² Redis å®ä¾‹ã€‚\n1 2 create-cluster start create-cluster create æˆªå–ä»¥ä¸Šè„šæœ¬è¾“å‡ºçš„ä¸€éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 M: 02f543ee55bb36c72816617d24aaf3c1438abdd1 127.0.0.1:30001 slots:[0-5460] (5461 slots) master 1 additional replica(s) S: c7dcf3932a10ea80cd67e1f350c328b272da1cf4 127.0.0.1:30006 slots: (0 slots) slave replicates 6b27d42f51f5991f2458be0bf48bc28691e71dd4 M: 6b27d42f51f5991f2458be0bf48bc28691e71dd4 127.0.0.1:30003 slots:[10923-16383] (5461 slots) master 1 additional replica(s) M: cf89f789b2347d73e91f035d0c6b3b5eef0d8414 127.0.0.1:30002 slots:[5461-10922] (5462 slots) master 1 additional replica(s) S: 0b6d6ade090167e47bb74d385548c6b787d52f71 127.0.0.1:30005 slots: (0 slots) slave replicates cf89f789b2347d73e91f035d0c6b3b5eef0d8414 S: 0166962044b5fa13cf64d0c968963e5ee63f3241 127.0.0.1:30004 slots: (0 slots) slave replicates 02f543ee55bb36c72816617d24aaf3c1438abdd1 é»˜è®¤æƒ…å†µä¸‹ï¼Œæ€»å…± 6 ä¸ªç»“ç‚¹ï¼Œ3 ä¸ª ä¸»ç»“ç‚¹ï¼ˆMï¼‰ï¼Œ3 ä¸ª ä»ç»“ç‚¹ï¼ˆSï¼‰ï¼Œæ›´å¤šç”¨æ³•è¯·å‚è€ƒ utils/create-cluster/READMEã€‚\næˆ‘ä»¬ä½¿ç”¨ redis-cli è¯•éªŒä¸€ä¸‹è‡ªåŠ¨æ•°æ®åˆ†ç‰‡ã€‚\n1 2 3 4 % redis-cli -c -p 30001 127.0.0.1:30001\u0026gt; set foo bar -\u0026gt; Redirected to slot [12182] located at 127.0.0.1:30003 OK 1 2 3 4 % redis-cli -c -p 30003 127.0.0.1:30003\u0026gt; set hello world -\u0026gt; Redirected to slot [866] located at 127.0.0.1:30001 OK å½“æŸ¥æ‰¾é”®æ—¶ï¼Œå¯èƒ½è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œæç¤ºæˆ‘ä»¬è½¬è€Œè¿æ¥å…¶å®ƒç»“ç‚¹ã€‚\n1 2 3 % redis-cli -p 30002 127.0.0.1:30002\u0026gt; get foo (error) MOVED 12182 127.0.0.1:30003 1 2 3 redis-cli -p 30003 127.0.0.1:30003\u0026gt; get foo \u0026#34;bar\u0026#34; å½“ç„¶ï¼Œredis-cli æ”¯æŒé‡å®šå‘ã€‚\n1 2 3 4 5 6 7 % redis-cli -c -p 30002 127.0.0.1:30002\u0026gt; get foo -\u0026gt; Redirected to slot [12182] located at 127.0.0.1:30003 \u0026#34;bar\u0026#34; 127.0.0.1:30003\u0026gt; get hello -\u0026gt; Redirected to slot [866] located at 127.0.0.1:30001 \u0026#34;world\u0026#34; è®¿é—® Redis é›†ç¾¤çš„åº”ç”¨ç¨‹åºæ— æ³•ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ï¼Œåº”ç”¨ç¨‹åºçš„ Redis å®¢æˆ·ç«¯éœ€è¦ä»¥ Redis é›†ç¾¤çš„åè®®ä¸ Redis å®ä¾‹é€šä¿¡ã€‚åœ¨ Java ç”Ÿæ€ä¸­ï¼ŒJedis å·²æ”¯æŒ Redis é›†ç¾¤ã€‚\n1 2 3 4 5 6 Set\u0026lt;HostAndPort\u0026gt; jedisClusterNodes = new HashSet\u0026lt;HostAndPort\u0026gt;(); //Jedis Cluster will attempt to discover cluster nodes automatically jedisClusterNodes.add(new HostAndPort(\u0026#34;127.0.0.1\u0026#34;, 7379)); JedisCluster jc = new JedisCluster(jedisClusterNodes); jc.set(\u0026#34;foo\u0026#34;, \u0026#34;bar\u0026#34;); String value = jc.get(\u0026#34;foo\u0026#34;); å®¢æˆ·ç«¯è·¯ç”± ä¸€ä¸ªä¸¥è‚ƒçš„å®¢æˆ·ç«¯é™¤äº†å®ç°é‡å®šå‘æˆ–è·¯ç”±ï¼Œè¿˜åº”è¯¥ç¼“å­˜å“ˆå¸Œæ§½ä¸ç»“ç‚¹åœ°å€ä¹‹é—´çš„æ˜ å°„ï¼ˆè¿›ç¨‹å†…ç¼“å­˜æˆ–æœ¬åœ°ç¼“å­˜ï¼‰ï¼Œç›´æ¥è¿æ¥æ­£ç¡®çš„ç»“ç‚¹ï¼ˆå‡å°é‡å®šå‘é¢‘ç‡ï¼‰ã€‚å‘ç”Ÿæ•…éšœè½¬ç§»ä¹‹åæˆ–ç³»ç»Ÿç®¡ç†å‘˜å¢åŠ æˆ–åˆ é™¤ç»“ç‚¹ä¹‹åï¼Œå®¢æˆ·ç«¯éœ€è¦åˆ·æ–°æ˜ å°„ã€‚\nä»£ç†åˆ†å‘ å®¢æˆ·ç«¯ä¸ä¸€ç¾¤ Redis å®ä¾‹äº¤æµèƒ½å¦ç®€åŒ–æˆä¸å•ä¸€ Redis å®ä¾‹äº¤æµï¼Ÿç­”æ¡ˆæ˜¯å¢åŠ ä¸€ä¸ªä¸­é—´å±‚ã€‚\nä»£ç†ï¼ˆProxyï¼‰ï¼Œæ¯”å¦‚ Redis Cluster Proxy å’Œ CodisLabs/codisï¼Œä½†æ˜¯ï¼Œä»£ç†é€šå¸¸ä¹Ÿè¦æä¾›ä¸€å®šç¨‹åº¦çš„å¯ç”¨æ€§ã€‚\nå®¹å™¨åŒ– ä¸ºäº†ä½¿ Docker ä¸ Redis é›†ç¾¤å…¼å®¹ï¼Œéœ€è¦ä½¿ç”¨ Docker çš„ host networking modeï¼Œè¯¦æƒ…è¯·è§ docker # networkã€‚\nç»„åˆæ‹³ åœ¨é«˜è´Ÿè½½ä¸‹çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬é€šå¸¸è€ƒè™‘ä½¿ç”¨ Redis ä½œä¸º MySQL ç­‰å…³ç³»å‹æ•°æ®åº“çš„ï¼ˆé«˜é€Ÿï¼‰ç¼“å­˜ï¼Œè™½ç„¶åº”ç”¨ç¨‹åºéƒ½è¦ä¸å®ƒä»¬é€šä¿¡ï¼Œä½†æ˜¯ Redis è®¿é—®å†…å­˜è¦æ¯”æ•°æ®åº“è®¿é—®ç£ç›˜å¿«å¾—å¤šï¼Œè½¬è€Œè§£å†³å¼€å¤´æ‰€è¯´çš„ä¸‰å¤§é—®é¢˜ï¼›ä½†ä»ç„¶ä¸æ˜¯æœ€ä¼˜æ–¹æ¡ˆï¼Œå†å¦‚å¼€å¤´æ‰€è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ›´ä¸Šå±‚çš„ï¼ˆé«˜é€Ÿï¼‰ç¼“å­˜ï¼Œåº”ç”¨ç¨‹åºä¸ Redis é›†ç¾¤çš„ç½‘ç»œå¼€é”€å¯ä»¥é€šè¿‡è¿›ç¨‹å†…ç¼“å­˜æˆ–æœ¬åœ°ç¼“å­˜è¿›ä¸€æ­¥é™ä½ã€‚\nä¾‹å¦‚ï¼ŒJ2Cacheï¼Œå®ƒå°† Java è¿›ç¨‹ç¼“å­˜æ¡†æ¶ä½œä¸ºä¸€çº§ç¼“å­˜ï¼ˆæ¯”å¦‚ Ehcacheï¼‰ï¼Œå°† Redis ä½œä¸ºäºŒçº§ç¼“å­˜ã€‚æŸ¥æ‰¾é”®æ—¶ï¼Œå…ˆæŸ¥æ‰¾ä¸€çº§ç¼“å­˜ï¼Œè‹¥ä¸€çº§ç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥æ‰¾äºŒçº§ç¼“å­˜ã€‚é‚£ä¹ˆå®ƒå¦‚ä½•è§£å†³ä¸€è‡´æ€§é—®é¢˜å’Œå¯é æ€§é—®é¢˜ï¼Ÿ\nå®ƒå¯ä»¥ä½¿ç”¨ Redis çš„å‘å¸ƒ/è®¢é˜…ï¼ˆç±»ä¼¼æ¶ˆæ¯ä¸­é—´ä»¶çš„ç‰¹æ€§ï¼‰æ¥ä¿è¯å¤šä¸ªåº”ç”¨ç¨‹åºå®ä¾‹ä¹‹é—´ä¸€å®šç¨‹åº¦çš„ç¼“å­˜ä¸€è‡´æ€§ï¼Œä¸€å®šç¨‹åº¦æ˜¯å› ä¸º Redis å®˜æ–¹è¯´å°†æ¥æœ‰è®¡åˆ’æ”¯æŒæ›´å¯é çš„æ¶ˆæ¯ä¼ é€’ï¼›æ‰€è°“å¯é çš„æ¶ˆæ¯ä¼ é€’ï¼Œç±»æ¯” TCP å¯é ä¼ è¾“çš„åŸºæœ¬æ€æƒ³ï¼Œå³ç¡®è®¤ã€è¶…æ—¶ã€é‡ä¼ ç­‰æ¦‚å¿µã€‚\nCDN Content delivery networkï¼Œå³å†…å®¹åˆ†å‘ç½‘ç»œï¼Œä¸å®¹å¿½è§†çš„å¤§è§„æ¨¡åˆ†å¸ƒå¼å¤šçº§ç¼“å­˜ç³»ç»Ÿã€‚\nå¦‚ä¸Šé¢è¿™å¼ æ¥è‡ªç»´åŸºç™¾ç§‘çš„æ’å›¾æ‰€ç¤ºï¼Œå·¦æ‰‹è¾¹æ˜¯å•æœåŠ¡å™¨åˆ†å‘ï¼Œå³æ‰‹è¾¹æ˜¯ CDN åˆ†å‘ã€‚CDN ç»“ç‚¹é€šå¸¸éƒ¨ç½²åœ¨å¤šä¸ªä½ç½®ï¼ŒCDN ç³»ç»Ÿèƒ½å¤Ÿåœ¨ç®—æ³•ä¸Šå°†æµè§ˆå™¨çš„è¯·æ±‚å¯¼å‘ç¦»ç”¨æˆ·æœ€è¿‘æˆ–æœ€ä½³çš„ CDN ç»“ç‚¹ï¼Œæµè§ˆå™¨åˆ™é…åˆç³»ç»Ÿå°±è¿‘è®¿é—®ç»“ç‚¹ã€‚ä½¿ç”¨ CDN è‡³å°‘å…·æœ‰å¦‚ä¸‹ä¼˜åŠ¿ï¼š\né™ä½å¸¦å®½æˆæœ¬ã€‚ ç¼©çŸ­å“åº”æ—¶é—´ã€‚ æé«˜å†…å®¹çš„çš„å…¨çƒæ€§ã€‚ CDN ç³»ç»Ÿæ˜¯ï¼ˆå›ï¼‰æºä¸»æœºåŠå…¶ Web æœåŠ¡å™¨çš„ï¼ˆé«˜é€Ÿï¼‰ç¼“å­˜ï¼ŒCDN ç³»ç»Ÿé€‚åˆç¼“å­˜çš„å†…å®¹æ˜¯æ–‡ä»¶ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ Redis cluster tutorial\nRedis Cluster Specification\nç”Ÿäº§ç¯å¢ƒä¸‹çš„ redis é›†ç¾¤ä¸€èˆ¬æ˜¯å¦‚ä½•éƒ¨ç½²çš„ï¼Ÿ\nA Few Notes on Kafka and Jepsen\nGuava\u0026rsquo;s cache\nSpring cache\nJ2Cache å’Œæ™®é€šç¼“å­˜æ¡†æ¶æœ‰ä½•ä¸åŒï¼Œå®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ\næ‰’æ‰çº¢è–¯çš„å†…è£¤-æ·±å…¥å‰–æJ2Cache\nRedis # documentation\nredisson/redisson\nCDNæ˜¯ä»€ä¹ˆï¼Ÿä½¿ç”¨CDNæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ\n","date":"2020-03-24T17:40:48+08:00","permalink":"https://h2cone.github.io/2020/03/24/distributed-cache/","title":"åˆ†å¸ƒå¼ç¼“å­˜"},{"content":"I/O æœ¬æ–‡ä»¥å¤šçº¿ç¨‹Â·å¹¶å‘ç¼–ç¨‹ä¸­çš„ç¬¬ä¸€å¼ å›¾ä½œä¸ºå¼€ç¯‡ï¼š\nI/O è®¾å¤‡åŒ…æ‹¬é¼ æ ‡ã€é”®ç›˜ã€æ˜¾ç¤ºå™¨ã€ç£ç›˜ã€ç½‘å¡ç­‰ã€‚\nI/Oï¼ˆè¾“å…¥/è¾“å‡ºï¼‰ï¼Œè¾“å…¥æ˜¯ä» I/O è®¾å¤‡å¤åˆ¶æ•°æ®åˆ°ä¸»å­˜ï¼Œè¾“å‡ºæ˜¯ä»ä¸»å­˜å¤åˆ¶æ•°æ®åˆ° I/O è®¾å¤‡ã€‚\nä»ä¸€ä¸ªè®¡ç®—æœºè§’åº¦æ¥çœ‹ï¼Œç½‘ç»œï¼ˆé€‚é…å™¨ï¼‰æ˜¯å®ƒçš„ä¸€ä¸ª I/O è®¾å¤‡ã€‚å½“è®¡ç®—æœºç³»ç»Ÿä»ä¸»å­˜å¤åˆ¶å­—èŠ‚åºåˆ—åˆ°ç½‘ç»œé€‚é…å™¨æ—¶ï¼Œæ•°æ®æµç»è¿‡ç½‘ç»œåˆ°è¾¾å¦ä¸€å°æœºå™¨ï¼ŒåŒç†ï¼Œè®¡ç®—æœºç³»ç»Ÿå¯ä»¥ä»ç½‘ç»œé€‚é…å™¨å¤åˆ¶å­—èŠ‚åºåˆ—åˆ°ä¸»å­˜ã€‚\nSocket ä»äººç±»çš„è§’åº¦æ¥çœ‹ï¼Œè®¡ç®—æœºç½‘ç»œç”±ä¸€å°æˆ–å¤šå°æœºå™¨ç»„æˆã€‚ç½‘ç»œä¸­ï¼Œæ•°æ®ä»ä¸€å°æœºå™¨ä¼ è¾“åˆ°å¦ä¸€ä¸ªæœºå™¨çš„æ–¹å¼é€šå¸¸æ˜¯åˆ†ç»„äº¤æ¢ï¼Œå³æ•°æ®è¢«åˆ‡åˆ†æˆé€‚åˆä¼ è¾“çš„å°å—æ•°æ®ï¼Œå°å—æ•°æ®éƒ½æœ‰å„è‡ªçš„ç¼–å·ï¼›å®ƒä»¬ä»ä¸€ä¸ªç«¯ç‚¹åˆ†é“æ‰¬é•³ï¼Œä½†æ®Šé€”åŒå½’ï¼Œåˆ°å¦ä¸€ä¸ªç«¯ç‚¹æ—¶ï¼Œé‡æ–°æ’åˆ—ç»„åˆæˆå®Œæ•´æ•°æ®ã€‚åˆ†ç»„äº¤æ¢çš„å¥½å¤„ä¹‹ä¸€æ˜¯å……åˆ†åˆ©ç”¨ç½‘ç»œå¸¦å®½ï¼Œè€Œå½“ TCP è¿æ¥ç©ºé—²æ—¶ï¼Œé€šå¸¸ä¸å ç”¨ä»»ä½•å¸¦å®½ã€‚\nåˆ†ç»„äº¤æ¢æœ‰å¯èƒ½å‡ºç°æ•°æ®çš„ä¸¢å¤±ã€ä¹±åºã€é‡å¤ï¼Œå¦‚ä½•æ£€æµ‹ã€é‡ä¼ ã€ç¼“å­˜ï¼Œå®ç°å¯é æ€§ä¼ è¾“æ˜¯ TCP çš„ç›®æ ‡ã€‚åˆ«é—®ï¼Œé—®å°±æ˜¯ä¸‰æ¬¡æ¡æ‰‹ã€å››æ¬¡æŒ¥æ‰‹ã€æ»‘åŠ¨çª—å£åè®®ã€æ‹¥å¡æ§åˆ¶ç®—æ³•\u0026hellip;\u0026hellip;\nTCP/IP åè®®æ—å¯¹æ™®é€šç¨‹åºå‘˜æ¥è¯´è¶³å¤Ÿå¤æ‚ï¼Œä½†æ˜¯ï¼ŒDavid Wheeler æ›¾ç»è¯´è¿‡ï¼š\nAll problems in computer science can be solved by another level of indirection.\nSocket æ˜¯è¿›ç¨‹ä¸ä¼ è¾“å±‚çš„ä¸­é—´å±‚ã€‚\nSocket åŒ…å«äº”å…ƒç»„ (client ip, client port, server ip, server port, protocol)ã€‚\nåŒåœ¨ä¼ è¾“å±‚çš„ UDP ä¸å¦‚ TCP å¯é ï¼Œä½†æ˜¯è½»é‡çº§ï¼Œå› ä¸ºå®ƒæ²¡æœ‰ç¡®è®¤ã€è¶…æ—¶ã€é‡ä¼ çš„æ¦‚å¿µï¼Œä¹Ÿæ²¡æœ‰æ‹¥å¡æ§åˆ¶ï¼Œè€Œä¸”æ— è¿æ¥ï¼Œä»è€Œèƒ½å¹¿æ’­ã€‚\nSocket éšè—äº†ä¸‹å±‚å…·ä½“å®ç°çš„å¤æ‚æ€§ï¼Œå¹¶ç»™ä¸Šå±‚æä¾›äº†ç®€å•æˆ–ç»Ÿä¸€çš„ APIã€‚ä¸‹å›¾æ˜¯ TCP Socket åŸºæœ¬æµç¨‹ï¼Œä½¿ç”¨ ä¼¯å…‹åˆ© Sockets æè¿°ã€‚\nUnix çš„ä¸»é¢˜æ˜¯â€œä¸€åˆ‡éƒ½æ˜¯æ–‡ä»¶â€ã€‚å½“è¿›ç¨‹ç”³è¯·è®¿é—® Socket æ—¶ï¼Œå†…æ ¸åˆ™æä¾›ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆint å˜é‡ï¼‰ï¼Œè¿›ç¨‹å‘èµ·ç³»ç»Ÿè°ƒç”¨å¹¶ä¼ é€’ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦æ¥è¯»å†™ Socketã€‚\nJava ç½‘ç»œç¼–ç¨‹ BIO Java çš„ BIO æ˜¯æŒ‡ blocking I/Oï¼Œé€šå¸¸æŒ‡ java.io åŒ…ç»„åˆ java.net åŒ…ã€‚\næ¨¡å‹ ä¸Šå›¾æ¥è‡ªæœåŠ¡åŒ–åŸºçŸ³ä¹‹è¿œç¨‹é€šä¿¡ç³»åˆ—ä¸‰ï¼šI/Oæ¨¡å‹ã€‚åŸºäº Java BIO çš„æœåŠ¡å™¨ç«¯ç¨‹åºï¼Œé€šå¸¸ä¸€ä¸ªå®¢æˆ·ç«¯ï¼ˆClientï¼‰å‘æœåŠ¡å™¨ç«¯ï¼ˆServerï¼‰å‘èµ·çš„è¯·æ±‚ç”±ä¸€ä¸ªçº¿ç¨‹å¤„ç†ï¼Œå›æƒ³å‰æ–‡çš„ TCP Socket åŸºæœ¬æµç¨‹å›¾ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¸ Socket çš„å…³ç³»å¦‚ä¸‹ï¼š\nå¤„ç†è¯·æ±‚ï¼Œé€šå¸¸éƒ½å¯ä»¥åˆ†è§£ä¸ºï¼š\næ¥æ”¶è¯·æ±‚ï¼ˆreceive/readï¼‰ è§£ç è¯·æ±‚ï¼ˆdeocodeï¼‰ è®¡ç®—/å¤„ç†ï¼ˆcompute/processï¼‰ ç¼–ç å“åº”ï¼ˆencodeï¼‰ å‘é€å“åº”ï¼ˆsend/wirteï¼‰ å…¶ä¸­ 1 å’Œ 5 å¿…å®šæ˜¯ I/O æ“ä½œï¼Œå›æƒ³å‰æ–‡æ‰€è¯´çš„ I/O æ“ä½œçš„æœ¬è´¨ï¼Œå³å­—èŠ‚åºåˆ—çš„æ¥å‘å’Œå»å‘ï¼Œæ¥å‘ä¸å»å‘åœ¨ java.io ä¸­çš„å¸¸è§ç±»å‹æ˜¯ InputStream å’Œ OutputStreamï¼ŒI/O Stream è¡¨ç¤ºè¾“å…¥æºæˆ–è¾“å‡ºç›®çš„åœ°ã€‚\nåŸºäº Java BIO çš„æœåŠ¡å™¨ç«¯ç¨‹åºä¹‹æ‰€ä»¥ä½¿ç”¨çº¿ç¨‹æ± ï¼ˆThreadPoolï¼‰ï¼Œç†ç”±è¯·å‚è€ƒå¤šçº¿ç¨‹Â·å¹¶å‘ç¼–ç¨‹ # Java å¤šçº¿ç¨‹ # çº¿ç¨‹æ± ã€‚\nServer ä»¥ä¸Šå†…å®¹ç»“åˆ java.net çš„ Socket APIï¼Œè¶³ä»¥ç¼–å†™å…¸å‹çš„ Java BIO æœåŠ¡å™¨ç«¯ç¨‹åºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 class Server implements Runnable { final int port; final Executor executor; final Processable processable; public Server(int port, Executor executor, Processable processable) { this.port = port; this.executor = executor; this.processable = processable; } @Override public void run() { try { ServerSocket serverSocket = new ServerSocket(port); while (!Thread.interrupted()) { Socket socket = serverSocket.accept(); executor.execute(new Handler(socket, processable)); } } catch (IOException e) { e.printStackTrace(); } } static class Handler implements Runnable { final Socket socket; final Processable processable; public Handler(Socket socket, Processable processable) { this.socket = socket; this.processable = processable; } @Override public void run() { processable.process(socket); } } @Deprecated interface Processable { void process(Socket socket); } } æ³¨æ„ Server çš„ run æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨ ServerSocket å¾ªç¯ï¼Ÿé¦–å…ˆ accept() æ˜¯é˜»å¡æ–¹æ³•ï¼Œè¡¨ç°ä¸ºä¸€ä¸ªçº¿ç¨‹è°ƒç”¨è¯¥æ–¹æ³•æ—¶è¢«é˜»å¡åœ¨è¯¥æ–¹æ³•ï¼Œç›´åˆ° ServerSocket å‡†å¤‡å¥½æ¥å—ï¼ˆaccpetï¼‰å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥ï¼ˆconnectï¼‰æ—¶æ–¹æ³•è¿”å›ï¼Œè¯¥çº¿ç¨‹é€€å‡ºè¯¥æ–¹æ³•ï¼Œè¿”å›å€¼çš„ç±»å‹æ˜¯ Socketï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯çš„ Socket å‰¯æœ¬ã€‚ç„¶åï¼Œè¯¥çº¿ç¨‹å‘½ä»¤å·¥ä½œçº¿ç¨‹å¤„ç† Socketï¼Œè¿™é‡Œç”¨ Handler çš„ run æ–¹æ³•ä½œä¸ºå·¥ä½œçº¿ç¨‹çš„ä»»åŠ¡ï¼Œæ ¹æ® Executor çš„ä¸€èˆ¬å®ç°ï¼Œexecute() éé˜»å¡ï¼Œç«‹å³è¿”å›ã€‚æœ€åï¼Œç»§ç»­å¾ªç¯ã€‚å› æ­¤ï¼Œå¦‚æœæ²¡æœ‰å·¥ä½œçº¿ç¨‹ä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå®¹æ˜“å‡ºç°è¯¥çº¿ç¨‹æ­£åœ¨å¤„ç†ä¸€ä¸ª Socket è€Œæ— æ³•è„±èº«å»å¤„ç†å…¶å®ƒå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼ˆä¾›ä¸åº”æ±‚ï¼‰ã€‚\nå»ºè®®ä½¿ç”¨æ—¥å¿—æ¡†æ¶ä»£æ›¿ e.printStackTrace() å’Œ System.out.print*ï¼Œè¿˜æœ‰åˆç†è®¾ç½®çº¿ç¨‹æ± çš„å‚æ•°ï¼Œä»…ä»…ä¸ºäº†æ–¹ä¾¿å±•ç¤ºï¼Œé‡‡ç”¨ä»¥ä¸‹æ–¹å¼å¯åŠ¨ Serverï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 public static void main(String[] args) { int port = args.length == 0 ? 8080 : Integer.parseInt(args[0]); Server server = new Server(port, Executors.newCachedThreadPool(), (socket) -\u0026gt; { try (InputStream input = socket.getInputStream(); OutputStream output = socket.getOutputStream()) { // read int len; byte[] buf = new byte[1024]; if ((len = input.read(buf)) != -1) { String msg = new String(buf, 0, len); System.out.printf(\u0026#34;%s receive \u0026#39;%s\u0026#39; from %s\\n\u0026#34;, Thread.currentThread().getName(), msg, socket.toString()); // consuming Thread.sleep(DELAY_TIME); // write msg = String.format(\u0026#34;i am %s\u0026#34;, Thread.currentThread().getName()); output.write(msg.getBytes()); output.flush(); } } catch (IOException | InterruptedException e) { e.printStackTrace(); } }); new Thread(server).start(); System.out.printf(\u0026#34;server running on %s\\n\u0026#34;, port); } å¤„ç† Socket çš„è¿‡ç¨‹é¦–å…ˆæ˜¯ä½¿ç”¨ Socket å¾—åˆ° InputStream å’Œ OutputStreamï¼Œç„¶åä»ä¸­è¯»å–å­—èŠ‚æ•°ç»„ï¼Œè§£ç ä¸ºå­—ç¬¦ä¸²ï¼Œæ‰“å°è¡¨ç¤ºæ”¶åˆ°äº†å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼Œæœ€åä»¥â€œè‡ªæˆ‘ä»‹ç»â€å›å¤å®¢æˆ·ç«¯ã€‚æ³¨æ„ï¼Œè°ƒç”¨ read æ–¹æ³•å°†é˜»å¡ï¼Œç›´åˆ°è¾“å…¥æ•°æ®å¯ç”¨æˆ–æ£€æµ‹åˆ° EOF æˆ–å¼•å‘å¼‚å¸¸ä¸ºæ­¢ã€‚\nå¤šå®¢æˆ·ç«¯å¯ä»¥ç”¨å¤šçº¿ç¨‹æ¨¡æ‹Ÿã€‚å®¢æˆ·ç«¯å…ˆå‘æœåŠ¡å™¨ç«¯å‘é€â€œè‡ªæˆ‘ä»‹ç»â€ï¼Œç„¶åå°è¯•è¯»å–æ¥è‡ªæœåŠ¡å™¨ç«¯çš„æ¶ˆæ¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public class BioClient { public static int NUMBER_OF_CLIENTS = 8; public static void main(String[] args) { String host = args.length == 0 ? \u0026#34;127.0.0.1\u0026#34; : args[0]; int port = args.length == 0 ? 8080 : Integer.parseInt(args[1]); Runnable runnable = () -\u0026gt; { try { Socket socket = new Socket(host, port); try (OutputStream output = socket.getOutputStream(); InputStream input = socket.getInputStream()) { // write String msg = String.format(\u0026#34;i am %s\u0026#34;, Thread.currentThread().getName()); output.write(msg.getBytes()); output.flush(); // read int len; byte[] buf = new byte[1024]; if ((len = input.read(buf)) != -1) { msg = new String(buf, 0, len); System.out.printf(\u0026#34;%s receive \u0026#39;%s\u0026#39; from %s\\n\u0026#34;, Thread.currentThread().getName(), msg, socket.toString()); } } } catch (IOException e) { e.printStackTrace(); } }; for (int i = 0; i \u0026lt; NUMBER_OF_CLIENTS; i++) { new Thread(runnable).start(); } } } åŸºäº Java NIO çš„æœåŠ¡å™¨ç«¯ç¨‹åºï¼Œè™½ç„¶ä½¿ç”¨äº†çº¿ç¨‹æ± ï¼Œä½†æ˜¯å¤„ç† Socket æ™®éå­˜åœ¨é˜»å¡ I/Oï¼Œå·¥ä½œçº¿ç¨‹è¢«é˜»å¡æˆ–è¢«è¿«ç­‰å¾…è¾ƒé•¿æ—¶é—´ï¼Œä¸”ä¸€ä¸ª Socket ç”±ä¸€ä¸ªçº¿ç¨‹å¤„ç†ï¼Œå³çº¿ç¨‹å·¥æ—¶åˆ©ç”¨ç‡è¾ƒä½ï¼Œå•ä¸ªè¿™ç§æœåŠ¡å™¨ç«¯ç¨‹åºåº”å¯¹è´Ÿè½½å¢åŠ ï¼ˆC10K ~ C100Kï¼‰çš„èƒ½åŠ›å¹¶ä¸æ˜¯æœ€ä¼˜åŒ–ã€‚\nNIO Java çš„ NIO æ˜¯æŒ‡ non-blocking I/O æˆ– New I/Oï¼Œé€šå¸¸æŒ‡ java.nio åŒ…ç»„åˆ java.net åŒ…ã€‚\næ¨¡å‹ ä¸Šå›¾æ¥è‡ªæœåŠ¡åŒ–åŸºçŸ³ä¹‹è¿œç¨‹é€šä¿¡ç³»åˆ—ä¸‰ï¼šI/Oæ¨¡å‹ã€‚Java NIO è‡´åŠ›äºç”¨æ¯” Java BIO æ›´å°‘çš„çº¿ç¨‹å¤„ç†æ›´å¤šçš„è¿æ¥ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªä¸å¸Œæœ›è¢«è€æ¿å¼€é™¤çš„åº—å°äºŒå°†ä¸€ä½å®¢äººçš„è®¢å•äº¤ç»™åå¨åï¼Œä¸ä¼šåªç­‰å¾…åå¨åšå¥½ç›¸åº”çš„èœç„¶åä¸Šèœï¼Œè€Œæ˜¯ç«‹å³å»æ¥å¾…å…¶å®ƒå®¢äººå…¥åº§ã€ç‚¹é¤ã€ç»“è´¦ç­‰ï¼Œè‹¥åº—å°äºŒè§‚å¯Ÿåˆ°åå¨åšèœå®Œæˆååˆ™ä¸Šèœæˆ–è€…åå¨åšèœå®Œæˆåé€šçŸ¥åº—å°äºŒä¸Šèœã€‚\nJava NIO æœ‰ä¸‰å¤§æ ¸å¿ƒç»„ä»¶ï¼š\nChannelsã€‚æ”¯æŒéé˜»å¡è¯»å†™ Channel å…³è”çš„æ–‡ä»¶æˆ– Socketã€‚\nBuffersã€‚å¯ä»¥ä» Channel ç›´æ¥è¯»å–æˆ–ç›´æ¥å†™å…¥ Channel çš„ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ã€‚\nSelectorsã€‚åˆ¤æ–­ä¸€ç»„ Channel ä¸­å“ªäº›å‘ç”Ÿäº†ç”¨æˆ·æ„Ÿå…´è¶£çš„ I/O äº‹ä»¶ã€‚\nä¸€äº›ä¸å®¹å¿½è§†ï¼š\nSelectionKeysã€‚ç»´æŠ¤ I/O äº‹ä»¶çŠ¶æ€å’Œé™„ä»¶ã€‚\nServerSocketChannelã€‚ä»£æ›¿ ServerSocketã€‚\nSocketChannelã€‚ä»£æ›¿ Socketã€‚\nChannel\u0026amp;Selector Selector æ˜¯çº¿ç¨‹å’Œ Channel çš„ä¸­é—´å±‚ï¼Œå¤šä¸ªè¿æ¥å¯ç”±ä¸€ä¸ªçº¿ç¨‹å¤„ç†ã€‚\nSelectionKey å®šä¹‰äº†å››ç§ I/O äº‹ä»¶ï¼š OP_READã€OP_WRITEã€OP_CONNECTã€OP_ACCEPTï¼Œå‡ç¬¦åˆä¼¯å…‹åˆ© Sockets çš„è¯­ä¹‰ï¼ŒOP_CONNECT ä¸ºå®¢æˆ·ç«¯ä¸“æœ‰ï¼ŒOP_ACCEPT ä¸ºæœåŠ¡å™¨ç«¯ä¸“æœ‰ã€‚\nOP_ACCEPTã€‚ServerSocketChannel æ¥å—å°±ç»ªã€‚\nOP_READã€‚ä¾‹å¦‚ï¼ŒSocketChannel è¯»å°±ç»ªã€‚\nOP_WRITEã€‚ä¾‹å¦‚ï¼ŒSocketChannel å†™å°±ç»ªã€‚\nBuffer Buffer ç»´æŠ¤äº† positionã€limitã€capacity å˜é‡ï¼Œå…·æœ‰å†™æ¨¡å¼å’Œè¯»æ¨¡å¼ã€‚\nå†™æ¨¡å¼ã€‚position ä¸º 0ï¼Œlimit ç­‰äº capacityï¼Œæ¯æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œposition å¢åŠ  1ã€‚\nè¯»æ¨¡å¼ã€‚ç”±è¯»æ¨¡å¼è½¬æ¢ä¸ºå†™æ¨¡å¼æ—¶ï¼Œlimit è®¾ä¸º positionï¼Œposition å½’é›¶ã€‚\nByteBuffer çš„å†™å…¥å’Œè¯»å–é€šå¸¸ç»å†å¦‚ä¸‹æ­¥éª¤ï¼š\nå°†å­—èŠ‚æ•°ç»„å†™å…¥ ByteBufferã€‚\nè°ƒç”¨ flip()ï¼Œè½¬æ¢ä¸ºè¯»æ¨¡å¼ã€‚\nä» ByteBuffer è¯»å–å­—èŠ‚æ•°ç»„ã€‚\nè°ƒç”¨ clear() æˆ– compact() æ¸…ç©º ByteBufferã€‚\nChannel å·²æä¾›ç›´æ¥ä»ä¸­è¯»å– ByteBuffer æˆ–ç›´æ¥å†™å…¥å…¶ä¸­çš„æ–¹æ³•ã€‚\nå€¼å¾—ä¸€æçš„æ˜¯ï¼ŒByteBuffer æ”¯æŒåˆ†é…ç›´æ¥å­—èŠ‚ç¼“å†²åŒºï¼Œå³å †å¤–å†…å­˜ã€‚\n1 2 3 public static ByteBuffer allocateDirect(int capacity) { return new DirectByteBuffer(capacity); } 1 2 3 4 5 public static ByteBuffer allocate(int capacity) { if (capacity \u0026lt; 0) throw new IllegalArgumentException(); return new HeapByteBuffer(capacity, capacity); } DirectByteBuffer é€šå¸¸æ¯” HeapByteBuffer å†…å­˜å¤åˆ¶æ¬¡æ•°æ›´å°‘ã€‚ä»¥å†™ Socket ä¸ºä¾‹ï¼ŒJVM å…ˆä»å †ä¸­å¤åˆ¶æ•°æ®åˆ°è¿›ç¨‹ç¼“å†²åŒºï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸å†ä»è¿›ç¨‹ç¼“å†²åŒºå¤åˆ¶æ•°æ®åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ®åˆ° I/O è®¾å¤‡ã€‚å¦‚æœåˆ†é…ç›´æ¥ç¼“å†²åŒºï¼Œé‚£ä¹ˆå°±å‡å»äº†ä»å †å¤åˆ¶æ•°æ®åˆ°è¿›ç¨‹ç¼“å†²åŒºçš„æ“ä½œã€‚allocateDirect æ–¹æ³•ä½¿ç”¨äº† sun.misc.Unsafe#allocateMemory æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•è¿”å›çš„ç¼“å†²åŒºé€šå¸¸æ¯”éç›´æ¥ç¼“å†²åŒºå…·æœ‰æ›´é«˜çš„åˆ†é…å’Œé‡Šæ”¾æˆæœ¬ï¼Œå› ä¸ºå †å¤–å†…å­˜åœ¨ GC èŒƒå›´ä¹‹å¤–ï¼Œå³ä½¿ java.nio.DirectByteBuffer å®ç°äº†è‡ªå·±çš„ç¼“å†²åŒºå¯¹è±¡ç®¡ç†ï¼Œä»ç„¶æœ‰å †å¤–å†…å­˜æ³„éœ²çš„é£é™©ï¼Œé€šå¸¸è¦è€ƒè™‘ä»¥ä¸‹çš„ JVM é€‰é¡¹ï¼š\n1 -XX:MaxDirectMemorySize=size ä¸€ä¸ªç›´æ¥å­—èŠ‚ç¼“å†²åŒºä¹Ÿå¯ä»¥é€šè¿‡å°†æ–‡ä»¶åŒºåŸŸç›´æ¥ mapping åˆ°å†…å­˜ä¸­æ¥åˆ›å»ºï¼ŒåŸç†æ˜¯ mmapã€‚\nReactor æ ¹æ®ä¸Šæ–‡çš„çŸ¥è¯†ï¼Œè¶³ä»¥å®ç°å…¸å‹çš„ Java NIO æœåŠ¡å™¨ç«¯ç¨‹åºï¼Œä½†æ˜¯æˆ‘æŠŠå®ƒåˆ æ‰äº†ï¼›å› ä¸ºå®ƒè¡¨ç°å¾—ä¸å¦‚ä¸Šæ–‡å…¸å‹çš„ Java BIO çš„æœåŠ¡å™¨ç«¯ç¨‹åºï¼Œæ›´å› ä¸ºæˆ‘è¯»åˆ°äº† Doug Lea è®²çš„ Reactor æ¨¡å¼ï¼ˆé“¾æ¥åœ¨æ–‡ç« æœ«å°¾ï¼‰ï¼Œå¸¸ç¿» JDK æºç å¯ä»¥å‘ç°ä»–æ˜¯å¤§éƒ¨åˆ†å¹¶å‘æ•°æ®ç»“æ„çš„ä½œè€…ã€‚\nå•çº¿ç¨‹ç‰ˆ è‹¥ç”¨ Java è¯­è¨€æ¥æè¿°ä¸Šå›¾ï¼ŒåŸºæœ¬çš„ Reactor æ¨¡å¼å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 class Reactor implements Runnable { final Selector selector; final ServerSocketChannel serverSocketChannel; final ChannelHandler channelHandler; public Reactor(int port, ChannelHandler channelHandler) throws IOException { selector = Selector.open(); serverSocketChannel = ServerSocketChannel.open(); serverSocketChannel.socket().bind(new InetSocketAddress(port)); serverSocketChannel.configureBlocking(false); SelectionKey selectionKey = serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT); selectionKey.attach(new Acceptor()); // (1) this.channelHandler = channelHandler; } @Override public void run() { try { while (!Thread.interrupted()) { selector.select(); Set\u0026lt;SelectionKey\u0026gt; selectionKeys = selector.selectedKeys(); Iterator\u0026lt;SelectionKey\u0026gt; iterator = selectionKeys.iterator(); while (iterator.hasNext()) { SelectionKey selectionKey = iterator.next(); dispatch(selectionKey); // (2) iterator.remove(); } selectionKeys.clear(); } } catch (IOException e) { e.printStackTrace(); } } private void dispatch(SelectionKey selectionKey) { Runnable runnable = (Runnable) selectionKey.attachment(); if (runnable != null) { runnable.run(); // (3) } } class Acceptor implements Runnable { @Override public void run() { try { SocketChannel socketChannel = serverSocketChannel.accept(); if (socketChannel != null) { new Handler(selector, socketChannel, channelHandler); // (4) } } catch (IOException e) { e.printStackTrace(); } } } static class Handler implements Runnable { final SelectionKey selectionKey; final SocketChannel socketChannel; final ChannelHandler channelHandler; ByteBuffer inputBuf = ByteBuffer.allocate(1024); ByteBuffer outputBuf = ByteBuffer.allocate(1024); static int READING = 0, WRITING = 1; int state = READING; public Handler(Selector selector, SocketChannel socketChannel, ChannelHandler channelHandler) throws IOException { this.socketChannel = socketChannel; this.socketChannel.configureBlocking(false); // (5) selectionKey = this.socketChannel.register(selector, 0); selectionKey.attach(this); selectionKey.interestOps(SelectionKey.OP_READ); selector.wakeup(); this.channelHandler = channelHandler; } @Override public void run() { try { if (state == READING) { read(); } else if (state == WRITING) { write(); } } catch (Exception e) { e.printStackTrace(); } } private void read() throws IOException { channelHandler.read(socketChannel, inputBuf); if (channelHandler.inputCompleted(inputBuf)) { channelHandler.process(inputBuf, outputBuf); state = WRITING; selectionKey.interestOps(SelectionKey.OP_WRITE); } } private void write() throws IOException { channelHandler.write(socketChannel, outputBuf); if (channelHandler.outputCompleted(outputBuf)) { selectionKey.cancel(); // (6) } } } } ï¼ˆ1ï¼‰Reactor æ„é€ å™¨ã€‚ä½¿ç”¨ serverSocketChannel æ³¨å†Œ selector å¹¶æ·»åŠ æ„Ÿå…´è¶£çš„ I/O äº‹ä»¶ï¼ˆOP_ACCEPTï¼‰ä¹‹åï¼Œè¿”å›å¾—åˆ°ä¸€ä¸ª selectionKeyï¼ŒselectionKey å¯æ·»åŠ ä¸€ä¸ªé™„ä»¶ï¼Œè¿™ä¸ªé™„ä»¶æ˜¯ Acceptor å¯¹è±¡çš„å¼•ç”¨ã€‚\nï¼ˆ2ï¼‰åˆ†æ´¾å¾ªç¯ã€‚é¦–å…ˆï¼Œè°ƒç”¨ selector.select() æ—¶é˜»å¡ï¼Œç›´åˆ°é€‰ä¸­äº†ä¸€ç»„å·²å‡†å¤‡å¥½è¿›è¡Œ I/O æ“ä½œçš„ Channel æ‰€å¯¹åº”çš„é”®ï¼ˆSelectionKeyï¼‰ï¼Œåˆå§‹åªå¯¹ OP_ACCEPT æ„Ÿå…´è¶£ã€‚ç„¶åï¼Œè¿­ä»£å¾—åˆ°ç›¸åº”çš„é”®ï¼Œå› ä¸ºä¸€å¼€å§‹åªæœ‰ä¸€ä¸ª Channelï¼Œæ‰€ä»¥å½“å‰é”®é›†åˆå¤§å°ä¸º 1ï¼Œè°ƒç”¨ dispatch æ—¶å¾—åˆ°çš„é”®çš„é™„ä»¶å³æ˜¯ Acceptor å¯¹è±¡çš„å¼•ç”¨ã€‚\nï¼ˆ3ï¼‰åˆ†æ´¾æ–¹æ³•ã€‚ç”±ï¼ˆ2ï¼‰å¯çŸ¥ï¼ŒAcceptor çš„ run æ–¹æ³•è¢«è°ƒç”¨ï¼Œä½†ä¸ç›´æ¥å¯åŠ¨æ–°çº¿ç¨‹ã€‚\nï¼ˆ4ï¼‰Acceptor è¿è¡Œæ–¹æ³•ã€‚ä¼ é€’ selector å’Œ socketChannel æ¥æ–°å»º Handler å¯¹è±¡ï¼Œä¸ç›´æ¥è°ƒç”¨å…¶ run æ–¹æ³•ï¼Œè€Œæ˜¯è¿”å›åˆ°åˆ†æ´¾å¾ªç¯ã€‚\nï¼ˆ5ï¼‰Handler æ„é€ å™¨ã€‚ç”¨å½“å‰çš„ socketChannel æ³¨å†Œ selector å¹¶æ·»åŠ æ„Ÿå…´è¶£çš„ I/O äº‹ä»¶ï¼ˆOP_READï¼‰å’Œé™„ä»¶ï¼ˆHandler å¯¹è±¡çš„å¼•ç”¨ï¼‰ï¼Œä½†è¦æ³¨æ„å”¤é†’ selectorï¼Œä½¿å°šæœªè¿”å›çš„ç¬¬ä¸€ä¸ª select æ“ä½œç«‹å³è¿”å›ï¼Œç†ç”±æ˜¯æœ‰æ–°çš„ Channel åŠ å…¥ã€‚\nï¼ˆ6ï¼‰Handler è¿è¡Œæ–¹æ³•ã€‚åœ¨åˆ†æ´¾å¾ªç¯ä¸­ï¼Œè‹¥å¯è¯»çš„ socketChannel å¯¹åº”çš„é”®è¢«é€‰ä¸­ï¼Œåˆ™è¯¥é”®çš„é™„ä»¶ï¼Œå³ Handler å¯¹è±¡çš„ run æ–¹æ³•è¢«è°ƒç”¨ï¼Œå¯¹ Channel è¿›è¡Œéé˜»å¡è¯»å†™æ“ä½œï¼Œä¸­é—´è¿˜æœ‰ process æ–¹æ³•ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰ï¼Œå†™å®Œä¹‹åå–æ¶ˆè¯¥é”®å…³è”çš„ socketChannel å¯¹ selector çš„æ³¨å†Œã€‚\nåœ¨ Java NIO ä¸­ï¼Œå¯¹ Channel çš„è¯»å†™æ˜¯éé˜»å¡æ–¹æ³•ï¼ˆç›´æ¥æ‰§è¡Œä¸”ç«‹å³è¿”å›ï¼Œä½†ç¨åå†æ‰§è¡Œï¼‰ï¼Œé€šå¸¸è¦åˆ¤æ–­è¾“å…¥æ˜¯å¦å®Œæˆï¼ˆinputCompletedï¼‰ï¼Œå®Œæˆåè¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆprocessï¼‰ï¼Œä»¥åŠåˆ¤æ–­è¾“å‡ºæ˜¯å¦å®Œæˆï¼ˆoutputCompletedï¼‰ï¼Œå®Œæˆåæ³¨é”€ï¼ˆçŸ­è¿æ¥ï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 public interface ChannelHandler { void read(SocketChannel socketChannel, ByteBuffer inputBuf) throws IOException; boolean inputCompleted(ByteBuffer inputBuf); void process(ByteBuffer inputBuf, ByteBuffer outputBuf); void write(SocketChannel socketChannel, ByteBuffer outputBuf) throws IOException; boolean outputCompleted(ByteBuffer outputBuf); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 public class DefaultChannelHandler implements ChannelHandler { public static final String SEND = \u0026#34;i am %s\u0026#34;; public static final String RECEIVE = \u0026#34;%s receive \u0026#39;%s\u0026#39;\u0026#34;; @Override public void read(SocketChannel socketChannel, ByteBuffer inputBuf) throws IOException { socketChannel.read(inputBuf); } @Override public boolean inputCompleted(ByteBuffer inputBuf) { return inputBuf.position() \u0026gt; 2; } @Override public void process(ByteBuffer inputBuf, ByteBuffer outputBuf) { try { inputBuf.flip(); String msg = Charset.defaultCharset().newDecoder().decode(inputBuf).toString(); System.out.printf(RECEIVE + \u0026#34;\\n\u0026#34;, Thread.currentThread().getName(), msg); // consuming Thread.sleep(BioServer.DELAY_TIME); msg = String.format(SEND, Thread.currentThread().getName()); outputBuf.put(ByteBuffer.wrap(msg.getBytes())); } catch (IOException | InterruptedException e) { e.printStackTrace(); } } @Override public void write(SocketChannel socketChannel, ByteBuffer outputBuf) throws IOException { outputBuf.flip(); socketChannel.write(outputBuf); } @Override public boolean outputCompleted(ByteBuffer outputBuf) { return !outputBuf.hasRemaining(); } } ä»…ä»…ä¸ºäº†æ–¹ä¾¿å±•ç¤ºï¼Œé‡‡ç”¨ä»¥ä¸‹æ–¹å¼å¯åŠ¨ Reactorï¼š\n1 2 3 4 5 6 7 8 public static void main(String[] args) throws IOException { int port = args.length == 0 ? 8080 : Integer.parseInt(args[0]); ExecutorService executorService = Executors.newSingleThreadExecutor(); executorService.execute(new Reactor(port, Executors.newCachedThreadPool(), new DefaultChannelHandler())); System.out.printf(\u0026#34;server running on %s\\n\u0026#34;, port); } ä¸€å›¾èƒœåƒè¨€ã€‚\nä¸ä¸Šæ–‡ BIO å®¢æˆ·ç«¯ç¨‹åºç±»ä¼¼ï¼Œä¹Ÿæ¨¡æ‹Ÿå¤šå®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯å…ˆå‘æœåŠ¡å™¨ç«¯å‘é€â€œè‡ªæˆ‘ä»‹ç»â€ï¼Œç„¶åå°è¯•è¯»å–æ¥è‡ªæœåŠ¡å™¨ç«¯çš„æ¶ˆæ¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public class Client { public static void main(String[] args) { String host = args.length == 0 ? \u0026#34;127.0.0.1\u0026#34; : args[0]; int port = args.length == 0 ? 8080 : Integer.parseInt(args[1]); SocketAddress socketAddress = new InetSocketAddress(host, port); Runnable runnable = () -\u0026gt; { try { SocketChannel socketChannel = SocketChannel.open(socketAddress); socketChannel.configureBlocking(true); // write String msg = String.format(DefaultChannelHandler.SEND, Thread.currentThread().getName()); ByteBuffer buffer = ByteBuffer.wrap(msg.getBytes()); socketChannel.write(buffer); // read buffer = ByteBuffer.allocate(1024); socketChannel.read(buffer); if (buffer.position() \u0026gt; 0) { buffer.flip(); msg = Charset.defaultCharset().newDecoder().decode(buffer).toString(); System.out.printf(DefaultChannelHandler.RECEIVE + \u0026#34;\\n\u0026#34;, Thread.currentThread().getName(), msg); } } catch (IOException e) { e.printStackTrace(); } }; for (int i = 0; i \u0026lt; BioClient.NUMBER_OF_CLIENTS; i++) { new Thread(runnable).start(); } } } å¤šçº¿ç¨‹ç‰ˆ ä»”ç»†å®¡è§†å•çº¿ç¨‹ç‰ˆå¯ä»¥å‘ç°ï¼Œacceptã€readã€processã€write éƒ½åªç”±ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œä½†æ˜¯åº”å¯¹é«˜å¹¶å‘æ—¶å•çº¿ç¨‹å·¥ä½œèƒ½åŠ›æœ‰é™ã€‚å¦‚æœå®ƒè¯»å®Œäº†ä¸€ä¸ª Channel ååœ¨ process ä¸­æ‰§è¡Œè€—æ—¶ä»»åŠ¡ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰ç©ºé—²æ—¶é—´è¿›è¡Œå…¶å®ƒ Channel çš„ acceptã€readã€write æ“ä½œï¼›å› æ­¤ï¼Œä½¿ç”¨ Boss/Reactor çº¿ç¨‹æ‰§è¡Œéé˜»å¡çš„ acceptã€readã€write æ“ä½œï¼Œå‘½ä»¤å·¥ä½œçº¿ç¨‹æ‰§è¡Œè€—æ—¶çš„ process æ“ä½œï¼Œå……åˆ†æ¶ˆè´¹å¤šå¤„ç†å™¨æ¥æé«˜ç¨‹åºæ€§èƒ½ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 static class Handler implements Runnable { final Selector selector; final SelectionKey selectionKey; final SocketChannel socketChannel; final ChannelHandler channelHandler; ByteBuffer inputBuf = ByteBuffer.allocate(1024); ByteBuffer outputBuf = ByteBuffer.allocate(1024); static int READING = 0, PROCESSING = 1, WRITING = 2; int state = READING; final Executor executor; public Handler(Selector selector, SocketChannel socketChannel, Executor executor, ChannelHandler channelHandler) throws IOException { this.selector = selector; this.socketChannel = socketChannel; this.socketChannel.configureBlocking(false); selectionKey = this.socketChannel.register(selector, 0); selectionKey.attach(this); selectionKey.interestOps(SelectionKey.OP_READ); selector.wakeup(); this.executor = executor; this.channelHandler = channelHandler; } @Override public void run() { try { if (state == READING) { read(); } else if (state == PROCESSING) { processAndHandOff(); } else if (state == WRITING) { write(); } } catch (IOException e) { e.printStackTrace(); } } private synchronized void read() throws IOException { channelHandler.read(socketChannel, inputBuf); if (channelHandler.inputCompleted(inputBuf)) { state = PROCESSING; executor.execute(this::processAndHandOff); } } private synchronized void processAndHandOff() { channelHandler.process(inputBuf, outputBuf); state = WRITING; selectionKey.interestOps(SelectionKey.OP_WRITE); selector.wakeup(); } private void write() throws IOException { channelHandler.write(socketChannel, outputBuf); if (channelHandler.outputCompleted(outputBuf)) { selectionKey.cancel(); } } } åœ¨å•çº¿ç¨‹ç‰ˆçš„åŸºç¡€ä¸Šæ›´æ”¹ Handlerï¼Œç„¶åç”¨ä»¥ä¸‹æ–¹å¼å¯åŠ¨ Reactorï¼ˆå»ºè®®åˆç†è®¾ç½®çº¿ç¨‹æ± çš„å‚æ•°ï¼‰ï¼š\n1 2 ExecutorService executorService = Executors.newSingleThreadExecutor(); executorService.execute(new Reactor(port, Executors.newCachedThreadPool(), new DefaultChannelHandler())); è¿›ä¸€æ­¥æ‰©å±•ï¼Œç”šè‡³å¯ä»¥åŒæ—¶è¿è¡Œä¸¤ä¸ª Boss/Reactor çº¿ç¨‹ï¼Œä¸» Reactor çº¿ç¨‹è´Ÿè´£ acceptï¼Œåˆ†æ´¾å·²æ¥å—çš„ Channel ç»™å­ Reactor çº¿ç¨‹ read å’Œ writeï¼Œå­ Reactor çº¿ç¨‹å‘½ä»¤å·¥ä½œçº¿ç¨‹ processã€‚\nä¸€èˆ¬çš„å¼€å‘äººå‘˜ç›´æ¥ä½¿ç”¨ Java NIO ç¼–å†™æœåŠ¡å™¨ç«¯æˆ–å®¢æˆ·ç«¯ï¼Œæ—¢è¦ä¿è¯å¯é ï¼Œåˆè¦ä¿è¯é«˜æ€§èƒ½ï¼Œå®å±ä¸æ˜“ï¼Œç»ˆäºåˆ°äº†ä¸»è§’ç™»åœºçš„æ—¶å€™ã€‚\nNetty Netty æ˜¯å¼‚æ­¥ã€äº‹ä»¶é©±åŠ¨ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤çš„é«˜æ€§èƒ½åè®®æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ã€‚\nå¦‚ä½•ä½¿ç”¨ Nettyï¼Œå‚è€ƒ Netty # Wikiã€netty/netty/tree/4.1/exampleã€normanmaurer/netty-in-action ã€‚ä¸‹æ–‡åˆ™æ›´å…³æ³¨å¦‚ä½•ç†è§£ Netty 4.x çš„æ ¸å¿ƒï¼ˆCoreï¼‰ã€‚\nBootstrapor or ServerBootstrap EventLoop EventLoopGroup ChannelPipeline Channel Future or ChannelFuture ChannelInitializer ChannelHandler äº‹ä»¶æ¨¡å‹ EventLoop EventLoopï¼Œå³äº‹ä»¶å¾ªç¯ï¼Œä¸€ä¸ª EventLoop é€šå¸¸å°†å¤„ç†å¤šä¸ª Channel çš„äº‹ä»¶ï¼ŒEventLoop åœ¨å®ƒç”Ÿå‘½å‘¨æœŸä¸­åªç»‘å®šå•ä¸ªçº¿ç¨‹ï¼Œè€Œ EventLoopGroup åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª EventLoopã€‚\nEventLoop ç±»çš„æ—è°±å¦‚ä¸‹æ‰€ç¤ºï¼š\nç”±æ­¤å¯è§ï¼ŒEventLoop çš„æœ¬æºæ˜¯ Executorï¼ˆè¯·å…ˆé˜…è¯»å¤šçº¿ç¨‹Â·å¹¶å‘ç¼–ç¨‹ # Java å¤šçº¿ç¨‹ # çº¿ç¨‹æ± ï¼‰ï¼Œé‚£ä¹ˆ EventLoop å¤„ç† Channel çš„äº‹ä»¶è½¬æ¢ä¸ºæ‰§è¡Œï¼ˆexecuteï¼‰ç›¸åº”çš„ä»»åŠ¡ï¼Œ\nä»»åŠ¡çš„åŸºæœ¬å®ç°æ˜¯ Runableï¼Œä»»åŠ¡å¯èƒ½ç«‹å³æ‰§è¡Œï¼Œä¹Ÿå¯èƒ½åŠ å…¥é˜Ÿåˆ—ï¼Œå–å†³äºè°ƒç”¨ execute æ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦æ˜¯ EventLoop ç»‘å®šçš„çº¿ç¨‹ã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸€ä¸ª NioEventLoopGroup é€šå¸¸ç»´æŠ¤å¤šä¸ª NioEventLoop ã€‚\nå½“ä¸€ä¸ª Channel æ³¨å†Œåˆ°ä¸€ä¸ª NioEventLoopGroupï¼Œæ ¹æ®ä¸Šæ–‡æ‰€è¯´çš„ Java NIO çŸ¥è¯†ï¼Œè¯¥ Channel æ³¨å†Œåˆ°ä¸€ä¸ªç”±æŸä¸ª NioEventLoop ç»´æŠ¤çš„ Selectorï¼Œå› æ­¤ï¼ŒNioEventLoop é€šå¸¸å°†å¤„ç†å¤šä¸ª Channel çš„äº‹ä»¶ã€‚\nChannelPipeline äº‹ä»¶åˆ†ä¸ºå…¥ç«™ï¼ˆinboundï¼‰äº‹ä»¶å’Œå‡ºç«™ï¼ˆoutboundï¼‰äº‹ä»¶ã€‚ä¸€ä¸ªäº‹ä»¶è¢« EventLoop ä½œä¸ºä»»åŠ¡æ‰§è¡Œä¹‹å‰ï¼Œå®ƒæµç» ChannelPipeline ä¸­å·²å®‰è£…çš„ä¸€ä¸ªæˆ–å¤šä¸ª ChannelHandlerã€‚\næ¯ä¸ª Channel éƒ½æœ‰å„è‡ªçš„ ChannelPipelineï¼Œæ–°å»º Channel æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œä½¿ç”¨ ChannelPipeline æ·»åŠ æˆ–åˆ é™¤ ChannelHandler æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ChannelPipeline çš„å­æ¥å£æœ‰ ChannelInboundHandler å’Œ ChannelOutboundHandlerï¼Œåˆ†åˆ«ç”¨äº EventLoop å¤„ç†å…¥ç«™äº‹ä»¶å’Œå‡ºç«™äº‹ä»¶ã€‚\nChannelPipeline å®ç°äº† Intercepting Filter æ¨¡å¼çš„é«˜çº§å½¢å¼ï¼Œæ‰€è°“ Filter æ¨¡å¼ï¼Œå¸¸å¸¸è¢«è®¤ä¸ºå±äºè´£ä»»é“¾æ¨¡å¼ï¼Œæ¯”å¦‚ Servlet çš„è¯·æ±‚è¿‡æ»¤å™¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public class CustomFilter implements Filter { public void doFilter( ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException { // process the request // pass the request (i.e. the command) along the filter chain chain.doFilter(request, response); } } ä¸€ä¸ª Filter å¯ä»¥æ‹¦æˆªè¯·æ±‚ï¼Œä¹Ÿå¯ä»¥è½¬å‘è¯·æ±‚ç»™ä¸‹ä¸€ä¸ª Filterã€‚ä¸ºäº†å¸®åŠ©ç†è§£ï¼ŒHandlerChain æ¼”ç¤ºäº†åŸºäºé“¾è¡¨å’Œå¤šæ€çš„è´£ä»»é“¾æ¨¡å¼ã€‚\nå¯¹äº DefaultChannelPipeline æ¥è¯´ï¼Œå…¶é“¾è¡¨é€šå¸¸æœ‰ä¸€ä¸ªç‰¹åˆ«çš„å¤´ï¼ˆHeadContextï¼‰å’Œå°¾ï¼ˆTailContextï¼‰ï¼Œå®é™…ä¸Šç»“ç‚¹æ˜¯åŒ…è£…äº† ChannelHandler çš„ ChannelHandlerContextã€‚ChannelHandlerContext å®šä¹‰äº†äº‹ä»¶ä¼ æ’­æ–¹æ³•ï¼ˆevent propagation methodï¼‰ï¼Œä¾‹å¦‚ ChannelHandlerContext.fireChannelRead(Object) å’Œ ChannelOutboundInvoker.write(Object)ï¼Œäº‹ä»¶åœ¨ ChannelPipeline ä¸­æµåŠ¨ã€‚\nä»¥ Channel è¯»å°±ç»ªä¸ºä¾‹ï¼Œå®ƒå±äºå…¥ç«™äº‹ä»¶ï¼Œè¾“å…¥çš„æ•°æ®ä¹Ÿåœ¨ ChannelPipeline ä¸­æµåŠ¨ã€‚\nè‹¥ä»¥æœåŠ¡å™¨ç«¯æ¥å—è¯·æ±‚å’Œå‘é€å“åº”ä¸ºä¾‹ï¼Œå‡è®¾ RequestDecoder å’Œ BussinessHandler éƒ½ç»§æ‰¿äº† ChannelInboundHandlerAdapterï¼ŒResponseEncoder ç»§æ‰¿äº† ChannelOutboundHandlerAdapterã€‚\n1 2 3 4 ChannelPipeline pipeline = channel.pipeline(); pipeline.addLast(new RequestDecoder()); pipeline.addLast(new ResponseEncoder()); pipeline.addLast(new BussinessHandler()); ï¼ˆ1ï¼‰æ¥å—è¯·æ±‚ã€‚\n1 -\u0026gt; RequestDecoderï¼ˆè§£ç ï¼‰-\u0026gt; ResponseEncoderï¼ˆéè§¦å‘ï¼‰-\u0026gt; BussinessHandlerï¼ˆå¤„ç†ï¼‰-\u0026gt; ï¼ˆ2ï¼‰ä¸šåŠ¡é€»è¾‘ã€‚\nå‡è®¾å¤„ç†å®Œæˆåè°ƒç”¨ ChannelOutboundInvoker.writeAndFlush(Object) æ¥å†™å›å¤æ¶ˆæ¯ã€‚\nï¼ˆ3ï¼‰å‘é€å“åº”ã€‚\n1 -\u0026gt; BussinessHandlerï¼ˆå†™æ¶ˆæ¯ï¼‰-\u0026gt; ResponseEncoderï¼ˆç¼–ç ï¼‰-\u0026gt; RequestDecoderï¼ˆéè§¦å‘ï¼‰-\u0026gt; æœ€å°åŒ–å†…å­˜å¤åˆ¶ Netty ä½¿ç”¨å®ƒè‡ªå·±çš„ buffer API ä»£æ›¿ Java NIO çš„ ByteBuffer æ¥è¡¨ç¤ºå­—èŠ‚åºåˆ—ã€‚Netty æ–°çš„ç¼“å†²åŒºç±»å‹ï¼Œåä¸º ByteBufï¼Œå®ƒå…·æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š\næ‚¨å¯ä»¥æ ¹æ®éœ€è¦å®šä¹‰ç¼“å†²åŒºç±»å‹ã€‚ é€æ˜çš„é›¶å¤åˆ¶æ˜¯é€šè¿‡å†…ç½®çš„èšåˆç¼“å†²åŒºç±»å‹å®ç°çš„ã€‚ å¼€ç®±å³æœ‰ï¼ŒåŠ¨æ€æ‰©å®¹ã€‚ ä¸éœ€è¦è°ƒç”¨ flip() äº†ã€‚ å®ƒé€šå¸¸æ¯” ByteBuffer å¿«ã€‚ æ³¨æ„ï¼Œä¸Šé¢çš„é›¶å¤åˆ¶å¹¶ä¸æ˜¯æ“ä½œç³»ç»Ÿçº§é›¶å¤åˆ¶ï¼Œæ“ä½œç³»ç»Ÿçº§é›¶å¤åˆ¶æ˜¯æŒ‡ CPU ä¸æ‰§è¡Œå°†æ•°æ®ä»ä¸€ä¸ªå­˜å‚¨åŒºåŸŸå¤åˆ¶åˆ°å¦ä¸€ä¸ªå­˜å‚¨åŒºåŸŸçš„ä»»åŠ¡ï¼Œè¯¦æƒ…è§ zero-copyã€‚å¦‚æœ \u0008I/O è®¾å¤‡æ”¯æŒ DMA çš„ scatter-gather æ“ä½œï¼Œé‚£ä¹ˆ Java NIO æä¾›æ“ä½œç³»ç»Ÿçº§é›¶å¤åˆ¶æ–¹æ³•æ˜¯ transferToã€‚\nèšåˆç¼“å†²åŒºç±»å‹æ˜¯æŒ‡ CompositeByteBufã€‚\nå‡è®¾æœ‰ä¸¤ä¸ªå­—èŠ‚æ•°ç»„ï¼Œheader å’Œ bodyï¼Œåœ¨æ¨¡å—åŒ–ç³»ç»Ÿä¸­ï¼Œè¿™ä¸¤ä¸ªå­—èŠ‚æ•°ç»„å¯ä»¥ç”±ä¸åŒçš„æ¨¡å—ç”Ÿäº§ï¼Œç„¶ååœ¨æ¶ˆæ¯å‘é€åèšåˆã€‚å¦‚æœç”¨ Java NIO çš„ ByteBuffer æ¥èšåˆä¸¤ä¸ªå­—èŠ‚æ•°ç»„ï¼Œä¸€èˆ¬äººå¯èƒ½è€ƒè™‘æ–°å»ºä¸€ä¸ªç¼“å†²åŒºæ•°ç»„å¹¶æŒæœ‰ä¸¤ä¸ªå­—èŠ‚æ•°ç»„ï¼Œæˆ–è€…æ–°å»ºä¸€ä¸ªç¼“å†²åŒºå¹¶æ’å…¥ä¸¤ä¸ªå­—èŠ‚æ•°ç»„ã€‚\n1 2 // Use an array to composite them ByteBuffer[] message = new ByteBuffer[] { header, body }; 1 2 3 4 5 // Use copy to merge both ByteBuffer message2 = ByteBuffer.allocate(header.remaining() + body.remaining()); message.put(header); message.put(body); message.flip(); ä»¥ä¸Šä¸¤ç§æ–¹å¼ä¸ä»…æœ‰å†…å­˜å¤åˆ¶çš„æˆæœ¬ï¼Œè€Œä¸”ç¬¬ä¸€ç§æ–¹å¼è¿˜å¼•å…¥äº†ä¸å…¼å®¹æˆ–å¤æ‚çš„ç¼“å†²åŒºæ•°ç»„ç±»å‹ã€‚\n1 2 3 4 5 6 // The composite type is incompatible with the component type. ByteBuf message = Unpooled.wrappedBuffer(header, body); // Therefore, you can even create a composite by mixing a composite and an // ordinary buffer. ByteBuf messageWithFooter = Unpooled.wrappedBuffer(message, footer); å¦‚æœä½¿ç”¨ Netty çš„ ByteBuf å®ç°ï¼Œåˆ™å†…å­˜å¤åˆ¶æ¬¡æ•°å‡ ä¹ä¸ºé›¶ï¼Œå› ä¸ºç¼“å†²åŒºå¼•ç”¨äº†ä¸¤ä¸ªæˆ–å¤šä¸ªæ•°ç»„ï¼ˆæŒ‡é’ˆï¼‰ã€‚\n1 2 3 4 CompositeByteBuf compBuf = Unpooled.compositeBuffer(); ByteBuf headerBuf = ...; // can be backing or direct ByteBuf bodyBuf = ...; // can be backing or direct compBuf.addComponent(headerBuf, bodyBuf); åŒç†ï¼Œèšåˆä¸¤ä¸ªç¼“å†²åŒºï¼Œä½¿ç”¨æŒ‡é’ˆè€Œä¸æ˜¯ä»åŸç¼“å†²åŒºå¤åˆ¶ã€‚\n1 2 ByteBuf buf = Unpooled.copiedBuffer(\u0026#34;Hello, World!\u0026#34;, StandardCharsets.UTF_8); ByteBuf sliced = buf.slice(0, 14); åŒç†ï¼Œç¼“å†²åŒºçš„åˆ‡ç‰‡ï¼Œè¿”å›çš„åˆ‡ç‰‡å¼•ç”¨äº†åŸç¼“å†²åŒºçš„å­æ•°ç»„ã€‚\nä¸ºä»€ä¹ˆé«˜æ€§èƒ½ ä¸ºä»€ä¹ˆ Netty ååé‡æ›´é«˜ã€å»¶è¿Ÿæ›´ä½ã€èµ„æºæ¶ˆè€—æ›´å°‘ï¼Ÿæ¯”å¦‚ RxNetty vs Tomcat å’Œ ä¸ƒç§ WebSocket æ¡†æ¶çš„æ€§èƒ½æ¯”è¾ƒã€‚\nä½¿ç”¨ Java NIO å’Œ Reactor æ¨¡å¼ã€‚ä¸ºä»€ä¹ˆ Java NIO é«˜æ•ˆï¼Œä¸Šæ–‡çš„è§£é‡Šæ˜¯â€œä»¥é˜»å¡æ—¶é—´æ¢å·¥ä½œæ—¶é—´â€ï¼Œä¸‹æ–‡å°†è¡¥å……æ“ä½œç³»ç»Ÿå±‚è§£é‡Šï¼›ä¸ºä»€ä¹ˆè¯´ Netty ä½¿ç”¨äº† Reactor æ¨¡å¼ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªçº¿ç´¢ï¼ŒNetty ä¸­çš„ ServerBootstrap çš„ group æ–¹æ³•æœ‰ä¸¤ä¸ªç±»å‹å‡ä¸º EventLoopGroup çš„å‚æ•°ï¼Œå›æƒ³ä¸€ä¸‹ä¸Šæ–‡â€œReactor å¤šçº¿ç¨‹ç‰ˆâ€ æœ€åä¸€å¼ å›¾ã€‚\nGC ä¼˜åŒ–ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ç¼“å†²åŒºå¯¹è±¡æ± ï¼Œå¤ç”¨ç¼“å†²åŒºå¯¹è±¡å‡å°‘äº†é¢‘ç¹æ–°å»ºå¯¹è±¡å’Œæ”¶é›†åƒåœ¾å¼•èµ·çš„å»¶è¿Ÿï¼Œä¸”ä½¿ç”¨ç›´æ¥ç¼“å†²åŒºï¼Œè¯¦æƒ…è§ Netty 4 at Twitter: Reduced GC Overhead å’Œ PooledByteBufAllocator.javaã€‚\nå‡å°‘ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶ã€‚å¦‚ä¸Šæ–‡æ‰€è¯´ã€‚\n\u0026hellip;\u0026hellip;\nåº”ç”¨ç¨‹åºä¼˜åŒ– S0 ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘ã€‚\nS1 é¿å…é˜»å¡ bossGroup/parentGroup å’Œ workerGroup/childGroup ä¸­çš„çº¿ç¨‹ã€‚æ‰§è¡Œè€—æ—¶ä»»åŠ¡ï¼ˆå¦‚è®¿é—®æ•°æ®åº“ï¼‰ï¼Œè€ƒè™‘æ–°å»ºç»™å®šçº¿ç¨‹æ•°çš„ EventLoopGroup å¯¹è±¡ï¼Œæ·»åŠ å®ƒå’Œä¸šåŠ¡é€»è¾‘çš„ ChannelHandler åˆ° ChannelPipelineã€‚\nS2 å¤ç”¨ ByteBuf å¯¹è±¡ï¼Œå‡å°‘ GC å¼•èµ·çš„å»¶è¿Ÿã€‚\nByteBuf is a reference-counted object which has to be released explicitly via the release() method. Please keep in mind that it is the handler\u0026rsquo;s responsibility to release any reference-counted object passed to the handler\nS2.1 ä½¿ç”¨ release()ï¼Œå›æ”¶å¯¹è±¡åå°†éšå¼å¤ç”¨å¯¹è±¡ã€‚\n1 2 3 4 5 @Override public void channelRead(ChannelHandlerContext ctx, Object msg) { // Do something with msg ((ByteBuf) msg).release(); } 1 2 3 4 5 6 7 8 @Override public void channelRead(ChannelHandlerContext ctx, Object msg) { try { // Do something with msg } finally { ReferenceCountUtil.release(msg); } } 1 2 3 4 5 6 @Override public void channelRead(ChannelHandlerContext ctx, Object msg) { // Do something with msg ctx.write(msg); ctx.flush(); } It is because Netty releases it for you when it is written out to the wire.\nS2.2 ç»§æ‰¿ SimpleChannelInboundHandlerã€‚\nBe aware that depending of the constructor parameters it will release all handled messages by passing them to ReferenceCountUtil.release(Object). In this case you may need to use ReferenceCountUtil.retain(Object) if you pass the object to the next handler in the ChannelPipeline.\nS2.3 ä½¿ç”¨äº‹ä»¶ä¼ æ’­æ–¹æ³•ï¼Œè½¬å‘ç»™å…¶å®ƒç»“ç‚¹é‡Šæ”¾ã€‚\nA1 ChannelOption é…ç½®æˆ–å‚æ•°è°ƒä¼˜ï¼Œä¾‹å¦‚è°ƒæ•´ TCP å‘é€/æ¥æ”¶ç¼“å†²åŒºï¼ˆTCP Send/Receive Buffersï¼‰çš„å¤§å°ï¼š\n1 2 3 4 5 6 7 ServerBootstrap bootstrap = new ServerBootstrap() .channel(EpollServerSocketChannel.class) .group(bossGroup, workerGroup) .handler(new LoggingHandler(LogLevel.INFO)) .childHandler(new CustomChannelInitializer()) .childOption(ChannelOption.SO_SNDBUF, 1024 * 1024) .childOption(ChannelOption.SO_RCVBUF, 32 * 1024); A2 å¤ç”¨è‡ªå®šä¹‰çš„ ChannelHandler å¯¹è±¡ã€‚ä½¿ç”¨ @ChannelHandler.Sharableï¼Œä½†è¦æ³¨æ„æ˜¯å¦å­˜åœ¨å¤šçº¿ç¨‹è®¿é—®å…±äº«å˜é‡çš„å®‰å…¨é—®é¢˜ã€‚\nI/O æ¨¡å‹ ç»å…¸çš„ ã€ŠUNIX Network Programmingã€‹å·²ç»å®Œç¾è¯ é‡Šäº†äº”ç§ I/O æ¨¡å‹ã€‚\nblocking I/O nonblocking I/O I/O multiplexing (select and poll and epoll) signal driven I/O (SIGIO) asynchronous I/O (the POSIX aio_ functions) ç›®å‰æ¥è¯´ï¼Œsignal driven I/O å’Œ asynchronous I/O åœ¨ Linux çš„åº”ç”¨è¾ƒä¸ºç½•è§ï¼Œå› æ­¤æœ¬æ–‡åªå…³æ³¨å‰ä¸‰ç§ã€‚\nå›æƒ³å¼€å¤´æ‰€è¯´çš„ I/O çš„æœ¬è´¨ï¼Œä½†åˆ«å¿˜äº†æ“ä½œç³»ç»Ÿæ˜¯åº”ç”¨ç¨‹åºå’Œç¡¬ä»¶çš„ä¸­é—´å±‚ã€‚\nè¾“å…¥æ˜¯ä» I/O è®¾å¤‡å¤åˆ¶å­—èŠ‚åºåˆ—åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶å­—èŠ‚åºåˆ—åˆ°è¿›ç¨‹ç¼“å†²åŒºã€‚\nè¾“å‡ºæ˜¯ä»è¿›ç¨‹ç¼“å†²åŒºå¤åˆ¶å­—èŠ‚åºåˆ—åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶å­—èŠ‚åºåˆ—åˆ° I/O è®¾å¤‡ã€‚\nblocking I/O \u0026amp; nonblocking I/O ä»¥è¯» Socket ä¸ºä¾‹ï¼Œçº¿ç¨‹è°ƒç”¨ recvfrom å‡½æ•°å¹¶ä¼ é€’ç›®æ ‡ Socket æ–‡ä»¶æè¿°ç¬¦ï¼Œè¯¥çº¿ç¨‹è¢«é˜»å¡åœ¨è¯¥å‡½æ•°ï¼Œå½“ç›®æ ‡ Socket è¯»å°±ç»ªï¼Œå†…æ ¸å¤åˆ¶æ•°æ®æŠ¥ï¼Œå¤åˆ¶å®Œæˆåè¯¥å‡½æ•°è¿”å› OKï¼Œè¯¥çº¿ç¨‹é€€å‡ºè¯¥å‡½æ•°å¹¶æ‰§è¡Œåç»­è¯­å¥ã€‚\nä»ä»¥è¯» Socket ä¸ºä¾‹ï¼Œçº¿ç¨‹è°ƒç”¨ recvfrom å‡½æ•°å¹¶ä¼ é€’ç›®æ ‡ Socket æ–‡ä»¶æè¿°ç¬¦ï¼Œè¯¥çº¿ç¨‹æ²¡è¢«é˜»å¡åœ¨è¯¥å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›é”™è¯¯ç ï¼Œè¡¨ç¤ºç›®æ ‡ Socket éè¯»å°±ç»ªï¼Œçº¿ç¨‹é‡å¤è°ƒç”¨è¯¥å‡½æ•°ï¼ˆè½®è¯¢ï¼‰ï¼Œå½“ç›®æ ‡ Socket è¯»å°±ç»ªï¼Œè¯¥çº¿ç¨‹è¢«é˜»å¡åœ¨è¯¥å‡½æ•°ï¼Œå†…æ ¸å¤åˆ¶æ•°æ®æŠ¥ï¼Œå¤åˆ¶å®Œæˆåè¯¥å‡½æ•°è¿”å› OKï¼Œè¯¥çº¿ç¨‹é€€å‡ºè¯¥å‡½æ•°å¹¶æ‰§è¡Œåç»­è¯­å¥ã€‚\næ³¨æ„ï¼Œblocking I/O æ¨¡å‹å’Œ nonblocking I/O æ¨¡å‹éƒ½å‡ºç°äº†çº¿ç¨‹è¢«é˜»å¡åœ¨å‡½æ•°çš„ç°è±¡ã€‚\næœ€åä»¥å…ˆè¯» Socket åå†™ Socket ä¸ºä¾‹ï¼Œä¸‹é¢è¿™å¼ æ¥è‡ª Shawn Xu çš„æ–‡ç« ï¼ˆæ–‡æœ«æœ‰é“¾æ¥ï¼‰çš„å›¾è¯¦ç»†æè¿°äº† Java BIO çš„åº•å±‚è¡Œä¸ºã€‚\næ³¨æ„ï¼ŒJVM å‘èµ· 2 æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸æ‰§è¡Œ 2 æ¬¡æ•°æ®å¤åˆ¶ã€‚\nI/O multiplexing ç»§ç»­ä»¥è¯» Socket ä¸ºä¾‹ï¼Œçº¿ç¨‹åœ¨è°ƒç”¨ recvfrom å‡½æ•°å‰ï¼Œå…ˆè°ƒç”¨ select å‡½æ•°å¹¶ä¼ é€’ç›®æ ‡ Socket æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨ï¼Œè¯¥çº¿ç¨‹è¢«é˜»å¡åœ¨ select å‡½æ•°ï¼Œç›´åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªç›®æ ‡ Socket è¯»å°±ç»ªï¼Œå†…æ ¸å¯¹åˆ—è¡¨ä¸­å¯è¯»çš„ Socket æ–‡ä»¶æè¿°ç¬¦åšäº†æ ‡è®°ï¼Œç„¶å select å‡½æ•°è¿”å›ï¼Œçº¿ç¨‹æ‰§è¡Œå¾ªç¯è¯­å¥éå†è¿™ä¸ªåˆ—è¡¨ï¼ŒæŸ¥æ‰¾å·²æ ‡è®°çš„ Socket æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¯å‘½ä¸­ä¸€ä¸ª Socket æ–‡ä»¶æè¿°ç¬¦å°±è°ƒç”¨ recvfrom å‡½æ•°å¹¶ä¼ é€’ Socket æ–‡ä»¶æè¿°ç¬¦ï¼Œè¯¥çº¿ç¨‹è¢«é˜»å¡åœ¨ recvfrom å‡½æ•°ï¼Œå½“ç›®æ ‡ Socket è¯»å°±ç»ªï¼Œå†…æ ¸å¤åˆ¶æ•°æ®æŠ¥ï¼Œå¤åˆ¶å®Œæˆåè¯¥å‡½æ•°è¿”å› OKï¼Œè¯¥çº¿ç¨‹é€€å‡ºè¯¥å‡½æ•°å¹¶ç»§ç»­æ‰§è¡Œå¾ªç¯è¯­å¥ã€‚select å‡½æ•°çš„å®ç°ç»†èŠ‚æœ‰æ˜æ˜¾å¯ä¼˜åŒ–çš„åœ°æ–¹ï¼Œæ¯”å¦‚ï¼Œå†…æ ¸åªéœ€å›å¤ä¸€ä¸ªåªå­˜å‚¨å°±ç»ªçš„ Socket æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨ï¼Œå¯èŠ‚çœé¡ºåºæŸ¥æ‰¾çš„å¼€é”€ã€‚\nè™½ç„¶ä»¥ä¸Šä¸‰ç§ I/O æ¨¡å‹å‡å‡ºç°äº†çº¿ç¨‹è¢«é˜»å¡åœ¨å‡½æ•°çš„ç°è±¡ï¼Œä½†æ˜¯ I/O multiplexing æ¨¡å‹çš„ä¼˜åŠ¿åœ¨äºå•ä¸€çº¿ç¨‹åœ¨ç›¸åŒæ—¶é—´å†…èƒ½å¤Ÿå¤„ç†æ›´å¤šçš„è¿æ¥æˆ–è¯·æ±‚ï¼ŒåŒæ—¶ç»„åˆå¤šçº¿ç¨‹æ¨¡å‹ï¼Œä¾‹å¦‚ Reactor æ¨¡å¼ï¼Œæ‰€ä»¥æ‰è¯´ï¼Œä¸€ä¸ªåŸºäº I/O multiplexing çš„ Java NIO æœåŠ¡å™¨ç«¯åº”å¯¹è´Ÿè½½å¢åŠ çš„èƒ½åŠ›é€šå¸¸é«˜äºä¸€ä¸ª Java BIO æœåŠ¡å™¨ç«¯ã€‚\nåŸç”Ÿä¼ è¾“ æ—©åœ¨ JDK 6 å°±å·²ç»åŒ…æ‹¬äº†åŸºäº Linux epoll å…¨æ–°çš„ SelectorProviderï¼Œå½“æ£€æµ‹åˆ°å†…æ ¸ 2.6 ä»¥åŠæ›´é«˜ç‰ˆæœ¬æ—¶ï¼Œé»˜è®¤ä½¿ç”¨åŸºäº epoll çš„å®ç°ï¼Œå½“æ£€æµ‹åˆ° 2.6 ä¹‹å‰çš„å†…æ ¸ç‰ˆæœ¬æ—¶ï¼Œå°†ä½¿ç”¨åŸºäº poll çš„å®ç°ã€‚\nNetty åˆ™æä¾›äº†ç‰¹åˆ«çš„ JNI ä¼ è¾“ï¼Œä¸åŸºäº NIO çš„ä¼ è¾“ç›¸æ¯”ï¼Œäº§ç”Ÿæ›´å°‘çš„åƒåœ¾ï¼Œé€šå¸¸å¯ä»¥æé«˜æ€§èƒ½ã€‚\nNioEventLoopGroup â†’ EpollEventLoopGroup NioEventLoop â†’ EpollEventLoop NioServerSocketChannel â†’ EpollServerSocketChannel NioSocketChannel â†’ EpollSocketChannel è¯¦æƒ…è¯·è§ Netty # Native transportsã€‚\næ–‡ä¸­ä»£ç  å·²å‘å¸ƒï¼Œè¯·ç§»æ­¥ networkã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\næ›´å¤šç»éªŒ Scalable IO in Java - Doug Lea\nJava NIO trick and trap\nItâ€™s all about buffers: zero-copy, mmap and Java NIO\nBuild Your Own Netty â€” Reactor Pattern\nReactor pattern - Wikipedia\nEvent (computing) - Wikipedia\nNetty in Action # Chapter 7. EventLoop and threading model\nNetty in Action # Chapter 6. ChannelHandler and ChannelPipeline\nNetty in Action # Chapter 5. ByteBuf\nChain-of-responsibility pattern - Wikipedia\nChain of Responsibility Design Pattern in Java\nHigh Performance JVM Networking with Netty - Speaker Deck\nNetty # Wiki # Reference counted objects\nPrinciples to Handle Thousands of Connections in Java Using Netty\nOracle # Enhancements in Java I/O\nUNP # Chapter 6. I/O Multiplexing: The select and poll Functions\n6.2 I/O Models - MASTERRAGHU\nä¸€æ–‡è¯»æ‡‚é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹ä¸­çš„I/Oæ¨¡å‹\nselectã€pollã€epollä¹‹é—´çš„åŒºåˆ«æ€»ç»“[æ•´ç†]\nJava Tutorials # Basic I/O\nJava Tutorials # Custom Networking\nVert.x # Guide\n","date":"2020-03-08T11:07:41+08:00","permalink":"https://h2cone.github.io/2020/03/08/network_nio/","title":"ç½‘ç»œÂ·NIO"},{"content":"è¿›ç¨‹ä¸çº¿ç¨‹ ç°ä»£çš„è®¡ç®—æœºç³»ç»Ÿæä¾›äº†è®¸å¤šæ¼‚äº®çš„æŠ½è±¡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå…¶ä¸­ï¼Œè¿›ç¨‹æ˜¯å¯¹å¤„ç†å™¨ã€ä¸»å­˜å’Œ I/O è®¾å¤‡çš„æŠ½è±¡ï¼Œæ¢è¨€ä¹‹ï¼Œè¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿå¯¹ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åºçš„ä¸€ç§æŠ½è±¡ã€‚æ“ä½œç³»ç»Ÿä¸Šå¯ä»¥â€œåŒæ—¶â€è¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼Œå·²ç»å¯¹ä¸€è¾¹å¬æ­Œä¸€è¾¹å†™ä»£ç å’Œæ¥æ”¶æ¶ˆæ¯çš„æµç•…ä¸è¶³ä¸ºå¥‡ï¼Œä¹‹æ‰€ä»¥ç”¨åŒå¼•å·ï¼Œå› ä¸ºè¿™å¯èƒ½æ˜¯ä¸€ç§å‡è±¡ã€‚\nå¤§å¤šæ•°è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œéœ€è¦è¿è¡Œçš„è¿›ç¨‹æ•°æ˜¯å¤šäºå¯ä»¥è¿è¡Œå®ƒä»¬çš„ CPU ä¸ªæ•°çš„ï¼Œé‚£ä¹ˆæ‰€è°“çš„â€åŒæ—¶â€œè¿è¡Œï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯æ¨¡æ‹Ÿå¹¶å‘çš„å‡è±¡ï¼›ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªè¿›ç¨‹çš„æŒ‡ä»¤å’Œå¦ä¸€ä¸ªè¿›ç¨‹çš„æŒ‡ä»¤æ˜¯è¢« CPU äº¤é”™æ‰§è¡Œçš„ï¼Œè€Œä¸” CPU åœ¨è¿›ç¨‹é—´åˆ‡æ¢è¶³å¤Ÿå¿«ï¼Œè¿›ç¨‹â€œæš‚åœâ€å’Œâ€œæ¢å¤â€çš„é—´éš”ä¹Ÿè¶³å¤ŸçŸ­ï¼Œæ¯ä¸ªè¿›ç¨‹çœ‹ä¸Šå»åƒæ˜¯è¿ç»­è¿è¡Œã€‚é™¤éæœ‰å¤šä¸ª CPU æˆ–å¤šå¤„ç†å™¨çš„è®¡ç®—æœºç³»ç»Ÿï¼Œæ‰èƒ½æ”¯æŒå¤šè¿›ç¨‹å¹¶è¡Œï¼Œå³å¤„ç†å™¨åŒæ—¶æ‰§è¡Œå¤šä¸ªç¨‹åºçš„æŒ‡ä»¤ã€‚\nä¸€ä¸ªè¿›ç¨‹ç”¨å®Œäº†æ“ä½œç³»ç»Ÿåˆ†é…ç»™å®ƒçš„æ—¶é—´ç‰‡ï¼Œæ“ä½œç³»ç»Ÿå†³å®šæŠŠæ§åˆ¶æƒè½¬ç§»ç»™æ–°çš„è¿›ç¨‹ï¼Œå°±ä¼šè¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆcontext switchï¼‰ï¼Œå³ä¿å­˜å½“å‰è¿›ç¨‹çš„çŠ¶æ€ï¼Œæ¢å¤ç›®æ ‡è¿›ç¨‹çš„çŠ¶æ€ï¼Œäº¤æ¥æ§åˆ¶æƒã€‚è¿™ç§çŠ¶æ€è¢«ç§°ä¸ºä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰ï¼Œæ¯”å¦‚ç¨‹åºè®¡æ•°å™¨å’Œå¯„å­˜å™¨çš„å½“å‰å€¼ä»¥åŠä¸»å­˜çš„å†…å®¹ã€‚\nä¸€ä¸ªè¿›ç¨‹å¯ä»¥å­˜åœ¨å¤šä¸ªæ§åˆ¶æµï¼ˆcontrol flowï¼‰ï¼Œå®ƒä»¬è¢«ç§°ä¸ºçº¿ç¨‹ã€‚å¦‚æ¥è‡ªç»´åŸºç™¾ç§‘çº¿ç¨‹è¯æ¡çš„æ’å›¾æ‰€ç¤ºï¼š\nå› ä¸ºåªæœ‰å•å¤„ç†å™¨ï¼Œæ‰€ä»¥è¿™ä¸ªè¿›ç¨‹çš„ä¸¤ä¸ªçº¿ç¨‹è½®ç•ªè¿è¡Œåœ¨è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼ˆæ¨¡æ‹Ÿå¹¶å‘ï¼‰ã€‚æ“ä½œç³»ç»Ÿä¸ä»…è°ƒåº¦è¿›ç¨‹ï¼Œæ•™ç§‘ä¹¦å¸¸è¯´ï¼Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦çš„æœ€å°å•ä½ã€‚å¤§å¤šæ•°è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œéœ€è¦è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äºå¯ä»¥è¿è¡Œå®ƒä»¬çš„ CPU æ ¸æ•°ï¼Œä»å•çº¿ç¨‹è¿›ç¨‹æ¨å¹¿åˆ°å¤šçº¿ç¨‹è¿›ç¨‹çš„çº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹æ—¶é—´åˆ°äº†ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå®ƒè¢«â€œæš‚åœâ€äº†ï¼Œè½®åˆ°äº†å¦ä¸€ä¸ªçº¿ç¨‹è¿è¡Œï¼Œç¨åè½®åˆ°å®ƒæ—¶åˆâ€œæ¢å¤â€äº†ã€‚\nå¤šçº¿ç¨‹ç¨‹åºååˆ†æ™®éã€‚ç”µè„‘å’Œæ‰‹æœºåº”ç”¨ç¨‹åºåœ¨ç”¨æˆ·ç•Œé¢æ¸²æŸ“åŠ¨ç”»ï¼ŒåŒæ—¶åœ¨åå°æ‰§è¡Œè®¡ç®—å’Œç½‘ç»œè¯·æ±‚ã€‚ä¸€ä¸ª Web æœåŠ¡å™¨ä¸€æ¬¡å¤„ç†æ•°åƒä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚å¤šçº¿ç¨‹ä¸‹è½½ã€å¤šçº¿ç¨‹çˆ¬è™«ã€å¤šçº¿ç¨‹éå†æ–‡ä»¶æ ‘\u0026hellip;\u0026hellip;å¤šçº¿ç¨‹æˆä¸ºè¶Šæ¥è¶Šé‡è¦çš„æ¨¡å‹ï¼Œå› ä¸ºå¤šçº¿ç¨‹ç¨‹åºæœ‰ä¸å°‘ä¼˜ç‚¹ã€‚\nå¤šçº¿ç¨‹ä¹‹é—´æ¯”å¤šè¿›ç¨‹ä¹‹é—´æ›´å®¹æ˜“å…±äº«æ•°æ®å’Œé€šä¿¡ã€‚åŒä¸€ä¸ªè¿›ç¨‹çš„å¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„èµ„æºï¼Œæ¯”å¦‚è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„ç¨‹åºä»£ç å’Œç¨‹åºå¤„ç†çš„æ•°æ®ä»¥åŠæ–‡ä»¶ï¼Œå¯¹äºåŒä¸€è¿›ç¨‹çš„çº¿ç¨‹ä»¬æ¥è¯´ï¼Œå¯æ‰§è¡Œä»£ç åªæœ‰ä¸€å¥—ï¼Œå®ƒä»¬å¯ä»¥è®¿é—®å­˜å‚¨åœ¨å † (Heap) ä¸­çš„å…±äº«å˜é‡æˆ–å…¨å±€å˜é‡ï¼Œä½†æ˜¯ï¼Œæ ˆï¼ˆStackï¼‰ã€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counterï¼‰åœ¨å†…çš„å¯„å­˜å™¨ï¼ˆRegisterï¼‰å‰¯æœ¬ã€çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆThread Local Storageï¼‰éƒ½æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚ä¸ä»…å¦‚æ­¤ï¼Œçº¿ç¨‹ä¹‹é—´å¯ä»¥é€šè¿‡å…±äº«çš„ä»£ç ã€æ•°æ®ã€æ–‡ä»¶è¿›è¡Œé€šä¿¡ï¼Œç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ¯”è¿›ç¨‹é—´çš„é€šä¿¡æ›´é«˜æ•ˆã€‚\nå¤šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ›´å¤šæˆ–æ›´å¿«ã€‚å¦‚æœä¸»çº¿ç¨‹é˜»å¡åœ¨è€—æ—¶ä»»åŠ¡ï¼Œæ•´ä¸ªç¨‹åºå¯èƒ½ä¼šå¡é¡¿æˆ–é•¿æ—¶é—´æ— å“åº”ï¼Œè§£å†³åŠæ³•ä¹‹ä¸€ä¾¿æ˜¯æ–°å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ä¸“é—¨æ‰§è¡Œè¿™ä¸ªè€—æ—¶ä»»åŠ¡ï¼Œè€Œä¸»çº¿ç¨‹åˆ™ç»§ç»­æ‰§è¡Œå…¶å®ƒä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œå‰é¢æåˆ°çš„æ‰‹æœº APPï¼ˆç‰¹åˆ«æ˜¯ Android APPï¼‰ï¼ŒUI çº¿ç¨‹è¢«é˜»å¡åå¾ˆæœ‰å¯èƒ½æ— æ³•æ­£å¸¸äººæœºäº¤äº’äº†ï¼Œç”¨æˆ·ä½“éªŒæå·®ã€‚æ›´è¿›ä¸€æ­¥ï¼Œå•è¿›ç¨‹çš„å¤šçº¿ç¨‹ä¹‹é—´çš„åä½œæœ‰å¯èƒ½æé«˜ client-server ç³»ç»Ÿçš„æ€§èƒ½ï¼Œè­¬å¦‚å¼‚æ­¥è°ƒç”¨ç¼©çŸ­äº†è¯·æ±‚å“åº”æ—¶é—´ï¼ˆä¹Ÿè®¸æ€»å»¶è¿Ÿå‡ ä¹æ²¡å˜ï¼‰ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œè™½ç„¶ä¸€ä¸ªä¼ ç»Ÿçš„ CPU åªèƒ½äº¤é”™æ‰§è¡Œä¸€ä¸ªè¿›ç¨‹çš„å¤šä¸ªçº¿ç¨‹ï¼Œä½†éšç€å¤šæ ¸å¤„ç†å™¨å’Œè¶…çº¿ç¨‹ï¼ˆhyperthreadingï¼‰çš„æ™®åŠï¼Œé¢å¯¹å¤šä»»åŠ¡æˆ–å¤§ä»»åŠ¡çš„æ‰§è¡Œï¼Œå¤šçº¿ç¨‹ç¨‹åºçš„æ€§èƒ½ä¸Šé™å…·æœ‰æ›´é«˜çš„å¤©èŠ±æ¿ï¼Œå› ä¸ºå‡å°‘äº†æ‰§è¡Œå¤šä¸ªä»»åŠ¡éœ€è¦æ¨¡æ‹Ÿå¹¶å‘çš„å¼€é”€ï¼Œè¿˜å› ä¸ºå¤„ç†å™¨å¯ä»¥å¹¶è¡Œè¿è¡Œå¤šä¸ªçº¿ç¨‹ã€‚\nå¹¶å‘ä¸å¹¶è¡Œ å¹¶å‘ï¼ˆConcurrencyï¼‰å’Œå¹¶è¡Œï¼ˆParallelismï¼‰è¿™ä¸¤ä¸ªæœ¯è¯­ç»å¸¸æ··æ·†ï¼Œè¯­ä¹‰åº”å½“ç»“åˆè¯­å¢ƒã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡è®¾æœ‰ä¸¤ä¸ªä»»åŠ¡å’Œä¸¤ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªä»»åŠ¡åªèƒ½ç”±ä¸€çº¿ç¨‹æ‰§è¡Œä¸”ç”¨æ—¶åˆ†åˆ«æ˜¯ t1 å’Œ t2ï¼ˆt1 \u0026lt; t2ï¼‰ï¼Œä¸”çº¿ç¨‹éƒ½æ˜¯åŒæ—¶å¯åŠ¨ï¼Œé‚£ä¹ˆå„ä¸ªæ–¹å¼æ€»æ‰§è¡Œæ—¶é—´å¯èƒ½å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š\næ–¹å¼ æ€»æ‰§è¡Œæ—¶é—´ ä¸²è¡Œ t1 + t2 å¹¶è¡Œ t2 å•å¤„ç†å™¨å¹¶å‘ t1 + t2 + ä¸Šä¸‹æ–‡åˆ‡æ¢æ€»æ—¶é—´ ç”±æ­¤å¯è§ï¼Œå¦‚æœä¸Šä¸‹æ–‡åˆ‡æ¢çš„è€—æ—¶å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œå•å¤„ç†å™¨å¹¶å‘ä¸ä»…æ‰§è¡Œæ€»æ—¶é—´è¿‘ä¼¼äºä¸²è¡Œæ‰§è¡Œæ€»æ—¶é—´ï¼Œè¿˜æœ‰ä¸€ä¸ªä¼˜ç‚¹æ˜¯åŒæ—¶æ‰§è¡Œä¸¤ä¸ªä»»åŠ¡çš„å‡è±¡ã€‚å¹¶è¡Œçš„æ–¹å¼éå¸¸å¿«ï¼Œä½†ä¹Ÿå–å†³äºæœ€è€—æ—¶çš„ä»»åŠ¡ã€‚\nåœ¨å¤šå¤„ç†å™¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå¤šçº¿ç¨‹äº¤é”™æ‰§è¡Œæˆ–å¹¶è¡Œæ‰§è¡Œéƒ½æœ‰å¯èƒ½å‡ºç°ï¼Œä¸‹æ–‡å°†â€äº¤é”™æˆ–å¹¶è¡Œâ€œç»Ÿç§°ä¸ºâ€å¹¶å‘â€œã€‚\nJava å¤šçº¿ç¨‹ Java è¿›ç¨‹ ä»»ä½• Java åº”ç”¨ç¨‹åºéƒ½è·‘åœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œæ“ä½œç³»ç»Ÿä½œä¸ºç¡¬ä»¶å’Œåº”ç”¨ç¨‹åºçš„ä¸­é—´å±‚ï¼Œéšè—äº†ä¸‹å±‚å…·ä½“å®ç°çš„å¤æ‚æ€§ï¼Œå¹¶ç»™ä¸Šå±‚æä¾›äº†ç®€å•æˆ–ç»Ÿä¸€çš„æ¥å£ã€‚\næ­£åœ¨è¿è¡Œçš„ Java ç¨‹åºå°±æ˜¯ Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰ï¼Œè€Œè™šæ‹Ÿæœºæ˜¯å¯¹æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„æŠ½è±¡ï¼Œä½†å¯¹æ“ä½œç³»ç»Ÿæ¥è¯´ JVM ä»ç„¶æ˜¯è¿›ç¨‹ã€‚ä¸‹é¢è¿™å¼ æ¥è‡ª JVM Internals çš„å›¾å±•ç¤ºäº† Java SE 7 è™šæ‹Ÿæœºè¿è¡Œæ—¶çš„æ•°æ®åŒºåŸŸï¼ˆRun-Time Data Areasï¼‰ã€‚å›¾ä¸­çš„å †å’Œæ ˆç±»ä¼¼äº Linux/Unix æ“ä½œç³»ç»Ÿè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„å †å’Œæ ˆï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ Java 8 ç”¨å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰ä»£æ›¿äº†æ°¸ä¹…ä»£ï¼ˆPermGenï¼‰ã€‚JVM è¿è¡Œæ—¶çš„æ•°æ®åŒºåŸŸå¯åˆ†æˆä¸¤å¤§ç±»ï¼Œä¸€æ˜¯ Java çº¿ç¨‹å…±äº«åŒºåŸŸï¼ŒåŒ…æ‹¬å †å’Œæ–¹æ³•åŒºï¼›äºŒæ˜¯ Java çº¿ç¨‹ç§æœ‰åŒºåŸŸï¼ŒåŒ…æ‹¬æ ˆï¼Œè¯¦æƒ…è¯·è§ The Java Virtual Machine Specification, Java SE 8 Edition # 2.5. Run-Time Data Areasã€‚\nJava SE æœ€å¸¸ç”¨çš„è™šæ‹Ÿæœºæ˜¯ Oracle/Sun ç ”å‘çš„ Java HotSpot VMã€‚HotSpot åŸºæœ¬çš„çº¿ç¨‹æ¨¡å‹æ˜¯ Java çº¿ç¨‹ä¸åŸç”Ÿçº¿ç¨‹ï¼ˆnative threadï¼‰ä¹‹é—´ 1:1 çš„æ˜ å°„ã€‚çº¿ç¨‹é€šå¸¸åœ¨æ“ä½œç³»ç»Ÿå±‚å®ç°æˆ–åœ¨åº”ç”¨ç¨‹åºå±‚å®ç°ï¼Œå‰è€…çš„çº¿ç¨‹ç§°ä¸ºå†…æ ¸çº¿ç¨‹ï¼Œåè€…çš„çº¿ç¨‹å¯èƒ½ç§°ä¸ºç”¨æˆ·çº¿ç¨‹ã€‚å†…æ ¸ï¼ˆkernelï¼‰æ˜¯æ“ä½œç³»ç»Ÿä»£ç å¸¸é©»ä¸»å­˜çš„éƒ¨åˆ†ï¼Œè€Œæ‰€è°“ç”¨æˆ·ï¼Œå°±æ˜¯åº”ç”¨ç¨‹åºå’Œåº”ç”¨ç¨‹åºå¼€å‘è€…ã€‚\nå‰æ–‡æåˆ°ï¼Œå……åˆ†åˆ©ç”¨å¤šå¤„ç†å™¨èƒ½ä½¿å¤šçº¿ç¨‹ç¨‹åºè¿è¡Œå¾—æ›´å¿«ã€‚åœ¨æ“ä½œç³»ç»Ÿå±‚ï¼Œæ¶ˆè´¹å¤šå¤„ç†å™¨çš„æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£è°ƒåº¦æ‰€æœ‰å†…æ ¸çº¿ç¨‹ï¼ˆåŸç”Ÿçº¿ç¨‹ï¼‰å¹¶æ´¾é£åˆ°ä»»ä½•å¯ç”¨çš„ CPUï¼Œå› ä¸º Java çº¿ç¨‹ä¸å†…æ ¸çº¿ç¨‹ï¼ˆåŸç”Ÿçº¿ç¨‹ï¼‰æ˜¯ä¸€å¯¹ä¸€æ˜ å°„ï¼Œæ‰€ä»¥å……åˆ†åˆ©ç”¨å¤šå¤„ç†å™¨èƒ½å¢å¼º Java ç¨‹åºçš„æ€§èƒ½ã€‚\nå¯åŠ¨çº¿ç¨‹ å¯¹äº HotSpot VM æ¥è¯´ï¼ŒJava çº¿ç¨‹æ˜¯ java.lang.Thread çš„å®ä¾‹ã€‚Java ç”¨æˆ·å¯ä»¥ä½¿ç”¨ç±»ç»§æ‰¿ java.lang.Thread æ¥æ–°å»ºå’Œå¯åŠ¨ Java çº¿ç¨‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 public class HelloThread extends Thread { @Override public void run() { System.out.println(\u0026#34;Hello from a thread\u0026#34;); } public static void main(String[] args) { new HelloThread().start(); } } æˆ–è€…ä½¿ç”¨ç±»å®ç° java.lang.Runnable æ¥æ–°å»ºå’Œå¯åŠ¨çº¿ç¨‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 public class HelloRunnable implements Runnable { @Override public void run() { System.out.println(\u0026#34;Hello from a thread\u0026#34;); } public static void main(String[] args) { new Thread(new HelloRunnable()).start(); } } Java 8 ä»¥ä¸Šçš„ç”¨æˆ·ä¹Ÿè®¸æ›´å€¾å‘äºä½¿ç”¨åŒ¿åå†…éƒ¨ç±»å®ç° java.lang.Runnable æˆ– Lambda è¡¨è¾¾å¼ç®€åŒ–ä»¥ä¸Šä»£ç ï¼Œä½†éƒ½æ˜¯é€šè¿‡è°ƒç”¨ java.lang.Thread#start æ–¹æ³•æ¥å¯åŠ¨æ–°çº¿ç¨‹ï¼Œå¯¹åº”çš„åŸç”Ÿçº¿ç¨‹ï¼ˆå†…æ ¸çº¿ç¨‹ï¼‰åœ¨å¯åŠ¨ Java çº¿ç¨‹æ—¶åˆ›å»ºï¼Œå¹¶åœ¨ç»ˆæ­¢æ—¶å›æ”¶ã€‚å…¶ä¸­ï¼Œrun æ–¹æ³•æ˜¯ Java çº¿ç¨‹å¯åŠ¨åæ‰§è¡Œçš„è¯­å¥ç»„ï¼Œå³äººç±»è¦æ±‚å®ƒæ‰§è¡Œçš„ä»»åŠ¡ï¼Œè€Œ main æ–¹æ³•çš„è¯­å¥æ˜¯ Java ç”¨æˆ·ç›´æ¥æˆ–é—´æ¥é€šè¿‡å‘½ä»¤è¡Œå¯åŠ¨ JVM åæ‰§è¡Œã€‚\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå³ä½¿è¿è¡Œä¸€ä¸ªç®€å•çš„ \u0026ldquo;Hello World\u0026rdquo; ç¨‹åºï¼Œä¹Ÿå¯èƒ½åœ¨ JVM æˆ–æ“ä½œç³»ç»Ÿåˆ›å»ºåå‡ ä¸ªæˆ–æ›´å¤šçº¿ç¨‹ã€‚ä¾‹å¦‚æ‰§è¡Œ main æ–¹æ³•çš„è¯­å¥éœ€è¦çš„ä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹èƒ½å¯åŠ¨å­çº¿ç¨‹å¹¶æ‰§è¡Œåç»­è¯­å¥ï¼Œå­çº¿ç¨‹ä¹Ÿèƒ½å¯åŠ¨å…¶å­çº¿ç¨‹å¹¶æ‰§è¡Œåç»­è¯­å¥ï¼Œè€Œä¸”è¿˜æœ‰å…¶å®ƒç”± HotSpot ä¸ºäº†å†…éƒ¨ç›®çš„è€Œåˆ›å»ºçš„çº¿ç¨‹ï¼Œå¦‚ VM threadã€Periodic task threadã€GC threadsã€Compiler threadsã€Signal dispatcher threadã€‚\nä¸»çº¿ç¨‹ç»ˆæ­¢ï¼Œå…¶å®ƒçº¿ç¨‹è¿˜ä¼šè¿è¡Œå—ï¼Ÿ\nThreadLocal å‰é¢æåˆ°äº†çº¿ç¨‹æœ‰è‹¥å¹²çš„ç§æœ‰åŒºåŸŸï¼Œå…¶ä¸­ä¹‹ä¸€èƒ½åœ¨ java.lang.Thread ä¸­æ‰¾åˆ°æ•°æ®ç»“æ„ã€‚Thread ç»´æŠ¤äº†ä¸€ä¸ªç±»å‹ä¸º java.lang.ThreadLocal.ThreadLocalMap çš„å­—æ®µï¼ŒThreadLocalMap æ˜¯ä¸€ä¸ªå®šåˆ¶åŒ–çš„ HashMapï¼Œkey çš„ç±»å‹æ˜¯ ThreadLocalï¼Œvalue æŒ‡ä»£çº¿ç¨‹æœ¬åœ°å˜é‡çš„å€¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 public class TransactionId { private static final ThreadLocal\u0026lt;Long\u0026gt; tid = ThreadLocal.withInitial(() -\u0026gt; 0L); public static Long get() { return tid.get(); } public static void set(Long value) { tid.set(value); } } å¦‚ä¸Šæ‰€ç¤ºï¼Œç±»å‹ä¸º ThreadLocal çš„å­—æ®µåˆå§‹åŒ–åï¼Œæ¯ä¸ªè®¿é—®è¯¥å­—æ®µï¼ˆé€šè¿‡ get æˆ– set æ–¹æ³•ï¼‰çš„çº¿ç¨‹è®¿é—®çš„æ˜¯å„è‡ª ThreadLocalMap å®ä¾‹å­˜å‚¨çš„ key/valueï¼Œå…¶ä¸­ç±»å‹æ˜¯ ThreadLocal çš„ key ç›¸ç­‰ï¼Œä½† value ä¸ä¸€å®šç›¸ç­‰ã€‚\nçº¿ç¨‹çŠ¶æ€ ä¸‹é¢è¿™ä¸ªæ¥è‡ª Java 6 Thread States and Life Cycle çš„çŠ¶æ€æœºï¼Œå¾ˆå¥½åœ°æè¿°äº† Java çº¿ç¨‹çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸã€‚\nç¿»é˜… JDK 8 çš„ java.lang.Thread.State å¯ä»¥ç¡®å®šï¼Œåœ¨ç»™å®šçš„æ—¶é—´ç‚¹ï¼Œä¸€ä¸ª Java çº¿ç¨‹åªèƒ½å¤„äºä»¥ä¸‹çŠ¶æ€ä¹‹ä¸€ï¼š\nNewã€‚å°šæœªå¯åŠ¨çš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€ã€‚\nRunnableã€‚Java è™šæ‹Ÿæœºä¸­æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€ã€‚\nBlockedã€‚ç­‰å¾…è·å¾—ç›‘è§†å™¨é”ï¼ˆmonitor lockï¼‰è€Œè¢«é˜»å¡çš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€ã€‚\nWaittingã€‚æ— é™æœŸåœ°ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç‰¹å®šæ“ä½œçš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€ã€‚\nTimed Waitingã€‚æœ‰é™æœŸåœ°ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç‰¹å®šæ“ä½œçš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€ã€‚\nTerminatedã€‚ç»ˆæ­¢çš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€ã€‚\nå¦‚çŠ¶æ€æœºæ‰€ç¤ºï¼Œå½“çº¿ç¨‹æ‰§è¡Œä¸åŒæ“ä½œæ—¶ï¼Œçº¿ç¨‹çŠ¶æ€å‘ç”Ÿè½¬æ¢ï¼Œè¿™äº›æ“ä½œå¯¹åº”äº JDK å·²æä¾›çš„æ–¹æ³•ã€‚æ³¨æ„ä¸Šå›¾çš„ o è¡¨ç¤º Objectï¼Œt è¡¨ç¤º Threadã€‚\né€šçŸ¥ wait/notify ä¸€ä¸ªçº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€æ—¶ï¼Œå¯ä»¥è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹é€šçŸ¥ï¼Œè½¬ä¸ºå¯è¿è¡ŒçŠ¶æ€ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªçº¿ç¨‹ç”¨ä¸€ä¸ªå¯¹è±¡ï¼ˆçš„å¼•ç”¨ï¼‰è°ƒç”¨ Object#wait()ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ç”¨åŒä¸€ä¸ªå¯¹è±¡ï¼ˆçš„å¼•ç”¨ï¼‰è°ƒç”¨ Object#notify() æˆ– Object#notifyAll()ï¼Œå‰ææ˜¯å®ƒä»¬å¿…é¡»æ‹¥æœ‰è¯¥å¯¹è±¡çš„å†…ç½®é”ï¼›ç¬¬ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ Object#wait() æ—¶ï¼Œå®ƒä¼šé‡Šæ”¾è¯¥å¯¹è±¡çš„å†…ç½®é”å¹¶â€œæš‚åœâ€ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹è·å¾—è¯¥å¯¹è±¡çš„å†…ç½®é”æˆåŠŸä¹‹åï¼Œè°ƒç”¨ Object#notifyAll() é€šçŸ¥æ‰€æœ‰æ›¾ç»ç”¨åŒä¸€ä¸ªå¯¹è±¡ï¼ˆçš„å¼•ç”¨ï¼‰è°ƒç”¨äº† Object#wait() çš„çº¿ç¨‹æœ‰é‡è¦äº‹æƒ…å‘ç”Ÿï¼›åœ¨ç¬¬äºŒä¸ªçº¿ç¨‹é‡Šæ”¾äº†è¯¥å¯¹è±¡çš„å†…ç½®é”åçš„æŸä¸ªæ—¶åˆ»ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹é‡æ–°è·å¾—äº†è¯¥å¯¹è±¡çš„å†…ç½®é”ï¼Œå¹¶ä» Object#wait() è¿”å›è€Œâ€œæ¢å¤â€ã€‚é˜»å¡çŠ¶æ€ä¸å†…ç½®é”æˆ–ç›‘è§†å™¨é”æ¯æ¯ç›¸å…³ï¼Œå°†åœ¨ä¸‹æ–‡çš„\u0026quot;é”å’ŒåŒæ­¥\u0026quot;è®¨è®ºã€‚\nè¯¦æƒ…è¯·è§ Objectã€‚\ninterrupt å¦å¤–ï¼Œçº¿ç¨‹æœ‰ä¸€ä¸ªä¸­æ–­çŠ¶æ€ï¼ˆinterrupt statusï¼‰ã€‚æ‰€è°“ä¸­æ–­ï¼Œå³åœæ­¢æ­£åœ¨æ‰§è¡Œçš„æ“ä½œï¼Œå¹¶æ‰§è¡Œå…¶å®ƒæ“ä½œã€‚ä¾‹å¦‚ï¼Œä¸»çº¿ç¨‹å¯ä½¿ç”¨å­çº¿ç¨‹å¯¹è±¡ï¼ˆçš„å¼•ç”¨ï¼‰è°ƒç”¨ java.lang.Thread#interrupt() ä¸­æ–­å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹èƒ½å¤Ÿæ•è· java.lang.InterruptedException æˆ–è°ƒç”¨ java.lang.Thread#interrupted() æ¥æ”¶åˆ°ä¸­æ–­ã€‚\nè¯¦æƒ…è¯·è§ Threadã€‚\npark/unpark ç±»æ¯”ç”³è¯·è®¸å¯å’Œæä¾›è®¸å¯ã€‚ç›¸æ¯”äº wait/notifyï¼Œpark/unpark å¯¹è°ƒç”¨é¡ºåºæ²¡æœ‰è¦æ±‚ã€‚çº¿ç¨‹è°ƒç”¨ LockSupport#park() æ—¶â€œæš‚åœâ€ï¼Œçº¿ç¨‹è°ƒç”¨ LockSupport#unpark(Thread) æ—¶å–æ¶ˆç»™å®šçº¿ç¨‹çš„â€œæš‚åœâ€ï¼Œå¦‚æœç»™å®šçº¿ç¨‹å·²â€œæš‚åœâ€ï¼Œåˆ™ç»™å®šçº¿ç¨‹ä» LockSupport#park() è¿”å›è€Œâ€œæ¢å¤â€ï¼Œå¦‚æœç»™å®šçº¿ç¨‹æ²¡æœ‰â€œæš‚åœâ€ï¼Œé‚£ä¹ˆå°†æ¥ç»™å®šçº¿ç¨‹ç¬¬ä¸€æ¬¡è°ƒç”¨ LockSupport#park() æ—¶ç«‹å³è¿”å›ã€‚\nè¯¦æƒ…è¯·è§ LockSupportã€‚\nspurious wakeup ä¸­æ–­å’Œè™šå‡å”¤é†’å¯èƒ½å‘ç”Ÿï¼Œå®˜æ–¹å»ºè®®åœ¨å¾ªç¯ä½“å†…ä½¿ç”¨ wait å’Œ parkï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n1 2 3 4 5 6 synchronized (obj) { while (\u0026lt;condition does not hold\u0026gt;) { obj.wait(); } ... // Perform action appropriate to condition } æˆ–è€…ï¼š\n1 2 3 4 5 6 7 while (waiters.peek() != current || !locked.compareAndSet(false, true)) { LockSupport.park(this); // ignore interrupts while waiting if (Thread.interrupted()) { wasInterrupted = true; } } çº¿ç¨‹æ±  ä½¿ç”¨ Thread.start(...) å¯åŠ¨çº¿ç¨‹è¶³ä»¥æ‰§è¡ŒåŸºæœ¬çš„ä»»åŠ¡ï¼Œä½†æ˜¯å¯¹äºå¤æ‚ä»»åŠ¡ï¼Œä¾‹å¦‚æœ‰è¿”å›å€¼çš„ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ç­‰ï¼Œå…¶ API è¿‡äºä½çº§ã€‚å¤§è§„æ¨¡çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå°†çº¿ç¨‹çš„åˆ›å»ºå’Œç®¡ç†ä»åº”ç”¨ç¨‹åºå…¶ä½™éƒ¨åˆ†åˆ†å¼€æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ï¼Œç†ç”±ä¹‹ä¸€æ˜¯åˆ†ç¦»å…³æ³¨ç‚¹èƒ½å¤Ÿå‡å¼±å¤æ‚æ€§ã€‚å°è£…äº†çº¿ç¨‹çš„åˆ›å»ºå’Œç®¡ç†çš„å¯¹è±¡ä»¬ç§°ä¸º Executorsã€‚JDK çš„ java.util.concurrent åŒ…å®šä¹‰äº†ä¸‰ä»£ Executor æ¥å£ï¼š\nExecutor\nExecutorService\nScheduledExecutorService\nå¦‚æœ r æ˜¯ Runnable å¯¹è±¡ï¼Œè€Œ e æ˜¯ Executor å¯¹è±¡ï¼Œåˆ™å¯ä»¥ä½¿ç”¨\n1 e.execute(r); ä»£æ›¿\n1 new Thread(r).start(); Executor æ¥å£å¤§éƒ¨åˆ†å®ç°éƒ½ä½¿ç”¨çº¿ç¨‹æ± ï¼ˆThread Poolï¼‰ï¼Œè¿™å°±æ˜¯ç†ç”±ä¹‹äºŒã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªä¸€èˆ¬çš„æœåŠ¡å™¨ç«¯ç¨‹åºæœåŠ¡ç€å¤šä¸ªå®¢æˆ·ç«¯ï¼Œå¦‚æœæ¯ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚éƒ½é€šè¿‡æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œå³çº¿ç¨‹æ•°éšç€è¯·æ±‚æ•°å¢åŠ è€Œå¢åŠ ï¼Œè™½ç„¶æ–°å»ºçº¿ç¨‹æ¯”æ–°å»ºè¿›ç¨‹ä¾¿å®œï¼Œä½†æ˜¯å½“æ´»è·ƒçš„çº¿ç¨‹æ•°å¤ªå¤šæ—¶ï¼Œä¸ä»…å ç”¨å¤§é‡çš„å†…å­˜ï¼Œå®¹æ˜“å¯¼è‡´å†…å­˜æº¢å‡ºï¼Œè€Œä¸”æ“ä½œç³»ç»Ÿå†…æ ¸éœ€è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´åœ¨çº¿ç¨‹è°ƒåº¦ä¸Šï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ï¼Œå¤§é‡çš„çº¿ç¨‹â€œæš‚åœâ€è¾ƒé•¿æ—¶é—´ï¼Œè¿˜å› é¢‘ç¹æ–°å»ºå’Œç»ˆç»“æ‰§è¡ŒçŸ­æ—¶ä»»åŠ¡çš„çº¿ç¨‹è€Œå¼•èµ·çš„å»¶è¿Ÿï¼Œå¤§é‡å®¢æˆ·ç«¯é•¿æ—¶é—´å¾—ä¸åˆ°å“åº”ã€‚\nå¯¹äº Java Hotspot VM æ¥è¯´ï¼Œå¤§é‡çº¿ç¨‹çš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯å·¨å¤§çš„æ ¹é›†åˆï¼ˆroot setï¼‰ï¼Œå› æ­¤ GC åœé¡¿é˜¶æ®µï¼ˆstop-the-world pauseï¼‰æ›´é•¿ã€‚\nçº¿ç¨‹æ± ç”±æ•°é‡å¯æ§çš„å·¥ä½œçº¿ç¨‹ï¼ˆworker threadï¼‰ ç»„æˆï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½éƒ½è¢«å»¶é•¿ï¼Œä»¥ä¾¿ç”¨äºæ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œæ—¢å‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢å¼•èµ·çš„å»¶è¿Ÿï¼Œä¹Ÿå‡å°‘äº†é¢‘ç¹æ–°å»ºå’Œç»ˆç»“æ‰§è¡ŒçŸ­æš‚ä»»åŠ¡çš„çº¿ç¨‹è€Œå¼•èµ·çš„å»¶è¿Ÿã€‚çº¿ç¨‹æ± çš„æ–°å»ºé€šå¸¸æ˜¯é¢„å¤„ç†ï¼Œå³æœåŠ¡å™¨ç«¯ç¨‹åºæä¾›æœåŠ¡ä¹‹å‰å·²å‡†å¤‡å¥½çº¿ç¨‹æ± ï¼Œé¿å…äº†ä¸´æ—¶æ–°å»ºå¤§é‡çº¿ç¨‹çš„å¼€é”€ã€‚\nçº¿ç¨‹æ± æœ‰ä¸€ç§ç±»å‹æ˜¯å›ºå®šçº¿ç¨‹æ± ï¼ˆfixed thread poolï¼‰ï¼Œå¦‚æœæŸä¸ªçº¿ç¨‹ä»åœ¨ä½¿ç”¨ä¸­è€Œè¢«æŸç§æ–¹å¼ç»ˆæ­¢ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰æ–°çš„çº¿ç¨‹ä»£æ›¿å®ƒã€‚ä»»åŠ¡é€šè¿‡é˜Ÿåˆ—æäº¤åˆ°æ± ä¸­ï¼Œä»»åŠ¡é˜Ÿåˆ—å¯ä»¥å®¹çº³è¶…è¿‡çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡çš„çš„ä»»åŠ¡ã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ä¼˜é›…é™çº§ï¼ˆdegrade gracefullyï¼‰å’Œå‰Šå³°ã€‚\n1 2 3 public static ExecutorService newFixedThreadPool(int nThreads) { return new ThreadPoolExecutor(nThreads, nThreads, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue\u0026lt;Runnable\u0026gt;()); } ä¸Šé¢æ˜¯ Executors çš„æ–°å»ºå›ºå®šçº¿ç¨‹æ± çš„ç®€å•æ–¹æ³•ã€‚æ³¨æ„å½“ä¸­çš„å‚æ•°ç±»å‹ï¼ŒLinkedBlockingQueueï¼Œå®ƒæ˜¯ BlockingQueue çš„åŸºäºé“¾è¡¨çš„å®ç°ç±»ï¼Œä½œä¸ºé˜»å¡é˜Ÿåˆ—ï¼Œå®ƒæœ‰ä¸€ä¸ªç‰¹æ€§ï¼Œå½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œçº¿ç¨‹ä»é˜Ÿåˆ—æ‹‰å–å…ƒç´ ä¼šè¢«é˜»å¡æˆ–è¢«è¿«ç­‰å¾…ã€‚ä»”ç»†ç¿»é˜…æºç ï¼Œå¯ä»¥çŸ¥é“çº¿ç¨‹æ± çš„é¢„å…ˆæ–°å»ºå’Œå·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å»¶é•¿æ˜¯é€šè¿‡é˜»å¡å·¥ä½œçº¿ç¨‹æˆ–ä½¿ä¹‹æœ‰é™æœŸç­‰å¾…æ¥å®ç°ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä»»åŠ¡é˜Ÿåˆ—çš„çš„ä»»åŠ¡æŠ½è±¡ä¸º Runableã€‚\næ–°å»ºçº¿ç¨‹æ± è¿”å›ä¸€ä¸ª ExecutorService å®ä¾‹ï¼Œåˆ©ç”¨å®ƒæ¥æäº¤ä»»åŠ¡ï¼š\n1 2 3 Future\u0026lt;?\u0026gt; future = executorService.submit(() -\u0026gt; { // do something }); submit æ–¹æ³•å¯ä¼ é€’ Runable å¼•ç”¨æˆ– Callable å¼•ç”¨ï¼Œä¸¤è€…çš„å…³ç³»å¦‚ä¸‹ï¼š\n1 Runnable runnable = new FutureTask\u0026lt;\u0026gt;(callable); Future è¡¨ç¤ºå¼‚æ­¥ç»“æœã€‚ä¸»çº¿ç¨‹è°ƒç”¨ Future#get æ–¹æ³•æ—¶è¢«è¿«ç­‰å¾…ï¼Œç›´åˆ°å­çº¿ç¨‹å®Œæˆç›¸åº”çš„ä»»åŠ¡åï¼Œä¸»çº¿ç¨‹ä» Future#get æ–¹æ³•è¿”å›å¾—åˆ°ç»“æœå¹¶æ‰§è¡Œåç»­è¯­å¥ã€‚\nCompletableFuture å®ç°äº† Futureï¼Œå¹¶ä¸”æ”¯æŒè®¾ç½®å›è°ƒæ–¹æ³•ã€‚ä¸»çº¿ç¨‹æ— éœ€ç­‰å¾…å·¥ä½œçº¿ç¨‹å®Œæˆç›¸åº”çš„ä»»åŠ¡ï¼Œå½“å·¥ä½œçº¿ç¨‹å®Œæˆç›¸åº”çš„ä»»åŠ¡åï¼Œå›è°ƒæ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 CompletableFuture\u0026lt;Object\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { // do something }, threadPoolExecutor); future.thenCompose(obj -\u0026gt; CompletableFuture.supplyAsync(() -\u0026gt; { // do other things }), threadPoolExecutor); future.whenComplete((obj, e) -\u0026gt; { // callback }, threadPoolExecutor); è®¾æƒ³ä¸€ä¸‹å¤šçº¿ç¨‹å¹¶å‘å¤„ç†äº‹ä»¶ï¼Œè¦æ±‚ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 List\u0026lt;CompletableFuture\u0026lt;Event\u0026gt;\u0026gt; futures = new ArrayList\u0026lt;\u0026gt;(events.size()); for (Event event : events) { CompletableFuture\u0026lt;Event\u0026gt; future = CompletableFuture.supplyAsync(() -\u0026gt; { // handle event return event; }, threadPoolExecutor); futures.add(future); } CompletableFuture\u0026lt;Void\u0026gt; allFuture = CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])); try { allFuture.join(); } catch (Exception e) { // ... } ä½¿ç”¨ Executors æ–°å»ºçº¿ç¨‹æ± ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯èƒ½ä¼šå› ä¸ºä»»åŠ¡é˜Ÿåˆ—å †ç§¯è¿‡å¤šä»»åŠ¡ä»è€Œå¯¼è‡´å†…å­˜æº¢å‡ºï¼Œå› ä¸º LinkedBlockingQueue å¯è‡ªåŠ¨æ‰©å®¹ï¼Œæœ€å¤§å€¼ä¸º Integer.MAX_VALUEã€‚å»ºè®®åˆç†è®¾ç½®çº¿ç¨‹æ± çš„å„ä¸ªå‚æ•°ï¼Œä¾‹å¦‚ä½¿ç”¨æ„é€ å™¨æ–°å»ºçº¿ç¨‹æ± ï¼š\n1 new ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue\u0026lt;Runnable\u0026gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler); æäº¤ä»»åŠ¡åï¼Œå¯èƒ½çš„æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºï¼š\nè¯¦æƒ…è§ ThreadPoolExecutor å’Œ ScheduledThreadPoolExecutorã€‚\nFork/Join Fork/Join æ¡†æ¶æ˜¯ ExecutorService æ¥å£çš„å®ç°ï¼Œå®ƒæ˜¯ä¸ºäº†å¯ä»¥åˆ†è€Œæ²»ä¹‹çš„ä»»åŠ¡æˆ–å·¥ä½œè€Œè®¾è®¡çš„ï¼Œç›®æ ‡æ˜¯ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„å¤„ç†å™¨æ¥æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚Fork/Join æ¡†æ¶åˆ†é…ä»»åŠ¡ç»™çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹ï¼Œä½†æ˜¯ä¸ä¸€èˆ¬çš„çº¿ç¨‹æ± ä¸ä¸€æ ·ï¼Œå®ƒä½¿ç”¨å·¥ä½œçªƒå–ç®—æ³•ï¼Œç©ºé—²çš„å·¥ä½œçº¿ç¨‹å¯ä»¥çªƒå–ç¹å¿™çš„å·¥ä½œçº¿ç¨‹çš„ä»»åŠ¡æ¥æ‰§è¡Œï¼Œè¿™ä¸ªçº¿ç¨‹æ± ç§°ä¸º ForkJoinPoolã€‚\nå·¥ä½œçº¿ç¨‹å¾ˆæœ‰å¯èƒ½ä¼šè¢« BOSS å‘½ä»¤æŒ‰ä»¥ä¸‹å¥—è·¯å·¥ä½œï¼š\n1 2 3 4 5 if æˆ‘çš„å·¥ä½œé‡è¶³å¤Ÿå° ç›´æ¥åšå·¥ä½œ else å°†æˆ‘çš„å·¥ä½œåˆ†ä¸ºä¸¤ä¸ªç‰‡æ®µ è°ƒç”¨ä¸¤ä¸ªç‰‡æ®µå¹¶ç­‰å¾…ç»“æœ åˆ†è€Œæ²»ä¹‹ï¼Œé€šå¸¸æŠŠä¸€ä¸ªè¶³å¤Ÿå¤§çš„å·¥ä½œä»»åŠ¡é€’å½’åˆ†è§£ä¸ºä¸¤ä¸ªæˆ–å¤šä¸ªç›¸åŒæˆ–ç›¸ä¼¼çš„å­ä»»åŠ¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 public class BigTask extends RecursiveAction { private long[] src; private int start, len; // ... public BigTask(long[] src, int start, int len) { this.src = src; this.start = start; this.len = len; } protected static int threshold = 1000; @Override protected void compute() { if (len \u0026lt; threshold) { // ç›´æ¥æ“ä½œ src } else { int split = len / 2; invokeAll(new BigTask(src, start, split), new BigTask(src, start + split, len - split)); // ... } } } å‡è®¾è¿™ä¸ªå¤§ä»»åŠ¡ï¼ˆBigTaskï¼‰æ˜¯å¯¹ä¸€ä¸ªå¾ˆé•¿çš„æ•°ç»„ï¼ˆsrcï¼‰è¿›è¡ŒæŸäº›æ“ä½œï¼Œä¾‹å¦‚æ’åºã€mapã€reduceã€è¿‡æ»¤ã€åˆ†ç»„ç­‰ã€‚å…¶ä¸­ BigTask ç»§æ‰¿äº† RecursiveActionï¼Œé‡å†™äº† compute æ–¹æ³•ã€‚ç„¶åï¼Œæ–°å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå‘½ä»¤å·¥ä½œçº¿ç¨‹æ‰§è¡Œå¤§ä»»åŠ¡ã€‚\n1 2 3 4 5 long[] src = ...; BigTask task = new BigTask(src, 0, src.length); ForkJoinPool pool = new ForkJoinPool(); pool.invoke(task); ä¸€ä¸ªå·¥ä½œçº¿ç¨‹è°ƒç”¨äº† compute æ–¹æ³•ï¼Œå…ˆåˆ¤æ–­å½“å‰ src çš„é•¿åº¦æ˜¯å¦å°äºé˜ˆå€¼ï¼ˆthresholdï¼‰ï¼Œè‹¥æ˜¯åˆ™è®¤ä¸ºè¿™ä¸ªä»»åŠ¡è¶³å¤Ÿå°ï¼Œå•çº¿ç¨‹å¾ˆå¿«å°±èƒ½å®Œæˆå¯¹ src çš„æ“ä½œï¼Œå¦è€…å°±è®¤ä¸ºè¿™ä¸ªä»»åŠ¡è¶³å¤Ÿå¤§ï¼Œéœ€è¦åˆ†å·¥ï¼Œäºæ˜¯å…ˆæŠŠ src åˆ†æˆä¸¤ä¸ªç‰‡æ®µï¼Œç„¶åè°ƒç”¨ invokeAll æ–¹æ³•ï¼Œå…¶å®ƒå·¥ä½œçº¿ç¨‹å»æ‰§è¡Œè¿™ä¸¤ä¸ªå­ä»»åŠ¡ï¼Œåˆè°ƒç”¨äº† compute æ–¹æ³•\u0026hellip;\u0026hellip;åœ¨å¤šå¤„ç†å™¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå› ä¸ºæ”¯æŒå¤šçº¿ç¨‹å¹¶è¡Œï¼Œæ‰€ä»¥è¿™ç±»ç¨‹åºé€šå¸¸è¿è¡Œå¾—å¾ˆå¿«ã€‚\nå¦‚æœéœ€è¦è¿”å›å€¼ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ RecursiveTaskã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public class FibonacciTask extends RecursiveTask\u0026lt;Integer\u0026gt; { private int n; public FibonacciTask(int n) { this.n = n; } @Override protected Integer compute() { if (n \u0026lt;= 1) { return n; } FibonacciTask f1 = new FibonacciTask(n - 1); f1.fork(); FibonacciTask f2 = new FibonacciTask(n - 2); return f2.compute() + f1.join(); } public static void main(String[] args) throws ExecutionException, InterruptedException { ForkJoinPool pool = new ForkJoinPool (Runtime.getRuntime().availableProcessors(), ForkJoinPool.defaultForkJoinWorkerThreadFactory, null, true); ForkJoinTask\u0026lt;Integer\u0026gt; task = pool.submit(new FibonacciTask(10)); Integer result = task.get(); } } å…ˆåˆ†è§£ï¼Œååˆå¹¶ã€‚\nJDK çš„ java.util.Arrays å’Œ java.util.streams æä¾›äº†è®¸å¤šæ“ä½œèšåˆç±»å‹å®ä¾‹çš„å¹¶è¡ŒåŒ–æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•é€šå¸¸åŸºäº Fork/Joinã€‚\néçº¿ç¨‹å®‰å…¨ å‰é¢è¯´åˆ°äº†å¤šçº¿ç¨‹ç¨‹åºçš„ä¼˜ç‚¹ï¼Œä½†å®ƒä¹Ÿæœ‰æ˜æ˜¾çš„ç¼ºç‚¹ã€‚å› ä¸ºå¤šä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œä¸”å¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä»½åªè¯»ä»£ç ï¼Œå½“å¤šä¸ªçº¿ç¨‹å¹¶å‘è¯»å†™å…±äº«å˜é‡æˆ–å…¨å±€å˜é‡æ—¶ï¼Œå¯èƒ½å‡ºç°çº¿ç¨‹å¹²æ‰°ï¼ˆthread interferenceï¼‰å’Œå†…å­˜ä¸€è‡´æ€§é”™è¯¯ï¼ˆmemory consistency errorsï¼‰ï¼Œä»è€Œæ— æ³•ä¿è¯ç¨‹åºåŠŸèƒ½æ­£ç¡®ï¼Œä¹Ÿç§°ä¸ºçº¿ç¨‹ä¸å®‰å…¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 public class Counter { private long count; public void increment() { count++; } public long value() { return count; } } ä¸Šé¢æ˜¯ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ï¼ˆCounterï¼‰ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå°†è®¡æ•°å™¨çš„å€¼ï¼ˆcountï¼‰å¢åŠ  1 çš„æ–¹æ³•ï¼ˆincrementï¼‰ã€‚ä»äººè„‘çš„è§’åº¦ï¼Œincrement æ–¹æ³•å¯åˆ†è§£ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š\nè¯»å– count çš„å€¼ã€‚ è®¡ç®— count + 1ã€‚ æŠŠè®¡ç®—ç»“æœå†™å› countã€‚ ä»è®¡ç®—æœºå¤„ç†å™¨çš„è§’åº¦ï¼š\nä»ä¸»å­˜å¤åˆ¶ count çš„å€¼å’Œ 1 çš„å€¼åˆ°ä¸¤ä¸ªå¯„å­˜å™¨ï¼Œä»¥è¦†ç›–å¯„å­˜å™¨åŸæ¥çš„å€¼ã€‚ æŠŠä¸¤ä¸ªå¯„å­˜å™¨çš„å€¼å¤åˆ¶åˆ° ALUï¼ŒALU å¯¹è¿™ä¸¤ä¸ªå€¼åšç®—æœ¯è¿ç®—ã€‚ ALU å°†è¿ç®—ç»“æœå­˜å…¥ä¸€ä¸ªå¯„å­˜å™¨ï¼Œä»¥è¦†ç›–è¯¥å¯„å­˜å™¨åŸæ¥çš„å€¼ã€‚ å‡è®¾ä¸¤ä¸ªçº¿ç¨‹è¯»å–äº† count çš„å€¼ä¸º 0ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨è®¡ç®— 0 + 1ï¼Œä¸€ä¸ªçº¿ç¨‹æ¯”å¦ä¸€ä¸ªçº¿ç¨‹æ›´å¿«æŠŠè®¡ç®—ç»“æœå†™å› countï¼Œæ­¤æ—¶ count çš„å€¼ä¸º 1ï¼Œè¾ƒæ…¢çš„çº¿ç¨‹æŠŠ 1 å†™å›äº† countï¼Œæœ€ç»ˆ count çš„å€¼æ˜¯é”™è¯¯çš„ 1ï¼Œè€Œä¸æ˜¯æ­£ç¡®çš„ 2ã€‚åœ¨è½¬è´¦åœºæ™¯ä¸‹ï¼Œç›¸äº’è¦†ç›–æˆ–ä¸¢å¤±æ›´æ”¹æ˜¯ä¸€ä¸ªéå¸¸ä¸¥é‡çš„é”™è¯¯ï¼Œä¾‹å¦‚ä¸¤ä¸ªäººåŒæ—¶å¯¹ä¸€ä¸ªé“¶è¡Œè´¦æˆ·è¿›è¡Œå–æ¬¾æˆ–å­˜æ¬¾ï¼Œå¦‚æœé“¶è¡Œè½¯ä»¶ç³»ç»Ÿå¼€å‘è€…ä»ç„¶æœ‰çº¿ç¨‹æƒ¯æ€§ï¼Œé‚£ä¹ˆç»“æœå¯èƒ½å–å¤šäº†é‡‘é¢æˆ–å­˜å°‘äº†é‡‘é¢ã€‚\nçº¿ç¨‹ 1 çº¿ç¨‹ 2 æ•´æ•°å€¼ 0 è¯»å– \u0026lt;- 0 è¯»å– \u0026lt;- 0 å¢åŠ  0 å¢åŠ  0 å†™å› -\u0026gt; 1 å†™å› -\u0026gt; 1 ä¸‹é¢é€šè¿‡ Junit æµ‹è¯•ï¼Œæ¥è¯å®çº¿ç¨‹ä¸å®‰å…¨çš„å­˜åœ¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public class CounterTest { private static final long wait = 3000; private final long threads = 2; private final long times = 1000000; private final long excepted = threads * times; @Test public void testIncrement() throws InterruptedException { Counter counter = new Counter(); startThreads(counter, () -\u0026gt; { for (int j = 0; j \u0026lt; times; j++) { counter.increment(); } System.out.printf(\u0026#34;threadName: %s, counterValue: %s\\n\u0026#34;, Thread.currentThread().getName(), counter.value()); }); Assert.assertNotEquals(excepted, counter.value()); } private void startThreads(Counter counter, Runnable runnable) throws InterruptedException { for (int i = 0; i \u0026lt; threads; i++) { new Thread(runnable).start(); } Thread.sleep(CounterTest.wait); System.out.printf(\u0026#34;threadName: %s, exceptedCounterValue: %s, actualCounterValue: %s\\n\u0026#34;, Thread.currentThread().getName(), excepted, counter.value()); } } ä¸€ä¸ªä¸´æ—¶æµ‹è¯•çº¿ç¨‹è°ƒç”¨äº† testIncrement æ–¹æ³•ï¼Œå¯åŠ¨äº† 2 ä¸ªå­çº¿ç¨‹ï¼Œä¸ºäº†é¿å…å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹å·²ç»åœæ­¢äº†ï¼Œè€Œå¦å¤–ä¸€çº¿ç¨‹å¯åŠ¨ä¸­ï¼Œæ¨¡æ‹Ÿäº†ä¸€ä¸ªè€—æ—¶ä»»åŠ¡ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½è¦é‡å¤è°ƒç”¨ Counter çš„ increment æ–¹æ³• 1000000 æ¬¡ã€‚æ³¨æ„ï¼Œä¸´æ—¶æµ‹è¯•çº¿ç¨‹è·³å‡ºå¾ªç¯åï¼Œä¼šç¡çœ  3000 æ¯«ç§’ï¼Œæ‰ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œé¢„æœŸç»“æœä¸º 2000000ï¼ˆå­çº¿ç¨‹æ•°ä¸é€’å¢æ¬¡æ•°çš„ä¹˜ç§¯ï¼‰ã€‚æ­¤å¤„çœç•¥æœ¬æœºä¿¡æ¯ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š\nä¸´æ—¶æµ‹è¯•çº¿ç¨‹å’Œä¸¤ä¸ªå­çº¿ç¨‹å–å¾— count çš„å€¼éƒ½æ˜¯é”™è¯¯çš„ã€‚æ ¹æœ¬åŸå› æ˜¯å¤šçº¿ç¨‹å¹¶å‘è®¿é—®å…±äº«å˜é‡æˆ–å…¨å±€å˜é‡æ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹è¯¥å˜é‡èµ‹å€¼å‰çš„å€¼ä¸å®ƒè¯»å–çš„å€¼ä¸ä¸€è‡´ï¼Œæœ€ç»ˆå¯¼è‡´äº†ç¨‹åºé”™è¯¯ã€‚ç»“åˆä¸Šé¢æåˆ°çš„ JVM è¿è¡Œæ—¶çš„æ•°æ®åŒºåŸŸï¼Œå¯ä»¥æ¨æ–­å‡º Java å„ç§å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ã€‚\nå˜é‡ åŒºåŸŸ æ˜¯å¦çº¿ç¨‹å…±äº« æ˜¯å¦çº¿ç¨‹å®‰å…¨ å®ä¾‹å­—æ®µï¼ˆinstance fieldï¼‰ å † æ˜¯ å¦ é™æ€å­—æ®µï¼ˆstatic fieldï¼‰ å † æ˜¯ å¦ æœ¬åœ°å˜é‡ï¼ˆlocal variableï¼‰ æ ˆ å¦ æ˜¯ Java å¹¶å‘ç¼–ç¨‹ é” ä¿è¯å¤šçº¿ç¨‹å¹¶å‘è®¿é—®å…±äº«èµ„æºçš„ç¨‹åºæ­£ç¡®ï¼Œæœ‰ä¸€ä¸ªç›´è§‚çš„è§£å†³æ–¹æ¡ˆâ€”â€”é”ï¼ˆLockï¼‰ã€‚\nåªæœ‰è·å¾—é”æˆåŠŸçš„çº¿ç¨‹æ‰èƒ½è¿›å…¥ä¸´ç•ŒåŒºï¼ˆcritical sectionï¼‰ï¼Œè®¿é—®å…±äº«èµ„æºã€‚\nè®¿é—®å…±äº«èµ„æºå®Œæˆåï¼Œå³ä½¿è¿‡ç¨‹å‘ç”Ÿå¼‚å¸¸ï¼Œä¹Ÿä¸€å®šè¦é‡Šæ”¾é”ï¼Œé€€å‡ºä¸´ç•ŒåŒºã€‚\nè½¯ä»¶å±‚çš„é”é€šå¸¸éœ€è¦ç¡¬ä»¶å±‚æ”¯æŒæ‰èƒ½æœ‰æ•ˆå®ç°ã€‚è¿™ç§æ”¯æŒé€šå¸¸é‡‡å–ä¸€ç§æˆ–å¤šç§åŸå­æŒ‡ä»¤çš„å½¢å¼ï¼Œå¦‚ test-and-setã€compare-and-swapã€fetch-and-addã€‚æ‰€è°“åŸå­æŒ‡ä»¤ï¼Œå³å¤„ç†å™¨æ‰§è¡Œè¯¥æŒ‡ä»¤ä¸å¯åˆ†å‰²ä¸”ä¸å¯ä¸­æ–­ï¼Œæ¢è¨€ä¹‹ï¼ŒåŸå­æ“ä½œè¦ä¹ˆå®Œå…¨å‘ç”Ÿï¼Œè¦ä¹ˆæ ¹æœ¬ä¸å‘ç”Ÿã€‚å¯¹äºå¤šå¤„ç†å™¨çš„è®¡ç®—æœºç³»ç»Ÿï¼Œä¸ºäº†ä¿è¯åŸå­æ€§ï¼Œç”šè‡³å¯èƒ½é€šè¿‡é”å®šæ€»çº¿ï¼Œæš‚æ—¶ç¦æ­¢å…¶å®ƒ CPU ä¸å†…å­˜é€šä¿¡ã€‚\nsynchronized ä»¥å‰æ–‡çš„è®¡æ•°å™¨ä¸ºä¾‹ï¼Œæ–°å¢ä¸€ä¸ªç”¨ synchronized ä¿®é¥°çš„ incrementSyncMethod æ–¹æ³•åˆ° Counterï¼Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public class Counter { private long count; public void increment() { count++; } public synchronized void incrementSyncMethod() { count++; } public long value() { return count; } } ä½¿ç”¨ä¸æµ‹è¯• increment æ–¹æ³•ç›¸åŒçš„æµ‹è¯•æ•°æ®ï¼Œæµ‹è¯•å¯åŠ¨ç›¸åŒä¸ªæ•°çš„å­çº¿ç¨‹é‡å¤è°ƒç”¨åŒä¸€ä¸ª Counter å¯¹è±¡çš„ incrementSyncMethod æ–¹æ³•ç›¸åŒæ¬¡æ•°ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 @Test public void testIncrementSyncMethod() throws InterruptedException { Counter counter = new Counter(); startThreads(counter, () -\u0026gt; { for (int j = 0; j \u0026lt; times; j++) { counter.incrementSyncMethod(); } System.out.printf(\u0026#34;threadName: %s, counterValue: %s\\n\u0026#34;, Thread.currentThread().getName(), counter.value()); }); Assert.assertEquals(excepted, counter.value()); } æµ‹è¯•ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\næµ‹è¯•é€šè¿‡ï¼ŒæœŸæœ›å€¼ï¼ˆexceptedCounterValueï¼‰ä¸å®é™…å€¼ï¼ˆexceptedCounterValueï¼‰ç›¸ç­‰ï¼Œå…¶ä¸­ä¸€ä¸ªå­çº¿ç¨‹ï¼ˆThread-1ï¼‰ä¸ä¸´æ—¶æµ‹è¯•çº¿ç¨‹ï¼ˆTime-limited testï¼‰è¯»å–çš„ count å€¼ç›¸ç­‰ã€‚\né˜²æ­¢çº¿ç¨‹å¹²æ‰°å’Œå†…å­˜ä¸€è‡´æ€§é”™è¯¯çš„æœºåˆ¶æ˜¯åŒæ­¥ï¼ˆSynchronizationï¼‰ã€‚å…³é”®å­— synchronizedï¼Œç¿»è¯‘ä¸ºå·²åŒæ­¥ã€‚å½“åªæœ‰ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œå®ƒä¼šéšå¼è·å¾—è¯¥æ–¹æ³•çš„å¯¹è±¡çš„å†…ç½®é”ï¼ˆintrinsic lockï¼‰æˆ–ç›‘è§†å™¨é”ï¼ˆmonitor lockï¼‰ï¼Œå¹¶åœ¨è¯¥æ–¹æ³•è¿”å›æ—¶éšå¼é‡Šæ”¾è¯¥å¯¹è±¡çš„å†…ç½®é”ï¼ˆå³ä½¿è¿”å›æ˜¯ç”±æœªæ•è·å¼‚å¸¸å¼•èµ·çš„ï¼‰ã€‚å¦‚æœæ˜¯ç”¨ synchronized ä¿®é¥°çš„é™æ€æ–¹æ³•ï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šè·å¾—è¯¥é™æ€æ–¹æ³•æ‰€å±çš„ç±»æ‰€å…³è”çš„ Class å¯¹è±¡çš„å†…ç½®é”ï¼Œå› æ­¤ï¼Œé€šè¿‡ä¸åŒäºè¯¥ç±»çš„ä»»ä½•å®ä¾‹çš„é”æ¥æ§åˆ¶å¯¹è¯¥ç±»çš„é™æ€å­—æ®µçš„è®¿é—®ã€‚\nè¿™è¶³ä»¥è§£é‡Šä¸Šé¢çš„ä¸¤ä¸ªçº¿ç¨‹è¯»å†™åŒä¸€ä¸ªå˜é‡é‡å¤ç™¾ä¸‡æ¬¡ï¼Œæœ€åç»“æœä»ç„¶æ­£ç¡®çš„åŸå› ã€‚ä¸¤ä¸ªçº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œä¸€ä¸ªçº¿ç¨‹å¿«äºå¦ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†è¿™ä¸ªæ–¹æ³•çš„å¯¹è±¡çš„å†…ç½®é”ï¼Œè¾ƒæ…¢çš„çº¿ç¨‹åˆ™è¢«è¿«ç­‰å¾…æˆ–è¢«é˜»å¡ï¼Œå·²æ‹¥æœ‰è¯¥å¯¹è±¡çš„å†…ç½®é”çš„çº¿ç¨‹æ‰§è¡Œè¯¥æ–¹æ³•çš„è¯­å¥ï¼Œæ›´æ”¹å…±äº«å®ä¾‹å­—æ®µï¼Œè¯¥æ–¹æ³•è¿”å›æ—¶éšå¼é‡Šæ”¾äº†è¯¥å¯¹è±¡çš„å†…ç½®é”ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æœ‰æœºä¼šæ‹¥æœ‰è¯¥å¯¹è±¡çš„å†…ç½®é”\u0026hellip;\u0026hellip;å³ä½¿é‡å¤å¤šæ¬¡ï¼Œä¸€ä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è®¿é—®å…±äº«å®ä¾‹å­—æ®µï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¢«è¿«ç­‰å¾…æˆ–è¢«é˜»å¡ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªä¸¤ä¸ªçº¿ç¨‹å¯¹äºå…±äº«å®ä¾‹å­—æ®µçš„è®¿é—®æ˜¯äº’æ–¥çš„ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°çº¿ç¨‹å¹²æ‰°å’Œå†…å­˜ä¸€è‡´æ€§é”™è¯¯ã€‚\nçº¿ç¨‹ 1 çº¿ç¨‹ 2 æ•´æ•°å€¼ 0 è·å¾—é”ï¼ˆæˆåŠŸï¼‰ 0 è·å¾—é”ï¼ˆå¤±è´¥ï¼‰ 0 è¯»å– \u0026lt;- 0 å¢åŠ  0 å†™å› -\u0026gt; 1 é‡Šæ”¾é” 1 è·å¾—é”ï¼ˆæˆåŠŸï¼‰ 1 è¯»å– \u0026lt;- 1 å¢åŠ  1 å†™å› -\u0026gt; 2 é‡Šæ”¾é” 2 ç¼–å†™åŒæ­¥ä»£ç çš„å¦ä¸€ä¸ªæ–¹å¼æ˜¯ä½¿ç”¨åŒæ­¥è¯­å¥ï¼ˆSynchronized Statementsï¼‰ï¼Œæ¯”å¦‚ï¼Œæ”¹å†™ä¸€ä¸‹æµ‹è¯•æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Test public void testIncrementSyncBlock() throws InterruptedException { Counter counter = new Counter(); startThreads(counter, () -\u0026gt; { for (int j = 0; j \u0026lt; times; j++) { synchronized (counter) { counter.increment(); } } System.out.printf(\u0026#34;threadName: %s, counterValue: %s\\n\u0026#34;, Thread.currentThread().getName(), counter.value()); }); Assert.assertEquals(excepted, counter.value()); } æˆ–è€…æ·»åŠ ä¸€ä¸ª incrementSyncStmt æ–¹æ³•åˆ° Counter ç±»ï¼Œä»¥åŠæ–°å¢å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public class Counter { private long count; public void increment() { count++; } public synchronized void incrementSyncMethod() { count++; } public void incrementSyncStmt() { synchronized (this) { count++; } } public long value() { return count; } } 1 2 3 4 5 6 7 8 9 10 11 12 @Test public void testIncrementSyncStmt() throws InterruptedException { Counter counter = new Counter(); startThreads(counter, () -\u0026gt; { for (int j = 0; j \u0026lt; times; j++) { counter.incrementSyncStmt(); } System.out.printf(\u0026#34;threadName: %s, counterValue: %s\\n\u0026#34;, Thread.currentThread().getName(), counter.value()); }); Assert.assertEquals(excepted, counter.value()); } é‡‡ç”¨åŒæ­¥è¯­å¥éœ€è¦æ˜¾å¼æŒ‡å®šä¸€ä¸ªæä¾›å†…ç½®é”çš„å¯¹è±¡ï¼ŒåŒæ­¥è¯­å¥å»ºç«‹ä¸´ç•ŒåŒºï¼Œå¤šçº¿ç¨‹äº’æ–¥è®¿é—®è¯¥å¯¹è±¡çš„çŠ¶æ€ï¼ˆå®ä¾‹å­—æ®µæˆ–é™æ€å­—æ®µï¼‰ã€‚\nè†¨èƒ€ æ¯ä¸€ä¸ª Java å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„å†…ç½®é”æˆ–ç›‘è§†å™¨é”ï¼Œå…¶å†…éƒ¨å®ä½“ç®€ç§°ä¸ºç›‘è§†å™¨ï¼ˆmonitorï¼‰ï¼Œåˆç§°ä¸ºç®¡ç¨‹ã€‚å› ä¸ºæœ‰å…³é”®å­— synchronizedï¼Œæ‰€ä»¥æ¯ä¸ª Java å¯¹è±¡éƒ½æ˜¯ä¸€ä¸ªæ½œåœ¨çš„ç›‘è§†å™¨ã€‚ä¸€ä¸ªçº¿ç¨‹å¯ä»¥é”å®šæˆ–è§£é”ç›‘è§†å™¨ï¼Œå¹¶ä¸”åœ¨ä»»ä½•æ—¶å€™åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰è¯¥ç›‘è§†å™¨ã€‚åªæœ‰è·å¾—äº†ç›‘è§†å™¨çš„æ‰€æœ‰æƒåï¼Œçº¿ç¨‹æ‰å¯ä»¥è¿›å…¥å—ç›‘è§†å™¨ä¿æŠ¤çš„ä¸´ç•ŒåŒºã€‚è¿™ä¸ä¸Šæ–‡å¯¹å†…ç½®é”çš„è®¨è®ºä¸€è‡´ï¼Œè·å¾—é”å’Œé‡Šæ”¾é”å¯å¯¹åº”äº JVM æŒ‡ä»¤é›†çš„ monitorenter å’Œ monitorexitï¼Œå³çº¿ç¨‹è¿›å…¥ç›‘è§†å™¨å’Œé€€å‡ºç›‘è§†å™¨ã€‚\nå¦‚æœå¯¹ Counter.class è¿›è¡Œåæ±‡ç¼–ï¼š\n1 javap -v target/classes/io/h2cone/concurrent/Counter.class é‚£ä¹ˆå¯ä»¥çœ‹åˆ°åŒæ­¥æ–¹æ³•å’ŒåŒæ­¥è¯­å¥çš„å¯è§†åŒ–å­—èŠ‚ç ã€‚\nåŒæ­¥æ–¹æ³•è™½ç„¶ä½¿ç”¨ä¸€ä¸ªåä¸º ACC_SYNCHRONIZED çš„ flagï¼Œä½†ä» Java è™šæ‹Ÿæœºè§„èŒƒå¯ä»¥çŸ¥é“ï¼Œåº•å±‚è¡Œä¸ºä¹Ÿåº”è¯¥æ˜¯è¿›å…¥ç›‘è§†å™¨å’Œé€€å‡ºç›‘è§†å™¨ã€‚\nåœ¨ Java Hostspot VM ä¸­ï¼Œæ¯ä¸€ä¸ª Java å¯¹è±¡çš„å†…å­˜å¸ƒå±€éƒ½æœ‰ä¸€ä¸ªé€šç”¨çš„å¯¹è±¡å¤´ï¼ˆobject headerï¼‰ï½ç»“æ„ã€‚å¯¹è±¡å¤´çš„ç¬¬ä¸€ä¸ªå­—æ˜¯ mark wordï¼Œç¬¬äºŒå­—æ˜¯ klass pointerã€‚\nmark wordã€‚é€šå¸¸å­˜å‚¨åŒæ­¥çŠ¶æ€ï¼ˆsynchronization stateï¼‰å’Œå¯¹è±¡çš„ hash codeã€‚åœ¨ GC æœŸé—´ï¼Œå¯èƒ½åŒ…å« GC çŠ¶æ€ã€‚\nklass pointerã€‚æŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡ï¼ˆå…ƒå¯¹è±¡ï¼‰ï¼Œè¯¥å¯¹è±¡æè¿°äº†åŸå§‹å¯¹è±¡çš„å¸ƒå±€å’Œè¡Œä¸ºã€‚\næ™®é€šå¯¹è±¡å¤´ä¸€èˆ¬æœ‰ 2 ä¸ªå­—ï¼ˆwordï¼‰ï¼Œæ•°ç»„å¯¹è±¡å¤´ä¸€èˆ¬æœ‰ 3 ä¸ªå­—ï¼ˆwordï¼‰ã€‚\né”çš„ä¿¡æ¯è¢«ç¼–ç åœ¨åœ¨å¯¹è±¡å¤´çš„ mark wordï¼ŒMark word æœ€ä½ä¸¤ä½çš„å€¼ï¼ˆTagï¼‰åŒ…å«äº†å¯¹è±¡çš„åŒæ­¥çŠ¶æ€ï¼š\næœªé”å®š/å·²è§£é”ï¼ˆUnlockedï¼‰ã€‚æ²¡æœ‰çº¿ç¨‹æ‹¥æœ‰è¯¥å¯¹è±¡çš„é”ã€‚ è½»é‡çº§å·²é”å®šï¼ˆLight-weight lockedï¼‰ã€‚æŸä¸ªçº¿ç¨‹æ‹¥æœ‰è¯¥å¯¹è±¡çš„è½»é‡çº§é”ã€‚ é‡é‡çº§å·²é”å®šï¼ˆHeavy-weight lockedï¼‰ã€‚æŸä¸ªçº¿ç¨‹æ‹¥æœ‰è¯¥å¯¹è±¡çš„é‡é‡çº§é”ã€‚ æœ‰åå‘/å¯åå‘ï¼ˆBiased / Biasableï¼‰ã€‚è¯¥å¯¹è±¡å·²åå‘æˆ–å¯åå‘äºæŸçº¿ç¨‹ã€‚ ä¸‹å›¾æè¿°äº†å¯¹è±¡åŒæ­¥çŠ¶æ€çš„è½¬æ¢ï¼Œä¹Ÿæ˜¯é”çŠ¶æ€çš„è½¬æ¢ã€‚\nå¦‚æœä¸€ä¸ªç±»çš„â€œå¯åå‘â€è¢«ç¦ç”¨ï¼Œè¯¥ç±»çš„å®ä¾‹æˆ–å¯¹è±¡çš„åŒæ­¥çŠ¶æ€å§‹äºæœªé”å®šï¼Œå³å³æ‰‹è¾¹ã€‚\nå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨è¯¥å¯¹è±¡çš„åŒæ­¥æ–¹æ³•æˆ–æ‰§è¡Œäº†æŒ‡å®šè¯¥å¯¹è±¡çš„åŒæ­¥è¯­å¥ï¼ŒMark word å‰¯æœ¬å’ŒæŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆå­˜å‚¨åœ¨è¯¥çº¿ç¨‹å½“å‰æ ˆå¸§ï¼ˆframeï¼‰å†…çš„é”è®°å½•ï¼ˆlock recordï¼‰ä¸­ã€‚\nJVM å°è¯•é€šè¿‡ compare-and-swapï¼ˆCASï¼‰åœ¨è¯¥å¯¹è±¡çš„ mark word ä¸­å®‰è£…ä¸€ä¸ªæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆï¼ˆpointer to lock recordï¼‰ã€‚\nå¦‚æœ CAS æ“ä½œæˆåŠŸï¼Œåˆ™è¯¥çº¿ç¨‹æ‹¥æœ‰äº†è¯¥å¯¹è±¡çš„é”ã€‚è¯¥å¯¹è±¡çš„ mark word æœ€åä¸¤ä½çš„å€¼æ˜¯ 00ã€‚è¯¥é”ç§°ä¸ºè½»é‡çº§é”ã€‚\nå¦‚æœæ˜¯é€’å½’æˆ–åµŒå¥—è°ƒç”¨ä½œç”¨äºè¯¥å¯¹è±¡çš„åŒæ­¥ä»£ç ï¼Œé”è®°å½•åˆå§‹åŒ–ä¸º 0ï¼Œè€Œä¸æ˜¯è¯¥å¯¹è±¡çš„ mark wordã€‚ å¦‚æœ CAS æ“ä½œå¤±è´¥ï¼Œåˆ™è¯´æ˜è¯¥å¯¹è±¡å·²è¢«å…¶å®ƒçº¿ç¨‹é”å®šæˆåŠŸã€‚JVM é¦–å…ˆæ£€æµ‹è¯¥å¯¹è±¡çš„ mark word æ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆã€‚\nå½“å¤šä¸ªçº¿ç¨‹å¹¶å‘é”å®šåŒä¸€ä¸ªå¯¹è±¡ï¼Œä¸”ç«äº‰è¶³å¤Ÿæ¿€çƒˆæ—¶ï¼Œè½»é‡çº§é”å‡ä¸ºé‡é‡çº§é”ã€‚é‡é‡çº§é”å°±æ˜¯ç›‘è§†å™¨ï¼Œç›‘è§†å™¨ç®¡ç†ç­‰å¾…çš„çº¿ç¨‹ã€‚ç­‰å¾…è·å¾—ç›‘è§†å™¨çš„çº¿ç¨‹çŠ¶æ€å°±æ˜¯â€œçº¿ç¨‹çŠ¶æ€â€æ‰€è¯´çš„é˜»å¡ã€‚\nJVM ä½¿ç”¨çš„ç›‘è§†å™¨ç±»å‹å¯èƒ½å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¯¥ç›‘è§†å™¨ç”±ä¸‰ä¸ªæˆ¿é—´ç»„æˆã€‚ä¸­é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå³ç›‘è§†å™¨æ‰€æœ‰è€…ã€‚åœ¨å·¦ä¾§ï¼Œä¸€ä¸ªå°æˆ¿é—´åŒ…å«äº†å…¥å£é›†ï¼ˆentry setï¼‰ã€‚åœ¨å³ä¾§ï¼Œå¦ä¸€ä¸ªå°æˆ¿é—´åŒ…å«äº†ç­‰å¾…é›†åˆï¼ˆwait setï¼‰ã€‚é‚£ä¹ˆå¦‚æœæ­¤ Java ç›‘è§†å™¨æœªè¿‡æ—¶ï¼Œè¢«é˜»å¡çš„çº¿ç¨‹æ›´å¯èƒ½å¤„äºå…¥å£é›†ï¼Œå› ä¸ºç­‰å¾…é›†ä¸­çš„çº¿ç¨‹çŠ¶æ€æ˜¯â€œçº¿ç¨‹çŠ¶æ€â€æ‰€è¯´çš„ç­‰å¾…ã€‚\nè½»é‡çº§é”æ¯”é‡é‡çº§é”ä¾¿å®œå¾ˆå¤šï¼Œå› ä¸ºé¿å…äº†æ“ä½œç³»ç»Ÿäº’æ–¥é”/æ¡ä»¶å˜é‡ï¼ˆmutex / condition variablesï¼‰ä¸æ¯ä¸ªå¯¹è±¡çš„è”åŠ¨ã€‚\nå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹å¹¶å‘é”å®šå…±äº«å¯¹è±¡ï¼Œè·å¾—è½»é‡çº§é”å¤±è´¥çš„çº¿ç¨‹é€šå¸¸ä¸ä¼šè¢«é˜»å¡æˆ–è¢«è¿«ç­‰å¾…ï¼Œè€Œæ˜¯è‡ªæ—‹è‹¥å¹²æ¬¡ï¼Œå°è¯•è·å¾—é”ã€‚HotSpot VM ä½¿ç”¨é«˜çº§è‡ªé€‚åº”è‡ªæ—‹æŠ€æœ¯ï¼ˆadvanced adaptive spinning techniquesï¼‰æ¥æé«˜ç¨‹åºååé‡ï¼Œå³ä½¿æ˜¯é”å®šå…±äº«å¯¹è±¡ç«äº‰æ¿€çƒˆçš„ç¨‹åºã€‚\nå¦‚æœä¸€ä¸ªç±»çš„â€œå¯åå‘â€å·²å¯ç”¨ï¼Œè¯¥ç±»çš„å®ä¾‹æˆ–å¯¹è±¡çš„åŒæ­¥çŠ¶æ€å§‹äºæœªé”å®šï¼Œä¸”æ— åå‘ï¼Œå³å·¦æ‰‹è¾¹ã€‚\næ®è¯´ï¼Œè·å¾—è½»é‡é”çš„ CAS åœ¨å¤šå¤„ç†å™¨è®¡ç®—æœºç³»ç»Ÿä¸Šå¯èƒ½å¼•èµ·è¾ƒå¤§å»¶è¿Ÿï¼Œä¹Ÿè®¸å¤§å¤šæ•°å¯¹è±¡åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­æœ€å¤šåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹é”å®šã€‚æ—©åœ¨ Java 6ï¼Œæ­¤é—®é¢˜è¯•å›¾é€šè¿‡åå‘é”ä¼˜åŒ–ã€‚\nè¯¥å¯¹è±¡è¢«ç¬¬ä¸€ä¸ªçº¿ç¨‹é”å®šæ—¶ï¼Œåªæ‰§è¡Œä¸€æ¬¡ CAS æ“ä½œï¼Œä»¥å°†è¯¥çº¿ç¨‹ ID è®°å½•åˆ°è¯¥å¯¹è±¡çš„ mark word ä¸­ã€‚äºæ˜¯è¯¥å¯¹è±¡åå‘äºè¯¥çº¿ç¨‹ã€‚å°†æ¥è¯¥çº¿ç¨‹å¯¹è¯¥å¯¹è±¡çš„é”å®šå’Œè§£é”æ— éœ€ä»»ä½•åŸå­æ“ä½œæˆ– mark word çš„æ›´æ–°ï¼Œç”šè‡³è¯¥çº¿ç¨‹æ ˆä¸­çš„é”è®°å½•ä¹Ÿä¸ä¼šåˆå§‹åŒ–ã€‚\nå½“ä¸€ä¸ªçº¿ç¨‹é”å®šå·²åå‘äºå¦ä¸€ä¸ªçº¿ç¨‹çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„åå‘ä¼šè¢«æ’¤é”€ï¼ˆæ­¤æ“ä½œå¿…é¡»æš‚åœæ‰€æœ‰çº¿ç¨‹ï¼‰ã€‚ä¸€èˆ¬ç”±åå‘é”è½¬ä¸ºè½»é‡çº§é”ã€‚\nåå‘é”çš„è®¾è®¡å¯¹ä¸€ä¸ªçº¿ç¨‹é‡æ–°è·å¾—é”æ›´ä¾¿å®œå’Œå¦ä¸€ä¸ªçº¿ç¨‹è·å¾—é”æ›´æ˜‚è´µåšäº†æƒè¡¡ï¼š\nå¦‚æœæŸä¸ªç±»çš„å®ä¾‹åœ¨è¿‡å»é¢‘ç¹å‘ç”Ÿä¾¿åå‘æ’¤é”€ï¼Œåˆ™è¯¥ç±»å°†ç¦ç”¨â€œå¯åå‘â€ã€‚è¿™ä¸ªæœºåˆ¶å«åšæ‰¹é‡æ’¤é”€ï¼ˆbulk revocationï¼‰ã€‚\nå¦‚æœä¸€ä¸ªç±»çš„å®ä¾‹è¢«ä¸åŒçš„çº¿ç¨‹é”å®šå’Œè§£é”ï¼Œä¸”ä¸æ˜¯å¹¶å‘ï¼Œåˆ™è¯¥ç±»çš„å®ä¾‹è¢«é‡ç½®ä¸ºå·²è§£é”ä¸”æ— åå‘ï¼Œä½†ä»æ˜¯å¯åå‘çš„å¯¹è±¡ï¼Œå› ä¸ºè¯¥ç±»çš„â€œå¯åå‘â€ä¸ä¼šè¢«ç¦ç”¨ã€‚è¿™ä¸ªæœºåˆ¶å«åšæ‰¹é‡é‡ç½®åå‘ï¼ˆbulk rebiasingï¼‰ã€‚\nå½“ç„¶å¯ä»¥ä»ä¸€å¼€å§‹å°±ç¦ç”¨åå‘é”ï¼Œå¯åŠ¨ HotSpot VM æ—¶æŒ‡å®šå…³é—­ UseBiasedLockingï¼š\n1 -XX:-UseBiasedLocking å¯¹äºä¸€äº›ç¨‹åºï¼Œåå‘é”å¼Šå¤§äºåˆ©ï¼Œä¾‹å¦‚ Cassandra å°±ç¦ç”¨äº†å®ƒã€‚\nç®€è€Œè¨€ä¹‹ï¼Œä» Java 6 å¼€å§‹å°±å¯¹ synchronized åšäº†ä¸å°‘ä¼˜åŒ–ï¼Œéšç€å¤šçº¿ç¨‹é”å®šå…±äº«å¯¹è±¡çš„ç«äº‰å¼ºåº¦å¢å¤§ï¼Œé”çš„çŠ¶æ€ä¸€èˆ¬ç”±åå‘é”å‡ä¸ºè½»é‡çº§é”ï¼Œç«äº‰è¶³å¤Ÿæ¿€çƒˆæ—¶ï¼Œåˆ™å‡ä¸ºé‡é‡çº§é”ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºè†¨èƒ€ï¼ˆinflateï¼‰ã€‚\næ¶ˆé™¤ åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒJVM å¯ä»¥åº”ç”¨å…¶å®ƒä¼˜åŒ–ã€‚ä¾‹å¦‚ï¼ŒStringBufferï¼Œå®ƒæœ‰å¾ˆå¤šåŒæ­¥æ–¹æ³•ã€‚\n1 2 3 4 5 6 7 { StringBuffer sb = new StringBuffer(); sb.append(\u0026#34;foo\u0026#34;); sb.append(v); sb.append(\u0026#34;bar\u0026#34;); return sb.toString(); } å¦‚ä¸Šæ‰€ç¤ºï¼Œè¯­å¥åœ¨æŸæ–¹æ³•ä½“å†…ï¼Œå› ä¸º sb æ˜¯æœ¬åœ°å˜é‡ï¼Œæ‰€ä»¥è°ƒç”¨ append æ–¹æ³•å¯ä»¥çœç•¥é”ï¼Œè¿™å«åšé”æ¶ˆé™¤ï¼ˆlock elisionï¼‰ã€‚\nç²—åŒ– 1 2 3 4 5 { sb.append(\u0026#34;foo\u0026#34;); sb.append(v); sb.append(\u0026#34;bar\u0026#34;); } å†å¦‚ä¸Šæ‰€ç¤ºï¼Œå¦‚æœ sb æ˜¯å…¨å±€å˜é‡ï¼Œä¸”ç¬¬ä¸€æ¬¡ append æ–¹æ³•è°ƒç”¨æ—¶å·²è¢«æŸçº¿ç¨‹é”å®šæˆåŠŸï¼Œè¯¥çº¿ç¨‹å¯ä»¥é¿å… 3 æ¬¡é”å®š/è§£é”æ“ä½œï¼Œè€Œåªéœ€ 1 æ¬¡ï¼Œè¿™å«åšé”ç²—åŒ–ï¼ˆlock coarseningï¼‰ã€‚\næ­»é” æ­»é”æè¿°äº†çº¿ç¨‹ç­‰å¾…è·å¾—è‡ªå·±æˆ–å¯¹æ–¹å·²æ‹¥æœ‰çš„é”çš„åƒµæŒçŠ¶æ€ã€‚\né˜²æ­¢æ­»é”çš„æœ‰æ•ˆæ–¹æ¡ˆå¦‚ä¸‹ï¼š\nè®¾ç½®çº¿ç¨‹å°è¯•è·å¾—é”çš„è¶…æ—¶æ—¶é—´ã€‚ æ¯ä¸ªçº¿ç¨‹å°è¯•è·å¾—å¤šä¸ªèµ„æºçš„é”çš„é¡ºåºå¿…é¡»ä¸€è‡´ã€‚ æ¯”å¦‚ä¸Šå›¾ï¼Œçº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 éƒ½éœ€è¦è·å¾—èµ„æº 1 å’Œèµ„æº 2 çš„é”ï¼Œåªè¦æ¯ä¸ªçº¿ç¨‹å°è¯•è·å¾—èµ„æºçš„é”çš„é¡ºåºæ˜¯ (1ï¼Œ2)ï¼Œä¹Ÿå°±ä¸ä¼šæ˜¯åƒµå±€ã€‚\næƒ¯ç”¨é” é™¤äº† synchronizedï¼ŒJDK æä¾›çš„ java.util.concurrent åŒ…ï¼Œå¯Œæœ‰å‚å·®å¤šæ€çš„é”ã€‚\nReentrantLock ReentrantLockï¼Œå¯è¯‘ä¸ºé‡å…¥é”ã€‚é‡å…¥ï¼ˆreentrantï¼‰æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å†æ¬¡æ‹¥æœ‰å®ƒå·²æ‹¥æœ‰ä¸”æœªé‡Šæ”¾çš„é”ã€‚é€šè¿‡ä¸Šæ–‡â€œåå‘é”å’Œè½»é‡çº§é”ä»¥åŠé‡é‡çº§é”â€ï¼Œå¯ä»¥çŸ¥é“å†…ç½®é”æ˜¯å¯é‡å…¥é”ã€‚\n1 2 3 4 5 6 7 8 9 10 11 public class Foobar { public synchronized void doSomething() { System.out.println(\u0026#34;do something\u0026#34;); doOtherThings(); } public synchronized void doOtherThings() { System.out.println(\u0026#34;do other things\u0026#34;); } } å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œå½“ä¸€ä¸ªçº¿ç¨‹ç”¨ Foobar å¯¹è±¡è°ƒç”¨ doSomething æ–¹æ³•ï¼ŒæˆåŠŸè·å¾—è¯¥å¯¹è±¡çš„å†…ç½®é”åï¼Œç»§ç»­è°ƒç”¨ doOther æ–¹æ³•æ—¶ï¼Œå‡è®¾å†…ç½®é”ä¸æ˜¯é‡å…¥é”ï¼Œé‚£ä¹ˆå› ä¸º doSomething æ–¹æ³•è¿˜æœªè¿”å›ï¼Œæ‰€ä»¥è¯¥å¯¹è±¡çš„å†…ç½®é”è¿˜æœªè‡ªåŠ¨é‡Šæ”¾ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°†è¢«è¿«æ— é™æœŸç­‰å¾…ã€‚\næˆ–è€…æ–­è¨€è¯¥çº¿ç¨‹è°ƒç”¨ä»¥ä¸‹æ–¹æ³•ä¸ä¼šå¼•èµ· java.lang.StackOverflowError å¼‚å¸¸ï¼š\n1 2 3 4 5 6 public class Foobar { public synchronized void doSomething() { doSomething(); } } äº‹å®è¯æ˜ï¼Œä»¥ä¸Šæ–­è¨€éƒ½æ˜¯é”™çš„ã€‚ReentrantLock çš„ä¸€èˆ¬ç”¨æ³•å¦‚ä¸‹ï¼š\n1 final Lock lock = new ReentrantLock(); 1 2 3 4 5 6 lock.lock(); try { // critical section } finally { lock.unlock(); } ç›¸æ¯”äº synchronizedï¼ŒLock è¦æ±‚æ˜¾å¼é”å®šï¼ˆlockï¼‰å’Œè§£é”ï¼ˆunlockï¼‰ï¼Œå› æ­¤è¦ç‰¹åˆ«æ³¨æ„å³ä½¿å‘ç”Ÿå¼‚å¸¸ä¹Ÿè¦é‡Šæ”¾é”ã€‚å¦‚æœä¸å¸Œæœ›çº¿ç¨‹è·å¾—é”å¤±è´¥åç­‰å¾…æœºä¼šè€Œæ˜¯ç»§ç»­å‰è¡Œæˆ–è€…éœ€è¦è¿”å›ç»“æœï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹çš„æ–¹æ³•ï¼š\nboolean tryLock();\nboolean tryLock(long time, TimeUnit unit) throws InterruptedException;\nä¸€ä¸ªå…¸å‹çš„ç”¨æ³•å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š\n1 2 3 4 5 6 7 8 9 if (lock.tryLock()) { try { // manipulate protected state } finally { lock.unlock(); } } else { // perform alternative actions } ReadWriteLock ReadWriteLockï¼Œâ€œè¯»è¯»å…±äº«ï¼Œè¯»å†™ï¼ˆå†™è¯»ï¼‰äº’æ–¥ï¼Œå†™å†™äº’æ–¥â€ã€‚\n1 final ReadWriteLock readWriteLock = new ReentrantReadWriteLock(); 1 Lock readLock = readWriteLock.readLock(); 1 Lock writeLock = readWriteLock.writeLock(); readLock å’Œ writeLock ç±»ä¼¼äºå…±äº«é”å’Œæ’ä»–é”ã€‚\nSemaphore Semaphoreï¼Œç¿»è¯‘ä¸ºä¿¡å·é‡ï¼Œä¹Ÿå¯å®ç°é”ã€‚\n1 final Semaphore semaphore = new Semaphore(3); 1 semaphore.acquire(); 1 semaphore.release(); å¦‚ä¸Šæ‰€ç¤ºï¼Œåœ¨åŒä¸€æ—¶åˆ»ï¼Œæœ€å¤šåªèƒ½æœ‰ 3 ä¸ªçº¿ç¨‹è·å¾—é”æˆåŠŸã€‚\nåˆ†ç±»ç›®å½• ä¸‹é¢è¿™å¼ å›¾æ¥è‡ªç¾å›¢æŠ€æœ¯å›¢é˜Ÿï¼Œæè¿°äº† Java ä¸»æµé”çš„åˆ†ç±»ç›®å½•ï¼š\nå¤šçº¿ç¨‹ç«äº‰é”æ—¶ï¼ŒæŠ¢ä¸åˆ°é”çš„çº¿ç¨‹ï¼Œå¯èƒ½è¢«è¿«ç­‰å¾…ï¼ˆç­‰å¾…é€šçŸ¥ï¼‰ï¼Œæˆ–è¢«é˜»å¡ï¼ˆç­‰å¾…è·å¾—é”ï¼‰ï¼ŒæŠ‘æˆ–è‡ªæ—‹ã€‚\nåè°ƒ CountDownLatch CountDownLatchï¼Œä¸€ä¸ªå®‰å…¨çš„ä¸”åªèƒ½é€’å‡çš„è®¡æ•°å™¨ï¼Œæ”¯æŒä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¤šä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡åæ¢å¤æ‰§è¡Œã€‚\n1 final CountDownLatch latch = new CountDownLatch(2); ä¸‹é™ï¼š\n1 latch.countDown(); ç­‰å¾…ï¼š\n1 latch.await(3000, TimeUnit.MILLISECONDS); å¦‚ä¸Šæ‰€ç¤ºï¼Œä¸»çº¿ç¨‹è°ƒç”¨ await æ–¹æ³•è¢«è¿«ç­‰å¾…ï¼Œé™¤éè®¾ç½®äº†è¶…æ—¶æ—¶é—´ï¼Œå¦åˆ™ç›´åˆ°æœ€åä¸€ä¸ªå­çº¿ç¨‹å®Œæˆä»»åŠ¡åè°ƒç”¨ countDown æ–¹æ³•æŠŠ latch çš„æ¬¡æ•°å‡å°‘ä¸º 0 æ—¶ï¼Œæ‰èƒ½ç»§ç»­å‰è¡Œã€‚\nCyclicBarrier CyclicBarrierï¼Œè°ƒç”¨ await æ–¹æ³•çš„çº¿ç¨‹è¢«è¿«ç­‰å¾…ï¼Œç›´åˆ°ç»™å®šæ•°é‡çš„çº¿ç¨‹éƒ½åˆ°è¾¾â€œæ …æ â€ï¼ŒåŒæ—¶èµ·è·‘ã€‚\n1 final CyclicBarrier barrier = new CyclicBarrier(8); ç­‰å¾…ï¼š\n1 barrier.await(); AQS å®ƒä»¬æœ€äº²è¿‘çš„çˆ¶ç±»æ˜¯ AbstractQueuedSynchronizerã€‚\nåŸå­ ä¿è¯å¤šçº¿ç¨‹å¹¶å‘è®¿é—®å…±äº«å˜é‡çš„ç¨‹åºæ­£ç¡®ï¼Œæœ‰å¦ä¸€ä¸ªè§£å†³æ–¹æ¡ˆâ€”â€”åŸå­æ“ä½œã€‚\nåŸå­è®¿é—® åœ¨ Java ä¸­ï¼Œå¯¹ä»¥ä¸‹å˜é‡çš„è¯»å–æˆ–å†™å…¥éƒ½å±äºåŸå­è®¿é—®ï¼ˆatomic accessï¼‰ï¼š\nå¼•ç”¨ç±»å‹çš„å˜é‡å’Œå¤§éƒ¨åˆ†åŸå§‹ç±»å‹çš„å˜é‡ï¼ˆé™¤äº† long å’Œ double çš„æ‰€æœ‰ç±»å‹ï¼‰ã€‚\nå£°æ˜ä¸º volatile çš„æ‰€æœ‰å˜é‡ï¼ˆåŒ…æ‹¬ long å’Œ double å˜é‡ï¼‰ã€‚\nåŸå­è®¿é—®æ˜¯æŒ‡ä¸å¯åˆ†ä¸”ä¸å¯ä¸­æ–­çš„æ“ä½œï¼ŒåŸå­è®¿é—®è¦ä¹ˆå®Œå…¨å‘ç”Ÿï¼Œè¦ä¹ˆæ ¹æœ¬ä¸å‘ç”Ÿã€‚è™½ç„¶å•ä¸€åŸå­è®¿é—®é¿å…äº†çº¿ç¨‹å¹²æ‰°ï¼Œä½†æ˜¯ä¸ä»£è¡¨ä¸€ç»„åŸå­è®¿é—®å¯ä»¥é˜²æ­¢å†…å­˜ä¸€è‡´æ€§é”™è¯¯ã€‚\nä½¿ç”¨ volatile å¯é™ä½å†…å­˜ä¸€è‡´æ€§é”™è¯¯çš„é£é™©ï¼Œå› ä¸ºä»»ä½•å¯¹ volatile å˜é‡çš„å†™å…¥éƒ½ä¼šä¸è¯¥å˜é‡çš„åç»­è¯»å–å»ºç«‹å…ˆå‘ç”Ÿåœ¨å‰çš„å…³ç³»ï¼ˆhappens-before relationshipï¼‰ã€‚æ¢è¨€ä¹‹ï¼Œå¯¹ volatile å˜é‡çš„æ›´æ”¹å§‹ç»ˆå¯¹å…¶å®ƒçº¿ç¨‹å¯è§ï¼Œå³çº¿ç¨‹è¯»å–çš„ volatile å˜é‡æ€»æ˜¯æœ€æ–°çš„ã€‚ä» The Java Virtual Machine Specification, Java SE 8 Edition # 4.5. Fields å¯ä»¥å‘ç°ï¼ŒACC_VOLATILE è¿™ä¸ª flag è§£é‡Šä¸º volatile å˜é‡å°†æ°¸è¿œä¸è¢« CPU ç¼“å­˜ã€‚ï¼Œåªè¦ JVM éµå¾ªäº†è¿™ä¸ªè§„èŒƒé¡¹ï¼Œåˆ™çº¿ç¨‹åªä¼šä»ä¸»å­˜ä¸­è¯»å–è€Œä¸æ˜¯ä»å…¶å®ƒé«˜é€Ÿç¼“å­˜ã€‚volatile å¦ä¸€ä¸ªä½œç”¨æ˜¯é¿å…æŒ‡ä»¤é‡æ’å¯¼è‡´çº¿ç¨‹å¯¹å˜é‡çš„æ›´æ”¹ä¸å¯è§ï¼Œå› ä¸ºç°åœ¨çš„ HotSpot VM é»˜è®¤å¼€å¯äº† JIT ç¼–è¯‘å™¨ï¼ˆJust-in-time compilerï¼‰ï¼Œåœ¨è¿è¡Œæ—¶ JIT å¯èƒ½åº”ç”¨æŒ‡ä»¤é‡æ’ä¼˜åŒ–ã€‚\nå›æƒ³å‰æ–‡æ‰€è®¨è®ºçš„â€œéçº¿ç¨‹å®‰å…¨â€ä¸­çš„è®¡æ•°å™¨ï¼ˆCounterï¼‰ï¼ŒéåŒæ­¥çš„â€œå½“å‰å€¼åŠ ä¸€â€åˆ†è§£å‡ºæ¥çš„ä¸‰ä¸ªæ­¥éª¤æ˜¯åŸå­è®¿é—®ï¼Œä½†æ˜¯è¯•éªŒè¯æ˜ï¼Œå‡ºç°äº†ç›¸äº’è¦†ç›–æˆ–ä¸¢å¤±æ›´æ”¹ã€‚ç”±ä¸Šä¸€æ®µå¯çŸ¥ï¼Œå³ä½¿ä½¿ç”¨ volatile ä¿®é¥° Counter çš„ count å­—æ®µï¼ŒéåŒæ­¥çš„â€œå½“å‰å€¼åŠ ä¸€â€ä»ç„¶ä¼šå‡ºç°å†…å­˜ä¸€è‡´æ€§é”™è¯¯ã€‚\nåˆ°æ­¤ä¸ºæ­¢ï¼Œéš¾é“åªèƒ½ä½¿ç”¨ synchronized æˆ– Java é”é˜²æ­¢çº¿ç¨‹å¹²æ‰°å’Œå†…å­˜ä¸€è‡´æ€§é”™è¯¯ï¼Ÿç„¶è€Œå¹¶ä¸æ˜¯ï¼Œè¿˜æœ‰ä¸€ç§ volatile å˜é‡ç»„åˆ CAS å¾ªç¯çš„æ–¹æ¡ˆï¼Œå…¶å®å‰é¢â€æƒ¯ç”¨é”â€œä¸­æ‰€è¯´çš„ ReentrantLock çš„å®ç°ä¹Ÿä½¿ç”¨äº† CASã€‚\nCAS åœ¨â€œé”â€ä¸­ç¬¬ä¸€æ¬¡æåˆ°äº† compare-and-swap è¿™ä¸ªæŒ‡ä»¤ï¼Œè€Œåœ¨â€œåå‘é”å’Œè½»é‡çº§é”ä»¥åŠé‡é‡çº§é”â€ä¸­ä¹Ÿæåˆ°äº† CASã€‚CAS çš„å®ç°é€šå¸¸éœ€è¦ç¡¬ä»¶å±‚çš„æ”¯æŒï¼Œç”šè‡³å¯èƒ½åœ¨ç¡¬ä»¶å±‚è§åˆ°ç±»ä¼¼äºè½¯ä»¶å±‚çš„é”æ¦‚å¿µã€‚\nç°åœ¨ç”¨å…¨æ–°çš„ AtomicCounter æ¥ä»£æ›¿é‚£ä¸ªæ··æ‚çš„ Counterã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public class AtomicCounter { private AtomicLong count = new AtomicLong(0); public void increment() { long current, next; while (true) { current = count.get(); next = current + 1; if (count.compareAndSet(current, next)) { return; } } } public long value() { return count.get(); } } ä½¿ç”¨ AtomicLong ä»£æ›¿ longï¼Œå®ƒç»´æŠ¤äº†ä¸€ä¸ªç”¨ volatile ä¿®é¥°çš„ long å­—æ®µã€‚\nä½¿ç”¨æ ¸å¿ƒæ˜¯ CAS çš„æ–¹æ³•ï¼ˆCAS å¾ªç¯ï¼‰ä»£æ›¿ä½¿ç”¨ synchronized çš„æ–¹æ³•ã€‚\nå…¶ä¸­æ–°çš„ increment æ–¹æ³•çš„å¾ªç¯ä½“å†…çš„å‰ä¸¤ä¸ªæ­¥éª¤å’Œåœ¨ â€œéçº¿ç¨‹å®‰å…¨â€ æ‰€åˆ†è§£çš„å‰ä¸¤ä¸ªæ­¥éª¤æ˜¯ä¸€è‡´çš„ï¼Œç¬¬ä¸‰ä¸ªæ­¥éª¤æ˜¯å…³é”®ï¼š\n1 count.compareAndSet(current, next) å½“æœ‰å¤šä¸ªçº¿ç¨‹å¹¶å‘è°ƒç”¨ increment æ–¹æ³•ï¼Œåˆ°äº†ç¬¬ä¸‰ä¸ªæ­¥éª¤ï¼ŒæŸä¸€ä¸ªçº¿ç¨‹æ¯”è¾ƒ count ç»‘å®šçš„å­—æ®µä¸å®ƒå‰ä¸€æ¬¡è¯»å–çš„ current å˜é‡æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™æŠŠ count ç»‘å®šçš„å­—æ®µçš„å€¼è®¾ä¸º next çš„å€¼ï¼Œincrement æ–¹æ³•è¿”å›ï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™è¡¨æ˜ count ç»‘å®šçš„å­—æ®µå·²è¢«å…¶å®ƒçº¿ç¨‹æ›´æ”¹ï¼ŒcompareAndSet æ–¹æ³•è¿”å› falseï¼Œè·³åˆ°ç¬¬ä¸€æ­¥ï¼Œç»§ç»­å°è¯•ã€‚ç«äº‰è¶³å¤Ÿæ¿€çƒˆæ—¶ï¼Œç›¸æ¯”äº synchronizedï¼Œvolatile å˜é‡ç»„åˆ CAS å¾ªç¯æ˜¯éé˜»å¡æ–¹æ¡ˆã€‚\ncompareAndSet æ–¹æ³•çœ‹ä¼¼å¯åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼Œå®é™…ä¸Šåœ¨åº•å±‚ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸å¯åˆ†ä¸”ä¸å¯ä¸­æ–­çš„åŸå­æŒ‡ä»¤ï¼Œå³ä»æ¯”è¾ƒå¼€å§‹åˆ°èµ‹å€¼ç»“æŸæœ‰ä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ­¤ä»»åŠ¡ã€‚è¯¥æ–¹æ³•ä¹‹æ‰€ä»¥å¯èƒ½è¿”å› falseï¼Œåˆ™æ˜¯å› ä¸ºæœ‰å¯èƒ½ä¸€ä¸ªçº¿ç¨‹èµ‹å€¼ç»“æŸï¼Œä¸æ­¤åŒæ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¼€å§‹æ¯”è¾ƒã€‚\nåŒæ ·ï¼Œä¹Ÿç»™ AtomicCounter å†™æµ‹è¯•ç±»ï¼Œè¿™ä¸€æ¬¡çº¿ç¨‹åŠ ä¸€ï¼Œæ¬¡æ•°åŠ ä¸€ç™¾ä¸‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 public class AtomicCounterTest { private static final long wait = 3000; private final long threads = 3; private final long times = 2000000; private final long excepted = threads * times; @Test public void testIncrement() throws InterruptedException { AtomicCounter counter = new AtomicCounter(); startThreads(counter, () -\u0026gt; { for (int j = 0; j \u0026lt; times; j++) { counter.increment(); } System.out.printf(\u0026#34;threadName: %s, counterValue: %s\\n\u0026#34;, Thread.currentThread().getName(), counter.value()); }); Assert.assertEquals(excepted, counter.value()); } private void startThreads(AtomicCounter counter, Runnable runnable) throws InterruptedException { for (int i = 0; i \u0026lt; threads; i++) { new Thread(runnable).start(); } Thread.sleep(AtomicCounterTest.wait); System.out.printf(\u0026#34;threadName: %s, exceptedCounterValue: %s, actualCounterValue: %s\\n\u0026#34;, Thread.currentThread().getName(), excepted, counter.value()); } } ç»“æœæœç„¶æ­£ç¡®ï¼š\näº‹å®ä¸Šï¼ŒJDK å·²ç»æä¾›äº†è®¸å¤šæ“ä½œåŸå­ç±»å‹å®ä¾‹çš„åŸå­æ–¹æ³•ï¼Œä¸Šæ–‡æœ€æ–°ç‰ˆçš„â€œå½“å‰å€¼åŠ ä¸€â€æ–¹æ³•è¿‡äºå•°å—¦ï¼Œå®é™…å¼€å‘ä¸­è¯·ç›´æ¥ä½¿ç”¨åŸå­ç±»çš„ incrementAndGet æ–¹æ³•ã€‚ç¿»é˜…æºç å¯ä»¥çŸ¥é“ï¼ŒåŸå­ç±»çš„ compareAndSet æ–¹æ³•ä½¿ç”¨äº† sun.misc.Unsafe çš„ compareAndSwap æ–¹æ³•ï¼š\n1 2 3 4 5 public final native boolean compareAndSwapObject(Object var1, long var2, Object var4, Object var5); public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5); public final native boolean compareAndSwapLong(Object var1, long var2, long var4, long var6); æ³¨æ„å…¶ä¸­çš„ nativeï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹å±‚çš„ compareAndSwap å‡½æ•°ç”± C/C++ å®ç°ï¼Œè€Œ Java ç¨‹åºå¯é€šè¿‡ JNI è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚ è™½ç„¶ JDK æ²¡æœ‰åŒ…å« sun.misc.Unsafe çš„æºæ–‡ä»¶ï¼Œä½†æ˜¯é€šè¿‡å¯¹ Unsafe.classåç¼–è¯‘ï¼Œå¯ä»¥ç¡®å®š incrementAndGet æ–¹æ³•åŒæ ·ä½¿ç”¨äº† CAS å‡½æ•°ï¼Œå¹¶ä¸”ä¹Ÿä½¿ç”¨ CAS å¾ªç¯ã€‚\n1 2 3 public final long incrementAndGet() { return unsafe.getAndAddLong(this, valueOffset, 1L) + 1L; } æŸ¥çœ‹å…·ä½“å®ç°ï¼š\n1 2 3 4 5 6 7 8 public final long getAndAddLong(Object var1, long var2, long var4) { long var6; do { var6 = this.getLongVolatile(var1, var2); } while(!this.compareAndSwapLong(var1, var2, var6, var6 + var4)); return var6; } æ³¨æ„ï¼Œä¸Šæ–‡è®¨è®ºçš„è®¡æ•°å™¨åœ¨é«˜å¹¶å‘åœºæ™¯ä¸­ä¸ä¸€å®šæ˜¯æœ€ä¼˜çš„æ–¹æ¡ˆï¼Œè¯·çœ‹ LongAdder å’Œ LongAccumulatorã€‚\nåŸå­ç±» è¿™ä¸ª java.util.concurrent.atomic åŒ…å®šä¹‰äº†æ”¯æŒå¯¹å•ä¸ªå˜é‡è¿›è¡ŒåŸå­æ“ä½œçš„ç±»ã€‚\nå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒAtomicReference* ç”¨äºé˜²æ­¢å¤šçº¿ç¨‹å¹¶å‘æ“ä½œå¼•ç”¨ç±»å‹å®ä¾‹å‡ºç°çº¿ç¨‹å¹²æ‰°å’Œå†…å­˜ä¸€è‡´æ€§é”™è¯¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public class LinkedList\u0026lt;Item\u0026gt; { private Node\u0026lt;Item\u0026gt; first; static class Node\u0026lt;Item\u0026gt; { Item item; Node\u0026lt;Item\u0026gt; next; } public void push(Item item) { Node\u0026lt;Item\u0026gt; oldFirst = first; first = new Node\u0026lt;\u0026gt;(); first.item = item; first.next = oldFirst; } } å¦‚ä¸Šæ‰€ç¤ºï¼Œä¸€ä¸ªç®€ç•¥çš„é“¾è¡¨ï¼ˆLinkedListï¼‰ï¼Œç»´æŠ¤äº†ä¸€ä¸ªé¦–ç»“ç‚¹ï¼ˆfirstï¼‰ï¼Œpush æ–¹æ³•ç”¨äºåœ¨é“¾è¡¨è¡¨å¤´æ’å…¥ç»“ç‚¹ï¼Œå½“å¤šçº¿ç¨‹å¹¶å‘è°ƒç”¨åŒä¸€ä¸ª LinkedList å®ä¾‹çš„ push æ–¹æ³•æ—¶ï¼Œå®ƒä»¬å­˜å‚¨äº†å„è‡ªçš„è€é¦–ç»“ç‚¹ï¼ˆNode oldFirst = first;ï¼‰ï¼Œå®ƒä»¬æ–°å»ºäº†å„è‡ªçš„æ–°é¦–ç»“ç‚¹ï¼ˆnew Node\u0026lt;\u0026gt;();ï¼‰ï¼Œç„¶åæŠŠ first æŒ‡å‘å„è‡ªçš„ç»“ç‚¹ï¼ˆfirst = new Node\u0026lt;\u0026gt;();ï¼‰ï¼Œå› ä¸º first æ˜¯å®ƒä»¬çš„å…±äº«å˜é‡ï¼Œæ‰€ä»¥å¯èƒ½å·²ç»å‡ºç°ç›¸äº’è¦†ç›–æˆ–ä¸¢å¤±æ›´æ”¹ï¼Œæ›´ä¸ç”¨è¯´åé¢äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 public class LinkedList\u0026lt;Item\u0026gt; { private Node\u0026lt;Item\u0026gt; first; static class Node\u0026lt;Item\u0026gt; { Item item; Node\u0026lt;Item\u0026gt; next; } public void push(Item item) { Node\u0026lt;Item\u0026gt; oldFirst = first; Node\u0026lt;Item\u0026gt; newFirst = new Node\u0026lt;\u0026gt;(); newFirst.item = item; newFirst.next = oldFirst; first = newFirst; } } å†å¦‚ä¸Šæ‰€ç¤ºï¼Œä¸ºäº†ä½¿é—®é¢˜æ¸…æ™°ï¼Œåªåœ¨ push æ–¹æ³•æœ€åä¸€æ­¥æ‰è®¾ç½® firstã€‚åŒæ ·ä¹Ÿå› ä¸º first æ˜¯å®ƒä»¬çš„å…±äº«å˜é‡ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½æ‰§è¡Œå®Œæœ€åä¸€æ­¥åï¼Œå¯èƒ½å‡ºç°ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹çš„æ–°é¦–ç»“ç‚¹æ¸¸ç¦»äºé“¾è¡¨ä¹‹å¤–ï¼Œå› æ­¤ï¼Œæ”¹ç”¨ CAS æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public class AtomicLinkedList\u0026lt;Item\u0026gt; { private AtomicReference\u0026lt;Node\u0026lt;Item\u0026gt;\u0026gt; first = new AtomicReference\u0026lt;\u0026gt;(); static class Node\u0026lt;Item\u0026gt; { Item item; Node\u0026lt;Item\u0026gt; next; } public void push(Item item) { Node\u0026lt;Item\u0026gt; newFirst = new Node\u0026lt;\u0026gt;(); newFirst.item = item; Node\u0026lt;Item\u0026gt; oldFirst; while (true) { oldFirst = first.get(); newFirst.next = oldFirst; if (first.compareAndSet(oldFirst, newFirst)) { return; } } } } å¦‚æœè¿˜å®ç°äº†åˆ é™¤ç»“ç‚¹çš„æ–¹æ³•ï¼Œåˆ™è¦å°å¿ƒ ABA é—®é¢˜ï¼Œè¿™æ—¶å¯è€ƒè™‘ä½¿ç”¨ AtomicStampedReferenceã€‚\nCollections BlockingQueue çº¿ç¨‹çº§çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜çš„å®è´¨æ˜¯åˆ†ä¸ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä¸¤ç»„çº¿ç¨‹å…±äº«åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…æš‚ä¸èƒ½ä»é˜Ÿåˆ—æ‹‰å–å…ƒç´ ï¼Œé™¤éé˜Ÿåˆ—éç©ºï¼Œç”Ÿäº§è€…æš‚ä¸èƒ½æ¨é€å…ƒç´ åˆ°é˜Ÿåˆ—ï¼Œé™¤éé˜Ÿåˆ—éæ»¡ã€‚BlockingQueue æ—¢æœ‰åŸºäºæ•°ç»„çš„å®ç°ï¼Œä¹Ÿæœ‰åŸºäºé“¾è¡¨çš„å®ç°ï¼Œå¯ç”¨æ¥è§£å†³ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼ˆæ¯”å¦‚ BlockingQueueDemoï¼‰ï¼Œå½“é˜»å¡é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œçº¿ç¨‹ä»é˜»å¡é˜Ÿåˆ—æ‹‰å–å…ƒç´ æ—¶ä¼šè¢«é˜»å¡æˆ–è¢«è¿«ç­‰å¾…ï¼Œå½“é˜»å¡é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œçº¿ç¨‹æ¨é€å…ƒç´ åˆ°é˜»å¡é˜Ÿåˆ—ä¼šè¢«é˜»å¡æˆ–è¢«è¿«ç­‰å¾…ã€‚\nLinkedBlockingDeque å’Œ ArrayBlockingQueue å‡ä½¿ç”¨äº† Conditionï¼Œç»´æŠ¤äº†é˜Ÿåˆ—éæ»¡æ¡ä»¶å˜é‡å’Œé˜Ÿåˆ—éç©ºæ¡ä»¶å˜é‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé€šçŸ¥çš„å®ç°åŸºäºä¸Šæ–‡ \u0026ldquo;é€šçŸ¥\u0026rdquo; ä¸­æåˆ°çš„ park/unparkã€‚\næœ¬è´¨ä¸Šï¼ŒCondition å®ä¾‹ä¸ Lock å®ä¾‹ç»‘å®šï¼Œé€šè¿‡ Lock å®ä¾‹çš„ newCondition æ–¹æ³•å¯æ–°å»º Condition å®ä¾‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 class BoundedBuffer { final Lock lock = new ReentrantLock(); final Condition notFull = lock.newCondition(); final Condition notEmpty = lock.newCondition(); final Object[] items = new Object[100]; int putptr, takeptr, count; public void put(Object x) throws InterruptedException { lock.lock(); try { while (count == items.length) notFull.await(); items[putptr] = x; if (++putptr == items.length) putptr = 0; ++count; notEmpty.signal(); } finally { lock.unlock(); } } public Object take() throws InterruptedException { lock.lock(); try { while (count == 0) notEmpty.await(); Object x = items[takeptr]; if (++takeptr == items.length) takeptr = 0; --count; notFull.signal(); return x; } finally { lock.unlock(); } } } ConcurrentMap ConcurrentMap æ˜¯ Map çš„å­æ¥å£ï¼Œå®ƒå®šä¹‰äº†æœ‰ç”¨çš„åŸå­æ“ä½œï¼Œä¾‹å¦‚ï¼Œä»…åœ¨é”®å­˜åœ¨æ—¶æ‰åˆ é™¤æˆ–æ›¿æ¢é”®å€¼å¯¹ï¼Œæˆ–ä»…åœ¨é”®ä¸å­˜åœ¨æ—¶æ‰æ·»åŠ é”®å€¼å¯¹ï¼Œå…¶ä¸­ä¸€ä¸ªæ ‡å‡†å®ç°æ˜¯ ConcurrentHashMapï¼Œå®ƒæ˜¯ HashMap çš„çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬ã€‚\nJDK 7 çš„ HashMap æ˜¯åŸºäºæ‹‰é“¾æ³•çš„æ•£åˆ—è¡¨ã€‚\nå¦‚ä¸Šé¢è¿™å¼ æ¥è‡ª algs4 çš„å›¾æ‰€ç¤ºï¼Œæ•£åˆ—è¡¨æ˜¯ä¸€ç§ç¬¦å·è¡¨ï¼ˆsymbol tableï¼‰ï¼Œç¬¦å·è¡¨æ˜¯ä¸€ç§å­˜å‚¨é”®å€¼å¯¹çš„æ•°æ®ç»“æ„ï¼Œæ”¯æŒä¸¤ç§æ“ä½œï¼š\næ’å…¥ï¼ˆputï¼‰ã€‚æŸ¥æ‰¾ç»™å®šçš„é”®æ˜¯å¦å‘½ä¸­ï¼Œè‹¥å‘½ä¸­ï¼Œåˆ™æ›´æ–°å¯¹åº”çš„å€¼ï¼Œè‹¥æœªå‘½ä¸­ï¼Œåˆ™æ’å…¥é”®å€¼å¯¹ã€‚\næŸ¥æ‰¾ï¼ˆgetï¼‰ã€‚é€šè¿‡ç»™å®šçš„é”®å¾—åˆ°ç›¸åº”çš„å€¼ã€‚\nåŸºäºæ‹‰é“¾æ³•çš„æ•£åˆ—è¡¨ç»´æŠ¤äº†å…ƒç´ ç±»å‹æ˜¯é“¾è¡¨çš„æ•°ç»„ï¼Œå®ƒçš„æŸ¥æ‰¾ç®—æ³•å¯åˆ†ä¸ºä¸¤æ­¥ï¼š\nä½¿ç”¨ Hash å‡½æ•°å°†ç»™å®šçš„é”®è½¬åŒ–ä¸ºæ•°ç»„çš„ç´¢å¼•ã€‚\nåœ¨é“¾è¡¨ä¸­æŸ¥æ‰¾ç»™å®šçš„é”®ï¼Œè¿”å›å¯¹åº”çš„å€¼ã€‚\nå¦‚ä¸‹é¢è¿™å¼ æ¥è‡ª Java HashMap internals çš„å›¾æ‰€ç¤ºï¼Œåœ¨ HashMap ä¸­ï¼Œæ•°ç»„å…ƒç´ ç§°ä¸º bucket æˆ– binï¼Œé“¾è¡¨ç»“ç‚¹ç§°ä¸º entryã€‚\nJDK 8 åœ¨ HashMap ä¸­å¼•å…¥çº¢é»‘æ ‘ä»¥ä¼˜åŒ–æŸ¥æ‰¾ç®—æ³•ã€‚å½“ä¸€ä¸ªæ¡¶çš„å¤§å°ï¼ˆé“¾è¡¨å¤§å°ï¼‰å¤§äºç­‰äºæ ‘åŒ–é˜ˆå€¼ï¼ˆTREEIFY_THRESHOLDï¼‰ä¸”æ¡¶çš„æ•°é‡ï¼ˆæ•°ç»„é•¿åº¦ï¼‰å¤§äºç­‰äº 64ï¼Œè¯¥æ¡¶å°†è½¬åŒ–ä¸ºä¸€é¢—çº¢é»‘æ ‘ï¼Œå½“ä¸€ä¸ªæ¡¶çš„å¤§å°å°äºç­‰äºè§£æ ‘é˜ˆå€¼ï¼ˆTREEIFY_THRESHOLDï¼‰ï¼Œè¯¥æ¡¶å°†è½¬åŒ–ä¸ºé“¾è¡¨ã€‚è¯´åˆ°çº¢é»‘äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œä¸å¾—ä¸å…ˆè¯´äºŒå‰æŸ¥æ‰¾æ ‘å’Œ 2-3 æŸ¥æ‰¾æ ‘ï¼Œæœªæ¥å°†å¼€å¯ HashMap çš„æ–°ç¯‡ç« ã€‚\nç¿»é˜…æºç å¯ä»¥çŸ¥é“ï¼Œä¾‹å¦‚ ConcurrentHashMap#put æ–¹æ³•ï¼ŒConcurrentHashMap ä½¿ç”¨ CAS å’Œ synchronized é˜²æ­¢å¤šçº¿ç¨‹å¹¶å‘è®¿é—®å®ƒç»´æŠ¤çš„é“¾è¡¨æˆ–çº¢é»‘æ ‘æ—¶å‡ºç°çº¿ç¨‹å¹²æ‰°å’Œå†…å­˜ä¸€è‡´æ€§é”™è¯¯ã€‚\nä¸€æˆä¸å˜ å¦‚æœä¸€ä¸ªå…±äº«å¯¹è±¡çš„çŠ¶æ€åªè¯»ï¼Œå°±ä¸å­˜åœ¨çº¿ç¨‹å¹²æ‰°å’Œå†…å­˜ä¸€è‡´æ€§é”™è¯¯ï¼Œè€Œä¸”åªè¦å°è¯•æ”¹å†™çŠ¶æ€æ—¶ï¼Œæ¯æ¬¡éƒ½æ–°å»ºä¸åŒçŠ¶æ€çš„è¿™ç§å¯¹è±¡å¹¶è¿”å›ï¼Œå®Œç¾åˆ¶é€ äº†çŠ¶æ€å¯å˜çš„å‡è±¡ï¼ˆæƒ³è±¡ä¸€ä¸‹æ‰‹ç¿»ä¹¦ï¼‰ï¼Œä¹Ÿå°±ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚è¿™ç§å¯¹è±¡ï¼Œè¢«ç§°ä¸ºä¸å¯å˜å¯¹è±¡ï¼ˆImmutable Objectsï¼‰ã€‚å®šä¹‰ä¸å¯å˜å¯¹è±¡çš„ç­–ç•¥ï¼Œå¯å‚è€ƒ A Strategy for Defining Immutable Objectsã€‚\nã€ŠThe Joy of Clojure, second-editionã€‹ï¼Œ1.4. Why Clojure isnâ€™t especially object-orientedï¼Œä½œè€…å¯¹ä¸å¯å˜çš„å’Œå¯å˜çš„åšäº†å¾ˆæ£’çš„ç±»æ¯”ã€‚\nåè®° å•æœºå¯ä»¥è¿è¡Œæ•°ç™¾ä¸‡ä¸ª Go åç¨‹ï¼ˆGoroutineï¼‰ï¼Œå´åªèƒ½è¿è¡Œæ•°åƒä¸ª Java çº¿ç¨‹ã€‚ç°åœ¨çš„ Java HotSpot VMï¼Œé»˜è®¤ä¸€ä¸ª Java çº¿ç¨‹å æœ‰ 1 M çš„æ ˆï¼ˆä»¥å‰æ˜¯ 256Kï¼‰ï¼Œè€Œä¸”æ˜¯å¤§å°å›ºå®šçš„æ ˆï¼Œè€Œ Go åç¨‹çš„æ ˆæ˜¯å¤§å°å¯å˜çš„æ ˆï¼Œå³éšç€å­˜å‚¨çš„æ•°æ®é‡å˜åŒ–è€Œå˜åŒ–ï¼Œå¹¶ä¸”åˆå§‹å€¼ä»…ä¸º 4 KBã€‚ç¡®å®ï¼Œè¿è¡Œè¿‡å¤šçš„ Java çº¿ç¨‹å®¹æ˜“å¯¼è‡´ out of memoryï¼Œè€Œä¸” Java çº¿ç¨‹ä¸å†…æ ¸çº¿ç¨‹ï¼ˆåŸç”Ÿçº¿ç¨‹ï¼‰æ˜¯ 1:1 æ˜ å°„ï¼Œé‚£ä¹ˆè¿‡å¤šçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¹Ÿä¼šå¼•èµ·åº”ç”¨ç¨‹åºè¾ƒå¤§å»¶è¿Ÿï¼›Go åç¨‹ä¸å†…æ ¸çº¿ç¨‹ï¼ˆåŸç”Ÿçº¿ç¨‹ï¼‰æ˜¯å¤šå¯¹ä¸€æ˜ å°„ï¼ŒGo å®ç°äº†è‡ªå·±çš„åç¨‹è°ƒåº¦å™¨ï¼Œå®é™…ä¸Šè¦è¿è¡Œæ•°ç™¾ä¸‡ä¸ªåç¨‹ï¼ŒGo éœ€è¦åšå¾—äº‹æƒ…è¦å¤æ‚å¾—å¤šã€‚\nè‹¥åªè®¨è®º Java å•ä½“åº”ç”¨æ‰¿å—é«˜å¹¶å‘çš„åœºæ™¯ï¼Œå³ä½¿æ‰©å¤§çº¿ç¨‹æ± ä¹Ÿä¸èƒ½æ˜¾è‘—æé«˜æ€§èƒ½æˆ–é€‚å¾—å…¶åï¼Œç›¸åï¼Œå°‘é‡çš„çº¿ç¨‹å°±èƒ½å¤„ç†æ›´å¤šçš„è¿æ¥ï¼Œæ¯”å¦‚ï¼ŒNettyã€‚å¦‚æœä»ç„¶è®¤ä¸ºé‡é‡çº§çš„ Java çº¿ç¨‹æ˜¯ç“¶é¢ˆï¼Œå¹¶ä¸”è¿˜æƒ³ä½¿ç”¨ Java çš„è¯ï¼Œä¸å¦¨å°è¯• Quasarï¼Œå®ƒæ˜¯ä¸€ä¸ªæä¾›çº¤ç¨‹å’Œç±»ä¼¼äº Go çš„ Channel ä»¥åŠç±»ä¼¼äº Erlang çš„ Actor çš„ Java åº“ã€‚\nè™½ç„¶è¿›ç¨‹ä¹‹é—´ä¸ä¸€å®šå…±äº«æœ¬æœºèµ„æºï¼Œä½†æ˜¯çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥å¯ä»¥æ¨å¹¿åˆ°è¿›ç¨‹ä¹‹é—´çš„åŒæ­¥ï¼Œæ¯”å¦‚ï¼Œåˆ†å¸ƒå¼é”ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä»£ç ä¸€è‡´çš„å¤šä¸ªè¿›ç¨‹å¯èƒ½å…±äº«åŒä¸€ä¸ªæ•°æ®åº“ï¼Œæ•°æ®åº“æ”¯æŒå¹¶å‘æ§åˆ¶ï¼Œæ¯”å¦‚ï¼Œå…±äº«é”å’Œæ’ä»–é”ä»¥åŠ MVCCã€‚\næ–‡ä¸­ä»£ç  éƒ¨åˆ†ä»£ç å·²å‘å¸ƒï¼Œå¯æŸ¥çœ‹ concurrentã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå¸æ”¶æ›´å¤š æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆåŸä¹¦ç¬¬3ç‰ˆï¼‰\nThread (computing)\n~jbell/CourseNotes/OperatingSystems/4_Threads\nImplementing threads :: Operating systems 2018\nHotSpot Runtime Overview # Thread Management\nJVMä¸­çš„çº¿ç¨‹æ¨¡å‹æ˜¯ç”¨æˆ·çº§çš„ä¹ˆï¼Ÿ\nHow Java thread maps to OS thread\nHotSpot JVM internal threads\nJava Tutorials # Concurrency # Guarded Blocks\nThread pool\nJava Tutorials # Concurrency # Thread Pools\nJava Tutorials # Concurrency # Fork/Join\nForkâ€“join model\nGuide To CompletableFuture\nJava Tutorials # Collections # Streams # Parallelism\nJava Tutorials # Concurrency # Synchronization\nThe Java Language Specification, Java SE 8 Edition # Chapter 17. Threads and Locks\nHotSpot Runtime Overview # Synchronization\nOpenJDK Wiki # HotSpot # Synchronization and Object Locking\nThe Java Virtual Machine Specification, Java SE 8 Edition # 2.11.10. Synchronization\nThe Hotspot Java Virtual Machine by Paul Hohensee\nã€æ­»ç£•Javaå¹¶å‘ã€‘\u0026mdash;\u0026ndash;æ·±å…¥åˆ†æsynchronizedçš„å®ç°åŸç†\nLock Lock Lock: Enter!\nInside the Java Virtual Machine by Bill Venners # Thread Synchronization\nBiased Locking in HotSpot\nHotSpotGlossary\nLock (computer science)\nMutual exclusion\nSynchronization (computer science)\nMonitor (synchronization)\nUnderstand the object internally\nå•ä¾‹æ¨¡å¼\u0026ndash;åŒé‡æ£€éªŒé”çœŸçš„çº¿ç¨‹å®‰å…¨å—\nKnow Thy Java Object Memory Layout\nã€åŸºæœ¬åŠŸã€‘ä¸å¯ä¸è¯´çš„Javaâ€œé”â€äº‹\nç å†œç¿»èº«ï¼šç”¨æ•…äº‹ç»™æŠ€æœ¯åŠ ç‚¹æ–™\nJava Tutorials # Concurrency # Atomic Access\nJava Tutorials # Concurrency # Atomic Variables\nèŠèŠå¹¶å‘ï¼ˆäº”ï¼‰â€”â€”åŸå­æ“ä½œçš„å®ç°åŸç†\nJava Tutorials # Concurrency\nå”¯å“ä¼š Java å¼€å‘æ‰‹å†Œ (ä¹) å¹¶å‘å¤„ç†\nWhy you can have millions of Goroutines but only thousands of Java Threads\nJavaä¸­çš„çº¤ç¨‹åº“ - Quasar\nç»§ç»­äº†è§£Javaçš„çº¤ç¨‹åº“ - Quasar\nThe actor model in 10 minutes - Brian Storti\n","date":"2020-02-21T17:47:30+08:00","permalink":"https://h2cone.github.io/2020/02/21/thread_concurrent/","title":"å¤šçº¿ç¨‹Â·å¹¶å‘ç¼–ç¨‹"},{"content":"æ’ä»¶ æˆ‘ä»¬æ—©å·²çŸ¥é“ MyBatis è‡ªèº«æ”¯æŒå®¢æˆ·ç«¯åˆ†é¡µï¼ˆRowBoundsï¼‰, å³ä»æ•°æ®åº“è·å–å…¨éƒ¨ç›®æ ‡æ•°æ®ï¼Œåœ¨å†…å­˜ä¸­å¯¹ç»“æœé›†è¿›è¡Œåˆ†é¡µï¼Œè™½ç„¶é€‚ç”¨äºä¸åŒæ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®é‡è¶³å¤Ÿå¤§æ—¶ Java ç¨‹åºå¯èƒ½å‘ç”Ÿå†…å­˜æº¢å‡ºï¼›è‹¥é‡‡ç”¨æ•°æ®åº“æœåŠ¡å™¨ç«¯åˆ†é¡µï¼Œå³ä»æ•°æ®åº“è·å–éƒ¨åˆ†ç›®æ ‡æ•°æ®ï¼Œä¾‹å¦‚å‘ MySQL æ•°æ®åº“å‘é€ä½¿ç”¨äº† LIMIT æˆ– OFFSETå…³é”®è¯çš„ SQLï¼Œè¿˜æŒºç®€å•ï¼Œå¯æ˜¯ç›´æ¥ä½¿ç”¨ MyBatis åšæ•°æ®åº“åˆ†é¡µä»ç„¶æœ‰ä¸€äº›ç—›ç‚¹ï¼š\né‡å¤ç¼–å†™åˆ†é¡µã€æ±‚æ€»è®°å½•æ•°ã€æ’åºè¯­å¥ã€‚\nè¯­æ³•ä¸åŒï¼Œä¸é€‚ç”¨äºå…¶å®ƒæ•°æ®åº“ã€‚\né‚£ä¸å¦‚æ”¹ç”¨ Hibernate ï¼Ÿè¿˜çœŸä¸ä¸€å®šï¼Œå›½äººåçˆ± MyBatisï¼Œä»¥è‡³äºä½¿ç”¨æ’ä»¶æ¥å¢å¼º MyBatisï¼Œæ¯”å¦‚ Mybatis-PageHelperï¼Œä¸€ä¸ªé€šç”¨çš„ MyBatis åˆ†é¡µæ’ä»¶ã€‚æƒ³ä¸åˆ° MyBatis è¿˜æŒºçµæ´»ï¼Œæ”¯æŒæ’ä»¶æœºåˆ¶ã€‚ä»”ç»†ç¿»é˜…å®˜æ–¹æ–‡æ¡£å¯ä»¥ç¡®å®š MyBatis å…è®¸ä½ åœ¨ Mapper æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æŸäº›ç‚¹æ‹¦æˆªè°ƒç”¨ï¼Œå·²ç»çŸ¥æ™“åŠ¨æ€ä»£ç†çš„æœ‹å‹ä»¬ï¼ˆå‚è§åˆ‡é¢å’ŒåŠ¨æ€ä»£ç†ä»¥åŠå­—èŠ‚ç ï¼‰ï¼Œå½·ä½›çœ‹é€äº† MyBatis æ’ä»¶ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼ŒMyBatis å…è®¸æ’ä»¶æ‹¦æˆªä»¥ä¸‹æ–¹æ³•çš„è°ƒç”¨ï¼š\nClasses Methods Executor update, query, flushStatements, commit, rollback, getTransaction, close, isClosed ParameterHandler getParameterObject, setParameters ResultSetHandler handleResultSets, handleOutputParameters StatementHandler prepare, parameterize, batch, update, query é¡¾åæ€ä¹‰ï¼ŒMyBatis ä¸æ„§ä¸º SQL æ˜ å°„æ¡†æ¶ã€‚è¿™äº›é‡è¦çš„ç»„ä»¶å…±åŒå‚ä¸äº† MyBatis ä¸€èˆ¬çš„å·¥ä½œæµç¨‹ï¼š\nç¤ºä¾‹æ’ä»¶ ç¼–å†™ä¸€ä¸ªæ’ä»¶ï¼Œåªéœ€è¦å®ç° org.apache.ibatis.plugin.Interceptor æ¥å£ï¼ŒæŒ‡å®šä½ è¦æ‹¦æˆªçš„æ–¹æ³•ç­¾åã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 @Intercepts({ @Signature( type = Executor.class, method = \u0026#34;query\u0026#34;, args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class} ) }) public class ExamplePlugin implements Interceptor { @Override public Object intercept(Invocation invocation) throws Throwable { System.out.println(\u0026#34;implement pre-processing if needed\u0026#34;); Object result = invocation.proceed(); System.out.printf(\u0026#34;result: %s\\n\u0026#34;, result); System.out.println(\u0026#34;implement post-processing if needed\u0026#34;); return result; } @Override public void setProperties(Properties properties) { System.out.printf(\u0026#34;properties: %s\\n\u0026#34;, properties); } } @Intercepts å¿…ä¸å¯å°‘ï¼Œå…¶ä¸­ @Signature å£°æ˜æ–¹æ³•ç­¾åæ•°ç»„ï¼Œä¸Šé¢è¿™ä¸ªç®€å•çš„æ’ä»¶ç”¨äºæ‹¦æˆª Executor çš„å‚æ•°ç±»å‹åˆ—è¡¨ä¸º (MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class) çš„ query æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•è°ƒç”¨å‰åšé¢„å¤„ç†ï¼Œåœ¨æ­¤æ–¹æ³•è°ƒç”¨ååšåå¤„ç†ã€‚\næ‹¦æˆª Executor çš„ query æ–¹æ³•æ˜¯å¦çœŸèƒ½å¯¹ Mapper æ–¹æ³•è°ƒç”¨èµ·ä½œç”¨ï¼Ÿä¸”è®©æˆ‘ä»¬å…ˆåœ¨ mybatis-config.xml ä¸­å£°æ˜è‡ªå®šä¹‰æ’ä»¶ï¼š\n1 2 3 4 5 \u0026lt;plugins\u0026gt; \u0026lt;plugin interceptor=\u0026#34;io.h2cone.mybatis.interceptor.ExamplePlugin\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;someProperty\u0026#34; value=\u0026#34;1024\u0026#34;/\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; å‡†å¤‡ä¸€ä¸ªç®€å•çš„ Mapperï¼Œæ¨¡æ‹Ÿé€šè¿‡çœåŒºä»£ç æŸ¥è¯¢åŸå¸‚åˆ—è¡¨ï¼š\n1 2 3 4 5 6 public interface CityMapper { @Select(\u0026#34;select * from city where province_code = #{provinceCode}\u0026#34;) List\u0026lt;City\u0026gt; selectCities(String provinceCode); } ç¼–å†™ç”¨ä¾‹æµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬çš„æ’ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 @Test public void testExamplePlugin() throws IOException { String resource = \u0026#34;mybatis-config.xml\u0026#34;; InputStream inputStream = Resources.getResourceAsStream(resource); SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream); try (SqlSession session = sqlSessionFactory.openSession()) { CityMapper mapper = session.getMapper(CityMapper.class); List\u0026lt;City\u0026gt; cities = mapper.selectCities(\u0026#34;000000\u0026#34;); Assert.assertNotNull(cities); } } è¿è¡Œæµ‹è¯•ä»£ç è¾“å‡ºå¦‚ä¸‹ï¼š\n1 2 3 4 properties: {someProperty=1024} implement pre-processing if needed result: [] implement post-processing if needed å¯è§æˆ‘ä»¬çš„é¢„å¤„ç†å’Œåå¤„ç†æˆåŠŸæ’å…¥äº† Mapper æ–¹æ³•è°ƒç”¨ä¹‹å‰å’Œä¹‹åï¼Œå®Œæ•´ä»£ç è¯·çœ‹ mybatis-interceptorã€‚\nçŸ¥å…¶æ‰€ä»¥ç„¶ MyBatis å¦‚ä½•å®ç°æ’ä»¶ï¼Ÿç§ç§ MyBatis æºç ä¹Ÿè®¸èƒ½æ‰¾åˆ°ç­”æ¡ˆã€‚å…ˆä» testExamplePlugin è¿™ä¸ªæµ‹è¯•æ–¹æ³•å¼€å§‹ï¼Œä»è¡¨é¢ä¸Šçœ‹ï¼Œåˆ†æˆå‡ æ­¥ï¼š\nåŠ è½½ XML é…ç½®æ–‡ä»¶\nä» XML æ„å»º SqlSessionFactory\nä½¿ç”¨ SqlSessionFactory æ‰“å¼€ SqlSession\næŸ¥è¯¢æ•°æ®åº“\nè§£æ XML é…ç½®ååŠ è½½æ’ä»¶æ˜¯å¦å‘ç”Ÿåœ¨ç¬¬äºŒæ­¥ï¼Ÿå±‚å±‚æ¢ç´¢æºç ä¹‹åï¼Œç•™ä¸‹äº†ä¸€äº›è››ä¸é©¬è¿¹ï¼š\norg.apache.ibatis.session.SqlSessionFactoryBuilder#build(java.io.InputStream)\norg.apache.ibatis.session.SqlSessionFactoryBuilder#build(java.io.InputStream, java.lang.String, java.util.Properties)\norg.apache.ibatis.builder.xml.XMLConfigBuilder#XMLConfigBuilder(java.io.InputStream, java.lang.String, java.util.Properties)\norg.apache.ibatis.builder.xml.XMLConfigBuilder#XMLConfigBuilder(org.apache.ibatis.parsing.XPathParser, java.lang.String, java.util.Properties)\norg.apache.ibatis.builder.xml.XMLConfigBuilder#parse\norg.apache.ibatis.builder.xml.XMLConfigBuilder#parseConfiguration\norg.apache.ibatis.builder.xml.XMLConfigBuilder#pluginElement\norg.apache.ibatis.session.Configuration#addInterceptor\norg.apache.ibatis.plugin.InterceptorChain#addInterceptor\norg.apache.ibatis.plugin.InterceptorChain#addInterceptor\nç”±æ­¤çœ‹æ¥ï¼Œè‡ªå®šä¹‰æ’ä»¶ä¼šæ·»åŠ åˆ° org.apache.ibatis.plugin.InterceptorChain#interceptorsï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class InterceptorChain { private final List\u0026lt;Interceptor\u0026gt; interceptors = new ArrayList\u0026lt;\u0026gt;(); public Object pluginAll(Object target) { for (Interceptor interceptor : interceptors) { target = interceptor.plugin(target); } return target; } public void addInterceptor(Interceptor interceptor) { interceptors.add(interceptor); } public List\u0026lt;Interceptor\u0026gt; getInterceptors() { return Collections.unmodifiableList(interceptors); } } è¿™ç§è®¾è®¡æ˜¯ Chain-of-responsibility patternã€‚æ³¨æ„ pluginAll æ–¹æ³•ï¼Œç»ˆäºè¿˜æ˜¯å›åˆ°äº† Interceptor:\n1 2 3 4 5 6 7 8 9 10 11 12 13 public interface Interceptor { Object intercept(Invocation invocation) throws Throwable; default Object plugin(Object target) { return Plugin.wrap(target, this); } default void setProperties(Properties properties) { // NOP } } æ³¨æ„ plugin æ–¹æ³•ï¼Œå†ç‚¹å¼€ org.apache.ibatis.plugin.Plugin#wrap æ–¹æ³•ï¼Œæœç„¶ MyBatis æ’ä»¶åŸºäº JDK åŠ¨æ€ä»£ç†æ¥å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 public class Plugin implements InvocationHandler { private final Object target; private final Interceptor interceptor; private final Map\u0026lt;Class\u0026lt;?\u0026gt;, Set\u0026lt;Method\u0026gt;\u0026gt; signatureMap; private Plugin(Object target, Interceptor interceptor, Map\u0026lt;Class\u0026lt;?\u0026gt;, Set\u0026lt;Method\u0026gt;\u0026gt; signatureMap) { this.target = target; this.interceptor = interceptor; this.signatureMap = signatureMap; } public static Object wrap(Object target, Interceptor interceptor) { Map\u0026lt;Class\u0026lt;?\u0026gt;, Set\u0026lt;Method\u0026gt;\u0026gt; signatureMap = getSignatureMap(interceptor); Class\u0026lt;?\u0026gt; type = target.getClass(); Class\u0026lt;?\u0026gt;[] interfaces = getAllInterfaces(type, signatureMap); if (interfaces.length \u0026gt; 0) { return Proxy.newProxyInstance( type.getClassLoader(), interfaces, new Plugin(target, interceptor, signatureMap)); } return target; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { try { Set\u0026lt;Method\u0026gt; methods = signatureMap.get(method.getDeclaringClass()); if (methods != null \u0026amp;\u0026amp; methods.contains(method)) { return interceptor.intercept(new Invocation(target, method, args)); } return method.invoke(target, args); } catch (Exception e) { throw ExceptionUtil.unwrapThrowable(e); } } ... å¦‚ä»£ç æ‰€è¯´ï¼ŒæŠŠæ’ä»¶è¦æ‹¦æˆªçš„æ–¹æ³•æ‰€å±çš„ç±»çš„å®ä¾‹å½“ä½œè¢«ä»£ç†ï¼ˆtargetï¼‰ï¼Œæ»¡è¶³æ¡ä»¶æ—¶ç”Ÿæˆäº†ä»£ç†ï¼ˆproxyï¼‰ã€‚ä¸¾ä¾‹æ¥è¯´ï¼ŒExecutor æ¥å£çš„å®ç°ç±»éƒ½æ˜¯è¢«ä»£ç†ç±»ï¼Œå®ƒä»¬å¯¹åº”çš„ä»£ç†ç±»éƒ½å®ç°äº† Executorï¼Œä¸€æ—¦ Executor çš„å®ç°ç±»çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå·å¤©æ¢æ—¥ï¼Œå®é™…è°ƒç”¨çš„åˆ™æ˜¯ org.apache.ibatis.plugin.Plugin#invoke æ–¹æ³•ï¼Œå…¶ä¸­è°ƒç”¨äº† ExamplePlugin é‡å†™çš„intercept æ–¹æ³•ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨ Executor å®ç°ç±»æ–¹æ³•è°ƒç”¨å‰åæ’å…¥é¢„å¤„ç†å’Œåå¤„ç†ã€‚\né‚£ä¹ˆï¼Œorg.apache.ibatis.plugin.InterceptorChain#pluginAll æ–¹æ³•ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨ï¼Ÿç»§ç»­æ·±å…¥æµ‹è¯•ä»£ç ç¬¬ä¸‰æ­¥çš„æºä»£ç ï¼š\norg.apache.ibatis.session.SqlSessionFactory#openSession()\norg.apache.ibatis.session.defaults.DefaultSqlSessionFactory#openSession()\norg.apache.ibatis.session.defaults.DefaultSqlSessionFactory#openSessionFromDataSource\norg.apache.ibatis.session.Configuration#newExecutor(org.apache.ibatis.transaction.Transaction, org.apache.ibatis.session.ExecutorType)\norg.apache.ibatis.plugin.InterceptorChain#pluginAll\nå½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨ IntelliJ IDEA CE çš„ä»£ç åˆ†æåŠŸèƒ½ï¼ŒæŸ¥ä¸€ä¸‹å“ªé‡Œä½¿ç”¨äº† pluginAll æ–¹æ³•ï¼š\nä»ç»ˆç‚¹å‡ºå‘ï¼Œå›åˆ°äº†èµ·ç‚¹ã€‚\nå°¾å£° å¤§èƒ†çŒœæƒ³ä¸€ä¸‹ï¼Œåˆ†é¡µæ’ä»¶æ˜¯é€šè¿‡æ‹¦æˆª StatementHandler çš„ query ç­‰æ–¹æ³•ï¼Œå–å¾— SQLï¼Œæ”¹å†™ SQL ä½¿å…¶èƒ½å¤Ÿåˆ†é¡µã€æ±‚æ€»è®°å½•æ•°ã€æ’åºã€‚é™¤äº†åˆ†é¡µï¼ŒMyBatis æ’ä»¶ç†æ‰€å½“ç„¶å¯ä»¥åšæ…¢ SQL ç›‘æ§ã€æ°´å¹³åˆ†è¡¨ã€æ•°æ®åŠ å¯†å’Œè§£å¯†ã€èœå•æƒé™æ§åˆ¶\u0026hellip;\u0026hellip;\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ MyBatis: plug-ins\nMybatisä¹‹pluginæ’ä»¶è®¾è®¡åŸç†\nMyBatisæ’ä»¶åŸç†\nMyBatis: getting started\nMybatisAutoConfigurationTest\nI can not config my interceptors in application.yml\nplugins-package option for application.yml\nPlug-in (computing)\n","date":"2020-02-08T18:28:19+08:00","permalink":"https://h2cone.github.io/2020/02/08/your-own-mybatis-interceptor/","title":"é€ ä½ è‡ªå·±çš„ MyBatis æ’ä»¶"},{"content":"è‡ªåŠ¨é…ç½® é¥æƒ³ä»¥å‰ï¼ŒSpring é›†æˆå…¶å®ƒæ¨¡å—å¾€å¾€éœ€è¦å¤§é‡çš„ XML é…ç½®å’Œ Java é…ç½®ï¼Œç»å†è¿‡ SSMï¼ˆSpringã€Spring MVCã€MyBatisï¼‰æˆ–è€… SSHï¼ˆStrutsã€Springã€Hibernateï¼‰æ¡†æ¶æ­å»ºå’Œå¡«ç©ºçš„äººä»¬åº”è¯¥æ·±æœ‰ä½“ä¼šï¼Œç‰¹åˆ«è´¹æ—¶è´¹åŠ›ï¼Œç›´åˆ° Spring Boot çš„æµè¡Œæ‰æœ‰æ‰€æ”¹å–„ã€‚\nSpring Boot ç®€åŒ–é…ç½®ï¼Œå¼€ç®±å³ç”¨ï¼Œå¾—ç›Šäºè‡ªåŠ¨é…ç½®ï¼ˆauto-configurationï¼‰ã€‚å¼€å¯äº†è‡ªåŠ¨é…ç½®çš„ Spring Boot ç¨‹åºä¼šå°è¯•çŒœæµ‹å’Œé…ç½®æˆ‘ä»¬å¯èƒ½éœ€è¦çš„ Beanã€‚å¦‚æœæˆ‘ä»¬ç»™ä¸€èˆ¬çš„ Spring Boot Web ç¨‹åºï¼ˆæ·»åŠ äº† spring-boot-starter-web ä¾èµ–çš„ Spring Boot ç¨‹åºï¼‰å…³è”çš„ application.yml æ–‡ä»¶å¢åŠ ä¸€è¡Œï¼š\n1 debug: true ç¨‹åºå¯åŠ¨æˆåŠŸåï¼Œå¯ä»¥åœ¨æ§åˆ¶å°è§‚å¯Ÿåˆ°ä¸€æ®µå«åš CONDITIONS EVALUATION REPORT çš„å†—é•¿æ—¥å¿—ï¼Œä¸‹é¢æˆªå–è‹¥å¹²éƒ¨åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 ============================ CONDITIONS EVALUATION REPORT ============================ Positive matches: ----------------- ... EmbeddedWebServerFactoryCustomizerAutoConfiguration.TomcatWebServerFactoryCustomizerConfiguration matched: - @ConditionalOnClass found required classes \u0026#39;org.apache.catalina.startup.Tomcat\u0026#39;, \u0026#39;org.apache.coyote.UpgradeProtocol\u0026#39; (OnClassCondition) ... Negative matches: ----------------- ... EmbeddedWebServerFactoryCustomizerAutoConfiguration.JettyWebServerFactoryCustomizerConfiguration: Did not match: - @ConditionalOnClass did not find required classes \u0026#39;org.eclipse.jetty.server.Server\u0026#39;, \u0026#39;org.eclipse.jetty.util.Loader\u0026#39;, \u0026#39;org.eclipse.jetty.webapp.WebAppContext\u0026#39; (OnClassCondition) EmbeddedWebServerFactoryCustomizerAutoConfiguration.NettyWebServerFactoryCustomizerConfiguration: Did not match: - @ConditionalOnClass did not find required class \u0026#39;reactor.netty.http.server.HttpServer\u0026#39; (OnClassCondition) EmbeddedWebServerFactoryCustomizerAutoConfiguration.UndertowWebServerFactoryCustomizerConfiguration: Did not match: - @ConditionalOnClass did not find required classes \u0026#39;io.undertow.Undertow\u0026#39;, \u0026#39;org.xnio.SslClientAuthMode\u0026#39; (OnClassCondition) ... Exclusions: ----------- None Unconditional classes: ---------------------- org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration org.springframework.boot.actuate.autoconfigure.info.InfoContributorAutoConfiguration ... è¿™ä»½æŠ¥å‘Šåˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼šPositive matchesã€Negative matchesã€Exclusionsã€Unconditional classesï¼Œé¡¾åæ€ä¹‰ï¼Œå¯¹äºè¿™ä¸ªç¨‹åºå†…åµŒçš„åº”ç”¨æœåŠ¡å™¨ï¼Œåªæœ‰ Tomcat çš„é…ç½®ç±»æ˜¯åŒ¹é…çš„ï¼Œè€Œ Jettyã€Undertowã€Netty çš„é…ç½®ç±»å‡ä¸åŒ¹é…ï¼Œå®ƒä»¬å…±åŒçš„å¤–éƒ¨ç±»åˆ™æ˜¯ä¸€ä¸ªè‡ªåŠ¨é…ç½®ç±»ï¼šEmbeddedWebServerFactoryCustomizerAutoConfigurationï¼Œè¿™å°±æ˜¯ Spring Boot æä¾›çš„å†…åµŒåº”ç”¨æœåŠ¡å™¨çš„è‡ªåŠ¨é…ç½®ã€‚\nè‡ªåŠ¨é…ç½®ç±»æ»¡è¶³ä¸€äº›æ¡ä»¶æ—¶ï¼Œå³åŒ¹é…ï¼Œæ¡†æ¶å°±è‡ªåŠ¨è¿›è¡Œäº†é…ç½®ï¼Œä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨ classpath ä¸Šæœ‰ tomcat-embedded.jarï¼Œä½ å¯èƒ½æƒ³è¦ä¸€ä¸ª TomcatServletWebServerFactory beanï¼Œé™¤éä½ å®šä¹‰äº†è‡ªå·±çš„ ServletWebServerFactory beanã€‚\nä¸å‡ºæ„å¤–ï¼ŒSpring Web æ¨¡å—éœ€è¦é…ç½®çš„ Dispatcher Servletã€æ•°æ®åº“æ“ä½œéœ€è¦é…ç½®çš„æ•°æ®æºç­‰ç­‰ï¼ŒSpring Boot éƒ½æä¾›äº†åŸºç¡€çš„é…ç½®ï¼ˆå‚è§ Spring Boot æºç çš„ spring.factories æ–‡ä»¶ï¼‰ï¼Œé€šå¸¸ï¼Œç”¨æˆ·åªéœ€è¦æ·»åŠ å¯¹åº”çš„ä¾èµ–ï¼Œç®€å•å£°æ˜ä¸€ä¸‹ï¼Œå¼€ç®±å³ç”¨ï¼Œå³ä½¿é»˜è®¤é…ç½®ä¸æ»¡è¶³åæœŸéœ€æ±‚ï¼Œä¹Ÿæ”¯æŒè¦†ç›–æˆ–é‡å†™ã€‚\nè‡ªå®šä¹‰å§ è‡ªåŠ¨é…ç½®æ˜¯é€šè¿‡ä½¿ç”¨ @Configuration æ³¨è§£çš„ç±»æ¥å®ç°ï¼Œå…¶å®ƒè¯¸å¦‚ @Conditional çš„æ³¨è§£ç”¨äºçº¦æŸä½•æ—¶åº”ç”¨è‡ªåŠ¨é…ç½®ï¼ˆæ˜¯å¦åŒ¹é…ï¼‰ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªè‡ªå®šä¹‰çš„è‡ªåŠ¨é…ç½®ç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 @ConditionalOnProperty(prefix = \u0026#34;springfox-swagger2\u0026#34;, name = \u0026#34;enabled\u0026#34;) @Configuration @EnableSwagger2 @EnableConfigurationProperties(SpringFoxSwagger2Prop.class) public class SpringFoxSwagger2AutoConfig { @Resource private SpringFoxSwagger2Prop springFoxSwagger2Prop; @Bean @ConditionalOnMissingBean public Docket docket() { ApiSelectorBuilder builder = new Docket(DocumentationType.SWAGGER_2) .apiInfo(apiInfo()) .select(); List\u0026lt;String\u0026gt; excludedPaths = springFoxSwagger2Prop.getExcludedPaths(); if (excludedPaths == null || excludedPaths.isEmpty()) { builder.paths(Predicates.not(PathSelectors.regex(\u0026#34;/error\u0026#34;))) .paths(Predicates.not(PathSelectors.regex(\u0026#34;/actuator.*\u0026#34;))); } else { for (String path : excludedPaths) { builder.paths(Predicates.not(PathSelectors.regex(path))); } } return builder.build(); } private ApiInfo apiInfo() { SpringFoxSwagger2Prop.ApiInfo apiInfo = springFoxSwagger2Prop.getApiInfo(); if (apiInfo == null) { return ApiInfo.DEFAULT; } SpringFoxSwagger2Prop.Contact contact = apiInfo.getContact(); return new ApiInfo( apiInfo.getTitle(), apiInfo.getDescription(), apiInfo.getVersion(), apiInfo.getTermsOfServiceUrl(), new Contact(contact.getName(), contact.getUrl(), contact.getEmail()), apiInfo.getLicense(), apiInfo.getLicenseUrl(), Collections.emptyList() ); } } SpringFoxSwagger2AutoConfig çš„ç›®çš„æ˜¯åˆ›å»º Docket å®ä¾‹å¹¶äº¤ç”± Spring IoC å®¹å™¨ç®¡ç†ï¼Œä¸ºäº†èƒ½å¤Ÿè®© Spring Boot é‡‡ç”¨è¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»ï¼Œåº”å½“åœ¨ springfox-swagger2-spring-boot-autoconfigure/src/main/resources/META-INF/spring.factories æ–‡ä»¶é‡Œå£°æ˜ï¼š\n1 2 org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\ io.h2cone.springfox.swagger2.spring.boot.autoconfigure.SpringFoxSwagger2AutoConfig è‹¥æœ‰å¤šä¸ªï¼Œåˆ™ç”¨é€—å·éš”å¼€ï¼Œè‹¥éœ€æ¢è¡Œï¼Œåˆ™ç”¨åæ–œæ ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå®˜æ–¹æ–‡æ¡£æœ‰ä¸€ä¸ªå°æç¤ºï¼š\nAuto-configurations must be loaded that way only. Make sure that they are defined in a specific package space and that they are never the target of component scanning. Furthermore, auto-configuration classes should not enable component scanning to find additional components. Specific @Imports should be used instead.\nç‰¹åˆ«æ˜¯ç¬¬ä¸‰å¥ï¼Œè‡ªåŠ¨é…ç½®ç±»ä¸åº”å¯ç”¨ç»„ä»¶æ‰«æä»¥æŸ¥æ‰¾å…¶ä»–ç»„ä»¶ï¼Œæ¯”å¦‚ @ComponentScanï¼Œåº”è¯¥ä½¿ç”¨æŒ‡å®šçš„ @Imports ä»£æ›¿ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè‡ªåŠ¨é…ç½®ç±»åªèƒ½é—´æ¥å¯ç”¨ç»„ä»¶æ‰«æï¼Œåœ¨è‡ªåŠ¨é…ç½®ç±»ä¸Šå£°æ˜å¯¼å…¥äº†ä¸€äº›é…ç½®ç±»ï¼ˆ@Configurationï¼‰ï¼Œåˆ©ç”¨è¿™äº›é…ç½®ç±»å¯ä»¥å¯åŠ¨ç»„ä»¶æ‰«æï¼ŒæŸ¥æ‰¾æ ‡æ³¨äº† @Componentã€@Controllerã€@Repositoryã€@Serviceã€@Aspect ç­‰æ³¨è§£çš„ç±»ï¼Œé™¤éï¼Œè‡ªå®šä¹‰æ³¨è§£ã€æ‰«æã€å¤„ç†ã€‚\nä»¥ä¸Šä»£ç æ¥æºäº springfox-swagger2-spring-bootï¼Œå…¶ä¸­æœ‰å¦‚ä¸‹ä¸‰ä¸ªæ¨¡å—:\nspringfox-swagger2-spring-boot-autoconfigure springfox-swagger2-spring-boot-starter springfox-swagger2-spring-boot-sample èŒè´£åˆ†åˆ«æ˜¯è‡ªåŠ¨é…ç½®ã€åŒ…è£…ã€ç¤ºä¾‹ã€‚åˆ©ç”¨ Spring Boot çš„è‡ªåŠ¨é…ç½®ç‰¹æ€§ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æå‰åˆ›å»ºå¥½ä¸€ç»„å¤æ‚å•ä¾‹ï¼Œæ³¨å†Œä¸º Spring Beanï¼Œé€šè¿‡ YML é…ç½®å’Œä¾èµ–æ³¨å…¥æ¥ä½¿ç”¨\u0026hellip;\u0026hellip;\nèµ°é©¬è§‚èŠ± ä»¥ä¸Šç»éªŒå‘Šè¯‰æˆ‘ä»¬ï¼ŒSpring Boot å¯åŠ¨æ—¶ä¼šè¯»å– META-INF/spring.factories çš„å…ƒæ•°æ®ï¼ŒåŠ è½½ç±»ï¼Œè¿›è¡Œè‡ªåŠ¨é…ç½®ã€‚é‚£æˆ‘ä»¬å°±èƒ½é€šè¿‡ IntelliJ IDEA CE å¼ºå¤§çš„æœç´¢åŠŸèƒ½å‘ç°åŠ è½½æ­¤æ–‡ä»¶çš„ç±»ï¼š\nè¿›å»é˜…è¯»ä¸€ä¸‹ org.springframework.core.io.support.SpringFactoriesLoader çš„æºç å’Œ Javadocï¼Œå†åˆ©ç”¨ IntelliJ IDEA CE ä»£ç åˆ†æèƒ½åŠ›å¾—çŸ¥ loadFactories å’Œ loadFactoryNames è¿™ä¸¤ä¸ªå…¬å…±æ–¹æ³•è¢« org.springframework.boot.autoconfigure.AutoConfigurationImportSelector ä½¿ç”¨äº†ã€‚å†æ¥çœ‹çœ‹ AutoConfigurationImportSelector çš„ç®€ä»‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 /** * {@link DeferredImportSelector} to handle {@link EnableAutoConfiguration * auto-configuration}. This class can also be subclassed if a custom variant of * {@link EnableAutoConfiguration @EnableAutoConfiguration} is needed. * * @author Phillip Webb * @author Andy Wilkinson * @author Stephane Nicoll * @author Madhura Bhave * @since 1.3.0 * @see EnableAutoConfiguration */ public class AutoConfigurationImportSelector implements DeferredImportSelector, BeanClassLoaderAware, ResourceLoaderAware, BeanFactoryAware, EnvironmentAware, Ordered { åŸæ¥æ˜¯å¤„ç† @EnableAutoConfiguration æ³¨è§£çš„ç±»ã€‚æˆ‘æƒ³æœ‰äººæ›¾ç»å¯¹ä¸€èˆ¬çš„ Spring Boot ç¨‹åºçš„å…¥å£æ„Ÿåˆ°å¥½å¥‡ï¼š\n1 2 3 4 5 6 7 8 @SpringBootApplication public class SampleApplication { public static void main(String[] args) { SpringApplication.run(SampleApplication.class, args); } } ç„äº†ä¸€ä¸‹ @SpringBootApplicationï¼š\n1 2 3 4 5 6 7 8 9 @Target(ElementType.TYPE) @Retention(RetentionPolicy.RUNTIME) @Documented @Inherited @SpringBootConfiguration @EnableAutoConfiguration @ComponentScan(excludeFilters = { @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class), @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) }) public @interface SpringBootApplication { å½“ç„¶ï¼Œå¼€å¯äº†è‡ªåŠ¨é…ç½®ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\næ¨èé˜…è¯» Creating Your Own Auto-configuration\nspring-boot-master-auto-configuration\nmybatis/spring-boot-starter\ndubbo-spring-boot-autoconfigure\ngrpc-spring-boot-starter\n","date":"2020-01-23T20:16:58+08:00","permalink":"https://h2cone.github.io/2020/01/23/your-own-spring-boot-starter/","title":"é€ ä½ è‡ªå·±çš„ Spring Boot Starter ç»„ä»¶"},{"content":"ä¸ºä»€ä¹ˆä½¿ç”¨ Getter/Setter Java çš„å•°å—¦å’Œå†—ä½™æ˜¯é—»åäºä¸–çš„ï¼Œç‰¹åˆ«åœ¨å¼€å‘åŸºäº Java çš„ä¸šåŠ¡ç³»ç»Ÿçš„æ—¶å€™ï¼Œç»§ç»­ä¸æ–­åœ°ç¼–å†™æ™®é€šçš„ Java ç±»ï¼ˆæ•°æ®ç±»å‹ï¼‰ï¼Œä¸å‡æ€ç´¢åœ°ç”¨ private ä¿®é¥°æˆå‘˜å˜é‡ï¼Œç†Ÿç»ƒè¿ç”¨ç¼–è¾‘å™¨æˆ–é›†æˆå¼€å‘ç¯å¢ƒä¸åœåœ°ç”Ÿæˆ Getterã€Setterã€ToStringã€Constructor ç­‰æ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 public class Member { public static final Logger log = LoggerFactory.getLogger(Member.class); private Long id; private String name; public Long getId() { return id; } public void setId(Long id) { this.id = id; } public String getName() { return name; } public void setName(String name) { this.name = name; } @Override public String toString() { return new StringJoiner(\u0026#34;, \u0026#34;, Member.class.getSimpleName() + \u0026#34;[\u0026#34;, \u0026#34;]\u0026#34;) .add(\u0026#34;id=\u0026#34; + id) .add(\u0026#34;name=\u0026#39;\u0026#34; + name + \u0026#34;\u0026#39;\u0026#34;) .toString(); } } å¦‚æœè¢«é—®åˆ°ä¸ºä»€ä¹ˆæ€ä¹ˆåšï¼Œä¾¿ç¾åå…¶æ›°â€œé¢å‘å¯¹è±¡ç¼–ç¨‹â€ï¼ˆä¸ç®¡é‡å¤å¤šå°‘éï¼Œæˆ‘éƒ½æƒ³å›åˆ°è¿‡å»æŠ—è®®ä¸ç¿»è¯‘æˆå¯¹è±¡å¯¼å‘ç¼–ç¨‹çš„äººï¼‰ï¼›ä¸ºäº†è¯ é‡Šä»€ä¹ˆæ˜¯ Java å¯¹è±¡ï¼Œäºæ˜¯æŠŠå¯¹è±¡ä¸‰å¤§ç‰¹å¾ç»™æ¬äº†å‡ºæ¥ï¼šçŠ¶æ€ã€æ ‡è¯†ã€è¡Œä¸ºã€‚\nç‰¹å¾ è§£é‡Š çŠ¶æ€ æ•°æ®ç±»å‹çš„å€¼ æ ‡è¯† å†…å­˜åœ°å€ è¡Œä¸º æ•°æ®ç±»å‹çš„æ“ä½œ å†ç»“åˆâ€œé¢å‘å¯¹è±¡ç¼–ç¨‹â€çš„ä¸‰å¤§ç‰¹å¾ï¼šç»§æ‰¿ã€å¤šæ€ã€å°è£…ï¼Œç‰¹åˆ«æŒ‡å‡ºå°è£…ï¼ˆç†ç›´æ°”å£®ï¼Œå¥½åƒå‡½æ•°å¼ç¼–ç¨‹ä¸èƒ½å°è£…ä¼¼çš„ï¼‰ï¼Œé«˜è°ˆé˜”è®ºå°è£…çš„å¥½å¤„ï¼Œæ¯”å¦‚åˆ†ç¦»æ•°æ®ç»“æ„ä¸å…¶æ“ä½œï¼Œæä¾› APIï¼Œå¯¹ä½¿ç”¨è€…éšè—å®ç°ç»†èŠ‚ã€éšè—æ•°æ®çš„å†…éƒ¨è¡¨ç¤ºï¼Œéå¸¸åˆ©äºç»´æŠ¤ã€é‡ç”¨ã€å•å…ƒæµ‹è¯•ï¼Œè¿˜ä¸å¿˜æ‹¾äººç‰™æ…§ï¼Œå¤è¯» David Wheeler çš„è¯ï¼š\nAll problems in computer science can be solved by another level of indirection.\nè®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªä¸­é—´å±‚æ¥è§£å†³ï¼ŒGetter å’Œ Setter å°±æ˜¯å°è£…å½¢æˆçš„ä¸­é—´å±‚ï¼ˆç§æœ‰å˜é‡ä¸èƒ½ç›´æ¥è®¿é—®ï¼Œåªèƒ½é€šè¿‡ä¸­é—´å±‚è®¿é—®ï¼Œä¸è¿‡è¯¥ä¸­é—´å±‚å¾€å¾€éå¸¸æµ…è–„ï¼‰ï¼Œæœ€åç”©æ¥ä¸€ä¸ªé“¾æ¥ï¼šwhy-use-getters-and-setters-accessorsã€‚\nProject Lombok ç”¨ private ä¿®é¥°çš„å­—æ®µå’Œå…¶ Getter/Settter æ–¹æ³•ï¼Œæ—¢ç„¶å·²ç»æˆä¸ºçº¦å®šä¿—æˆï¼ˆè‹¥æ”¹ç”¨ public ä¿®é¥°å­—æ®µï¼Œå¯èƒ½æˆä¸ºâ€å¼‚ç±»â€œï¼‰ï¼Œåˆæˆ–è€…è¿™æ˜¯åº“æˆ–æ¡†æ¶çš„è¦æ±‚ï¼ˆæˆ‘ä»¬ä¸æ˜¾å¼è°ƒç”¨çš„æ–¹æ³•ï¼Œå®ƒä»¬å´å¾ˆæœ‰å¯èƒ½éœ€è¦éšå¼è°ƒç”¨æ‰èƒ½æ­£å¸¸å·¥ä½œï¼‰ï¼Œæˆ–è®¸è¿˜æœ‰å…¶å®ƒç†ç”±ï¼ŒJava ç¨‹åºå‘˜ä»¬éœ€è¦ä¸åŒå…¶çƒ¦å»æ‰‹åŠ¨ç¼–å†™æˆ–é™æ€ç”Ÿæˆé‚£äº›åˆ»æ¿åˆç¹å¤šçš„ä»£ç ï¼Œè¿˜å¥½ä»–ä»¬æœ‰åŒ–ç¹ä¸ºç®€çš„ç¥å™¨ï¼Œåä¸º Project Lombokï¼š\nProject Lombok is a java library that automatically plugs into your editor and build tools, spicing up your java. Never write another getter or equals method again, with one annotation your class has a fully featured builder, Automate your logging variables, and much more.\nè‹¥ç”¨ Lombok ç®€åŒ–å‰é¢çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 @Slf4j @Getter @Setter @Accessors(chain = true) @ToString public class Member { private Long id; private String name; } ç‰¹åœ°ç”¨ @Accessors(chain = true) è¿›è¡Œäº†å¢å¼ºï¼Œå…è®¸é“¾å¼è°ƒç”¨ Setter æ–¹æ³•åˆ›å»ºå¯¹è±¡ï¼ˆå› ä¸ºæ¯æ¬¡éƒ½è¿”å› thisï¼‰ï¼š\n1 2 3 Member member = new Member() .setId(0L) .setName(\u0026#34;lombok\u0026#34;); åˆ›å»ºä¸€ä¸ªå¤æ‚å¯¹è±¡ï¼Œä¸»æµçš„åšæ³•æ˜¯ä½¿ç”¨å»ºé€ è€…æ¨¡å¼ï¼ˆBuilder Patternï¼‰ï¼Œåªéœ€è¦ä¸€ä¸ª @Builder æ³¨è§£åˆ°ç±»ä¸Šï¼Œæ›´å¤šç‰¹è‰²çš„æ³¨è§£åœ¨è¿™é‡Œå¯ä»¥æ‰¾åˆ°ã€‚\næ³¨è§£ ï¼ˆAnnotationï¼‰å¹¶ä¸ç¥å¥‡ï¼Œå®ƒä»¬åªæ˜¯åªè¯»çš„å…ƒæ•°æ®ï¼Œç¨‹åºè¯»å–å®ƒä»¬ï¼ŒæŒ‰æˆ‘ä»¬çš„å£°æ˜è¿›è¡Œå¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥å·çœ‹ä¸€ä¸‹ @Slf4j è¿™ä¸ªæ³¨è§£çš„ç±»ï¼š\n1 2 3 4 5 @Retention(RetentionPolicy.SOURCE) @Target(ElementType.TYPE) public @interface Slf4j { String topic() default \u0026#34;\u0026#34;; } @Retention æ˜¯ä¸€ä¸ªå…ƒæ³¨è§£ï¼ˆæ³¨è§£çš„æ³¨è§£ï¼‰ï¼Œå…¶å”¯ä¸€å±æ€§çš„ç±»å‹æ˜¯ RetentionPolicy, è¿™ä¸ªæšä¸¾åªæœ‰ä¸‰ä¸ªï¼šSOURCEã€CLASSã€RUNTIMEï¼Œåˆ†åˆ«è¡¨ç¤ºæ³¨è§£åªä¿ç•™åˆ°æºæ–‡ä»¶ï¼Œè¿˜æ˜¯åªä¿ç•™åˆ°ç±»æ–‡ä»¶ï¼ŒæŠ‘æˆ–æ˜¯ä¿ç•™åˆ°è¿è¡Œæ—¶ã€‚ç”±æ­¤å¯è§ï¼ŒLombok çš„ç‰¹è‰²æ³¨è§£åªä¿ç•™åˆ°æºæ–‡ä»¶ï¼Œé‚£ä¹ˆ Lombok ä¸æ˜¯åœ¨è¿è¡Œæ—¶ç”Ÿæˆä»£ç ï¼Œè€Œæ˜¯åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆä»£ç ï¼ˆè¿›ä¸€æ­¥è¯å®æ˜¯åç¼–è¯‘æœ‰ Lombok ç‰¹è‰²æ³¨è§£çš„æºæ–‡ä»¶ç¼–è¯‘åçš„ç±»æ–‡ä»¶ï¼‰ã€‚\nAnnotation Processor æ—©åœ¨ Java 6 æ—¶æœŸï¼Œå¼€å‘äººå‘˜å°±å¯ä»¥ä½¿ç”¨ Pluggable Annotation Processing APIï¼ˆJSR 269ï¼‰å®šåˆ¶æ³¨è§£å¤„ç†å™¨ï¼ˆAnnotation Processorï¼‰ï¼Œå¤„ç†æºæ–‡ä»¶ä¸­çš„æ³¨è§£ã€‚æ¯”å¦‚ï¼Œæ£€æŸ¥ä»£ç å¹¶å‘å‡ºè‡ªå®šä¹‰çš„é”™è¯¯æˆ–è­¦å‘Šï¼Œå°±åƒ Java ç¼–è¯‘å™¨ç¼–è¯‘ Java æºæ–‡ä»¶æ—¶ï¼Œå®ƒå°±ä¼šæ£€æŸ¥è¢« @Override ä¿®é¥°çš„æ–¹æ³•æ˜¯å¦ä¸çˆ¶ç±»æˆ–æ¥å£çš„æ–¹æ³•ç­¾åç›¸åŒï¼Œå¦‚æœä¸åŒï¼Œå°±ä¼šæŠ¥é”™ï¼ˆç¼–è¯‘å¤±è´¥ï¼‰ï¼Œåˆæˆ–è€…åƒ Lombok é‚£æ ·ï¼Œæ ¹æ®æ³¨è§£æä¾›çš„ä¿¡æ¯åœ¨ç¼–è¯‘æ—¶æ›´æ”¹ä»£ç ï¼ˆæ›´æ”¹æŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼Œè€Œä¸ä¼šæœ‰è¿è¡Œæ—¶æ›´æ”¹ä»£ç çš„å¼€é”€ã€‚\nä¸‹é¢å±•ç¤ºä¸€ä¸ªç®€å•çš„æ³¨è§£å¤„ç†å™¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @SupportedAnnotationTypes({ \u0026#34;io.h2cone.annotation.processor.Inspect\u0026#34; }) @SupportedSourceVersion(SourceVersion.RELEASE_8) public class SimpleAnnotationProcessor extends AbstractProcessor { @Override public boolean process(Set\u0026lt;? extends TypeElement\u0026gt; annotations, RoundEnvironment roundEnv) { for (TypeElement element : annotations) { this.processingEnv.getMessager().printMessage(Diagnostic.Kind.NOTE, element.getQualifiedName()); System.out.println(element.getQualifiedName()); } return false; } } å…³é”®åœ¨äºå®šåˆ¶çš„æ³¨è§£å¤„ç†å™¨ç±»éœ€è¦ç»§æ‰¿ AbstractProcessor ç±»ï¼Œå¹¶é‡å†™æ„Ÿå…´è¶£çš„æ–¹æ³•ï¼Œå»å¤„ç†ç‰¹å®šçš„æ³¨è§£ï¼Œä¾‹å¦‚æˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£ï¼š\n1 2 3 4 5 6 7 8 9 10 @Retention(RetentionPolicy.SOURCE) @Target({ ElementType.TYPE, ElementType.METHOD }) public @interface Inspect { boolean ignore() default false; } é¢„æœŸ process æ–¹æ³•ä¼šåœ¨ç¼–è¯‘æ—¶è¢«è°ƒç”¨ï¼Œè¾“å‡ºæˆ–æ‰“å°ä¼ é€’è€Œæ¥çš„è‡ªå®šä¹‰æ³¨è§£çš„åç§°ã€‚å¯æ˜¯å…¶å®ƒé¡¹ç›®å¦‚ä½•ä½¿ç”¨å®šåˆ¶çš„æ³¨è§£å¤„ç†å™¨ï¼Ÿå¦‚æœå®šåˆ¶çš„æ³¨è§£å¤„ç†å™¨é¡¹ç›®ä¸º annotation-processorï¼Œé‚£ä¹ˆå®ƒè¿˜éœ€è¦ä¸€ä¸ªæ–‡ä»¶ï¼ˆsrc/main/resources/META-INF/services/javax.annotation.processing.Processorï¼‰ç”¨æ¥å‘Šè¯‰ç¼–è¯‘å™¨å®šåˆ¶çš„æ³¨è§£å¤„ç†å™¨ç±»åœ¨å“ªé‡Œï¼š\n1 io.h2cone.annotation.processor.SimpleAnnotationProcessor é™¤æ­¤ä¹‹å¤–ï¼Œæ„å»ºæ­¤é¡¹ç›®æ—¶åº”å½“æ·»åŠ ç¼–è¯‘å‚æ•° -proc:noneï¼Œæ„å‘³ç€æ— éœ€æ³¨è§£å¤„ç†å³å¯è¿›è¡Œç¼–è¯‘ï¼ˆä»¥ Maven ä¸ºä¾‹ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-compiler-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;compilerArgument\u0026gt;-proc:none\u0026lt;/compilerArgument\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; å¦è€…ä¼šç¼–è¯‘å¤±è´¥ï¼Œå¾—åˆ°ä¸€ä¸ªé”™è¯¯ï¼ˆerror: Bad service configuration fileï¼‰ã€‚\nå‡è®¾å‡†å¤‡ä½¿ç”¨å®šåˆ¶çš„æ³¨è§£å¤„ç†å™¨çš„é¡¹ç›®ä¸º annotation-processor-demoï¼Œé‚£ä¹ˆå®ƒåªéœ€æ·»åŠ ä¾èµ–ï¼š\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.h2cone\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;annotation-processor\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${project.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; æ­¤ä¾èµ–è¿˜åŒ…å«äº†ä¸Šé¢è¯´åˆ°çš„è‡ªå®šä¹‰æ³¨è§£ï¼š\n1 2 3 @Inspect(ignore = true) public class Foobar { } è‹¥ä½¿ç”¨ IntelliJ IDEAï¼Œä¾æ¬¡ç‚¹å‡» Build \u0026gt; Rebuild Projectï¼ŒæˆåŠŸåå¯ä»¥åœ¨åº•éƒ¨çš„ Messages çœ‹åˆ° process æ–¹æ³•è¢«è°ƒç”¨ä»è€Œè¾“å‡ºäº† Inspect æ³¨è§£çš„åç§°ï¼š\n1 Information:java: io.h2cone.annotation.processor.Inspect æœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒèµ„æ–™ Javaå¼€å‘ç¥å™¨Lombokçš„ä½¿ç”¨ä¸åŸç†\nOpen JDK # Compilation Overview\nã€LombokåŸç†1ã€‘è‡ªå®šä¹‰æ³¨è§£å¤„ç†å™¨\nJava Pluggable Annotation Processor\n","date":"2019-11-30T23:43:35+08:00","permalink":"https://h2cone.github.io/2019/11/30/annotation-processor/","title":"æ³¨è§£å¤„ç†å™¨"},{"content":"åºè¨€ ä»€ä¹ˆæƒ…å†µä¸‹åº”è¯¥æ¢æµ‹æˆ–è¿½è¸ªç¨‹åºï¼Ÿåº”ç”¨ç¨‹åºæ— ä¸ä¾‹å¤–å¯èƒ½å­˜åœ¨è¿è¡Œæ—¶æ‰æš´éœ²çš„ bugï¼Œç”Ÿäº§ç¯å¢ƒçš„æ•…éšœæ’é™¤ï¼Œä¸å¾—ä¸ä¾é è¯»æ—¥å¿—å’Œ Review ä»£ç ï¼Œè¿æ°”å¥½çš„è¯ä¹Ÿè®¸åªçœ‹å¼‚å¸¸æ ˆå’Œå…³é”®ä»£ç å°±èƒ½å¿«é€Ÿæå‡ºå‡è®¾ï¼Œåœ¨æœ¬åœ°éªŒè¯é€šè¿‡ï¼Œä¿®å¤åå‘å¸ƒä¸Šçº¿ï¼Œæœ€åè¿˜å¯èƒ½å¯¹å…ˆå‰æµ‹è¯•ä¸å……åˆ†æ„Ÿåˆ°ç¾æ„§ã€‚å¾ˆä¸å¹¸ï¼Œå¦‚æœæ˜¯åº•å±‚æˆ–æ€§èƒ½çš„ç–‘éš¾æ‚ç—‡ï¼ŒCPUã€å†…å­˜ã€I/Oã€è¿›ç¨‹ã€çº¿ç¨‹ã€å †ã€æ ˆç­‰éƒ½å¯èƒ½æä¾›çº¿ç´¢ï¼Œå®ƒä»¬åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€å˜åŒ–ï¼Œåªæœ‰æ¢æµ‹æˆ–è¿½è¸ªå®ƒä»¬æ‰èƒ½è¶…è¶Šè¡¨é¢çš„ä»£ç è§‚å¯Ÿï¼Œä»è€Œæœé›†ä¸‹å±‚è¡Œä¸ºæ•°æ®ä»¥ä¾›åˆ†æï¼Œå‚ä¸ debug çš„ç¨‹åºå‘˜åˆ™å¦‚è™æ·»ç¿¼ã€‚åœ¨ Java å¹³å°ï¼ŒBTrace éå¸¸é€‚åˆåŠ¨æ€è¿½è¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œå®ƒçš„åŸºç¡€æ­£æ˜¯ Java Instrumention å’Œ Java Attach APIã€‚\nInstrument ç®€ä»‹ Oracle JDK é‡Œæœ‰ä¸€ä¸ªåä¸º java.lang.instrument çš„åŒ…ï¼š\nProvides services that allow Java programming language agents to instrument programs running on the JVM. The mechanism for instrumentation is modification of the byte-codes of methods. [0]\nä»å®ƒçš„ç®€ä»‹ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®è®¤çš„æ˜¯ instrumentation çš„æœºåˆ¶æ˜¯æ›´æ”¹ Java å­—èŠ‚ç ï¼Œè€Œä¸”æˆ‘ä»¬å·²ç»çŸ¥é“ç±»æ–‡ä»¶åŒ…å«å­—èŠ‚ç ã€‚ä¸è¿‡ç­‰ç­‰ï¼Œinstrumentation å’Œ instrument éƒ½æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿåœ¨è¿™é‡Œçš„ instrumentï¼Œæˆ‘æš‚æ—¶è¿˜æ‰¾ä¸åˆ°æ°åˆ°å¥½å¤„çš„æ±‰è¯‘ï¼Œä½œåŠ¨è¯æ—¶æ„ä¸ºâ€œç»™\u0026hellip;\u0026hellip;è£…æµ‹é‡ä»ªå™¨â€æˆ–è€…â€œä»ªå™¨åŒ–â€ï¼Œç»“åˆç®€ä»‹ï¼Œæ­¤åŒ…å…è®¸ Java agent ç»™è¿è¡Œåœ¨ JVM ä¸Šçš„ç¨‹åºè£…æµ‹é‡ä»ªå™¨ã€‚Java agent åˆæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå¯ä»¥ä½œä¸º Java ç¨‹åºçš„æ¢é’ˆï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª Jar æ–‡ä»¶ï¼Œå®ƒåˆ©ç”¨ Instrumentation æ¥æ›´æ”¹å·²åŠ è½½åˆ° JVM çš„ç±»ï¼Œä¾‹å¦‚å¾€åŸç±»æ’å…¥ç”¨äºæ¢æµ‹æˆ–è¿½è¸ªçš„ä»£ç ï¼Œå³æ‰€è°“çš„åŸ‹ç‚¹ï¼Œå®ƒçš„åº•å±‚å®ç°ä¾èµ–äº JVMTI (Java Virtual Machine Tool Interface)ã€‚\nIn the context of computer programming, instrumentation refers to an ability to monitor or measure the level of a product\u0026rsquo;s performance, to diagnose errors, and to write trace information. [1]\nä¸Šé¢è¿™ä¸€æ®µæ˜¯ instrumentation åœ¨ç»´åŸºç™¾ç§‘çš„å®šä¹‰ï¼Œinstrumentation æ˜¯ä¸€ç§ç›‘æ§æˆ–æµ‹é‡åº”ç”¨ç¨‹åºæ€§èƒ½ï¼Œè¯Šæ–­é”™è¯¯ä»¥åŠå†™å…¥è·Ÿè¸ªä¿¡æ¯çš„èƒ½åŠ›ï¼Œæ­¤åŒ…å½“ä¸­çš„ java.lang.instrument.Instrumentation æ¥å£ï¼Œäº¦æ˜¯å¦‚æ­¤ï¼š\nThis class provides services needed to instrument Java programming language code. Instrumentation is the addition of byte-codes to methods for the purpose of gathering data to be utilized by tools. Since the changes are purely additive, these tools do not modify application state or behavior. Examples of such benign tools include monitoring agents, profilers, coverage analyzers, and event loggers. [2]\nå®ƒè¢«ç›‘æ§ä»£ç†ï¼Œåˆ†æå™¨ï¼Œè¦†ç›–ç‡åˆ†æä»ªï¼Œäº‹ä»¶è®°å½•å™¨ç­‰å·¥å…·æ‰€ä½¿ç”¨ï¼Œè¯¸å¦‚ jvisualvmã€JProfilerã€Arthas ç­‰ï¼Œè¿™äº›å·¥å…·é€šå¸¸ä¸ä¼šæ”¹å˜ç›®æ ‡ç¨‹åºçš„çŠ¶æ€æˆ–è¡Œä¸ºã€‚\nä½“éªŒ å¦‚ä½•ä»¥éä¾µå…¥å¼æµ‹é‡ Java æ–¹æ³•æ‰§è¡Œè€—æ—¶ï¼Ÿä½ å¯èƒ½ç«‹é©¬æƒ³åˆ°äº†æ“ä½œå­—èŠ‚ç çš„åº“æˆ–æ¡†æ¶ï¼Œæ¯”å¦‚ JDK åŠ¨æ€ä»£ç†ã€cglibã€ASMã€javassistã€byte-buddy\u0026hellip;\u0026hellip;é€šè¿‡æ“ä½œå­—èŠ‚ç åœ¨æ–¹æ³•æˆ–ä»£ç å—æ‰§è¡Œå‰åæ’å…¥è®¡æ—¶ä»£ç ï¼Œä½†å´ææœ‰å¯èƒ½éœ€è¦æ‰‹åŠ¨æ›´æ”¹åŸæ¥çš„ç¨‹åºä»£ç ï¼Œä¾‹å¦‚æ·»åŠ ä¾èµ–é¡¹ä»¥åŠæ–°å¢åˆ‡é¢ç±»ç­‰ç­‰ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œé‚£å°±è¯· Java agent å¸®å¿™å§ã€‚\nå‡è®¾æœ‰ä¸€ä¸ª Cat ç±»ï¼Œå®ƒæœ‰ä¸€äº›è€—æ—¶æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 public class Cat { public static void run() throws InterruptedException { System.out.println(\u0026#34;Cat is running\u0026#34;); Thread.sleep(RandomUtils.nextLong(3, 7)); } } ç°åœ¨è¦åˆ©ç”¨ Java agent æµ‹é‡ run æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ï¼Œåˆ™éœ€å…ˆæ„å»º Java agentï¼Œå› ä¸ºå®ƒæ˜¯ Jar æ–‡ä»¶ï¼Œè¦å¯¹è¢«æ¢æµ‹æˆ–è¿½è¸ªçš„ç¨‹åºèµ·ä½œç”¨å¿…ç„¶è¦å…ˆåŠ è½½åˆ° JVMï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€æ˜¯åœ¨ JVM å¯åŠ¨æ—¶é€šè¿‡å‘½ä»¤è¡Œæ¥å£å¼€å¯ agentï¼›äºŒæ˜¯ JVM å¯åŠ¨åé€šè¿‡ Java Attach API æŠŠ agent é™„åŠ åˆ° JVMã€‚\né¦–å…ˆä»¥ç¬¬ä¸€ç§æ–¹å¼æ¥è€ƒè™‘ agent ç±»ï¼š\n1 2 3 4 5 6 public class ElapsedTimeAgent { public static void premain(String agentArgs, Instrumentation inst) { inst.addTransformer(new ElapsedTimeTransformer(agentArgs)); } } æ­¤ç±»å®ç°äº†ä¸€ä¸ª premain æ–¹æ³•ï¼Œå®ƒä¸æˆ‘ä»¬å¸¸è§çš„ main æ–¹æ³•ç›¸ä¼¼ï¼Œä¸ä»…éƒ½æ˜¯ä½œä¸ºæ‰§è¡Œçš„å…¥å£ç‚¹ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ–¹æ³•å‚æ•°çš„å€¼æ¥æºäºå‘½ä»¤è¡Œï¼Œä¸è¿‡å‚æ•°ç±»å‹æ˜¯å­—ç¬¦ä¸²è€Œä¸æ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼Œå‘½ä»¤è¡Œå‚æ•°çš„è§£æäº¤ç”±ç”¨æˆ·å®ç°ï¼›ç¬¬äºŒä¸ªå‚æ•°ç±»å‹æ˜¯ Instrumentationï¼Œæœ‰ä¸¤ç§è·å¾—å…¶å®ä¾‹çš„æ–¹å¼ï¼š\nå½“ä»¥æŒ‡å®šäº† Java agent çš„æ–¹å¼å¯åŠ¨ JVMï¼ŒInstrumentation å®ä¾‹å°†ä¼ é€’ç»™ agent ç±»çš„ premain æ–¹æ³•ã€‚\nå½“ Java agent é™„åŠ åˆ°å¯åŠ¨åçš„ JVMï¼ŒInstrumentation å®ä¾‹å°†ä¼ é€’åˆ° agent ç±»çš„ agentmain æ–¹æ³•ã€‚\nè¿™ä¸¤ç§æ–¹å¼ä¸åŠ è½½ Java agent çš„æ–¹å¼ä¸€ä¸€å¯¹åº”ã€‚Instrumentation çš„ addTransformer æ–¹æ³•ç”¨äºæ³¨å†Œå·²æä¾›çš„ transformerï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 public class ElapsedTimeTransformer implements ClassFileTransformer { private String agentArgs; public ElapsedTimeTransformer() { } public ElapsedTimeTransformer(String agentArgs) { this.agentArgs = agentArgs; } @Override public byte[] transform(ClassLoader loader, String className, Class\u0026lt;?\u0026gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException { byte[] bytecode = classfileBuffer; if (className.equals(agentArgs)) { ClassPool classPool = ClassPool.getDefault(); try { CtClass ctClass = classPool.makeClass(new ByteArrayInputStream(classfileBuffer)); CtMethod[] methods = ctClass.getDeclaredMethods(); for (CtMethod method : methods) { method.addLocalVariable(\u0026#34;begin\u0026#34;, CtClass.longType); method.addLocalVariable(\u0026#34;end\u0026#34;, CtClass.longType); method.insertBefore(\u0026#34;begin = System.nanoTime();\u0026#34;); method.insertAfter(\u0026#34;end = System.nanoTime();\u0026#34;); String methodName = method.getLongName(); String x = \u0026#34;System.out.println(\\\u0026#34;\u0026#34; + methodName + \u0026#34;\\\u0026#34; + \\\u0026#34;: \\\u0026#34; + (end - begin) + \\\u0026#34; ns\\\u0026#34;\u0026#34; + \u0026#34;);\u0026#34;; method.insertAfter(x); } bytecode = ctClass.toBytecode(); ctClass.detach(); } catch (IOException | CannotCompileException e) { e.printStackTrace(); } } return bytecode; } } é‡å†™ transform æ–¹æ³•å…è®¸æˆ‘ä»¬ç”¨æ›´æ”¹åçš„ç±»ä»£æ›¿åŸç±»å¹¶åŠ è½½ã€‚å…·ä½“å®ç°æ˜¯ä½¿ç”¨ javassist çš„ API å»æ›´æ”¹å·²åŠ è½½ç±»çš„å­—èŠ‚ç ï¼Œåœ¨ç±»æ–¹æ³•ä½“çš„å¼€å¤´å’Œç»“å°¾åˆ†åˆ«æ’å…¥è·å–å½“å‰çš„çº³ç§’çº§æ—¶é—´æˆ³è¯­å¥ï¼Œå¹¶åœ¨æœ€åæ’å…¥è®¡ç®—ç»“æœçš„æ‰“å°è¯­å¥ï¼Œæ–°ç±»çš„å­—èŠ‚ç ä½œä¸º transform æ–¹æ³•çš„è¿”å›å€¼ã€‚transform æ–¹æ³•ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨ï¼Ÿæ¯ä¸€ä¸ªæ–°ç±»è¢«ç±»åŠ è½½å™¨åŠ è½½æ—¶ã€‚\nå…¶æ¬¡ï¼Œæ–°å»º MANIFEST.MF æ–‡ä»¶ç¼–å†™ä¸€äº›é”®å€¼å¯¹å‘Šè¯‰ JVM è¿™ä¸ª agent ç±»åœ¨å“ªé‡Œä»¥åŠæ˜¯å¦å…è®¸é‡å®šä¹‰ç±»æˆ–é‡è½¬æ¢ç±»ï¼š\n1 2 3 4 Manifest-Version: 1.0 Premain-Class: io.h2cone.trace.agent.ElapsedTimeAgent Can-Redefine-Classes: true Can-Retransform-Classes: true å†æ¬¡ï¼Œåˆ©ç”¨ Maven æ’ä»¶æ„å»º agent jar æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-assembly-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.1.1\u0026lt;/version\u0026gt; \u0026lt;executions\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;phase\u0026gt;package\u0026lt;/phase\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;single\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;finalName\u0026gt;agent\u0026lt;/finalName\u0026gt; \u0026lt;archive\u0026gt; \u0026lt;manifestFile\u0026gt;src/main/resources/META-INF/MANIFEST.MF\u0026lt;/manifestFile\u0026gt; \u0026lt;/archive\u0026gt; \u0026lt;descriptorRefs\u0026gt; \u0026lt;descriptorRef\u0026gt;jar-with-dependencies\u0026lt;/descriptorRef\u0026gt; \u0026lt;/descriptorRefs\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;/executions\u0026gt; \u0026lt;/plugin\u0026gt; ç„¶åï¼Œç»™ Cat ç±»ç¼–å†™æµ‹è¯•ç”¨çš„ä¸»ç±»ï¼š\n1 2 3 4 5 6 public class CatMain { public static void main(String[] args) throws InterruptedException { Cat.run(); } } å¹¶æŠŠä¸¤è€…æ„å»ºæˆå¯æ‰§è¡Œä¸”åä¸º app çš„ jar æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-shade-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.1\u0026lt;/version\u0026gt; \u0026lt;executions\u0026gt; \u0026lt;execution\u0026gt; \u0026lt;goals\u0026gt; \u0026lt;goal\u0026gt;shade\u0026lt;/goal\u0026gt; \u0026lt;/goals\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;finalName\u0026gt;app\u0026lt;/finalName\u0026gt; \u0026lt;shadedArtifactAttached\u0026gt;true\u0026lt;/shadedArtifactAttached\u0026gt; \u0026lt;transformers\u0026gt; \u0026lt;transformer implementation= \u0026#34;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer\u0026#34;\u0026gt; \u0026lt;mainClass\u0026gt;io.h2cone.inst.app.CatMain\u0026lt;/mainClass\u0026gt; \u0026lt;/transformer\u0026gt; \u0026lt;/transformers\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/execution\u0026gt; \u0026lt;/executions\u0026gt; \u0026lt;/plugin\u0026gt; æœ€åï¼Œå¾—åˆ°äº† agent-jar-with-dependencies.jar å’Œ app.jar åï¼ŒæŸ¥é˜… Java agent å‘½ä»¤è¡Œæ¥å£æ–‡æ¡£ï¼š\n1 -javaagent:jarpath[=options] jarpath æ˜¯ agent jar æ–‡ä»¶çš„è·¯å¾„ï¼Œå¯é€‰çš„ options èƒ½ä¼ é€’ç»™ agent ç±»çš„ premain æ–¹æ³•ï¼Œè¿™é‡Œä¼ é€’ Cat ç±»çš„å‘½åï¼šio/h2cone/inst/app/Catï¼Œè¡¨ç¤ºæˆ‘ä»¬è¦æµ‹é‡å®ƒçš„æ–¹æ³•æ‰§è¡Œæ—¶é—´ï¼š\n1 java -javaagent:agent-jar-with-dependencies.jar=io/h2cone/inst/app/Cat -jar app.jar ç»“æœè¡¨æ˜ï¼Œä¸ä»… Cat ç±»çš„ run æ–¹æ³•æ­£å¸¸æ‰§è¡Œï¼Œè€Œä¸”è¾“å‡ºäº†è¯¥æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ï¼š\n1 2 Cat is running io.h2cone.inst.app.Cat.run(): 73993800 ns å®Œæ•´ä»£ç å·²å‘å¸ƒï¼Œè¯·å‚è€ƒ inst-agent å’Œ inst-appã€‚\nAttach ç®€è¿° ç¿»é˜… Oracle JDK æ–‡æ¡£å¯ä»¥æ‰¾åˆ°åä¸º com.sun.tools.attach çš„åŒ…ï¼š\nProvides the API to attach to a Java virtual machine. [3]\nåœ¨ä¸Šä¸€èŠ‚ï¼Œåˆ—å‡ºäº†åŠ è½½ Java agent çš„ä¸¤ç§æ–¹å¼ï¼Œç¬¬äºŒç§æ–¹å¼ä½¿ç”¨ Attach APIï¼ŒæŠŠ Java agent é™„åŠ åˆ°å¯åŠ¨åçš„ JVMï¼Œé‡‡ç”¨è¿™ç§æ–¹å¼æ— éœ€é‡å¯ JVMã€‚Attach æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿåˆæ­¥å¤§èƒ†çŒœæƒ³ï¼Œåˆ©ç”¨ Attach API ç¼–å†™è€Œæˆçš„ç¨‹åºä¸ç›®æ ‡ JVM è¿›è¡Œäº†çº¿ç¨‹é—´é€šä¿¡ï¼Œä¼ è¾“ Java agent å¹¶è£…è½½åˆ°ç›®æ ‡ JVMã€‚\nè·Ÿè¸ªç¨‹åºé€šè¿‡ Unix Domain Socket ä¸ç›®æ ‡ JVM çš„ Attach Listener çº¿ç¨‹è¿›è¡Œäº¤äº’ã€‚[4]\nä¾‹å­ ç¼–å†™ä¸€åªå¯ä»¥æŒç»­æ±ªæ±ªå«çš„å°ç‹—ï¼š\n1 2 3 4 5 6 7 8 9 10 11 public class DogMain { public static void main(String[] args) throws InterruptedException { String name = ManagementFactory.getRuntimeMXBean().getName(); System.out.printf(\u0026#34;managed bean name: %s\\n\u0026#34;, name); while (true) { Thread.sleep(10000); CompletableFuture.runAsync(() -\u0026gt; System.out.println(\u0026#34;Woof Woof\u0026#34;)); } } } è¿™ä¸ªç¨‹åºè·‘èµ·æ¥å 20 ç§’å†…è¾“å‡ºï¼š\n1 2 managed bean name: 5424@borvino Woof Woof æ³¨æ„ managed bean name çš„å€¼ä¸º 5424@borvinoï¼Œå½“ä¸­çš„ 5424 å°±æ˜¯è¿™ä¸ªè¿›ç¨‹çš„ PIDã€‚\næ–¹ä¾¿èµ·è§ï¼Œç¼–å†™ç®€æ˜“çš„ agent ç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 public class OwnerAgent { public static void agentmain(String agentArgs, Instrumentation inst) throws Exception { System.out.println(\u0026#34;agentmain agentArgs: \u0026#34; + agentArgs); System.out.println(\u0026#34;agentmain inst: \u0026#34; + inst); } public static void premain(String agentArgs, Instrumentation inst) throws Exception { System.out.println(\u0026#34;premain agentArgs: \u0026#34; + agentArgs); System.out.println(\u0026#34;premain inst: \u0026#34; + inst); } } å›æƒ³å‰æ–‡æ‰€è¯´çš„è·å– Instrumentation å®ä¾‹çš„ä¸¤ç§æ–¹å¼ï¼Œå½“æŠŠ Java agent é™„åŠ åˆ° JVM æ—¶ï¼ŒInstrumentation å®ä¾‹å°†ä¼ é€’åˆ° agent ç±»çš„ agentmain æ–¹æ³•ï¼Œä¹Ÿæ˜¯å°±è¯´ agentmain å°†ä¼šè¢«è°ƒç”¨ã€‚\nä¸å¿˜ç¼–å†™ MANIFEST.MF æ–‡ä»¶ï¼š\n1 2 3 4 5 Manifest-Version: 1.0 Premain-Class: io.h2cone.attach.agent.OwnerAgent Agent-Class: io.h2cone.attach.agent.OwnerAgent Can-Redefine-Classes: true Can-Retransform-Classes: true æ—¢å£°æ˜ Agent-Class ä¹Ÿå£°æ˜ Premain-Classï¼ŒOwnerAgent ç±»åŒæ—¶æ»¡è¶³ä¸¤ç§æ–¹å¼æ‰€è¦æ±‚çš„æ–¹æ³•ç­¾åã€‚\nä¸ä¸Šæ–‡ç›¸ä¼¼ï¼Œæ‰“åŒ…å¥½ agent.jar åï¼Œæ–¹ä¾¿èµ·è§ï¼Œç›´æ¥ç”¨ IDE å¯åŠ¨ DogMainï¼Œä»æ§åˆ¶å°è¯»å–ç›®æ ‡ JVM çš„ PIDï¼Œä¸‡äº‹ä¿±å¤‡ï¼Œé¦–å…ˆä¾é™„åˆ° JVMï¼Œç„¶ååŠ¨æ€åŠ è½½ agent åˆ° JVMï¼Œæœ€ååˆ†ç¦»ï¼š\n1 2 3 4 5 6 7 8 9 10 @Test public void attach() throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException { String pid = \u0026#34;pid\u0026#34;; // ç›®æ ‡ JVM çš„ PID VirtualMachine vm = VirtualMachine.attach(pid); String agentJarPath = \u0026#34;path to agent.jar\u0026#34;; // agent.jar æ–‡ä»¶çš„è·¯å¾„ String options = \u0026#34;Hello, Dog\u0026#34;; vm.loadAgent(agentJarPath, options); vm.detach(); } è¯•éªŒç»“æœï¼š\n1 2 3 4 5 6 managed bean name: 5424@borvino Woof Woof agentmain agentArgs: Hello, Dog agentmain inst: sun.instrument.InstrumentationImpl@4c4744d8 Woof Woof Woof Woof OwnerAgent ç±»çš„ agentmain æ–¹æ³•è¢«è°ƒç”¨ï¼ŒDogMain çš„ main æ–¹æ³•ä¹Ÿæ­£å¸¸æ‰§è¡Œã€‚\nå®Œæ•´ä»£ç å·²å‘å¸ƒï¼Œè¯·å‚è€ƒ attach-agent å’Œ attach-appã€‚\næ¶æ„ç¨‹åº Test.classï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public class Test { public static void main(String[] paramArrayOfString) throws AgentLoadException, AgentInitializationException, IOException, AttachNotSupportedException { attach(paramArrayOfString[0]); } public static void attach(String paramString) throws AgentLoadException, AgentInitializationException, IOException, AttachNotSupportedException { String str1 = paramString; String str2 = (new File(\u0026#34;agent.jar\u0026#34;)).getAbsolutePath(); System.out.println(\u0026#34;attaching....pid=\u0026#34; + str1); VirtualMachine virtualMachine = VirtualMachine.attach(str1); virtualMachine.loadAgent(str2, null); virtualMachine.detach(); } } agent.jar/HotSwapAgent.classï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public class HotSwapAgent { public static void premain(String paramString, Instrumentation paramInstrumentation) {} public static void agentmain(String paramString, Instrumentation paramInstrumentation) { try { Class[] arrayOfClass = paramInstrumentation.getAllLoadedClasses(); for (Class\u0026lt;?\u0026gt; clazz : arrayOfClass) { if (clazz.getName().equals(\u0026#34;org.apache.shiro.web.servlet.AbstractShiroFilter\u0026#34;)) { System.out.println(clazz.getName()); byte[] arrayOfByte = (new BASE64Decoder()).decodeBuffer(\u0026#34;yv66vgAAADIBbQoAYgCvCQBgALAJAGAAsQkAYACyCgBgALMKAGAAtAoAYAC1CgBgALYKAGAAtwoAuAC5CABuCgBgALoKALsAvAoAuwC9CgBgAL4JAGAAvwgAwAsAwQDCCgBgAMMKAGAAxAcAxQoAFQCvCwDGAMcHAMgKAGAAyQoAYADKCgAYAMsHAMwKAGAAzQcAzgoAHgDPBwDQCgBgANEHANMKACIA1QoAIgDWCgC4ANcLANgA2QsA2gDbBwDcCADdCwDBAN4JAN8A4AoA4QDiCADjCwAcAOQIAOUKAN8A5goANADnCADoCgA0AOkHAOoIAOsIAOwIAO0IAO4HAO8KADkA8AoAOQDxCgA5APIKAPMA9AcA9QoAPgCvCgD2APcKAD4A+AoAPgD5BwD6CwAgAPsKAEMA/AoAPgD9CgA0AP4KAEMA/woAQwD5CgBDAQAKAGABAQoAYAECCgBgAQMHAQQKAE4BBQsA2AEGBwEHCgBRAQgHAQkHAQoIAQsKAFMBDAoAYAENCAEOCwDBAQ8LARABEQgBEgsAwQETCAEUCgBgARULARYBFwcBGAoBGQEaBwEbAQAAAQAMSW5uZXJDbGFzc2VzAQADbG9nAQASTG9yZy9zbGY0ai9Mb2dnZXI7AQAWU1RBVElDX0lOSVRfUEFSQU1fTkFNRQEAEkxqYXZhL2xhbmcvU3RyaW5nOwEADUNvbnN0YW50VmFsdWUBAA9zZWN1cml0eU1hbmFnZXIBAC1Mb3JnL2FwYWNoZS9zaGlyby93ZWIvbWd0L1dlYlNlY3VyaXR5TWFuYWdlcjsBABNmaWx0ZXJDaGFpblJlc29sdmVyAQA1TG9yZy9hcGFjaGUvc2hpcm8vd2ViL2ZpbHRlci9tZ3QvRmlsdGVyQ2hhaW5SZXNvbHZlcjsBABxzdGF0aWNTZWN1cml0eU1hbmFnZXJFbmFibGVkAQABWgEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJnZXRTZWN1cml0eU1hbmFnZXIBAC8oKUxvcmcvYXBhY2hlL3NoaXJvL3dlYi9tZ3QvV2ViU2VjdXJpdHlNYW5hZ2VyOwEAEnNldFNlY3VyaXR5TWFuYWdlcgEAMChMb3JnL2FwYWNoZS9zaGlyby93ZWIvbWd0L1dlYlNlY3VyaXR5TWFuYWdlcjspVgEAFmdldEZpbHRlckNoYWluUmVzb2x2ZXIBADcoKUxvcmcvYXBhY2hlL3NoaXJvL3dlYi9maWx0ZXIvbWd0L0ZpbHRlckNoYWluUmVzb2x2ZXI7AQAWc2V0RmlsdGVyQ2hhaW5SZXNvbHZlcgEAOChMb3JnL2FwYWNoZS9zaGlyby93ZWIvZmlsdGVyL21ndC9GaWx0ZXJDaGFpblJlc29sdmVyOylWAQAeaXNTdGF0aWNTZWN1cml0eU1hbmFnZXJFbmFibGVkAQADKClaAQAfc2V0U3RhdGljU2VjdXJpdHlNYW5hZ2VyRW5hYmxlZAEABChaKVYBABFvbkZpbHRlckNvbmZpZ1NldAEADVN0YWNrTWFwVGFibGUBAApFeGNlcHRpb25zBwEcAQAnYXBwbHlTdGF0aWNTZWN1cml0eU1hbmFnZXJFbmFibGVkQ29uZmlnBwDqAQAEaW5pdAEAFWVuc3VyZVNlY3VyaXR5TWFuYWdlcgcBHQEAHGNyZWF0ZURlZmF1bHRTZWN1cml0eU1hbmFnZXIBAA5pc0h0dHBTZXNzaW9ucwEAEndyYXBTZXJ2bGV0UmVxdWVzdAEARyhMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDspTGphdmF4L3NlcnZsZXQvU2VydmxldFJlcXVlc3Q7AQAVcHJlcGFyZVNlcnZsZXRSZXF1ZXN0AQB4KExqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTtMamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbjspTGphdmF4L3NlcnZsZXQvU2VydmxldFJlcXVlc3Q7BwEeAQATd3JhcFNlcnZsZXRSZXNwb25zZQEAfyhMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7TG9yZy9hcGFjaGUvc2hpcm8vd2ViL3NlcnZsZXQvU2hpcm9IdHRwU2VydmxldFJlcXVlc3Q7KUxqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTsBABZwcmVwYXJlU2VydmxldFJlc3BvbnNlAQB5KExqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTtMamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbjspTGphdmF4L3NlcnZsZXQvU2VydmxldFJlc3BvbnNlOwcBHwEADWNyZWF0ZVN1YmplY3QBAGgoTGphdmF4L3NlcnZsZXQvU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvU2VydmxldFJlc3BvbnNlOylMb3JnL2FwYWNoZS9zaGlyby93ZWIvc3ViamVjdC9XZWJTdWJqZWN0OwEAG3VwZGF0ZVNlc3Npb25MYXN0QWNjZXNzVGltZQEAQChMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7KVYHARgHASAHASEHANwBABBkb0ZpbHRlckludGVybmFsAQBbKExqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTtMamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbjspVgcBIgcAzAcA0AcBIwcA7wcBJAcA9QcBJQcBBwEAEWdldEV4ZWN1dGlvbkNoYWluAQB1KExqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTtMamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbjspTGphdmF4L3NlcnZsZXQvRmlsdGVyQ2hhaW47BwEmAQAMZXhlY3V0ZUNoYWluAQAIPGNsaW5pdD4BAApTb3VyY2VGaWxlAQAYQWJzdHJhY3RTaGlyb0ZpbHRlci5qYXZhDABwAHEMAG4AbwwAagBrDABsAG0MAIQAcQwAhgBxDACHAHEMAHwAfQwAdAB1BwEnDAB2ASgMASkBKgcBKwwBLAEtDAEuAH0MAH4AfwwAZQBmAQAxTm8gU2VjdXJpdHlNYW5hZ2VyIGNvbmZpZ3VyZWQuICBDcmVhdGluZyBkZWZhdWx0LgcBLwwBMAExDACJAHUMAHYAdwEAMm9yZy9hcGFjaGUvc2hpcm8vd2ViL21ndC9EZWZhdWx0V2ViU2VjdXJpdHlNYW5hZ2VyBwEdDAEyAH0BADRvcmcvYXBhY2hlL3NoaXJvL3dlYi9zZXJ2bGV0L1NoaXJvSHR0cFNlcnZsZXRSZXF1ZXN0DAEzATQMAIoAfQwAcAE1AQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAwAiwCMAQA1b3JnL2FwYWNoZS9zaGlyby93ZWIvc2VydmxldC9TaGlyb0h0dHBTZXJ2bGV0UmVzcG9uc2UMAHABNgEAJmphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlDACQAJEHATcBAC9vcmcvYXBhY2hlL3NoaXJvL3dlYi9zdWJqZWN0L1dlYlN1YmplY3QkQnVpbGRlcgEAB0J1aWxkZXIMAHABOAwBOQE6DAE7ATwHASAMAT0BPgcBIQwBPwBxAQATamF2YS9sYW5nL1Rocm93YWJsZQEAinNlc3Npb24udG91Y2goKSBtZXRob2QgaW52b2NhdGlvbiBoYXMgZmFpbGVkLiAgVW5hYmxlIHRvIHVwZGF0ZXRoZSBjb3JyZXNwb25kaW5nIHNlc3Npb24ncyBsYXN0IGFjY2VzcyB0aW1lIGJhc2VkIG9uIHRoZSBpbmNvbWluZyByZXF1ZXN0LgwBQAFBBwFCDAFDAUQHAUUMAUYAfwEAA0NNRAwBRwEqAQAHb3MubmFtZQwBSAEqDAFJAUoBAAd3aW5kb3dzDAFLAUwBABBqYXZhL2xhbmcvU3RyaW5nAQAHY21kLmV4ZQEABy9iaW4vc2gBAAIvYwEAAi1jAQAYamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyDABwAU0MAU4BTwwBUAFRBwFSDAFTAVQBAB1qYXZhL2lvL0J5dGVBcnJheU91dHB1dFN0cmVhbQcBJAwBVQFWDAFXAVgMAVkAcQEAE2phdmEvaW8vUHJpbnRXcml0ZXIMAVoBWwwAcAFcDAFdAV4MAHABXwwBVwExDAFgAHEMAI0AjgwAkgCTDACVAJYBADJvcmcvYXBhY2hlL3NoaXJvL3dlYi9zZXJ2bGV0L0Fic3RyYWN0U2hpcm9GaWx0ZXIkMQwAcAFhDAFiAWMBACtvcmcvYXBhY2hlL3NoaXJvL3N1YmplY3QvRXhlY3V0aW9uRXhjZXB0aW9uDAFkAWUBAB5qYXZheC9zZXJ2bGV0L1NlcnZsZXRFeGNlcHRpb24BABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAYRmlsdGVyZWQgcmVxdWVzdCBmYWlsZWQuDABwAUEMAHgAeQEAQ05vIEZpbHRlckNoYWluUmVzb2x2ZXIgY29uZmlndXJlZC4gIFJldHVybmluZyBvcmlnaW5hbCBGaWx0ZXJDaGFpbi4MAWYBMQcBJgwBZwCpAQA6UmVzb2x2ZWQgYSBjb25maWd1cmVkIEZpbHRlckNoYWluIGZvciB0aGUgY3VycmVudCByZXF1ZXN0LgwBaAExAQBGTm8gRmlsdGVyQ2hhaW4gY29uZmlndXJlZCBmb3IgdGhlIGN1cnJlbnQgcmVxdWVzdC4gIFVzaW5nIHRoZSBkZWZhdWx0LgwAqACpBwEiDAFpAJgBADBvcmcvYXBhY2hlL3NoaXJvL3dlYi9zZXJ2bGV0L0Fic3RyYWN0U2hpcm9GaWx0ZXIHAWoMAWsBbAEAMW9yZy9hcGFjaGUvc2hpcm8vd2ViL3NlcnZsZXQvT25jZVBlclJlcXVlc3RGaWx0ZXIBABNqYXZhL2xhbmcvRXhjZXB0aW9uAQArb3JnL2FwYWNoZS9zaGlyby93ZWIvbWd0L1dlYlNlY3VyaXR5TWFuYWdlcgEAHGphdmF4L3NlcnZsZXQvU2VydmxldFJlcXVlc3QBAB1qYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZQEAIG9yZy9hcGFjaGUvc2hpcm8vc3ViamVjdC9TdWJqZWN0AQAgb3JnL2FwYWNoZS9zaGlyby9zZXNzaW9uL1Nlc3Npb24BABlqYXZheC9zZXJ2bGV0L0ZpbHRlckNoYWluAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEAE2phdmEvaW8vSW5wdXRTdHJlYW0BAAJbQgEAM29yZy9hcGFjaGUvc2hpcm8vd2ViL2ZpbHRlci9tZ3QvRmlsdGVyQ2hhaW5SZXNvbHZlcgEAHm9yZy9hcGFjaGUvc2hpcm8vU2VjdXJpdHlVdGlscwEAKShMb3JnL2FwYWNoZS9zaGlyby9tZ3QvU2VjdXJpdHlNYW5hZ2VyOylWAQAMZ2V0SW5pdFBhcmFtAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsBABFqYXZhL2xhbmcvQm9vbGVhbgEAB3ZhbHVlT2YBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvQm9vbGVhbjsBAAxib29sZWFuVmFsdWUBABBvcmcvc2xmNGovTG9nZ2VyAQAEaW5mbwEAFShMamF2YS9sYW5nL1N0cmluZzspVgEAEWlzSHR0cFNlc3Npb25Nb2RlAQARZ2V0U2VydmxldENvbnRleHQBACAoKUxqYXZheC9zZXJ2bGV0L1NlcnZsZXRDb250ZXh0OwEASShMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0Q29udGV4dDtaKVYBAH8oTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlO0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRDb250ZXh0O0xvcmcvYXBhY2hlL3NoaXJvL3dlYi9zZXJ2bGV0L1NoaXJvSHR0cFNlcnZsZXRSZXF1ZXN0OylWAQAnb3JnL2FwYWNoZS9zaGlyby93ZWIvc3ViamVjdC9XZWJTdWJqZWN0AQBmKExvcmcvYXBhY2hlL3NoaXJvL21ndC9TZWN1cml0eU1hbmFnZXI7TGphdmF4L3NlcnZsZXQvU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvU2VydmxldFJlc3BvbnNlOylWAQAPYnVpbGRXZWJTdWJqZWN0AQArKClMb3JnL2FwYWNoZS9zaGlyby93ZWIvc3ViamVjdC9XZWJTdWJqZWN0OwEACmdldFN1YmplY3QBACQoKUxvcmcvYXBhY2hlL3NoaXJvL3N1YmplY3QvU3ViamVjdDsBAApnZXRTZXNzaW9uAQAlKFopTG9yZy9hcGFjaGUvc2hpcm8vc2Vzc2lvbi9TZXNzaW9uOwEABXRvdWNoAQAFZXJyb3IBACooTGphdmEvbGFuZy9TdHJpbmc7TGphdmEvbGFuZy9UaHJvd2FibGU7KVYBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BAAlnZXRIZWFkZXIBAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAdpbmRleE9mAQAVKExqYXZhL2xhbmcvU3RyaW5nOylJAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEAE3JlZGlyZWN0RXJyb3JTdHJlYW0BAB0oWilMamF2YS9sYW5nL1Byb2Nlc3NCdWlsZGVyOwEABXN0YXJ0AQAVKClMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAEcmVhZAEABShbQilJAQAFd3JpdGUBAAcoW0JJSSlWAQAFZmx1c2gBAA9nZXRPdXRwdXRTdHJlYW0BACUoKUxqYXZheC9zZXJ2bGV0L1NlcnZsZXRPdXRwdXRTdHJlYW07AQAZKExqYXZhL2lvL091dHB1dFN0cmVhbTspVgEAC3RvQnl0ZUFycmF5AQAEKClbQgEABShbQilWAQAFY2xvc2UBAI0oTG9yZy9hcGFjaGUvc2hpcm8vd2ViL3NlcnZsZXQvQWJzdHJhY3RTaGlyb0ZpbHRlcjtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7TGphdmF4L3NlcnZsZXQvRmlsdGVyQ2hhaW47KVYBAAdleGVjdXRlAQAzKExqYXZhL3V0aWwvY29uY3VycmVudC9DYWxsYWJsZTspTGphdmEvbGFuZy9PYmplY3Q7AQAIZ2V0Q2F1c2UBABcoKUxqYXZhL2xhbmcvVGhyb3dhYmxlOwEABWRlYnVnAQAIZ2V0Q2hhaW4BAAV0cmFjZQEACGRvRmlsdGVyAQAXb3JnL3NsZjRqL0xvZ2dlckZhY3RvcnkBAAlnZXRMb2dnZXIBACUoTGphdmEvbGFuZy9DbGFzczspTG9yZy9zbGY0ai9Mb2dnZXI7BCEAYABiAAAABQAaAGUAZgAAABoAZwBoAAEAaQAAAAIACwACAGoAawAAAAIAbABtAAAAAgBuAG8AAAAXAAQAcABxAAEAcgAAACoAAgABAAAACiq3AAEqA7UAArEAAAABAHMAAAAOAAMAAABdAAQAXgAJAF8AAQB0AHUAAQByAAAAHQABAAEAAAAFKrQAA7AAAAABAHMAAAAGAAEAAABiAAEAdgB3AAEAcgAAACIAAgACAAAABiortQADsQAAAAEAcwAAAAoAAgAAAGYABQBnAAEAeAB5AAEAcgAAAB0AAQABAAAABSq0AASwAAAAAQBzAAAABgABAAAAagABAHoAewABAHIAAAAiAAIAAgAAAAYqK7UABLEAAAABAHMAAAAKAAIAAABuAAUAbwABAHwAfQABAHIAAAAdAAEAAQAAAAUqtAACrAAAAAEAcwAAAAYAAQAAAIIAAQB+AH8AAQByAAAAIgACAAIAAAAGKhu1AAKxAAAAAQBzAAAACgACAAAAkgAFAJMAFACAAHEAAgByAAAAUAABAAEAAAAbKrcABSq2AAYqtwAHKrYACJkACiq2AAm4AAqxAAAAAgBzAAAAGgAGAAAAlwAEAJgACACZAAwAmwATAJwAGgCeAIEAAAADAAEaAIIAAAAEAAEAgwACAIQAcQABAHIAAABXAAIAAwAAAB0qEgu2AAxMK8YAFCu4AA1NLMYACyostgAOtgAPsQAAAAIAcwAAABoABgAAAKgABwCpAAsAqgAQAKsAFACsABwArwCBAAAACAAB/AAcBwCFAAEAhgBxAAIAcgAAABkAAAABAAAAAbEAAAABAHMAAAAGAAEAAACyAIIAAAAEAAEAgwACAIcAcQABAHIAAABYAAIAAgAAAB4qtgAJTCvHABeyABASEbkAEgIAKrYAE0wqK7YAFLEAAAACAHMAAAAaAAYAAAC6AAUAuwAJALwAEwC9ABgAvgAdAMAAgQAAAAgAAfwAHQcAiAAEAIkAdQABAHIAAAAgAAIAAQAAAAi7ABVZtwAWsAAAAAEAcwAAAAYAAQAAAMMABACKAH0AAQByAAAAIgABAAEAAAAKKrYACbkAFwEArAAAAAEAcwAAAAYAAQAAAMcABACLAIwAAQByAAAAKQAFAAIAAAARuwAYWSsqtgAZKrYAGrcAG7AAAAABAHMAAAAGAAEAAADTAAQAjQCOAAEAcgAAAFEAAgAGAAAAGys6BCvBAByZABErwAAcOgUqGQW2AB06BBkEsAAAAAIAcwAAABYABQAAAOYAAwDnAAoA6AAQAOkAGADrAIEAAAAIAAH8ABgHAI8ABACQAJEAAQByAAAAJgAFAAMAAAAOuwAeWSsqtgAZLLcAH7AAAAABAHMAAAAGAAEAAAD5AAQAkgCTAAEAcgAAAFsAAwAFAAAAKSw6BCq2ABqaAB8rwQAYmQAYLMEAIJkAESoswAAgK8AAGLYAIToEGQSwAAAAAgBzAAAAEgAEAAABEAADAREAGAEVACYBFwCBAAAACAAB/AAmBwCUAAQAlQCWAAEAcgAAACkABQADAAAAEbsAIlkqtgAJKyy3ACO2ACSwAAAAAQBzAAAABgABAAABJAAEAJcAmAABAHIAAACeAAMABgAAADYqtgAamgAxuAAlTi3GACktA7kAJgIAOgQZBMYAGxkEuQAnAQCnABE6BbIAEBIpGQW5ACoDALEAAQAdACQAJwAoAAIAcwAAACoACgAAATQABwE1AAsBNwAPATgAGAE5AB0BOwAkAT8AJwE8ACkBPQA1AUMAgQAAAB4AAv8AJwAFBwCZBwCPBwCUBwCaBwCbAAEHAJz5AA0ABACdAJ4AAgByAAADQQAHABAAAAFhAToEK8EAHJkA4bIAKyvBABy2ACwrwAAcOgUswAAgOgYZBRItuQAuAgA6BxkHxgC7Ei+4ADC2ADESMrYAMwKkAAcEpwAEAzYIBr0ANFkDFQiZAAgSNacABRI2U1kEFQiZAAgSN6cABRI4U1kFGQdTOgm7ADlZGQm3ADo6ChkKBLYAO1cZCrYAPLYAPToLuwA+WbcAPzoMEQQAvAg6DRkLGQ22AEBZNg4CpAAQGQwZDQMVDrYAQaf/6BkMtgBCuwBDWRkGuQBEAQC3AEU6DxkPuwA0WRkMtgBGtwBHtgBIGQ+2AEkZD7YASiorLC22AEs6BSoZBSwttgBMOgYqGQUZBrYATToHGQe7AE5ZKhkFGQYttwBPuQBQAgBXpwAVOgUZBbYAUjoEpwAJOgUZBToEGQTGAC8ZBMEAU5kACRkEwABTvxkEwQBUmQAJGQTAAFS/ElU6BbsAU1kZBRkEtwBWv7EAAgADARoBHQBRAAMBGgEpACgAAgBzAAAAngAnAAABYQADAWUACgFmABQBZwAaAWgAIAFqACsBawAwAW0ASAFuAHEBbwB8AXAAgwFxAI0BcgCWAXMAnQF1AKsBdgC4AXgAvQF6AM0BewDeAXwA4wF9AOgBhADxAYUA+wGHAQUBigEaAZUBHQGRAR8BkgEmAZUBKQGTASsBlAEvAZcBNAGYATwBmQFCAZsBSgGcAVABnwFUAaABYAGiAIEAAAEaAA//AEUACAcAmQcAjwcAlAcAnwcAnAcAoAcAoQcAhQAAQAH/ABEACQcAmQcAjwcAlAcAnwcAnAcAoAcAoQcAhQEAAwcAogcAogH/AAEACQcAmQcAjwcAlAcAnwcAnAcAoAcAoQcAhQEABAcAogcAogEHAIX/AAwACQcAmQcAjwcAlAcAnwcAnAcAoAcAoQcAhQEAAwcAogcAogH/AAEACQcAmQcAjwcAlAcAnwcAnAcAoAcAoQcAhQEABAcAogcAogEHAIX/ADMADgcAmQcAjwcAlAcAnwcAnAcAoAcAoQcAhQEHAKIHAKMHAKQHAKUHAKYAAPwAGgH/AC8ABQcAmQcAjwcAlAcAnwcAnAAAdAcAp0sHAJwFEg0PAIIAAAAGAAIAUwBUAAQAqACpAAEAcgAAAKEABAAHAAAASS06BCq2AFc6BRkFxwAPsgAQEli5AFkCAC2wGQUrLC25AFoEADoGGQbGABSyABASW7kAXAIAGQY6BKcADbIAEBJduQBcAgAZBLAAAAACAHMAAAAuAAsAAAG3AAMBuQAJAboADgG7ABgBvAAaAb8AJgHAACsBwQA1AcIAPAHEAEYBxwCBAAAAEgAD/QAaBwCfBwCq/AAhBwCfCQAEAKsAngACAHIAAAAzAAQABQAAABMqKywttgBeOgQZBCssuQBfAwCxAAAAAQBzAAAADgADAAAB4AAJAeEAEgHiAIIAAAAGAAIAVABTAAgArABxAAEAcgAAACIAAQAAAAAAChMAYLgAYbMAELEAAAABAHMAAAAGAAEAAABMAAIArQAAAAIArgBkAAAAEgACAE4AAAAAAAAAIgDSANQACQ==\u0026#34;); ClassDefinition classDefinition = new ClassDefinition(clazz, arrayOfByte); try { paramInstrumentation.redefineClasses(new ClassDefinition[] { classDefinition }); } catch (Exception e) { e.printStackTrace(); } } } } catch (Exception e) {} } } agent.jar/META-INF/MANIFEST.MFï¼š\n1 2 3 4 5 Manifest-Version: 1.0 Can-Redefine-Classes: true Agent-Class: HotSwapAgent Premain-Class: HotSwapAgent Can-Retransform-Classes: true ä½œè€…ç”¨è‡ªå®šä¹‰ç±»æ›¿æ¢ â€œorg.apache.shiro.web.servlet.AbstractShiroFilterâ€ï¼Œä¼å›¾ç»•è¿‡é‰´æƒã€‚\nå†™åœ¨åé¢ å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œè¿›ç¨‹é—´çš„è”ç³»é”™ç»¼å¤æ‚ï¼Œå®¢æˆ·ç«¯çš„è¯·æ±‚åˆ°äº†æœåŠ¡å™¨ç«¯åå¯èƒ½å½¢æˆäº†å¤æ‚çš„è°ƒç”¨é“¾ï¼Œå‡å¦‚å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¦‚ä½•æŸ¥æ˜å“ªé‡Œå‘ç”Ÿæ•…éšœä»¥åŠä»€ä¹ˆåŸå› å¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Ÿåˆ†å¸ƒå¼è¿½è¸ªï¼ˆDistributed Tracingï¼‰ æ­£æ˜¯ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚Java ç‹å›½æœ‰ç€è®¸è®¸å¤šå¤šçš„ APMï¼ˆApplication Performance Monitoringï¼‰ç³»ç»Ÿä¸“é—¨è§£å†³æ­¤ç±»é—®é¢˜ï¼Œä¾‹å¦‚ SkyWalkingã€Zipkinã€Pinpointï¼Œå®ƒä»¬æˆ–å¤šæˆ–å°‘æ”¯æŒäº†åä¸º OpenTracing çš„æ ‡å‡†ï¼Œåˆ†å¸ƒå¼è¿½è¸ªçš„æ ‡å‡†ä¸æŠ€æœ¯éå¸¸æœ‰åŠ©äºå¾®æœåŠ¡æ¶æ„ä¸‹çš„æ•…éšœæ’é™¤ã€‚\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\næ–‡ç« å‚è€ƒ Package java.lang.instrument\nInstrumentation (computer programming)\nInterface Instrumentation\nAttach API\nå…¥é—¨ç§‘æ™®ï¼Œå›´ç»•JVMçš„å„ç§å¤–æŒ‚æŠ€æœ¯\njava-instrumentation\nGuide to Java Instrumentation\nJava Attach API\nJAVA æ‹¾é— \u0026ndash;Instrument æœºåˆ¶\nInstrumentation: querying the memory usage of a Java object\nJavaåŠ¨æ€è¿½è¸ªæŠ€æœ¯æ¢ç©¶\nJVM æºç åˆ†æä¹‹ javaagent åŸç†å®Œå…¨è§£è¯»\nJavaç¥å™¨BTraceï¼Œä»å…¥é—¨åˆ°ç†Ÿç»ƒå°å·¥çš„æ‰‹å†Œ\n","date":"2019-10-30T15:27:01+08:00","permalink":"https://h2cone.github.io/2019/10/30/instrument_attach/","title":"Java ç¨‹åºæ¢æµ‹æˆ–è¿½è¸ª"},{"content":"æ¥”å­ æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬ç¼–å†™çš„ä»£ç å—é‡å¤äº†ä¸¤æ¬¡æˆ–ä¸¤æ¬¡ä»¥ä¸Šï¼Œç†æ™ºçš„ç¨‹åºå‘˜å¯èƒ½ä¼šè€ƒè™‘é‡æ„ï¼Œæå–å…¬å…±çš„éƒ¨åˆ†æŠ½è±¡æˆå‡½æ•°æˆ–æ–¹æ³•ï¼Œé€šè¿‡é‡ç”¨å‡½æ•°æˆ–æ–¹æ³•ä»¥æ­¤å‡å°‘å†—ä½™ï¼Œç®€åŒ–ä»£ç ï¼Œç”šè‡³é¢„é˜²äº†â€œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«â€çš„å™©æ¢¦ï¼Œè¿™å·²ç»ç®—å¾—ä¸Šæ˜¯å¯¹ DRY å’Œ SoC åŸåˆ™çš„è·µè¡Œã€‚DRYï¼ˆDon\u0026rsquo;t repeat yourselfï¼‰æ•™å¯¼æˆ‘ä»¬å°½é‡å‡å°‘é‡å¤ä»£ç ï¼Œè€Œ SoCï¼ˆSeparation of Concernsï¼‰æŒ‡çš„æ˜¯å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œå› ä¸ºå…³æ³¨ç‚¹æ··æ‚ä¼šæå¤§åœ°å¢å¼ºå¤æ‚æ€§ï¼Œå¥½æ¯”æŠŠä»€ä¹ˆéƒ½æ··ä¸ºä¸€è°ˆï¼Œå †ç§¯è€Œæˆçš„ç¥–ä¼ ä»£ç ï¼Œè¿™åˆæ˜¯ç¨‹åºå‘˜ä»¬çš„å¦ä¸€ä¸ªå™©æ¢¦ï¼Œæ‰€ä»¥æ‰æŠŠå¤æ‚çš„é—®é¢˜åˆ†è§£æˆè‹¥å¹²ç‹¬ç«‹çš„å°é—®é¢˜ï¼Œæ¨¡å—åŒ–ï¼ŒæåŠ›è¿½æ±‚â€œé«˜å†…èšï¼Œä½è€¦åˆâ€ã€‚\nAOPï¼ˆAspect-oriented programmingï¼‰æ˜¯å¯¹æ¨ªå‘çš„é‡ç”¨ï¼Œéå¸¸ç¬¦åˆ DRY å’Œ SoC çš„åŸåˆ™ã€‚ç›´è§‚ä¸Šï¼Œä»£ç æ€»æ˜¯ä»ä¸Šå¾€ä¸‹æ‰§è¡Œï¼Œä¸å¦¨ç§°ä¹‹ä¸ºçºµå‘ï¼ŒOOPï¼ˆObject-oriented Programmingï¼‰çš„ç»§æ‰¿ä¹Ÿå¯çœ‹ä½œæ˜¯çºµå‘ï¼›ç›¸å¯¹åˆ™æ˜¯æ¨ªå‘ï¼Œä»æ¨ªè·¨å¤šä¸ªç±»çš„è§’åº¦æ¥çœ‹ï¼Œæ¨ªå‘æœ‰ç€è®¸è®¸å¤šå¤šçš„ç»Ÿä¸€é€»è¾‘å¯ä»¥åˆ‡å…¥ï¼Œæ¯”å¦‚å®‰å…¨æ£€æŸ¥ã€å¼‚å¸¸å¤„ç†ã€æ—¥å¿—è¾“å‡ºã€äº‹åŠ¡ç®¡ç†ã€è¿½è¸ªã€ç›‘æ§ç­‰ç­‰ï¼Œè¿™äº›ç»Ÿä¸€é€»è¾‘èƒ½å¤Ÿè¢«æŠ½è±¡æˆæ¨¡å—ï¼Œé‡ç”¨å®ƒä»¬ç”šè‡³ä¸éœ€è¦æ˜¾å¼ä½¿ç”¨æˆ–åªéœ€è¦ç¼–å†™ç®€å•çš„å…ƒæ•°æ®è¿›è¡Œå£°æ˜ï¼Œä¸€æ¬¡ç¼–å†™ï¼Œåˆ°å¤„æ‰§è¡Œï¼ŒJava ç¨‹åºå‘˜ä»¬å·²ç»ä½“éªŒè¿‡ä¸å°‘ Spring AOP çš„é­”æœ¯ã€‚\nAOP èƒ½å¤Ÿä½¿å‰æ–‡æ‰€è¿°çš„ç»Ÿä¸€é€»è¾‘æ¨¡å—åŒ–ï¼Œè¿™äº›ç»Ÿä¸€é€»è¾‘å¯ç§°ä¹‹ä¸ºæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆcrosscutting concernsï¼‰ï¼Œåˆ‡é¢ï¼ˆAspectï¼‰åˆ™ä½œä¸ºæ¨¡å—ï¼Œå› æ­¤è¯‘ä¸ºåˆ‡é¢å¯¼å‘ç¼–ç¨‹ã€‚åˆ‡é¢çš„ä½œç”¨æ•ˆæœå½·ä½›æ˜¯å¾€ç¨‹åºçš„æ‰§è¡Œç‚¹æ³¨å…¥äº†æ–°çš„ä»£ç ï¼Œè¿™äº›æ‰§è¡Œç‚¹è¢«ç§°ä¹‹ä¸ºæ¥å…¥ç‚¹ï¼ˆJoin Pointï¼‰ï¼Œæ¯”å¦‚æ–¹æ³•è°ƒç”¨çš„å‰åï¼›æ¥å…¥ç‚¹çš„é›†åˆç§°ä¹‹ä¸ºåˆ‡å…¥ç‚¹ ï¼ˆPointcutï¼‰ï¼Œæ¯”å¦‚æ»¡è¶³æ¡ä»¶çš„ä¸€ç»„æ–¹æ³•ï¼›æ³¨å…¥çš„ä»£ç ç§°ä¹‹ä¸ºå»ºè®®ï¼ˆAdviceï¼‰ï¼Œæ¯”å¦‚åœ¨æ–¹æ³•è°ƒç”¨å‰åè¾“å‡ºæ—¥å¿—ï¼›å…¶ä¸­ä»£ç æ³¨å…¥çš„æœ¯è¯­æ˜¯ç¼–ç»‡ï¼ˆWeavingï¼‰ï¼Œæ—¢ç„¶æŠŠç¼–ç»‡å·¥ä½œäº¤ç»™åº“æˆ–æ¡†æ¶ï¼Œé‚£ä¹ˆå¯èƒ½æ˜¯åœ¨ç¼–è¯‘æ—¶ç¼–ç»‡ï¼ˆCompile-time weavingï¼‰æˆ–è¿è¡Œæ—¶ç¼–ç»‡ï¼ˆRun-Time weavingï¼‰ï¼Œè¿˜å¯èƒ½åœ¨ç¼–è¯‘åç¼–ç»‡ï¼ˆPost-compile weavingï¼‰ æˆ–åŠ è½½æ—¶ç¼–ç»‡ï¼ˆLoad-time weavingï¼‰ã€‚\nè™½è¯´å¦‚æ­¤ï¼Œé‚£å±äº Spring æ ¸å¿ƒçš„ Spring AOP çš„é­”æœ¯æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ\nå–§é—¹ä¸­ï¼Œå¬è§äº†ä¸€å¥æ‚„æ‚„è¯ï¼š\nSpring AOP is implemented by using runtime proxies.\nå¦ä¸€å¥æ‚„æ‚„è¯ï¼š\nIn the Spring Framework, an AOP proxy is a JDK dynamic proxy or a CGLIB proxy.\nåŸæ¥ Spring AOP æ˜¯ä½¿ç”¨è¿è¡Œæ—¶ä»£ç†å®ç°çš„ï¼Œä»£ç†åˆ™æ˜¯ç”± JDK åŠ¨æ€ä»£ç†æˆ– CGLIB ç”Ÿæˆã€‚æ®ä¼ é—»æ‰€è¯´ï¼Œåˆ©ç”¨ JDK åŠ¨æ€ä»£ç†èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶ç”Ÿæˆä»£ç†ï¼Œä¸€ç•ªæ‰“å¬ä¹‹åä¹Ÿäº†è§£åˆ° CGLIB æ˜¯ä¸€ä¸ªå­—èŠ‚ç ç”Ÿæˆå’Œè½¬æ¢åº“ï¼Œä¹Ÿå¯ç”¨äºåŠ¨æ€ç”Ÿæˆä»£ç†ã€‚\nByte Code Generation Library is high level API to generate and transform JAVA byte code. It is used by AOP, testing, data access frameworks to generate dynamic proxy objects and intercept field access.\né—¨æ‰“å¼€äº†ï¼Œé¢å‰æ˜¯é€šå‘ç§˜å¯†åœ°ä¸‹å®¤çš„åˆ†å²”ï¼Œä¸€æ¡æ˜¯åä¸º JDK åŠ¨æ€ä»£ç†çš„è·¯ï¼Œå¦ä¸€æ¡æ˜¯åä¸º CGLIB çš„è·¯ã€‚\næ¢ç§˜ Pythonã€JavaScriptã€PHPã€Ruby ç­‰åŠ¨æ€è¯­è¨€ä»¬ï¼Œç«Ÿç„¶èƒ½åœ¨è¿è¡Œæ—¶å¯¹ç±»/å±æ€§/æ–¹æ³•/å‡½æ•°è¿›è¡Œæ“ä½œï¼Œä½œä¸ºé™æ€è¯­è¨€çš„ Java åœ¨ä¸é‡å¯ JVM çš„å‰æä¸‹ï¼Œæ˜¯å¦ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶æ“ä½œç±»ï¼Ÿ\nå½“æˆ‘ä»¬å†™å®Œä¸€ä¸ª Java ç¨‹åºï¼Œé€šè¿‡ Java ç¼–è¯‘å™¨ç¼–è¯‘åè¾“å‡ºåŒ…å« Java å­—èŠ‚ç çš„ Class æ–‡ä»¶ï¼Œéšåå¯åŠ¨ Java è™šæ‹Ÿæœºï¼ˆç®€ç§° JVMï¼Œæœ¬æ–‡ä»¥ HotSpot ä¸ºä¾‹ï¼‰ï¼ŒJava è¿è¡Œæ—¶ç¯å¢ƒï¼ˆJREï¼‰é€šè¿‡ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰åŠ è½½ç±»åˆ° JVM è¿è¡Œæ—¶çš„æ–¹æ³•åŒºï¼Œæ–¹æ³•åŒºå‚¨å­˜ç€ç±»çš„æ•°æ®ï¼Œæ¯”å¦‚è¿è¡Œæ—¶çš„å¸¸é‡æ± ï¼ˆRun-Time Constant Poolï¼‰å’Œæ–¹æ³•ä»£ç ç­‰ï¼Œä¹‹åï¼Œç±»è¢«å®ä¾‹åŒ–æˆ–å¯¹è±¡è¢«åˆ›å»º\u0026hellip;\u0026hellip;é‚£ä¹ˆï¼ŒJava æ˜¯å¦æ”¯æŒè¿è¡Œæ—¶æ›´æ”¹ç±»æˆ–è€…è¿è¡Œæ—¶ç”Ÿæˆç±»å¹¶åŠ¨æ€åŠ è½½åˆ°æ–¹æ³•åŒºï¼Ÿ\nä¸€ç•ªæœç´¢åï¼Œæœç„¶å…¶ä¸­ä¸€äº›æƒ³æ³•æ—©å·²å®ç°åœ¨ JDK ä¸­ã€‚JDK åŠ¨æ€ä»£ç†ä¸ä»…èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶ç”Ÿæˆç±»ï¼Œè¿˜èƒ½æ‹¦æˆªæ–¹æ³•è°ƒç”¨ï¼Œæ¥ä¸‹æ¥ç”¨ç®€å•çš„ä»£ç è¯¦ç»†è¯´æ˜ã€‚\næˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„æ¥å£å’Œæ¥å£å®ç°ç±»ï¼š\n1 2 3 4 5 public interface PersonService { String sayHello(String name); } 1 2 3 4 5 6 7 public class SimplePersonService implements PersonService { @Override public String sayHello(String name) { return \u0026#34;Hello, \u0026#34; + name; } } æ„Ÿè°¢å¤šæ€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¥å£ say helloï¼š\n1 2 3 4 5 6 @Test public void helloWorld() { PersonService service = new SimplePersonService(); String result = service.sayHello(\u0026#34;World\u0026#34;); Assert.assertEquals(\u0026#34;Hello, World\u0026#34;, result); } å¯æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦åœ¨ sayHello(\u0026ldquo;World\u0026rdquo;) è°ƒç”¨å‰åæ·»åŠ ä¸€äº›é€»è¾‘ï¼Œæ¯”å¦‚ï¼š\n1 2 3 System.out.println(\u0026#34;ä¹‹å‰åšç‚¹ä»€ä¹ˆ\u0026#34;); String result = service.sayHello(\u0026#34;World\u0026#34;); System.out.println(\u0026#34;ä¹‹ååšç‚¹ä»€ä¹ˆ\u0026#34;); æ’å…¥ä¸€ä¸¤å¤„ä¹Ÿè®¸è¿˜èƒ½æ¥å—ï¼Œå¦‚æœ sayHello(\u0026hellip;) éå¸ƒå„å¤„æˆ–ä¸ä¾¿æ”¹åŠ¨å…¶ä¸Šä¸‹æ–‡ä»£ç ï¼Œä¸ºäº†å‡å°‘ä»£ç å†—ä½™å’Œåˆ†ç¦»å…³æ³¨ç‚¹ï¼Œè¯•è¯• JDK åŠ¨æ€ä»£ç†å§ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 @Test public void sayHello() { // åˆ›å»ºç›®æ ‡å®ä¾‹ï¼ˆè¢«ä»£ç†å®ä¾‹ï¼Œå¯é€‰ï¼‰ã€‚ SimplePersonService target = new SimplePersonService(); // ç”Ÿæˆä»£ç†ç±»ï¼Œåˆ›å»ºä»£ç†å®ä¾‹ã€‚ PersonService proxy = (PersonService) Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), new PersonServiceHandler(target)); String result = proxy.sayHello(\u0026#34;World\u0026#34;); Assert.assertEquals(\u0026#34;Hello, World\u0026#34;, result); } /** * æ‹¦æˆª PersonService æ–¹æ³•è°ƒç”¨çš„å¤„ç†å™¨ */ static class PersonServiceHandler implements InvocationHandler { /** * ç›®æ ‡å®ä¾‹ (è¢«ä»£ç†å®ä¾‹) */ Object target; PersonServiceHandler() { } PersonServiceHandler(Object target) { this.target = target; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { System.out.printf(\u0026#34;proxy class: %s\\n\u0026#34;, proxy.getClass()); System.out.printf(\u0026#34;method: %s\\n\u0026#34;, method); System.out.printf(\u0026#34;args: %s\\n\u0026#34;, Arrays.toString(args)); if (target != null) { System.out.println(\u0026#34;Before invoke\u0026#34;); // è°ƒç”¨å‰ï¼Œæ·»åŠ é€»è¾‘ã€‚ Object result = method.invoke(target, args); System.out.println(result); System.out.println(\u0026#34;After invoke\u0026#34;); // è°ƒç”¨åï¼Œæ·»åŠ é€»è¾‘ã€‚ return result; } return null; } } ä¸Šé¢è¿™æ®µä»£ç é€šè¿‡äº†æµ‹è¯•å¹¶è¾“å‡ºäº†ä»¥ä¸‹å†…å®¹ï¼š\n1 2 3 4 5 6 proxy class: class com.sun.proxy.$Proxy4 method: public abstract java.lang.String io.h2cone.proxy.jdk.PersonService.sayHello(java.lang.String) args: [World] Before invoke Hello, World After invoke ç”Ÿæˆçš„ä»£ç†ç±»åå« com.sun.proxy.$Proxy4ï¼Œå®˜æ–¹æ–‡æ¡£å¯¹ä»£ç†ç±»çš„å®šä¹‰æ˜¯ï¼š\nA dynamic proxy class is a class that implements a list of interfaces specified at runtime such that a method invocation through one of the interfaces on an instance of the class will be encoded and dispatched to another object through a uniform interface\nåŒæ—¶æ³¨æ„åˆ°äº† java.lang.reflect.Proxy#newProxyInstance æ–¹æ³•å‚æ•°ï¼š\n1 2 3 loader â€“ the class loader to define the proxy class interfaces â€“ the list of interfaces for the proxy class to implement h â€“ the invocation handler to dispatch method invocations to ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä»£ç†ç±»å®ç°çš„æ¥å£åˆ—è¡¨ï¼ŒåŸæ¥ä»£ç†ç±»æ˜¯æ¥å£å®ç°ç±»ï¼Œå›é¡¾ä¸€ä¸‹ä¸Šæ–‡çš„ä»£ç ï¼Œcom.sun.proxy.$Proxy4 å®ç°äº† PersonService æ¥å£ï¼Œè€Œ SimplePersonService ä¹Ÿå®ç°äº† PersonService æ¥å£ï¼Œä¹Ÿå°±è¯´ä»£ç†ç±»å’Œè¢«ä»£ç†ç±»æ˜¯å…„å¼Ÿå§å¦¹ã€‚æ‰€è°“ä»£ç†ï¼Œåœ¨è¿™é‡Œå°±æ˜¯é€šè¿‡é‡å†™ InvocationHandler çš„ invoke æ–¹æ³•æ‹¦æˆª PersonService æ–¹æ³•è°ƒç”¨å¹¶èƒ½åœ¨è°ƒç”¨å‰åæ·»åŠ é€»è¾‘ã€‚\nå½“ç”¨ Java å·¥ä½œçš„æ—¶å€™ï¼Œç¨‹åºå‘˜ä»¬ä¹Ÿè®¸ç»å¸¸ç¼–å†™è®¸å¤šæ¥å£ï¼Œä½†æ¯ä¸ªæ¥å£å´åªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œä¸å…æœ‰ä¸€ç§â€œè¿‡åº¦å·¥ç¨‹â€çš„å«Œç–‘ï¼Œå¾€å¾€å¾ˆå¤šæ¥å£æˆä¸ºäº†ä¸å¿…è¦çš„æŠ½è±¡ï¼Œè¿˜å› æ­¤å¤šäº†ä¸€äº›è¿è¡Œæ—¶å¼€é”€ï¼Œæ¥å£è™½å¥½å´ä¸å¿…è¿‡æ—©è®¾è®¡ã€‚å›åˆ°åŠ¨æ€ä»£ç†çš„è¯é¢˜ï¼Œæ˜¯å¦æœ‰å¯èƒ½ä¸éœ€è¦æ¥å£å°±èƒ½åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ï¼Ÿ\nåˆ°äº† CGLIB çš„ç”¨æ­¦ä¹‹åœ°ã€‚CGLIB å…¶å®æ˜¯ï¼ˆCode Generation Libraryï¼‰çš„ç®€ç§°ï¼Œè¯‘ä½œä»£ç ç”Ÿæˆåº“ï¼Œä½†è¿™ä¼šè®©äººå›°æƒ‘ï¼Œéš¾é“æ˜¯ç”Ÿæˆ Java æºä»£ç ï¼Ÿå¹¶ä¸æ˜¯ï¼Œå®ƒçš„çœŸåæ˜¯ Java å­—èŠ‚ç ç”Ÿæˆåº“ã€‚Java å­—èŠ‚ç ï¼ˆJava bytecodeï¼‰çœ‹èµ·æ¥å¦‚ä½•ï¼Ÿ\nå¯¹äºä¸Šæ–‡çš„ä»£ç ï¼Œå½“æˆ‘ä»¬ç”¨ javac ç¼–è¯‘æºä»£ç æˆåŠŸä¼šè¾“å‡º PersonService.class å’Œ SimplePersonService.class ç­‰æ–‡ä»¶ã€‚æˆ‘ä»¬ç”¨ç¼–è¾‘å™¨çœ‹çœ‹å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 cafe babe 0000 0034 0009 0700 0707 0008 0100 0873 6179 4865 6c6c 6f01 0026 284c 6a61 7661 2f6c 616e 672f 5374 7269 6e67 3b29 4c6a 6176 612f 6c61 6e67 2f53 7472 696e 673b 0100 0a53 6f75 7263 6546 696c 6501 0012 5065 7273 6f6e 5365 7276 6963 652e 6a61 7661 0100 2169 6f2f 6832 636f 6e65 2f70 726f 7879 2f6a 646b 2f50 6572 736f 6e53 6572 7669 6365 0100 106a 6176 612f 6c61 6e67 2f4f 626a 6563 7406 0100 0100 0200 0000 0000 0104 0100 0300 0400 0000 0100 0500 0000 0200 06 è¿™å°±æ˜¯ Java å­—èŠ‚ç çœ‹èµ·æ¥çš„æ ·å­ï¼Œè¿™é‡Œè¡¨ç°ä¸ºåå…­è¿›åˆ¶æ•°æ®ã€‚Java ç¼–è¯‘æ—¶ä»æºä»£ç åˆ°å­—èŠ‚ç ï¼Œå­—èŠ‚ç ä¹Ÿå¯åŠ¨æ€ç¼–è¯‘ï¼ˆJITï¼‰ä¸ºæœºå™¨ç ï¼ˆnative codeï¼‰ï¼›æœºå™¨åªç†è§£æœºå™¨ç ï¼Œè€Œ JVM åªç†è§£ Java å­—èŠ‚ç ï¼Œå¯ä»¥è¯´ Java å­—èŠ‚ç æ˜¯ JVM çš„æŒ‡ä»¤é›†ã€‚æ—¢ç„¶ Class æ–‡ä»¶åŒ…å«äº† Java å­—èŠ‚ç ï¼Œåˆ™æ›´æ”¹ç±»æˆ–ç”Ÿæˆç±»æ˜¯ç”±æ“ä½œ Java å­—èŠ‚ç å¼€å§‹ï¼Œå¯æ˜¯æˆ‘ä»¬å¤§éƒ¨åˆ†éƒ½åªæ“…é•¿ Java ä»£ç ï¼Œæ“ä½œ Java å­—èŠ‚ç è¦æ€ä¹ˆå¼€å§‹å‘¢ï¼Ÿ\nä¸å¦¨å…ˆè¯•è¯•ä» Class æ–‡ä»¶é€†å‘åˆ° Java æ–‡ä»¶ï¼Œåˆ©ç”¨åæ±‡ç¼–å‘½ä»¤è¡Œå·¥å…·ï¼Œä¾‹å¦‚åœ¨ç»ˆç«¯ä¸­æ•²ä¸‹ javap -v SimplePersonService.classï¼Œä½ å°†å¾—åˆ° Class æ–‡ä»¶æ ¼å¼ï¼ˆThe class File Formatï¼‰çš„ç›´è§‚è®¤è¯†ï¼›ä½†æ˜¯ï¼Œæ“ä½œ Java å­—èŠ‚ç éœ€è¦é€å½»ç†è§£ Java è™šæ‹Ÿæœºè§„èŒƒï¼Œæ¯”å¦‚ JVM çš„æŒ‡ä»¤é›†å’Œ JVM å†…å¹•ï¼ŒASM çš„å‡ºç°ä½¿ä¹‹æˆä¸ºå¯èƒ½ã€‚ASM æ˜¯ä¸€ä¸ª Java å­—èŠ‚ç æ“ä½œå’Œåˆ†ææ¡†æ¶ï¼Œå¯ç”¨äºæ›´æ”¹å·²å­˜åœ¨ç±»æˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ï¼Œç¨‹åºå‘˜ä»¬ä¸æ»¡è¶³äºæ­¤ï¼Œåˆ©ç”¨ ASM å°è£…äº†æ›´é«˜å±‚çš„ Java APIï¼Œæœ€ç»ˆå‡ºç°äº† CGLIBã€‚\næˆ‘ä»¬æ¥çœ‹çœ‹ CGLIB ä»“åº“çš„ç»´åŸºçš„ä¸€æ®µæè¿°ï¼š\ncglib is a powerful, high performance and quality Code Generation Library, It is used to extend JAVA classes and implements interfaces at runtime\næ— éœ€æ¥å£åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ä¸æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºä»£ç†ç±»å¯ä»¥ç»§æ‰¿è¢«ä»£ç†ç±»ã€‚æ¥ä¸‹æ¥ä½“éªŒä¸€ä¸‹ CGLIBï¼Œæˆ‘ä»¬ä½¿ç”¨æŠ½è±¡ç±»ä»£æ›¿æ¥å£ï¼š\n1 2 3 4 5 6 public abstract class PersonService { public String sayHello(String name) { return \u0026#34;Hello, \u0026#34; + name; } } ç„¶åï¼Œç”¨ CGLIB çš„æ–¹å¼ say helloï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Test public void sayHello() { Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(PersonService.class); // è®¾ç½®åŸºç±»ã€‚ enhancer.setCallback(new PersonServiceInterceptor()); // è®¾ç½®æ–¹æ³•è°ƒç”¨æ‹¦æˆªå™¨ã€‚ PersonService service = (PersonService) enhancer.create(); // ç”Ÿæˆä»£ç†ç±»ï¼Œåˆ›å»ºä»£ç†å®ä¾‹ã€‚ String result = service.sayHello(\u0026#34;World\u0026#34;); Assert.assertEquals(\u0026#34;Hello, World\u0026#34;, result); } /** * PersonService æ–¹æ³•è°ƒç”¨æ‹¦æˆªå™¨ */ static class PersonServiceInterceptor implements MethodInterceptor { @Override public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable { System.out.printf(\u0026#34;obj class: %s\\n\u0026#34;, obj.getClass()); System.out.printf(\u0026#34;method: %s\\n\u0026#34;, method); System.out.printf(\u0026#34;args: %s\\n\u0026#34;, Arrays.toString(args)); System.out.printf(\u0026#34;method proxy: %s\\n\u0026#34;, proxy); System.out.println(\u0026#34;Before invoke\u0026#34;); // è°ƒç”¨å‰ï¼Œæ·»åŠ é€»è¾‘ã€‚ Object result = proxy.invokeSuper(obj, args); System.out.println(result); System.out.println(\u0026#34;After invoke\u0026#34;); // è°ƒç”¨åï¼Œæ·»åŠ é€»è¾‘ã€‚ return result; } } è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 obj class: class io.h2cone.proxy.cglib.PersonService$$EnhancerByCGLIB$$64e53be2 method: public java.lang.String io.h2cone.proxy.cglib.PersonService.sayHello(java.lang.String) args: [World] method proxy: net.sf.cglib.proxy.MethodProxy@629f0666 Before invoke Hello, World After invoke è¿™ç§æ–¹å¼çš„ä»£ç†ç±»åç§°æ˜¯ obj calss å¯¹åº”çš„å€¼ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒæ˜¯ PersonService çš„å¢å¼ºç±»ã€‚åœ¨ç”Ÿæˆä»£ç†ç±»ä¹‹å‰ï¼Œenhancer è®¾ç½®äº†åŸºç±» PersonServiceï¼Œç”±æ­¤ç”Ÿæˆçš„ä»£ç†ç±»è‡ªç„¶å°±ç»§æ‰¿äº†è¢«ä»£ç†ç±»ï¼ˆPersonServiceï¼‰ï¼Œå®ƒä»¬æ˜¯å­©å­ä¸çˆ¶æ¯çš„å…³ç³»ã€‚CGLIB ä¸ JDK åŠ¨æ€ä»£ç†ä¸€æ ·éƒ½èƒ½æ‹¦æˆªæ–¹æ³•è°ƒç”¨ï¼Œæ›¿è¢«æ‹¦æˆªæ–¹æ³•åšä¸€äº›å®ƒåšä¸åˆ°çš„äº‹æƒ…ã€‚\nå®Œæ•´ä»£ç å·²å‘å¸ƒï¼Œè¯·å‚è€ƒ proxyã€‚\nç»¼ä¸Šæ‰€è¿°ï¼ŒJDK åŠ¨æ€ä»£ç†åªèƒ½é€šè¿‡æ¥å£ç”Ÿæˆä»£ç†ç±»ï¼Œä»£ç†ç±»ä¸è¢«ä»£ç†ç±»æ˜¯å…„å¼Ÿå§å¦¹ï¼Œè€Œ CGLIB è¿˜èƒ½é€šè¿‡åŸºç±»ç”Ÿæˆä»£ç†ç±»ï¼Œä»£ç†ç±»æ˜¯è¢«ä»£ç†ç±»çš„å­ç±»ã€‚ é™¤äº†èƒ½åŠ›ä¸Šçš„åŒºåˆ«ï¼Œåœ¨æ€§èƒ½ä¸Šï¼Œä¼¼ä¹æ™®éè®¤ä¸º CGLIB è¦å¿«äº JDK åŠ¨æ€ä»£ç†ã€‚å‰æ–‡æåˆ°äº† Spring AOP ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†æˆ– CGLIB åœ¨è¿è¡Œæ—¶ç”Ÿæˆä»£ç†ç±»ï¼Œé‚£ä¹ˆ Spring AOP åœ¨ä»€ä¹ˆæƒ…å†µä¸‹é‡‡ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Ÿåˆæ˜¯åœ¨ä»€ä¹ˆæƒ…å†µä¸‹æ¬¡é‡‡ç”¨ CGLIBï¼Ÿå¦‚ç»“è®ºæ‰€è¯´ï¼Œå¦‚æœè¢«ä»£ç†ç±»æˆ–ç›®æ ‡ç±»å®ç°äº†ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£ï¼Œé‚£ä¹ˆ Spring AOP å°†é‡‡ç”¨ JDK åŠ¨æ€ä»£ç†ç”Ÿæˆä¸€ä¸ªå®ç°æ¯ä¸ªæ¥å£çš„ä»£ç†ç±»ï¼›å¦‚æœè¢«ä»£ç†ç±»æˆ–ç›®æ ‡ç±»æ²¡æœ‰å®ç°æ¥å£ï¼Œé‚£ä¹ˆ Spring AOP å°†é‡‡ç”¨ CGLIB åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ï¼Œå®ƒæ˜¯è¢«ä»£ç†ç±»æˆ–ç›®æ ‡ç±»çš„å­ç±»ã€‚å½“ç„¶ï¼ŒSpring AOP å¾ˆå¯èƒ½ä¹Ÿå…è®¸æˆ‘ä»¬å¼ºåˆ¶é‡‡ç”¨å…¶ä¸­ä¸€ç§æ–¹å¼ã€‚\nè™½ç„¶åŠ¨æ€ç”Ÿæˆäº†ä»£ç†ç±»ï¼Œä½†æ˜¯å¦‚æœä¸æŠŠä»£ç†ç±»åŠ è½½åˆ° JVM æ–¹æ³•åŒºï¼Œä¹Ÿå°±ä¸èƒ½åˆ›å»ºå®ƒçš„å®ä¾‹ã€‚å›å¤´çœ‹ä¸€ä¸‹ JDK åŠ¨æ€ä»£ç†çš„ newProxyInstance æ–¹æ³•çš„é¦–è¦å‚æ•°ï¼š\n1 loader â€“ the class loader to define the proxy class å®ƒæ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰ä»£ç†ç±»çš„ç±»åŠ è½½å™¨ï¼Œæˆ‘ä»¬ä¼ é€’äº†è¢«ä»£ç†ç±»çš„ç±»åŠ è½½å™¨ï¼Œå› è€Œè¢«ä»£ç†ç±»å’Œä»£ç†ç±»çš„ç±»åŠ è½½å™¨æ˜¯ç›¸åŒçš„ã€‚\n1 2 target class loader: sun.misc.Launcher$AppClassLoader@18b4aac2 proxy class loader: sun.misc.Launcher$AppClassLoader@18b4aac2 AppClassLoader æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œåˆåä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆSystem Class Loaderï¼‰ï¼Œå®ƒæ‰€åœ¨çš„å®¶æ—å¤§æ¦‚é•¿è¿™æ ·å­ï¼š\nå…¶ä¸­æ²¡æœ‰åŒäº²çš„ Bootstrap Class Loader ä» JRE/lib/rt.jar åŠ è½½ç±»ï¼Œå®ƒçš„å­©å­ Extension Class Loader ä» JRE/lib/ext æˆ– java.ext.dirs åŠ è½½ç±»ï¼Œå®ƒçš„å­å­™ System Class Loader ä» CLASSPATHã€-classpathã€-cpã€Mainfest åŠ è½½ç±»ã€‚ç±»åŠ è½½æœºåˆ¶ä½¿ç”¨ Parent Delegation Model å¤„ç†ç±»åŠ è½½è¯·æ±‚ï¼Œè‡ªåº•å‘ä¸Šæ£€æŸ¥ç±»æ˜¯å¦å·²åŠ è½½ï¼Œè‡ªé¡¶å‘ä¸‹å°è¯•åŠ è½½ç±»ã€‚å½“ç„¶ï¼Œå¦‚æœæœ‰éœ€è¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œåˆ™éœ€è¦ç¼–å†™ç±»ç›´æ¥æˆ–é—´æ¥ç»§æ‰¿ java.lang.ClassLoader å¹¶é‡å†™ç›¸åº”çš„æ–¹æ³•ï¼ˆä¸€èˆ¬ä¼šç»§æ‰¿ java.net.URLClassLoaderï¼‰ã€‚\nåè®° åœ¨ Spring AOP çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œè¿˜å‘ç°ä¸€ä¸ªå«åš AspectJ çš„å®¶ä¼™ï¼›åœ¨ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶ä¹‹é—´æ˜¯ç¼–è¯‘åå’ŒåŠ è½½æ—¶ï¼Œå®ƒå°±åœ¨åŠ è½½æ—¶åšæ‰‹è„š\u0026hellip;\u0026hellip;\næœ¬æ–‡é¦–å‘äº https://h2cone.github.io\nå‚è€ƒ å†’å·è¯¾å ‚Â§3.3ï¼šåˆ‡é¢èŒƒå¼\nAspect Oriented Programming with Spring\nJDK- and CGLIB-based proxies\nSpringæœ¬è´¨ç³»åˆ—(2)-AOP\nDynamic Proxy Classes\nJavaå¸å›½ä¹‹åŠ¨æ€ä»£ç†\nä»å…„å¼Ÿåˆ°çˆ¶å­ï¼šåŠ¨æ€ä»£ç†åœ¨æ°‘é—´æ˜¯æ€ä¹ˆç©çš„ï¼Ÿ\nCGLIB ä»“åº“\nASMï¼š ä¸€ä¸ªä½è°ƒæˆåŠŸè€…çš„è‡ªè¿°\nASM å®˜ç½‘\nclassloader-in-java\nClass ClassLoader\nJavaè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆclassçš„æ–¹æ³•\nLoad-time Weaving with AspectJ in the Spring Framework\n","date":"2019-09-17T11:29:21+08:00","permalink":"https://h2cone.github.io/2019/09/17/aop_proxy_bytecode/","title":"åˆ‡é¢å’ŒåŠ¨æ€ä»£ç†ä»¥åŠå­—èŠ‚ç "}]