<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>正则表达式用例 - Huangh&#39;s blog</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="记录一些正则表达式的应用场景。" />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="https://h2cone.github.io/2022/07/15/regex_use_cases/">
  <meta property="og:site_name" content="Huangh&#39;s blog">
  <meta property="og:title" content="正则表达式用例">
  <meta property="og:description" content="记录一些正则表达式的应用场景。">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
  <meta property="article:section" content="post">
    <meta property="article:published_time" content="2022-07-15T10:31:49+08:00">
    <meta property="article:modified_time" content="2022-07-15T10:31:49+08:00">
    <meta property="article:tag" content="Regex">
    <meta property="article:tag" content="Text-Processing">
    <meta property="article:tag" content="Sd">
    <meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary"><meta name="twitter:title" content="正则表达式用例">
<meta name="twitter:description" content="记录一些正则表达式的应用场景。">
<script src="https://h2cone.github.io/js/feather.min.js"></script>
	
	
        <link href="https://h2cone.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://h2cone.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://h2cone.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>
	
		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
		
		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	
	
	

	<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/pagefind/pagefind-ui.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#search", showSubResults: true });
    });
</script>
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://h2cone.github.io/">Huangh&#39;s blog</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/post">Posts</a>
		
		<a href="/tags">Tags</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="https://h2cone.github.io/js/themetoggle.js"></script>
		
	</nav>
</header>

<div id="search"></div>
<main>
	<article>
		<div class="title">
			<h1 class="title">正则表达式用例</h1>
			<div class="meta">Posted on Jul 15, 2022</div>
		</div>
		

		<section class="body">
			<h2 id="前言">前言</h2>
<p>正则表达式是指定文本中搜索<strong>模式</strong>的字符序列，这种模式被字符串搜索算法用于对字符串进行<strong>查找</strong>、<strong>替换</strong>、<strong>校验</strong>等。</p>
<h2 id="拆分">拆分</h2>
<p>在日志解析领域，时常遇到满足特定模式的日志条目，比如“头部”是时间信息，“身体”是详细信息的日志条目：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>% cat a0.log 
</span></span><span style="display:flex;"><span>&lt;30&gt;May <span style="color:#ae81ff">21</span> 21:33:47 localhost alert: <span style="color:#f92672">{</span>category<span style="color:#f92672">=</span>漏洞扫描事件<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>type<span style="color:#f92672">=</span>WebShell<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>priority<span style="color:#f92672">=</span>提示<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>typeCN<span style="color:#f92672">=</span>Web后门<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>level<span style="color:#f92672">=</span>6<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>id<span style="color:#f92672">=</span>974609<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>time<span style="color:#f92672">=</span>2018-05-21 21:33:04<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>sip<span style="color:#f92672">=</span>101.206.169.180<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>sport<span style="color:#f92672">=</span>49187<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>dip<span style="color:#f92672">=</span>10.1.186.7<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>dport<span style="color:#f92672">=</span>9084<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>host<span style="color:#f92672">=</span>m.****.com.cn:9084<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>code<span style="color:#f92672">=</span>200<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>sysurl<span style="color:#f92672">=</span>/sys/web_session.php?level<span style="color:#f92672">=</span>6&amp;sid<span style="color:#f92672">=</span>974609<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>attach<span style="color:#f92672">=</span>/sys/web_session.php?act<span style="color:#f92672">=</span>download&amp;level<span style="color:#f92672">=</span>6&amp;sid<span style="color:#f92672">=</span>974609<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>intent<span style="color:#f92672">=</span>上传可执行脚本或WebShell文件<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>detail<span style="color:#f92672">=</span>在Post数据包中发现含有JSP/ASP/ASP.NET代码特征的字符：&lt;%request/QueryString/Form/<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;...&#39;</span><span style="color:#f92672">]</span>%&gt;<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>dev<span style="color:#f92672">=</span>zonghang01<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>url<span style="color:#f92672">=</span>http://m.****.com.cn:9084/pmobile/MCPerEAccountSignTrs.do<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>人脑能够从少量日志条目归纳出日志的格式，也能从程序开发者的角度看见日志的结构，但是计算机只有在人类的指导（声明字符串满足的模式）下才能区分日志条目的各个组成部分。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>% cat a0.log | sd <span style="color:#e6db74">&#39;(&lt;\d+&gt;\w+\s+\d{1,2}\s+\d{2}:\d{2}:\d{2}\s+\w+\s+\w+:\s+)(.+)&#39;</span> <span style="color:#e6db74">&#39;$1\n$2&#39;</span>
</span></span><span style="display:flex;"><span>&lt;30&gt;May <span style="color:#ae81ff">21</span> 21:33:47 localhost alert: 
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>category<span style="color:#f92672">=</span>漏洞扫描事件<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>type<span style="color:#f92672">=</span>WebShell<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>priority<span style="color:#f92672">=</span>提示<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>typeCN<span style="color:#f92672">=</span>Web后门<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>level<span style="color:#f92672">=</span>6<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>id<span style="color:#f92672">=</span>974609<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>time<span style="color:#f92672">=</span>2018-05-21 21:33:04<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>sip<span style="color:#f92672">=</span>101.206.169.180<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>sport<span style="color:#f92672">=</span>49187<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>dip<span style="color:#f92672">=</span>10.1.186.7<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>dport<span style="color:#f92672">=</span>9084<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>host<span style="color:#f92672">=</span>m.****.com.cn:9084<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>code<span style="color:#f92672">=</span>200<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>sysurl<span style="color:#f92672">=</span>/sys/web_session.php?level<span style="color:#f92672">=</span>6&amp;sid<span style="color:#f92672">=</span>974609<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>attach<span style="color:#f92672">=</span>/sys/web_session.php?act<span style="color:#f92672">=</span>download&amp;level<span style="color:#f92672">=</span>6&amp;sid<span style="color:#f92672">=</span>974609<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>intent<span style="color:#f92672">=</span>上传可执行脚本或WebShell文件<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>detail<span style="color:#f92672">=</span>在Post数据包中发现含有JSP/ASP/ASP.NET代码特征的字符：&lt;%request/QueryString/Form/<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;...&#39;</span><span style="color:#f92672">]</span>%&gt;<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>dev<span style="color:#f92672">=</span>zonghang01<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>url<span style="color:#f92672">=</span>http://m.****.com.cn:9084/pmobile/MCPerEAccountSignTrs.do<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>命令行工具 <a href="https://github.com/chmln/sd">sd</a> 用于在文本中查找与替换，它既支持基于字面量的查找，也支持基于正则表达式的查找。上文整条命令表示将文件 a1.log 输入到 sd，它第一个参数是替换前字符串满足的模式（正则表达式），第二个参数是替换后的字符串格式，从输出结果可以看到日志条目的“头部”和“身体”之间已通过行分隔符 \n 分隔，相当于拆分成两个部分。</p>
<p>正则表达式通常包含<a href="https://en.wikipedia.org/wiki/Metacharacter">元字符</a>，其中 (X) 表示一个组（Group）的一名成员 X，一个组是正则表达式匹配到的一个子字符串，通过从 0 开始且步长为 1 的单调递增的索引（index）定位各名成员（子子字符串）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>% echo <span style="color:#e6db74">&#39;lizzy 2 2002&#39;</span> | sd <span style="color:#e6db74">&#39;(\w+)\s+(\d+)\s+(\d+)&#39;</span> <span style="color:#e6db74">&#39;name: $1, gender: $2, birth: $3, raw: &#34;$0&#34;&#39;</span>
</span></span><span style="display:flex;"><span>name: lizzy, gender: 2, birth: 2002, raw: <span style="color:#e6db74">&#34;lizzy 2 2002&#34;</span>
</span></span></code></pre></div><p>索引为 0 的成员始终代表整个组。</p>
<h2 id="提取键值对">提取键值对</h2>
<p>使用正则表达式作用于文本可能匹配到一个或多个组，每个组又能按照索引拆分。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>% cat a1.log
</span></span><span style="display:flex;"><span>&lt;30&gt;May <span style="color:#ae81ff">21</span> 22:01:16 localhost alert: <span style="color:#f92672">{</span>category<span style="color:#f92672">=</span>漏洞扫描事件<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>type<span style="color:#f92672">=</span>WebShell<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>priority<span style="color:#f92672">=</span>提示<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>typeCN<span style="color:#f92672">=</span>Web后门<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>level<span style="color:#f92672">=</span>6<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>id<span style="color:#f92672">=</span>974612<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>time<span style="color:#f92672">=</span>2018-05-21 22:01:12<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>sip<span style="color:#f92672">=</span>125.45.235.110<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>sport<span style="color:#f92672">=</span>42425<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>dip<span style="color:#f92672">=</span>10.1.186.5<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>dport<span style="color:#f92672">=</span>9223<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>host<span style="color:#f92672">=</span>ebank.****.com.cn:9223<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>code<span style="color:#f92672">=</span>200<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>sysurl<span style="color:#f92672">=</span>/sys/web_session.php?level<span style="color:#f92672">=</span>6&amp;sid<span style="color:#f92672">=</span>974612<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>attach<span style="color:#f92672">=</span>/sys/web_session.php?act<span style="color:#f92672">=</span>download&amp;level<span style="color:#f92672">=</span>6&amp;sid<span style="color:#f92672">=</span>974612<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>intent<span style="color:#f92672">=</span>上传可执行脚本或WebShell文件<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>detail<span style="color:#f92672">=</span>在Post数据包中发现含有JSP/ASP/ASP.NET代码特征的字符：&lt;%request/QueryString/Form/<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;...&#39;</span><span style="color:#f92672">]</span>%&gt;<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>dev<span style="color:#f92672">=</span>zonghang01<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>url<span style="color:#f92672">=</span>http://ebank.****.com.cn:9223/pWeb/FP410803.do?Wdserialno<span style="color:#f92672">=</span>CIP06A029396<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>使用 Java APIs 从 a1.log 提取用户感兴趣的信息，例如键值对。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String text <span style="color:#f92672">=</span> Files.<span style="color:#a6e22e">readString</span>(Paths.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;/path/to/a1.log&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 移除转义后的表达式为 \{(\w+?)=(.+?)}</span>
</span></span><span style="display:flex;"><span>Pattern pattern <span style="color:#f92672">=</span> Pattern.<span style="color:#a6e22e">compile</span>(<span style="color:#e6db74">&#34;\\{(\\w+?)=(.+?)}&#34;</span>);
</span></span><span style="display:flex;"><span>Matcher matcher <span style="color:#f92672">=</span> pattern.<span style="color:#a6e22e">matcher</span>(text);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (matcher.<span style="color:#a6e22e">find</span>()) {
</span></span><span style="display:flex;"><span>    String kv <span style="color:#f92672">=</span> matcher.<span style="color:#a6e22e">group</span>(0);
</span></span><span style="display:flex;"><span>    String k <span style="color:#f92672">=</span> matcher.<span style="color:#a6e22e">group</span>(1);
</span></span><span style="display:flex;"><span>    String v <span style="color:#f92672">=</span> matcher.<span style="color:#a6e22e">group</span>(2);
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s &lt;=&gt; %s -&gt; %s&#34;</span> <span style="color:#f92672">+</span> System.<span style="color:#a6e22e">lineSeparator</span>(), kv, k, v);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>标准输出如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">{</span>category<span style="color:#f92672">=</span>漏洞扫描事件<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; category -&gt; 漏洞扫描事件
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>type<span style="color:#f92672">=</span>WebShell<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; type -&gt; WebShell
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>priority<span style="color:#f92672">=</span>提示<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; priority -&gt; 提示
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>typeCN<span style="color:#f92672">=</span>Web后门<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; typeCN -&gt; Web后门
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>level<span style="color:#f92672">=</span>6<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; level -&gt; <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>id<span style="color:#f92672">=</span>974612<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; id -&gt; <span style="color:#ae81ff">974612</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>time<span style="color:#f92672">=</span>2018-05-21 22:01:12<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; time -&gt; 2018-05-21 22:01:12
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>sip<span style="color:#f92672">=</span>125.45.235.110<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; sip -&gt; 125.45.235.110
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>sport<span style="color:#f92672">=</span>42425<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; sport -&gt; <span style="color:#ae81ff">42425</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>dip<span style="color:#f92672">=</span>10.1.186.5<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; dip -&gt; 10.1.186.5
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>dport<span style="color:#f92672">=</span>9223<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; dport -&gt; <span style="color:#ae81ff">9223</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>host<span style="color:#f92672">=</span>ebank.****.com.cn:9223<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; host -&gt; ebank.****.com.cn:9223
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>code<span style="color:#f92672">=</span>200<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; code -&gt; <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>sysurl<span style="color:#f92672">=</span>/sys/web_session.php?level<span style="color:#f92672">=</span>6&amp;sid<span style="color:#f92672">=</span>974612<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; sysurl -&gt; /sys/web_session.php?level<span style="color:#f92672">=</span>6&amp;sid<span style="color:#f92672">=</span><span style="color:#ae81ff">974612</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>attach<span style="color:#f92672">=</span>/sys/web_session.php?act<span style="color:#f92672">=</span>download&amp;level<span style="color:#f92672">=</span>6&amp;sid<span style="color:#f92672">=</span>974612<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; attach -&gt; /sys/web_session.php?act<span style="color:#f92672">=</span>download&amp;level<span style="color:#f92672">=</span>6&amp;sid<span style="color:#f92672">=</span><span style="color:#ae81ff">974612</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>intent<span style="color:#f92672">=</span>上传可执行脚本或WebShell文件<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; intent -&gt; 上传可执行脚本或WebShell文件
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>detail<span style="color:#f92672">=</span>在Post数据包中发现含有JSP/ASP/ASP.NET代码特征的字符：&lt;%request/QueryString/Form/<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;...&#39;</span><span style="color:#f92672">]</span>%&gt;<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; detail -&gt; 在Post数据包中发现含有JSP/ASP/ASP.NET代码特征的字符：&lt;%request/QueryString/Form/<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;...&#39;</span><span style="color:#f92672">]</span>%&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>dev<span style="color:#f92672">=</span>zonghang01<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; dev -&gt; zonghang01
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>url<span style="color:#f92672">=</span>http://ebank.****.com.cn:9223/pWeb/FP410803.do?Wdserialno<span style="color:#f92672">=</span>CIP06A029396<span style="color:#f92672">}</span> &lt;<span style="color:#f92672">=</span>&gt; url -&gt; http://ebank.****.com.cn:9223/pWeb/FP410803.do?Wdserialno<span style="color:#f92672">=</span>CIP06A029396
</span></span></code></pre></div><p>即使“头部”有干扰项的日志条目，也不能排除找不到精准的正则表达式去匹配键值对。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>% cat b0.log 
</span></span><span style="display:flex;"><span>&lt;134&gt;Mar <span style="color:#ae81ff">17</span> 14:16:11 CMFEACLOG01 BA<span style="color:#f92672">[</span>5100<span style="color:#f92672">]</span>:<span style="color:#f92672">[</span>log_type:flux<span style="color:#f92672">][</span>record_time:2022-03-17 14:12.24<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>user:liujt2<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>group:/****/23基金核算部/<span style="color:#f92672">][</span>host_ip:192.168.79.78<span style="color:#f92672">][</span>dst_ip:::<span style="color:#f92672">][</span>serv:访问网站<span style="color:#f92672">][</span>app:款件下裁<span style="color:#f92672">][</span>site:未定义位置<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>tm_type:/PC/MAC PC<span style="color:#f92672">][</span>up_flux:120<span style="color:#f92672">][</span>down_flux:120<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>梅开二度：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String text <span style="color:#f92672">=</span> Files.<span style="color:#a6e22e">readString</span>(Paths.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;/path/to/b0.log&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 移除转义后的表达式为 \[(\w+?):(.+?)]</span>
</span></span><span style="display:flex;"><span>Pattern pattern <span style="color:#f92672">=</span> Pattern.<span style="color:#a6e22e">compile</span>(<span style="color:#e6db74">&#34;\\[(\\w+?):(.+?)]&#34;</span>);
</span></span><span style="display:flex;"><span>Matcher matcher <span style="color:#f92672">=</span> pattern.<span style="color:#a6e22e">matcher</span>(text);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (matcher.<span style="color:#a6e22e">find</span>()) {
</span></span><span style="display:flex;"><span>    String kv <span style="color:#f92672">=</span> matcher.<span style="color:#a6e22e">group</span>(0);
</span></span><span style="display:flex;"><span>    String k <span style="color:#f92672">=</span> matcher.<span style="color:#a6e22e">group</span>(1);
</span></span><span style="display:flex;"><span>    String v <span style="color:#f92672">=</span> matcher.<span style="color:#a6e22e">group</span>(2);
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s &lt;=&gt; %s -&gt; %s&#34;</span> <span style="color:#f92672">+</span> System.<span style="color:#a6e22e">lineSeparator</span>(), kv, k, v);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>符合预期：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>log_type:flux<span style="color:#f92672">]</span> &lt;<span style="color:#f92672">=</span>&gt; log_type -&gt; flux
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>record_time:2022-03-17 14:12.24<span style="color:#f92672">]</span> &lt;<span style="color:#f92672">=</span>&gt; record_time -&gt; 2022-03-17 14:12.24
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>user:liujt2<span style="color:#f92672">]</span> &lt;<span style="color:#f92672">=</span>&gt; user -&gt; liujt2
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>group:/****/23基金核算部/<span style="color:#f92672">]</span> &lt;<span style="color:#f92672">=</span>&gt; group -&gt; /****/23基金核算部/
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>host_ip:192.168.79.78<span style="color:#f92672">]</span> &lt;<span style="color:#f92672">=</span>&gt; host_ip -&gt; 192.168.79.78
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>dst_ip:::<span style="color:#f92672">]</span> &lt;<span style="color:#f92672">=</span>&gt; dst_ip -&gt; ::
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>serv:访问网站<span style="color:#f92672">]</span> &lt;<span style="color:#f92672">=</span>&gt; serv -&gt; 访问网站
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>app:款件下裁<span style="color:#f92672">]</span> &lt;<span style="color:#f92672">=</span>&gt; app -&gt; 款件下裁
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>site:未定义位置<span style="color:#f92672">]</span> &lt;<span style="color:#f92672">=</span>&gt; site -&gt; 未定义位置
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>tm_type:/PC/MAC PC<span style="color:#f92672">]</span> &lt;<span style="color:#f92672">=</span>&gt; tm_type -&gt; /PC/MAC PC
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>up_flux:120<span style="color:#f92672">]</span> &lt;<span style="color:#f92672">=</span>&gt; up_flux -&gt; <span style="color:#ae81ff">120</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>down_flux:120<span style="color:#f92672">]</span> &lt;<span style="color:#f92672">=</span>&gt; down_flux -&gt; <span style="color:#ae81ff">120</span>
</span></span></code></pre></div><p>非专业人士也许不懂正则表达式，倒有一种更直观的键值对提取方案，用户至少填写 2 个分隔符：</p>
<ul>
<li>要求切除的前缀，默认为 null。</li>
<li>要求切除的后缀，默认为 null。</li>
<li><strong>键值对之间的分隔符，不能为 null。</strong></li>
<li><strong>键与值之间的分隔符，不能为 null。</strong></li>
<li>是否删除值头尾引号，默认为 false。</li>
</ul>
<p>假设键值对之间的分隔符是 pairSeparator，而键与值之间的分隔符是 kvSeparator，伪代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String<span style="color:#f92672">[]</span> pairs <span style="color:#f92672">=</span> text.<span style="color:#a6e22e">split</span>(Pattern.<span style="color:#a6e22e">quote</span>(pairSeparator));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (ArrayUtils.<span style="color:#a6e22e">isEmpty</span>(pairs)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> kv <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>(keys.<span style="color:#a6e22e">size</span>());
</span></span><span style="display:flex;"><span>String lastKey <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (String pair : pairs) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> first <span style="color:#f92672">=</span> pair.<span style="color:#a6e22e">indexOf</span>(kvSeparator);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (first <span style="color:#f92672">&gt;</span> 0) {
</span></span><span style="display:flex;"><span>        String key <span style="color:#f92672">=</span> pair.<span style="color:#a6e22e">substring</span>(0, first);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (StringUtils.<span style="color:#a6e22e">isNotBlank</span>(key)) {
</span></span><span style="display:flex;"><span>            String value <span style="color:#f92672">=</span> pair.<span style="color:#a6e22e">substring</span>(key.<span style="color:#a6e22e">length</span>() <span style="color:#f92672">+</span> kvSeparator.<span style="color:#a6e22e">length</span>());
</span></span><span style="display:flex;"><span>            kv.<span style="color:#a6e22e">put</span>(key, value);
</span></span><span style="display:flex;"><span>            lastKey <span style="color:#f92672">=</span> key;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将孤独的值追加到上一对键值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (StringUtils.<span style="color:#a6e22e">isNotBlank</span>(lastKey)) {
</span></span><span style="display:flex;"><span>            Object lastValue <span style="color:#f92672">=</span> kv.<span style="color:#a6e22e">get</span>(lastKey);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (Objects.<span style="color:#a6e22e">nonNull</span>(lastValue)) {
</span></span><span style="display:flex;"><span>                kv.<span style="color:#a6e22e">put</span>(lastKey, lastValue <span style="color:#f92672">+</span> pairSeparator <span style="color:#f92672">+</span> pair);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="方法-split-的坑">方法 split 的坑</h2>
<p>说起字符串分隔，方法 <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/String.html#split(java.lang.String)">split</a> 的参数可是正则表达式！</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;a=1} {b=2} {c=3&#34;</span>;
</span></span><span style="display:flex;"><span>String separator <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;} {&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// java.util.regex.PatternSyntaxException: Illegal repetition near index 3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// } {</span>
</span></span><span style="display:flex;"><span>String<span style="color:#f92672">[]</span> pairs <span style="color:#f92672">=</span> str.<span style="color:#a6e22e">split</span>(separator);
</span></span></code></pre></div><p>输入的分隔符包含元字符会被当作正则表达式来校验和解析，除了转义，另一种基于字面量的分隔技巧：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String<span style="color:#f92672">[]</span> pairs <span style="color:#f92672">=</span> str.<span style="color:#a6e22e">split</span>(Pattern.<span style="color:#a6e22e">quote</span>(separator));
</span></span></code></pre></div><h2 id="查找与替换">查找与替换</h2>
<p>最近在捣鼓一系列大数据集，遇到了类似于 <a href="https://jsonlines.org/">JSON lines</a> 的文件，理想情况下它们每一行都是一个有效的 JSON 值，遗憾的是它们是二手资料：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">%</span> cat <span style="color:#f92672">****</span>_sample_750k<span style="color:#f92672">/</span>person_info.<span style="color:#a6e22e">json</span> <span style="color:#f92672">|</span> jq type
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;object&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;object&#34;</span>
</span></span><span style="display:flex;"><span>parse error: Invalid numeric literal at line 3, column 289
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span> cat <span style="color:#f92672">****</span>_sample_750k<span style="color:#f92672">/</span>address_merge_with_mobile_data.<span style="color:#a6e22e">json</span> <span style="color:#f92672">|</span> jq type
</span></span><span style="display:flex;"><span>parse error: Invalid numeric literal at line 1, column 95
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span> cat <span style="color:#f92672">****</span>_sample_750k<span style="color:#f92672">/</span>case_data_index.<span style="color:#a6e22e">json</span> <span style="color:#f92672">|</span> jq type
</span></span><span style="display:flex;"><span>parse error: Invalid numeric literal at line 1, column 118
</span></span></code></pre></div><p>通过 <a href="https://github.com/stedolan/jq">jq</a> 可以快速定位哪些行不是有效的 JSON，视察后使用 sd 等工具将其<strong>就地</strong>（in-place）替换成合规的 JSON。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>file<span style="color:#f92672">=</span>****_sample_750k/person_info.json
</span></span><span style="display:flex;"><span>sd -s <span style="color:#e6db74">&#39;&#34;{&#39;</span> <span style="color:#e6db74">&#39;{&#39;</span> $file
</span></span><span style="display:flex;"><span>sd -s <span style="color:#e6db74">&#39;}&#34;&#39;</span> <span style="color:#e6db74">&#39;}&#39;</span> $file
</span></span><span style="display:flex;"><span>sd -s <span style="color:#e6db74">&#39;简称&#34;中专&#34;&#39;</span> <span style="color:#e6db74">&#39;简称中专&#39;</span> $file
</span></span><span style="display:flex;"><span>sd -s <span style="color:#e6db74">&#39;简称&#34;大学&#34;&#39;</span> <span style="color:#e6db74">&#39;简称大学&#39;</span> $file
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;&#34;]}}}&#39;</span> &gt;&gt; $file
</span></span><span style="display:flex;"><span>cat $file | jq type
</span></span></code></pre></div><p>选项 <code>-s</code> 就是 sd 的字符串字面量模式（将表达式视为非正则字符串），但是可能发生“误伤”或“越界”，因为剩余两个类 JSON lines 文件的某些字符串类型的字段的值包含一些 JSON 元字符：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>&#34;field&#34;:&#34;内容{内容}内容&#34;
</span></span></code></pre></div><p>（内容可能为空白）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>&#34;field&#34;:&#34;内容&#34;内容&#34;内容&#34;
</span></span></code></pre></div><p>混合使用正则模式与非正则模式来修复：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>file<span style="color:#f92672">=</span>****_sample_750k/address_merge_with_mobile_data.json
</span></span><span style="display:flex;"><span>sd <span style="color:#e6db74">&#39;&#34;\{(.+?)}&#34;&#39;</span> <span style="color:#e6db74">&#39;{$1}&#39;</span> $file
</span></span><span style="display:flex;"><span>export JAVA_HOME<span style="color:#f92672">=</span>/Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home <span style="color:#f92672">&amp;&amp;</span> java StrFieldReplace.java $file
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;&#34;}}&#39;</span> &gt;&gt; $file
</span></span><span style="display:flex;"><span>cat $file | jq type
</span></span></code></pre></div><p>其中脚本 StrFieldReplace.java 的实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StrFieldReplace</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Pattern<span style="color:#f92672">[]</span> PATTERNS <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Pattern<span style="color:#f92672">[]</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// &#34;SRC_ADDRESS&#34;:&#34;(.+?)&#34;,&#34;SRC_ID&#34;</span>
</span></span><span style="display:flex;"><span>            Pattern.<span style="color:#a6e22e">compile</span>(<span style="color:#e6db74">&#34;\&#34;SRC_ADDRESS\&#34;:\&#34;(.+?)\&#34;,\&#34;SRC_ID\&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// &#34;BRIEF_CASE&#34;:&#34;(.+?)&#34;,&#34;CASE_TYPE&#34;</span>
</span></span><span style="display:flex;"><span>            Pattern.<span style="color:#a6e22e">compile</span>(<span style="color:#e6db74">&#34;\&#34;BRIEF_CASE\&#34;:\&#34;(.+?)\&#34;,\&#34;CASE_TYPE\&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// &#34;CASE_ADDRESS&#34;:&#34;(.+?)&#34;}</span>
</span></span><span style="display:flex;"><span>            Pattern.<span style="color:#a6e22e">compile</span>(<span style="color:#e6db74">&#34;\&#34;CASE_ADDRESS\&#34;:\&#34;(.+?)\&#34;}&#34;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// &#34;case_address&#34;:&#34;(.+?)&#34;,&#34;\w+?&#34;</span>
</span></span><span style="display:flex;"><span>            Pattern.<span style="color:#a6e22e">compile</span>(<span style="color:#e6db74">&#34;\&#34;case_address\&#34;:\&#34;(.+?)\&#34;,\&#34;\\w+?\&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// &#34;caseAddress&#34;:&#34;(.+?)&#34;,&#34;\w+?&#34;</span>
</span></span><span style="display:flex;"><span>            Pattern.<span style="color:#a6e22e">compile</span>(<span style="color:#e6db74">&#34;\&#34;caseAddress\&#34;:\&#34;(.+?)\&#34;,\&#34;\\w+?\&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// &#34;CASE_NAME&#34;:&#34;(.+?)&#34;,&#34;CASE_NUMBER&#34;</span>
</span></span><span style="display:flex;"><span>            Pattern.<span style="color:#a6e22e">compile</span>(<span style="color:#e6db74">&#34;\&#34;CASE_NAME\&#34;:\&#34;(.+?)\&#34;,\&#34;CASE_NUMBER\&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>String, String<span style="color:#f92672">&gt;</span> REGEX_REPL <span style="color:#f92672">=</span> Map.<span style="color:#a6e22e">of</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// &#34; -&gt; &#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;\&#34;&#34;</span>, <span style="color:#e6db74">&#34;&#39;&#34;</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (args.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&lt;</span> 1) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Usage: java StrFieldReplace.java &lt;pathToFile&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">exit</span>(1);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        String pathToFile <span style="color:#f92672">=</span> args<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        Path filepath <span style="color:#f92672">=</span> Paths.<span style="color:#a6e22e">get</span>(pathToFile);
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> lines <span style="color:#f92672">=</span> Files.<span style="color:#a6e22e">readAllLines</span>(filepath);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (lines.<span style="color:#a6e22e">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">println</span>(filepath <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; is empty&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0; i <span style="color:#f92672">&lt;</span> lines.<span style="color:#a6e22e">size</span>(); i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>            String line <span style="color:#f92672">=</span> lines.<span style="color:#a6e22e">get</span>(i);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (Pattern pattern : PATTERNS) {
</span></span><span style="display:flex;"><span>                Matcher matcher <span style="color:#f92672">=</span> pattern.<span style="color:#a6e22e">matcher</span>(line);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">while</span> (matcher.<span style="color:#a6e22e">find</span>()) {
</span></span><span style="display:flex;"><span>                    String value <span style="color:#f92672">=</span> matcher.<span style="color:#a6e22e">group</span>(1);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">for</span> (Map.<span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String, String<span style="color:#f92672">&gt;</span> entry : REGEX_REPL.<span style="color:#a6e22e">entrySet</span>()) {
</span></span><span style="display:flex;"><span>                        String regex <span style="color:#f92672">=</span> entry.<span style="color:#a6e22e">getKey</span>();
</span></span><span style="display:flex;"><span>                        String repl <span style="color:#f92672">=</span> entry.<span style="color:#a6e22e">getValue</span>();
</span></span><span style="display:flex;"><span>                        String newValue <span style="color:#f92672">=</span> value.<span style="color:#a6e22e">replaceAll</span>(regex, repl);
</span></span><span style="display:flex;"><span>                        line <span style="color:#f92672">=</span> line.<span style="color:#a6e22e">replace</span>(value, newValue);
</span></span><span style="display:flex;"><span>                        lines.<span style="color:#a6e22e">set</span>(i, line);
</span></span><span style="display:flex;"><span>                        value <span style="color:#f92672">=</span> newValue;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Files.<span style="color:#a6e22e">writeString</span>(filepath, String.<span style="color:#a6e22e">join</span>(System.<span style="color:#a6e22e">lineSeparator</span>(), lines));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>此处，基于字面量替换比基于正则替换更快，在行替换比在全文替换更快。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>file<span style="color:#f92672">=</span>****_sample_750k/case_data_index.json
</span></span><span style="display:flex;"><span>sd <span style="color:#e6db74">&#39;&#34;ADDR_DETL&#34;:&#34;\{(.+?)}&#34;,&#34;ADDR_TYPE&#34;&#39;</span> <span style="color:#e6db74">&#39;&#34;ADDR_DETL&#34;:{$1},&#34;ADDR_TYPE&#34;&#39;</span> $file
</span></span><span style="display:flex;"><span>export JAVA_HOME<span style="color:#f92672">=</span>/Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home <span style="color:#f92672">&amp;&amp;</span> java StrFieldReplace.java $file
</span></span><span style="display:flex;"><span>sd -s <span style="color:#e6db74">&#39;&#34;{&#39;</span> <span style="color:#e6db74">&#39;{&#39;</span> $file <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">&#39;&#34;:null}}}}&#39;</span> &gt;&gt; $file
</span></span><span style="display:flex;"><span>cat $file | jq type
</span></span></code></pre></div><h2 id="文本校验">文本校验</h2>
<p>通常始于一行的开头 <code>^</code>，终于一行的结尾 <code>$</code>。</p>
<blockquote>
<p>本文首发于 https://h2cone.github.io/</p>
</blockquote>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Regular_expression">Wiki # Regular expression</a></li>
<li><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/regex/Pattern.html">Oracle # Class Pattern</a></li>
<li><a href="https://regex101.com/">regex101: build, test, and debug regex</a></li>
</ul>

		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/regex">regex</a></li>
					
					<li><a href="/tags/text-processing">text-processing</a></li>
					
					<li><a href="/tags/sd">sd</a></li>
					
					<li><a href="/tags/java">java</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/h2cone" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  © Huangh&#39;s blog |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


  


<script>
  feather.replace()
</script></div>
    </body>
</html>
